{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Desenvolupament Web en Entorn Servidor","title":"Inici"},{"location":"#desenvolupament-web-en-entorn-servidor","text":"","title":"Desenvolupament Web en Entorn Servidor"},{"location":"01-intro/01-intro/","text":"Introducci\u00f3 a la programaci\u00f3 web Objectius Seleccionar les arquitectures i tecnologies de programaci\u00f3 web en entorn servidor, analitzant-ne les capacitats i caracter\u00edstiques pr\u00f2pies. Introduir els principals llenguatges i frameworks per al desenvolupament en l'entorn servidor. Caracteritzar i diferenciar els models d'execuci\u00f3 de codi en el servidor i en el client web. Identificar les principals tecnologies associades. Instal\u00b7lar i configurar l'entorn de treball que emprarem per al desenvolupament web. Visualitzar mitjan\u00e7ant el navegador una p\u00e0gina web html amb codi PHP encastat. Arquitectura d'una aplicaci\u00f3 web A difer\u00e8ncia de les aplicacions d'escriptori, que utilitzen els recursos d'un \u00fanic ordinador les aplicacions web s\u00f3n distribu\u00efdes, intervenen com a m\u00ednin dos equipos diferents: el client i el servidor. La comunicaci\u00f3 \u00e9s du a terme mitjan\u00e7ant el protocol HTTP, base de la World Wide Web . El model client/servidor El model client-servidor \u00e9s aquell on tots els clients estan connectats a un servidor on es centralitzen els diferents recursos. Aquests recursos estan a disposici\u00f3 dels clients cada cop que els sol\u00b7liciten. Aix\u00f2 fa que totes les gestions que es realitzen es concentren en el servidor, que disposa dels requeriments dels clients amb prioritat, els arxius que s\u00f3n d'\u00fas p\u00fablic i els restringits, els arxius de nom\u00e9s lectura, els que poden ser modificats, etc. Arquitectura Client Servidor. En el model client/servidor, el dispositiu que sol\u00b7licita informaci\u00f3 es denomina client i el dispositiu que respon la sol\u00b7licitud es denomina servidor. Els processos de client i servidor es consideren una part de la capa d'aplicaci\u00f3. El client comen\u00e7a l'intercanvi sol\u00b7licitant les dades al servidor, que respon enviant un o m\u00e9s blocs de dades al client. Els protocols de capa d'aplicaci\u00f3 descriuen el format de les sol\u00b7licituds i respostes entre clients i servidor. A m\u00e9s de la transfer\u00e8ncia real de dades, aquest intercanvi pot requerir informaci\u00f3 addicional, com l'autentificaci\u00f3 de l'usuari o la identificaci\u00f3 d'un arxiu de dades per transferir. Encara que les dades generalment es descriuen com un flux del servidor al client, algunes dades sempre flueixen del client al servidor. El flux de dades pot ser el mateix en les dues direccions o fins i tot ser major en la direcci\u00f3 que va del client al servidor. Per exemple, un client pot transferir un arxiu al servidor amb finalitats d'emmagatzemament. La transfer\u00e8ncia de dades d'un client a un servidor es coneix com a pujada i la de les dades d'un servidor a un client, baixada. El protocol HTTP El protocol de transfer\u00e8ncia d'hipertext (HTTP) \u00e9s un protocol client-servidor molt senzill que articula els intercanvis d'informaci\u00f3 entre els clients HTTP (navegadors) i els servidors HTTP. HTTP es basa en operacions senzilles de sol\u00b7licitud/resposta. Quan un client estableix una connexi\u00f3 amb un servidor i envia un missatge amb les dades de la sol\u00b7licitud, el servidor respon amb un missatge similar que cont\u00e9 l'estat de l'operaci\u00f3 i el seu resultat de la sol\u00b7licitud. Totes les operacions poden adjuntar un objecte o recurs sobre el qual actuen; cada objecte web (document HTML, arxiu multim\u00e8dia o aplicaci\u00f3 CGI) \u00e9s conegut pel seu localitzador uniforme de recursos (URL, Uniform Resource Locator ). Els recursos poden ser arxius, el resultat de l'execuci\u00f3 d'un programa, una consulta a una base de dades, la traducci\u00f3 autom\u00e0tica d'un document, etc. HTTP \u00e9s un protocol sense estat , \u00e9s a dir, no guarda cap informaci\u00f3 sobre connexions anteriors. El desenvolupament d'aplicacions web freq\u00fcentment necessita mantenir estat. Per aix\u00f2 s'utilitzen les galetes ( cookies ), \u00e9s a dir, la informaci\u00f3 que un servidor pot emmagatzemar en el sistema client. Aix\u00f2 permet que les aplicacions web institueixin la noci\u00f3 de \"sessi\u00f3\", i, alhora, permet rastrejar usuaris, ja que les galetes es poden emmagatzemar en el client durant un temps indeterminat. Per a con\u00e8ixer amb m\u00e9s profunditat el protocol HTTP avaluarem en qu\u00e8 consisteix una transacci\u00f3 HTTP. Cada vegada que un client fa una petici\u00f3 a un servidor, s'executen un seguit d'accions: Un usuari accedeix a una adre\u00e7a d'Internet (URL) seleccionant un enlla\u00e7 d'un document HTML o introduint-la directament a la barra de navegaci\u00f3 d'un navegador web des de la perspectiva del client web. El client web descodifica l'adre\u00e7a d'Internet (URL) separant-ne les diferents parts. \u00c9s aix\u00ed com s'identifiquen el protocol d'acc\u00e9s, el node, expressat amb el nom de domini o la seua adre\u00e7a IP, el possible port opcional (el valor per defecte \u00e9s el 80) i l'objecte del servidor requerit. S'obre una connexi\u00f3 TCP/IP amb el servidor cridant el port TCP corresponent. Es fa la petici\u00f3. En conseq\u00fc\u00e8ncia, s'envien l'ordre necess\u00e0ria (GET, POST, HEAD, etc.), l'adre\u00e7a de l'objecte requerit (el contingut de l'adre\u00e7a d'Internet del servidor), la versi\u00f3 del protocol HTTP utilitzada (en la major part de les ocasions \u00e9s HTTP/1.1) i un conjunt variable d'informaci\u00f3 que inclou dades sobre les capacitats del navegador web, dades opcionals per al servidor, etc. El servidor localitza el recurs sol\u00b7licitat i torna la resposta al client. Aquesta resposta consisteix en un codi d'estat i el tipus de dada amb extensions multiprop\u00f2sit de correu d'Internet (MIME, Multipurpose Internet Mail Extension) de la informaci\u00f3 de tornada, seguit de la mateixa informaci\u00f3. El client formata i mostra el recurs rebut. Es tanca la connexi\u00f3 TCP. Important Aquest proc\u00e9s es repeteix en cada acc\u00e9s que es fa\u00e7a al servidor HTTP. Per exemple, si es recull un document HTML que cont\u00e9 quatre imatges, el proc\u00e9s de transici\u00f3 mostrat amb anterioritat es repeteix cinc vegades, \u00e9s a dir, una pel document HTML i quatre per les imatges. Etapes d'una transacci\u00f3 HTTP Si el recurs sol\u00b7licitat \u00e9s un programa (CGI, ASP.NET, PHP, etc.) el servidor HTTP redirigir\u00e0 la petici\u00f3 a la llibreria o int\u00e8rpret adequat que executar\u00e0 el programa i tornar\u00e0 el control al servidor web. Etapes d'una sol\u00b7licitud HTTP amb processament per part del servidor Format de les URL La sintaxi general de les URL consisteix en una seq\u00fc\u00e8ncia jer\u00e0rquica de 5 components: URI = scheme:[//authority]path[?query][#fragment] on el component authoriry es deivideix en tres subcomponents: authority = [userinfo@]host[:port] Sintaxi de les URL Servidors web i servidors d'aplicacions Aix\u00ed com les aplicacions d'escriptori s'executen directament sobre el sistema operatiu, les aplicacions web necessiten d'una eina addicional que permeti desplegar-les per a la seva posada en marxa. Parlem de servidors web i servidors d'aplicacions , respectivament. Un servidor web \u00e9s una aplicaci\u00f3 que rep una petici\u00f3 HTTP (normalment a trav\u00e9s d'un navegador web) i retorna la p\u00e0gina web sol\u00b7licitada (escrita en llenguatge HTML i podent contenir codi Javascript encastat) perqu\u00e8 aquesta sigua interpretada i visualitzada pel navegador de qui va realitzar la sol\u00b7licitud (l'usuari). Un servidor d'aplicacions \u00e9s un servidor que permet l'execuci\u00f3 d'aplicacions web. Exemples Apache Apache \u00e9s un dels servidors web m\u00e9s coneguts. \u00c9s programari lliure i multiplataforma, encara que aproximadament el 90% dels servidors Apache s'executen actualment en entorns Linux ja que \u00e9s el servidor preferit per a aquesta plataforma. \u00c9s molt modular el que permet incorporar caracter\u00edstiques un cop instal\u00b7lat i posat en marxa. Aix\u00f2 li fa tamb\u00e9 molt flexible i pot donar servei a webs escrites en els llenguatges de programaci\u00f3 web m\u00e9s estesos (com PHP, Python, ASP,...) A trav\u00e9s del m\u00f2dul corresponent. nginx nginx (pronunciat en angl\u00e8s \"engine X\") \u00e9s un servidor web/proxy invers lleuger d'alt rendiment i un proxy per protocols de correu electr\u00f2nic ( IMAP / POP3). PHP-FPM FastCGI Process Manager \u00e9s un servei que permet executar codi PHP separat del servidor HTTP de forma que millora la seua flexibilitat i el seu rendiment. P\u00e0gines web est\u00e0tiques i din\u00e0miques P\u00e0gines web est\u00e0tiques Les p\u00e0gines web est\u00e0tiques s\u00f3n aquelles en que el seu contingut no varia, per la qual cosa mostraran sempre la mateixa informaci\u00f3 cada vegada que es carreguen. S\u00f3n les p\u00e0gines creades en el llenguatge HTML, CSS i javascript. Les p\u00e0gines est\u00e0tiques nom\u00e9s canvien si el programador web les modifica. P\u00e0gines web din\u00e0miques Les p\u00e0gines web din\u00e0miques s\u00f3n p\u00e0gines el contingut de les quals varia a partir de certa informaci\u00f3: base de dades, identificaci\u00f3 de l'usuari, hora del dia, etc. Aquest tipus de p\u00e0gines s'han de realitzar mitjan\u00e7at un llenguatge de programaci\u00f3. Execuci\u00f3 de codi en el client i en el servidor Pel que hem pogut veure fins ara en el desenvolupament d'una aplicaci\u00f3 web podem distingir entre una s\u00e8rie de tecnologies que s'executen en el navegador ( client-side o front-end programming ) i un s\u00e8rie de tecnologies que s'executen en el servidor ( server-side o back-end programming ) En el seg\u00fcent gr\u00e0fic es mostra un escenari on podem trobar codi que s'executa en el servidor (PHP) i en el client (javascript). Execuci\u00f3 de codi en el client i en el servidor Model de desenvolupament en 3 capes Des d'un punt de vista de desenvolupament una aproximaci\u00f3 m\u00e9s detallada al model client-servidor \u00e9s el que es coneix com a model en 3 capes . \u00c9s un model on es mostra m\u00e9s en detall com es distribueix el programari que participa en qualsevol desenvolupament web. Segueix estant present l'arquitectura client-servidor (tot es basa en ella) per\u00f2 apareixen m\u00e9s detalls com el programari utilitzat en cada un dels dos actors i com interactuen les diferents tecnologies o aplicacions. Per comprendre millor que \u00e9s el model de desenvolupament de 3 capes podem observar el seg\u00fcent esquema on es mostra cadascuna d'aquestes capes f\u00eds\u00edques : Model de desenvolupament de 3 capes Des d'un punt de vista l\u00f2gic les capes ( layers ) es divideixen les seg\u00fcents funcionalitats: Capa de presentaci\u00f3: \u00c9s la capa on l'aplicaci\u00f3 es mostra a l'usuari. B\u00e0sicament \u00e9s la GUI ( Graphical User Interface, interf\u00edcie gr\u00e0fica d'usuari ). En el cas d'una aplicaci\u00f3 web seria el codi HTML que es carrega directament al navegador web. En qualsevol cas, s'executa directament en l'equip del client. Capa d'aplicaci\u00f3: \u00c9s la capa interm\u00e8dia on es porta a terme tota la l\u00f2gica de l'aplicaci\u00f3. Sempre s'executar\u00e0 en el costat servidor. Aquesta capa, despr\u00e9s de realitzar tots els c\u00e0lculs i/o operacions sobre les dades, genera el codi HTML que ser\u00e0 presentat a l'usuari en la capa seg\u00fcent. Sols estar desenvolupada usant PHP, Pyhton, Java, etc i es comunica amb la capa de dades mitjan\u00e7ant una API. Capa de dades: \u00c9s la capa que emmagatzema les dades. B\u00e0sicament, en condicions normals, fa refer\u00e8ncia al propi SGBD que \u00e9s l'encarregat d'emmagatzemar les dades. Depenent de l'arquitectura de l'aplicaci\u00f3, aquesta capa i la de negoci es poden trobar f\u00edsicament en el mateix equip, encara que tamb\u00e9 \u00e9s possible que s'hagin de separar per q\u00fcestions de rendiment. La capa de dades serveix totes la informaci\u00f3 necess\u00e0ria a la capa de negoci per dur a terme les seves operacions. Si ens imaginem una botiga online, la capa de dades emmagatzemaria tota la informaci\u00f3 en una base de dades (usuaris, comandes, articles, ofertes,...). La capa d'aplicaci\u00f3 hauria d'accedir a aquesta informaci\u00f3 i, despr\u00e9s processar una comanda, per exemple i finalment presentar el resultat a l'usuari en el navegador, que \u00e9s la capa de presentaci\u00f3. I si ens centrem en un cas concret amb programari i tecnologies ja definits, un model de 3 capes podria ser el seg\u00fcent: Modelo de desarrollo de 3 capas (desarrollo web con PHP) Navegador web: En aquest cas, Mozilla Firefox, Internet Explorer o Google Chrome podrien ser qualsevol de les aplicacions que ocuparien aquesta capa Apache + PHP / IIS + ASP: Un servidor web acompanyat del seu corresponent llenguatge de programaci\u00f3 web permeten desenvolupar la part que ocupa la capa de negoci. Tamb\u00e9 podr\u00edem col\u00b7locar la combinaci\u00f3 Apache Tomcat + Servlets MySQL / PostgreSQL / Node: Finalment a la capa de dades podem posar qualsevol SGBD, com poden ser MySQL o PostgreSQL. L'avantatge principal d'aquest model \u00e9s que el desenvolupament es pot dur a terme en diversos nivells i, en cas que sobrevinga algun canvi, nom\u00e9s afectar\u00e0 el nivell requerit sense haver de revisar entre el codi font d'altres m\u00f2duls, at\u00e8s que s'haur\u00e0 redu\u00eft el acoblament inform\u00e0tic fins a una interf\u00edcie de pas de missatges. Front-end, back-end, Full stack Tamb\u00e9 tenint en compte en quin costat se situen les tecnologies i per a qu\u00e8 s'utilitzen aquestes, actualment es parla molt de 3 perfils diferenciats en l'\u00e0mbit del desenvolupament web: Front-end: \u00c9s la part del desenvolupament que s'encarrega del disseny i maquetaci\u00f3 de l'aplicaci\u00f3 web utilitzant tecnologies com HTML, CSS i Javascript (i els seus frameworks). En aquest cas s'ha de preocupar tamb\u00e9 de la correcta presentaci\u00f3 en qualsevol tipus de dispositiu i fins i tot del posicionament en cercadors Back-end: \u00c9s la part del desenvolupament que s'encarrega del costat servidor utilitzant tecnologies com PHP, JSP i Python. Tamb\u00e9 s'encarrega de l'administraci\u00f3 del servidor d'aplicacions i la base de dades. Full stack: En un perfil que engloba els dos anteriors. En aquest cas el desenvolupador potser no \u00e9s un expert de cap tecnologia concreta per\u00f2 t\u00e9 amplis coneixements de tot el conjunt i \u00e9s capa\u00e7 de col\u00b7laborar en qualsevol de les parts. Fullstack Tipogia de les aplicacions web Depenent de la forma en qu\u00e8 s'utilitzen les tecnologies podem classificar les aplicacions en: Tradicionals o cl\u00e0ssiques, on pr\u00e0ctimanent tota la l\u00f2gica i la presentenci\u00f3 es genera en el costat de servidor. H\u00edbidres on una aplicaci\u00f3 tradicional incorpora tecnologies en el costat del client per a millorar l'experi\u00e8ncia de l'usuari. Single Page Applications (SPA). En el costat servidor es generen una s\u00e8rie de funcionalitats accessibles mitjan\u00e7ant una API i tota la c\u00e0rrega de la presentaci\u00f3 \u00e9s realitza en el costat del client que s'encarrega a m\u00e9s realizar les sol\u00b7licitus a la API. Arquitectura tradicional vs SPA Llenguatges PHP PHP ( PHP Hypertext Preprocessor ) \u00e9s un llenguatge de programaci\u00f3 de costat servidor dissenyat principalment per al desenvolupament web. PHP s'utilitza com a llenguatge de script embegut en p\u00e0gines HTML i funciona, normalment, com un m\u00f2dul del servidor web (per exemple, a Apache). El servidor web combina els resultats d'executar els scripts PHP amb l'HTML al qual va encastat i genera la p\u00e0gina web resultant per al navegador. Actualment PHP funciona pr\u00e0cticament amb qualsevol servidor web i en qualsevol Sistema Operatiu existents, i gaireb\u00e9 amb qualsevol SGBD en cas que necessitem utilitzar una base de dades. Tot i aix\u00f2, el m\u00e9s habitual \u00e9s veure-ho formant el que es coneix com una arquitectura LAMP (Linux, Apache, MySQL i PHP), \u00e9s a dir, funcionant sobre un sistema operatiu Linux, executant-com un m\u00f2dul del servidor web Apache i utilitzant a MySQL com SGBD per emmagatzemar la informaci\u00f3 en cas que es requereixi una base de dades. Arquitectura LAMP El llenguatge PHP va ser dissenyat per Rasmus Lerdorf i ara es mant\u00e9 per una comunitat de desenvolupadors, a m\u00e9s \u00e9s de codi obert. A continuaci\u00f3, un fragment d'una p\u00e0gina web din\u00e0mica escrita amb PHP on es pot apreciar com s'incrusta el codi juntament amb l'HTML de la p\u00e0gina: JSP / Servlets JavaServer Pages (tamb\u00e9 conegut com JSP) \u00e9s una tecnologia creada per a la creaci\u00f3 de p\u00e0gines web din\u00e0miques del costat servidor. Igual que PHP, el seu codi s'escriu encastat juntament amb l'HTML de la p\u00e0gina web i \u00e9s el servidor d'aplicacions, en aquest cas, qui ha de processar-per generar la p\u00e0gina web resultant, en HTML. D'altra banda, Java Servlets \u00e9s una tecnologia que tamb\u00e9 es pot utilitzar per crear contingut web din\u00e0mic per\u00f2 que a m\u00e9s est\u00e9n la seva funcionalitat a la possibilitat de connectar aquestes webs din\u00e0miques amb un altre contingut accessible a trav\u00e9s d'Internet. De vegades s'utilitza juntament amb JSP per crear aplicacions web m\u00e9s complexes. Totes dues s\u00f3n tecnologies desenvolupades per Sun Microsystems i propietat ara d'Oracle, despr\u00e9s d'adquirir aquesta \u00faltima a la primera fa ja alguns anys. Python El llenguatge Python va ser dissenyat per Guido van Rossum i ara es mant\u00e9 gr\u00e0cies a una comunitat de desenvolupadors, i \u00e9s codi obert. Exemple de codi escrit amb Python. En aquest cas utilitzant el framework Django per al desenvolupament d'aplicacions web: < h1 > Mis pel\u00edculas </ h1 > < a href = \"#\" > + </ a > {% if lista_peliculas %} < ul > {% for pelicula in lista_peliculas %} < li >< a href = \"{% url 'pelicula' pelicula.id %}\" > {{ pelicula.titulo }} </ a ></ li > {% endfor %} </ ul > {% else %} < p > No hay pel\u00edculas disponibles </ p > {% endif %} Separada del controlador: from django.shortcuts import render . . . def index ( request ): lista_peliculas = Pelicula . objects . all () context = { 'lista_peliculas' : lista_peliculas } return render ( request , 'mispeliculas/index.html' , context ) ASP.NET ASP.NET \u00e9s una tecnologia, creada per Microsoft, per al desenvolupament de lloc web din\u00e0mics, aplicacions i serveis web. \u00c9s la tecnologia successora del que abans es coneixia com ASP, l'antiga tecnologia de Microsoft per a la creaci\u00f3 de p\u00e0gines web din\u00e0miques. Com que funciona sobre la plataforma .NET de Microsoft, permet que es pugui desenvolupar en qualsevol dels llenguatges de programaci\u00f3 d'aquesta plataforma, Visual Basic .NET o C#. El m\u00e9s habitual \u00e9s veure-ho funcionar juntament amb el lloc web de Microsoft, IIS (Internet Information Server). A continuaci\u00f3, un exemple de p\u00e0gina web din\u00e0mica amb ASP.NET (desenvolupada en llenguatge C #) programant l'acci\u00f3 que passa en pr\u00e9mer un bot\u00f3 (apareix el text d'un formulari a la part final del web): protected void Button1_Click(object sender, EventArgs e) { string buf = TextBox1.Text; changed_text.InnerHtml = buf.ToUpper(); } < %@ Page Language=\"C#\" AutoEventWireup=\"true\" CodeBehind=\"Default.aspx.cs\" Inherits=\"firstexample._Default\" %> <!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"> < html xmlns = \"http://www.w3.org/1999/xhtml\" > < head runat = \"server\" > < title > Untitled Page </ title > </ head > < body > < form id = \"form1\" runat = \"server\" > < div > < asp:TextBox ID = \"TextBox1\" runat = \"server\" style = \"width:224px\" > </ asp:TextBox > < asp:Button ID = \"Button1\" runat = \"server\" Text = \"Enter...\" style = \"width:85px\" onclick = \"Button1_Click\" /> < hr /> < h3 > Results: </ h3 > < span runat = \"server\" id = \"changed_text\" /> </ div > </ form > </ body > </ html > Bibliografia Education, I., 2020. What is Three-Tier Architecture . [online] Ibm.com. Available at: https://www.ibm.com/cloud/learn/three-tier-architecture [Accessed 9 September 2022]. MDN contributors, 2022. Introduction to the server side - Learn web development | MDN. [online] Developer.mozilla.org. Available at: https://developer.mozilla.org/en-US/docs/Learn/Server-side/First_steps/Introduction [Accessed 9 September 2022].","title":"Estructura aplicacions web"},{"location":"01-intro/01-intro/#introduccio-a-la-programacio-web","text":"Objectius Seleccionar les arquitectures i tecnologies de programaci\u00f3 web en entorn servidor, analitzant-ne les capacitats i caracter\u00edstiques pr\u00f2pies. Introduir els principals llenguatges i frameworks per al desenvolupament en l'entorn servidor. Caracteritzar i diferenciar els models d'execuci\u00f3 de codi en el servidor i en el client web. Identificar les principals tecnologies associades. Instal\u00b7lar i configurar l'entorn de treball que emprarem per al desenvolupament web. Visualitzar mitjan\u00e7ant el navegador una p\u00e0gina web html amb codi PHP encastat.","title":"Introducci\u00f3 a la programaci\u00f3 web"},{"location":"01-intro/01-intro/#arquitectura-duna-aplicacio-web","text":"A difer\u00e8ncia de les aplicacions d'escriptori, que utilitzen els recursos d'un \u00fanic ordinador les aplicacions web s\u00f3n distribu\u00efdes, intervenen com a m\u00ednin dos equipos diferents: el client i el servidor. La comunicaci\u00f3 \u00e9s du a terme mitjan\u00e7ant el protocol HTTP, base de la World Wide Web .","title":"Arquitectura d'una aplicaci\u00f3 web"},{"location":"01-intro/01-intro/#el-model-clientservidor","text":"El model client-servidor \u00e9s aquell on tots els clients estan connectats a un servidor on es centralitzen els diferents recursos. Aquests recursos estan a disposici\u00f3 dels clients cada cop que els sol\u00b7liciten. Aix\u00f2 fa que totes les gestions que es realitzen es concentren en el servidor, que disposa dels requeriments dels clients amb prioritat, els arxius que s\u00f3n d'\u00fas p\u00fablic i els restringits, els arxius de nom\u00e9s lectura, els que poden ser modificats, etc. Arquitectura Client Servidor. En el model client/servidor, el dispositiu que sol\u00b7licita informaci\u00f3 es denomina client i el dispositiu que respon la sol\u00b7licitud es denomina servidor. Els processos de client i servidor es consideren una part de la capa d'aplicaci\u00f3. El client comen\u00e7a l'intercanvi sol\u00b7licitant les dades al servidor, que respon enviant un o m\u00e9s blocs de dades al client. Els protocols de capa d'aplicaci\u00f3 descriuen el format de les sol\u00b7licituds i respostes entre clients i servidor. A m\u00e9s de la transfer\u00e8ncia real de dades, aquest intercanvi pot requerir informaci\u00f3 addicional, com l'autentificaci\u00f3 de l'usuari o la identificaci\u00f3 d'un arxiu de dades per transferir. Encara que les dades generalment es descriuen com un flux del servidor al client, algunes dades sempre flueixen del client al servidor. El flux de dades pot ser el mateix en les dues direccions o fins i tot ser major en la direcci\u00f3 que va del client al servidor. Per exemple, un client pot transferir un arxiu al servidor amb finalitats d'emmagatzemament. La transfer\u00e8ncia de dades d'un client a un servidor es coneix com a pujada i la de les dades d'un servidor a un client, baixada.","title":"El model client/servidor"},{"location":"01-intro/01-intro/#el-protocol-http","text":"El protocol de transfer\u00e8ncia d'hipertext (HTTP) \u00e9s un protocol client-servidor molt senzill que articula els intercanvis d'informaci\u00f3 entre els clients HTTP (navegadors) i els servidors HTTP. HTTP es basa en operacions senzilles de sol\u00b7licitud/resposta. Quan un client estableix una connexi\u00f3 amb un servidor i envia un missatge amb les dades de la sol\u00b7licitud, el servidor respon amb un missatge similar que cont\u00e9 l'estat de l'operaci\u00f3 i el seu resultat de la sol\u00b7licitud. Totes les operacions poden adjuntar un objecte o recurs sobre el qual actuen; cada objecte web (document HTML, arxiu multim\u00e8dia o aplicaci\u00f3 CGI) \u00e9s conegut pel seu localitzador uniforme de recursos (URL, Uniform Resource Locator ). Els recursos poden ser arxius, el resultat de l'execuci\u00f3 d'un programa, una consulta a una base de dades, la traducci\u00f3 autom\u00e0tica d'un document, etc. HTTP \u00e9s un protocol sense estat , \u00e9s a dir, no guarda cap informaci\u00f3 sobre connexions anteriors. El desenvolupament d'aplicacions web freq\u00fcentment necessita mantenir estat. Per aix\u00f2 s'utilitzen les galetes ( cookies ), \u00e9s a dir, la informaci\u00f3 que un servidor pot emmagatzemar en el sistema client. Aix\u00f2 permet que les aplicacions web institueixin la noci\u00f3 de \"sessi\u00f3\", i, alhora, permet rastrejar usuaris, ja que les galetes es poden emmagatzemar en el client durant un temps indeterminat. Per a con\u00e8ixer amb m\u00e9s profunditat el protocol HTTP avaluarem en qu\u00e8 consisteix una transacci\u00f3 HTTP. Cada vegada que un client fa una petici\u00f3 a un servidor, s'executen un seguit d'accions: Un usuari accedeix a una adre\u00e7a d'Internet (URL) seleccionant un enlla\u00e7 d'un document HTML o introduint-la directament a la barra de navegaci\u00f3 d'un navegador web des de la perspectiva del client web. El client web descodifica l'adre\u00e7a d'Internet (URL) separant-ne les diferents parts. \u00c9s aix\u00ed com s'identifiquen el protocol d'acc\u00e9s, el node, expressat amb el nom de domini o la seua adre\u00e7a IP, el possible port opcional (el valor per defecte \u00e9s el 80) i l'objecte del servidor requerit. S'obre una connexi\u00f3 TCP/IP amb el servidor cridant el port TCP corresponent. Es fa la petici\u00f3. En conseq\u00fc\u00e8ncia, s'envien l'ordre necess\u00e0ria (GET, POST, HEAD, etc.), l'adre\u00e7a de l'objecte requerit (el contingut de l'adre\u00e7a d'Internet del servidor), la versi\u00f3 del protocol HTTP utilitzada (en la major part de les ocasions \u00e9s HTTP/1.1) i un conjunt variable d'informaci\u00f3 que inclou dades sobre les capacitats del navegador web, dades opcionals per al servidor, etc. El servidor localitza el recurs sol\u00b7licitat i torna la resposta al client. Aquesta resposta consisteix en un codi d'estat i el tipus de dada amb extensions multiprop\u00f2sit de correu d'Internet (MIME, Multipurpose Internet Mail Extension) de la informaci\u00f3 de tornada, seguit de la mateixa informaci\u00f3. El client formata i mostra el recurs rebut. Es tanca la connexi\u00f3 TCP. Important Aquest proc\u00e9s es repeteix en cada acc\u00e9s que es fa\u00e7a al servidor HTTP. Per exemple, si es recull un document HTML que cont\u00e9 quatre imatges, el proc\u00e9s de transici\u00f3 mostrat amb anterioritat es repeteix cinc vegades, \u00e9s a dir, una pel document HTML i quatre per les imatges. Etapes d'una transacci\u00f3 HTTP Si el recurs sol\u00b7licitat \u00e9s un programa (CGI, ASP.NET, PHP, etc.) el servidor HTTP redirigir\u00e0 la petici\u00f3 a la llibreria o int\u00e8rpret adequat que executar\u00e0 el programa i tornar\u00e0 el control al servidor web. Etapes d'una sol\u00b7licitud HTTP amb processament per part del servidor","title":"El protocol HTTP"},{"location":"01-intro/01-intro/#format-de-les-url","text":"La sintaxi general de les URL consisteix en una seq\u00fc\u00e8ncia jer\u00e0rquica de 5 components: URI = scheme:[//authority]path[?query][#fragment] on el component authoriry es deivideix en tres subcomponents: authority = [userinfo@]host[:port] Sintaxi de les URL","title":"Format de les URL"},{"location":"01-intro/01-intro/#servidors-web-i-servidors-daplicacions","text":"Aix\u00ed com les aplicacions d'escriptori s'executen directament sobre el sistema operatiu, les aplicacions web necessiten d'una eina addicional que permeti desplegar-les per a la seva posada en marxa. Parlem de servidors web i servidors d'aplicacions , respectivament. Un servidor web \u00e9s una aplicaci\u00f3 que rep una petici\u00f3 HTTP (normalment a trav\u00e9s d'un navegador web) i retorna la p\u00e0gina web sol\u00b7licitada (escrita en llenguatge HTML i podent contenir codi Javascript encastat) perqu\u00e8 aquesta sigua interpretada i visualitzada pel navegador de qui va realitzar la sol\u00b7licitud (l'usuari). Un servidor d'aplicacions \u00e9s un servidor que permet l'execuci\u00f3 d'aplicacions web.","title":"Servidors web i servidors d'aplicacions"},{"location":"01-intro/01-intro/#exemples","text":"","title":"Exemples"},{"location":"01-intro/01-intro/#pagines-web-estatiques-i-dinamiques","text":"","title":"P\u00e0gines web est\u00e0tiques i din\u00e0miques"},{"location":"01-intro/01-intro/#pagines-web-estatiques","text":"Les p\u00e0gines web est\u00e0tiques s\u00f3n aquelles en que el seu contingut no varia, per la qual cosa mostraran sempre la mateixa informaci\u00f3 cada vegada que es carreguen. S\u00f3n les p\u00e0gines creades en el llenguatge HTML, CSS i javascript. Les p\u00e0gines est\u00e0tiques nom\u00e9s canvien si el programador web les modifica.","title":"P\u00e0gines web est\u00e0tiques"},{"location":"01-intro/01-intro/#pagines-web-dinamiques","text":"Les p\u00e0gines web din\u00e0miques s\u00f3n p\u00e0gines el contingut de les quals varia a partir de certa informaci\u00f3: base de dades, identificaci\u00f3 de l'usuari, hora del dia, etc. Aquest tipus de p\u00e0gines s'han de realitzar mitjan\u00e7at un llenguatge de programaci\u00f3.","title":"P\u00e0gines web din\u00e0miques"},{"location":"01-intro/01-intro/#execucio-de-codi-en-el-client-i-en-el-servidor","text":"Pel que hem pogut veure fins ara en el desenvolupament d'una aplicaci\u00f3 web podem distingir entre una s\u00e8rie de tecnologies que s'executen en el navegador ( client-side o front-end programming ) i un s\u00e8rie de tecnologies que s'executen en el servidor ( server-side o back-end programming ) En el seg\u00fcent gr\u00e0fic es mostra un escenari on podem trobar codi que s'executa en el servidor (PHP) i en el client (javascript). Execuci\u00f3 de codi en el client i en el servidor","title":"Execuci\u00f3 de codi en el client i en el servidor"},{"location":"01-intro/01-intro/#model-de-desenvolupament-en-3-capes","text":"Des d'un punt de vista de desenvolupament una aproximaci\u00f3 m\u00e9s detallada al model client-servidor \u00e9s el que es coneix com a model en 3 capes . \u00c9s un model on es mostra m\u00e9s en detall com es distribueix el programari que participa en qualsevol desenvolupament web. Segueix estant present l'arquitectura client-servidor (tot es basa en ella) per\u00f2 apareixen m\u00e9s detalls com el programari utilitzat en cada un dels dos actors i com interactuen les diferents tecnologies o aplicacions. Per comprendre millor que \u00e9s el model de desenvolupament de 3 capes podem observar el seg\u00fcent esquema on es mostra cadascuna d'aquestes capes f\u00eds\u00edques : Model de desenvolupament de 3 capes Des d'un punt de vista l\u00f2gic les capes ( layers ) es divideixen les seg\u00fcents funcionalitats: Capa de presentaci\u00f3: \u00c9s la capa on l'aplicaci\u00f3 es mostra a l'usuari. B\u00e0sicament \u00e9s la GUI ( Graphical User Interface, interf\u00edcie gr\u00e0fica d'usuari ). En el cas d'una aplicaci\u00f3 web seria el codi HTML que es carrega directament al navegador web. En qualsevol cas, s'executa directament en l'equip del client. Capa d'aplicaci\u00f3: \u00c9s la capa interm\u00e8dia on es porta a terme tota la l\u00f2gica de l'aplicaci\u00f3. Sempre s'executar\u00e0 en el costat servidor. Aquesta capa, despr\u00e9s de realitzar tots els c\u00e0lculs i/o operacions sobre les dades, genera el codi HTML que ser\u00e0 presentat a l'usuari en la capa seg\u00fcent. Sols estar desenvolupada usant PHP, Pyhton, Java, etc i es comunica amb la capa de dades mitjan\u00e7ant una API. Capa de dades: \u00c9s la capa que emmagatzema les dades. B\u00e0sicament, en condicions normals, fa refer\u00e8ncia al propi SGBD que \u00e9s l'encarregat d'emmagatzemar les dades. Depenent de l'arquitectura de l'aplicaci\u00f3, aquesta capa i la de negoci es poden trobar f\u00edsicament en el mateix equip, encara que tamb\u00e9 \u00e9s possible que s'hagin de separar per q\u00fcestions de rendiment. La capa de dades serveix totes la informaci\u00f3 necess\u00e0ria a la capa de negoci per dur a terme les seves operacions. Si ens imaginem una botiga online, la capa de dades emmagatzemaria tota la informaci\u00f3 en una base de dades (usuaris, comandes, articles, ofertes,...). La capa d'aplicaci\u00f3 hauria d'accedir a aquesta informaci\u00f3 i, despr\u00e9s processar una comanda, per exemple i finalment presentar el resultat a l'usuari en el navegador, que \u00e9s la capa de presentaci\u00f3. I si ens centrem en un cas concret amb programari i tecnologies ja definits, un model de 3 capes podria ser el seg\u00fcent: Modelo de desarrollo de 3 capas (desarrollo web con PHP) Navegador web: En aquest cas, Mozilla Firefox, Internet Explorer o Google Chrome podrien ser qualsevol de les aplicacions que ocuparien aquesta capa Apache + PHP / IIS + ASP: Un servidor web acompanyat del seu corresponent llenguatge de programaci\u00f3 web permeten desenvolupar la part que ocupa la capa de negoci. Tamb\u00e9 podr\u00edem col\u00b7locar la combinaci\u00f3 Apache Tomcat + Servlets MySQL / PostgreSQL / Node: Finalment a la capa de dades podem posar qualsevol SGBD, com poden ser MySQL o PostgreSQL. L'avantatge principal d'aquest model \u00e9s que el desenvolupament es pot dur a terme en diversos nivells i, en cas que sobrevinga algun canvi, nom\u00e9s afectar\u00e0 el nivell requerit sense haver de revisar entre el codi font d'altres m\u00f2duls, at\u00e8s que s'haur\u00e0 redu\u00eft el acoblament inform\u00e0tic fins a una interf\u00edcie de pas de missatges.","title":"Model de desenvolupament en 3 capes"},{"location":"01-intro/01-intro/#front-end-back-end-full-stack","text":"Tamb\u00e9 tenint en compte en quin costat se situen les tecnologies i per a qu\u00e8 s'utilitzen aquestes, actualment es parla molt de 3 perfils diferenciats en l'\u00e0mbit del desenvolupament web: Front-end: \u00c9s la part del desenvolupament que s'encarrega del disseny i maquetaci\u00f3 de l'aplicaci\u00f3 web utilitzant tecnologies com HTML, CSS i Javascript (i els seus frameworks). En aquest cas s'ha de preocupar tamb\u00e9 de la correcta presentaci\u00f3 en qualsevol tipus de dispositiu i fins i tot del posicionament en cercadors Back-end: \u00c9s la part del desenvolupament que s'encarrega del costat servidor utilitzant tecnologies com PHP, JSP i Python. Tamb\u00e9 s'encarrega de l'administraci\u00f3 del servidor d'aplicacions i la base de dades. Full stack: En un perfil que engloba els dos anteriors. En aquest cas el desenvolupador potser no \u00e9s un expert de cap tecnologia concreta per\u00f2 t\u00e9 amplis coneixements de tot el conjunt i \u00e9s capa\u00e7 de col\u00b7laborar en qualsevol de les parts. Fullstack","title":"Front-end, back-end, Full stack"},{"location":"01-intro/01-intro/#tipogia-de-les-aplicacions-web","text":"Depenent de la forma en qu\u00e8 s'utilitzen les tecnologies podem classificar les aplicacions en: Tradicionals o cl\u00e0ssiques, on pr\u00e0ctimanent tota la l\u00f2gica i la presentenci\u00f3 es genera en el costat de servidor. H\u00edbidres on una aplicaci\u00f3 tradicional incorpora tecnologies en el costat del client per a millorar l'experi\u00e8ncia de l'usuari. Single Page Applications (SPA). En el costat servidor es generen una s\u00e8rie de funcionalitats accessibles mitjan\u00e7ant una API i tota la c\u00e0rrega de la presentaci\u00f3 \u00e9s realitza en el costat del client que s'encarrega a m\u00e9s realizar les sol\u00b7licitus a la API. Arquitectura tradicional vs SPA","title":"Tipogia de les aplicacions web"},{"location":"01-intro/01-intro/#llenguatges","text":"","title":"Llenguatges"},{"location":"01-intro/01-intro/#php","text":"PHP ( PHP Hypertext Preprocessor ) \u00e9s un llenguatge de programaci\u00f3 de costat servidor dissenyat principalment per al desenvolupament web. PHP s'utilitza com a llenguatge de script embegut en p\u00e0gines HTML i funciona, normalment, com un m\u00f2dul del servidor web (per exemple, a Apache). El servidor web combina els resultats d'executar els scripts PHP amb l'HTML al qual va encastat i genera la p\u00e0gina web resultant per al navegador. Actualment PHP funciona pr\u00e0cticament amb qualsevol servidor web i en qualsevol Sistema Operatiu existents, i gaireb\u00e9 amb qualsevol SGBD en cas que necessitem utilitzar una base de dades. Tot i aix\u00f2, el m\u00e9s habitual \u00e9s veure-ho formant el que es coneix com una arquitectura LAMP (Linux, Apache, MySQL i PHP), \u00e9s a dir, funcionant sobre un sistema operatiu Linux, executant-com un m\u00f2dul del servidor web Apache i utilitzant a MySQL com SGBD per emmagatzemar la informaci\u00f3 en cas que es requereixi una base de dades. Arquitectura LAMP El llenguatge PHP va ser dissenyat per Rasmus Lerdorf i ara es mant\u00e9 per una comunitat de desenvolupadors, a m\u00e9s \u00e9s de codi obert. A continuaci\u00f3, un fragment d'una p\u00e0gina web din\u00e0mica escrita amb PHP on es pot apreciar com s'incrusta el codi juntament amb l'HTML de la p\u00e0gina:","title":"PHP"},{"location":"01-intro/01-intro/#jsp-servlets","text":"JavaServer Pages (tamb\u00e9 conegut com JSP) \u00e9s una tecnologia creada per a la creaci\u00f3 de p\u00e0gines web din\u00e0miques del costat servidor. Igual que PHP, el seu codi s'escriu encastat juntament amb l'HTML de la p\u00e0gina web i \u00e9s el servidor d'aplicacions, en aquest cas, qui ha de processar-per generar la p\u00e0gina web resultant, en HTML. D'altra banda, Java Servlets \u00e9s una tecnologia que tamb\u00e9 es pot utilitzar per crear contingut web din\u00e0mic per\u00f2 que a m\u00e9s est\u00e9n la seva funcionalitat a la possibilitat de connectar aquestes webs din\u00e0miques amb un altre contingut accessible a trav\u00e9s d'Internet. De vegades s'utilitza juntament amb JSP per crear aplicacions web m\u00e9s complexes. Totes dues s\u00f3n tecnologies desenvolupades per Sun Microsystems i propietat ara d'Oracle, despr\u00e9s d'adquirir aquesta \u00faltima a la primera fa ja alguns anys.","title":"JSP / Servlets"},{"location":"01-intro/01-intro/#python","text":"El llenguatge Python va ser dissenyat per Guido van Rossum i ara es mant\u00e9 gr\u00e0cies a una comunitat de desenvolupadors, i \u00e9s codi obert. Exemple de codi escrit amb Python. En aquest cas utilitzant el framework Django per al desenvolupament d'aplicacions web: < h1 > Mis pel\u00edculas </ h1 > < a href = \"#\" > + </ a > {% if lista_peliculas %} < ul > {% for pelicula in lista_peliculas %} < li >< a href = \"{% url 'pelicula' pelicula.id %}\" > {{ pelicula.titulo }} </ a ></ li > {% endfor %} </ ul > {% else %} < p > No hay pel\u00edculas disponibles </ p > {% endif %} Separada del controlador: from django.shortcuts import render . . . def index ( request ): lista_peliculas = Pelicula . objects . all () context = { 'lista_peliculas' : lista_peliculas } return render ( request , 'mispeliculas/index.html' , context )","title":"Python"},{"location":"01-intro/01-intro/#aspnet","text":"ASP.NET \u00e9s una tecnologia, creada per Microsoft, per al desenvolupament de lloc web din\u00e0mics, aplicacions i serveis web. \u00c9s la tecnologia successora del que abans es coneixia com ASP, l'antiga tecnologia de Microsoft per a la creaci\u00f3 de p\u00e0gines web din\u00e0miques. Com que funciona sobre la plataforma .NET de Microsoft, permet que es pugui desenvolupar en qualsevol dels llenguatges de programaci\u00f3 d'aquesta plataforma, Visual Basic .NET o C#. El m\u00e9s habitual \u00e9s veure-ho funcionar juntament amb el lloc web de Microsoft, IIS (Internet Information Server). A continuaci\u00f3, un exemple de p\u00e0gina web din\u00e0mica amb ASP.NET (desenvolupada en llenguatge C #) programant l'acci\u00f3 que passa en pr\u00e9mer un bot\u00f3 (apareix el text d'un formulari a la part final del web): protected void Button1_Click(object sender, EventArgs e) { string buf = TextBox1.Text; changed_text.InnerHtml = buf.ToUpper(); } < %@ Page Language=\"C#\" AutoEventWireup=\"true\" CodeBehind=\"Default.aspx.cs\" Inherits=\"firstexample._Default\" %> <!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"> < html xmlns = \"http://www.w3.org/1999/xhtml\" > < head runat = \"server\" > < title > Untitled Page </ title > </ head > < body > < form id = \"form1\" runat = \"server\" > < div > < asp:TextBox ID = \"TextBox1\" runat = \"server\" style = \"width:224px\" > </ asp:TextBox > < asp:Button ID = \"Button1\" runat = \"server\" Text = \"Enter...\" style = \"width:85px\" onclick = \"Button1_Click\" /> < hr /> < h3 > Results: </ h3 > < span runat = \"server\" id = \"changed_text\" /> </ div > </ form > </ body > </ html >","title":"ASP.NET"},{"location":"01-intro/01-intro/#bibliografia","text":"Education, I., 2020. What is Three-Tier Architecture . [online] Ibm.com. Available at: https://www.ibm.com/cloud/learn/three-tier-architecture [Accessed 9 September 2022]. MDN contributors, 2022. Introduction to the server side - Learn web development | MDN. [online] Developer.mozilla.org. Available at: https://developer.mozilla.org/en-US/docs/Learn/Server-side/First_steps/Introduction [Accessed 9 September 2022].","title":"Bibliografia"},{"location":"01-intro/02-developement/","text":"Preparant l'entorn de desenvolupament Per a poder provar els nostres llocs web necessitarem instal\u00b7lar una s\u00e8rie d'eines com s\u00f3n: el servidor web Apache, el m\u00f2dul PHP per a aquest servidor, el SGBD MySql, un front-end per al SGBD (PHPMyAdmin), etc. Per simplificar les coses optarem per instal\u00b7lar-ho mitjan\u00e7ant XAMPP, un paquet de programari lliure que cont\u00e9 el servidor HTTP Apache, la base de dades de MySQL i eines necess\u00e0ries per utilitzar el PHP i el llenguatge de programaci\u00f3 Perl. Eines de desevolupament Per a programar en llenguatges encastats com PHP, ASP o Phython \u00e9s suficient amb un editor de text pla. No obstant sempre \u00e9s recomanable treballar en un entorn integrat de desenvolupament o IDE (acr\u00f2nim en angl\u00e8s de Integrated development environment ). Un IDE \u00e9s una eina inform\u00e0tica per al desenvolupament de programari de manera c\u00f2moda i r\u00e0pida. Aix\u00ed doncs \u00e9s un entorn de desenvolupament que agrupa diferents funcions en un sol programa, habitualment: editor de codi, compilador, depurador i un programa de disseny d'interf\u00edcie gr\u00e0fica. El principal avantatge \u00e9s que facilita la tasca del programador mentre que l'inconvenient m\u00e9s important \u00e9s que pot provocar mals h\u00e0bits a l'hora de programar o provocar errors que a priori comen\u00e7ant de zero no es produirien. Alguns dels IDE m\u00e9s emprats per al desenvolupament web s\u00f3n: Eclipse Netbeans Atom Sublime PHPStorm Brackets Durant les activitats anteriors has preparat el teu propi entorn de desenvolupament sobre una m\u00e0quina virtual (o una real) tal com s'ha explicat en les anotacions. Despr\u00e9s, has de crear un projecte php utilitzant PHPStorm i visualitzar la p\u00e0gina principal a trav\u00e9s del teu servidor XAMPP. Al llarg del curs, crearem els nostres projectes utilitzant l'IDE PHPStorm. Aquesta eina \u00e9s de pagament, per\u00f2 podem utilitzar-la de forma gratu\u00efta per a projectes OpenSource i amb finalitats educatives. En aqueixos casos caldr\u00e0 sol\u00b7licitar la llic\u00e8ncia corresponent al fabricant del programari. Una vegada obtinguda la llic\u00e8ncia educativa pel professor, ser\u00e0 renovable anualment i podran utilitzar-la tots els alumnes del curs. \u00c9s una eina molt completa que ens permetr\u00e0 la integraci\u00f3 amb moltes de les funcionalitats que emprarem. Instal\u00b7laci\u00f3 de l'entorn de desenvolupament LAMP Descarrega el paquet XAMPP que continga la versi\u00f3 de PHP en la que anem a treballar durant el curs per a la nostra m\u00e0quina ( https://www.apachefriends.org/ ). Dona-li permisos d'execuci\u00f3 al fitxer descarregat: sudo chmod +x xampp-linux-x64-X.X.X-X-installer.run Executem l'assistent d'instal\u00b7laci\u00f3 sudo ./xampp-linux-x64-X.X.X.-X-installer.run En l'assistent d'instal\u00b7laci\u00f3, deixarem les opcions per defecte (excepte la qual ens parla de bitnami que la desmarcarem). Una vegada finalitzada la instal\u00b7laci\u00f3, el nostre XAMPP es trobar\u00e0 en el directori /opt/lampp Ara ja pots arrancar els serveis amb la seg\u00fcent ordre: sudo /opt/lampp/lampp start Quan els arranques, si obris el navegador i ens anem a la url http://localhost , ens hauria d'apar\u00e8ixer la p\u00e0gina de benvinguda de XAMPP. Per a parar els serveis podem fer a\u00e7\u00f2: sudo /opt/lampp/xampp stop En qualsevol cas, \u00e9s molt m\u00e9s c\u00f2mode treballar amb el panell de control de XAMPP que podrem executar amb la seg\u00fcent ordre: sudo /opt/lampp/manager-linux-x64.run Veurem que s'inicia l'aplicaci\u00f3 que ens permet controlar els serveis de XAMPP. Panell de control de XAMPP Instal\u00b7lar PHPStorm Per a instal\u00b7lar l'IDE PHPStorm seguirem els seg\u00fcents passos: Executarem sudo snap install phpstorm --classic Ens demanar\u00e0 si volem importar dades d'una instal\u00b7laci\u00f3 anterior, al que contestarem, \u00f2bviament, que no. Ens demanar\u00e0 que acceptem la pol\u00edtica de privadesa. En executar l'aplicaci\u00f3 per primera vegada ens demanar\u00e0 les dades de llic\u00e8ncia. Cada alumne s'haur\u00e0 de registrar utilitzant l'enlla\u00e7 que us passar\u00e0 el professor en classe. en pr\u00e9mer l'enlla\u00e7 ens redirigir\u00e0 a la p\u00e0gina web de jetbrains perqu\u00e8 ens registrem. Una vegada registrats, podrem accedir a l'aplicaci\u00f3 amb el nostre compte o amb el codi d'activaci\u00f3 que ens proporcionen. Finalment, indicarem la configuraci\u00f3 inicial. Creaci\u00f3 de projectes i comprovaci\u00f3 de la instal\u00b7laci\u00f3 de PHP Seguirem els passos que s'indiquen a continuaci\u00f3: Arrancar XAMPP Iniciar el m\u00f2dul Apache Executar PHPStorm Crear un projecte buit amb Create New > Project PHP Empty Project Posar al projecte el nom practica1 i situar-lo en el directori /opt/lampp/htdocs . Amb a\u00e7\u00f2 es crea un directori de nom practica1 dintre de /opt/lampp/htdocs . En la finestra de l'esquerra (explorador de projectes) apareix el projecte creat. Dins d'ell crearem un nou fitxer PHP prement bot\u00f3 dret sobre el nom i seleccionant New > PHP File . Li posem de nom index.php . En el fitxer creat introdu\u00efm les seg\u00fcents l\u00ednies de codi: <! doctype html > < html lang = \"es\" > < head > < meta charset = \"utf-8\" > < title > Desenvolupament web en entorn servidor </ title > < meta name = \"description\" content = \"PHP, PHPStorm\" > < meta name = \"author\" content = \"Homer Simpson\" > </ head > < body > <? php phpinfo (); ?> </body> </html> Canviem l'autor del document al nostre nom. Obrim el navegador i teclegem en la barra d'adreces la url: http://localhost/practica1 Apareixer\u00e0 una p\u00e0gina similar a la de la seg\u00fcent imatge: Integrant l'executable de PHP PHPStorm disposa d'ajuda intel\u00b7ligent (IntelliJ IDEA). Perqu\u00e8 aquesta ajuda es corresponga amb la versi\u00f3 de php que tenim en el nostre XAMPP haurem de registrar l'executable de PHP de XAMPP en el nostre PHPStorm. Per a a\u00e7\u00f2 seguirem els seg\u00fcents passos: En la pantalla d'inici anem a Configure \u2013 Settings . En la llista de categories de l'esquerra anem a Language & Frameworks - PHP . Necessitem indicar quin \u00e9s el nostre int\u00e8rpret. ja que la llista est\u00e0 buida anem a configurar un de la seg\u00fcent forma: Fem clic en el bot\u00f3 ... de la llista d'int\u00e8rprets Premem el bot\u00f3 + de la cantonada superior esquerra per a afegir-ne un. Li posem el nom PHP de XAMPP. Indiquem instal\u00b7lat on nostre est\u00e0 XAMPP: /opt/lampp/bin/php Immediatament ens indicar\u00e0 la versi\u00f3 de l'int\u00e8rpret que tenim instal\u00b7lat Premem OK i seleccionem el nou interprete en la llista d'int\u00e8rprets. Finalment, seleccionem en l'opci\u00f3 PHP language level aquell que es corresponga amb l'int\u00e8rpret que acabem de configurar. Ara el nostre PHPStorm far\u00e0 \u00fas del PHP de XAMPP i utilitzar\u00e0 la versi\u00f3 de PHP que tenim instal\u00b7lada quan ens oferisca les ajudes. Primer projecte amb PHPStorm Per a comen\u00e7ar a treballar amb PHPStorm anem a crear el nostre primer projecte PHP buit. Tingueu en compte que el projecte heu de crear-ho en el directori /opt/lampp/htdocs i que necessitem tenir permisos d'escriptura en aquest directori. Compte! Pot ser que ho h\u00e0gem instal\u00b7lat com root , mentre que quan executem PHPStorm ho fem amb l'usuari dwes , per tant, l'usuari dwes necessita poder escriure en aquest directori. Per a assegurar-nos que tenim permisos, anirem amb una finestra de terminal al directori /opt/lampp i executarem la seg\u00fcent ordre: ls \u2013la htdocs Aquesta ordre ens dir\u00e0 qui \u00e9s el propietari de la carpeta i quins permisos t\u00e9. En el cas que el propietari siga root executarem la seguent ordre: sudo chown -hR dwes htdocs/ A\u00e7\u00f2 canviar\u00e0 el propietari a l'usuari dwes , amb el que tindrem perm\u00eds d'escriptura en aquest directori des de PHPStorm. Treballarem tenint els projectes en la mateixa carpeta. Eines per a la depuraci\u00f3 de codi En els entorns de desevolupament \u00e9s necessari disposar de ferramentes que ens permenten depurar les nostres aplicacions. Ja siga per arreglar errors com per millorar l'execuci\u00f3 del codi. Els entorns de desevolupament d'aplicacions d'escriptori solen disposar dels seus propis sistemes de depuraci\u00f3, en el cas dels llenguatges d'entorn servidor alguns ecosistemes com el de .Net de Microsoft l'inclouen. Per a PHP hi ha diverses ferramentes com XDebug o DBG. Instal\u00b7laci\u00f3 d'XDEBUG 3.0 XDebug 3.0 Recentment s'ha publicat XDebug 3.0, versi\u00f3 que cobreix aquest document. Si busqueu informaci\u00f3, tingau en compte en quina versi\u00f3 treballeu. A continuaci\u00f3, explicarem com instal\u00b7lar el m\u00f2dul XDebug 3 en un entorn basat en XAMPP. Abans de res comprovarem que no el tenim instal\u00b7lat, per a aix\u00f2 seguirem els seg\u00fcents passos: Obrim la p\u00e0gina de benvinguda de XAMPP escrivint al navegador la URL http://localhost . A la part superior de la p\u00e0gina tenim una s\u00e8rie d'enlla\u00e7os, entre els que es troba un que diu phpinfo . Feu clic en aquest enlla\u00e7. Se'ns mostrar\u00e0 la p\u00e0gina de configuraci\u00f3 del nostre m\u00f2dul php. Anem a seleccionar tots els continguts d'aquesta p\u00e0gina i els anem a copiar. Obrirem al navegador la seg\u00fcent URL: http://xdebug.org/wizard.php . En aquesta p\u00e0gina podrem comprovar quins m\u00f2duls tenim instal\u00b7lats en nostre m\u00f2dul PHP. Per a aix\u00f2, enganxarem els continguts que hem copiat pr\u00e8viament a la caixa de text que apareix i premerem Analyse mi phpinfo() output . Ens apareixeran un resultats semblants a aquests: Com es pot observar, l'extensi\u00f3 XDebug no est\u00e0 instal\u00b7lada. Una altra informaci\u00f3 important que ens d\u00f3na \u00e9s que el nostre fitxer de configuraci\u00f3 del PHP el podem trobar en /opt/lampp/etc/php.ini i les extensions les tenim en /opt/lampp/lib/php/extensions/no-debug-non-zts-20180731 \u00c9s important que recordem aquestes dades. Per instal\u00b7lar l'extensi\u00f3 XDebug seguirem les instruccions que ens indica la p\u00e0gina anterior per\u00f2 compte perqu\u00e8 cal fer algunes modificacions: Important Els car\u00e0cters # representen valors que depenen de cada instal\u00b7laci\u00f3, aix\u00ed que cal tindre-ho en compte en executar-ho. Descarregueu la darrera versi\u00f3 d'Xdebug Instal\u00b7leu els requisits previs per a la compilaci\u00f3 d'extensions PHP.\\ Instal\u00b7leu-lo amb el sistema Ubuntu amb: apt-get install php-dev autoconf automake Desempaqueteu el fitxer descarregat amb tar -xvzf xdebug-#.#.#.tgz Executar: cd xdebug-#.#.# Executar: /opt/lampp/bin/phpize (hem canviat la ruta perqu\u00e8 execute el phpize de XAMPP). Com a part de la seva eixida hauria de mostrar: Configuring for: ... Zend Module Api No: ######## Zend Extension Api No: ######### Si no \u00e9s aix\u00ed, est\u00e0s utilitzant phpize incorrecta. Seguiu aquesta entrada de FAQ i passeu al pas seg\u00fcent. Executar: ./configure --with-php-config=/opt/lampp/bin/php-config (hem afegit la ruta del php-config de XAMPP). Compilem les fonts: make Executar: sudo cp modules/xdebug.so /opt/lampp/lib/php/extensions/no-debug-non-zts-######## Edita /opt/lampp/etc/php.ini i afegeix les seg\u00fcents l\u00ednies al final [xdebug] zend_extension=xdebug Reinicieu el servidor web Repeteix els passos del 1 al 5 inicials per comprovar que XDebug s\u00ed est\u00e0 instal\u00b7lat. Despr\u00e9s caldr\u00e0 configurar PHPStorm per a connectar-lo a XDebug Integraci\u00f3 amb PHPStorm i instal\u00b7lar una extensi\u00f3 de Firefox Xdebug Helper o Chrome.","title":"Preparaci\u00f3 de l'entorn de desenvolupament"},{"location":"01-intro/02-developement/#preparant-lentorn-de-desenvolupament","text":"Per a poder provar els nostres llocs web necessitarem instal\u00b7lar una s\u00e8rie d'eines com s\u00f3n: el servidor web Apache, el m\u00f2dul PHP per a aquest servidor, el SGBD MySql, un front-end per al SGBD (PHPMyAdmin), etc. Per simplificar les coses optarem per instal\u00b7lar-ho mitjan\u00e7ant XAMPP, un paquet de programari lliure que cont\u00e9 el servidor HTTP Apache, la base de dades de MySQL i eines necess\u00e0ries per utilitzar el PHP i el llenguatge de programaci\u00f3 Perl.","title":"Preparant l'entorn de desenvolupament"},{"location":"01-intro/02-developement/#eines-de-desevolupament","text":"Per a programar en llenguatges encastats com PHP, ASP o Phython \u00e9s suficient amb un editor de text pla. No obstant sempre \u00e9s recomanable treballar en un entorn integrat de desenvolupament o IDE (acr\u00f2nim en angl\u00e8s de Integrated development environment ). Un IDE \u00e9s una eina inform\u00e0tica per al desenvolupament de programari de manera c\u00f2moda i r\u00e0pida. Aix\u00ed doncs \u00e9s un entorn de desenvolupament que agrupa diferents funcions en un sol programa, habitualment: editor de codi, compilador, depurador i un programa de disseny d'interf\u00edcie gr\u00e0fica. El principal avantatge \u00e9s que facilita la tasca del programador mentre que l'inconvenient m\u00e9s important \u00e9s que pot provocar mals h\u00e0bits a l'hora de programar o provocar errors que a priori comen\u00e7ant de zero no es produirien. Alguns dels IDE m\u00e9s emprats per al desenvolupament web s\u00f3n: Eclipse Netbeans Atom Sublime PHPStorm Brackets Durant les activitats anteriors has preparat el teu propi entorn de desenvolupament sobre una m\u00e0quina virtual (o una real) tal com s'ha explicat en les anotacions. Despr\u00e9s, has de crear un projecte php utilitzant PHPStorm i visualitzar la p\u00e0gina principal a trav\u00e9s del teu servidor XAMPP. Al llarg del curs, crearem els nostres projectes utilitzant l'IDE PHPStorm. Aquesta eina \u00e9s de pagament, per\u00f2 podem utilitzar-la de forma gratu\u00efta per a projectes OpenSource i amb finalitats educatives. En aqueixos casos caldr\u00e0 sol\u00b7licitar la llic\u00e8ncia corresponent al fabricant del programari. Una vegada obtinguda la llic\u00e8ncia educativa pel professor, ser\u00e0 renovable anualment i podran utilitzar-la tots els alumnes del curs. \u00c9s una eina molt completa que ens permetr\u00e0 la integraci\u00f3 amb moltes de les funcionalitats que emprarem.","title":"Eines de desevolupament"},{"location":"01-intro/02-developement/#installacio-de-lentorn-de-desenvolupament-lamp","text":"Descarrega el paquet XAMPP que continga la versi\u00f3 de PHP en la que anem a treballar durant el curs per a la nostra m\u00e0quina ( https://www.apachefriends.org/ ). Dona-li permisos d'execuci\u00f3 al fitxer descarregat: sudo chmod +x xampp-linux-x64-X.X.X-X-installer.run Executem l'assistent d'instal\u00b7laci\u00f3 sudo ./xampp-linux-x64-X.X.X.-X-installer.run En l'assistent d'instal\u00b7laci\u00f3, deixarem les opcions per defecte (excepte la qual ens parla de bitnami que la desmarcarem). Una vegada finalitzada la instal\u00b7laci\u00f3, el nostre XAMPP es trobar\u00e0 en el directori /opt/lampp Ara ja pots arrancar els serveis amb la seg\u00fcent ordre: sudo /opt/lampp/lampp start Quan els arranques, si obris el navegador i ens anem a la url http://localhost , ens hauria d'apar\u00e8ixer la p\u00e0gina de benvinguda de XAMPP. Per a parar els serveis podem fer a\u00e7\u00f2: sudo /opt/lampp/xampp stop En qualsevol cas, \u00e9s molt m\u00e9s c\u00f2mode treballar amb el panell de control de XAMPP que podrem executar amb la seg\u00fcent ordre: sudo /opt/lampp/manager-linux-x64.run Veurem que s'inicia l'aplicaci\u00f3 que ens permet controlar els serveis de XAMPP. Panell de control de XAMPP","title":"Instal\u00b7laci\u00f3 de l'entorn de desenvolupament LAMP"},{"location":"01-intro/02-developement/#installar-phpstorm","text":"Per a instal\u00b7lar l'IDE PHPStorm seguirem els seg\u00fcents passos: Executarem sudo snap install phpstorm --classic Ens demanar\u00e0 si volem importar dades d'una instal\u00b7laci\u00f3 anterior, al que contestarem, \u00f2bviament, que no. Ens demanar\u00e0 que acceptem la pol\u00edtica de privadesa. En executar l'aplicaci\u00f3 per primera vegada ens demanar\u00e0 les dades de llic\u00e8ncia. Cada alumne s'haur\u00e0 de registrar utilitzant l'enlla\u00e7 que us passar\u00e0 el professor en classe. en pr\u00e9mer l'enlla\u00e7 ens redirigir\u00e0 a la p\u00e0gina web de jetbrains perqu\u00e8 ens registrem. Una vegada registrats, podrem accedir a l'aplicaci\u00f3 amb el nostre compte o amb el codi d'activaci\u00f3 que ens proporcionen. Finalment, indicarem la configuraci\u00f3 inicial.","title":"Instal\u00b7lar PHPStorm"},{"location":"01-intro/02-developement/#creacio-de-projectes-i-comprovacio-de-la-installacio-de-php","text":"Seguirem els passos que s'indiquen a continuaci\u00f3: Arrancar XAMPP Iniciar el m\u00f2dul Apache Executar PHPStorm Crear un projecte buit amb Create New > Project PHP Empty Project Posar al projecte el nom practica1 i situar-lo en el directori /opt/lampp/htdocs . Amb a\u00e7\u00f2 es crea un directori de nom practica1 dintre de /opt/lampp/htdocs . En la finestra de l'esquerra (explorador de projectes) apareix el projecte creat. Dins d'ell crearem un nou fitxer PHP prement bot\u00f3 dret sobre el nom i seleccionant New > PHP File . Li posem de nom index.php . En el fitxer creat introdu\u00efm les seg\u00fcents l\u00ednies de codi: <! doctype html > < html lang = \"es\" > < head > < meta charset = \"utf-8\" > < title > Desenvolupament web en entorn servidor </ title > < meta name = \"description\" content = \"PHP, PHPStorm\" > < meta name = \"author\" content = \"Homer Simpson\" > </ head > < body > <? php phpinfo (); ?> </body> </html> Canviem l'autor del document al nostre nom. Obrim el navegador i teclegem en la barra d'adreces la url: http://localhost/practica1 Apareixer\u00e0 una p\u00e0gina similar a la de la seg\u00fcent imatge:","title":"Creaci\u00f3 de projectes i comprovaci\u00f3 de la instal\u00b7laci\u00f3 de PHP"},{"location":"01-intro/02-developement/#integrant-lexecutable-de-php","text":"PHPStorm disposa d'ajuda intel\u00b7ligent (IntelliJ IDEA). Perqu\u00e8 aquesta ajuda es corresponga amb la versi\u00f3 de php que tenim en el nostre XAMPP haurem de registrar l'executable de PHP de XAMPP en el nostre PHPStorm. Per a a\u00e7\u00f2 seguirem els seg\u00fcents passos: En la pantalla d'inici anem a Configure \u2013 Settings . En la llista de categories de l'esquerra anem a Language & Frameworks - PHP . Necessitem indicar quin \u00e9s el nostre int\u00e8rpret. ja que la llista est\u00e0 buida anem a configurar un de la seg\u00fcent forma: Fem clic en el bot\u00f3 ... de la llista d'int\u00e8rprets Premem el bot\u00f3 + de la cantonada superior esquerra per a afegir-ne un. Li posem el nom PHP de XAMPP. Indiquem instal\u00b7lat on nostre est\u00e0 XAMPP: /opt/lampp/bin/php Immediatament ens indicar\u00e0 la versi\u00f3 de l'int\u00e8rpret que tenim instal\u00b7lat Premem OK i seleccionem el nou interprete en la llista d'int\u00e8rprets. Finalment, seleccionem en l'opci\u00f3 PHP language level aquell que es corresponga amb l'int\u00e8rpret que acabem de configurar. Ara el nostre PHPStorm far\u00e0 \u00fas del PHP de XAMPP i utilitzar\u00e0 la versi\u00f3 de PHP que tenim instal\u00b7lada quan ens oferisca les ajudes. Primer projecte amb PHPStorm Per a comen\u00e7ar a treballar amb PHPStorm anem a crear el nostre primer projecte PHP buit. Tingueu en compte que el projecte heu de crear-ho en el directori /opt/lampp/htdocs i que necessitem tenir permisos d'escriptura en aquest directori. Compte! Pot ser que ho h\u00e0gem instal\u00b7lat com root , mentre que quan executem PHPStorm ho fem amb l'usuari dwes , per tant, l'usuari dwes necessita poder escriure en aquest directori. Per a assegurar-nos que tenim permisos, anirem amb una finestra de terminal al directori /opt/lampp i executarem la seg\u00fcent ordre: ls \u2013la htdocs Aquesta ordre ens dir\u00e0 qui \u00e9s el propietari de la carpeta i quins permisos t\u00e9. En el cas que el propietari siga root executarem la seguent ordre: sudo chown -hR dwes htdocs/ A\u00e7\u00f2 canviar\u00e0 el propietari a l'usuari dwes , amb el que tindrem perm\u00eds d'escriptura en aquest directori des de PHPStorm. Treballarem tenint els projectes en la mateixa carpeta.","title":"Integrant l'executable de PHP"},{"location":"01-intro/02-developement/#eines-per-a-la-depuracio-de-codi","text":"En els entorns de desevolupament \u00e9s necessari disposar de ferramentes que ens permenten depurar les nostres aplicacions. Ja siga per arreglar errors com per millorar l'execuci\u00f3 del codi. Els entorns de desevolupament d'aplicacions d'escriptori solen disposar dels seus propis sistemes de depuraci\u00f3, en el cas dels llenguatges d'entorn servidor alguns ecosistemes com el de .Net de Microsoft l'inclouen. Per a PHP hi ha diverses ferramentes com XDebug o DBG.","title":"Eines per a la depuraci\u00f3 de codi"},{"location":"01-intro/02-developement/#installacio-dxdebug-30","text":"XDebug 3.0 Recentment s'ha publicat XDebug 3.0, versi\u00f3 que cobreix aquest document. Si busqueu informaci\u00f3, tingau en compte en quina versi\u00f3 treballeu. A continuaci\u00f3, explicarem com instal\u00b7lar el m\u00f2dul XDebug 3 en un entorn basat en XAMPP. Abans de res comprovarem que no el tenim instal\u00b7lat, per a aix\u00f2 seguirem els seg\u00fcents passos: Obrim la p\u00e0gina de benvinguda de XAMPP escrivint al navegador la URL http://localhost . A la part superior de la p\u00e0gina tenim una s\u00e8rie d'enlla\u00e7os, entre els que es troba un que diu phpinfo . Feu clic en aquest enlla\u00e7. Se'ns mostrar\u00e0 la p\u00e0gina de configuraci\u00f3 del nostre m\u00f2dul php. Anem a seleccionar tots els continguts d'aquesta p\u00e0gina i els anem a copiar. Obrirem al navegador la seg\u00fcent URL: http://xdebug.org/wizard.php . En aquesta p\u00e0gina podrem comprovar quins m\u00f2duls tenim instal\u00b7lats en nostre m\u00f2dul PHP. Per a aix\u00f2, enganxarem els continguts que hem copiat pr\u00e8viament a la caixa de text que apareix i premerem Analyse mi phpinfo() output . Ens apareixeran un resultats semblants a aquests: Com es pot observar, l'extensi\u00f3 XDebug no est\u00e0 instal\u00b7lada. Una altra informaci\u00f3 important que ens d\u00f3na \u00e9s que el nostre fitxer de configuraci\u00f3 del PHP el podem trobar en /opt/lampp/etc/php.ini i les extensions les tenim en /opt/lampp/lib/php/extensions/no-debug-non-zts-20180731 \u00c9s important que recordem aquestes dades. Per instal\u00b7lar l'extensi\u00f3 XDebug seguirem les instruccions que ens indica la p\u00e0gina anterior per\u00f2 compte perqu\u00e8 cal fer algunes modificacions: Important Els car\u00e0cters # representen valors que depenen de cada instal\u00b7laci\u00f3, aix\u00ed que cal tindre-ho en compte en executar-ho. Descarregueu la darrera versi\u00f3 d'Xdebug Instal\u00b7leu els requisits previs per a la compilaci\u00f3 d'extensions PHP.\\ Instal\u00b7leu-lo amb el sistema Ubuntu amb: apt-get install php-dev autoconf automake Desempaqueteu el fitxer descarregat amb tar -xvzf xdebug-#.#.#.tgz Executar: cd xdebug-#.#.# Executar: /opt/lampp/bin/phpize (hem canviat la ruta perqu\u00e8 execute el phpize de XAMPP). Com a part de la seva eixida hauria de mostrar: Configuring for: ... Zend Module Api No: ######## Zend Extension Api No: ######### Si no \u00e9s aix\u00ed, est\u00e0s utilitzant phpize incorrecta. Seguiu aquesta entrada de FAQ i passeu al pas seg\u00fcent. Executar: ./configure --with-php-config=/opt/lampp/bin/php-config (hem afegit la ruta del php-config de XAMPP). Compilem les fonts: make Executar: sudo cp modules/xdebug.so /opt/lampp/lib/php/extensions/no-debug-non-zts-######## Edita /opt/lampp/etc/php.ini i afegeix les seg\u00fcents l\u00ednies al final [xdebug] zend_extension=xdebug Reinicieu el servidor web Repeteix els passos del 1 al 5 inicials per comprovar que XDebug s\u00ed est\u00e0 instal\u00b7lat. Despr\u00e9s caldr\u00e0 configurar PHPStorm per a connectar-lo a XDebug Integraci\u00f3 amb PHPStorm i instal\u00b7lar una extensi\u00f3 de Firefox Xdebug Helper o Chrome.","title":"Instal\u00b7laci\u00f3 d'XDEBUG 3.0"},{"location":"01-intro/99-tasks/","text":"Activitats Aplicacions Web Inspeccionant sol\u00b7licituds des del terminal curl \u00e9s un programari realitzar sol\u00b7licituds HTTP, \u00e9s a dir, un client HTTP, des de la l\u00ednia de comandaments. Permet l'automatitzaci\u00f3 de les sol\u00b7licituds. Usa curl per a accedir a les seg\u00fcents URL i registra en un documents les respostes incloent el codi d'estat i el tipus MIME: http://www.google.com https://google.com https://www.google.com https://www.google.com/x L'ordre concreta \u00e9s: curl -sSL -D - URL -o /dev/null Inspeccionats sol\u00b7licituds HTTP des del navegador Des de l'opci\u00f3 Eines per a desenvolupadors de Firefox \u00e9s possible accedir a la pestanya Xarxa per poder comprova totes les sol\u00b7licituds que ha generat la URL a la que hem accedit. Activa l'opci\u00f3 anterior i accedeix a Google. Fes una captura de les sol\u00b7licituds que inclouen JS, CSS i Imatges. Busca tres ofertes de treball de desenvolupament de software a Infojobs en la prov\u00edncia d'Alacant que citen PHP i anota: Empresa + lloc de treball + frameworks PHP + requisits + salari + enll\u00e7 a l'oferta. Entorn de desenvolupament Instal\u00b7laci\u00f3 de l'entorn de desenvolupament LAMP Seguint les instruccions dels apunts instal\u00b7la l'entorn de desevolupament Instal\u00b7laci\u00f3 de PHPStorm Seguint les instruccions dels apunts instal\u00b7la i configura PHP Storm. Prova d'Apache i PHP L'objectiu d'aquesta pr\u00e0ctica \u00e9s aprendre el maneig b\u00e0sic de l'entorn de desenvolupament PHPStorm creant una primera p\u00e0gina PHP que alhora servir\u00e0 per a comprovar la correcta instal\u00b7laci\u00f3 de XAMPP. Seguint les instruccions dels apunts crea projecte i prova'l. Instal\u00b7laci\u00f2 d'XDebug Seguint les instruccions dels apunts instal\u00b7la i configura XDEBUG i connecta'l a PHP Storm. Creaci\u00f3 d'un virtualhost Crea un nou host virtual que responga a la url: bloc-i.local i el document arrel ( document root ) siga el directori /home/USUARI/projectes/bloc-i . Crea en el document root un fitxer index.php que contiga <? php echo \"Hola mon!\" ?> Comprova que funciona accediant a http://bloc-i.local .","title":"Activitats"},{"location":"01-intro/99-tasks/#activitats","text":"","title":"Activitats"},{"location":"01-intro/99-tasks/#aplicacions-web","text":"Inspeccionant sol\u00b7licituds des del terminal curl \u00e9s un programari realitzar sol\u00b7licituds HTTP, \u00e9s a dir, un client HTTP, des de la l\u00ednia de comandaments. Permet l'automatitzaci\u00f3 de les sol\u00b7licituds. Usa curl per a accedir a les seg\u00fcents URL i registra en un documents les respostes incloent el codi d'estat i el tipus MIME: http://www.google.com https://google.com https://www.google.com https://www.google.com/x L'ordre concreta \u00e9s: curl -sSL -D - URL -o /dev/null Inspeccionats sol\u00b7licituds HTTP des del navegador Des de l'opci\u00f3 Eines per a desenvolupadors de Firefox \u00e9s possible accedir a la pestanya Xarxa per poder comprova totes les sol\u00b7licituds que ha generat la URL a la que hem accedit. Activa l'opci\u00f3 anterior i accedeix a Google. Fes una captura de les sol\u00b7licituds que inclouen JS, CSS i Imatges. Busca tres ofertes de treball de desenvolupament de software a Infojobs en la prov\u00edncia d'Alacant que citen PHP i anota: Empresa + lloc de treball + frameworks PHP + requisits + salari + enll\u00e7 a l'oferta.","title":"Aplicacions Web"},{"location":"01-intro/99-tasks/#entorn-de-desenvolupament","text":"Instal\u00b7laci\u00f3 de l'entorn de desenvolupament LAMP Seguint les instruccions dels apunts instal\u00b7la l'entorn de desevolupament Instal\u00b7laci\u00f3 de PHPStorm Seguint les instruccions dels apunts instal\u00b7la i configura PHP Storm. Prova d'Apache i PHP L'objectiu d'aquesta pr\u00e0ctica \u00e9s aprendre el maneig b\u00e0sic de l'entorn de desenvolupament PHPStorm creant una primera p\u00e0gina PHP que alhora servir\u00e0 per a comprovar la correcta instal\u00b7laci\u00f3 de XAMPP. Seguint les instruccions dels apunts crea projecte i prova'l. Instal\u00b7laci\u00f2 d'XDebug Seguint les instruccions dels apunts instal\u00b7la i configura XDEBUG i connecta'l a PHP Storm. Creaci\u00f3 d'un virtualhost Crea un nou host virtual que responga a la url: bloc-i.local i el document arrel ( document root ) siga el directori /home/USUARI/projectes/bloc-i . Crea en el document root un fitxer index.php que contiga <? php echo \"Hola mon!\" ?> Comprova que funciona accediant a http://bloc-i.local .","title":"Entorn de desenvolupament"},{"location":"02-basics/02-phpbasics/","text":"El llenguatge PHP Objectius Con\u00e8ixer la sintaxi b\u00e0sica de PHP i les noves caracter\u00edstiques de PHP 8. Entendre com s'integren PHP i HTML. Descriure els tipus de dades existents en PHP. Fer servir les estructures de control b\u00e0siques. Aprendre a utilitzar els arrays associatius. Con\u00e8ixer els mecanismes de pas de par\u00e0metres a un script. Processar i validar formularis Incloure fitxers Introducci\u00f3 Acr\u00f2nim de Personal Home Page Llenguatge de prop\u00f2sit general, encara que el seu fort \u00e9s el desenvolupament web. Sintaxi similar a C/Java El codi s'executa en el servidor (en Apache mitjan\u00e7ant mod_php ) El client rep el resultat generat despr\u00e9s d'interpretar el codi al servidor. El codi s'emmagatzema en arxiu amb extensi\u00f3 .php. L'\u00faltima versi\u00f3 \u00e9s la 8.1, de novembre de 2021 (i en breu tindrem la versi\u00f3 8.2). La versi\u00f3 7.0 va sortir al desembre de 2015. A m\u00e9s de nombroses noves funcionalitats que anirem veient durant el curs, t\u00e9 m\u00e9s de dues vegades millor rendiment que PHP5. PHP 8.1 Nosaltres farem \u00fas de la versi\u00f3 8.1 de PHP La seva documentaci\u00f3 \u00e9s extensa i est\u00e0 tradu\u00efda: https://www.php.net/manual/es/. Funcionament i estructura b\u00e0sica El nostre primer codi PHP El codi PHP sempre va entre els simbolos <?php i ?> . Les instruccions PHP acaben sempre amb ; . <!DOCTYPE html> < html lang = \"ca\" > < head > < meta charset = \"UTF-8\" > < title > PHP f\u00e0cil </ title > </ head > < body > <!-- Mostra una frase en HTML --> Hola m\u00f3n! < br > <!-- Mostra una frase en PHP --> <?php echo \"\u00c9s molt f\u00e0cil programar en PHP.\" ; ?> </ body > </ html > Per a generar codi HTML des de PHP podem utilitzar diversos m\u00e8todes: echo expressi\u00f3 print (expressi\u00f3) <?= expressi\u00f3 ?> El codi pot anar entre les etiquetes d'HTML. < html > < head ></ head > < body > < h1 > <?php echo \"Hola m\u00f3n\" ?> </ h1 > < body > < html > < head ></ head > < body > < h1 > <? = \"Hola m\u00f3n\" ?> </ h1 > < body > Comentaris De bloc entre /* i */ . De linea, comen\u00e7ant per // o per # . Variables i tipus de dades Una de les caracter\u00edstiques de PHP \u00e9s que \u00e9s un llenguatge no fortament tipat (com Javascript). De fet, no cal declarar la variable ni indicar el tipus de dades si la declare. Encara que si volem codi de qualitat ho hauriem de fer. Declaraci\u00f3 Els noms de les variables sempre comencen per $ Despr\u00e9s del $ els noms de les variables han d'anar seguits per una lletra o el car\u00e0cter _ i poden contenir tamb\u00e9 n\u00fameros. No \u00e9s necessari declarar una variable ni especificar-li un tipus (enter, cadena,...) concret. Les variables s\u00f3n case sensitive : $var != $vAR . Per crear una variable que continga el text a generar i mostrar-la: < html > < head ></ head > < body > < h1 > <?php $salutacio = \"Hola m\u00f3n\" ; echo $salutacio ; ?> </ h1 > < body > Tipus de les variables El tipus de la variable es decideix en funci\u00f3 del context en qu\u00e8 s'utilitze. En assignar-li el valor 7, la variable \u00e9s de tipus \u201csencer\u201d $la_meua_variable = 7 ; // ara \u00e9s un n\u00famero $la_meua_variable = \"set\" ; // ara \u00e9s cadena Si li canviem el contingut passa a ser de tipus \u201ccadena\u201d Variable no inicialitzades Si s'intenta utilitzar una variable abans d'assignar-li un valor, es genera un error de tipus E_NOTICE per\u00f2 no s'interromp l'execuci\u00f3 de l'script. L'eixida mostrar\u00e0 un av\u00eds cada volta que s'intente. Tipus de dades en PHP boole\u00e0 ( boolean ). Els seus possibles valors s\u00f3n true i false . A m\u00e9s, qualsevol nombre enter es considera com true , excepte el 0 que \u00e9s false . enters ( integer ). Qualsevol nombre sense decimals. Es poden representar en format decimal, octal (comen\u00e7ant per un 0), o hexadecimal (comen\u00e7ant per 0x). real ( float ). Qualsevol nombre amb decimals. Es poden representar tamb\u00e9 en notaci\u00f3 cient\u00edfica. cadena ( string ). Conjunts de car\u00e0cters delimitats per cometes simples o dobles. vector ( array ). Conjunt de variables del mateix tipus ordenades. Objecte ( object ). Utilitzat per les inst\u00e0ncies de classes. null . \u00c9s un tipus de dades especial, que s'usa per a indicar que la variable no t\u00e9 valor. ( http://php.net/manual/es/language.types.null.php ) Valors que s'avaluen a false Quan es realitzen operacions que s'avaluen com a boole\u00e0 els seg\u00fcents valors s'avaluaran a false : els enters 0 i -0 (zero). els reals 0.0 y -0.0 (zero). la cadena buida i la cadena \"0\" . un array amb zero elements. el tipus especial NULL (incloses les variables no inicialitzades). \u00c0mbit de les variables L'\u00e0mbit d'una variable indica quina \u00e9s la part del codi en qu\u00e8 la variable esmentada \u00e9s accessible. Una variable declarada en un fitxer de PHP est\u00e0 disponible en aqueix fitxer i en els que incloguen. Les funcions defineixen un \u00e0mbit local, separat de la resta del codi. No obstant aix\u00f2, es poden definir variables globals amb la paraula reservada global , encara que no s\u00f3n aconsellables. $a = 1 ; /* global scope */ function test () { echo $a ; /* reference to local scope variable */ } test (); // \"\" function test2 () { global $a ; /* reference to global scope variable */ echo $a ; } test2 (); // 1 Constants Per a definir constants s'utilitza define() , que reb el nom de la constant i el valor que li volem donar. Tamb\u00e9 podem user la paraula reservada const . const PI = 3.1415927 define ( \"PI\" , 3.1415927 ) Constants sempre en maj\u00fascules \u00c9s una convenci\u00f3 utilitzar identificadors en maj\u00fascules per a les constants. Operadors Arim\u00e8tics Exemple Nom Resultat +$a Identidat Conversi\u00f3 de $a a int o float segons el cas. -$a Negaci\u00f3 Oposat de $a . $a + $b Suma Suma de $a i $b . $a - $b Resta Difer\u00e8ncia de $a i $b . $a * $b Multiplicaci\u00f3 Producte de $a i $b . $a / $b Divisi\u00f3 Quocient de $a i $b . $a % $b M\u00f3dul / Residu Residu de $a dividit per $b . $a ** $b Pot\u00e8ncia Resultat de $a elevat a $b . PHP >= 5.6. En el caso de cadenas , si queremos concatenarlas, se utiliza el operador . : $x = 33 ; $y = 11 ; $z = $x + $y ; echo \"La suma de 33 y 11 es \" . 44. \"<br />\" ; echo \"La suma de \" . $x . \" y \" . $y . \" es \" . ( 33 + 11 ) . \"<br />\" ; echo \"La suma de \" . $x . \" y \" . $y . \" es \" . $z . \"<br />\" ; Realment en lloc de concatenar cadenas con variables, podem imprimir-les directament ja que s'expandeixen autom\u00e0ticament: echo \"La suma de $x y $y es $z <br />\" ; A vegades, necessitem envoltar el nom de la variable entre claus per poder un m\u00e9s text al resultat: $color = \"rojo\" ; echo \"El plural de $color el ${ color } s\" ; ?> M\u00e9s endavant estudiarem algunes funcions per al tractament de cadenes. Comparaci\u00f3 Exemple Nom Resultat $a == $b Igual true si $a \u00e9s igual a $b despr\u00e9s de la conversi\u00f3 de tipus. $a === $b Id\u00e8ntic, Comparaci\u00f3 estricta true si $a \u00e9s igual a $b , i s\u00f3n del mateix tipus de dada. $a != $b , $a <> $b Diferent true si $a no \u00e9s igual a $b despr\u00e9s de la conversi\u00f3 de tipus. $a !== $b No id\u00e8ntic true si $a no \u00e9s igual a $b , o si no s\u00f3n del mateix tipus. $a < $b Menor que true si $a \u00e9s estrictament menor que $b . $a > $b Major que true si $a \u00e9s estrictament major que $b . $a <= $b Menor o igual que true si $a \u00e9s menor o igual que $b . $a >= $b Major o igual que true si $a \u00e9s major o igual que $b . $a <=> $b Nau espacial Torna -1 , 0 o 1 quan $a \u00e9s respectivamente menor, igual, o major que $b . PHP >= 7. $a ?? $b ?? $c Fusi\u00f3n de null El primer operano d'esquerra a dreta que existisca i no siga null . null si no hi ha valors definits i no s\u00f3n null . PHP >= 7. L\u00f2gics Exemple Nom Resultat $a and $b , $a && $b And (i) true si tant $a com $b s\u00f3n true . $a or $b , $a || $b Or (o inclusiu) true si qualsevol de $a o $b \u00e9s true . $a xor $b Xor (o exclusiu) true si $a o $b \u00e9s true , pero no ambd\u00f3s. !$a Not (no) true si $a no \u00e9s true . Assignaci\u00f3 Exemple Nom Resultat $a = $b Assignaci\u00f3 Assigna a $a el valor de $b $a += $b Assignaci\u00f3 de la suma Le suma a $a el valor de $b . Equivalent a $a = $a + $b $a -= $b Assignaci\u00f3 de la resta Le resta a $a el valor de $b . Equivalent a $a = $a - $b $a *= $b Assignaci\u00f3 del producte Assigna a $a el producto de $a por $b . Equivalent a $a = $a * $b $a /= $b Assignaci\u00f3 de la divisi\u00f3 Assigna a $a el quocient de $a entre $b . Equivalent a $a = $a / $b $a %= $b Assignaci\u00f3 del residu Assigna a $a el residu de dividir $a entre $b . Equivalent a $a = $a % $b $a .= $b Concatenaci\u00f3 Concatena a $a la cadena $b . Equivalent a $a = $a . $b $a++ Increment Incrementa $a en una unitat. Equivalent a $a = $a + 1 $a-- Decrement Decrementa $a en una unitat. Equivalent a $a = $a - 1 Prioritat dels operadors Recorda la prioritat. Primer els par\u00e8ntesis, despr\u00e9s la negaci\u00f3 ( ! ), productes/divisions, sumes/restes, comparacions, l\u00f2gics i finalment es realitza l'assignaci\u00f3. M\u00e9s informaci\u00f3 a https://www.php.net/manual/es/language.operators.precedence.php Autoavaluaci\u00f3 Si $a=5 i $b=4 , esbrina el valor de $c si $c = $a*2 > $b+5 && !($b<>4) Treballant en formularis Les dades s'envien via URL en el format var1=valor1&var2=valor2\u2026. Per exemple: exemple.php?nom=Homer+cognom=Simpson Es divideix en dos passos: Genera un formulari amb l'atribut action='file.php' method='GET' . En el fitxer .php cal llegir les dades amb $_GET['varName'] . Anem a separar sempre que puguem el codi HTML del de PHP. Per exemple, el formulari el coloquem en saluda.html : < form action = \"saluda.php\" method = \"get\" > < p >< label for = \"nombre\" > Nombre: </ label > < input type = \"text\" name = \"nombre\" id = \"nombre\" ></ p > < p >< label for = \"apellido1\" > Primer apellido: </ label > < input type = \"text\" name = \"apellido1\" id = \"apellido1\" ></ p > < p >< input type = \"submit\" value = \"enviar\" ></ p > </ form > I recollim les dades en saluda.php : <? php $nombre = $_GET [ \"nombre\" ]; $apellido1 = $_GET [ \"apellido1\" ]; echo \"Hola $nombre $apellido1 \" ; ?> Si volgu\u00e9ssim fer-ho tot en un \u00fanic fitxer (la qual cosa no es recomanable), podem fer-ho aix\u00ed: < form action = \"\" method = \"get\" > < p >< label for = \"nombre\" > Nombre: </ label > < input type = \"text\" name = \"nombre\" id = \"nombre\" ></ p > < p >< label for = \"apellido1\" > Primer apellido: </ label > < input type = \"text\" name = \"apellido1\" id = \"apellido1\" ></ p > < input type = \"submit\" value = \"enviar\" > </ form > < p > <?php if ( isset ( $_GET [ 'nombre' ])) { $nombre = $_GET [ \"nombre\" ]; $apellido1 = $_GET [ \"apellido1\" ]; echo \"Hola $nombre $apellido1 \" ; } ?> </ p > M\u00e9s endavant aprofundirem en la gesti\u00f3 de formularis. Estructures de control de flux Les instruccions de control de flux en PHP funcionen exactament igual que en altres llenguatges de programaci\u00f3. Les m\u00e9s habituals s\u00f3n: Condicionals: if , if else , switch Bucles: while , do while , for seguint les estructures: if ( condici\u00f3 ) { // instruccions } else { // instruccions } switch ( $variable ) { case valor : //instruccio1 break ; case valor : //instruccio1 break ; default : //instruccio1 } while ( condici\u00f3 ) { //instruccions } do { //instruccions } while ( condici\u00f3 ); for ( $i = 1 ; $i < 10 ; $i ++ ){ //instruccions } http://php.net/manual/es/language.control-structures.php Maneig de cadenes de text Podem utilitzar tant cometes simples com a cometes dobles. Per a concatenar cadenes utilitzarem l'operador punt (.) $fullName = $name.' '.$surname; Expansi\u00f3 de variables Podem introduir una variable dins d'un text sempre que usem les cometes dobles per a delimitar el text. A\u00e7\u00f2 far\u00e0 que el contingut de la variable s'expandisca i es concatene amb el text existent en la cadena. echo \"<p>M\u00f2dul: $module </p>\" A voltes, \u00e9s necessari envoltar-la entre claus echo \"<p>M\u00f2dul: { $module } DAW</p>\" Si no pos\u00e0rem les claus l'int\u00e8rpret cercaria una variable que es cride $moduleDAW M\u00e9s informaci\u00f3 en funcions de cadena Maneig de dates Funci\u00f3 time() En PHP les dates s'emmagatzemen com a n\u00fameros enters. La funci\u00f3 time() retorna el nombre de segons transcorreguts des de l'1 de gener de 1970 (instant conegut com a \u00e8poca Unix). A aquesta forma d'expressar data i hora se li denomina timestamp . Funci\u00f3 date() date ( string $format [, int $timestamp = time ()]) : string La funci\u00f3 date retorna una cadena formatada segons els codi de format. Si no li passem la variable timestamp ens retorna la cadena formatada per a la data i l'hora actual. Els codis de format m\u00e9s habituals per a la funci\u00f3 date s\u00f3n: CODI DESCRIPCI\u00d3 a am o pm A AM o PM d Dia del mes amb zeros D Abreviatura del dia de la setmana (en angl\u00e8s) F Nom del mes (en angl\u00e8s) h Hora en format 1-12 H Hora en format 0-23 i Minuts j Dia del mes sense zeros l Dia de la setmana m N\u00famero de mes (1-12) M Abreviatura del mes (en angl\u00e8s) s Segons y Any amb 2 d\u00edgits Y Any amb 4 d\u00edgits z Dia de l'any (1-365) La informaci\u00f3 completa la pots trobar en el manual oficial de PHP: date Suposant que hui \u00e9s 15 de setembre de 2019 i les 19 hores 20 minuts i 23 segons et mostrem alguns exemples: date ( \"d-m-Y\" ); // 15-09-2019 date ( \"H:i:s\" ); // 19:20:23 date ( \"Y\" ); // 2019 date ( \"YmdHis\" ); // 20190915192023 date ( \"d/m/y H:i a\" ); // 15/09/19 19:20 pm date ( \"d-m-Y H:i\" , time ()); // Moment actual Funci\u00f3 mktime(hora, min, seg, mes, dia, any) La funci\u00f3 mktime permet obtenir la marca de temps Unix ( timestamp ) d'una data. Per exemple: $data = mktime ( 0 , 0 , 0 , 1 , 1 , 2020 ); echo date ( 'd-m-Y' , $data ); // mostrar\u00e0 01-01-2020 M\u00e9s informaci\u00f3 en https://www.php.net/manual/es/function.mktime.php Una altra forma de crear dates \u00e9s mitjan\u00e7ant la funci\u00f3 strtotime() on podem indicar les dates mitjan\u00e7ant una cadena de text. Per exemple: // posarem la data en el format any-mes-dia per a evitar confusions. $date = strtotime ( \"2020-01-01\" ); Operar amb dates Com hem dit al principi les dates s'emmagatzemen com a enters on cada unitat representa un segon. Aix\u00ed podem sumar i restar dates ( timestamp ) per a afegir, llevar o calcular difer\u00e8ncies entre ells. Per exemple, per poder determinar els dies que falten per a l'1 de gener de 2020 far\u00edem: $data = mktime ( 0 , 0 , 0 , 1 , 1 , 2020 ); // timestamp que representa l'1 de gener de 2020 $diferencia = $data - time (); // restem a l'1 de gener de 2020 el temps actual, // el resultat estar\u00e0 en segons. $diferenciaEnDies = ((( $diferencia / 60 ) / 60 ) / 24 ); /* dividim els segons entre 60 i obtenim els minuts, els dividim entre 60 i obtenim les hores, els dividim entre 24 i obtenim els dies */ Validar dates En la funci\u00f3 checkdate podem validar una data. checkdate ( int $month , int $day , int $year ) : bool La funci\u00f3 torna true si la data es v\u00e0lida, si no, torna false . Classe DateTime PHP disposa tamb\u00e9 de la classe DateTime per a representar les dates, la veurem m\u00e9s avant. Maneig d'arrays Un array \u00e9s un tipus de dades que ens permet emmagatzemar diversos valors. Per tal d'accedir a un valor utilitzarem una clau . Les claus poden ser nombres o textos ( arrays associatius ). Si no indiquem cap clau, a cada element se li associar\u00e0 una clau num\u00e8rica correlativa. Array indexat Crear array Podem crear un array buit de dues formes: $noms = array (); $noms = []; Si volem assignar valors al array en el moment de crear-ho: $noms = array ( 'Sandra' , 'Pedro' , 'Andrea' ); $noms = [ 'Sandra' , 'Pedro' , 'Andrea' ]; Mostrar el contingut d'un array Si intentem mostrar el contingut d'un array amb echo no obtindrem les dades que hi ha dins del array. En lloc d'a\u00e7\u00f2 podem utilitzar la funci\u00f3 print_r: print_r ( $noms ); Per\u00f2 si necessitem donar-li format als continguts del array, haurem de rec\u00f3rrer-ho amb un bucle i anar mostrant element a element. Afegint elements al array Podem afegir elements al array utilitzant claud\u00e0tors buits. La clau d'aquests elements ser\u00e0 el seg\u00fcent \u00edndex num\u00e8ric disponible. $noms [] = 'Raul' ; $noms [] = 'Marta' ; Accedir als elements del array Accedirem als elements del array indicant la clau de l'element entre claud\u00e0tors: echo $noms [ 2 ]; Tamb\u00e9 podem modificar el seu valor: $noms [ 0 ] = 'Sara' ; Rec\u00f3rrer arrays Arrays associatius Si el array cont\u00e9 dades diverses i/o ens interessa accedir a ells amb claus m\u00e9s espec\u00edfiques que un simple \u00edndex num\u00e8ric podem utilitzar arrays associatius: $alumne = array ( 'nom' => 'Sara' , 'cognom' => 'Garc\u00eda' , 'edat' => 22 ); $alumne = [ 'nom' => 'Sara' , 'cognom' => 'Garc\u00eda' , 'edat' => 22 ]; $alumne [ 'nom' ] = 'Ver\u00f3nica' ; echo $alumne [ 'nom' ]; Rec\u00f3rrer arrays associatius Rec\u00f3rrer claus i valors Arrays multidimensionals Imagina que volem tenir un array els elements del qual s\u00f3n noms d'esports. Volem dividir-los en esports d'hivern i esports d'estiu. Podem crear un array esports que continga dos elements que al seu torn tamb\u00e9 seran arrays. $esports = [ 'hivern' => [ 'esqu\u00ed de fons' , 'hoquei sobre gel' ], 'estiu' => [ 'nataci\u00f3' , 'voley platja' ] ]; Per a accedir al primer esport d'hivern: echo $esports [ 'hivern' ][ 0 ]; Funcions d'arrays Podem obtenir la mida de l'array mitjan\u00e7ant la funci\u00f3 count(array) . Per rec\u00f3rrer l'array farem \u00fas d'un bucle for : $tam = count($fruites); // mida de l'array for ($i=0; $i < count ($ fruites ); $ i ++) { echo \" Element $ i: $ fruites [$ i ] < br /> \"; } Les operacions m\u00e9s importants que podem realitzar amb arrays s\u00f3n: print_r($ array) : mostra el contingut de tot el $array $elem = array_pop($array) : elimina l'\u00faltim $element array_push ($ array, $ elem) : afegeix un $element al final. $bool = in_array($elem, $array) : esbrina si $elem est\u00e0 en el $array PHP $fruits = [ \"orange\" , \"pear\" , \"apple\" ]; array_push ( $fruites , \"pinapple\" ); print_r ( $fruits ); $lastFruit = array_pop ( $fruits ); if ( in_array ( \"pineapple\" , $fruits )) { echo \"<p> Pineapple left </ p>\" ; } else { echo \"<p> No pineapple left </ p>\" ; } print_r ( $fruites ); ?> Consola Array ( [0] => orange [1] => pear [2] => apple [3] => pinapple ) <p>No pineapple left</ p> Array ( [0] => orange [1] => pear [2] => apple ) $claus = array_keys($array) : torna les claus de l' $ array associatiu. $tam = count ($array) : retorna la mida de $ array . sort($array) : ordena els elements de l' $ array . isset($array[element]) : indica si existeix / t\u00e9 valor element dins del array. unset($array[element]) : elimina l'element de l'array (deixa un buit). PHP $capitals = array ( \"Italy\" => \"Rome\" , \"France\" => \"Paris\" , \"Portugal\" => \"Lisbon\" ); $countries = array_keys ( $capitals ); print_r ( $countries ); sort ( $countries ); print_r ( $countries ); unset ( $capitals [ \"France\" ]); print_r ( $capitals ); Consola Array ( [0] => Italy [1] => France [2] => Portugal ) Array ( [0] => France [1] => Italy [2] => Portugal ) Array ( [Italy] => Rome [Portugal] => Lisbon ) Existeixen molt\u00edssimes m\u00e9s funcions per treballar amb arrays. Tota la informaci\u00f3 en el documentaci\u00f3 oficial . Articles per aprofundir en les operacions amb arrays Un article molt complet (en angl\u00e8s) de Com treballar amb arrays en PHP de la manera correcta . Un altre article recomanable (en angl\u00e8s) \u00e9s Com ordenar arrays en PHP . Altres recursos: https://www.studytonight.com/php/indexed-array https://aprende-web.net/php/php6_1.php Funcions Funcions predefinides Algunes de les funcions predefinides en PHP s\u00f3n les seg\u00fcents, per\u00f2 hi ha molt\u00edssimes m\u00e9s vinculades als diferents m\u00f2duls que podem instal\u00b7lar. is_null($var) determina si una variable \u00e9s nula o no. isset($var) determina si una variable estan definida i no \u00e9s NULL. unset($var) destrueix les variables especificades. empty($var) torna true si no existeix o \u00e9s FALSE is_int($var) , is_float() , is_bool() , is_array() var_dump($var) , mostra informaci\u00f3 de la variable. Funcions definides per l'usuari Per a crear les teues pr\u00f2pies funcions, haur\u00e0s d'usar la paraula function : function suma ( $a , $b ) { return $a + $b ; } Per tal d'invocar la funci\u00f3: $resultat = suma ( 5 , 7 ); Si una funci\u00f3 no t\u00e9 una sent\u00e8ncia return , retorna null en finalitzar. Command-query separation S\u00ed b\u00e9 \u00e9s un principi de la programaci\u00f3 orientada a objectes \u00e9s \u00fatil usar-lo tamb\u00e9 quan definim funcions. El principi afirma que cada m\u00e8tode ha de ser un comandament que realitza una acci\u00f3 o una consulta que retorna dades al que la crida, pero no ambdues coses. Valors per defecte en els par\u00e0metres Podem indicar valors per defecte per als par\u00e0metres. Si quan cridem a la funci\u00f3 no indiquem el valor d'un par\u00e0metre es prendr\u00e0 el valor per defecte indicat. function preuAmbIva ( $preu , $iva = 0.21 ){ return $preu * ( 1 + $iva ); } $preu = 10 ; $pIva = preuAmbIva ( $preu ); Pot haver-hi m\u00e9s d'un par\u00e0metre amb valor per defecte, per\u00f2 sempre han d'estar al final. Pas de par\u00e0metres per refer\u00e8ncia Per defecte els par\u00e0metres es passen per valor. Per a passar un par\u00e0metre per refer\u00e8ncia afegirem el s\u00edmbol & davant del seu nom. function preuAmbIva ( & $preu , $iva = 0.18 ){ $preu *= ( 1 + $iva ); } Par\u00e0metres per nom Des de PHP 8.0 podem passar els arguments amb el nom (a m\u00e9s de per posici\u00f3, com hem fet fins ara). Els arguments amb nom es passen posant el nom com a prefix del par\u00e0metres separat per dos punts : $resultat=funcio(arg1: valor1, arg2: valor2); Aquesta caracter\u00edstica complementa els par\u00e0metres opcionals permetent-nos saltar-ne el valor: function funcionArgumentsNom ( $a , $b = 2 , $c = 4 ) { echo \" $a $b $c \" ; } funcionArgumentsNom ( c : 3 , a : 1 ); // \"1 2 3\" Tant els par\u00e0metres opcionals com els obligatoris poden tenir nom, per\u00f2 els arguments amb nom s'han de posar despr\u00e9s dels que no en tenen. funcioArgumentsNom ( 1 , c : 3 ); // \"1 2 3\" Declaracions de tipus ( Type Hinting ) Des de PHP 7.0 les funcions poden definir tipus tant per als par\u00e0metres com als valors de retorn. Si el valor donat \u00e9s d'un tipus incorrecte, es generar\u00e0 un error. Per aix\u00f2 s'ha d'anteposar-se el nom del tipus al nom del par\u00e0metre. Es pot fer que una declaraci\u00f3 accepte valors NULL si el valor predeterminat del par\u00e0metre s'estableix a NULL. Per a aconseguir este comportament caldr\u00e0 afegit la seg\u00fcent directiva: <? php declare ( strict_types = 1 ); Si una funci\u00f3 no torna res s'indica mitjan\u00e7ant el tipus void . Tipus v\u00e0lids Type Description Version Class/interface name The value must be an instanceof the given class or interface. self The value must be an instanceof the same class as the one in which the type declaration is used. Can only be used in classes. parent The value must be an instanceof the parent of the class in which the type declaration is used. Can only be used in classes. array The value must be an array. callable The value must be a valid callable. Cannot be used as a class property type declaration. bool The value must be a boolean value. float The value must be a floating point number. int The value must be an integer. string The value must be a string. iterable The value must be either an array or an instanceof Traversable. PHP 7.1.0 object The value must be an object. PHP 7.2.0 mixed The value can be any value. PHP 8.0.0 Exemple declare ( strict_types = 1 ); function suma ( int a , int b ) : int { return $a + $b ; } $num = 25 echo suma ( 3 , 5 ); // 8 echo suma ( 3 , $num ); // 28 echo suma ( \"3\" , 5 ) // error ja que s'aplica el tipat estricte \u00c0mbit ( scope ) de les variables L'\u00e0mbit d'una variable \u00e9s el context dins el qual la variable est\u00e0 definida. La major part de les variables PHP nom\u00e9s tenen un \u00e0mbit simple. Les variables globals s\u00f3n accessibles des de qualsevol part del programa. Qualsevol variable usada dins d\u2019una funci\u00f3 est\u00e1, per defecte, limitada a l'\u00e0mbit local de la funci\u00f3. test() no imprimir\u00e0 res ja que els \u00e0mbits de les variables \u00e9s distint. $a = 1 /* \u00e0mbit global */ function test () { echo $a ; } test (); La paraula reservada global permet accedir a les varibles globals dintre d\u2019una funci\u00f3. $a = 1 /* \u00e0mbit global */ function test () { global $a echo $a ; } test (); // 1 Evita l'\u00fas de variables globals Les variables globals es poden alterar per qualsevol part del codi, la qual cosa fa que siga dif\u00edcil de recordar o raonar sobre cada \u00fas possible. Una variable global no pot tenir control d'acc\u00e9s. No es pot limitar a algunes parts del programa. L'\u00fas de variables globals provoca un acoblament molt estret del codi. Funcions com a par\u00e0metres En PHP \u00e9s possible passar funcions com a par\u00e0metres a altres funcions. Nom\u00e9s cal passar el nom de la funci\u00f3 entre cometes. Exemple: function calculator ( $operation , $numA , $numB ){ return $operation ( $numA , $numB ); } function sumar ( $a , $b ) { return $a + $b ; } function restar ( $a , $b ) { return $a - $b ; } $a = 4 ; $b = 6 ; echo calculator ( 'sumar' , $a , $b ); // 10 echo calculator ( 'restar' , $a , $b ); // -1 Funcions an\u00f2nimes ( closures ) Los funcions an\u00f2nimes estan implementades usant la classe Closure . Permeten la creaci\u00f3 de funcions que no tenen un nom espec\u00edfic . Podem assignar una funci\u00f3 an\u00f2nima a una variable o passar-la com a par\u00e0metre a una altra funci\u00f3. Exemple: Sense par\u00e0metres: $anonima = function () { echo \"Hola\" ; }; $anonima (); // Hola Amb par\u00e0metres: $anonima = function ( $nom ) { echo \"Hola { $nom } \" ; }; $anonima ( 'Vicent' ); // Hola Vicent Usar variables de l'\u00e0mbit superior Una funci\u00f3 an\u00f2nima pot usar variables de l'\u00e0mbit superior mitjan\u00e7ant la paraula reservada use : function saluda ( callable $fnSaluda ) { $fnSaluda ( 'Vicent' ); } $salutacio = 'Hola' ; $anonima = function ( $nom ) use ( $salutacio ) { echo \" { $salutacio } { $nom } \" ; }; saluda ( $anonima ); Llibreries Podem fer llibreries de funcions guardant-les en un fitxer que despr\u00e8s importem des d'on les utilitzem. Ho podem fer amb include, o utilitzant composer per a fer-ho. Sent\u00e8ncies per a incloure Fitxers Les sent\u00e8ncies include() i include_once() i require() i require_once() inclouen i avaluen el fitxeru especificat. include_once() i require_once() a m\u00e9s verifique que el fitxer no haja sigut incl\u00f2s abans i \u00e9s preferible a include . Cal ser cur\u00f2s amb el path del fitxer a incloure. La difer\u00e8ncia entre require i include \u00e9s el tractament de l'error quan el fitxer no existeix. Mentre include mostra un av\u00eds, require mostra una error fatal que para l'execuci\u00f3 de l'script. Vistes Un \u00fas habitual de les funcions d'inclusi\u00f3 \u00e9s crear vistes. Una vista \u00e9s la part de l'aplicaci\u00f3 que mostra la informaci\u00f3 a l'usuari. Amb les inclusions podem separar la part de l\u00f2gica de la d'interf\u00edcie d'usuari. \u00c0mbit de les variables Com s'observa en l'exemple seg\u00fcent, les variables creades abans de cridar l'include, estaran disponibles en el fitxer incl\u00f2s. \u00c9s a dir, com si tot fora un \u00fanic document. fruits.php <? php $color = 'green' ; $fruit = 'apple' ; include 'fruit.view.php' fruits.view.php < html > < head > < title > Fruites </ title > </ head > < body > < h3 > <? = \"A $color $fruit \" ?> </ h3 > </ body > </ html > Rutes En l'exemple anterior include \"fruit.view.php\" la ruta s'especifica de forma relativa, \u00e9s a dir, la ruta es calcular\u00e0 a partir de la ruta en que s'execute el fitxer principal. A mesura que les aplicacions van creixent aquest tipus de rutes acaben sent un mal de cap. Per aix\u00f2 \u00e9s recomanable escriure les inclusions de forma relativa per\u00f2 fixant pr\u00e8viament el directori actual. require __DIR__ . '/fruits.view.php' ; Noves caracter\u00edsques PHP Spaceship operator (<==>) Compara dues expressions $a i $b i torna -1 si $a \u00e9s menor que $b, 0 si s\u00f3n iguals i 1 si $b \u00e9s major que $a. Exemple: // Integers echo 1 <=> 1 ; // 0 echo 1 <=> 2 ; // -1 echo 2 <=> 1 ; // 1 Operador de fusi\u00f3 de null ?? Torna el primer operand si existeix i no \u00e9s NULL o el segon operand. Exemple: // Fetches the value of $_GET['user'] and returns 'nobody' // if it does not exist. $username = $_GET [ 'user' ] ?? 'nobody' ; // This is equivalent to: $username = isset ( $_GET [ 'user' ]) ? $_GET [ 'user' ] : 'nobody' ; M\u00e9s recursos: Noves caracter\u00edstiques PHP 7.0 Noves caracter\u00edstiques PHP 7.1 Noves caracter\u00edstiques PHP 7.2 Noves caracter\u00edstiques PHP 7.3 Noves caracter\u00edstiques PHP 7.4 Noves caracter\u00edstiques PHP 8.0 Noves caracter\u00edstiques PHP 8.1 Cr\u00e8dits Aitor Medrano. (setembre de 2021) Desarrollo Web en Entorno Servidor disponible en: https://aitor-medrano.github.io/dwes2122/index.html","title":"PHP B\u00e0sic"},{"location":"02-basics/02-phpbasics/#el-llenguatge-php","text":"Objectius Con\u00e8ixer la sintaxi b\u00e0sica de PHP i les noves caracter\u00edstiques de PHP 8. Entendre com s'integren PHP i HTML. Descriure els tipus de dades existents en PHP. Fer servir les estructures de control b\u00e0siques. Aprendre a utilitzar els arrays associatius. Con\u00e8ixer els mecanismes de pas de par\u00e0metres a un script. Processar i validar formularis Incloure fitxers","title":"El llenguatge PHP"},{"location":"02-basics/02-phpbasics/#introduccio","text":"Acr\u00f2nim de Personal Home Page Llenguatge de prop\u00f2sit general, encara que el seu fort \u00e9s el desenvolupament web. Sintaxi similar a C/Java El codi s'executa en el servidor (en Apache mitjan\u00e7ant mod_php ) El client rep el resultat generat despr\u00e9s d'interpretar el codi al servidor. El codi s'emmagatzema en arxiu amb extensi\u00f3 .php. L'\u00faltima versi\u00f3 \u00e9s la 8.1, de novembre de 2021 (i en breu tindrem la versi\u00f3 8.2). La versi\u00f3 7.0 va sortir al desembre de 2015. A m\u00e9s de nombroses noves funcionalitats que anirem veient durant el curs, t\u00e9 m\u00e9s de dues vegades millor rendiment que PHP5. PHP 8.1 Nosaltres farem \u00fas de la versi\u00f3 8.1 de PHP La seva documentaci\u00f3 \u00e9s extensa i est\u00e0 tradu\u00efda: https://www.php.net/manual/es/.","title":"Introducci\u00f3"},{"location":"02-basics/02-phpbasics/#funcionament-i-estructura-basica","text":"","title":"Funcionament i estructura b\u00e0sica"},{"location":"02-basics/02-phpbasics/#el-nostre-primer-codi-php","text":"El codi PHP sempre va entre els simbolos <?php i ?> . Les instruccions PHP acaben sempre amb ; . <!DOCTYPE html> < html lang = \"ca\" > < head > < meta charset = \"UTF-8\" > < title > PHP f\u00e0cil </ title > </ head > < body > <!-- Mostra una frase en HTML --> Hola m\u00f3n! < br > <!-- Mostra una frase en PHP --> <?php echo \"\u00c9s molt f\u00e0cil programar en PHP.\" ; ?> </ body > </ html > Per a generar codi HTML des de PHP podem utilitzar diversos m\u00e8todes: echo expressi\u00f3 print (expressi\u00f3) <?= expressi\u00f3 ?> El codi pot anar entre les etiquetes d'HTML. < html > < head ></ head > < body > < h1 > <?php echo \"Hola m\u00f3n\" ?> </ h1 > < body > < html > < head ></ head > < body > < h1 > <? = \"Hola m\u00f3n\" ?> </ h1 > < body >","title":"El nostre primer codi PHP"},{"location":"02-basics/02-phpbasics/#comentaris","text":"De bloc entre /* i */ . De linea, comen\u00e7ant per // o per # .","title":"Comentaris"},{"location":"02-basics/02-phpbasics/#variables-i-tipus-de-dades","text":"Una de les caracter\u00edstiques de PHP \u00e9s que \u00e9s un llenguatge no fortament tipat (com Javascript). De fet, no cal declarar la variable ni indicar el tipus de dades si la declare. Encara que si volem codi de qualitat ho hauriem de fer.","title":"Variables i tipus de dades"},{"location":"02-basics/02-phpbasics/#constants","text":"Per a definir constants s'utilitza define() , que reb el nom de la constant i el valor que li volem donar. Tamb\u00e9 podem user la paraula reservada const . const PI = 3.1415927 define ( \"PI\" , 3.1415927 ) Constants sempre en maj\u00fascules \u00c9s una convenci\u00f3 utilitzar identificadors en maj\u00fascules per a les constants.","title":"Constants"},{"location":"02-basics/02-phpbasics/#operadors","text":"","title":"Operadors"},{"location":"02-basics/02-phpbasics/#treballant-en-formularis","text":"Les dades s'envien via URL en el format var1=valor1&var2=valor2\u2026. Per exemple: exemple.php?nom=Homer+cognom=Simpson Es divideix en dos passos: Genera un formulari amb l'atribut action='file.php' method='GET' . En el fitxer .php cal llegir les dades amb $_GET['varName'] . Anem a separar sempre que puguem el codi HTML del de PHP. Per exemple, el formulari el coloquem en saluda.html : < form action = \"saluda.php\" method = \"get\" > < p >< label for = \"nombre\" > Nombre: </ label > < input type = \"text\" name = \"nombre\" id = \"nombre\" ></ p > < p >< label for = \"apellido1\" > Primer apellido: </ label > < input type = \"text\" name = \"apellido1\" id = \"apellido1\" ></ p > < p >< input type = \"submit\" value = \"enviar\" ></ p > </ form > I recollim les dades en saluda.php : <? php $nombre = $_GET [ \"nombre\" ]; $apellido1 = $_GET [ \"apellido1\" ]; echo \"Hola $nombre $apellido1 \" ; ?> Si volgu\u00e9ssim fer-ho tot en un \u00fanic fitxer (la qual cosa no es recomanable), podem fer-ho aix\u00ed: < form action = \"\" method = \"get\" > < p >< label for = \"nombre\" > Nombre: </ label > < input type = \"text\" name = \"nombre\" id = \"nombre\" ></ p > < p >< label for = \"apellido1\" > Primer apellido: </ label > < input type = \"text\" name = \"apellido1\" id = \"apellido1\" ></ p > < input type = \"submit\" value = \"enviar\" > </ form > < p > <?php if ( isset ( $_GET [ 'nombre' ])) { $nombre = $_GET [ \"nombre\" ]; $apellido1 = $_GET [ \"apellido1\" ]; echo \"Hola $nombre $apellido1 \" ; } ?> </ p > M\u00e9s endavant aprofundirem en la gesti\u00f3 de formularis.","title":"Treballant en formularis"},{"location":"02-basics/02-phpbasics/#estructures-de-control-de-flux","text":"Les instruccions de control de flux en PHP funcionen exactament igual que en altres llenguatges de programaci\u00f3. Les m\u00e9s habituals s\u00f3n: Condicionals: if , if else , switch Bucles: while , do while , for seguint les estructures: if ( condici\u00f3 ) { // instruccions } else { // instruccions } switch ( $variable ) { case valor : //instruccio1 break ; case valor : //instruccio1 break ; default : //instruccio1 } while ( condici\u00f3 ) { //instruccions } do { //instruccions } while ( condici\u00f3 ); for ( $i = 1 ; $i < 10 ; $i ++ ){ //instruccions } http://php.net/manual/es/language.control-structures.php","title":"Estructures de control de flux"},{"location":"02-basics/02-phpbasics/#maneig-de-cadenes-de-text","text":"Podem utilitzar tant cometes simples com a cometes dobles. Per a concatenar cadenes utilitzarem l'operador punt (.) $fullName = $name.' '.$surname;","title":"Maneig de cadenes de text"},{"location":"02-basics/02-phpbasics/#expansio-de-variables","text":"Podem introduir una variable dins d'un text sempre que usem les cometes dobles per a delimitar el text. A\u00e7\u00f2 far\u00e0 que el contingut de la variable s'expandisca i es concatene amb el text existent en la cadena. echo \"<p>M\u00f2dul: $module </p>\" A voltes, \u00e9s necessari envoltar-la entre claus echo \"<p>M\u00f2dul: { $module } DAW</p>\" Si no pos\u00e0rem les claus l'int\u00e8rpret cercaria una variable que es cride $moduleDAW M\u00e9s informaci\u00f3 en funcions de cadena","title":"Expansi\u00f3 de variables"},{"location":"02-basics/02-phpbasics/#maneig-de-dates","text":"","title":"Maneig de dates"},{"location":"02-basics/02-phpbasics/#funcio-time","text":"En PHP les dates s'emmagatzemen com a n\u00fameros enters. La funci\u00f3 time() retorna el nombre de segons transcorreguts des de l'1 de gener de 1970 (instant conegut com a \u00e8poca Unix). A aquesta forma d'expressar data i hora se li denomina timestamp .","title":"Funci\u00f3 time()"},{"location":"02-basics/02-phpbasics/#funcio-date","text":"date ( string $format [, int $timestamp = time ()]) : string La funci\u00f3 date retorna una cadena formatada segons els codi de format. Si no li passem la variable timestamp ens retorna la cadena formatada per a la data i l'hora actual. Els codis de format m\u00e9s habituals per a la funci\u00f3 date s\u00f3n: CODI DESCRIPCI\u00d3 a am o pm A AM o PM d Dia del mes amb zeros D Abreviatura del dia de la setmana (en angl\u00e8s) F Nom del mes (en angl\u00e8s) h Hora en format 1-12 H Hora en format 0-23 i Minuts j Dia del mes sense zeros l Dia de la setmana m N\u00famero de mes (1-12) M Abreviatura del mes (en angl\u00e8s) s Segons y Any amb 2 d\u00edgits Y Any amb 4 d\u00edgits z Dia de l'any (1-365) La informaci\u00f3 completa la pots trobar en el manual oficial de PHP: date Suposant que hui \u00e9s 15 de setembre de 2019 i les 19 hores 20 minuts i 23 segons et mostrem alguns exemples: date ( \"d-m-Y\" ); // 15-09-2019 date ( \"H:i:s\" ); // 19:20:23 date ( \"Y\" ); // 2019 date ( \"YmdHis\" ); // 20190915192023 date ( \"d/m/y H:i a\" ); // 15/09/19 19:20 pm date ( \"d-m-Y H:i\" , time ()); // Moment actual","title":"Funci\u00f3 date()"},{"location":"02-basics/02-phpbasics/#funcio-mktimehora-min-seg-mes-dia-any","text":"La funci\u00f3 mktime permet obtenir la marca de temps Unix ( timestamp ) d'una data. Per exemple: $data = mktime ( 0 , 0 , 0 , 1 , 1 , 2020 ); echo date ( 'd-m-Y' , $data ); // mostrar\u00e0 01-01-2020 M\u00e9s informaci\u00f3 en https://www.php.net/manual/es/function.mktime.php Una altra forma de crear dates \u00e9s mitjan\u00e7ant la funci\u00f3 strtotime() on podem indicar les dates mitjan\u00e7ant una cadena de text. Per exemple: // posarem la data en el format any-mes-dia per a evitar confusions. $date = strtotime ( \"2020-01-01\" );","title":"Funci\u00f3 mktime(hora, min, seg, mes, dia, any)"},{"location":"02-basics/02-phpbasics/#operar-amb-dates","text":"Com hem dit al principi les dates s'emmagatzemen com a enters on cada unitat representa un segon. Aix\u00ed podem sumar i restar dates ( timestamp ) per a afegir, llevar o calcular difer\u00e8ncies entre ells. Per exemple, per poder determinar els dies que falten per a l'1 de gener de 2020 far\u00edem: $data = mktime ( 0 , 0 , 0 , 1 , 1 , 2020 ); // timestamp que representa l'1 de gener de 2020 $diferencia = $data - time (); // restem a l'1 de gener de 2020 el temps actual, // el resultat estar\u00e0 en segons. $diferenciaEnDies = ((( $diferencia / 60 ) / 60 ) / 24 ); /* dividim els segons entre 60 i obtenim els minuts, els dividim entre 60 i obtenim les hores, els dividim entre 24 i obtenim els dies */","title":"Operar amb dates"},{"location":"02-basics/02-phpbasics/#validar-dates","text":"En la funci\u00f3 checkdate podem validar una data. checkdate ( int $month , int $day , int $year ) : bool La funci\u00f3 torna true si la data es v\u00e0lida, si no, torna false .","title":"Validar dates"},{"location":"02-basics/02-phpbasics/#classe-datetime","text":"PHP disposa tamb\u00e9 de la classe DateTime per a representar les dates, la veurem m\u00e9s avant.","title":"Classe DateTime"},{"location":"02-basics/02-phpbasics/#maneig-darrays","text":"Un array \u00e9s un tipus de dades que ens permet emmagatzemar diversos valors. Per tal d'accedir a un valor utilitzarem una clau . Les claus poden ser nombres o textos ( arrays associatius ). Si no indiquem cap clau, a cada element se li associar\u00e0 una clau num\u00e8rica correlativa.","title":"Maneig d'arrays"},{"location":"02-basics/02-phpbasics/#array-indexat","text":"","title":"Array indexat"},{"location":"02-basics/02-phpbasics/#arrays-associatius","text":"Si el array cont\u00e9 dades diverses i/o ens interessa accedir a ells amb claus m\u00e9s espec\u00edfiques que un simple \u00edndex num\u00e8ric podem utilitzar arrays associatius: $alumne = array ( 'nom' => 'Sara' , 'cognom' => 'Garc\u00eda' , 'edat' => 22 ); $alumne = [ 'nom' => 'Sara' , 'cognom' => 'Garc\u00eda' , 'edat' => 22 ]; $alumne [ 'nom' ] = 'Ver\u00f3nica' ; echo $alumne [ 'nom' ];","title":"Arrays associatius"},{"location":"02-basics/02-phpbasics/#arrays-multidimensionals","text":"Imagina que volem tenir un array els elements del qual s\u00f3n noms d'esports. Volem dividir-los en esports d'hivern i esports d'estiu. Podem crear un array esports que continga dos elements que al seu torn tamb\u00e9 seran arrays. $esports = [ 'hivern' => [ 'esqu\u00ed de fons' , 'hoquei sobre gel' ], 'estiu' => [ 'nataci\u00f3' , 'voley platja' ] ]; Per a accedir al primer esport d'hivern: echo $esports [ 'hivern' ][ 0 ];","title":"Arrays multidimensionals"},{"location":"02-basics/02-phpbasics/#funcions-darrays","text":"Podem obtenir la mida de l'array mitjan\u00e7ant la funci\u00f3 count(array) . Per rec\u00f3rrer l'array farem \u00fas d'un bucle for : $tam = count($fruites); // mida de l'array for ($i=0; $i < count ($ fruites ); $ i ++) { echo \" Element $ i: $ fruites [$ i ] < br /> \"; } Les operacions m\u00e9s importants que podem realitzar amb arrays s\u00f3n: print_r($ array) : mostra el contingut de tot el $array $elem = array_pop($array) : elimina l'\u00faltim $element array_push ($ array, $ elem) : afegeix un $element al final. $bool = in_array($elem, $array) : esbrina si $elem est\u00e0 en el $array PHP $fruits = [ \"orange\" , \"pear\" , \"apple\" ]; array_push ( $fruites , \"pinapple\" ); print_r ( $fruits ); $lastFruit = array_pop ( $fruits ); if ( in_array ( \"pineapple\" , $fruits )) { echo \"<p> Pineapple left </ p>\" ; } else { echo \"<p> No pineapple left </ p>\" ; } print_r ( $fruites ); ?> Consola Array ( [0] => orange [1] => pear [2] => apple [3] => pinapple ) <p>No pineapple left</ p> Array ( [0] => orange [1] => pear [2] => apple ) $claus = array_keys($array) : torna les claus de l' $ array associatiu. $tam = count ($array) : retorna la mida de $ array . sort($array) : ordena els elements de l' $ array . isset($array[element]) : indica si existeix / t\u00e9 valor element dins del array. unset($array[element]) : elimina l'element de l'array (deixa un buit). PHP $capitals = array ( \"Italy\" => \"Rome\" , \"France\" => \"Paris\" , \"Portugal\" => \"Lisbon\" ); $countries = array_keys ( $capitals ); print_r ( $countries ); sort ( $countries ); print_r ( $countries ); unset ( $capitals [ \"France\" ]); print_r ( $capitals ); Consola Array ( [0] => Italy [1] => France [2] => Portugal ) Array ( [0] => France [1] => Italy [2] => Portugal ) Array ( [Italy] => Rome [Portugal] => Lisbon ) Existeixen molt\u00edssimes m\u00e9s funcions per treballar amb arrays. Tota la informaci\u00f3 en el documentaci\u00f3 oficial . Articles per aprofundir en les operacions amb arrays Un article molt complet (en angl\u00e8s) de Com treballar amb arrays en PHP de la manera correcta . Un altre article recomanable (en angl\u00e8s) \u00e9s Com ordenar arrays en PHP . Altres recursos: https://www.studytonight.com/php/indexed-array https://aprende-web.net/php/php6_1.php","title":"Funcions d'arrays"},{"location":"02-basics/02-phpbasics/#funcions","text":"","title":"Funcions"},{"location":"02-basics/02-phpbasics/#funcions-predefinides","text":"Algunes de les funcions predefinides en PHP s\u00f3n les seg\u00fcents, per\u00f2 hi ha molt\u00edssimes m\u00e9s vinculades als diferents m\u00f2duls que podem instal\u00b7lar. is_null($var) determina si una variable \u00e9s nula o no. isset($var) determina si una variable estan definida i no \u00e9s NULL. unset($var) destrueix les variables especificades. empty($var) torna true si no existeix o \u00e9s FALSE is_int($var) , is_float() , is_bool() , is_array() var_dump($var) , mostra informaci\u00f3 de la variable.","title":"Funcions predefinides"},{"location":"02-basics/02-phpbasics/#funcions-definides-per-lusuari","text":"Per a crear les teues pr\u00f2pies funcions, haur\u00e0s d'usar la paraula function : function suma ( $a , $b ) { return $a + $b ; } Per tal d'invocar la funci\u00f3: $resultat = suma ( 5 , 7 ); Si una funci\u00f3 no t\u00e9 una sent\u00e8ncia return , retorna null en finalitzar. Command-query separation S\u00ed b\u00e9 \u00e9s un principi de la programaci\u00f3 orientada a objectes \u00e9s \u00fatil usar-lo tamb\u00e9 quan definim funcions. El principi afirma que cada m\u00e8tode ha de ser un comandament que realitza una acci\u00f3 o una consulta que retorna dades al que la crida, pero no ambdues coses.","title":"Funcions definides per l'usuari"},{"location":"02-basics/02-phpbasics/#valors-per-defecte-en-els-parametres","text":"Podem indicar valors per defecte per als par\u00e0metres. Si quan cridem a la funci\u00f3 no indiquem el valor d'un par\u00e0metre es prendr\u00e0 el valor per defecte indicat. function preuAmbIva ( $preu , $iva = 0.21 ){ return $preu * ( 1 + $iva ); } $preu = 10 ; $pIva = preuAmbIva ( $preu ); Pot haver-hi m\u00e9s d'un par\u00e0metre amb valor per defecte, per\u00f2 sempre han d'estar al final.","title":"Valors per defecte en els par\u00e0metres"},{"location":"02-basics/02-phpbasics/#pas-de-parametres-per-referencia","text":"Per defecte els par\u00e0metres es passen per valor. Per a passar un par\u00e0metre per refer\u00e8ncia afegirem el s\u00edmbol & davant del seu nom. function preuAmbIva ( & $preu , $iva = 0.18 ){ $preu *= ( 1 + $iva ); }","title":"Pas de par\u00e0metres per refer\u00e8ncia"},{"location":"02-basics/02-phpbasics/#parametres-per-nom","text":"Des de PHP 8.0 podem passar els arguments amb el nom (a m\u00e9s de per posici\u00f3, com hem fet fins ara). Els arguments amb nom es passen posant el nom com a prefix del par\u00e0metres separat per dos punts : $resultat=funcio(arg1: valor1, arg2: valor2); Aquesta caracter\u00edstica complementa els par\u00e0metres opcionals permetent-nos saltar-ne el valor: function funcionArgumentsNom ( $a , $b = 2 , $c = 4 ) { echo \" $a $b $c \" ; } funcionArgumentsNom ( c : 3 , a : 1 ); // \"1 2 3\" Tant els par\u00e0metres opcionals com els obligatoris poden tenir nom, per\u00f2 els arguments amb nom s'han de posar despr\u00e9s dels que no en tenen. funcioArgumentsNom ( 1 , c : 3 ); // \"1 2 3\"","title":"Par\u00e0metres per nom"},{"location":"02-basics/02-phpbasics/#declaracions-de-tipus-type-hinting","text":"Des de PHP 7.0 les funcions poden definir tipus tant per als par\u00e0metres com als valors de retorn. Si el valor donat \u00e9s d'un tipus incorrecte, es generar\u00e0 un error. Per aix\u00f2 s'ha d'anteposar-se el nom del tipus al nom del par\u00e0metre. Es pot fer que una declaraci\u00f3 accepte valors NULL si el valor predeterminat del par\u00e0metre s'estableix a NULL. Per a aconseguir este comportament caldr\u00e0 afegit la seg\u00fcent directiva: <? php declare ( strict_types = 1 ); Si una funci\u00f3 no torna res s'indica mitjan\u00e7ant el tipus void .","title":"Declaracions de tipus (Type Hinting)"},{"location":"02-basics/02-phpbasics/#ambit-scope-de-les-variables","text":"L'\u00e0mbit d'una variable \u00e9s el context dins el qual la variable est\u00e0 definida. La major part de les variables PHP nom\u00e9s tenen un \u00e0mbit simple. Les variables globals s\u00f3n accessibles des de qualsevol part del programa. Qualsevol variable usada dins d\u2019una funci\u00f3 est\u00e1, per defecte, limitada a l'\u00e0mbit local de la funci\u00f3. test() no imprimir\u00e0 res ja que els \u00e0mbits de les variables \u00e9s distint. $a = 1 /* \u00e0mbit global */ function test () { echo $a ; } test (); La paraula reservada global permet accedir a les varibles globals dintre d\u2019una funci\u00f3. $a = 1 /* \u00e0mbit global */ function test () { global $a echo $a ; } test (); // 1 Evita l'\u00fas de variables globals Les variables globals es poden alterar per qualsevol part del codi, la qual cosa fa que siga dif\u00edcil de recordar o raonar sobre cada \u00fas possible. Una variable global no pot tenir control d'acc\u00e9s. No es pot limitar a algunes parts del programa. L'\u00fas de variables globals provoca un acoblament molt estret del codi.","title":"\u00c0mbit (scope) de les variables"},{"location":"02-basics/02-phpbasics/#funcions-com-a-parametres","text":"En PHP \u00e9s possible passar funcions com a par\u00e0metres a altres funcions. Nom\u00e9s cal passar el nom de la funci\u00f3 entre cometes. Exemple: function calculator ( $operation , $numA , $numB ){ return $operation ( $numA , $numB ); } function sumar ( $a , $b ) { return $a + $b ; } function restar ( $a , $b ) { return $a - $b ; } $a = 4 ; $b = 6 ; echo calculator ( 'sumar' , $a , $b ); // 10 echo calculator ( 'restar' , $a , $b ); // -1","title":"Funcions com a par\u00e0metres"},{"location":"02-basics/02-phpbasics/#funcions-anonimes-closures","text":"Los funcions an\u00f2nimes estan implementades usant la classe Closure . Permeten la creaci\u00f3 de funcions que no tenen un nom espec\u00edfic . Podem assignar una funci\u00f3 an\u00f2nima a una variable o passar-la com a par\u00e0metre a una altra funci\u00f3. Exemple: Sense par\u00e0metres: $anonima = function () { echo \"Hola\" ; }; $anonima (); // Hola Amb par\u00e0metres: $anonima = function ( $nom ) { echo \"Hola { $nom } \" ; }; $anonima ( 'Vicent' ); // Hola Vicent","title":"Funcions an\u00f2nimes (closures)"},{"location":"02-basics/02-phpbasics/#sentencies-per-a-incloure-fitxers","text":"Les sent\u00e8ncies include() i include_once() i require() i require_once() inclouen i avaluen el fitxeru especificat. include_once() i require_once() a m\u00e9s verifique que el fitxer no haja sigut incl\u00f2s abans i \u00e9s preferible a include . Cal ser cur\u00f2s amb el path del fitxer a incloure. La difer\u00e8ncia entre require i include \u00e9s el tractament de l'error quan el fitxer no existeix. Mentre include mostra un av\u00eds, require mostra una error fatal que para l'execuci\u00f3 de l'script. Vistes Un \u00fas habitual de les funcions d'inclusi\u00f3 \u00e9s crear vistes. Una vista \u00e9s la part de l'aplicaci\u00f3 que mostra la informaci\u00f3 a l'usuari. Amb les inclusions podem separar la part de l\u00f2gica de la d'interf\u00edcie d'usuari.","title":"Sent\u00e8ncies per a incloure Fitxers"},{"location":"02-basics/02-phpbasics/#ambit-de-les-variables_1","text":"Com s'observa en l'exemple seg\u00fcent, les variables creades abans de cridar l'include, estaran disponibles en el fitxer incl\u00f2s. \u00c9s a dir, com si tot fora un \u00fanic document. fruits.php <? php $color = 'green' ; $fruit = 'apple' ; include 'fruit.view.php' fruits.view.php < html > < head > < title > Fruites </ title > </ head > < body > < h3 > <? = \"A $color $fruit \" ?> </ h3 > </ body > </ html >","title":"\u00c0mbit de les variables"},{"location":"02-basics/02-phpbasics/#rutes","text":"En l'exemple anterior include \"fruit.view.php\" la ruta s'especifica de forma relativa, \u00e9s a dir, la ruta es calcular\u00e0 a partir de la ruta en que s'execute el fitxer principal. A mesura que les aplicacions van creixent aquest tipus de rutes acaben sent un mal de cap. Per aix\u00f2 \u00e9s recomanable escriure les inclusions de forma relativa per\u00f2 fixant pr\u00e8viament el directori actual. require __DIR__ . '/fruits.view.php' ;","title":"Rutes"},{"location":"02-basics/02-phpbasics/#noves-caracterisques-php","text":"","title":"Noves caracter\u00edsques PHP"},{"location":"02-basics/02-phpbasics/#spaceship-operator","text":"Compara dues expressions $a i $b i torna -1 si $a \u00e9s menor que $b, 0 si s\u00f3n iguals i 1 si $b \u00e9s major que $a. Exemple: // Integers echo 1 <=> 1 ; // 0 echo 1 <=> 2 ; // -1 echo 2 <=> 1 ; // 1","title":"Spaceship operator  (&lt;==&gt;)"},{"location":"02-basics/02-phpbasics/#operador-de-fusio-de-null","text":"Torna el primer operand si existeix i no \u00e9s NULL o el segon operand. Exemple: // Fetches the value of $_GET['user'] and returns 'nobody' // if it does not exist. $username = $_GET [ 'user' ] ?? 'nobody' ; // This is equivalent to: $username = isset ( $_GET [ 'user' ]) ? $_GET [ 'user' ] : 'nobody' ; M\u00e9s recursos: Noves caracter\u00edstiques PHP 7.0 Noves caracter\u00edstiques PHP 7.1 Noves caracter\u00edstiques PHP 7.2 Noves caracter\u00edstiques PHP 7.3 Noves caracter\u00edstiques PHP 7.4 Noves caracter\u00edstiques PHP 8.0 Noves caracter\u00edstiques PHP 8.1","title":"Operador de fusi\u00f3 de null ??"},{"location":"02-basics/02-phpbasics/#credits","text":"Aitor Medrano. (setembre de 2021) Desarrollo Web en Entorno Servidor disponible en: https://aitor-medrano.github.io/dwes2122/index.html","title":"Cr\u00e8dits"},{"location":"02-basics/99-activities/","text":"Activitats PHP B\u00e0sic 201tresfrases.php : Mostra 3 frases, cadascuna en un par\u00e0graf utilitzant les tres possibilitats que hi ha de mostrar contingut. Despr\u00e9s, introdueix dos comentaris, un de bloc i un altre d'una l\u00ednia. 202calculs.php : Escriu un programa que utilitze les variables $x i $y . Assigna'ls els valors 166 i 999 respectivament. Tot seguit, mostra per pantalla el valor de cada variable, la suma, la resta, la divisi\u00f3 i la multiplicaci\u00f3. 203dadesPersonals.php : Escriu un programa que emmagatzeme en variables teu nom, primer cognom, segon cognom, email, any de naixement i tel\u00e8fon. Despr\u00e9s mostra'ls per pantalla dins d'una taula. Nom Bruce Cognoms Wayne Email batman@dccomics.com Any de naixement 1939 Tel\u00e8fon 555666777 204dadesPersonales.html i 204dadesPersonales.php : \u00c9s el mateix exercici que l'anterior, per\u00f2 separant la l\u00f2gica. En el primer fitxer crearem el formulari per a introduir les dades i despr\u00e9s recollirem les dades i generarem la taula en el segon arxiu. 205anys.php : Despr\u00e9s de llegir l'edat d'una persona per la URL, mostrar l'edat que tindr\u00e0 d'aqu\u00ed a 10 anys i fa 10 anys. A m\u00e9s, mostra quin any ser\u00e0 en cada un dels casos. Finalment, mostra l'any de jubilaci\u00f3 suposant que treballar\u00e0s fins als 67 anys. No cal que faces un formulari, pots provar-ho directament via URL: 205anys.php?edad=33 . Tip: $currentYear = date(\"Y\") ; 206diners.php : A partir d'una quantitat de diners, mostrar la seva descomposici\u00f3 en bitllets (500, 200, 100, 50, 20, 10, 5) i monedes (2, 1) perqu\u00e8 el nombre d'elements sigui m\u00ednim. No es pot utilitzar cap instrucci\u00f3 condicional. Per exemple, en introduir 139 ha de mostrar: 1 bitllet de 100 0 bitllet de 50 1 bitllet de 20 1 bitllet de 10 1 bitllet de 5 2 moneda de 2 Tip: Pots for\u00e7ar a realitzar la divisi\u00f3 sencera mitjan\u00e7ant la funci\u00f3 intdiv($dividend, $divisor) o passar un nombre flotant a sencer pots fer servir la funci\u00f3 intval() . 207posnegzero.php : A partir d'un n\u00famero, mostra per pantalla si el n\u00famero \u00e9s positiu, negatiu o zero. 208mayor3.php : Sense fer \u00fas de condicions que utilitzen dins de la condici\u00f3 els operadors l\u00f2gics, mostra el m\u00e9s gran de tres n\u00fameros (a, b i c). 209mayor3c.php : Utilitza en les condicions els operadors l\u00f2gics. 210nomEdad.php : A partir d'una edat mostra per pantalla: nad\u00f3 si t\u00e9 menys de 3 anys nen si t\u00e9 entre 3 i 12 anys adolescent entre 13 i 17 anys adult entre 18 i 66 jubilat a partir de 67 Exercicis d'investigaci\u00f3 Investiga perqu\u00e8 serveix l'operador nau espacial, disponible des de PHP7 ( https://www.php.net/manual/es/migration70.new-features.php ). Explica amb un parell de l\u00ednies el seu prop\u00f2sit i mitjan\u00e7ant el codi demostra el seu \u00fas. Investiga per a qu\u00e8 serveix la instrucci\u00f3 match() , disponible des de PHP8 ( https://www.php.net/manual/ca/control-structures.match.php ). Explica amb un parell de l\u00ednies el seu prop\u00f2sit i mitjan\u00e7ant el codi demostra el seu \u00fas. Dates 213Dates.php : Crea un fitxer que realitza les seg\u00fcents tasques: Mostra la data i hora actuals amb el format: dd/mm/yyyy hh:mm:ss Mostra el nom de la zona hor\u00e0ria que s'utilitza per defecte. Mostra la data de que ser\u00e0 d\u2019ac\u00ed 45 dies. Mostra el nombre de dies que han passat des de l'1 de gener. Mostra la data i hora actuals de Nova York. Mostra el dia de la setmana que era l'1 de gener d'enguany. Cadenes 214Cadenes.php : Crea una p\u00e0gina que reba un nom. Amb la directiva de tipus estricta ( declare( strict_types = 1 ); ) aplica les seg\u00fcents funcions: Elimina els espais del principi i el final del nom si els hi haguera ( trim ). Elimina la lletra a del principi i el final del nom si els hi haguera ( trim ). Mostra la variable nom en maj\u00fascules, min\u00fascules i amb la primera lletra en maj\u00fascula i les altres en min\u00fascules ( strtoupper , strtolower , ucfirst ). Mostra el codi ascii de la primera lletra del nom ( ord ). Mostra la longitud del nom ( strlen ). Mostra el nombre de vegades que apareix la lletra a (maj\u00fascula o min\u00fascula, substr_count ). Mostra la posici\u00f3 de la primera a existent en el nom, siga maj\u00fascula o min\u00fascula ( strpos ). Si no hi ha cap mostrar\u00e0 -1. El mateix, per\u00f2 amb l''\u00faltima a . Mostra el nom substituint la lletra o pel n\u00famero 0 , siga maj\u00fascula o min\u00fascula ( str_replace ). Indica si el nom comen\u00e7a per al o no. 215Cadenes.php : Utilitza la funci\u00f3 parse_url per a extraure de la url les seg\u00fcents parts: El protocol utilitzat (en l'exemple \"http\"). El nom d'usuari (en l'exemple \"username\"). El path de la url (en l'exemple \"/path\"). El querystring de la url (en l'exemple \"arg=value\"). $url = \"http://username:password@hostname:9090/path?arg=value#anchor\" ; Bucles 220parells050.php: Escriu un programa que mostre els n\u00fameros parells del 0 al 50 (dintre d'una llista desordenada). 220parellsAB.php : A partir de l'anterior, refacciona perqu\u00e8 funcione amb els par\u00e0metres inici i fi . 221suma110.php : Escriu un programa que sume els n\u00fameros de l'1 al 10. 221sumaAB.php : A partir de l'anterior, refacciona perqu\u00e8 funcione amb inici i fi . 222potencia.php : A partir d'una base i exponent, mitjan\u00e7ant l'acumulaci\u00f3 de productes, calcula la pot\u00e8ncia utilitzant l'instrucci\u00f3 for . 222potenciaWhile.php : Reescriu l'exercici anterior fent \u00fas de while . 222potenciaDoWhile.php : Reescriu l'exercici anterior fent \u00fas sols de do-while . 223taulaMultiplicar.php : Mostra dins d'una taula HTML la taula de multiplicar d'un n\u00famero . Utiliza <thead> amb els seus respectius <th> y <tbody > per a dibujar la tabla. Per exemple: a * b = a*b 7 * 1 = 7 7 * 2 = 14 ... 7 * 10 = 70 224formulari.html : Crea un formulario que permeta llegir una quantitat . 224llegirDades.php : A partir de quantitat , prepara un formulari amb tantes caixes ( textbox ) com el valor de quantitat rebut. Finalment, en 224sumarDades.php : a partir de les dades de totes les caixes de text de la p\u00e0gina anterior, suma i mostra el total. 225formulari.html i 225taula.php : A partir d'un nombre de files i columnes , crear una taula amb aquesta mida. Les cel\u00b7les han d'estar emplenades amb els valors de les coordenades de cada cel\u00b7la. 226formulari.html i 226quadrat.php : Basant-te en l'exercici anterior, omple la taula de manera que nom\u00e9s les vores tinguin contingut, quedant-se la resta de cel\u00b7les en blanc. 227formulari.html i 227equis.php : Basant-te en l'exercici anterior, ara nom\u00e9s ha d'apar\u00e8ixer el contingut dels dos diagonals. 228quadratMultiplicar.php : Crea un programa que mostre per pantalla un quadrat exactament igual (fixa't b\u00e9 a les cap\u00e7aleres, tant de les files com de les columnes) al de la imatge amb les taules de multiplicar. Arrays 230aleatoris50.php : Omple un array amb 50 n\u00fameros aleatoris compresos entre el 0 i el 99, i despr\u00e9s mostra'l en una llista desordenada. Per crear un nombre aleatori, utilitzeu la funci\u00f3 rand(inici, fi) . Per exemple: $num = rand ( 0 , 99 ) 231bola8.html : Prepara un formulari amb una caixa de text que fa\u00e7a una pregunta a l\\'usuari. 231bola8.php : A partir de l'anterior, crea un programa que mostre la pregunta rebuda i genere una resposta de manera aleat\u00f2ria entre un conjunt de respostes predefinides, emmagatzemades en un array : Si, no, potser, \u00e9s clar que s\u00ed, per suposat que no, no ho tinc clar, segur, jo diria que s\u00ed, ni de conya, etc. . Aquest exercici es basa en el joc de la Bola 8 m\u00e0gica . 232mates.php : A partir de l'exercici 230, genera un array aleatori de 33 elements amb n\u00fameros compresos entre el 0 i 100 i calcula: El major El menor La mitjana 233sexos.php : Omple un array de 100 elements de manera aleat\u00f2ria amb valors M o F . Un cop completat, torna a rec\u00f3rrer-lo i calcula quants elements hi ha de cadascun dels valors. Per aix\u00f2, emmagatzema el resultat en un array associatiu ['M' => 44, 'F' => 56] . Finalment, mostra el resultat per pantalla 234monedes.php : Torna a fer l'exercici 206, el de les monedes (500, 200, 100, 50, 20, 10, 5, 2, 1), per\u00f2 fent \u00fas d'arrays i un bucle. Emmagatzema el resultat en un array associatiu . Mostra el resultat en una llista desordenada nom\u00e9s amb les quantitats que tenen algun valor. 235altures.php : Mitjan\u00e7ant un array associatiu, emmagatzema el nom i l'al\u00e7ada de 5 persones ( nom => altura ). Posteriorment, recorre l'array i mostra-ho en una taula HTML. Finalment afegeix una darrera fila a la taula amb l'al\u00e7ada mitjana. 236persones.php : Mitjan\u00e7ant un array bidimensional, emmagatzema el nom, al\u00e7ada i email de 5 persones. Per aix\u00f2, crea un array de persones, sent cada persona un array associatiu: [ ['nom'=>'Aitor', 'altura'=>182, 'email'=>'aitor@correo.com'],[ \u2026],\u2026 ] Posteriorment, recorre l'array i mostra'l en una taula HTML. 237llegirQuantitat.html i 237llegirPersones.php : a partir d'un formulari amb un camp de quantitat de persones, generar un nou formulari per llegir el nom, al\u00e7ada i email de quantitat persones. 237gestionarPersones.php : A partir de les persones introdu\u00efdes, mostrar les vostres dades en una taula, i posteriorment, destacar les dades del m\u00e9s alt i la del m\u00e9s baix. 238taulaDistints.php : Omple un array bidimensional de 6 files per 9 columnes amb n\u00fameros aleatoris compresos entre 100 i 999 (tots dos inclosos). Tots els n\u00fameros han de ser diferents, \u00e9s a dir, no se'n pot repetir cap. Mostra a continuaci\u00f3 per pantalla el contingut de l'array de manera que: La columna del m\u00e0xim ha d'apar\u00e8ixer en blau. La fila del m\u00ednim ha d'apar\u00e8ixer en verd La resta de n\u00fameros han d'apar\u00e8ixer en negre. 239Arrays.php : Crea una p\u00e0gina i resol els exercicis seg\u00fcents utilitzant funcions d'arrays: Crea un array amb els noms de diversos alumnes de la classe incloent el teu. Mostra el nombre d'elements que t\u00e9 l'array ( count ). Crea una cadena de text que continga els noms dels alumnes existents en l'array separats per un espai i mostra-la ( implode ). Mostra l'array en un ordre aleatori diferent al que ho vas crear ( shuffle ). Mostra l'array ordenat alfab\u00e8ticament ( sort ). Mostra els alumnes el nom dels quals continga almenys una \u201ca\u201d ( array_filter ). Mostra l'array en l'ordre invers al que es va crear ( rsort ). Mostra la posici\u00f3 que t\u00e9 el teu nom en l'array ( array_search ). 240Ciutats.php : Segons l'INE les 7 ciutats m\u00e9s grans d\u2019Espanya (per habitants) el 2018 van ser les seg\u00fcents: Madrid, MAD, 3.223.334 Sevilla, AN , 688.711 Murcia, MU, 447.182 M\u00e1laga, AN, 571.026 Zaragoza, AR, 666.880 Val\u00e8ncia, CV, 791.413 Barcelona, CAT, 1.620.343 Copia index.php i crea un nou document cituats.php . Defineix un array que continga aquesta informaci\u00f3 sobre ciutats i habitants. Imprimeix una taula d'ubicacions i habitants que incloga la poblaci\u00f3 total de les 7 ciutats. Opcional: Modifica la soluci\u00f3 de l\u2019anterior exercici perqu\u00e8 mostre les ciutats ordenades per habitants. Despr\u00e9s mostra-les per ordre alfab\u00e8tic. 241Alumnes.php : Resol els exercicis seg\u00fcents utilitzant funcions d'arrays: Crea un array d'alumnes on cada element siga un altre array que continga nom i edat de l'alumne. Crea una taula HTML en la qual es mostren totes les dades dels alumnes. Utilitza la funci\u00f3 array_column per a obtenir un array indexat que continga \u00fanicament els noms dels alumnes i mostra\u2019ls per pantalla. Crea un array amb 10 n\u00fameros i utilitza la funci\u00f3 array_sum per a obtenir la suma dels 10 nombres. Sense usar bucles for calcula la mitjana d'edat de l'alumnat. 242CiutatsOpcional.php : Modifica la soluci\u00f3 del exercici ciutats.php perqu\u00e8 la taula continga tamb\u00e9 la columna del total d\u2019habitants de la comunitat aut\u00f2noma de les ciutats de la llista i el percentatge sobre els habitants de la comunitat aut\u00f2noma que representa. Per exemple: Ciutat Habitants Habitats CA % sobre CA Val\u00e8ncia 791.413 5.003.769 15.81% Pista: Caldr\u00e0 modificar l'array $ciutats i convertir-lo en multidimensional. Les dades de comunitats aut\u00f2nomes hauran d'estar en un altre array. Dades: Municipis de Espa\u00f1a Funcions 250arrayParell.php : Crea les funcions seg\u00fcents: Una funci\u00f3 que esbrina si un nombre \u00e9s parell: esParell(int $num): bool . Una funci\u00f3 que retorne un array de mida $tam amb n\u00fameros aleatoris compresos entre $min i $max : arrayAleatori(int $tam, int $min, int $max): array . Una funci\u00f3 que reba un array amb n\u00fameros aleatoris per refer\u00e8ncia i torne la quantitat de nombres parells que hi ha emmagatzemats: arrayParells(array &$array): int . 251parametrosVariables.php : Crea les funcions seg\u00fcents: Una funci\u00f3 que retorne el nombre m\u00e9s gran de tots els n\u00fameros rebuts com a par\u00e0metres: function major(): int . Utilitza les funcions func_get_args() , etc... No pots fer servir la funci\u00f3 max() . Una funci\u00f3 que concatene tots els par\u00e0metres rebuts separant-los amb un espai: function concatenar(...$paraules) : string . Utilitza l'operador . . 252matematiques.php : Afegeix les funcions seg\u00fcents: digits(int $num): int \u2192 retorna la quantitat de d\u00edgits d'un n\u00famero. digitN(int $num, int $pos): int \u2192 torna el d\u00edgit que ocupa, comen\u00e7ant per l'esquerra, la posici\u00f3 $pos . llevarPerDarrere(int $num, int $quantitat): int \u2192 li treu per darrere (dreta) $quantitat d\u00edgits. llevarPerDavant(int $num, int $quantitat): int \u2192 li treu per davant (esquerra) $quantitat d\u00edgits. Per provar les funcions, feu \u00fas tant de pas d'arguments posicionals com arguments amb nom. 253biblioteca.php : crea un fitxer amb funcions per sumar, restar, multiplicar i dividir dos n\u00fameros. 254arrayFunciones.php : fent \u00fas d'un array que emmagatzeme el nom de les funcions del fitxer anterior, a partir de dos n\u00fameros rebuts per URL, recorre l'array i invoca les funcions de manera din\u00e0mica fent \u00fas de funcions variable. 255funcions.php : Escriu una funci\u00f3 per retornar una etiqueta HTML <img /> . La funci\u00f3 hauria d\u2019acceptar com a argument obligatori l\u2019URL de la imatge i arguments opcionals per a un text alternatiu, al\u00e7ada i amplada. 256funcions.php : Copieu la funci\u00f3 de l\u2019exercici anterior i modifiqueu-la de manera que nom\u00e9s es passe el nom de fitxer a la funci\u00f3 en lloc de l\u2019URL completa. Dins de la funci\u00f3, farem \u00fas d\u2019una variable global per fer l\u2019URL completa. Per exemple, si passem photo.png a la funci\u00f3, i la variable global cont\u00e9 /images , llavors l\u2019atribut src de l'etiqueta retornada ser\u00e0 /images/photo.png . Una funci\u00f3 com aquesta \u00e9s una forma senzilla de mantenir correctes les vostres etiquetes d\u2019imatges, fins i tot si les imatges es mouen a un nou cam\u00ed o servidor. Nom\u00e9s cal canviar la variable global, per exemple, de /images a http://images.example.com/. 257funciocolors.php : Els colors web com #ffffff i #cc3399 es realitzen concatenant els valors hexadecimals de color per a vermell, verd i blau. Escriu una funci\u00f3 que accepte 3 arguments: roig, verd i blau, i que retorne un string que cont\u00e9 el color adequat per utilitzar-lo en una p\u00e0gina web. Per exemple, si els arguments s\u00f3n 255, 0, i 255, llavors la cadena retornada hauria de ser #FF00FF. Pot resultar \u00fatil utilitzeu la funci\u00f3 dechex() integrada, que es troba documentada a http://www.php.net/ Assegureu-vos que els par\u00e0metres reben valors enters i que s\u00f3n colors v\u00e0lids. Implementa 3 exemples d\u2019\u00fas. 258. 258funcionsSQL.php : Crea una funci\u00f3 anomenada insert que ens genere una sent\u00e8ncia INSERT INTO en SQL. Per a a\u00e7\u00f2 la funci\u00f3 rebr\u00e0 dos par\u00e0metres: 1. El nom de la taula 2. Un array associatiu que contindr\u00e0 els noms i valors dels camps de la taula. La sent\u00e8ncia resultant tindr\u00e0 la seg\u00fcent forma: ``` \u201cINSERT INTO nom_taula (nom dels camps separats per comes) VALUES (noms dels camps separats per comes amb el car\u00e0cter \u201c:\u201d davant) ``` De moment, no farem res amb els valors dels camps. Ajuda: utilitza les funcions `sprintf`, `implode` i `array_keys` 259funcionsSQL2.php : A partir de l'exercici anterior crea una altra funci\u00f3 que reba els mateixos par\u00e0metres m\u00e9s un par\u00e0metre boole\u00e0 per a indicar si volem generar la query amb els noms dels camps o no. El par\u00e0metre tindr\u00e0 el valor true per defecte. Si el seu valor \u00e9s true generar\u00e0 la consulta igual que en l'exercici anterior, per\u00f2 si \u00e9s false la generar\u00e0 aix\u00ed: INSERT INTO nom_taula VALUES ( valors dels camps separats per comes amb el car\u00e0cter \u2018 : \u2019 davant ) 260funcionsSQLReferencia.php : Repeteix l'exercici anterior amb els seg\u00fcents canvis: La cadena resultant es passar\u00e0 per refer\u00e8ncia. Passarem la cadena de la seg\u00fcent forma: INSERT INTO taula ( camps ) VALUES ( valors ) Dins de la funci\u00f3 substituirem el seg\u00fcent: El text taula pel nom de la taula. El text camps pels noms dels camps separats per comes El text valors pels noms dels camps separats per comes i el car\u00e0cter \u2018:\u2019 davant. Cr\u00e8dits Aitor Medrano. (setembre de 2021) Desarrollo Web en Entorno Servidor disponible en: https://aitor-medrano.github.io/dwes2122/index.html","title":"Activitats"},{"location":"02-basics/99-activities/#activitats","text":"","title":"Activitats"},{"location":"02-basics/99-activities/#php-basic","text":"201tresfrases.php : Mostra 3 frases, cadascuna en un par\u00e0graf utilitzant les tres possibilitats que hi ha de mostrar contingut. Despr\u00e9s, introdueix dos comentaris, un de bloc i un altre d'una l\u00ednia. 202calculs.php : Escriu un programa que utilitze les variables $x i $y . Assigna'ls els valors 166 i 999 respectivament. Tot seguit, mostra per pantalla el valor de cada variable, la suma, la resta, la divisi\u00f3 i la multiplicaci\u00f3. 203dadesPersonals.php : Escriu un programa que emmagatzeme en variables teu nom, primer cognom, segon cognom, email, any de naixement i tel\u00e8fon. Despr\u00e9s mostra'ls per pantalla dins d'una taula. Nom Bruce Cognoms Wayne Email batman@dccomics.com Any de naixement 1939 Tel\u00e8fon 555666777 204dadesPersonales.html i 204dadesPersonales.php : \u00c9s el mateix exercici que l'anterior, per\u00f2 separant la l\u00f2gica. En el primer fitxer crearem el formulari per a introduir les dades i despr\u00e9s recollirem les dades i generarem la taula en el segon arxiu. 205anys.php : Despr\u00e9s de llegir l'edat d'una persona per la URL, mostrar l'edat que tindr\u00e0 d'aqu\u00ed a 10 anys i fa 10 anys. A m\u00e9s, mostra quin any ser\u00e0 en cada un dels casos. Finalment, mostra l'any de jubilaci\u00f3 suposant que treballar\u00e0s fins als 67 anys. No cal que faces un formulari, pots provar-ho directament via URL: 205anys.php?edad=33 . Tip: $currentYear = date(\"Y\") ; 206diners.php : A partir d'una quantitat de diners, mostrar la seva descomposici\u00f3 en bitllets (500, 200, 100, 50, 20, 10, 5) i monedes (2, 1) perqu\u00e8 el nombre d'elements sigui m\u00ednim. No es pot utilitzar cap instrucci\u00f3 condicional. Per exemple, en introduir 139 ha de mostrar: 1 bitllet de 100 0 bitllet de 50 1 bitllet de 20 1 bitllet de 10 1 bitllet de 5 2 moneda de 2 Tip: Pots for\u00e7ar a realitzar la divisi\u00f3 sencera mitjan\u00e7ant la funci\u00f3 intdiv($dividend, $divisor) o passar un nombre flotant a sencer pots fer servir la funci\u00f3 intval() . 207posnegzero.php : A partir d'un n\u00famero, mostra per pantalla si el n\u00famero \u00e9s positiu, negatiu o zero. 208mayor3.php : Sense fer \u00fas de condicions que utilitzen dins de la condici\u00f3 els operadors l\u00f2gics, mostra el m\u00e9s gran de tres n\u00fameros (a, b i c). 209mayor3c.php : Utilitza en les condicions els operadors l\u00f2gics. 210nomEdad.php : A partir d'una edat mostra per pantalla: nad\u00f3 si t\u00e9 menys de 3 anys nen si t\u00e9 entre 3 i 12 anys adolescent entre 13 i 17 anys adult entre 18 i 66 jubilat a partir de 67","title":"PHP B\u00e0sic"},{"location":"02-basics/99-activities/#exercicis-dinvestigacio","text":"Investiga perqu\u00e8 serveix l'operador nau espacial, disponible des de PHP7 ( https://www.php.net/manual/es/migration70.new-features.php ). Explica amb un parell de l\u00ednies el seu prop\u00f2sit i mitjan\u00e7ant el codi demostra el seu \u00fas. Investiga per a qu\u00e8 serveix la instrucci\u00f3 match() , disponible des de PHP8 ( https://www.php.net/manual/ca/control-structures.match.php ). Explica amb un parell de l\u00ednies el seu prop\u00f2sit i mitjan\u00e7ant el codi demostra el seu \u00fas.","title":"Exercicis d'investigaci\u00f3"},{"location":"02-basics/99-activities/#dates","text":"213Dates.php : Crea un fitxer que realitza les seg\u00fcents tasques: Mostra la data i hora actuals amb el format: dd/mm/yyyy hh:mm:ss Mostra el nom de la zona hor\u00e0ria que s'utilitza per defecte. Mostra la data de que ser\u00e0 d\u2019ac\u00ed 45 dies. Mostra el nombre de dies que han passat des de l'1 de gener. Mostra la data i hora actuals de Nova York. Mostra el dia de la setmana que era l'1 de gener d'enguany.","title":"Dates"},{"location":"02-basics/99-activities/#cadenes","text":"214Cadenes.php : Crea una p\u00e0gina que reba un nom. Amb la directiva de tipus estricta ( declare( strict_types = 1 ); ) aplica les seg\u00fcents funcions: Elimina els espais del principi i el final del nom si els hi haguera ( trim ). Elimina la lletra a del principi i el final del nom si els hi haguera ( trim ). Mostra la variable nom en maj\u00fascules, min\u00fascules i amb la primera lletra en maj\u00fascula i les altres en min\u00fascules ( strtoupper , strtolower , ucfirst ). Mostra el codi ascii de la primera lletra del nom ( ord ). Mostra la longitud del nom ( strlen ). Mostra el nombre de vegades que apareix la lletra a (maj\u00fascula o min\u00fascula, substr_count ). Mostra la posici\u00f3 de la primera a existent en el nom, siga maj\u00fascula o min\u00fascula ( strpos ). Si no hi ha cap mostrar\u00e0 -1. El mateix, per\u00f2 amb l''\u00faltima a . Mostra el nom substituint la lletra o pel n\u00famero 0 , siga maj\u00fascula o min\u00fascula ( str_replace ). Indica si el nom comen\u00e7a per al o no. 215Cadenes.php : Utilitza la funci\u00f3 parse_url per a extraure de la url les seg\u00fcents parts: El protocol utilitzat (en l'exemple \"http\"). El nom d'usuari (en l'exemple \"username\"). El path de la url (en l'exemple \"/path\"). El querystring de la url (en l'exemple \"arg=value\"). $url = \"http://username:password@hostname:9090/path?arg=value#anchor\" ;","title":"Cadenes"},{"location":"02-basics/99-activities/#bucles","text":"220parells050.php: Escriu un programa que mostre els n\u00fameros parells del 0 al 50 (dintre d'una llista desordenada). 220parellsAB.php : A partir de l'anterior, refacciona perqu\u00e8 funcione amb els par\u00e0metres inici i fi . 221suma110.php : Escriu un programa que sume els n\u00fameros de l'1 al 10. 221sumaAB.php : A partir de l'anterior, refacciona perqu\u00e8 funcione amb inici i fi . 222potencia.php : A partir d'una base i exponent, mitjan\u00e7ant l'acumulaci\u00f3 de productes, calcula la pot\u00e8ncia utilitzant l'instrucci\u00f3 for . 222potenciaWhile.php : Reescriu l'exercici anterior fent \u00fas de while . 222potenciaDoWhile.php : Reescriu l'exercici anterior fent \u00fas sols de do-while . 223taulaMultiplicar.php : Mostra dins d'una taula HTML la taula de multiplicar d'un n\u00famero . Utiliza <thead> amb els seus respectius <th> y <tbody > per a dibujar la tabla. Per exemple: a * b = a*b 7 * 1 = 7 7 * 2 = 14 ... 7 * 10 = 70 224formulari.html : Crea un formulario que permeta llegir una quantitat . 224llegirDades.php : A partir de quantitat , prepara un formulari amb tantes caixes ( textbox ) com el valor de quantitat rebut. Finalment, en 224sumarDades.php : a partir de les dades de totes les caixes de text de la p\u00e0gina anterior, suma i mostra el total. 225formulari.html i 225taula.php : A partir d'un nombre de files i columnes , crear una taula amb aquesta mida. Les cel\u00b7les han d'estar emplenades amb els valors de les coordenades de cada cel\u00b7la. 226formulari.html i 226quadrat.php : Basant-te en l'exercici anterior, omple la taula de manera que nom\u00e9s les vores tinguin contingut, quedant-se la resta de cel\u00b7les en blanc. 227formulari.html i 227equis.php : Basant-te en l'exercici anterior, ara nom\u00e9s ha d'apar\u00e8ixer el contingut dels dos diagonals. 228quadratMultiplicar.php : Crea un programa que mostre per pantalla un quadrat exactament igual (fixa't b\u00e9 a les cap\u00e7aleres, tant de les files com de les columnes) al de la imatge amb les taules de multiplicar.","title":"Bucles"},{"location":"02-basics/99-activities/#arrays","text":"230aleatoris50.php : Omple un array amb 50 n\u00fameros aleatoris compresos entre el 0 i el 99, i despr\u00e9s mostra'l en una llista desordenada. Per crear un nombre aleatori, utilitzeu la funci\u00f3 rand(inici, fi) . Per exemple: $num = rand ( 0 , 99 ) 231bola8.html : Prepara un formulari amb una caixa de text que fa\u00e7a una pregunta a l\\'usuari. 231bola8.php : A partir de l'anterior, crea un programa que mostre la pregunta rebuda i genere una resposta de manera aleat\u00f2ria entre un conjunt de respostes predefinides, emmagatzemades en un array : Si, no, potser, \u00e9s clar que s\u00ed, per suposat que no, no ho tinc clar, segur, jo diria que s\u00ed, ni de conya, etc. . Aquest exercici es basa en el joc de la Bola 8 m\u00e0gica . 232mates.php : A partir de l'exercici 230, genera un array aleatori de 33 elements amb n\u00fameros compresos entre el 0 i 100 i calcula: El major El menor La mitjana 233sexos.php : Omple un array de 100 elements de manera aleat\u00f2ria amb valors M o F . Un cop completat, torna a rec\u00f3rrer-lo i calcula quants elements hi ha de cadascun dels valors. Per aix\u00f2, emmagatzema el resultat en un array associatiu ['M' => 44, 'F' => 56] . Finalment, mostra el resultat per pantalla 234monedes.php : Torna a fer l'exercici 206, el de les monedes (500, 200, 100, 50, 20, 10, 5, 2, 1), per\u00f2 fent \u00fas d'arrays i un bucle. Emmagatzema el resultat en un array associatiu . Mostra el resultat en una llista desordenada nom\u00e9s amb les quantitats que tenen algun valor. 235altures.php : Mitjan\u00e7ant un array associatiu, emmagatzema el nom i l'al\u00e7ada de 5 persones ( nom => altura ). Posteriorment, recorre l'array i mostra-ho en una taula HTML. Finalment afegeix una darrera fila a la taula amb l'al\u00e7ada mitjana. 236persones.php : Mitjan\u00e7ant un array bidimensional, emmagatzema el nom, al\u00e7ada i email de 5 persones. Per aix\u00f2, crea un array de persones, sent cada persona un array associatiu: [ ['nom'=>'Aitor', 'altura'=>182, 'email'=>'aitor@correo.com'],[ \u2026],\u2026 ] Posteriorment, recorre l'array i mostra'l en una taula HTML. 237llegirQuantitat.html i 237llegirPersones.php : a partir d'un formulari amb un camp de quantitat de persones, generar un nou formulari per llegir el nom, al\u00e7ada i email de quantitat persones. 237gestionarPersones.php : A partir de les persones introdu\u00efdes, mostrar les vostres dades en una taula, i posteriorment, destacar les dades del m\u00e9s alt i la del m\u00e9s baix. 238taulaDistints.php : Omple un array bidimensional de 6 files per 9 columnes amb n\u00fameros aleatoris compresos entre 100 i 999 (tots dos inclosos). Tots els n\u00fameros han de ser diferents, \u00e9s a dir, no se'n pot repetir cap. Mostra a continuaci\u00f3 per pantalla el contingut de l'array de manera que: La columna del m\u00e0xim ha d'apar\u00e8ixer en blau. La fila del m\u00ednim ha d'apar\u00e8ixer en verd La resta de n\u00fameros han d'apar\u00e8ixer en negre. 239Arrays.php : Crea una p\u00e0gina i resol els exercicis seg\u00fcents utilitzant funcions d'arrays: Crea un array amb els noms de diversos alumnes de la classe incloent el teu. Mostra el nombre d'elements que t\u00e9 l'array ( count ). Crea una cadena de text que continga els noms dels alumnes existents en l'array separats per un espai i mostra-la ( implode ). Mostra l'array en un ordre aleatori diferent al que ho vas crear ( shuffle ). Mostra l'array ordenat alfab\u00e8ticament ( sort ). Mostra els alumnes el nom dels quals continga almenys una \u201ca\u201d ( array_filter ). Mostra l'array en l'ordre invers al que es va crear ( rsort ). Mostra la posici\u00f3 que t\u00e9 el teu nom en l'array ( array_search ). 240Ciutats.php : Segons l'INE les 7 ciutats m\u00e9s grans d\u2019Espanya (per habitants) el 2018 van ser les seg\u00fcents: Madrid, MAD, 3.223.334 Sevilla, AN , 688.711 Murcia, MU, 447.182 M\u00e1laga, AN, 571.026 Zaragoza, AR, 666.880 Val\u00e8ncia, CV, 791.413 Barcelona, CAT, 1.620.343 Copia index.php i crea un nou document cituats.php . Defineix un array que continga aquesta informaci\u00f3 sobre ciutats i habitants. Imprimeix una taula d'ubicacions i habitants que incloga la poblaci\u00f3 total de les 7 ciutats. Opcional: Modifica la soluci\u00f3 de l\u2019anterior exercici perqu\u00e8 mostre les ciutats ordenades per habitants. Despr\u00e9s mostra-les per ordre alfab\u00e8tic. 241Alumnes.php : Resol els exercicis seg\u00fcents utilitzant funcions d'arrays: Crea un array d'alumnes on cada element siga un altre array que continga nom i edat de l'alumne. Crea una taula HTML en la qual es mostren totes les dades dels alumnes. Utilitza la funci\u00f3 array_column per a obtenir un array indexat que continga \u00fanicament els noms dels alumnes i mostra\u2019ls per pantalla. Crea un array amb 10 n\u00fameros i utilitza la funci\u00f3 array_sum per a obtenir la suma dels 10 nombres. Sense usar bucles for calcula la mitjana d'edat de l'alumnat. 242CiutatsOpcional.php : Modifica la soluci\u00f3 del exercici ciutats.php perqu\u00e8 la taula continga tamb\u00e9 la columna del total d\u2019habitants de la comunitat aut\u00f2noma de les ciutats de la llista i el percentatge sobre els habitants de la comunitat aut\u00f2noma que representa. Per exemple: Ciutat Habitants Habitats CA % sobre CA Val\u00e8ncia 791.413 5.003.769 15.81% Pista: Caldr\u00e0 modificar l'array $ciutats i convertir-lo en multidimensional. Les dades de comunitats aut\u00f2nomes hauran d'estar en un altre array. Dades: Municipis de Espa\u00f1a","title":"Arrays"},{"location":"02-basics/99-activities/#funcions","text":"250arrayParell.php : Crea les funcions seg\u00fcents: Una funci\u00f3 que esbrina si un nombre \u00e9s parell: esParell(int $num): bool . Una funci\u00f3 que retorne un array de mida $tam amb n\u00fameros aleatoris compresos entre $min i $max : arrayAleatori(int $tam, int $min, int $max): array . Una funci\u00f3 que reba un array amb n\u00fameros aleatoris per refer\u00e8ncia i torne la quantitat de nombres parells que hi ha emmagatzemats: arrayParells(array &$array): int . 251parametrosVariables.php : Crea les funcions seg\u00fcents: Una funci\u00f3 que retorne el nombre m\u00e9s gran de tots els n\u00fameros rebuts com a par\u00e0metres: function major(): int . Utilitza les funcions func_get_args() , etc... No pots fer servir la funci\u00f3 max() . Una funci\u00f3 que concatene tots els par\u00e0metres rebuts separant-los amb un espai: function concatenar(...$paraules) : string . Utilitza l'operador . . 252matematiques.php : Afegeix les funcions seg\u00fcents: digits(int $num): int \u2192 retorna la quantitat de d\u00edgits d'un n\u00famero. digitN(int $num, int $pos): int \u2192 torna el d\u00edgit que ocupa, comen\u00e7ant per l'esquerra, la posici\u00f3 $pos . llevarPerDarrere(int $num, int $quantitat): int \u2192 li treu per darrere (dreta) $quantitat d\u00edgits. llevarPerDavant(int $num, int $quantitat): int \u2192 li treu per davant (esquerra) $quantitat d\u00edgits. Per provar les funcions, feu \u00fas tant de pas d'arguments posicionals com arguments amb nom. 253biblioteca.php : crea un fitxer amb funcions per sumar, restar, multiplicar i dividir dos n\u00fameros. 254arrayFunciones.php : fent \u00fas d'un array que emmagatzeme el nom de les funcions del fitxer anterior, a partir de dos n\u00fameros rebuts per URL, recorre l'array i invoca les funcions de manera din\u00e0mica fent \u00fas de funcions variable. 255funcions.php : Escriu una funci\u00f3 per retornar una etiqueta HTML <img /> . La funci\u00f3 hauria d\u2019acceptar com a argument obligatori l\u2019URL de la imatge i arguments opcionals per a un text alternatiu, al\u00e7ada i amplada. 256funcions.php : Copieu la funci\u00f3 de l\u2019exercici anterior i modifiqueu-la de manera que nom\u00e9s es passe el nom de fitxer a la funci\u00f3 en lloc de l\u2019URL completa. Dins de la funci\u00f3, farem \u00fas d\u2019una variable global per fer l\u2019URL completa. Per exemple, si passem photo.png a la funci\u00f3, i la variable global cont\u00e9 /images , llavors l\u2019atribut src de l'etiqueta retornada ser\u00e0 /images/photo.png . Una funci\u00f3 com aquesta \u00e9s una forma senzilla de mantenir correctes les vostres etiquetes d\u2019imatges, fins i tot si les imatges es mouen a un nou cam\u00ed o servidor. Nom\u00e9s cal canviar la variable global, per exemple, de /images a http://images.example.com/. 257funciocolors.php : Els colors web com #ffffff i #cc3399 es realitzen concatenant els valors hexadecimals de color per a vermell, verd i blau. Escriu una funci\u00f3 que accepte 3 arguments: roig, verd i blau, i que retorne un string que cont\u00e9 el color adequat per utilitzar-lo en una p\u00e0gina web. Per exemple, si els arguments s\u00f3n 255, 0, i 255, llavors la cadena retornada hauria de ser #FF00FF. Pot resultar \u00fatil utilitzeu la funci\u00f3 dechex() integrada, que es troba documentada a http://www.php.net/ Assegureu-vos que els par\u00e0metres reben valors enters i que s\u00f3n colors v\u00e0lids. Implementa 3 exemples d\u2019\u00fas. 258. 258funcionsSQL.php : Crea una funci\u00f3 anomenada insert que ens genere una sent\u00e8ncia INSERT INTO en SQL. Per a a\u00e7\u00f2 la funci\u00f3 rebr\u00e0 dos par\u00e0metres: 1. El nom de la taula 2. Un array associatiu que contindr\u00e0 els noms i valors dels camps de la taula. La sent\u00e8ncia resultant tindr\u00e0 la seg\u00fcent forma: ``` \u201cINSERT INTO nom_taula (nom dels camps separats per comes) VALUES (noms dels camps separats per comes amb el car\u00e0cter \u201c:\u201d davant) ``` De moment, no farem res amb els valors dels camps. Ajuda: utilitza les funcions `sprintf`, `implode` i `array_keys` 259funcionsSQL2.php : A partir de l'exercici anterior crea una altra funci\u00f3 que reba els mateixos par\u00e0metres m\u00e9s un par\u00e0metre boole\u00e0 per a indicar si volem generar la query amb els noms dels camps o no. El par\u00e0metre tindr\u00e0 el valor true per defecte. Si el seu valor \u00e9s true generar\u00e0 la consulta igual que en l'exercici anterior, per\u00f2 si \u00e9s false la generar\u00e0 aix\u00ed: INSERT INTO nom_taula VALUES ( valors dels camps separats per comes amb el car\u00e0cter \u2018 : \u2019 davant ) 260funcionsSQLReferencia.php : Repeteix l'exercici anterior amb els seg\u00fcents canvis: La cadena resultant es passar\u00e0 per refer\u00e8ncia. Passarem la cadena de la seg\u00fcent forma: INSERT INTO taula ( camps ) VALUES ( valors ) Dins de la funci\u00f3 substituirem el seg\u00fcent: El text taula pel nom de la taula. El text camps pels noms dels camps separats per comes El text valors pels noms dels camps separats per comes i el car\u00e0cter \u2018:\u2019 davant.","title":"Funcions"},{"location":"02-basics/99-activities/#credits","text":"Aitor Medrano. (setembre de 2021) Desarrollo Web en Entorno Servidor disponible en: https://aitor-medrano.github.io/dwes2122/index.html","title":"Cr\u00e8dits"},{"location":"03-phpoo/0301-phpoo-basic/","text":"POO en PHP. Conceptes b\u00e0sics Introducci\u00f3 La programaci\u00f3 orientada a objectes (OOP, per les seues sigles en angl\u00e8s) \u00e9s un paradigma de programaci\u00f3. Paradigma: Teoria [\u2026] el nucli central de la qual [\u2026] suministra la base i el model per resoldre problemes i avan\u00e7ar en el coneixement. Per la qual cosa podem definir la programaci\u00f3 orientada a objecte com un m\u00e8tode -provat i estudiat- el qual es basa en les interaccions d'objectes per resoldre les necessitats d'un sistema inform\u00e0tic. Un objecte \u00e9s una estructura que cont\u00e9 dades i el codi que els maneja. L'estructura dels objectes es defineix en les classes. En elles s'escriu el codi que defineix el comportament dels objectes i s'indiquen els membres que formaran part dels objectes d'aquesta classe. Entre els membres de una classe pot haver-hi: M\u00e8todes . S\u00f3n els membres de la classe que contenen el codi de la mateixa. Un m\u00e8tode \u00e9s com una funci\u00f3. Pot rebre par\u00e0metres i retornar valors. Atributs o propietats . Emmagatzemen informaci\u00f3 sobre el estat de l'objecte al que pertanyen (i per tant, el seu valor pot ser diferent per a cadascun dels objectes de la mateixa classe). A la creaci\u00f3 d'un objecte basat en una classe se li anomena instanciar una classe i a l'objecte obtingut tamb\u00e9 se li coneix com a inst\u00e0ncia d'aqueixa classe. Els pilars fonamentals de la POO s\u00f3n: Her\u00e8ncia . \u00c9s el proc\u00e9s de crear una classe a partir de una altra, heretant el seu comportament i caracter\u00edstiques i podent redefinir-los. Abstracci\u00f3 . L'objectiu principal es gestionar la complexitat ocultant detalls innecessaris a l'usuari. Aix\u00f2 li permet implementar l\u00f2gica m\u00e9s complexa sobre la base de la abstracci\u00f3 sense entendre o, incl\u00fas, sense pensar en tota la seua complexitat oculta. Polimorfisme . Un mateix m\u00e8tode pot tenir comportaments diferents en funci\u00f3 de l'objecte amb que s'utilitze. Encapsulaci\u00f3 . La idea \u00e9s mantindre en una mateix lloc (unitat de codi) les dades i el codi que els manipula. Aquest concepte tamb\u00e9 s'utilitza sovint per ocultar la representaci\u00f3 interna, o estat, d'un objecte des de l'exterior. Aix\u00f2 s'anomena ocultaci\u00f3 d'informaci\u00f3 . Els avantatges m\u00e9s importants que aporta la programaci\u00f3 orientada a objectes s\u00f3n: Modularitat . La POO permet dividir els programes en parts o m\u00f2duls m\u00e9s xicotets, que s\u00f3n independents uns d'uns altres per\u00f2 poden comunicar-se entre ells. Extensibilitat . Si es desitgen afegir noves caracter\u00edstiques a una aplicaci\u00f3, la POO facilita aquesta tasca de dues formes: afegint nous m\u00e8todes al codi, o creant nous objectes que estenguen el comportament dels ja existents. Manteniment . Els programes desenvolupats utilitzant POO s\u00f3n m\u00e9s senzills de mantenir, a causa de la modularitat abans comentada. Tamb\u00e9 ajuda seguir certes convencions en escriure'ls, per exemple, escriure cada classe en un fitxer propi. No ha d'haver-hi dues classes en un mateix fitxer, ni un altre codi a part del propi de la classe. Caracter\u00edstiques b\u00e0siques de l'\u00fas d'objectes en PHP Segurament tot, o la majoria del que acabes de veure, ja ho coneixies, i \u00e9s fins i tot probable que s\u00e0pigues utilitzar algun llenguatge de programaci\u00f3 orientat a objectes, aix\u00ed que anem a veure directament les peculiaritats pr\u00f2pies de PHP en el que fa refer\u00e8ncia a la POO. En PHP podemos utilitzar els dos paradigmes de la programaci\u00f3: estructurada i orientada a objectes. // utilitzant programaci\u00f3 estructurada $dwes = mysqli_connect ( 'localhost' , 'dwes' , 'abc123.' , 'dwes' ); // utilizant POO $dwes = new mysqli (); $dwes -> connect ( 'localhost' , 'dwes' , 'abc123.' , 'dwes' ); No obstant a\u00e7\u00f2, el llenguatge PHP original no es va dissenyar amb caracter\u00edstiques d'orientaci\u00f3 a objectes. Nom\u00e9s a partir de la versi\u00f3 3, es van comen\u00e7ar a introduir alguns trets de POO en el llenguatge. A\u00e7\u00f2 es va potenciar en la versi\u00f3 4, encara que encara de forma molt rudiment\u00e0ria. Per exemple, en PHP4: Els objectes es passen sempre per valor, no per refer\u00e8ncia. No es pot definir el nivell d'acc\u00e9s per als membres de la classe. Tots s\u00f3n p\u00fablics. No existeixen les interf\u00edcies. No existeixen m\u00e8todes destructors. En PHP5 es va reescriure i potenciar el suport d'orientaci\u00f3 a objectes del llenguatge, ampliant les seues caracter\u00edstiques i millorant el seu rendiment i el seu funcionament general. Les caracter\u00edstiques de POO que suporta PHP5 inclouen: M\u00e8todes est\u00e0tics. M\u00e8todes constructors i destructors. Her\u00e8ncia. Interf\u00edcies. Classes abstractes. Entre les caracter\u00edstiques que no inclou PHP5, i que pots con\u00e8ixer d'altres llenguatges de programaci\u00f3, estan: Her\u00e8ncia m\u00faltiple. Sobrec\u00e0rrega de m\u00e8todes (tenir diversos m\u00e8todes amb el mateix nom, per\u00f2 amb funcionalitats diferents. Els m\u00e8todes sobrecarregats han de tenir diferents par\u00e0metres. Quan es diu al m\u00e8tode, s'utilitza una o una altra versi\u00f3 en funci\u00f3 dels par\u00e0metres amb que es realitze la trucada (podent distingir per el seu nombre i per el seu tipus, segons el llenguatge de programaci\u00f3 utilitzat)) (inclosos els m\u00e8todes constructors). Sobrec\u00e0rrega d'operadors (similar a la sobrec\u00e0rrega de m\u00e8todes. Es poden definir diverses funcionalitats a un mateix operador, i s'utilitzar\u00e0 una o una altra en funci\u00f3 del tipus dels operands que s'usen en cada instant). PHP 7 incorpora millores en el rendiment i el tipat d'arguments, valors de retorn i atributs (des de la versi\u00f3 7.4) Quant a les novetats aportades per PHP 8 cal destacar: l'operador nullsafe , la propagaci\u00f3 de propietats en els constructors, la uni\u00f3 de tipus que permet definir tipus m\u00faltiples. Objectes sempre es passen per refer\u00e8ncia Els objectes que s'envien o reben com a par\u00e0metres sempre es passen per refer\u00e8ncia. Definici\u00f3 de classes La declaraci\u00f3 de una classe en PHP es fa utilitzant la paraula class . A continuaci\u00f3 i entre claus, han de figurar els membres de la classe. Conv\u00e9 fer-ho de forma ordenada, primer les propietats o atributs, i despr\u00e9s els m\u00e8todes, cadascun amb el seu codi respectiu. class Product { private string $code ; public string $name ; public float $price ; public function getSummaryLine () : string { return $this -> name ; } } En UML la classe anterior es representaria aix\u00ed: classDiagram class Product { -string code +string name +float price +string getSummaryLine() } Com coment\u00e0vem abans, \u00e9s preferible que cada classe figure en el seu propi fitxer ( Product.php ). A m\u00e9s, molts programadors prefereixen utilitzar per a les classes noms que comencen per lletra maj\u00fascula, per a, d'aquesta forma, distingir-los dels objectes i altres variables. Una vegada definida la classe, podem usar la paraula new per a instanciar objectes de la seg\u00fcent forma: $product = new Product (); Perqu\u00e8 la l\u00ednia anterior s'execute sense error, pr\u00e8viament hem d'haver declarat la classe. Per a a\u00e7\u00f2, en aqueix mateix fitxer haur\u00e0s de incloure la classe posant alguna cosa com: require ( 'Product.php' ); Els atributs de una classe s\u00f3n similars a les variables de PHP. \u00c9s possible indicar un valor en la declaraci\u00f3 de la classe. En aquest cas, tots els objectes que s'instancien a partir de aqueixa classe, partiran amb aqueix valor per defecte en l'atribut. Per a accedir des d'un objecte als seus atributs o als m\u00e8todes de la classe, has d'utilitzar l'operador fletxa (fixa't que nom\u00e9s es posa el s\u00edmbol $ davant del nom de l'objecte): $product -> name = 'Samsung Galaxy S' ; echo $product -> getSummaryLine (); Visibilitat Quan es declara una propietat o un m\u00e8tode, s'ha d'indicar el seu nivell d'acc\u00e9s (o visibilitat). Els principals nivells s\u00f3n: public . Els atributs declarats com public poden utilitzar-se directament per els objectes de la classe. \u00c9s el cas de l'atribut $name anterior. private . Els atributs declarats com private nom\u00e9s poden ser accedits i modificats per els m\u00e8todes definits en la classe, no directament per els objectes de la mateixa. \u00c9s el cas de l'atribut $code . protected . Una propietat o m\u00e8tode protected sols pot ser accedida per la classe on es defineix o per un subclasse. No \u00e9s accessible des de fora. Un dels motius per a crear atributs privats \u00e9s que el seu valor forma part de la informaci\u00f3 interna de l'objecte i no ha de formar part de la seua interf\u00edcie (els punts de comunicaci\u00f3 amb altres objectes). Un altre motiu \u00e9s mantenir cert control sobre els seus possibles valors. Per exemple, si no vols que es puga canviar lliurement el valor del codi d'un producte. O necessites con\u00e8ixer quin ser\u00e0 el nou valor abans d'assignar-lo. En aquests casos, se solen definir aqueixos atributs com a privats i a m\u00e9s es creen dins de la classe m\u00e8todes per a permetre'ns obtenir i/o modificar els valors d'aqueixos atributs. Per exemple: private string $code ; public function setCode ( string $newCode ) : boolean { if ( ! existsCode ( $newCode )) { $this -> code = $newCode ; return true ; } return false ; } public function getCode () : string { return $this -> code ; } Encara que no \u00e9s obligatori, el nom del m\u00e8tode que ens permet obtenir el valor de un atribut sol comen\u00e7ar per get , i el que ens permet modificar-lo per set . Aquest m\u00e8todes solen anomenar-se getters i setters o accessors . Constructor Com ja has vist, per a instanciar objectes d'una classe s'utilitza la paraula new : $product = new Product (); En PHP7 pots definir en les classes m\u00e8todes constructors, que s'executen quan es crea l'objecte. El constructor d'una classe ha d'anomenar-se __construct . Es poden utilitzar, per exemple, per assignar valors a atributs. class Product { private string $code ; public string $name ; public function __construct () { $this -> code = \"\" ; } \u2026 } El constructor d'una classe pot cridar a altres m\u00e8todes o tenir par\u00e0metres, en aquest cas hauran de passar-se quan es crea l'objecte. No obstant a\u00e7\u00f2, nom\u00e9s pot haver-hi un m\u00e8tode constructor en cada classe. class Product { private string $code ; public string $name ; public function __construct ( string $code ) { $this -> $code = $code ; } ... } $product = new Product ( 'GALAXYS' ); Si com en aquest exemple, definim un constructor en el qual cal passar el codi, sempre que instancies un nou objecte d'aqueixa classe haur\u00e0s d'indicar el seu codi. En PHP8 podem definir les propietats de la seg\u00fcent manera: class Product { public string $name ; public function __construct ( private string $code ) { } ... } D'aquest forma ens estalviem diverses l\u00ednies de codi. La pseuodovariable $this Quan des d'un objecte s'invoca un m\u00e8tode de la classe, a aquest se li passa sempre una refer\u00e8ncia a l'objecte que ha fet la crida. Aquesta refer\u00e8ncia s'emmagatzema en la pseudovariable $this. S'utilitza, per exemple, en el codi anterior per a tenir acc\u00e9s als atributs privats de l'objecte (que nom\u00e9s s\u00f3n accessibles des dels m\u00e8todes de la classe). echo \" < p > \" . $this->code . \" </ p > \"; Constants de classe A m\u00e9s de m\u00e8todes i propietats, en una classe tamb\u00e9 es poden definir constants, utilitzant la paraula const . \u00c9s important que no confongues els atributs amb les constants. S\u00f3n conceptes diferents: les constants no poden canviar el seu valor (\u00f2bviament, d'ah\u00ed el seu nom), no usen el car\u00e0cter $ , s'escriuen en maj\u00fascules (per convenci\u00f3) i el seu valor est\u00e0 associat a la classe, \u00e9s a dir, no existeix una c\u00f2pia del mateix en cada objecte. Per tant, per a accedir a les constants d'una classe, s'ha d'utilitzar el nom de la classe i l'operador :: , anomenat operador de resoluci\u00f3 d'\u00e0mbit (que s'utilitza per a accedir a els elements de una classe). class DB { const USUARIO = 'dwes' ; ... } echo DB :: USUARIO ; \u00c9s important ressaltar que no \u00e9s necessari que existisca cap objecte de una classe per a poder accedir al valor de les constants que definisca. PHP-FIG El PHP Framework Interop Group \u00e9s un grup de treball on est\u00e0 involucrada gent que treballa en diferents frameworks amb l'objectiu de posar en com\u00fa les t\u00e8cniques que usen en els diferents projectes per poder integrar-les i compartir-les i poder treballar millor junts. Les recomanacions PSR-1 i PSR-12 s\u00f3n recomanacions sobre l'estil de programaci\u00f3 amb l'objectiu d'aplicar estandards comuns i aix\u00ed facilitar la lectura del codi realitzar per altres. Algunes recomancions que cal seguir: Les classes s'han de declarar en StudlyCaps . Per exemple: Product . Les constants de classes s'HAN DE declarar en maj\u00fascules i separats amb gui\u00f3 baix. Per exemple: const IMAGE_PATH . Sobre els noms de les propietats la \u00fanica recomanaci\u00f3 \u00e9s ser consistent. Aix\u00ed, PODEM usar $camelCase . La mateixa recomanaci\u00f3 aplicarem a les variables. Els m\u00e8todes S'HAN DE declarar en camelCase() . M\u00e9s informaci\u00f3 en Est\u00e1ndares Utilitzaci\u00f3 d'objectes Ja saps com instanciar un objecte utilitzant new , i com accedir a els seus m\u00e8todes i atributs p\u00fablics amb l'operador fletxa: $product = new Product (); $product -> name = 'Samsung Galaxy S' ; echo $product -> getSummaryLine (); Una vegada creat un objecte, pots utilitzar l'operador instanceof per a comprovar si \u00e9s o no una inst\u00e0ncia de una classe determinada. if ( $product instanceof Product ) { \u2026 } Des de PHP7, pots indicar en les funcions i m\u00e8todes de quina classe han de ser els objectes que es passen com a par\u00e0metres. Per a a\u00e7\u00f2, has d'especificar el tipus abans del par\u00e0metre. public function sellProduct ( Product $product ) { \u2026 } Si quan es realitza la crida, el par\u00e0metre no \u00e9s del tipus adequat, es produeix un error que podries capturar. Una caracter\u00edstica de la POO que has de tenir molt en compte \u00e9s qu\u00e8 succeeix amb els objectes quan els passes a una funci\u00f3, o simplement quan executes un codi com el seg\u00fcent: $product1 = new Product (); $product1 -> name = 'Samsung Galaxy S' ; $product2 = $product1 ; El codi anterior simplement crearia un nou identificador del mateix objecte. A\u00e7\u00f2 \u00e9s, quan s'utilitze qualsevol dels identificadors per a canviar el valor de algun atribut, aquest canvi es veuria tamb\u00e9 reflectit en accedir utilitzant l'altre identificador. Recorda que, encara que hi haja dos o m\u00e9s identificadors del mateix objecte, en realitat tots es refereixen a l'\u00fanica c\u00f2pia que s'emmagatzema del mateix. Comparaci\u00f3 d'Objectes En utilitzar l'operador de comparaci\u00f3 ( == ), es comparen d'una manera senzilla les variables de cada objecte, \u00e9s a dir: dues inst\u00e0ncies d'un objecte s\u00f3n iguals si tenen els mateixos atributs i valors (els valors es comparen amb == ), i s\u00f3n inst\u00e0ncies de la mateixa classe. Quan s'utilitza l'operador identitat ( === ), les variables d'un objecte s\u00f3n id\u00e8ntiques si i nom\u00e9s s\u00ed fan refer\u00e8ncia a la mateixa inst\u00e0ncia de la mateixa classe. Her\u00e8ncia L'her\u00e8ncia \u00e9s un mecanisme de la POO que ens permet definir noves classes sobre la base d'una altra ja existent. Les noves classes que hereten tamb\u00e9 es coneixen amb el nom de subclasses. La classe de la qual hereten es diu classe base o superclasse. Per exemple, en la nostra tenda web anem a tenir productes de diferents tipus. En principi hem creat per a manejar-los una classe anomenada Product , amb alguns atributs i un m\u00e8tode que genera una eixida personalitzada en format HTML del codi. class Product { public string $code ; public string $name ; ... public function show () { echo \"<p>\" . $this -> code . \"</p>\" ; } } Aquesta classe \u00e9s molt \u00fatil si l'\u00fanica informaci\u00f3 que tenim dels diferents productes \u00e9s la que es mostra dalt. Per\u00f2, si vols personalitzar la informaci\u00f3 que vas a tractar de cada tipus de producte (i emmagatzemar, per exemple per als televisors, les polzades que tenen o la seua tecnologia de fabricaci\u00f3), pots crear noves classes que hereten de Product . Per exemple, TV , Computer , Phone . class TV extends Product { public float $size ; public string $technology ; } La paraula reservada extends Com pots veure, per a definir una classe que herete d'una altra, simplement has de utilitzar la paraula extends indicant la superclasse. Els nous objectes que s'instancien a partir de la subclasse s\u00f3n tamb\u00e9 objectes de la classe base; es pot comprovar utilitzant l'operador instanceof . $tv = new TV (); if ( $tv instanceof Product ) { // Aquest codi s'executa doncs la condici\u00f3 \u00e9s certa \u2026 } La nova classe hereta tots els atributs i m\u00e8todes p\u00fablics de la classe base, per\u00f2 no els privats. Si vols crear en la classe base un m\u00e8tode no visible a l'exterior (com els privats) que s'herete a les subclasses, has d'utilitzar la paraula protected en lloc de private . A m\u00e9s, pots redefinir el comportament dels m\u00e8todes existents en la classe base, simplement creant en la subclasse un nou m\u00e8tode amb el mateix nom. class TV extends Producte { public float $size ; public string $technology ; public function show () { print \"<p>\" . $this -> size . \" polzades</p>\" ; } } Bibliografia Jos\u00e9 Luis Comesa\u00f1a. Apuntes de formaci\u00f3n a distancia del m\u00f3dulo \u00abDesarrollo web en entorno servidor\u00bb del CFGS DAW, elaborados y licenciados por el Ministerio de Educaci\u00f3n, Cultura y Deporte. [en l\u00ednia]. 2012 [data de consulta: 13 de setembre de 2019]. Disponible en < https://github.com/statickidz/TemarioDAW/tree/master/DWES > Antonio L\u00f3pez. Learning PHP 7. Packt Publishing (29 de marzo de 2016). Janssen, Thorben. \u00abOOP Concept for Beginners: What Is Encapsulation\u00bb. Stackify, 7 gener 2022, https://stackify.com/oop-concept-for-beginners-what-is-encapsulation/ [data de consulta: 11 de setembre de 2022]. Janssen, Thorben. \u00abOOP Concept for Beginners: What Is Abstraction?\u00bb Stackify, 23 novembre 2017, https://stackify.com/oop-concept-abstraction/ [data de consulta: 11 de setembre de 2022].","title":"PHP OO B\u00e0sic"},{"location":"03-phpoo/0301-phpoo-basic/#poo-en-php-conceptes-basics","text":"","title":"POO en PHP. Conceptes b\u00e0sics"},{"location":"03-phpoo/0301-phpoo-basic/#introduccio","text":"La programaci\u00f3 orientada a objectes (OOP, per les seues sigles en angl\u00e8s) \u00e9s un paradigma de programaci\u00f3. Paradigma: Teoria [\u2026] el nucli central de la qual [\u2026] suministra la base i el model per resoldre problemes i avan\u00e7ar en el coneixement. Per la qual cosa podem definir la programaci\u00f3 orientada a objecte com un m\u00e8tode -provat i estudiat- el qual es basa en les interaccions d'objectes per resoldre les necessitats d'un sistema inform\u00e0tic. Un objecte \u00e9s una estructura que cont\u00e9 dades i el codi que els maneja. L'estructura dels objectes es defineix en les classes. En elles s'escriu el codi que defineix el comportament dels objectes i s'indiquen els membres que formaran part dels objectes d'aquesta classe. Entre els membres de una classe pot haver-hi: M\u00e8todes . S\u00f3n els membres de la classe que contenen el codi de la mateixa. Un m\u00e8tode \u00e9s com una funci\u00f3. Pot rebre par\u00e0metres i retornar valors. Atributs o propietats . Emmagatzemen informaci\u00f3 sobre el estat de l'objecte al que pertanyen (i per tant, el seu valor pot ser diferent per a cadascun dels objectes de la mateixa classe). A la creaci\u00f3 d'un objecte basat en una classe se li anomena instanciar una classe i a l'objecte obtingut tamb\u00e9 se li coneix com a inst\u00e0ncia d'aqueixa classe. Els pilars fonamentals de la POO s\u00f3n: Her\u00e8ncia . \u00c9s el proc\u00e9s de crear una classe a partir de una altra, heretant el seu comportament i caracter\u00edstiques i podent redefinir-los. Abstracci\u00f3 . L'objectiu principal es gestionar la complexitat ocultant detalls innecessaris a l'usuari. Aix\u00f2 li permet implementar l\u00f2gica m\u00e9s complexa sobre la base de la abstracci\u00f3 sense entendre o, incl\u00fas, sense pensar en tota la seua complexitat oculta. Polimorfisme . Un mateix m\u00e8tode pot tenir comportaments diferents en funci\u00f3 de l'objecte amb que s'utilitze. Encapsulaci\u00f3 . La idea \u00e9s mantindre en una mateix lloc (unitat de codi) les dades i el codi que els manipula. Aquest concepte tamb\u00e9 s'utilitza sovint per ocultar la representaci\u00f3 interna, o estat, d'un objecte des de l'exterior. Aix\u00f2 s'anomena ocultaci\u00f3 d'informaci\u00f3 . Els avantatges m\u00e9s importants que aporta la programaci\u00f3 orientada a objectes s\u00f3n: Modularitat . La POO permet dividir els programes en parts o m\u00f2duls m\u00e9s xicotets, que s\u00f3n independents uns d'uns altres per\u00f2 poden comunicar-se entre ells. Extensibilitat . Si es desitgen afegir noves caracter\u00edstiques a una aplicaci\u00f3, la POO facilita aquesta tasca de dues formes: afegint nous m\u00e8todes al codi, o creant nous objectes que estenguen el comportament dels ja existents. Manteniment . Els programes desenvolupats utilitzant POO s\u00f3n m\u00e9s senzills de mantenir, a causa de la modularitat abans comentada. Tamb\u00e9 ajuda seguir certes convencions en escriure'ls, per exemple, escriure cada classe en un fitxer propi. No ha d'haver-hi dues classes en un mateix fitxer, ni un altre codi a part del propi de la classe.","title":"Introducci\u00f3"},{"location":"03-phpoo/0301-phpoo-basic/#caracteristiques-basiques-de-lus-dobjectes-en-php","text":"Segurament tot, o la majoria del que acabes de veure, ja ho coneixies, i \u00e9s fins i tot probable que s\u00e0pigues utilitzar algun llenguatge de programaci\u00f3 orientat a objectes, aix\u00ed que anem a veure directament les peculiaritats pr\u00f2pies de PHP en el que fa refer\u00e8ncia a la POO. En PHP podemos utilitzar els dos paradigmes de la programaci\u00f3: estructurada i orientada a objectes. // utilitzant programaci\u00f3 estructurada $dwes = mysqli_connect ( 'localhost' , 'dwes' , 'abc123.' , 'dwes' ); // utilizant POO $dwes = new mysqli (); $dwes -> connect ( 'localhost' , 'dwes' , 'abc123.' , 'dwes' ); No obstant a\u00e7\u00f2, el llenguatge PHP original no es va dissenyar amb caracter\u00edstiques d'orientaci\u00f3 a objectes. Nom\u00e9s a partir de la versi\u00f3 3, es van comen\u00e7ar a introduir alguns trets de POO en el llenguatge. A\u00e7\u00f2 es va potenciar en la versi\u00f3 4, encara que encara de forma molt rudiment\u00e0ria. Per exemple, en PHP4: Els objectes es passen sempre per valor, no per refer\u00e8ncia. No es pot definir el nivell d'acc\u00e9s per als membres de la classe. Tots s\u00f3n p\u00fablics. No existeixen les interf\u00edcies. No existeixen m\u00e8todes destructors. En PHP5 es va reescriure i potenciar el suport d'orientaci\u00f3 a objectes del llenguatge, ampliant les seues caracter\u00edstiques i millorant el seu rendiment i el seu funcionament general. Les caracter\u00edstiques de POO que suporta PHP5 inclouen: M\u00e8todes est\u00e0tics. M\u00e8todes constructors i destructors. Her\u00e8ncia. Interf\u00edcies. Classes abstractes. Entre les caracter\u00edstiques que no inclou PHP5, i que pots con\u00e8ixer d'altres llenguatges de programaci\u00f3, estan: Her\u00e8ncia m\u00faltiple. Sobrec\u00e0rrega de m\u00e8todes (tenir diversos m\u00e8todes amb el mateix nom, per\u00f2 amb funcionalitats diferents. Els m\u00e8todes sobrecarregats han de tenir diferents par\u00e0metres. Quan es diu al m\u00e8tode, s'utilitza una o una altra versi\u00f3 en funci\u00f3 dels par\u00e0metres amb que es realitze la trucada (podent distingir per el seu nombre i per el seu tipus, segons el llenguatge de programaci\u00f3 utilitzat)) (inclosos els m\u00e8todes constructors). Sobrec\u00e0rrega d'operadors (similar a la sobrec\u00e0rrega de m\u00e8todes. Es poden definir diverses funcionalitats a un mateix operador, i s'utilitzar\u00e0 una o una altra en funci\u00f3 del tipus dels operands que s'usen en cada instant). PHP 7 incorpora millores en el rendiment i el tipat d'arguments, valors de retorn i atributs (des de la versi\u00f3 7.4) Quant a les novetats aportades per PHP 8 cal destacar: l'operador nullsafe , la propagaci\u00f3 de propietats en els constructors, la uni\u00f3 de tipus que permet definir tipus m\u00faltiples. Objectes sempre es passen per refer\u00e8ncia Els objectes que s'envien o reben com a par\u00e0metres sempre es passen per refer\u00e8ncia.","title":"Caracter\u00edstiques b\u00e0siques de l'\u00fas d'objectes en PHP"},{"location":"03-phpoo/0301-phpoo-basic/#definicio-de-classes","text":"La declaraci\u00f3 de una classe en PHP es fa utilitzant la paraula class . A continuaci\u00f3 i entre claus, han de figurar els membres de la classe. Conv\u00e9 fer-ho de forma ordenada, primer les propietats o atributs, i despr\u00e9s els m\u00e8todes, cadascun amb el seu codi respectiu. class Product { private string $code ; public string $name ; public float $price ; public function getSummaryLine () : string { return $this -> name ; } } En UML la classe anterior es representaria aix\u00ed: classDiagram class Product { -string code +string name +float price +string getSummaryLine() } Com coment\u00e0vem abans, \u00e9s preferible que cada classe figure en el seu propi fitxer ( Product.php ). A m\u00e9s, molts programadors prefereixen utilitzar per a les classes noms que comencen per lletra maj\u00fascula, per a, d'aquesta forma, distingir-los dels objectes i altres variables. Una vegada definida la classe, podem usar la paraula new per a instanciar objectes de la seg\u00fcent forma: $product = new Product (); Perqu\u00e8 la l\u00ednia anterior s'execute sense error, pr\u00e8viament hem d'haver declarat la classe. Per a a\u00e7\u00f2, en aqueix mateix fitxer haur\u00e0s de incloure la classe posant alguna cosa com: require ( 'Product.php' ); Els atributs de una classe s\u00f3n similars a les variables de PHP. \u00c9s possible indicar un valor en la declaraci\u00f3 de la classe. En aquest cas, tots els objectes que s'instancien a partir de aqueixa classe, partiran amb aqueix valor per defecte en l'atribut. Per a accedir des d'un objecte als seus atributs o als m\u00e8todes de la classe, has d'utilitzar l'operador fletxa (fixa't que nom\u00e9s es posa el s\u00edmbol $ davant del nom de l'objecte): $product -> name = 'Samsung Galaxy S' ; echo $product -> getSummaryLine ();","title":"Definici\u00f3 de classes"},{"location":"03-phpoo/0301-phpoo-basic/#visibilitat","text":"Quan es declara una propietat o un m\u00e8tode, s'ha d'indicar el seu nivell d'acc\u00e9s (o visibilitat). Els principals nivells s\u00f3n: public . Els atributs declarats com public poden utilitzar-se directament per els objectes de la classe. \u00c9s el cas de l'atribut $name anterior. private . Els atributs declarats com private nom\u00e9s poden ser accedits i modificats per els m\u00e8todes definits en la classe, no directament per els objectes de la mateixa. \u00c9s el cas de l'atribut $code . protected . Una propietat o m\u00e8tode protected sols pot ser accedida per la classe on es defineix o per un subclasse. No \u00e9s accessible des de fora. Un dels motius per a crear atributs privats \u00e9s que el seu valor forma part de la informaci\u00f3 interna de l'objecte i no ha de formar part de la seua interf\u00edcie (els punts de comunicaci\u00f3 amb altres objectes). Un altre motiu \u00e9s mantenir cert control sobre els seus possibles valors. Per exemple, si no vols que es puga canviar lliurement el valor del codi d'un producte. O necessites con\u00e8ixer quin ser\u00e0 el nou valor abans d'assignar-lo. En aquests casos, se solen definir aqueixos atributs com a privats i a m\u00e9s es creen dins de la classe m\u00e8todes per a permetre'ns obtenir i/o modificar els valors d'aqueixos atributs. Per exemple: private string $code ; public function setCode ( string $newCode ) : boolean { if ( ! existsCode ( $newCode )) { $this -> code = $newCode ; return true ; } return false ; } public function getCode () : string { return $this -> code ; } Encara que no \u00e9s obligatori, el nom del m\u00e8tode que ens permet obtenir el valor de un atribut sol comen\u00e7ar per get , i el que ens permet modificar-lo per set . Aquest m\u00e8todes solen anomenar-se getters i setters o accessors .","title":"Visibilitat"},{"location":"03-phpoo/0301-phpoo-basic/#constructor","text":"Com ja has vist, per a instanciar objectes d'una classe s'utilitza la paraula new : $product = new Product (); En PHP7 pots definir en les classes m\u00e8todes constructors, que s'executen quan es crea l'objecte. El constructor d'una classe ha d'anomenar-se __construct . Es poden utilitzar, per exemple, per assignar valors a atributs. class Product { private string $code ; public string $name ; public function __construct () { $this -> code = \"\" ; } \u2026 } El constructor d'una classe pot cridar a altres m\u00e8todes o tenir par\u00e0metres, en aquest cas hauran de passar-se quan es crea l'objecte. No obstant a\u00e7\u00f2, nom\u00e9s pot haver-hi un m\u00e8tode constructor en cada classe. class Product { private string $code ; public string $name ; public function __construct ( string $code ) { $this -> $code = $code ; } ... } $product = new Product ( 'GALAXYS' ); Si com en aquest exemple, definim un constructor en el qual cal passar el codi, sempre que instancies un nou objecte d'aqueixa classe haur\u00e0s d'indicar el seu codi. En PHP8 podem definir les propietats de la seg\u00fcent manera: class Product { public string $name ; public function __construct ( private string $code ) { } ... } D'aquest forma ens estalviem diverses l\u00ednies de codi.","title":"Constructor"},{"location":"03-phpoo/0301-phpoo-basic/#la-pseuodovariable-this","text":"Quan des d'un objecte s'invoca un m\u00e8tode de la classe, a aquest se li passa sempre una refer\u00e8ncia a l'objecte que ha fet la crida. Aquesta refer\u00e8ncia s'emmagatzema en la pseudovariable $this. S'utilitza, per exemple, en el codi anterior per a tenir acc\u00e9s als atributs privats de l'objecte (que nom\u00e9s s\u00f3n accessibles des dels m\u00e8todes de la classe). echo \" < p > \" . $this->code . \" </ p > \";","title":"La pseuodovariable $this"},{"location":"03-phpoo/0301-phpoo-basic/#constants-de-classe","text":"A m\u00e9s de m\u00e8todes i propietats, en una classe tamb\u00e9 es poden definir constants, utilitzant la paraula const . \u00c9s important que no confongues els atributs amb les constants. S\u00f3n conceptes diferents: les constants no poden canviar el seu valor (\u00f2bviament, d'ah\u00ed el seu nom), no usen el car\u00e0cter $ , s'escriuen en maj\u00fascules (per convenci\u00f3) i el seu valor est\u00e0 associat a la classe, \u00e9s a dir, no existeix una c\u00f2pia del mateix en cada objecte. Per tant, per a accedir a les constants d'una classe, s'ha d'utilitzar el nom de la classe i l'operador :: , anomenat operador de resoluci\u00f3 d'\u00e0mbit (que s'utilitza per a accedir a els elements de una classe). class DB { const USUARIO = 'dwes' ; ... } echo DB :: USUARIO ; \u00c9s important ressaltar que no \u00e9s necessari que existisca cap objecte de una classe per a poder accedir al valor de les constants que definisca. PHP-FIG El PHP Framework Interop Group \u00e9s un grup de treball on est\u00e0 involucrada gent que treballa en diferents frameworks amb l'objectiu de posar en com\u00fa les t\u00e8cniques que usen en els diferents projectes per poder integrar-les i compartir-les i poder treballar millor junts. Les recomanacions PSR-1 i PSR-12 s\u00f3n recomanacions sobre l'estil de programaci\u00f3 amb l'objectiu d'aplicar estandards comuns i aix\u00ed facilitar la lectura del codi realitzar per altres. Algunes recomancions que cal seguir: Les classes s'han de declarar en StudlyCaps . Per exemple: Product . Les constants de classes s'HAN DE declarar en maj\u00fascules i separats amb gui\u00f3 baix. Per exemple: const IMAGE_PATH . Sobre els noms de les propietats la \u00fanica recomanaci\u00f3 \u00e9s ser consistent. Aix\u00ed, PODEM usar $camelCase . La mateixa recomanaci\u00f3 aplicarem a les variables. Els m\u00e8todes S'HAN DE declarar en camelCase() . M\u00e9s informaci\u00f3 en Est\u00e1ndares","title":"Constants de classe"},{"location":"03-phpoo/0301-phpoo-basic/#utilitzacio-dobjectes","text":"Ja saps com instanciar un objecte utilitzant new , i com accedir a els seus m\u00e8todes i atributs p\u00fablics amb l'operador fletxa: $product = new Product (); $product -> name = 'Samsung Galaxy S' ; echo $product -> getSummaryLine (); Una vegada creat un objecte, pots utilitzar l'operador instanceof per a comprovar si \u00e9s o no una inst\u00e0ncia de una classe determinada. if ( $product instanceof Product ) { \u2026 } Des de PHP7, pots indicar en les funcions i m\u00e8todes de quina classe han de ser els objectes que es passen com a par\u00e0metres. Per a a\u00e7\u00f2, has d'especificar el tipus abans del par\u00e0metre. public function sellProduct ( Product $product ) { \u2026 } Si quan es realitza la crida, el par\u00e0metre no \u00e9s del tipus adequat, es produeix un error que podries capturar. Una caracter\u00edstica de la POO que has de tenir molt en compte \u00e9s qu\u00e8 succeeix amb els objectes quan els passes a una funci\u00f3, o simplement quan executes un codi com el seg\u00fcent: $product1 = new Product (); $product1 -> name = 'Samsung Galaxy S' ; $product2 = $product1 ; El codi anterior simplement crearia un nou identificador del mateix objecte. A\u00e7\u00f2 \u00e9s, quan s'utilitze qualsevol dels identificadors per a canviar el valor de algun atribut, aquest canvi es veuria tamb\u00e9 reflectit en accedir utilitzant l'altre identificador. Recorda que, encara que hi haja dos o m\u00e9s identificadors del mateix objecte, en realitat tots es refereixen a l'\u00fanica c\u00f2pia que s'emmagatzema del mateix.","title":"Utilitzaci\u00f3 d'objectes"},{"location":"03-phpoo/0301-phpoo-basic/#comparacio-dobjectes","text":"En utilitzar l'operador de comparaci\u00f3 ( == ), es comparen d'una manera senzilla les variables de cada objecte, \u00e9s a dir: dues inst\u00e0ncies d'un objecte s\u00f3n iguals si tenen els mateixos atributs i valors (els valors es comparen amb == ), i s\u00f3n inst\u00e0ncies de la mateixa classe. Quan s'utilitza l'operador identitat ( === ), les variables d'un objecte s\u00f3n id\u00e8ntiques si i nom\u00e9s s\u00ed fan refer\u00e8ncia a la mateixa inst\u00e0ncia de la mateixa classe.","title":"Comparaci\u00f3 d'Objectes"},{"location":"03-phpoo/0301-phpoo-basic/#herencia","text":"L'her\u00e8ncia \u00e9s un mecanisme de la POO que ens permet definir noves classes sobre la base d'una altra ja existent. Les noves classes que hereten tamb\u00e9 es coneixen amb el nom de subclasses. La classe de la qual hereten es diu classe base o superclasse. Per exemple, en la nostra tenda web anem a tenir productes de diferents tipus. En principi hem creat per a manejar-los una classe anomenada Product , amb alguns atributs i un m\u00e8tode que genera una eixida personalitzada en format HTML del codi. class Product { public string $code ; public string $name ; ... public function show () { echo \"<p>\" . $this -> code . \"</p>\" ; } } Aquesta classe \u00e9s molt \u00fatil si l'\u00fanica informaci\u00f3 que tenim dels diferents productes \u00e9s la que es mostra dalt. Per\u00f2, si vols personalitzar la informaci\u00f3 que vas a tractar de cada tipus de producte (i emmagatzemar, per exemple per als televisors, les polzades que tenen o la seua tecnologia de fabricaci\u00f3), pots crear noves classes que hereten de Product . Per exemple, TV , Computer , Phone . class TV extends Product { public float $size ; public string $technology ; }","title":"Her\u00e8ncia"},{"location":"03-phpoo/0301-phpoo-basic/#la-paraula-reservada-extends","text":"Com pots veure, per a definir una classe que herete d'una altra, simplement has de utilitzar la paraula extends indicant la superclasse. Els nous objectes que s'instancien a partir de la subclasse s\u00f3n tamb\u00e9 objectes de la classe base; es pot comprovar utilitzant l'operador instanceof . $tv = new TV (); if ( $tv instanceof Product ) { // Aquest codi s'executa doncs la condici\u00f3 \u00e9s certa \u2026 } La nova classe hereta tots els atributs i m\u00e8todes p\u00fablics de la classe base, per\u00f2 no els privats. Si vols crear en la classe base un m\u00e8tode no visible a l'exterior (com els privats) que s'herete a les subclasses, has d'utilitzar la paraula protected en lloc de private . A m\u00e9s, pots redefinir el comportament dels m\u00e8todes existents en la classe base, simplement creant en la subclasse un nou m\u00e8tode amb el mateix nom. class TV extends Producte { public float $size ; public string $technology ; public function show () { print \"<p>\" . $this -> size . \" polzades</p>\" ; } }","title":"La paraula reservada extends"},{"location":"03-phpoo/0301-phpoo-basic/#bibliografia","text":"Jos\u00e9 Luis Comesa\u00f1a. Apuntes de formaci\u00f3n a distancia del m\u00f3dulo \u00abDesarrollo web en entorno servidor\u00bb del CFGS DAW, elaborados y licenciados por el Ministerio de Educaci\u00f3n, Cultura y Deporte. [en l\u00ednia]. 2012 [data de consulta: 13 de setembre de 2019]. Disponible en < https://github.com/statickidz/TemarioDAW/tree/master/DWES > Antonio L\u00f3pez. Learning PHP 7. Packt Publishing (29 de marzo de 2016). Janssen, Thorben. \u00abOOP Concept for Beginners: What Is Encapsulation\u00bb. Stackify, 7 gener 2022, https://stackify.com/oop-concept-for-beginners-what-is-encapsulation/ [data de consulta: 11 de setembre de 2022]. Janssen, Thorben. \u00abOOP Concept for Beginners: What Is Abstraction?\u00bb Stackify, 23 novembre 2017, https://stackify.com/oop-concept-abstraction/ [data de consulta: 11 de setembre de 2022].","title":"Bibliografia"},{"location":"03-phpoo/0302-phpoo-advanced/","text":"PPO en PHP. Conceptes avan\u00e7ants M\u00e8todes i propietats est\u00e0tiques Els m\u00e8todes i propietats est\u00e0tics (o de classe) s\u00f3n aquells accessibles directament des de la classe, sense necessitat d'inst\u00e0nciar-la. Es declaren amb la paraula reservada static i s'accedeix a ells amb l'operador d'\u00e0mbit :: . Si volem accedir a un m\u00e8tode est\u00e0tic, es posa davant el nom de la classe: Product :: newProduct () . Si des d'un m\u00e8tode volem accedir a una propietat est\u00e0tica de la mateixa classe, s'utilitza la referencia self : self::$numberOfProducts class Product { const IVA = 0.23 ; private static $numberOfProducts = 0 ; public static function newProducts () { self :: $numberOfProducts ++ ; } } Product :: newProducts (); $tax = Product :: IVA ; Tamb\u00e9 podem tindre classes normals que tinguen alguna propietat est\u00e0tica: class Product { const IVA = 0.23 ; private static int $numberOfProducts = 0 ; private string $code ; public function __construct ( string $code ) { self :: $numOfProducts ++ ; $this -> code = $code ; } public function getSummaryLine () : string { return \"El producte \" . $this -> code . \" \u00e9s el n\u00famero \" . self :: $numOfProducts ; } } $prod1 = new Product ( \"PS5\" ); $prod2 = new Product ( \"XBOX Series X\" ); $prod3 = new Product ( \"Nintendo Switch\" ); echo $prod3 -> getSummaryLine (); Classes abstractes Les classes abstractes s\u00f3n classes que no es poden instanciar, per la qual cosa actuaran de superclasse i ser\u00e0 obligatori crear subclasses per a fer \u00fas d'ella. \u00c9s a dir, una classe amb el modificador abstract no pot tenir objectes que la instancien, per\u00f2 s\u00ed podr\u00e0 utilitzar-se de classe base i les seues subclasses s\u00ed podran utilitzar-se per a instanciar objectes. abstract class Product { ... } M\u00e8todes abstractes Un m\u00e8tode en el qual s'indique abstract , ha de ser redefinit obligat\u00f2riament per les subclasses, i no podr\u00e0 contenir codi. class Product { \u2026 abstract public function show (); } Anem a fer una petita modificaci\u00f3 en la nostra classe Product . Per a facilitar la creaci\u00f3 de nous objectes, crearem un constructor al que se li passar\u00e0 un array amb els valors dels atributs del nou producte. class Product { public $code ; public $name ; public $shortName ; public $price ; public function show () : void { echo \"<p>\" . $this -> code . \"</p>\" ; } public function __construct ( $row ) { $this -> code = $row [ 'code' ]; $this -> name = $row [ 'name' ]; $this -> shortName = $row [ 'short_name' ]; $this -> price = $row [ 'price' ]; } } Questi\u00f3 Qu\u00e8 passa ara amb la classe TV , qu\u00e8 hereta de Product ? Quan crees un nou objecte d'aqueixa classe, es cridar\u00e0 al constructor de Product? Pots crear un nou constructor espec\u00edfic perqu\u00e8 redefinisca el comportament de la classe base? Comen\u00e7ant per aquesta \u00faltima pregunta, \u00f2bviament pots definir un nou constructor per a les classes heretades que redefinisquen el comportament del que existeix en la classe base, tal com faries amb qualsevol altre m\u00e8tode. I depenent de si programes o no el constructor en la classe heretada, es cridar\u00e0 o no autom\u00e0ticament al constructor de la classe base. En PHP5+, si la classe heretada no t\u00e9 constructor propi, es cridar\u00e0 autom\u00e0ticament al constructor de la classe base (si existeix). No obstant a\u00e7\u00f2, si la classe heretada defineix el seu propi constructor, haur\u00e0s de ser tu el que realitze la crida al constructor de la classe base si ho consideres necessari, utilitzant per a a\u00e7\u00f2 la paraula parent i l'operador de resoluci\u00f3 d'\u00e0mbit. class TV extends Product { public $size ; public $technology ; public function show () { print \"<p>\" . $this -> size . \" polzades</p>\" ; } public function __construct ( $row ) { parent :: __construct ( $row ); $this -> size = $row [ 'size' ]; $this -> technology = $row [ 'technology' ]; } } Ja has vist amb amb anterioritat com s'utilitzava la paraula clau self per a tenir acc\u00e9s a la classe actual. La paraula parent \u00e9s semblant. En utilitzar parent fas refer\u00e8ncia a la classe base de la actual, tal com apareix rere extends . Interf\u00edcies Un interf\u00edcie ( interface ) \u00e9s com una classe buida que solament cont\u00e9 declaracions de m\u00e8todes. Es defineixen utilitzant la paraula interface . Per exemple, abans vam veure que pod\u00edem crear noves classes heretades de Product , com TV o Ordinador . Tamb\u00e9 vam veure que en les subclasses podies redefinir el comportament del m\u00e8tode perqu\u00e8 generara una eixida en HTML diferent per a cada tipus de producte. Si vols assegurar-te que tots els tipus de productes tinguen un m\u00e8tode show , pots crear un interface com el seg\u00fcent. interface IShow { public function show () : Void ; } I quan crees les subclasses haur\u00e0s d'indicar amb la paraula implements que han de implementar els m\u00e8todes declarats en aquest interface. class TV extends Product implements IShow { \u2026 public function show () { echo \"<p>\" . $this -> size . \" polzades</p>\" ; } \u2026 } Tots els m\u00e8todes que es declaren en un interface han de ser p\u00fablics. A m\u00e9s de m\u00e8todes, els interf\u00edcies podran contenir constants per\u00f2 no atributs. Un interface \u00e9s com un contracte que la classe ha de complir. En implementar tots els m\u00e8todes declarats en la interf\u00edcie s'assegura la interoperabilitat entre classes. Si saps que una classe implementa un interf\u00edcie determinada saps quins noms tenen els seus m\u00e8todes, quins par\u00e0metres els has de passar i, probablement, podr\u00e0s esbrinar f\u00e0cilment amb quins objectiu han sigut escrits. Per exemple, en la llibreria de PHP est\u00e0 definit la interf\u00edcie countable . Countable { abstract public int count ( void ) } Si crees una classe per a la cistella de la compra en la tenda web, podries implementar aquesta interf\u00edcie per a contar els productes que figuren en la mateixa. Abans vas aprendre que en PHP5 una classe nom\u00e9s pot heretar d'una altra. En PHP5 no existeix l'her\u00e8ncia m\u00faltiple. No obstant a\u00e7\u00f2, s\u00ed \u00e9s possible crear classes que implementen diverses interf\u00edcies, simplement separant la llista d'interf\u00edcies per comes despr\u00e9s de la paraula implements . class TV extends Product implements IShow , Countable { \u2026 } L'\u00fanica restricci\u00f3 \u00e9s que els noms dels m\u00e8todes que s'hagen d'implementar en els diferents interf\u00edcies no coincidisquen. \u00c9s a dir, en el nostre exemple, la interf\u00edcie IShow no podria contenir el m\u00e8tode count , doncs aquest ja est\u00e0 declarat en Countable . Des de PHP7 tamb\u00e9 es poden crear nous interf\u00edcies heretant d'uns altres ja existents. Es fa de la mateixa forma que amb les classes, utilitzant la paraula extends . Classes abstractes vs interf\u00edcies Un dels dubtes m\u00e9s comuns en POO, \u00e9s quina soluci\u00f3 adoptar en algunes situacions: interf\u00edcies o classes abstractes. Ambdues permeten definir regles per a les classes que els implementen o hereten respectivament. I cap permet instanciar objectes. Les difer\u00e8ncies principals entre ambdues opcions s\u00f3n: En les classes abstractes, els m\u00e8todes poden contenir codi. Si van a existir diverses subclasses amb un comportament com\u00fa, es podria programar en els m\u00e8todes de la classe abstracta. Si s'opta per un interface, caldria repetir el codi en totes les classes que ho implemente. Les classes abstractes poden contenir atributs, i les interf\u00edcies no. No es pot crear una classe que herete de dues classes abstractes, per\u00f2 s\u00ed es pot crear una classe que implemente diverses interf\u00edcies. Per exemple, en la botiga online va a haver-hi dos tipus d'usuaris: clients i empleats. Si necessites crear en la teua aplicaci\u00f3 objectes de tipus Usuari (per exemple, per a manejar de forma conjunta als clients i als empleats), hauries de crear una classe no abstracta amb aqueix nom, de la qual heretarien Client i Empleat. Podeu llegir tamb\u00e9 l'article Clases abastractas e interfaces en PHP class Usuari { ... } class Client extends Usuari { ... } class Empleat extends Usuari { ... } Per\u00f2 si no f\u00f3ra aix\u00ed, hauries de decidir si crees o no Usuari , i si ho faries com una classe abstracta o com una interf\u00edcie. Si per exemple, volgueres definir en un \u00fanic lloc els atributs comuns a Client i a Empleat, hauries de crear una classe abstracta Usuari de la qual hereten. abstract class Usuari { public string $dni ; protected string $nom ; ... } Per\u00f2 a\u00e7\u00f2 no podries fer-ho si ja tens planificada alguna relaci\u00f3 d'her\u00e8ncia per a una d'aquestes dues classes. Per a finalitzar amb les interf\u00edcies, a la llista de funcions de PHP relacionades amb la POO pots afegir les seg\u00fcents. Funci\u00f3 Exemple Significat get_declared_interf\u00edcies print_r (get_declared_interf\u00edcies()); Retorna un array amb els noms dels interf\u00edcies declarats. interface_exists if (interface_exists('iShow') Retorna true si existeix l'interface que s'indica, o false en cas contrari. Trets (Traits) Des de la seva versi\u00f3 5.4.0, PHP implementa una metodologia de reutilitzaci\u00f3 de codi anomenada Traits . Els trets (\u00abtraits\u00bb en angl\u00e8s) s\u00f3n un mecanisme de reutilitzaci\u00f3 de codi en llenguatges d'her\u00e8ncia simple, com PHP. L'objectiu d'un tret \u00e9s el de reduir les limitacions pr\u00f2pies de l'her\u00e8ncia simple permetent que els desenvolupadors reutilitzen a voluntat conjunts de m\u00e8todes sobre diverses classes independents i pertanyents a classes jer\u00e0rquiques diferents. Un Trait \u00e9s similar a una classe, per\u00f2 amb l'\u00fanic objectiu d'agrupar funcionalitats molt espec\u00edfiques i d'una manera coherent. No es pot instanciar directament un Trait . \u00c9s per tant un afegit a l'her\u00e8ncia tradicional, i habilita la composici\u00f3 horitzontal de comportaments; \u00e9s a dir, permet combinar membres de classes sense haver d'usar her\u00e8ncia. trait Saludar { function decirHola (){ return \"hola\" ; } } trait Despedir { function decirAdios (){ return \"adi\u00f3s\" ; } } class Comunicacion { use Saludar , Despedir ; } $comunicacion = new Comunicacion ; echo $comunicacion -> decirHola () . \", que tal. \" . $comunicacion -> decirAdios (); En l'exemple anterior la classe Comunicacion necessita reutilitzar els m\u00e8todes Saludar::decirHola() i Despedir::decirAdios() com que en PHP no hi ha her\u00e8ncia m\u00faltiple mitjan\u00e7ant els trait es pot aconseguir reutilitzar-les. Clonaci\u00f3 d'Objectes Per crear una c\u00f2pia d'un objecte s'utilitza la paraula clau clone (que invoca, si fos possible, al m\u00e8tode __clone() de l'objecte). No es pot cridar el m\u00e8tode __clone() d'un objecte directament. $copia_objecte = clone $objecte ; Quan es clona un objecte, PHP7 dur\u00e0 a terme una c\u00f2pia superficial de les propietats de l'objecte. Les propietats que siguen refer\u00e8ncies a altres variables (per exemple, objectes), mantindran les refer\u00e8ncies. Compte: si els atributs s\u00f3n objectes no es clonaran. Classes i m\u00e8todes finals Existeix una forma d'evitar que les classes heretades puguen redefinir el comportament dels m\u00e8todes existents en la superclasse: utilitzar la paraula final . Si en el nostre exemple hagu\u00e9rem fet: class Product { public string $code ; public string $name ; public float $price ; public final function show () { print \"<p>\" . $this -> code . \"</p>\" ; } } En aquest cas el m\u00e8tode show no podria redefinir-se en la classe TV . Tamb\u00e9 es pot declarar una classe utilitzant final . En aquest cas no podran crear-se classes heretades utilitzant-les com a base. final class Product { ... } M\u00e8todes m\u00e0gics Totes les classes PHP ofereixen un conjunt de m\u00e8todes, tamb\u00e9 coneguts com a m\u00e8todes m\u00e0gics que es poden sobreescriure per substituir el seu comportament. Alguns d\u2019ells ja els han utilitzat. Davant de qualsevol dubte, \u00e9s convenient consultar la documentaci\u00f3 oficial . Els m\u00e9s destacables s\u00f3n: __construct() __destruct () \u2192 S'invoca en perdre la refer\u00e8ncia. S'utilitza per tancar una connexi\u00f3 amb una base de dades, tancar un fitxer, etc. __toString () \u2192 representaci\u00f3 de l'objecte com a cadena __get(propietat) , __set(propietat, valor) \u2192 permetria l'acc\u00e9s a la propietat privada, tot i que sempre \u00e9s m\u00e9s llegible/mantenible codificar el getter/setter . __isset(propietat) , __unset (propietat) \u2192 us permet esbrinar o eliminar el valor d'una propietat. __sleep() , __wakeup () \u2192 S'executen quan es recuperen ( Unserialize ) o emmagatzemen un objecte serialitzat ( serialitze ), i s'utilitzen per definir quines propietats estan serialitzades. __call () , __callstatic () \u2192 s'executen cridant a un m\u00e8tode que no siga p\u00fablic. Permeten m\u00e8todes de sobrec\u00e0rrega. Espai de noms Des de PHP 5.3 permeten organitzar classes/interf\u00edcies, funcions o constant de manera similar als paquets java . Recomanaci\u00f3 Crea un espai de nom \u00fanic per fitxer i creeu una estructura de directoris respecte als nivells/subnivells (com es fa a java ) Es declara a la primera l\u00ednia per la paraula clau namespace seguit del nom de l'espai de nom assignat (cada subnivell est\u00e0 separat amb la barra invertida \\ ): Per exemple, per col\u00b7locar la classe Product dins de l'espai de noms Dwes\\Examples far\u00edem: <? php namespace Dwes\\Examples ; const IVA = 0.21 ; class Product { public string $name ; public function show () : void { echo \"<p> prod:\" . $ this -> name . \"</p>\" ; } } Acc\u00e9s Per fer refer\u00e8ncia a un recurs que cont\u00e9 un espai de noms, primer cal tenir -lo disponible mitjan\u00e7ant include o require . Si el recurs es troba al mateix espai de noms, es fa un acc\u00e9s directe (es coneix com a acc\u00e9s sense qualificar). Hi ha realment tres tipus d\u2019acc\u00e9s: Sense qualificar: recurs Qualificat: \\rutaRelativa\\recurs . No cal posar l'espai de noms complet. Totalment qualificat: \\rutaAbsoluta\\recurs <? php namespace Dwes\\Examples ; include_once ( \"Product.php\" ); echo IVA ; // sin cualificar echo Utils\\IVA ; // acceso cualificado. Dar\u00eda error, no existe \\Dwes\\Exemples\\Utilitats\\IVA echo \\Dwes\\Exemples\\IVA ; // totalmente cualificado $p1 = new Product (); // lo busca en el mismo namespace y encuentra \\Dwes\\Ejemplos\\Producto $p2 = new Model\\Product (); // dar\u00eda error, no existe el namespace Model. Est\u00e1 buscando \\Dwes\\Ejemplos\\Model\\Producto $p3 = new \\Dwes\\Examples\\Product (); // \\Dwes\\Ejemplos\\Producto Per a evitar la refer\u00e8ncia qualificada podem declarar l'\u00fas mitjan\u00e7ant use (similar a fer un import en Java ). Es faria en la cap\u00e7alera, despr\u00e9s del namespace : Els tipus possibles s\u00f3n: use const nomQualificatConstant use function nomQualificatFuncio use nomQualificatClasse use nomQualificatClase as Alias // per a canviar de nom elements Per exemple, si volem utilitzar la classe \\Dwes\\Examples\\Product des d'un recurs que es trobe en l'arrel, per exemple en index.php , far\u00edem: <? php include_once ( \"Dwes\\Examples\\Product.php\" ); use const Dwes\\Exemples\\IVA ; use \\Dwes\\Exemples\\Product ; echo IVA ; $p1 = new Product (); To use or not to use En resum, use permit acceder sense haver de qualificar-los a recursos que es troben en un altre namespace . Si estem en el mateix espai de noms, no necesitem usar use . Organitzaci\u00f3 Cada projecte, a mesura que creix, ha d\u2019organitzar el seu codi font. Es planteja una organitzaci\u00f3 en qu\u00e8 els fitxers que interaccionen amb el navegador es col\u00b7loquen a l\u2019arrel i les classes que definim entra dins d\u2019un namespace . Organitzaci\u00f3, includes i uses Posarem cada recurs en un fitxer independent. A la primera l\u00ednia indicarem el seu namespace (si no est\u00e0 a l'arrel). Si utilitzem altres recursos, farem un include_once d'aquests recursos (classes, interf\u00edcies, etc ...). Cada recurs ha d\u2019incloure tots els altres recursos a qu\u00e8 fa\u00e7a refer\u00e8ncia: la classe dels quals hereta, interf\u00edcies que implementen, les classes utilitzades/rebudes com a par\u00e0metres, etc. Si els recursos es troben en un espai de noms diferents dels que som, utilitzarem use amb la ruta completa i, a continuaci\u00f3, l'utilitzarem sense refer\u00e8ncies qualificades. Autoload No \u00e9s tedi\u00f3s haver de fer els require de les classes? La funcionalitat autoload arriba al rescat. Aix\u00ed, aquesta funcionalitat permet que les classes que s\u2019utilitzaran es carreguen autom\u00e0ticament i eviten haver de fer el include_once de cadascuna d'elles. Per fer-ho s'utilitza la funci\u00f3 spl_autoload_register <? php spl_autoload_register ( function ( $nombreClase ) { include_once $nombreClase . '.php' ; } ); ?> \u00bfPer qu\u00e8 s'anomena autoload ? Perqu\u00e8 abans es realitzaba mitjan\u00e7ant el m\u00e8tode m\u00e0gic __autoload() , el qual est\u00e0 deprecated des de PHP 7.2 I com organitzem ara el codi per aprofitar-nos de la c\u00e0rrega autom\u00e0tica? Per facilitar la cerca dels recursos per incloure, \u00e9s recomanable posar totes les classes de la mateixa carpeta. Les situarem dins de src (no \u00e9s obligatori, \u00e9s la convenci\u00f3 que seguirem). Altres directoris que podem crear s\u00f3n test per fer les proves phpunit que despr\u00e9s realitzarem, o la carpeta del views on s\u2019emmagatzemaran les vistes del projecte. Com que hem col\u00b7locat tots els nostres recursos dins de src , ara el nostre autoload.php (que col\u00b7loquem al directori arrel) nom\u00e9s mirar\u00e0 dins d\u2019aquest directori: <? php spl_autoload_register ( function ( $className ) { include_once \"src/\" . $className . '.php' ; } ); ?> Autoload i rutes err\u00f2nies A Ubuntu, quan fa la classe que rep com a par\u00e0metre, les barres de l\u2019espai de noms ( \\ ) s\u00f3n diferents de les de les rutes ( / ).Per tant, utilitzem millor aquesta implementaci\u00f3 del fitxer autoload.php : <? php spl_ <? php spl_autoload_register ( function ( $className ) { $ruta = \"src \\\\ \" . $className . '.php' ; $ruta = str_replace ( \" \\\\ \" , \"/\" , $ruta ); // Sustituimos las barras include_once $ruta ; } ); Bibliografia Jos\u00e9 Luis Comesa\u00f1a. Apuntes de formaci\u00f3n a distancia del m\u00f3dulo \u00abDesarrollo web en entorno servidor\u00bb del CFGS DAW, elaborados y licenciados por el Ministerio de Educaci\u00f3n, Cultura y Deporte. [en l\u00ednia]. 2012 [data de consulta: 13 de setembre de 2019]. Disponible en \\< https://github.com/statickidz/TemarioDAW/tree/master/DWES > Antonio L\u00f3pez. Learning PHP 7. Packt Publishing (29 de marzo de 2016). Medrano, Aitor, i Luis Alema\u00f1. \u00ab3.- PHP Orientado a Objetos - Desarrollo Web en Entorno Servidor\u00bb. Desarrollo Web en Entorno Servidor, https://aitor-medrano.github.io/dwes2122/03phpoo.html . Consulta 15 octubre 2022.","title":"PHP OO Avan\u00e7at"},{"location":"03-phpoo/0302-phpoo-advanced/#ppo-en-php-conceptes-avancants","text":"","title":"PPO en PHP. Conceptes avan\u00e7ants"},{"location":"03-phpoo/0302-phpoo-advanced/#metodes-i-propietats-estatiques","text":"Els m\u00e8todes i propietats est\u00e0tics (o de classe) s\u00f3n aquells accessibles directament des de la classe, sense necessitat d'inst\u00e0nciar-la. Es declaren amb la paraula reservada static i s'accedeix a ells amb l'operador d'\u00e0mbit :: . Si volem accedir a un m\u00e8tode est\u00e0tic, es posa davant el nom de la classe: Product :: newProduct () . Si des d'un m\u00e8tode volem accedir a una propietat est\u00e0tica de la mateixa classe, s'utilitza la referencia self : self::$numberOfProducts class Product { const IVA = 0.23 ; private static $numberOfProducts = 0 ; public static function newProducts () { self :: $numberOfProducts ++ ; } } Product :: newProducts (); $tax = Product :: IVA ; Tamb\u00e9 podem tindre classes normals que tinguen alguna propietat est\u00e0tica: class Product { const IVA = 0.23 ; private static int $numberOfProducts = 0 ; private string $code ; public function __construct ( string $code ) { self :: $numOfProducts ++ ; $this -> code = $code ; } public function getSummaryLine () : string { return \"El producte \" . $this -> code . \" \u00e9s el n\u00famero \" . self :: $numOfProducts ; } } $prod1 = new Product ( \"PS5\" ); $prod2 = new Product ( \"XBOX Series X\" ); $prod3 = new Product ( \"Nintendo Switch\" ); echo $prod3 -> getSummaryLine ();","title":"M\u00e8todes i propietats est\u00e0tiques"},{"location":"03-phpoo/0302-phpoo-advanced/#classes-abstractes","text":"Les classes abstractes s\u00f3n classes que no es poden instanciar, per la qual cosa actuaran de superclasse i ser\u00e0 obligatori crear subclasses per a fer \u00fas d'ella. \u00c9s a dir, una classe amb el modificador abstract no pot tenir objectes que la instancien, per\u00f2 s\u00ed podr\u00e0 utilitzar-se de classe base i les seues subclasses s\u00ed podran utilitzar-se per a instanciar objectes. abstract class Product { ... }","title":"Classes abstractes"},{"location":"03-phpoo/0302-phpoo-advanced/#metodes-abstractes","text":"Un m\u00e8tode en el qual s'indique abstract , ha de ser redefinit obligat\u00f2riament per les subclasses, i no podr\u00e0 contenir codi. class Product { \u2026 abstract public function show (); } Anem a fer una petita modificaci\u00f3 en la nostra classe Product . Per a facilitar la creaci\u00f3 de nous objectes, crearem un constructor al que se li passar\u00e0 un array amb els valors dels atributs del nou producte. class Product { public $code ; public $name ; public $shortName ; public $price ; public function show () : void { echo \"<p>\" . $this -> code . \"</p>\" ; } public function __construct ( $row ) { $this -> code = $row [ 'code' ]; $this -> name = $row [ 'name' ]; $this -> shortName = $row [ 'short_name' ]; $this -> price = $row [ 'price' ]; } } Questi\u00f3 Qu\u00e8 passa ara amb la classe TV , qu\u00e8 hereta de Product ? Quan crees un nou objecte d'aqueixa classe, es cridar\u00e0 al constructor de Product? Pots crear un nou constructor espec\u00edfic perqu\u00e8 redefinisca el comportament de la classe base? Comen\u00e7ant per aquesta \u00faltima pregunta, \u00f2bviament pots definir un nou constructor per a les classes heretades que redefinisquen el comportament del que existeix en la classe base, tal com faries amb qualsevol altre m\u00e8tode. I depenent de si programes o no el constructor en la classe heretada, es cridar\u00e0 o no autom\u00e0ticament al constructor de la classe base. En PHP5+, si la classe heretada no t\u00e9 constructor propi, es cridar\u00e0 autom\u00e0ticament al constructor de la classe base (si existeix). No obstant a\u00e7\u00f2, si la classe heretada defineix el seu propi constructor, haur\u00e0s de ser tu el que realitze la crida al constructor de la classe base si ho consideres necessari, utilitzant per a a\u00e7\u00f2 la paraula parent i l'operador de resoluci\u00f3 d'\u00e0mbit. class TV extends Product { public $size ; public $technology ; public function show () { print \"<p>\" . $this -> size . \" polzades</p>\" ; } public function __construct ( $row ) { parent :: __construct ( $row ); $this -> size = $row [ 'size' ]; $this -> technology = $row [ 'technology' ]; } } Ja has vist amb amb anterioritat com s'utilitzava la paraula clau self per a tenir acc\u00e9s a la classe actual. La paraula parent \u00e9s semblant. En utilitzar parent fas refer\u00e8ncia a la classe base de la actual, tal com apareix rere extends .","title":"M\u00e8todes abstractes"},{"location":"03-phpoo/0302-phpoo-advanced/#interficies","text":"Un interf\u00edcie ( interface ) \u00e9s com una classe buida que solament cont\u00e9 declaracions de m\u00e8todes. Es defineixen utilitzant la paraula interface . Per exemple, abans vam veure que pod\u00edem crear noves classes heretades de Product , com TV o Ordinador . Tamb\u00e9 vam veure que en les subclasses podies redefinir el comportament del m\u00e8tode perqu\u00e8 generara una eixida en HTML diferent per a cada tipus de producte. Si vols assegurar-te que tots els tipus de productes tinguen un m\u00e8tode show , pots crear un interface com el seg\u00fcent. interface IShow { public function show () : Void ; } I quan crees les subclasses haur\u00e0s d'indicar amb la paraula implements que han de implementar els m\u00e8todes declarats en aquest interface. class TV extends Product implements IShow { \u2026 public function show () { echo \"<p>\" . $this -> size . \" polzades</p>\" ; } \u2026 } Tots els m\u00e8todes que es declaren en un interface han de ser p\u00fablics. A m\u00e9s de m\u00e8todes, els interf\u00edcies podran contenir constants per\u00f2 no atributs. Un interface \u00e9s com un contracte que la classe ha de complir. En implementar tots els m\u00e8todes declarats en la interf\u00edcie s'assegura la interoperabilitat entre classes. Si saps que una classe implementa un interf\u00edcie determinada saps quins noms tenen els seus m\u00e8todes, quins par\u00e0metres els has de passar i, probablement, podr\u00e0s esbrinar f\u00e0cilment amb quins objectiu han sigut escrits. Per exemple, en la llibreria de PHP est\u00e0 definit la interf\u00edcie countable . Countable { abstract public int count ( void ) } Si crees una classe per a la cistella de la compra en la tenda web, podries implementar aquesta interf\u00edcie per a contar els productes que figuren en la mateixa. Abans vas aprendre que en PHP5 una classe nom\u00e9s pot heretar d'una altra. En PHP5 no existeix l'her\u00e8ncia m\u00faltiple. No obstant a\u00e7\u00f2, s\u00ed \u00e9s possible crear classes que implementen diverses interf\u00edcies, simplement separant la llista d'interf\u00edcies per comes despr\u00e9s de la paraula implements . class TV extends Product implements IShow , Countable { \u2026 } L'\u00fanica restricci\u00f3 \u00e9s que els noms dels m\u00e8todes que s'hagen d'implementar en els diferents interf\u00edcies no coincidisquen. \u00c9s a dir, en el nostre exemple, la interf\u00edcie IShow no podria contenir el m\u00e8tode count , doncs aquest ja est\u00e0 declarat en Countable . Des de PHP7 tamb\u00e9 es poden crear nous interf\u00edcies heretant d'uns altres ja existents. Es fa de la mateixa forma que amb les classes, utilitzant la paraula extends .","title":"Interf\u00edcies"},{"location":"03-phpoo/0302-phpoo-advanced/#classes-abstractes-vs-interficies","text":"Un dels dubtes m\u00e9s comuns en POO, \u00e9s quina soluci\u00f3 adoptar en algunes situacions: interf\u00edcies o classes abstractes. Ambdues permeten definir regles per a les classes que els implementen o hereten respectivament. I cap permet instanciar objectes. Les difer\u00e8ncies principals entre ambdues opcions s\u00f3n: En les classes abstractes, els m\u00e8todes poden contenir codi. Si van a existir diverses subclasses amb un comportament com\u00fa, es podria programar en els m\u00e8todes de la classe abstracta. Si s'opta per un interface, caldria repetir el codi en totes les classes que ho implemente. Les classes abstractes poden contenir atributs, i les interf\u00edcies no. No es pot crear una classe que herete de dues classes abstractes, per\u00f2 s\u00ed es pot crear una classe que implemente diverses interf\u00edcies. Per exemple, en la botiga online va a haver-hi dos tipus d'usuaris: clients i empleats. Si necessites crear en la teua aplicaci\u00f3 objectes de tipus Usuari (per exemple, per a manejar de forma conjunta als clients i als empleats), hauries de crear una classe no abstracta amb aqueix nom, de la qual heretarien Client i Empleat. Podeu llegir tamb\u00e9 l'article Clases abastractas e interfaces en PHP class Usuari { ... } class Client extends Usuari { ... } class Empleat extends Usuari { ... } Per\u00f2 si no f\u00f3ra aix\u00ed, hauries de decidir si crees o no Usuari , i si ho faries com una classe abstracta o com una interf\u00edcie. Si per exemple, volgueres definir en un \u00fanic lloc els atributs comuns a Client i a Empleat, hauries de crear una classe abstracta Usuari de la qual hereten. abstract class Usuari { public string $dni ; protected string $nom ; ... } Per\u00f2 a\u00e7\u00f2 no podries fer-ho si ja tens planificada alguna relaci\u00f3 d'her\u00e8ncia per a una d'aquestes dues classes. Per a finalitzar amb les interf\u00edcies, a la llista de funcions de PHP relacionades amb la POO pots afegir les seg\u00fcents. Funci\u00f3 Exemple Significat get_declared_interf\u00edcies print_r (get_declared_interf\u00edcies()); Retorna un array amb els noms dels interf\u00edcies declarats. interface_exists if (interface_exists('iShow') Retorna true si existeix l'interface que s'indica, o false en cas contrari.","title":"Classes abstractes vs interf\u00edcies"},{"location":"03-phpoo/0302-phpoo-advanced/#trets-traits","text":"Des de la seva versi\u00f3 5.4.0, PHP implementa una metodologia de reutilitzaci\u00f3 de codi anomenada Traits . Els trets (\u00abtraits\u00bb en angl\u00e8s) s\u00f3n un mecanisme de reutilitzaci\u00f3 de codi en llenguatges d'her\u00e8ncia simple, com PHP. L'objectiu d'un tret \u00e9s el de reduir les limitacions pr\u00f2pies de l'her\u00e8ncia simple permetent que els desenvolupadors reutilitzen a voluntat conjunts de m\u00e8todes sobre diverses classes independents i pertanyents a classes jer\u00e0rquiques diferents. Un Trait \u00e9s similar a una classe, per\u00f2 amb l'\u00fanic objectiu d'agrupar funcionalitats molt espec\u00edfiques i d'una manera coherent. No es pot instanciar directament un Trait . \u00c9s per tant un afegit a l'her\u00e8ncia tradicional, i habilita la composici\u00f3 horitzontal de comportaments; \u00e9s a dir, permet combinar membres de classes sense haver d'usar her\u00e8ncia. trait Saludar { function decirHola (){ return \"hola\" ; } } trait Despedir { function decirAdios (){ return \"adi\u00f3s\" ; } } class Comunicacion { use Saludar , Despedir ; } $comunicacion = new Comunicacion ; echo $comunicacion -> decirHola () . \", que tal. \" . $comunicacion -> decirAdios (); En l'exemple anterior la classe Comunicacion necessita reutilitzar els m\u00e8todes Saludar::decirHola() i Despedir::decirAdios() com que en PHP no hi ha her\u00e8ncia m\u00faltiple mitjan\u00e7ant els trait es pot aconseguir reutilitzar-les.","title":"Trets (Traits)"},{"location":"03-phpoo/0302-phpoo-advanced/#clonacio-dobjectes","text":"Per crear una c\u00f2pia d'un objecte s'utilitza la paraula clau clone (que invoca, si fos possible, al m\u00e8tode __clone() de l'objecte). No es pot cridar el m\u00e8tode __clone() d'un objecte directament. $copia_objecte = clone $objecte ; Quan es clona un objecte, PHP7 dur\u00e0 a terme una c\u00f2pia superficial de les propietats de l'objecte. Les propietats que siguen refer\u00e8ncies a altres variables (per exemple, objectes), mantindran les refer\u00e8ncies. Compte: si els atributs s\u00f3n objectes no es clonaran.","title":"Clonaci\u00f3 d'Objectes"},{"location":"03-phpoo/0302-phpoo-advanced/#classes-i-metodes-finals","text":"Existeix una forma d'evitar que les classes heretades puguen redefinir el comportament dels m\u00e8todes existents en la superclasse: utilitzar la paraula final . Si en el nostre exemple hagu\u00e9rem fet: class Product { public string $code ; public string $name ; public float $price ; public final function show () { print \"<p>\" . $this -> code . \"</p>\" ; } } En aquest cas el m\u00e8tode show no podria redefinir-se en la classe TV . Tamb\u00e9 es pot declarar una classe utilitzant final . En aquest cas no podran crear-se classes heretades utilitzant-les com a base. final class Product { ... }","title":"Classes i m\u00e8todes finals"},{"location":"03-phpoo/0302-phpoo-advanced/#metodes-magics","text":"Totes les classes PHP ofereixen un conjunt de m\u00e8todes, tamb\u00e9 coneguts com a m\u00e8todes m\u00e0gics que es poden sobreescriure per substituir el seu comportament. Alguns d\u2019ells ja els han utilitzat. Davant de qualsevol dubte, \u00e9s convenient consultar la documentaci\u00f3 oficial . Els m\u00e9s destacables s\u00f3n: __construct() __destruct () \u2192 S'invoca en perdre la refer\u00e8ncia. S'utilitza per tancar una connexi\u00f3 amb una base de dades, tancar un fitxer, etc. __toString () \u2192 representaci\u00f3 de l'objecte com a cadena __get(propietat) , __set(propietat, valor) \u2192 permetria l'acc\u00e9s a la propietat privada, tot i que sempre \u00e9s m\u00e9s llegible/mantenible codificar el getter/setter . __isset(propietat) , __unset (propietat) \u2192 us permet esbrinar o eliminar el valor d'una propietat. __sleep() , __wakeup () \u2192 S'executen quan es recuperen ( Unserialize ) o emmagatzemen un objecte serialitzat ( serialitze ), i s'utilitzen per definir quines propietats estan serialitzades. __call () , __callstatic () \u2192 s'executen cridant a un m\u00e8tode que no siga p\u00fablic. Permeten m\u00e8todes de sobrec\u00e0rrega.","title":"M\u00e8todes m\u00e0gics"},{"location":"03-phpoo/0302-phpoo-advanced/#espai-de-noms","text":"Des de PHP 5.3 permeten organitzar classes/interf\u00edcies, funcions o constant de manera similar als paquets java . Recomanaci\u00f3 Crea un espai de nom \u00fanic per fitxer i creeu una estructura de directoris respecte als nivells/subnivells (com es fa a java ) Es declara a la primera l\u00ednia per la paraula clau namespace seguit del nom de l'espai de nom assignat (cada subnivell est\u00e0 separat amb la barra invertida \\ ): Per exemple, per col\u00b7locar la classe Product dins de l'espai de noms Dwes\\Examples far\u00edem: <? php namespace Dwes\\Examples ; const IVA = 0.21 ; class Product { public string $name ; public function show () : void { echo \"<p> prod:\" . $ this -> name . \"</p>\" ; } }","title":"Espai de noms"},{"location":"03-phpoo/0302-phpoo-advanced/#acces","text":"Per fer refer\u00e8ncia a un recurs que cont\u00e9 un espai de noms, primer cal tenir -lo disponible mitjan\u00e7ant include o require . Si el recurs es troba al mateix espai de noms, es fa un acc\u00e9s directe (es coneix com a acc\u00e9s sense qualificar). Hi ha realment tres tipus d\u2019acc\u00e9s: Sense qualificar: recurs Qualificat: \\rutaRelativa\\recurs . No cal posar l'espai de noms complet. Totalment qualificat: \\rutaAbsoluta\\recurs <? php namespace Dwes\\Examples ; include_once ( \"Product.php\" ); echo IVA ; // sin cualificar echo Utils\\IVA ; // acceso cualificado. Dar\u00eda error, no existe \\Dwes\\Exemples\\Utilitats\\IVA echo \\Dwes\\Exemples\\IVA ; // totalmente cualificado $p1 = new Product (); // lo busca en el mismo namespace y encuentra \\Dwes\\Ejemplos\\Producto $p2 = new Model\\Product (); // dar\u00eda error, no existe el namespace Model. Est\u00e1 buscando \\Dwes\\Ejemplos\\Model\\Producto $p3 = new \\Dwes\\Examples\\Product (); // \\Dwes\\Ejemplos\\Producto Per a evitar la refer\u00e8ncia qualificada podem declarar l'\u00fas mitjan\u00e7ant use (similar a fer un import en Java ). Es faria en la cap\u00e7alera, despr\u00e9s del namespace : Els tipus possibles s\u00f3n: use const nomQualificatConstant use function nomQualificatFuncio use nomQualificatClasse use nomQualificatClase as Alias // per a canviar de nom elements Per exemple, si volem utilitzar la classe \\Dwes\\Examples\\Product des d'un recurs que es trobe en l'arrel, per exemple en index.php , far\u00edem: <? php include_once ( \"Dwes\\Examples\\Product.php\" ); use const Dwes\\Exemples\\IVA ; use \\Dwes\\Exemples\\Product ; echo IVA ; $p1 = new Product (); To use or not to use En resum, use permit acceder sense haver de qualificar-los a recursos que es troben en un altre namespace . Si estem en el mateix espai de noms, no necesitem usar use .","title":"Acc\u00e9s"},{"location":"03-phpoo/0302-phpoo-advanced/#organitzacio","text":"Cada projecte, a mesura que creix, ha d\u2019organitzar el seu codi font. Es planteja una organitzaci\u00f3 en qu\u00e8 els fitxers que interaccionen amb el navegador es col\u00b7loquen a l\u2019arrel i les classes que definim entra dins d\u2019un namespace . Organitzaci\u00f3, includes i uses Posarem cada recurs en un fitxer independent. A la primera l\u00ednia indicarem el seu namespace (si no est\u00e0 a l'arrel). Si utilitzem altres recursos, farem un include_once d'aquests recursos (classes, interf\u00edcies, etc ...). Cada recurs ha d\u2019incloure tots els altres recursos a qu\u00e8 fa\u00e7a refer\u00e8ncia: la classe dels quals hereta, interf\u00edcies que implementen, les classes utilitzades/rebudes com a par\u00e0metres, etc. Si els recursos es troben en un espai de noms diferents dels que som, utilitzarem use amb la ruta completa i, a continuaci\u00f3, l'utilitzarem sense refer\u00e8ncies qualificades.","title":"Organitzaci\u00f3"},{"location":"03-phpoo/0302-phpoo-advanced/#autoload","text":"No \u00e9s tedi\u00f3s haver de fer els require de les classes? La funcionalitat autoload arriba al rescat. Aix\u00ed, aquesta funcionalitat permet que les classes que s\u2019utilitzaran es carreguen autom\u00e0ticament i eviten haver de fer el include_once de cadascuna d'elles. Per fer-ho s'utilitza la funci\u00f3 spl_autoload_register <? php spl_autoload_register ( function ( $nombreClase ) { include_once $nombreClase . '.php' ; } ); ?> \u00bfPer qu\u00e8 s'anomena autoload ? Perqu\u00e8 abans es realitzaba mitjan\u00e7ant el m\u00e8tode m\u00e0gic __autoload() , el qual est\u00e0 deprecated des de PHP 7.2 I com organitzem ara el codi per aprofitar-nos de la c\u00e0rrega autom\u00e0tica? Per facilitar la cerca dels recursos per incloure, \u00e9s recomanable posar totes les classes de la mateixa carpeta. Les situarem dins de src (no \u00e9s obligatori, \u00e9s la convenci\u00f3 que seguirem). Altres directoris que podem crear s\u00f3n test per fer les proves phpunit que despr\u00e9s realitzarem, o la carpeta del views on s\u2019emmagatzemaran les vistes del projecte. Com que hem col\u00b7locat tots els nostres recursos dins de src , ara el nostre autoload.php (que col\u00b7loquem al directori arrel) nom\u00e9s mirar\u00e0 dins d\u2019aquest directori: <? php spl_autoload_register ( function ( $className ) { include_once \"src/\" . $className . '.php' ; } ); ?> Autoload i rutes err\u00f2nies A Ubuntu, quan fa la classe que rep com a par\u00e0metre, les barres de l\u2019espai de noms ( \\ ) s\u00f3n diferents de les de les rutes ( / ).Per tant, utilitzem millor aquesta implementaci\u00f3 del fitxer autoload.php : <? php spl_ <? php spl_autoload_register ( function ( $className ) { $ruta = \"src \\\\ \" . $className . '.php' ; $ruta = str_replace ( \" \\\\ \" , \"/\" , $ruta ); // Sustituimos las barras include_once $ruta ; } );","title":"Autoload"},{"location":"03-phpoo/0302-phpoo-advanced/#bibliografia","text":"Jos\u00e9 Luis Comesa\u00f1a. Apuntes de formaci\u00f3n a distancia del m\u00f3dulo \u00abDesarrollo web en entorno servidor\u00bb del CFGS DAW, elaborados y licenciados por el Ministerio de Educaci\u00f3n, Cultura y Deporte. [en l\u00ednia]. 2012 [data de consulta: 13 de setembre de 2019]. Disponible en \\< https://github.com/statickidz/TemarioDAW/tree/master/DWES > Antonio L\u00f3pez. Learning PHP 7. Packt Publishing (29 de marzo de 2016). Medrano, Aitor, i Luis Alema\u00f1. \u00ab3.- PHP Orientado a Objetos - Desarrollo Web en Entorno Servidor\u00bb. Desarrollo Web en Entorno Servidor, https://aitor-medrano.github.io/dwes2122/03phpoo.html . Consulta 15 octubre 2022.","title":"Bibliografia"},{"location":"03-phpoo/0303-errorhandling/","text":"Gesti\u00f3 d'errors i excepcions De ben segur que a mesura que has anat resolent exercicis o simplement provant codi, t'has trobat amb errors de programaci\u00f3. Alguns s\u00f3n reconeguts per l'entorn de desenvolupament i pots corregir-los abans d'executar. Altres apareixen al navegador en forma de missatge d'error a l'executar l' script . A difer\u00e8ncia d'altres llenguatges de programaci\u00f3 que tenen una gesti\u00f3 d'excepcions m\u00e9s completa PHP mant\u00e9 una gesti\u00f3 d'excepcions lleugera ja que distingeix entre errors i excepcions. Aix\u00ed, mentre no es produisca una excepci\u00f3 o un error fatal l'execuci\u00f3 del programa continuar\u00e0. No obstant aix\u00f2, en PHP 7 canvia la majoria dels errors notificats per PHP. En lloc de notificar errors a trav\u00e9s de l'mecanisme de notificaci\u00f3 d'errors tradicional de PHP 5, la majoria dels errors ara s\u00f3n notificats llan\u00e7ant excepcions Error . A l'igual que les excepcions normals, les excepcions Error es propagaran fins a arribar al primer bloc catch coincident. Si no hi ha blocs coincidents, ser\u00e0 invocat qualsevol gestor d'excepcions predeterminat definit amb set_exception_handler () , i si no hi hagu\u00e9s cap gestor d'excepcions predeterminat, l'excepci\u00f3 ser\u00e0 convertida en un error fatal i ser\u00e0 gestionada com un error tradicional. A causa de que la jerarquia d' Error no hereta de Exception , el codi que empre blocs catch (Exception $e) {...} per gestionar excepcions no capturades en PHP 5 trobareu que aquests Errors no s\u00f3n capturats per aquests blocs. Es requereix, per tant, un bloc catch (Error $e) {...} o un gestor set_exception_handler() . Errors PHP defineix una classificaci\u00f3 dels errors que es poden produir en l'execuci\u00f3 d'un programa i ofereix m\u00e8todes per ajustar el tractament dels mateixos. Per fer refer\u00e8ncia a cada un dels nivells d'error, PHP defineix una s\u00e8rie de constants. Cada nivell s'identifica per una constant. Per exemple, la constant E_NOTICE fa refer\u00e8ncia a avisos que poden indicar un error en executar el programa, i la constant E_ERROR engloba errors fatals que provoquen que s'interrompa for\u00e7osament l'execuci\u00f3. La llista completa de constants la pots consultar al manual de PHP, on tamb\u00e9 es descriu el tipus d'errors que representa : http://es.php.net/manual/es/errorfunc.constants.php Canviar el comportament de PHP La configuraci\u00f3 inicial de com va a tractar-se cada error segons el seu nivell es realitza en php.ini el fitxer de configuraci\u00f3 de PHP. Entre els principals par\u00e0metres que pots ajustar estan: error_reporting . Indica quins tipus d'errors es notificaran. El seu valor es forma utilitzant els operadors a nivell de bit per combinar les constants anteriors. El seu valor per defecte \u00e9s E_ALL & ~ E_NOTICE que indica que es notifiquin tots els errors ( E_ALL ) excepte els avisos a temps d'execuci\u00f3 ( E_NOTICE ). display_errors . En el seu valor per defecte ( On ), fa que els missatges s'envien a la sortida est\u00e0ndard (i per tant es mostrin al navegador). S'ha de desactivar ( Off ) en els servidors que s'usen per a producci\u00f3. Hi ha altres par\u00e0metres que podem utilitzar en php.ini per ajustar el comportament de PHP quan es produeix un error. http://es.php.net/manual/es/errorfunc.configuration.php Des codi, pots fer servir la funci\u00f3 error_reporting amb les constants anteriors per establir el nivell de notificaci\u00f3 en un moment determinat. Per exemple, si en algun lloc del teu codi figura una divisi\u00f3 en la qual hi haja la possibilitat que el divisor siga zero, quan aix\u00f2 passe obtindr\u00e0s un missatge d'error al navegador. Per evitar-ho, pots desactivar la notificaci\u00f3 de errors de nivell E_WARNING abans de la divisi\u00f3 i restaurar al seu valor normal a continuaci\u00f3: error_reporting ( E_ALL & ~ E_NOTICE & ~ E_WARNING ); $resultat = $dividend / $divisor ; error_reporting ( E_ALL & ~ E_NOTICE ); Notificaci\u00f3 d'error en entorns de producci\u00f3 ; PHP comes packaged with two INI files. One that is recommended to be used ; in production environments and one that is recommended to be used in ; development environments. ; php.ini-production contains settings which hold security, performance and ; best practices at its core. But please be aware, these settings may break ; compatibility with older or less security conscience applications. We ; recommending using the production ini in production and testing environments. ; display_errors ; Default Value: On ; Development Value: On ; Production Value: Off ; display_startup_errors ; Default Value: Off ; Development Value: On ; Production Value: Off ; error_reporting ; Default Value: E_ALL & ~E_NOTICE & ~E_STRICT & ~E_DEPRECATED ; Development Value: E_ALL ; Production Value: E_ALL & ~E_DEPRECATED & ~E_STRICT ; html_errors ; Default Value: On ; Development Value: On ; Production value: On ; log_errors ; Default Value: Off ; Development Value: On ; Production Value: On Gesti\u00f3 global dels errors En utilitzar la funci\u00f3 error_reporting nom\u00e9s controles quin tipus d'errors va a notificar PHP. A vegades pot ser suficient, per\u00f2 per obtenir m\u00e9s control sobre el proc\u00e9s existeix tamb\u00e9 la possibilitat de gestionar de forma personalitzada els errors. \u00c9s a dir, pots programar una funci\u00f3 perqu\u00e8 siga la que executa PHP cada vegada que es produeix un error. El nom d'aquesta funci\u00f3 s'indica utilitzant set_error_handler i ha de tenir com a m\u00ednim dos par\u00e0metres obligatoris (el nivell de l'error i el missatge descriptiu) i fins tres opcionals amb informaci\u00f3 addicional sobre el error (el nom del fitxer en qu\u00e8 es produeix, el nombre de l\u00ednia, i un bolcat de l'estat de les variables en aquest moment). set_error_handler ( \"miGestorDeErrores\" ); $resultat = $dividend / $divisor ; restore_error_handler (); function miGestorDeErrores ( $nivell , $missatge ) { switch ( $nivell ) { case E_WARNING : echo \"Error de tipus WARNING: $missatge . <br />\" ; break ; default : echo \"Error de tipus no especificat: $ missatge. <br />\" ; } } La funci\u00f3 restore_error_handler restaura el gestor d'errors original de PHP (m\u00e9s concretament, el que s'estava fent servir abans de la crida a set_error_handler ). ErrorException Gr\u00e0cies a la combinaci\u00f3 de la classe ErrorException i el m\u00e8tode set_error_handler podem convertir f\u00e0cilment els errors en excepcions de tipus ErrorException : <? php function exception_error_handler ( $severidad , $mensaje , $fichero , $l\u00ednea ) { if ( ! ( error_reporting () & $severidad )) { // Este c\u00f3digo de error no est\u00e1 incluido en error_reporting return ; } throw new ErrorException ( $mensaje , 0 , $severidad , $fichero , $l\u00ednea ); } set_error_handler ( \"exception_error_handler\" ); /* Desencadenar la excepci\u00f3n */ strpos (); ?> Excepcions A partir de la versi\u00f3 5 es va introduir en PHP un model d'excepcions similar a l'existent en altres llenguatges de programaci\u00f3: El codi susceptible de produir algun error s'introdueix en un bloc try . Quan es produeix algun error, es llan\u00e7a una excepci\u00f3 utilitzant la instrucci\u00f3 throw . Despr\u00e9s del bloc try ha d'haver com a m\u00ednim un bloc catch encarregat de processar el error. Si un cop acabat el bloc try no s'ha llan\u00e7at cap excepci\u00f3, es continua amb la execuci\u00f3 en la l\u00ednia seg\u00fcent al bloc o blocs catch . Per exemple, per llan\u00e7ar una excepci\u00f3 quan es produeix una divisi\u00f3 per zero podries fer: try { if ( $divisor == 0 ) throw new Exception ( \"Divisi\u00f3 per zero.\" ); $resultat = $dividend / $divisor ; } catch ( Exception $e ) { echo \"S'ha produ\u00eft el seg\u00fcent error:\" . $ e -> getMessage (); } PHP ofereix una classe base Exception per utilitzar com a gestor d'excepcions. Per llan\u00e7ar una excepci\u00f3 no cal indicar cap par\u00e0metre, encara que de forma opcional es pot passar un missatge d'error (com en l'exemple anterior) i tamb\u00e9 un codi d'error. Entre els m\u00e8todes que podeu utilitzar amb els objectes de la classe Exception estan: getMessage . Retorna el missatge, en cas que s'hagi posat algun. getCode . Retorna el codi d'error si existeix. Les funcions internes de PHP i moltes extensions com MySQLi usen el sistema d'errors vist anteriorment. Nom\u00e9s les extensions m\u00e9s modernes orientades a objectes, com \u00e9s el cas de PDO, utilitzen aquest model d'excepcions. En aquest cas, el m\u00e9s com\u00fa \u00e9s que l'extensi\u00f3 definisca els seues propis controladors d'errors heretant de la classe Exception . Classe ErrorException Com hem dit abans, utilitzant la classe ErrorException \u00e9s possible traduir els errors a excepcions. http://es.php.net/manual/es/class.errorexception.php Concretament, la classe PDO permet definir la f\u00f3rmula que far\u00e0 servir quan es produeixi un error, utilitzant l'atribut PDO::ATTR_ERRMODE . Les possibilitats s\u00f3n: PDO::ERRMODE_SILENT . No es fa res quan ocorre un error. \u00c9s el comportament per defecte. PDO::ERRMODE_WARNING . Genera un error de tipus E_WARNING quan es produeix un error. PDO::ERRMODE_EXCEPTION . Quan es produeix un error llan\u00e7a una excepci\u00f3 utilitzant el gestor propi PDOException. \u00c9s a dir, que si vols utilitzar excepcions amb l'extensi\u00f3 PDO, has de configurar la connexi\u00f3 fent: $dwes -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); Per exemple, el seg\u00fcent codi: $dwes = new PDO ( \"mysql:host=localhost;dbname=dwes\" , \"dwes\" , \"abc123.\" ); $dwes -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); try { $sql = \"SELECT * FROM stox\" ; $result = $dwes -> query ( $sql ); ... } catch ( PDOException $p ) { echo \"Error\" . $p -> getMessage () . \"<br />\" ; } Captura l'excepci\u00f3 que llan\u00e7a PDO a causa de que la taula no existeix. El bloc catch mostra el seg\u00fcent missatge: Error SQLSTATE [ 42 S02 ] : Base table or view not found : 1146 Table 'dwes.stox' does not exist El bloc finally En PHP 5.5 i posterior, es pot utilitzar un bloc finally despr\u00e9s o en lloc dels blocs catch . El codi de dins el bloc finally sempre s'executar\u00e0 despr\u00e9s dels blocs try i catch , independentment que s'haja llan\u00e7at una excepci\u00f3 o no, i abans que l'execuci\u00f3 normal continue. Com que el contingut del bloc finally sempre s'executa \u00e9s ideal per a alliberar recursos en cas d'error, com una connexi\u00f3 a base de dades o a la connexi\u00f3 a un servei proporcionats per tercers. M\u00faltiples catch \u00c9s possible afegir m\u00e9s d'un cath de la seg\u00fcent manera: try { ... } catch ( FooException e ) { ... } catch ( BarException e ) { ... } catch ( Exception e ) { ... } A partir de PHP 7.1 tamb\u00e9 \u00e9s possible fer-ho aix\u00ed: try { ... } catch ( FooException | BarException | Exception e ) { ... } Ampliant les excepcions \u00c9s possible crear excepcions personalitzades heretant de la classe Exception . class NegativeIdException extends Exception { public function __construct ( $message = null ) { $this -> message = $message ?: 'ID Negatiu.' ; parent :: __construct ( $message ); } } Despr\u00e9s l'utilitzarem aix\u00ed: try { $post = new Post ( - 1 , \"Hola m\u00f3n\" , \"Aquest \u00e9s el primer post del blog\" , new DateTime (), \"Vicent\" ); } catch ( NegativeIdException $e ) { echo \"No es pot posar un ID negatiu\" ; } catch ( Exception $e ) { echo \"Excepci\u00f3 desconeguda\" . $e -> getMessage (); } Les excepcions personalitzades ens permeten una gesti\u00f3 m\u00e9s senzilla dels errors i major flexibilitat a l'hora de gestionar les possibles situacions d'errors. Interf\u00edcie Throwable Throwable \u00e9s la interf\u00edcie base per a qualsevol objecte que puga ser llan\u00e7at mitjan\u00e7ant una sent\u00e8ncia throw en PHP 7, incloent Error i Exception . Les classes de PHP no poden implementar la interf\u00edcie Throwable directament, de manera que han d'estendre en el seu lloc Exception . Aquesta nova interf\u00edcie t\u00e9 per objectiu unificar les dos tipologies d'exceptions. Tant Exception com Error implementen la interf\u00edcie Throwable . Bibliografia Jos\u00e9 Luis Comesa\u00f1a. Apuntes de formaci\u00f3n a distancia del m\u00f3dulo \u00abDesarrollo web en entorno servidor\u00bb del CFGS DAW, elaborados y licenciados por el Ministerio de Educaci\u00f3n, Cultura y Deporte. [en l\u00ednia]. 2012 [data de consulta: 13 de setembre de 2019]. Disponible en \\< https://github.com/statickidz/TemarioDAW/tree/master/DWES > Antonio L\u00f3pez. Learning PHP 7. Packt Publishing (29 de marzo de 2016) .","title":"Errors i excepcions"},{"location":"03-phpoo/0303-errorhandling/#gestio-derrors-i-excepcions","text":"De ben segur que a mesura que has anat resolent exercicis o simplement provant codi, t'has trobat amb errors de programaci\u00f3. Alguns s\u00f3n reconeguts per l'entorn de desenvolupament i pots corregir-los abans d'executar. Altres apareixen al navegador en forma de missatge d'error a l'executar l' script . A difer\u00e8ncia d'altres llenguatges de programaci\u00f3 que tenen una gesti\u00f3 d'excepcions m\u00e9s completa PHP mant\u00e9 una gesti\u00f3 d'excepcions lleugera ja que distingeix entre errors i excepcions. Aix\u00ed, mentre no es produisca una excepci\u00f3 o un error fatal l'execuci\u00f3 del programa continuar\u00e0. No obstant aix\u00f2, en PHP 7 canvia la majoria dels errors notificats per PHP. En lloc de notificar errors a trav\u00e9s de l'mecanisme de notificaci\u00f3 d'errors tradicional de PHP 5, la majoria dels errors ara s\u00f3n notificats llan\u00e7ant excepcions Error . A l'igual que les excepcions normals, les excepcions Error es propagaran fins a arribar al primer bloc catch coincident. Si no hi ha blocs coincidents, ser\u00e0 invocat qualsevol gestor d'excepcions predeterminat definit amb set_exception_handler () , i si no hi hagu\u00e9s cap gestor d'excepcions predeterminat, l'excepci\u00f3 ser\u00e0 convertida en un error fatal i ser\u00e0 gestionada com un error tradicional. A causa de que la jerarquia d' Error no hereta de Exception , el codi que empre blocs catch (Exception $e) {...} per gestionar excepcions no capturades en PHP 5 trobareu que aquests Errors no s\u00f3n capturats per aquests blocs. Es requereix, per tant, un bloc catch (Error $e) {...} o un gestor set_exception_handler() .","title":"Gesti\u00f3 d'errors i excepcions"},{"location":"03-phpoo/0303-errorhandling/#errors","text":"PHP defineix una classificaci\u00f3 dels errors que es poden produir en l'execuci\u00f3 d'un programa i ofereix m\u00e8todes per ajustar el tractament dels mateixos. Per fer refer\u00e8ncia a cada un dels nivells d'error, PHP defineix una s\u00e8rie de constants. Cada nivell s'identifica per una constant. Per exemple, la constant E_NOTICE fa refer\u00e8ncia a avisos que poden indicar un error en executar el programa, i la constant E_ERROR engloba errors fatals que provoquen que s'interrompa for\u00e7osament l'execuci\u00f3. La llista completa de constants la pots consultar al manual de PHP, on tamb\u00e9 es descriu el tipus d'errors que representa : http://es.php.net/manual/es/errorfunc.constants.php","title":"Errors"},{"location":"03-phpoo/0303-errorhandling/#canviar-el-comportament-de-php","text":"La configuraci\u00f3 inicial de com va a tractar-se cada error segons el seu nivell es realitza en php.ini el fitxer de configuraci\u00f3 de PHP. Entre els principals par\u00e0metres que pots ajustar estan: error_reporting . Indica quins tipus d'errors es notificaran. El seu valor es forma utilitzant els operadors a nivell de bit per combinar les constants anteriors. El seu valor per defecte \u00e9s E_ALL & ~ E_NOTICE que indica que es notifiquin tots els errors ( E_ALL ) excepte els avisos a temps d'execuci\u00f3 ( E_NOTICE ). display_errors . En el seu valor per defecte ( On ), fa que els missatges s'envien a la sortida est\u00e0ndard (i per tant es mostrin al navegador). S'ha de desactivar ( Off ) en els servidors que s'usen per a producci\u00f3. Hi ha altres par\u00e0metres que podem utilitzar en php.ini per ajustar el comportament de PHP quan es produeix un error. http://es.php.net/manual/es/errorfunc.configuration.php Des codi, pots fer servir la funci\u00f3 error_reporting amb les constants anteriors per establir el nivell de notificaci\u00f3 en un moment determinat. Per exemple, si en algun lloc del teu codi figura una divisi\u00f3 en la qual hi haja la possibilitat que el divisor siga zero, quan aix\u00f2 passe obtindr\u00e0s un missatge d'error al navegador. Per evitar-ho, pots desactivar la notificaci\u00f3 de errors de nivell E_WARNING abans de la divisi\u00f3 i restaurar al seu valor normal a continuaci\u00f3: error_reporting ( E_ALL & ~ E_NOTICE & ~ E_WARNING ); $resultat = $dividend / $divisor ; error_reporting ( E_ALL & ~ E_NOTICE );","title":"Canviar el comportament de PHP"},{"location":"03-phpoo/0303-errorhandling/#notificacio-derror-en-entorns-de-produccio","text":"; PHP comes packaged with two INI files. One that is recommended to be used ; in production environments and one that is recommended to be used in ; development environments. ; php.ini-production contains settings which hold security, performance and ; best practices at its core. But please be aware, these settings may break ; compatibility with older or less security conscience applications. We ; recommending using the production ini in production and testing environments. ; display_errors ; Default Value: On ; Development Value: On ; Production Value: Off ; display_startup_errors ; Default Value: Off ; Development Value: On ; Production Value: Off ; error_reporting ; Default Value: E_ALL & ~E_NOTICE & ~E_STRICT & ~E_DEPRECATED ; Development Value: E_ALL ; Production Value: E_ALL & ~E_DEPRECATED & ~E_STRICT ; html_errors ; Default Value: On ; Development Value: On ; Production value: On ; log_errors ; Default Value: Off ; Development Value: On ; Production Value: On","title":"Notificaci\u00f3 d'error en entorns de producci\u00f3"},{"location":"03-phpoo/0303-errorhandling/#gestio-global-dels-errors","text":"En utilitzar la funci\u00f3 error_reporting nom\u00e9s controles quin tipus d'errors va a notificar PHP. A vegades pot ser suficient, per\u00f2 per obtenir m\u00e9s control sobre el proc\u00e9s existeix tamb\u00e9 la possibilitat de gestionar de forma personalitzada els errors. \u00c9s a dir, pots programar una funci\u00f3 perqu\u00e8 siga la que executa PHP cada vegada que es produeix un error. El nom d'aquesta funci\u00f3 s'indica utilitzant set_error_handler i ha de tenir com a m\u00ednim dos par\u00e0metres obligatoris (el nivell de l'error i el missatge descriptiu) i fins tres opcionals amb informaci\u00f3 addicional sobre el error (el nom del fitxer en qu\u00e8 es produeix, el nombre de l\u00ednia, i un bolcat de l'estat de les variables en aquest moment). set_error_handler ( \"miGestorDeErrores\" ); $resultat = $dividend / $divisor ; restore_error_handler (); function miGestorDeErrores ( $nivell , $missatge ) { switch ( $nivell ) { case E_WARNING : echo \"Error de tipus WARNING: $missatge . <br />\" ; break ; default : echo \"Error de tipus no especificat: $ missatge. <br />\" ; } } La funci\u00f3 restore_error_handler restaura el gestor d'errors original de PHP (m\u00e9s concretament, el que s'estava fent servir abans de la crida a set_error_handler ).","title":"Gesti\u00f3 global dels errors"},{"location":"03-phpoo/0303-errorhandling/#errorexception","text":"Gr\u00e0cies a la combinaci\u00f3 de la classe ErrorException i el m\u00e8tode set_error_handler podem convertir f\u00e0cilment els errors en excepcions de tipus ErrorException : <? php function exception_error_handler ( $severidad , $mensaje , $fichero , $l\u00ednea ) { if ( ! ( error_reporting () & $severidad )) { // Este c\u00f3digo de error no est\u00e1 incluido en error_reporting return ; } throw new ErrorException ( $mensaje , 0 , $severidad , $fichero , $l\u00ednea ); } set_error_handler ( \"exception_error_handler\" ); /* Desencadenar la excepci\u00f3n */ strpos (); ?>","title":"ErrorException"},{"location":"03-phpoo/0303-errorhandling/#excepcions","text":"A partir de la versi\u00f3 5 es va introduir en PHP un model d'excepcions similar a l'existent en altres llenguatges de programaci\u00f3: El codi susceptible de produir algun error s'introdueix en un bloc try . Quan es produeix algun error, es llan\u00e7a una excepci\u00f3 utilitzant la instrucci\u00f3 throw . Despr\u00e9s del bloc try ha d'haver com a m\u00ednim un bloc catch encarregat de processar el error. Si un cop acabat el bloc try no s'ha llan\u00e7at cap excepci\u00f3, es continua amb la execuci\u00f3 en la l\u00ednia seg\u00fcent al bloc o blocs catch . Per exemple, per llan\u00e7ar una excepci\u00f3 quan es produeix una divisi\u00f3 per zero podries fer: try { if ( $divisor == 0 ) throw new Exception ( \"Divisi\u00f3 per zero.\" ); $resultat = $dividend / $divisor ; } catch ( Exception $e ) { echo \"S'ha produ\u00eft el seg\u00fcent error:\" . $ e -> getMessage (); } PHP ofereix una classe base Exception per utilitzar com a gestor d'excepcions. Per llan\u00e7ar una excepci\u00f3 no cal indicar cap par\u00e0metre, encara que de forma opcional es pot passar un missatge d'error (com en l'exemple anterior) i tamb\u00e9 un codi d'error. Entre els m\u00e8todes que podeu utilitzar amb els objectes de la classe Exception estan: getMessage . Retorna el missatge, en cas que s'hagi posat algun. getCode . Retorna el codi d'error si existeix. Les funcions internes de PHP i moltes extensions com MySQLi usen el sistema d'errors vist anteriorment. Nom\u00e9s les extensions m\u00e9s modernes orientades a objectes, com \u00e9s el cas de PDO, utilitzen aquest model d'excepcions. En aquest cas, el m\u00e9s com\u00fa \u00e9s que l'extensi\u00f3 definisca els seues propis controladors d'errors heretant de la classe Exception . Classe ErrorException Com hem dit abans, utilitzant la classe ErrorException \u00e9s possible traduir els errors a excepcions. http://es.php.net/manual/es/class.errorexception.php Concretament, la classe PDO permet definir la f\u00f3rmula que far\u00e0 servir quan es produeixi un error, utilitzant l'atribut PDO::ATTR_ERRMODE . Les possibilitats s\u00f3n: PDO::ERRMODE_SILENT . No es fa res quan ocorre un error. \u00c9s el comportament per defecte. PDO::ERRMODE_WARNING . Genera un error de tipus E_WARNING quan es produeix un error. PDO::ERRMODE_EXCEPTION . Quan es produeix un error llan\u00e7a una excepci\u00f3 utilitzant el gestor propi PDOException. \u00c9s a dir, que si vols utilitzar excepcions amb l'extensi\u00f3 PDO, has de configurar la connexi\u00f3 fent: $dwes -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); Per exemple, el seg\u00fcent codi: $dwes = new PDO ( \"mysql:host=localhost;dbname=dwes\" , \"dwes\" , \"abc123.\" ); $dwes -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); try { $sql = \"SELECT * FROM stox\" ; $result = $dwes -> query ( $sql ); ... } catch ( PDOException $p ) { echo \"Error\" . $p -> getMessage () . \"<br />\" ; } Captura l'excepci\u00f3 que llan\u00e7a PDO a causa de que la taula no existeix. El bloc catch mostra el seg\u00fcent missatge: Error SQLSTATE [ 42 S02 ] : Base table or view not found : 1146 Table 'dwes.stox' does not exist","title":"Excepcions"},{"location":"03-phpoo/0303-errorhandling/#el-bloc-finally","text":"En PHP 5.5 i posterior, es pot utilitzar un bloc finally despr\u00e9s o en lloc dels blocs catch . El codi de dins el bloc finally sempre s'executar\u00e0 despr\u00e9s dels blocs try i catch , independentment que s'haja llan\u00e7at una excepci\u00f3 o no, i abans que l'execuci\u00f3 normal continue. Com que el contingut del bloc finally sempre s'executa \u00e9s ideal per a alliberar recursos en cas d'error, com una connexi\u00f3 a base de dades o a la connexi\u00f3 a un servei proporcionats per tercers.","title":"El bloc finally"},{"location":"03-phpoo/0303-errorhandling/#multiples-catch","text":"\u00c9s possible afegir m\u00e9s d'un cath de la seg\u00fcent manera: try { ... } catch ( FooException e ) { ... } catch ( BarException e ) { ... } catch ( Exception e ) { ... } A partir de PHP 7.1 tamb\u00e9 \u00e9s possible fer-ho aix\u00ed: try { ... } catch ( FooException | BarException | Exception e ) { ... }","title":"M\u00faltiples catch"},{"location":"03-phpoo/0303-errorhandling/#ampliant-les-excepcions","text":"\u00c9s possible crear excepcions personalitzades heretant de la classe Exception . class NegativeIdException extends Exception { public function __construct ( $message = null ) { $this -> message = $message ?: 'ID Negatiu.' ; parent :: __construct ( $message ); } } Despr\u00e9s l'utilitzarem aix\u00ed: try { $post = new Post ( - 1 , \"Hola m\u00f3n\" , \"Aquest \u00e9s el primer post del blog\" , new DateTime (), \"Vicent\" ); } catch ( NegativeIdException $e ) { echo \"No es pot posar un ID negatiu\" ; } catch ( Exception $e ) { echo \"Excepci\u00f3 desconeguda\" . $e -> getMessage (); } Les excepcions personalitzades ens permeten una gesti\u00f3 m\u00e9s senzilla dels errors i major flexibilitat a l'hora de gestionar les possibles situacions d'errors.","title":"Ampliant les excepcions"},{"location":"03-phpoo/0303-errorhandling/#interficie-throwable","text":"Throwable \u00e9s la interf\u00edcie base per a qualsevol objecte que puga ser llan\u00e7at mitjan\u00e7ant una sent\u00e8ncia throw en PHP 7, incloent Error i Exception . Les classes de PHP no poden implementar la interf\u00edcie Throwable directament, de manera que han d'estendre en el seu lloc Exception . Aquesta nova interf\u00edcie t\u00e9 per objectiu unificar les dos tipologies d'exceptions. Tant Exception com Error implementen la interf\u00edcie Throwable .","title":"Interf\u00edcie Throwable"},{"location":"03-phpoo/0303-errorhandling/#bibliografia","text":"Jos\u00e9 Luis Comesa\u00f1a. Apuntes de formaci\u00f3n a distancia del m\u00f3dulo \u00abDesarrollo web en entorno servidor\u00bb del CFGS DAW, elaborados y licenciados por el Ministerio de Educaci\u00f3n, Cultura y Deporte. [en l\u00ednia]. 2012 [data de consulta: 13 de setembre de 2019]. Disponible en \\< https://github.com/statickidz/TemarioDAW/tree/master/DWES > Antonio L\u00f3pez. Learning PHP 7. Packt Publishing (29 de marzo de 2016) .","title":"Bibliografia"},{"location":"03-phpoo/0399-activities/","text":"Activitats POO B\u00e0sic Crea una classe Employee que represente un empleat amb el seu nom, cognoms i sou. Encapsula les propietats mitjan\u00e7ant m\u00e8todes getters / setters i afegeix els seg\u00fcents m\u00e8todes: Obtenir el nom complet: getFullname(): string . Que torne un boole\u00e0 indicant si deu o no pagar impostos (es paguen quan el sou \u00e9s superior a 3333\u20ac): mustPayTaxes():bool . Afegeix una propietat privada que que emmagatzeme una s\u00e8rie de n\u00fameros de tel\u00e8fons. Afegiu els seg\u00fcents m\u00e8todes: public function addPhone(string $phone): void \u2192 Afegeix un tel\u00e8fon a l'array public function listPhones(): string \u2192 Torna els tel\u00e8fons en separats per comes public function emptyPhones(): void \u2192 Elimina tots els tel\u00e8fons Crea el constructor amb els par\u00e0metres nom i cognoms. Si el constructor rep un tercer par\u00e0metre, ser\u00e0 el sou. Si no, s\u2019assignaran 1000\u20ac com a sou inicial. Fes una versi\u00f3 fent \u00fas de la propagaci\u00f3 de propietats de PHP8. Afegeix una constant MAX_SALARY amb el valor del sou que ha de pagar impostos, i modifica el codi per utilitzar la constant. Completa el seg\u00fcent m\u00e8tode amb una cadena HTML que mostre les dades d'un empleat dins d'un par\u00e0graf i tots els tel\u00e8fons mitjan\u00e7ant una llista ordenada (haur\u00e0s de crear un getter per als tel\u00e8fons): public static function toHtml (Employee $emp): string Representa la classe en UML. Crea una classe anomenada Card que contindr\u00e0 la informaci\u00f3 relativa una carta de la baralla francesa amb les seguents propietats: suit , string, privada. symbol , string, privada. value , entera, privada. El constructor i el seus getters i setters . Crea cinc objects diferents en un array i mostra'ls de forma aleat\u00f2ria. classDiagram class Card { -string suit -string symbol -int value +void function __construct (string, string, int) } Crea una classe anomenada CardCollection que contindr\u00e0 la propietat cards que ser\u00e0 un array de cartes (objectes Card ). Hi haur\u00e0 dues formes d'inserir cartes, mitjan\u00e7ant el m\u00e8tode CardCollection::add(array $array) que rebr\u00e0 un array de cartes i els afegir\u00e0 a la propietat cards i el m\u00e8tode CardCollecion::addCard(Card $card) que rebr\u00e0 una carta i la inserir\u00e0 en la propietat cards . A m\u00e9s, contindr\u00e0 el m\u00e8tode shuffle() que ordenar\u00e0 les cartes de forma aleat\u00f2ria. Inst\u00e0ncia la classe, afig 5 cartes, reordena-les i mostra-les. classDiagram class CardCollection { -cards: array +add(cards: array) +addCard(card: Card): void shuffle() getCards() array } class Card { -suit: string -symbol: string -value: int __construct (suit: string, symbol: string, value: int) } CardCollection \"1\"--\"*\" Card Crea el m\u00e8todo writer en la classe CardCollection de forma que mostre en format lliure la col\u00b7leci\u00f3 de cartes. Amb aquest m\u00e8tode afegirem una nova capa d'abstracci\u00f3 ja que no caldr\u00e0 accedir directament als m\u00e8todes de la classe Card per representar-les. Implementa la interf\u00edcie Iterator en CardCollection de forma que es puguen rec\u00f3rrer la col\u00b7lecci\u00f3 de cartes en un foreach ; Fent \u00fas de les classes anteriors crearem una aplicaci\u00f3 b\u00e0sica en la que s'enfronten dos jugadors. Un exemple de partida podria ser el seg\u00fcent: La classe CardCollection quedar\u00e0 aix\u00ed: classDiagram class CardCollection { -cards: array add(cards: array) addCard(card: Card) void ... deal(amount: int) array play() Card } Els requisits seran els seg\u00fcents: Es repartiran 5 cartes per jugador. El m\u00e8tode deal que repartir\u00e0 el n\u00famero de cartes que s'indique com a par\u00e0metre eliminant-les de la col\u00b7lecci\u00f3. El m\u00e8tode play jugar\u00e0 una carta que s'eliminar\u00e0 de la col\u00b7lecci\u00f3. Cada tirada la guanya el jugador que t\u00e9 la carta m\u00e9s alta, segons el valor. La partida la guanya el jugador que ha guanyat m\u00e9s vegades. En cas d'empat es repartir\u00e0 una nova carta a cada jugador. Aix\u00ed que en la aplicaci\u00f3 interactuaran 3 objectes de tipus CardCollection . abastract_game : en l'activitat anterior vam crear tres objectes de tipus CardCollection . Podem observar que alguns m\u00e8todes, com per exemple deal ( repartir ) tenen sentit en l'objecte quan representen la m\u00e0 d'un jugador. Podem replantejar la soluci\u00f3 de la seg\u00fcent manera: classDiagram direction LR class CardCollection { < < abstract >> #cards: array +add(cards: Card[]) +addCard(card: Card) void getCards() Card[] } class Card { -suit: string -symbol: string -value: int __construct (suit: string, symbol: string, value: int) } class Deck { shuffle() deal(amount: int = 1) Card[] } class Hand { play() Card } CardCollection \"1\"--\"*\" Card Deck --|> CardCollection Hand --|> CardCollection En el diagrama anterior definim CardCollection com una classe abstracta, d'ella hereten dos classes Deck que representa la baralla i Hand que representa les cartes d'un jugador. Cada classe exten la funcionalitat afegint els seus propis m\u00e8todes. Recorda que una classe abstracta \u00e9s un tipus de classe que no s'inst\u00e0ncia i sols poden ser heretades traslladant aix\u00ed un funcionamient obligatori a les classes filles (o subclasses). Modifica la soluci\u00f3 a l'activitat anterior amb la nova jerarquia de classes. Errors i excepcions 320-error-handling : modifica l'activitat 303, Empleat.php de forma en cas que el sou siga negatiu llance una excepci\u00f3 amb el missage \"El sou no pot ser negatiu\". Captura l'excepci\u00f3 i mostra el missatge. 321-error-handling : modifica l'activitat anterior llan\u00e7ant en esta ocasi\u00f3 una excepci\u00f3 personalitzada InvalidWageException amb el missatge per defecte \"El sou no pot ser negatiu\". Captura l'exceptic\u00f3 i mostra el missatge. Projecte: Truiter En les seg\u00fcents activitats anem a posar en marxa el que ser\u00e0 el nostre projecte. Cal tenir en compte que es tracta d'un projecte de caracter did\u00e0ctic, aix\u00ed que algunes coses poden no ser del tot correctes des del punt de vista de la qualitat del codi. Per al projecte disposarem de la seg\u00fcent estructura de directoris: . \u251c\u2500\u2500 index.php \u251c\u2500\u2500 src \u2514\u2500\u2500 views src contindr\u00e0 les classes i views les vistes. Crea una classe per representar usuaris ( User ). Aquesta classe contindr\u00e0 les propietats necess\u00e0ries per a emmagatzemar un usuari de l'aplicaci\u00f3. El constructor rebr\u00e0 com a par\u00e0metres el nom i el nom d'usuari. En el cos del constructor assigna a la data de creaci\u00f3 la data actual. Codi de prova <?php // index.php $user = new User ( 'Bart Simpson' , 'bart' ); ?> < p > <? = $user -> getName () ?> (@ <? = $user -> getUsername () ?> ) - Creation date: <? = $user -> getCreatedAt () -> format ( 'd-m-Y h:i:s' ) ?> </ p > Navegador Bart Simpson (@bart) - Creation date: 11-10-2022 10:24:27 Crea una classe per representar tweets ( Tweet ). Aquesta classe contindr\u00e0 les propietats necess\u00e0ries per a emmagatzemar un tweet. Crea els setters i els getters . El constructor rebr\u00e0 com a par\u00e0metres el text i l'autor. En el cos del constructor assigna a la data de creaci\u00f3 la data actual i al n\u00famero de likes 0. classDiagram direction LR class Tweet { -text: string -createdAt: DateTime -attachments: array -author: User -likeCount: int __construct(text: string, user: User) } class User { createdAt: DateTime name: string verified: bool username: string __construct(user: string, username: string) } Tweet \"1\"--\"1\" User Codi de prova <? $user = new User ( 'Bart Simpson' , 'bart' ); // fem un delay de 4 segons perqu\u00e8 les dates de creaci\u00f3 no coincidisquen sleep ( 4 ); $tweet = new Tweet ( 'Hola m\u00f3n!' , $user ); ?> < h2 > Users </ h2 > < p > <? = $user -> getName () ?> (@ <? = $user -> getUsername () ?> ) - Creation date: <? = $user -> getCreatedAt () -> format ( 'd-m-Y h:i:s' ) ?> </ p > < h2 > Tweets </ h2 > <?php $tweetUser = $tweet -> getAuthor () ?> < p > <? = $tweetUser -> getName () ?> (@ <? = $tweetUser -> getUsername () ?> ) - Creation date: <? = $tweet -> getCreatedAt () -> format ( 'd-m-Y h:i:s' ) ?> </ p > < p > <? = $tweet -> getText () ?> </ p > < p > <? = $tweet -> getLikeCount () ?> </ p > < hr /> Navegador Users Bart Simpson (@bart) - Creation date: 12-10-2022 10:42:51 Tweets Bart Simpson (@bart) - Creation date: 12-10-2022 10:42:55 Hola m\u00f3n! Like counter: 0 Crea la seg\u00fcent jerarquia de classes que represent els diferents tipus de mitj\u00e0 que poden adjuntar a un tuit: classDiagram direction BT class Media { < < abstract >> __construct(caption, width, height) -caption: string -width: int -height: int getHeight() int getWidth() int getSummary()* string setHeight(height) getCaption() string setCaption(caption) setWidth(width) } class Photo { __construct(caption, width, height, altText) -altText :string getSummary() string getAltText() setAltText(altText) } class Video { __construct(caption, width, height, duration) -duration: int setDuration(duration) getSummary() string getDuration() int } Photo --> Media Video --> Media Codi de prova <?php // index.php ... $video = new Video ( 'V\u00eddeo 1' , 1080 , 1024 , 25 ); $photo = new Photo ( 'Foto 1' , 800 , 600 , 'Text alternatiu' ); ?> < h2 > Media </ h2 > ... <? = $video -> getSummary (); ?> <? = $photo -> getSummary (); ?> Navegador Media V\u00eddeo 1 [1080x1024] (25 s) Foto 1 (Text alternatiu) [800x600] Arribats a aquest punt anem a relacionar totes les classes que hem creat mitjan\u00e7ant la classe Twitter . Crea la classe representada en el gr\u00e0fic tenint en compte que users \u00e9s un array d'usuaris, tweets \u00e9s un array de tuits i attachements un array de mitjans. S'han omitit algunes propietats i m\u00e8todes per simplicar el diagrama UML. classDiagram direction LR class Twitter { - tweets: array - users: array - numberOfTweets: int - numberOfUsers: int + __construct() + likeTweet(user, tweet) void + addTweet(tweet) void + setTweets(tweets) void + getNumberOfUsers() int + setNumberOfUsers(numberOfUsers) void + getTweets() array + addUser(user) void + setNumberOfTweets(numberOfTweets) void + setUsers(users) void + getNumberOfTweets() int + getUsers() array } class User { } class Tweet { - attachments: array + getAttachments() array + addAttachment(media) void } class Media { < < abstract >> } class Photo { } class Video { } Twitter \"0\" -- \"*\" Tweet Tweet \"0\" -- \"*\" Media Twitter \"0\" -- \"*\" User Photo --> Media Video --> Media Codi de prova <?php $twitter = new Twitter (); $user = new User ( 'Bart Simpson' , 'bart' ); $twitter -> addUser ( $user ); // fem un delay de 4 segons perqu\u00e8 les dates de creaci\u00f3 no coincidisquen sleep ( 4 ); $userH = new User ( 'Homer Simpson' , 'homerj' ); $twitter -> addUser ( $userH ); $users = $twitter -> getUsers (); sleep ( 4 ); $tweet = new Tweet ( 'Hola m\u00f3n!' , $user ); $video = new Video ( 'V\u00eddeo 1' , 1080 , 1024 , 25 ); $photo = new Photo ( 'Foto 1' , 1080 , 1024 , 'Text alternatiu' ); $tweet -> addAttachment ( $video ); $tweet -> addAttachment ( $photo ); $twitter -> addTweet ( $tweet ); $twitter -> LikeTweet ( $user , $tweet ); $twitter -> LikeTweet ( $userH , $tweet ); $tweet = new Tweet ( \"Kids, just because I don\u2019t care doesn\u2019t mean I\u2019m not listening.\" , $userH ); $twitter -> addTweet ( $tweet ); $tweet = new Tweet ( \"I\u2019ve learned that life is one crushing defeat after another until you just wish Flanders was dead.\" , $userH ); $twitter -> addTweet ( $tweet ); $tweets = $twitter -> getTweets (); ?> < h1 > Welcome to Truiter </ h1 > < p > <? = $twitter -> getNumberOfUsers () ?> users, <? = $twitter -> getNumberOfTweets () ?> tweets. </ p > < h2 > Users </ h2 > <?php foreach ( $users as $user ) : ?> < p > <? = $user -> getName () ?> (@ <? = $user -> getUsername () ?> ) - Creation date: <? = $user -> getCreatedAt () -> format ( 'd-m-Y h:i:s' ) ?> </ p > <?php endforeach ; ?> < h2 > Tweets </ h2 > <?php foreach ( $tweets as $tweet ) : ?> <?php $tweetUser = $tweet -> getAuthor () ?> < p > <? = $tweetUser -> getName () ?> (@ <? = $tweetUser -> getUsername () ?> ) - Creation date: <? = $tweet -> getCreatedAt () -> format ( 'd-m-Y h:i:s' ) ?> </ p > < blockquote > <? = $tweet -> getText () ?> </ blockquote > < p > Like counter: <? = $tweet -> getLikeCount (); ?> </ p > <?php if ( count ( $tweet -> getAttachments ()) > 0 ) : ?> < h3 > Attachments </ h3 > < ul > <?php foreach ( $tweet -> getAttachments () as $attachment ) : ?> < li > <? = $attachment -> getSummary () ?> </ li > <?php endforeach ; ?> </ ul > <?php endif ; ?> < hr /> <?php endforeach ; ?> Navegador Welcome to Truiter 2 users, 3 tweets. Users Bart Simpson (@bart) - Creation date: 13-10-2022 09:45:52 Homer Simpson (@homerj) - Creation date: 13-10-2022 09:45:56 Tweets Bart Simpson (@bart) - Creation date: 13-10-2022 09:46:00 Hola m\u00f3n! Like counter: 2 Attachments - V\u00eddeo 1 [1080x1024] ( 25 s) - Foto 1 (Text alternatiu) [1080x1024] Homer Simpson (@homerj) - Creation date: 13-10-2022 09:46:00 Kids, just because I don\u2019t care doesn\u2019t mean I\u2019m not listening. Like counter: 0 Homer Simpson (@homerj) - Creation date: 13-10-2022 09:46:00 I\u2019ve learned that life is one crushing defeat after another until you just wish Flanders was dead. Like counter: 0 Implementa la c\u00e0rrega autom\u00e0tica (autoload) de classes tenint en compte que: Les classes estaran en el directori src/App . L'espai de noms ser\u00e0 App. Crea les excepcions InvalidWidthMediaException i InvalidHeightMediaException que es llan\u00e7aran quan alguna de les dimensions dels mitjans siga inferior a 300 p\u00edxels. Guarda-les en el directori src/App/Exceptions amb el namespace corresponent.","title":"Activitats"},{"location":"03-phpoo/0399-activities/#activitats","text":"","title":"Activitats"},{"location":"03-phpoo/0399-activities/#poo-basic","text":"Crea una classe Employee que represente un empleat amb el seu nom, cognoms i sou. Encapsula les propietats mitjan\u00e7ant m\u00e8todes getters / setters i afegeix els seg\u00fcents m\u00e8todes: Obtenir el nom complet: getFullname(): string . Que torne un boole\u00e0 indicant si deu o no pagar impostos (es paguen quan el sou \u00e9s superior a 3333\u20ac): mustPayTaxes():bool . Afegeix una propietat privada que que emmagatzeme una s\u00e8rie de n\u00fameros de tel\u00e8fons. Afegiu els seg\u00fcents m\u00e8todes: public function addPhone(string $phone): void \u2192 Afegeix un tel\u00e8fon a l'array public function listPhones(): string \u2192 Torna els tel\u00e8fons en separats per comes public function emptyPhones(): void \u2192 Elimina tots els tel\u00e8fons Crea el constructor amb els par\u00e0metres nom i cognoms. Si el constructor rep un tercer par\u00e0metre, ser\u00e0 el sou. Si no, s\u2019assignaran 1000\u20ac com a sou inicial. Fes una versi\u00f3 fent \u00fas de la propagaci\u00f3 de propietats de PHP8. Afegeix una constant MAX_SALARY amb el valor del sou que ha de pagar impostos, i modifica el codi per utilitzar la constant. Completa el seg\u00fcent m\u00e8tode amb una cadena HTML que mostre les dades d'un empleat dins d'un par\u00e0graf i tots els tel\u00e8fons mitjan\u00e7ant una llista ordenada (haur\u00e0s de crear un getter per als tel\u00e8fons): public static function toHtml (Employee $emp): string Representa la classe en UML. Crea una classe anomenada Card que contindr\u00e0 la informaci\u00f3 relativa una carta de la baralla francesa amb les seguents propietats: suit , string, privada. symbol , string, privada. value , entera, privada. El constructor i el seus getters i setters . Crea cinc objects diferents en un array i mostra'ls de forma aleat\u00f2ria. classDiagram class Card { -string suit -string symbol -int value +void function __construct (string, string, int) } Crea una classe anomenada CardCollection que contindr\u00e0 la propietat cards que ser\u00e0 un array de cartes (objectes Card ). Hi haur\u00e0 dues formes d'inserir cartes, mitjan\u00e7ant el m\u00e8tode CardCollection::add(array $array) que rebr\u00e0 un array de cartes i els afegir\u00e0 a la propietat cards i el m\u00e8tode CardCollecion::addCard(Card $card) que rebr\u00e0 una carta i la inserir\u00e0 en la propietat cards . A m\u00e9s, contindr\u00e0 el m\u00e8tode shuffle() que ordenar\u00e0 les cartes de forma aleat\u00f2ria. Inst\u00e0ncia la classe, afig 5 cartes, reordena-les i mostra-les. classDiagram class CardCollection { -cards: array +add(cards: array) +addCard(card: Card): void shuffle() getCards() array } class Card { -suit: string -symbol: string -value: int __construct (suit: string, symbol: string, value: int) } CardCollection \"1\"--\"*\" Card Crea el m\u00e8todo writer en la classe CardCollection de forma que mostre en format lliure la col\u00b7leci\u00f3 de cartes. Amb aquest m\u00e8tode afegirem una nova capa d'abstracci\u00f3 ja que no caldr\u00e0 accedir directament als m\u00e8todes de la classe Card per representar-les. Implementa la interf\u00edcie Iterator en CardCollection de forma que es puguen rec\u00f3rrer la col\u00b7lecci\u00f3 de cartes en un foreach ; Fent \u00fas de les classes anteriors crearem una aplicaci\u00f3 b\u00e0sica en la que s'enfronten dos jugadors. Un exemple de partida podria ser el seg\u00fcent: La classe CardCollection quedar\u00e0 aix\u00ed: classDiagram class CardCollection { -cards: array add(cards: array) addCard(card: Card) void ... deal(amount: int) array play() Card } Els requisits seran els seg\u00fcents: Es repartiran 5 cartes per jugador. El m\u00e8tode deal que repartir\u00e0 el n\u00famero de cartes que s'indique com a par\u00e0metre eliminant-les de la col\u00b7lecci\u00f3. El m\u00e8tode play jugar\u00e0 una carta que s'eliminar\u00e0 de la col\u00b7lecci\u00f3. Cada tirada la guanya el jugador que t\u00e9 la carta m\u00e9s alta, segons el valor. La partida la guanya el jugador que ha guanyat m\u00e9s vegades. En cas d'empat es repartir\u00e0 una nova carta a cada jugador. Aix\u00ed que en la aplicaci\u00f3 interactuaran 3 objectes de tipus CardCollection . abastract_game : en l'activitat anterior vam crear tres objectes de tipus CardCollection . Podem observar que alguns m\u00e8todes, com per exemple deal ( repartir ) tenen sentit en l'objecte quan representen la m\u00e0 d'un jugador. Podem replantejar la soluci\u00f3 de la seg\u00fcent manera: classDiagram direction LR class CardCollection { < < abstract >> #cards: array +add(cards: Card[]) +addCard(card: Card) void getCards() Card[] } class Card { -suit: string -symbol: string -value: int __construct (suit: string, symbol: string, value: int) } class Deck { shuffle() deal(amount: int = 1) Card[] } class Hand { play() Card } CardCollection \"1\"--\"*\" Card Deck --|> CardCollection Hand --|> CardCollection En el diagrama anterior definim CardCollection com una classe abstracta, d'ella hereten dos classes Deck que representa la baralla i Hand que representa les cartes d'un jugador. Cada classe exten la funcionalitat afegint els seus propis m\u00e8todes. Recorda que una classe abstracta \u00e9s un tipus de classe que no s'inst\u00e0ncia i sols poden ser heretades traslladant aix\u00ed un funcionamient obligatori a les classes filles (o subclasses). Modifica la soluci\u00f3 a l'activitat anterior amb la nova jerarquia de classes.","title":"POO B\u00e0sic"},{"location":"03-phpoo/0399-activities/#errors-i-excepcions","text":"320-error-handling : modifica l'activitat 303, Empleat.php de forma en cas que el sou siga negatiu llance una excepci\u00f3 amb el missage \"El sou no pot ser negatiu\". Captura l'excepci\u00f3 i mostra el missatge. 321-error-handling : modifica l'activitat anterior llan\u00e7ant en esta ocasi\u00f3 una excepci\u00f3 personalitzada InvalidWageException amb el missatge per defecte \"El sou no pot ser negatiu\". Captura l'exceptic\u00f3 i mostra el missatge.","title":"Errors i excepcions"},{"location":"03-phpoo/0399-activities/#projecte-truiter","text":"En les seg\u00fcents activitats anem a posar en marxa el que ser\u00e0 el nostre projecte. Cal tenir en compte que es tracta d'un projecte de caracter did\u00e0ctic, aix\u00ed que algunes coses poden no ser del tot correctes des del punt de vista de la qualitat del codi. Per al projecte disposarem de la seg\u00fcent estructura de directoris: . \u251c\u2500\u2500 index.php \u251c\u2500\u2500 src \u2514\u2500\u2500 views src contindr\u00e0 les classes i views les vistes. Crea una classe per representar usuaris ( User ). Aquesta classe contindr\u00e0 les propietats necess\u00e0ries per a emmagatzemar un usuari de l'aplicaci\u00f3. El constructor rebr\u00e0 com a par\u00e0metres el nom i el nom d'usuari. En el cos del constructor assigna a la data de creaci\u00f3 la data actual. Codi de prova <?php // index.php $user = new User ( 'Bart Simpson' , 'bart' ); ?> < p > <? = $user -> getName () ?> (@ <? = $user -> getUsername () ?> ) - Creation date: <? = $user -> getCreatedAt () -> format ( 'd-m-Y h:i:s' ) ?> </ p > Navegador Bart Simpson (@bart) - Creation date: 11-10-2022 10:24:27 Crea una classe per representar tweets ( Tweet ). Aquesta classe contindr\u00e0 les propietats necess\u00e0ries per a emmagatzemar un tweet. Crea els setters i els getters . El constructor rebr\u00e0 com a par\u00e0metres el text i l'autor. En el cos del constructor assigna a la data de creaci\u00f3 la data actual i al n\u00famero de likes 0. classDiagram direction LR class Tweet { -text: string -createdAt: DateTime -attachments: array -author: User -likeCount: int __construct(text: string, user: User) } class User { createdAt: DateTime name: string verified: bool username: string __construct(user: string, username: string) } Tweet \"1\"--\"1\" User Codi de prova <? $user = new User ( 'Bart Simpson' , 'bart' ); // fem un delay de 4 segons perqu\u00e8 les dates de creaci\u00f3 no coincidisquen sleep ( 4 ); $tweet = new Tweet ( 'Hola m\u00f3n!' , $user ); ?> < h2 > Users </ h2 > < p > <? = $user -> getName () ?> (@ <? = $user -> getUsername () ?> ) - Creation date: <? = $user -> getCreatedAt () -> format ( 'd-m-Y h:i:s' ) ?> </ p > < h2 > Tweets </ h2 > <?php $tweetUser = $tweet -> getAuthor () ?> < p > <? = $tweetUser -> getName () ?> (@ <? = $tweetUser -> getUsername () ?> ) - Creation date: <? = $tweet -> getCreatedAt () -> format ( 'd-m-Y h:i:s' ) ?> </ p > < p > <? = $tweet -> getText () ?> </ p > < p > <? = $tweet -> getLikeCount () ?> </ p > < hr /> Navegador Users Bart Simpson (@bart) - Creation date: 12-10-2022 10:42:51 Tweets Bart Simpson (@bart) - Creation date: 12-10-2022 10:42:55 Hola m\u00f3n! Like counter: 0 Crea la seg\u00fcent jerarquia de classes que represent els diferents tipus de mitj\u00e0 que poden adjuntar a un tuit: classDiagram direction BT class Media { < < abstract >> __construct(caption, width, height) -caption: string -width: int -height: int getHeight() int getWidth() int getSummary()* string setHeight(height) getCaption() string setCaption(caption) setWidth(width) } class Photo { __construct(caption, width, height, altText) -altText :string getSummary() string getAltText() setAltText(altText) } class Video { __construct(caption, width, height, duration) -duration: int setDuration(duration) getSummary() string getDuration() int } Photo --> Media Video --> Media Codi de prova <?php // index.php ... $video = new Video ( 'V\u00eddeo 1' , 1080 , 1024 , 25 ); $photo = new Photo ( 'Foto 1' , 800 , 600 , 'Text alternatiu' ); ?> < h2 > Media </ h2 > ... <? = $video -> getSummary (); ?> <? = $photo -> getSummary (); ?> Navegador Media V\u00eddeo 1 [1080x1024] (25 s) Foto 1 (Text alternatiu) [800x600] Arribats a aquest punt anem a relacionar totes les classes que hem creat mitjan\u00e7ant la classe Twitter . Crea la classe representada en el gr\u00e0fic tenint en compte que users \u00e9s un array d'usuaris, tweets \u00e9s un array de tuits i attachements un array de mitjans. S'han omitit algunes propietats i m\u00e8todes per simplicar el diagrama UML. classDiagram direction LR class Twitter { - tweets: array - users: array - numberOfTweets: int - numberOfUsers: int + __construct() + likeTweet(user, tweet) void + addTweet(tweet) void + setTweets(tweets) void + getNumberOfUsers() int + setNumberOfUsers(numberOfUsers) void + getTweets() array + addUser(user) void + setNumberOfTweets(numberOfTweets) void + setUsers(users) void + getNumberOfTweets() int + getUsers() array } class User { } class Tweet { - attachments: array + getAttachments() array + addAttachment(media) void } class Media { < < abstract >> } class Photo { } class Video { } Twitter \"0\" -- \"*\" Tweet Tweet \"0\" -- \"*\" Media Twitter \"0\" -- \"*\" User Photo --> Media Video --> Media Codi de prova <?php $twitter = new Twitter (); $user = new User ( 'Bart Simpson' , 'bart' ); $twitter -> addUser ( $user ); // fem un delay de 4 segons perqu\u00e8 les dates de creaci\u00f3 no coincidisquen sleep ( 4 ); $userH = new User ( 'Homer Simpson' , 'homerj' ); $twitter -> addUser ( $userH ); $users = $twitter -> getUsers (); sleep ( 4 ); $tweet = new Tweet ( 'Hola m\u00f3n!' , $user ); $video = new Video ( 'V\u00eddeo 1' , 1080 , 1024 , 25 ); $photo = new Photo ( 'Foto 1' , 1080 , 1024 , 'Text alternatiu' ); $tweet -> addAttachment ( $video ); $tweet -> addAttachment ( $photo ); $twitter -> addTweet ( $tweet ); $twitter -> LikeTweet ( $user , $tweet ); $twitter -> LikeTweet ( $userH , $tweet ); $tweet = new Tweet ( \"Kids, just because I don\u2019t care doesn\u2019t mean I\u2019m not listening.\" , $userH ); $twitter -> addTweet ( $tweet ); $tweet = new Tweet ( \"I\u2019ve learned that life is one crushing defeat after another until you just wish Flanders was dead.\" , $userH ); $twitter -> addTweet ( $tweet ); $tweets = $twitter -> getTweets (); ?> < h1 > Welcome to Truiter </ h1 > < p > <? = $twitter -> getNumberOfUsers () ?> users, <? = $twitter -> getNumberOfTweets () ?> tweets. </ p > < h2 > Users </ h2 > <?php foreach ( $users as $user ) : ?> < p > <? = $user -> getName () ?> (@ <? = $user -> getUsername () ?> ) - Creation date: <? = $user -> getCreatedAt () -> format ( 'd-m-Y h:i:s' ) ?> </ p > <?php endforeach ; ?> < h2 > Tweets </ h2 > <?php foreach ( $tweets as $tweet ) : ?> <?php $tweetUser = $tweet -> getAuthor () ?> < p > <? = $tweetUser -> getName () ?> (@ <? = $tweetUser -> getUsername () ?> ) - Creation date: <? = $tweet -> getCreatedAt () -> format ( 'd-m-Y h:i:s' ) ?> </ p > < blockquote > <? = $tweet -> getText () ?> </ blockquote > < p > Like counter: <? = $tweet -> getLikeCount (); ?> </ p > <?php if ( count ( $tweet -> getAttachments ()) > 0 ) : ?> < h3 > Attachments </ h3 > < ul > <?php foreach ( $tweet -> getAttachments () as $attachment ) : ?> < li > <? = $attachment -> getSummary () ?> </ li > <?php endforeach ; ?> </ ul > <?php endif ; ?> < hr /> <?php endforeach ; ?> Navegador Welcome to Truiter 2 users, 3 tweets. Users Bart Simpson (@bart) - Creation date: 13-10-2022 09:45:52 Homer Simpson (@homerj) - Creation date: 13-10-2022 09:45:56 Tweets Bart Simpson (@bart) - Creation date: 13-10-2022 09:46:00 Hola m\u00f3n! Like counter: 2 Attachments - V\u00eddeo 1 [1080x1024] ( 25 s) - Foto 1 (Text alternatiu) [1080x1024] Homer Simpson (@homerj) - Creation date: 13-10-2022 09:46:00 Kids, just because I don\u2019t care doesn\u2019t mean I\u2019m not listening. Like counter: 0 Homer Simpson (@homerj) - Creation date: 13-10-2022 09:46:00 I\u2019ve learned that life is one crushing defeat after another until you just wish Flanders was dead. Like counter: 0 Implementa la c\u00e0rrega autom\u00e0tica (autoload) de classes tenint en compte que: Les classes estaran en el directori src/App . L'espai de noms ser\u00e0 App. Crea les excepcions InvalidWidthMediaException i InvalidHeightMediaException que es llan\u00e7aran quan alguna de les dimensions dels mitjans siga inferior a 300 p\u00edxels. Guarda-les en el directori src/App/Exceptions amb el namespace corresponent.","title":"Projecte: Truiter"},{"location":"04-web-programming/04-01-forms/","text":"Processament de formularis Fins ara ens hem centrat a con\u00e8ixer les caracter\u00edstiques del llenguatge PHP. En aquesta unitat posarem el focus en les caracter\u00edstiques pr\u00f2pies de les aplicacions web i com podem gestionar-les amb PHP. Aix\u00ed, veurem com enviar informaci\u00f3 mitjan\u00e7ant formularis, com processar-la i com podem mantenir informaci\u00f3 entre sol\u00b7licituds, \u00e9s a dir, mantenir l'estat. Variables predefinides Les variables predefinides s\u00f3n variables internes de PHP que poden usar-se des de qualsevol \u00e0mbit, per aix\u00f2 s'anomenen variables superglobals . Es tracta d' arrays associatius que contenen un conjunt de valors. $_SERVER . Cont\u00e9 informaci\u00f3 sobre l'entorn del servidor web i d'execuci\u00f3. $_GET, $_POST i $_COOKIE contenen les variables que s'han passat al script actual utilitzant, respectivament, els m\u00e8todes GET (par\u00e0metres en la URL), HTTP POST i Cookies HTTP $_REQUEST junta en un solament el contingut dels tres *arrays anteriors, $_GET , $_POST i $_COOKIE . $_ENV cont\u00e9 les variables que es puguen haver passat a PHP des de l'entorn en qu\u00e8 s'executa. $_FILES cont\u00e9 els fitxers que es puguen haver pujat al servidor utilitzant el m\u00e8tode POST. $_SESSION cont\u00e9 les variables de sessi\u00f3 disponibles per al gui\u00f3 actual. http://es.php.net/manual/es/language.variables.superglobals.php Qu\u00e8 \u00e9s una petici\u00f3 HTTP? Una petici\u00f3 HTTP \u00e9s una sol\u00b7licitud d'un recurs a un servidor. La petici\u00f3 es realitza a trav\u00e9s d'unes URL. Amb la petici\u00f3 s'envien tamb\u00e9 par\u00e0metres. Hi ha diferents m\u00e8todes ( METHOD ) per a realitzar una petici\u00f3 ( GET , POST , PUT , DELETE , PATCH , etc.). Els m\u00e9s habituals s\u00f3n GET , que ja coneixes, i POST . La resta s\u00f3n m\u00e9s utilitzats en les RESTful API. M\u00e8tode GET El m\u00e8todo de sol\u00b7licitud GET t\u00e9 les seg\u00fcents caracter\u00edstiques: S'utilitza per a sol\u00b7licitar dades d'un recurs. Mostren els par\u00e0metres que s'envien en la url. Es poden utilitzar directament en enlla\u00e7os. El resultat es pot emmagatzemar en cache. Romanen en l'historial del navegador. La grand\u00e0ria dels par\u00e0metres est\u00e0 limitat a 2048 car\u00e0cters. Exemple de petici\u00f3 GET Inspecci\u00f3 de la petici\u00f3 Inspecci\u00f3 de la petici\u00f3 Accedir a les dades de la petici\u00f3 GET Per a accedir a les dades usem la variable superglobal $_GET . $_GET \u00e9s un array associatiu les claus del qual coincidiran amb els noms que li hem donat als par\u00e0metres. Per a accedir als par\u00e0metres de la petici\u00f3 anterior: echo $_GET [ 'nom' ] . ' ' . $_GET [ 'cognom' ]; // Homer Simpson M\u00e8tode POST El m\u00e8tode POST t\u00e9 les seg\u00fcents caracter\u00edstiques: S'utilitza per a enviar dades a un recurs. Els par\u00e0metres van en el cos de la petici\u00f3, no s\u00f3n visibles per a l'usuari. La petici\u00f3 no es guarda en cau. No es pot utilitzar en un enlla\u00e7. No roman en l'historial. No tenim la limitaci\u00f3 de grand\u00e0ria dels par\u00e0metres. Es solen utilitzar en els formularis. Evitar el CSRF En tota p\u00e0gina que reba par\u00e0metres POST has de comprovar el HTTP referer del navegador, i que aquest siga de dins de la teua web. En PHP el referer que envia el navegador s'emmagatzema en $_SERVER['HTTP_REFERER'] . \u00c9s a dir, sols processarem peticions que vinguen del teu lloc web. M\u00e9s informaci\u00f3 En el seg\u00fcent enlla\u00e7 trobareu m\u00e9s informaci\u00f3 relativa als atacs CSRF CSRF: explicaci\u00f3n del ataque Cross Site Request Forgery Seria tal com: if ( parse_url ( $_SERVER [ 'HTTP_REFERER' ], PHP_URL_HOST ) != $_SERVER [ 'HTTP_HOST' ]) die ( 'Anti-CSRF' ); Important Amb aquest codi estem obligant que el navegador envie un referer si o s\u00ed. Per tant nom\u00e9s ha d'utilitzar-se en p\u00e0gines a les quals el navegador accedisca des d'una altra p\u00e0gina de la nostra web. \u00d2bviament no podem col\u00b7locar-ho en la primera p\u00e0gina a la qual s'accedeix a la nostra web ( index.php o similar), ja que si l'usuari a escrit l'adre\u00e7a a m\u00e0 en la barra del navegador no s'enviar\u00e0 referer cap i saltar\u00e0 el sistema. Definici\u00f3 de formularis Com hem dit abans el m\u00e8tode POST s'empra en els formularis. El formulari seg\u00fcent enviar\u00e0 les dades a la p\u00e0gina index.php (atribut action de l'element form ). Utilitza el m\u00e8tode post indicat en l'atribut method : < form action = \"index.php\" method = \"post\" > < label for = \"nom\" > Nom </ label > < input type = \"text\" name = \"nom\" value = \"\" > < br /> < label for = \"cognom\" > Cognom </ label > < input type = \"text\" name = \"cognom\" value = \"\" > < br /> < input type = \"submit\" value = \"Enviar\" > </ form > Inspecci\u00f3 de la petici\u00f3: Headers Inspecci\u00f3 de la petici\u00f3: Param\u00e8tres Accedir a les dades de la petici\u00f3 POST Usem la variable superglobal $_POST . Funciona igual que $_GET , per\u00f2 amb els noms (atribut name ) que li hem donat als camps del formulari. En depuraci\u00f3 podem mostar totes les dades rebudes: var_dump ( $_POST ); print_r ( $_POST ) Per a mostrar les dades individualment: echo $_POST [ 'nom' ]; echo $_POST [ 'cognom' ]; Accedir a par\u00e0metres no existents Errors del tipus Notice: Undefined index: nom in /home/ubuntu/index.php on line 6 ens indiquen que la clau nom no existeix en l'array $_POST . La variable supergloblal $_POST est\u00e0 buida si no s'ha enviat el formulari. Per a evitar aquest tipus d'errors \u00e9s important verificar que s'haja enviat el formulari pr\u00e8viament: if ( $_SERVER [ 'REQUEST_METHOD' ] === 'POST' ) { } Par\u00e0metres multivalents Hi ha elements HTML que envien diversos valors: - select multiple - checkbox Per recollir les dades, el nom de l\u2019element ha de ser una matriu ( array ). < select name = \"lenguajes[]\" multiple = \"true\" > < option value = \"c\" > C </ option > < option value = \"java\" > Java </ option > < option value = \"php\" > PHP </ option > < option value = \"python\" > Python </ option > </ select > < input type = \"checkbox\" name = \"lenguajes[]\" value = \"c\" /> C < br /> < input type = \"checkbox\" name = \"lenguajes[]\" value = \"java\" /> Java < br /> < input type = \"checkbox\" name = \"lenguajes[]\" value = \"php\" /> Php < br /> < input type = \"checkbox\" name = \"lenguajes[]\" value = \"python\" /> Python < br /> Aix\u00ed doncs, recopilant les dades: <?php $lenguajes = $_GET [ \"lenguajes\" ]; foreach ( $lenguajes as $lenguaje ) { echo \" $lenguaje <br />\" ; } Validaci\u00f3 de formularis Sempre hem de comprovar que les dades que envia el formulari s\u00f3n correctes. Les validacions a realitzar s\u00f3n les seg\u00fcents: Els camps requerits no han de quedar buits. Ni contenir espais en blanc a l'inici i al final. Els camps correu electr\u00f2nic, data o URL han de tenir el format esperat. Tots els camps s'han de filtrar amb htmlspecialchars per a evitar atacs de Cross-site Scripting (XSS). Aquest article sobre Cross-site Scripting \u00e9s molt il\u00b7lustratiu: PHP Form Validation Validem en el client o el servidor? La resposta \u00e9s senzilla: en els dos llocs. La validaci\u00f3 en el client millora la usabilitat mentre que la validaci\u00f3 en el servidor ens permet una validaci\u00f3 m\u00e9s robusta i segura. Valors buits Els camps requerits no haurien de quedar-se buits. Per a verificar que un valor no queda buit podem utilitzar diverses funcions: La funci\u00f3 empty() La funci\u00f3 isset() . L'operador coalesce ?? . Espais en blanc Hem d'eliminar els espais en blanc del principi i final dels camps. S'utilitza la funci\u00f3 trim Escapar l'entrada Sempre hem de filtrar l'entrada amb htmlspecialchars abans de mostrar el camp amb echo o similar. Ac\u00f2 convertir\u00e0 qualsevol car\u00e0cter especial d'HTMLl en l'entitat corresponent, aix\u00ed no interferir\u00e0 en el programa. Comprovar l'email Per a verificar si un email \u00e9s correcte podem utilitzar la funci\u00f3 filter_var filter_var ( $email , FILTER_VALIDATE_EMAIL ) o la funci\u00f3 filter_input quan obtenin les dades directament d'una variable externa. // suposem que rebem les dades d'un formulari que t\u00e9 un quadre de text de nom 'email' $email = filter_input ( INPUT_POST , 'email' , FILTER_VALIDATE_EMAIL ) filter_input filter_input ( int $type , string $variable_name [, int $filter = FILTER_DEFAULT [, mixed $options ]]) : mixed La funci\u00f3 filter_input agafa una variable externa ( $_GET , $_POST , etc) concreta pel seu nom i aplica el filtre indicat. Els filtres poden sanejar o validar les variables externes. Per exemple, si volem agafar el valor del par\u00e0metre nom del querystring ( http://localhost/index.php?nom=<h1>Homer</h1> ) usarem el tipus INPUT_GET . El filtre FILTER_SANITIZE_STRING elimina etiquetes, i opcionalment elimina o codifica caracters especials. $nom = filter_input ( INPUT_GET , 'nom' , FILTER_SANITIZE_STRING ) . // $nom = Homer M\u00e9s informaci\u00f3 en: filter_var filter_input Comprovar la data Per a comprovar la data hem de crear una funci\u00f3 a aquest efecte. Podem utilitzar el m\u00e8tode est\u00e0tic createFromFormat de la classe DateTime M\u00e9s informaci\u00f3: http://php.net/manual/es/datetime.createfromformat.php Exemple $data1 = \"2001-05-02\" ; // Data \u00e9s de tipus string // DateTime::createFromFormat converteix una cadena de text a on objecte DateTime // ens tornar\u00e0 una inst\u00e0ncia de DateTime o FALSE en cas d'error. $dt1 = DateTime :: createFromFormat ( 'Y-m-d' , $data1 ); if ( $dt1 === false ) { echo \"La data d'inici \u00e9s incorrecta\" ; } https://www.php.net/manual/es/function.strtotime.php Tamb\u00e9 \u00e9s habitual trobar els controls de data separats en 3 elements input . Un per a l\u2019any, l\u2019altre per a mes i l\u2019altre per al dia. Bones pr\u00e0ctiques en l\u2019obtenci\u00f3 de dades des de l\u2019exterior Cal seguir les seg\u00fcents bones pr\u00e0ctiques: No confieu mai (mai) en l\u2019entrada des de l\u2019exterior del vostre PHP. Sanegeu i valideu l\u2019entrada de dades sempre. Les funcions filter_var() i filter_input() poden sanejar el text i validar els formats de text (per exemple, adreces de correu electr\u00f2nic, enters). Recordeu que l\u2019entrada de dades no es limita a formularis enviats per l\u2019usuari. Els fitxers carregats i descarregats, els valors de sessi\u00f3, les dades de galetes i les dades de serveis web de tercers tamb\u00e9 s\u00f3n dades que venen de l'exterior. A manera de resum pod\u00edem resumir la gesti\u00f3 de formularis en el seg\u00fcent diagrama de flux. En els seg\u00fcents recursos trobar\u00e0s informaci\u00f3 addicional sobre els controls de formularis en HTML5: Formularios en HTML en MDN web docs. Formularios en HTML5 en MDN web docs. HTML Forms en W3CSchools. Reomplint un formulari Un sticky form \u00e9s un formulari que recorda els seus valors. Per fer -ho, hem d\u2019omplir els atributs de valor dels elements HTML amb la informaci\u00f3 que contenia: <?php if ( ! empty ( $_POST [ 'modulos' ]) && ! empty ( $_POST [ 'nombre' ])) { // Aqu\u00ed se incluye el c\u00f3digo a ejecutar cuando los datos son correctos } else { // Generamos el formulario $nombre = $_POST [ 'nombre' ] ?? \"\" ; $modulos = $_POST [ 'modulos' ] ?? []; ?> < form action = \" <?php echo $_SERVER [ 'PHP_SELF' ]; ?> \" method = \"POST\" > < p >< label for = \"nombre\" > Nombre del alumno: </ label > < input type = \"text\" name = \"nombre\" id = \"nombre\" value = \" <? = $nombre ?> \" /> </ p > < p >< input type = \"checkbox\" name = \"modulos[]\" id = \"modulosDWES\" value = \"DWES\" <?php if ( in_array ( \"DWES\" , $modulos )) echo 'checked=\"checked\"' ; ?> /> < label for = \"modulosDWES\" > Desarrollo web en entorno servidor </ label > </ p > < p >< input type = \"checkbox\" name = \"modulos[]\" id = \"modulosDWEC\" value = \"DWEC\" <?php if ( in_array ( \"DWEC\" , $modulos )) echo 'checked=\"checked\"' ; ?> /> < label for = \"modulosDWEC\" > Desarrollo web en entorno cliente </ label > </ p > < input type = \"submit\" value = \"Enviar\" name = \"enviar\" /> </ form > <?php } ?> Pujada de fitxers Per a pujar fitxers PHP implementa un mecanisme senzill a trav\u00e9s de la variable superglobal $_FILES . En Pujada d'arxius disposeu de tota la informaci\u00f3 necess\u00e0ria per a gestionar la pujada d'arxius. Formulari Per poder utilitzar el tipus file en l'element input cal que el formulari incloga l'atribut enctype amb el valor multipart/form-data . El valor de l'atribut name de l'element input ser\u00e0 l'\u00edndex de l'array associatiu $_FILES que ens permetr\u00e0 obtenir tota la informaci\u00f3 del proc\u00e9s de pujada del fitxer. En el seg\u00fcent exemple: < form action = \"upload.php\" enctype = \"multipart/form-data\" method = \"POST\" > < input type = \"hidden\" name = \"MAX_FILE_SIZE\" value = \"10240\" > < input type = \"file\" name = \"image\" /> < input type = \"submit\" value = \"Upload\" /> </ form > Emprarem $_FILES['image'] per obtenir les dades de l'arxiu penjat. Variable superglobal $_FILES Cada element en $_FILES \u00e9s un array que aporta informaci\u00f3 sobre el fitxer pujat. Les claus m\u00e9s importants s\u00f3n: name . El nom original del fitxer pujat. No \u00e9s massa \u00fatil perqu\u00e8 el sistema original pot tindre convencions diferents i pot generar col\u00b7lisions si l'utilitzem per a emmagatzemar-lo en la seua ubicaci\u00f3 definitiva. type . El tipus MIME del fitxer dedu\u00eft pel navegador. size . La grand\u00e0ria en bytes del fitxer. Si el fitxer \u00e9s massa gran el valor enviat ser\u00e0 0. tmp_name . El nom temporal del fitxer en el servidor on s'ha emmagatzemat el fitxer pujat. Moure el fitxer Com que el fitxer pujat es guarda en una carpeta temporal hem d'emprar la funci\u00f3 move_uploaded_file per a guardar-lo en la ubicaci\u00f3 definitiva. La funci\u00f3 is_uploaded_file ens permet a assegurar-nos que el fitxer ha estat pujat usant HTTP POST i no es tracta d'un fitxer malici\u00f3s. move_uploaded_file ja fa eixa comprovaci\u00f3 en executar-se. Gesti\u00f3 d'errors PHP torna un codi d'error en $_FILES . El codi es pot trabar en la clau error . Per exemple: $_FILES['image']['error'] . Els missates d'error m\u00e9s importants s\u00f3n: UPLOAD_ERR_OK : La pujada ha sigut correcta. UPLOAD_ERR_INI_SIZE : La grand\u00e0ria del fitxer que s'intenta pujar \u00e9s major que el valor indicat en la directiva upload_max_filesize . UPLOAD_ERR_FORM_SIZE : La grand\u00e0ria del fitxer que s'intenta pujar \u00e9s major que el valor indicat en el formulari en max_file_size . UPLOAD_ERR_NO_FILE : No s'ha enviat cap fitxer. En Explicaci\u00f3 dels missatges d'error teniu m\u00e9s informaci\u00f3.","title":"Formularis"},{"location":"04-web-programming/04-01-forms/#processament-de-formularis","text":"Fins ara ens hem centrat a con\u00e8ixer les caracter\u00edstiques del llenguatge PHP. En aquesta unitat posarem el focus en les caracter\u00edstiques pr\u00f2pies de les aplicacions web i com podem gestionar-les amb PHP. Aix\u00ed, veurem com enviar informaci\u00f3 mitjan\u00e7ant formularis, com processar-la i com podem mantenir informaci\u00f3 entre sol\u00b7licituds, \u00e9s a dir, mantenir l'estat.","title":"Processament de formularis"},{"location":"04-web-programming/04-01-forms/#variables-predefinides","text":"Les variables predefinides s\u00f3n variables internes de PHP que poden usar-se des de qualsevol \u00e0mbit, per aix\u00f2 s'anomenen variables superglobals . Es tracta d' arrays associatius que contenen un conjunt de valors. $_SERVER . Cont\u00e9 informaci\u00f3 sobre l'entorn del servidor web i d'execuci\u00f3. $_GET, $_POST i $_COOKIE contenen les variables que s'han passat al script actual utilitzant, respectivament, els m\u00e8todes GET (par\u00e0metres en la URL), HTTP POST i Cookies HTTP $_REQUEST junta en un solament el contingut dels tres *arrays anteriors, $_GET , $_POST i $_COOKIE . $_ENV cont\u00e9 les variables que es puguen haver passat a PHP des de l'entorn en qu\u00e8 s'executa. $_FILES cont\u00e9 els fitxers que es puguen haver pujat al servidor utilitzant el m\u00e8tode POST. $_SESSION cont\u00e9 les variables de sessi\u00f3 disponibles per al gui\u00f3 actual. http://es.php.net/manual/es/language.variables.superglobals.php","title":"Variables predefinides"},{"location":"04-web-programming/04-01-forms/#que-es-una-peticio-http","text":"Una petici\u00f3 HTTP \u00e9s una sol\u00b7licitud d'un recurs a un servidor. La petici\u00f3 es realitza a trav\u00e9s d'unes URL. Amb la petici\u00f3 s'envien tamb\u00e9 par\u00e0metres. Hi ha diferents m\u00e8todes ( METHOD ) per a realitzar una petici\u00f3 ( GET , POST , PUT , DELETE , PATCH , etc.). Els m\u00e9s habituals s\u00f3n GET , que ja coneixes, i POST . La resta s\u00f3n m\u00e9s utilitzats en les RESTful API.","title":"Qu\u00e8 \u00e9s una petici\u00f3 HTTP?"},{"location":"04-web-programming/04-01-forms/#metode-get","text":"El m\u00e8todo de sol\u00b7licitud GET t\u00e9 les seg\u00fcents caracter\u00edstiques: S'utilitza per a sol\u00b7licitar dades d'un recurs. Mostren els par\u00e0metres que s'envien en la url. Es poden utilitzar directament en enlla\u00e7os. El resultat es pot emmagatzemar en cache. Romanen en l'historial del navegador. La grand\u00e0ria dels par\u00e0metres est\u00e0 limitat a 2048 car\u00e0cters. Exemple de petici\u00f3 GET Inspecci\u00f3 de la petici\u00f3 Inspecci\u00f3 de la petici\u00f3","title":"M\u00e8tode GET"},{"location":"04-web-programming/04-01-forms/#accedir-a-les-dades-de-la-peticio-get","text":"Per a accedir a les dades usem la variable superglobal $_GET . $_GET \u00e9s un array associatiu les claus del qual coincidiran amb els noms que li hem donat als par\u00e0metres. Per a accedir als par\u00e0metres de la petici\u00f3 anterior: echo $_GET [ 'nom' ] . ' ' . $_GET [ 'cognom' ]; // Homer Simpson","title":"Accedir a les dades de la petici\u00f3 GET"},{"location":"04-web-programming/04-01-forms/#metode-post","text":"El m\u00e8tode POST t\u00e9 les seg\u00fcents caracter\u00edstiques: S'utilitza per a enviar dades a un recurs. Els par\u00e0metres van en el cos de la petici\u00f3, no s\u00f3n visibles per a l'usuari. La petici\u00f3 no es guarda en cau. No es pot utilitzar en un enlla\u00e7. No roman en l'historial. No tenim la limitaci\u00f3 de grand\u00e0ria dels par\u00e0metres. Es solen utilitzar en els formularis.","title":"M\u00e8tode POST"},{"location":"04-web-programming/04-01-forms/#evitar-el-csrf","text":"En tota p\u00e0gina que reba par\u00e0metres POST has de comprovar el HTTP referer del navegador, i que aquest siga de dins de la teua web. En PHP el referer que envia el navegador s'emmagatzema en $_SERVER['HTTP_REFERER'] . \u00c9s a dir, sols processarem peticions que vinguen del teu lloc web. M\u00e9s informaci\u00f3 En el seg\u00fcent enlla\u00e7 trobareu m\u00e9s informaci\u00f3 relativa als atacs CSRF CSRF: explicaci\u00f3n del ataque Cross Site Request Forgery Seria tal com: if ( parse_url ( $_SERVER [ 'HTTP_REFERER' ], PHP_URL_HOST ) != $_SERVER [ 'HTTP_HOST' ]) die ( 'Anti-CSRF' ); Important Amb aquest codi estem obligant que el navegador envie un referer si o s\u00ed. Per tant nom\u00e9s ha d'utilitzar-se en p\u00e0gines a les quals el navegador accedisca des d'una altra p\u00e0gina de la nostra web. \u00d2bviament no podem col\u00b7locar-ho en la primera p\u00e0gina a la qual s'accedeix a la nostra web ( index.php o similar), ja que si l'usuari a escrit l'adre\u00e7a a m\u00e0 en la barra del navegador no s'enviar\u00e0 referer cap i saltar\u00e0 el sistema.","title":"Evitar el CSRF"},{"location":"04-web-programming/04-01-forms/#definicio-de-formularis","text":"Com hem dit abans el m\u00e8tode POST s'empra en els formularis. El formulari seg\u00fcent enviar\u00e0 les dades a la p\u00e0gina index.php (atribut action de l'element form ). Utilitza el m\u00e8tode post indicat en l'atribut method : < form action = \"index.php\" method = \"post\" > < label for = \"nom\" > Nom </ label > < input type = \"text\" name = \"nom\" value = \"\" > < br /> < label for = \"cognom\" > Cognom </ label > < input type = \"text\" name = \"cognom\" value = \"\" > < br /> < input type = \"submit\" value = \"Enviar\" > </ form > Inspecci\u00f3 de la petici\u00f3: Headers Inspecci\u00f3 de la petici\u00f3: Param\u00e8tres","title":"Definici\u00f3 de formularis"},{"location":"04-web-programming/04-01-forms/#accedir-a-les-dades-de-la-peticio-post","text":"Usem la variable superglobal $_POST . Funciona igual que $_GET , per\u00f2 amb els noms (atribut name ) que li hem donat als camps del formulari. En depuraci\u00f3 podem mostar totes les dades rebudes: var_dump ( $_POST ); print_r ( $_POST ) Per a mostrar les dades individualment: echo $_POST [ 'nom' ]; echo $_POST [ 'cognom' ];","title":"Accedir a les dades de la petici\u00f3 POST"},{"location":"04-web-programming/04-01-forms/#accedir-a-parametres-no-existents","text":"Errors del tipus Notice: Undefined index: nom in /home/ubuntu/index.php on line 6 ens indiquen que la clau nom no existeix en l'array $_POST . La variable supergloblal $_POST est\u00e0 buida si no s'ha enviat el formulari. Per a evitar aquest tipus d'errors \u00e9s important verificar que s'haja enviat el formulari pr\u00e8viament: if ( $_SERVER [ 'REQUEST_METHOD' ] === 'POST' ) { }","title":"Accedir a par\u00e0metres no existents"},{"location":"04-web-programming/04-01-forms/#parametres-multivalents","text":"Hi ha elements HTML que envien diversos valors: - select multiple - checkbox Per recollir les dades, el nom de l\u2019element ha de ser una matriu ( array ). < select name = \"lenguajes[]\" multiple = \"true\" > < option value = \"c\" > C </ option > < option value = \"java\" > Java </ option > < option value = \"php\" > PHP </ option > < option value = \"python\" > Python </ option > </ select > < input type = \"checkbox\" name = \"lenguajes[]\" value = \"c\" /> C < br /> < input type = \"checkbox\" name = \"lenguajes[]\" value = \"java\" /> Java < br /> < input type = \"checkbox\" name = \"lenguajes[]\" value = \"php\" /> Php < br /> < input type = \"checkbox\" name = \"lenguajes[]\" value = \"python\" /> Python < br /> Aix\u00ed doncs, recopilant les dades: <?php $lenguajes = $_GET [ \"lenguajes\" ]; foreach ( $lenguajes as $lenguaje ) { echo \" $lenguaje <br />\" ; }","title":"Par\u00e0metres multivalents"},{"location":"04-web-programming/04-01-forms/#validacio-de-formularis","text":"Sempre hem de comprovar que les dades que envia el formulari s\u00f3n correctes. Les validacions a realitzar s\u00f3n les seg\u00fcents: Els camps requerits no han de quedar buits. Ni contenir espais en blanc a l'inici i al final. Els camps correu electr\u00f2nic, data o URL han de tenir el format esperat. Tots els camps s'han de filtrar amb htmlspecialchars per a evitar atacs de Cross-site Scripting (XSS). Aquest article sobre Cross-site Scripting \u00e9s molt il\u00b7lustratiu: PHP Form Validation Validem en el client o el servidor? La resposta \u00e9s senzilla: en els dos llocs. La validaci\u00f3 en el client millora la usabilitat mentre que la validaci\u00f3 en el servidor ens permet una validaci\u00f3 m\u00e9s robusta i segura.","title":"Validaci\u00f3 de formularis"},{"location":"04-web-programming/04-01-forms/#bones-practiques-en-lobtencio-de-dades-des-de-lexterior","text":"Cal seguir les seg\u00fcents bones pr\u00e0ctiques: No confieu mai (mai) en l\u2019entrada des de l\u2019exterior del vostre PHP. Sanegeu i valideu l\u2019entrada de dades sempre. Les funcions filter_var() i filter_input() poden sanejar el text i validar els formats de text (per exemple, adreces de correu electr\u00f2nic, enters). Recordeu que l\u2019entrada de dades no es limita a formularis enviats per l\u2019usuari. Els fitxers carregats i descarregats, els valors de sessi\u00f3, les dades de galetes i les dades de serveis web de tercers tamb\u00e9 s\u00f3n dades que venen de l'exterior. A manera de resum pod\u00edem resumir la gesti\u00f3 de formularis en el seg\u00fcent diagrama de flux. En els seg\u00fcents recursos trobar\u00e0s informaci\u00f3 addicional sobre els controls de formularis en HTML5: Formularios en HTML en MDN web docs. Formularios en HTML5 en MDN web docs. HTML Forms en W3CSchools.","title":"Bones pr\u00e0ctiques en l\u2019obtenci\u00f3 de dades des de l\u2019exterior"},{"location":"04-web-programming/04-01-forms/#reomplint-un-formulari","text":"Un sticky form \u00e9s un formulari que recorda els seus valors. Per fer -ho, hem d\u2019omplir els atributs de valor dels elements HTML amb la informaci\u00f3 que contenia: <?php if ( ! empty ( $_POST [ 'modulos' ]) && ! empty ( $_POST [ 'nombre' ])) { // Aqu\u00ed se incluye el c\u00f3digo a ejecutar cuando los datos son correctos } else { // Generamos el formulario $nombre = $_POST [ 'nombre' ] ?? \"\" ; $modulos = $_POST [ 'modulos' ] ?? []; ?> < form action = \" <?php echo $_SERVER [ 'PHP_SELF' ]; ?> \" method = \"POST\" > < p >< label for = \"nombre\" > Nombre del alumno: </ label > < input type = \"text\" name = \"nombre\" id = \"nombre\" value = \" <? = $nombre ?> \" /> </ p > < p >< input type = \"checkbox\" name = \"modulos[]\" id = \"modulosDWES\" value = \"DWES\" <?php if ( in_array ( \"DWES\" , $modulos )) echo 'checked=\"checked\"' ; ?> /> < label for = \"modulosDWES\" > Desarrollo web en entorno servidor </ label > </ p > < p >< input type = \"checkbox\" name = \"modulos[]\" id = \"modulosDWEC\" value = \"DWEC\" <?php if ( in_array ( \"DWEC\" , $modulos )) echo 'checked=\"checked\"' ; ?> /> < label for = \"modulosDWEC\" > Desarrollo web en entorno cliente </ label > </ p > < input type = \"submit\" value = \"Enviar\" name = \"enviar\" /> </ form > <?php } ?>","title":"Reomplint un formulari"},{"location":"04-web-programming/04-01-forms/#pujada-de-fitxers","text":"Per a pujar fitxers PHP implementa un mecanisme senzill a trav\u00e9s de la variable superglobal $_FILES . En Pujada d'arxius disposeu de tota la informaci\u00f3 necess\u00e0ria per a gestionar la pujada d'arxius.","title":"Pujada de fitxers"},{"location":"04-web-programming/04-01-forms/#formulari","text":"Per poder utilitzar el tipus file en l'element input cal que el formulari incloga l'atribut enctype amb el valor multipart/form-data . El valor de l'atribut name de l'element input ser\u00e0 l'\u00edndex de l'array associatiu $_FILES que ens permetr\u00e0 obtenir tota la informaci\u00f3 del proc\u00e9s de pujada del fitxer. En el seg\u00fcent exemple: < form action = \"upload.php\" enctype = \"multipart/form-data\" method = \"POST\" > < input type = \"hidden\" name = \"MAX_FILE_SIZE\" value = \"10240\" > < input type = \"file\" name = \"image\" /> < input type = \"submit\" value = \"Upload\" /> </ form > Emprarem $_FILES['image'] per obtenir les dades de l'arxiu penjat.","title":"Formulari"},{"location":"04-web-programming/04-01-forms/#variable-superglobal-_files","text":"Cada element en $_FILES \u00e9s un array que aporta informaci\u00f3 sobre el fitxer pujat. Les claus m\u00e9s importants s\u00f3n: name . El nom original del fitxer pujat. No \u00e9s massa \u00fatil perqu\u00e8 el sistema original pot tindre convencions diferents i pot generar col\u00b7lisions si l'utilitzem per a emmagatzemar-lo en la seua ubicaci\u00f3 definitiva. type . El tipus MIME del fitxer dedu\u00eft pel navegador. size . La grand\u00e0ria en bytes del fitxer. Si el fitxer \u00e9s massa gran el valor enviat ser\u00e0 0. tmp_name . El nom temporal del fitxer en el servidor on s'ha emmagatzemat el fitxer pujat.","title":"Variable superglobal $_FILES"},{"location":"04-web-programming/04-01-forms/#moure-el-fitxer","text":"Com que el fitxer pujat es guarda en una carpeta temporal hem d'emprar la funci\u00f3 move_uploaded_file per a guardar-lo en la ubicaci\u00f3 definitiva. La funci\u00f3 is_uploaded_file ens permet a assegurar-nos que el fitxer ha estat pujat usant HTTP POST i no es tracta d'un fitxer malici\u00f3s. move_uploaded_file ja fa eixa comprovaci\u00f3 en executar-se.","title":"Moure el fitxer"},{"location":"04-web-programming/04-01-forms/#gestio-derrors","text":"PHP torna un codi d'error en $_FILES . El codi es pot trabar en la clau error . Per exemple: $_FILES['image']['error'] . Els missates d'error m\u00e9s importants s\u00f3n: UPLOAD_ERR_OK : La pujada ha sigut correcta. UPLOAD_ERR_INI_SIZE : La grand\u00e0ria del fitxer que s'intenta pujar \u00e9s major que el valor indicat en la directiva upload_max_filesize . UPLOAD_ERR_FORM_SIZE : La grand\u00e0ria del fitxer que s'intenta pujar \u00e9s major que el valor indicat en el formulari en max_file_size . UPLOAD_ERR_NO_FILE : No s'ha enviat cap fitxer. En Explicaci\u00f3 dels missatges d'error teniu m\u00e9s informaci\u00f3.","title":"Gesti\u00f3 d'errors"},{"location":"04-web-programming/04-02-state/","text":"Manteniment de l\u2019estat Recorda que HTTP \u00e9s un protocol sense estat, el que significa que un cop un servidor web completa la sol\u00b7licitud d\u2019un client d\u2019un recurs, la connexi\u00f3 entre els dos acaba. Dit d\u2019una altra manera, no hi ha manera que un servidor recorde una que una seq\u00fc\u00e8ncia de sol\u00b7licituds prov\u00e9 del mateix client. Info Mantenir l\u2019estat \u00e9s poder fer el seguiment d\u2019una sequ\u00e8ncia de sol\u00b7licituds d\u2019un client. No obstant aix\u00f2 mantenir l\u2019estat, poder fer el seguiment d\u2019una seq\u00fc\u00e8ncia de sol\u00b7licituds d\u2019un client, \u00e9s molt \u00fatil. No podeu crear una aplicaci\u00f3 que tinga cistella de la compra, per exemple, si no podeu mantenir l\u2019estat. Heu de saber quan un usuari afegeix articles a la cistella o els elimina i el contingut final de la cistella si el client decideix adquirir els productes. Per solucionar aquesta manca d\u2019estat de la web tenim disponibles diverses t\u00e8cniques com l\u2019\u00fas cookies o de sessions que veurem a continuaci\u00f3. Combinant mecanismes d\u2019autenticaci\u00f3 i t\u00e8cniques per a mantenir l\u2019estat podem crear aplicacions web segures. Galletes ( cookies ) Una galleta \u00e9s un fitxer de text que un lloc web guarda a l'entorn de l'usuari de navegador. El seu \u00fas m\u00e9s t\u00edpic \u00e9s l'emmagatzematge de les prefer\u00e8ncies de l'usuari (per exemple, l'idioma en que s'han de mostrar les p\u00e0gines), perqu\u00e8 no haja de tornar a indicar-les la propera vegada que visiteu el lloc. Si utilitzes Firefox com a navegador, pots accedir a Desenvolupador web \u2013 Inspector d'emmagatzematge des del men\u00fa principal. Entre les seves caracter\u00edstiques et permet consultar i editar les galetes emmagatzemades en el mateix. En PHP, per emmagatzemar una galleta al navegador de l'usuari, pots utilitzar la funci\u00f3 setcookie . L'\u00fanic par\u00e0metre obligatori que has de fer servir \u00e9s el nom de la galleta, per\u00f2 admet diversos par\u00e0metres m\u00e9s opcionals. setcookie ( string $name , string $value = \"\" , int $expires = 0 , string $path = \"\" , string $domain = \"\" , bool $secure = false , bool $httponly = false ) : bool Info Per a m\u00e9s informaci\u00f3 consulta: https://www.php.net/manual/es/function.setcookie.php . Per exemple, si vols emmagatzemar en una galleta la data del darrer acc\u00e9s d'un usuari, pots fer: setcookie ( \"last_visit_date\" , ( string ) time (), time () + 3600 ); Els dos primers par\u00e0metres s\u00f3n el nom de la galeta i el seu valor. El tercer \u00e9s la data de caducitat de la mateixa en format timestamp (en l'exemple, una hora des del moment en qu\u00e8 s'execute). En cas de no figurar aquest par\u00e0metre, la galeta s'eliminar\u00e0 quan es tanque el navegador. Tingues en compte que tamb\u00e9 es poden aplicar restriccions a les p\u00e0gines del lloc que poden accedir a una galeta en funci\u00f3 de la ruta. Les galetes es transmeten entre el navegador i el servidor web utilitzant les cap\u00e7aleres del protocol HTTP. Per aix\u00f2, les sent\u00e8ncies setcookie s'han d'enviar abans que el navegador mostre cap informaci\u00f3 a pantalla. Podeu trobar m\u00e9s informaci\u00f3 en Ultimate Guide to HTTP Cookies El proc\u00e9s de recuperaci\u00f3 de la informaci\u00f3 que emmagatzema una galleta \u00e9s molt simple. Quan accedeixes a un lloc web, el navegador li envia de forma autom\u00e0tica tot el contingut de les galetes que emmagatzema relatives a aquest lloc en concret. Des PHP pots accedir a aquesta informaci\u00f3 per mitj\u00e0 de la variable superglobal $_COOKIE . Warning Sempre que utilitzeu galetes en una aplicaci\u00f3 web, heu de tenir en compte que en \u00faltima inst\u00e0ncia la seva disponibilitat est\u00e0 controlada pel client. Per exemple, alguns usuaris deshabiliten les galetes al navegador perqu\u00e8 pensen que la informaci\u00f3 que emmagatzemen pot suposar un potencial problema de seguretat. O que la informaci\u00f3 que emmagatzemen pot arribar a perdre perqu\u00e8 l'usuari decideix formatar l'equip o simplement eliminar-les de sistema. Si un cop emmagatzemada una galeta al navegador vols eliminar-la abans que expire, pots utilitzar la mateixa funci\u00f3 setcookie per\u00f2 indicant una data de caducitat anterior a l'actual. Question Quina \u00e9s la durada per defecte d'una galeta si no s'indica la data de caducitat, com en la seg\u00fcent crida a la funci\u00f3 setcookie ? setcookie ( \"idioma\" , \"espanyol\" ); Fins que es tanque el navegador de l'usuari. 1 hora. Problemes de seguretat relacionats amb galletes A l'hora de fer \u00fas de galetes, cal ser conscient dels potencials problemes de seguretat que poden patir. En l'article Ultimate Guide to HTTP Cookies s'exposen tres dels problemes m\u00e9s rellevants i la seua sol\u00b7luci\u00f3. Aquest article \u00e9s una refer\u00e8ncia molt completa dels possibles valors i atributs que es poden fer servir les galetes: Set-Cookie headers Maneig de sessions Com acabes de veure, una forma per guardar informaci\u00f3 particular de cada usuari \u00e9s utilitzar galetes ( cookies ). No obstant aix\u00f2, hi ha diversos problemes associats a les galetes, com el nombre d'elles que admet el navegador, o la seva grand\u00e0ria m\u00e0xima. Per solucionar aquests inconvenients, existeixen les sessions. El terme sessi\u00f3 fa refer\u00e8ncia al conjunt d'informaci\u00f3 relativa a un usuari concret. Aquesta informaci\u00f3 pot ser tan simple com el nom de l'usuari mateix, o m\u00e9s complexa, com els articles que ha dipositat a la cistella de compra d'una botiga en l\u00ednia. Cada usuari diferent d'un lloc web t\u00e9 la seva pr\u00f2pia informaci\u00f3 de sessi\u00f3. Per distingir una sessi\u00f3 d'una altra s'usen els identificadors de sessi\u00f3 (SID). Un SID \u00e9s un atribut que s'assigna a cada un dels visitants d'un lloc web i l'identifica. D'aquesta manera, si el servidor web coneix el SID d'un usuari, pot relacionar-lo amb tota la informaci\u00f3 que posseeix sobre ell, que es mant\u00e9 en la sessi\u00f3 de l'usuari. Aquesta informaci\u00f3 s'emmagatzema en el servidor web, generalment en fitxers tot i que tamb\u00e9 es poden utilitzar altres mecanismes d'emmagatzematge com bases de dades. Com ja haur\u00e0s suposat, la q\u00fcesti\u00f3 ara \u00e9s: \u00bfi on s'emmagatzema aquest SID, identificador de la sessi\u00f3, que \u00e9s \u00fanic per a cada usuari? Doncs hi ha dues maneres de mantenir el SID entre les p\u00e0gines d'un lloc web que visita l'usuari: Utilitzant galetes. Propagant el SID en un par\u00e0metre de la URL. El SID s'afegeix com una part m\u00e9s de la URL, de la forma: http://www.misitioweb.com/tienda/listado.php& PHPSESSID=34534fg4ffg34ty En l'exemple anterior, el SID \u00e9s el valor del par\u00e0metre PHPSESSID . Cap de les dues maneres \u00e9s perfecta. Ja saps els problemes que t\u00e9 la utilitzaci\u00f3 de cookies. Malgrat aix\u00f2, \u00e9s el millor m\u00e8tode i el m\u00e9s utilitzat. Propagar el SID com a part de la URL comporta majors desavantatges, com la impossibilitat de mantenir el SID entre diferents sessions, o el fet que compartir la URL amb una altra persona implica compartir tamb\u00e9 l'identificador de sessi\u00f3. La bona not\u00edcia, \u00e9s que el proc\u00e9s de maneig de sessions en PHP est\u00e0 automatitzat en gran mida. Quan un usuari visita un lloc web, no cal programar un procediment per veure si hi ha un SID previ i carregar les dades associades amb el mateix. Tampoc has d'utilitzar la funci\u00f3 setcookie si vols emmagatzemar els SID en galetes, o anar passant el SID entre les p\u00e0gines web del teu lloc si et decideixes per propagar. Tot aix\u00f2 PHP ho fa autom\u00e0ticament. Server side cookies A la informaci\u00f3 que s'emmagatzema en la sessi\u00f3 d'un usuari tamb\u00e9 se li coneix com a galetes en la part de servidor ( server side cookies ). Has de tenir en compte que encara aquesta informaci\u00f3 no viatja entre el client i el servidor, s\u00ed que ho fa el SID, b\u00e9 com a part de l'URL o en una cap\u00e7alera HTTP si es guarda en una galleta. En tots dos casos, aix\u00f2 planteja un possible problema de seguretat. El SID pot ser aconseguit per una altra persona, i a partir de la mateixa obtenir la informaci\u00f3 de la sessi\u00f3 de l'usuari. La manera m\u00e9s segura d'utilitzar sessions \u00e9s emmagatzemant els SID en galetes i utilitzar HTTPS per a xifrar la informaci\u00f3 que es transmet entre el servidor web i el client. Configuraci\u00f3 Per defecte, PHP inclou suport per a la gesti\u00f3 de sessions. Abans, per\u00f2, d'utilitzar sessions en el teu lloc web, has de configurar correctament PHP utilitzant els seg\u00fcents directives en el fitxer php.ini segons corresponga: Directiva significat session.use_cookies Indica si s'han d'usar cookies (1) o propagaci\u00f3 a la URL (0) per emmagatzemar el SID. session.use_only_cookies S'ha d'activar (1) quan fas servir cookies per emmagatzemar els SID, i a m\u00e9s no vols que es reconeguin els SID que es puguin passar com part de la URL (aquest m\u00e8tode es pot usar per usurpar l'identificador d'un altre usuari) session.save_handler S'utilitza per indicar a PHP com ha de emmagatzemar les dades de la sessi\u00f3 de l'usuari. Hi ha quatre opcions: en fitxers (files), en mem\u00f2ria (Mm), en una base de dades SQLite (sqlite) o utilitzant per a aix\u00f2 funcions que ha de definir el programador (user). El valor per defecte (Files) funcionar\u00e0 sense problemes en la majoria dels casos. session.name Determina el nom de la galleta que s'utilitzar\u00e0 per guardar el SID. La seva valor per defecte \u00e9s PHPSESSID. session.auto_start El seu valor per defecte \u00e9s 0, i en aquest cas haur\u00e0s de fer servir la funci\u00f3 session_start per gestionar l'inici de les sessions. Si fas servir sessions al lloc web, pot ser bona idea canviar el seu valor a 1 per que PHP activi de forma autom\u00e0tica el maneig de sessions. session.cookie_lifetime Si utilitzes l'URL per propagar el SID, aquest es perdr\u00e0 quan tanque el navegador. No obstant aix\u00f2, si utilitzes galetes, el SID es mantindr\u00e0 mentre no es destruisca la galleta. En el seu valor per defecte (0), les galetes es destrueixen quan es tanca el navegador. Si vols que es mantingui el SID durant m\u00e9s temps, has d'indicar en aquesta directiva aquest temps en segons. session.gc_maxlifetime Indica el temps en segons que s'ha de mantenir activa la sessi\u00f3, encara que no hi hagi cap activitat per part de l'usuari. El seu valor per defecte \u00e9s 1440. \u00c9s a dir, passats 24 minuts des de l'\u00faltima activitat per part de l'usuari, es tanca la sessi\u00f3 autom\u00e0ticament. session.cookie_path Indica la ruta que ha d'existir per a enviar la galleta de sessi\u00f3. session.cookie_domain Domini que ha d'haver perqu\u00e8 s'envie la cookie . Quan no s'indica valor la galleta s'envia sols al nom complet de host que l'ha enviada. session.cookie_secure Quan t\u00e9 el valor On la galleta sols s'enviar\u00e0 si les urls s\u00f3n HTTPS. session.cookie_httponly Quan t\u00e9 el valor On s'indica als navegadors que el JavaScript no pot llegir-les. La funci\u00f3 phpinfo , de la qual ja vam parlar amb anterioritat, t'ofereix informaci\u00f3 sobre la configuraci\u00f3 actual de les directives de sessi\u00f3. Cal saber La majoria de directives de PHP es poden modificar en temps d'execuci\u00f3 amb la funci\u00f3 ini_set . En la documentaci\u00f3 de PHP tens informaci\u00f3 sobre aquestes i altres directives que permeten configurar el maneig de sessions. https://www.php.net/manual/es/session.configuration.php Question Si la informaci\u00f3 de l'usuari que vols emmagatzemar inclou contingut privat com una contrasenya, \u00bfqu\u00e8 utilitzaries, galetes o la sessi\u00f3 de l'usuari? Inici i fi d'una sessi\u00f3 L'inici d'una sessi\u00f3 pot tenir lloc de dues maneres. Si has activat la directiva session.auto_start en la configuraci\u00f3 de PHP, la sessi\u00f3 comen\u00e7ar\u00e0 autom\u00e0ticament quan un usuari es connecte al teu lloc web. En el cas que aquest usuari ja haja obert una sessi\u00f3 amb anterioritat, i aquesta no s'haja eliminat, en lloc d'obrir una nova sessi\u00f3 es reprendr\u00e0 la anterior. Per a aix\u00f2 s'utilitzar\u00e0 el SID anterior, que estar\u00e0 emmagatzemat en una galleta (recorda que si fas servir propagaci\u00f3 de l'SID, no podr\u00e0s restaurar sessions anteriors; el SID figura a la URL i es perd quan tanques el navegador). Si per contra, decideixes no utilitzar l'inici autom\u00e0tic de sessions, haur\u00e0s executar la funci\u00f3 session_start() per indicar a PHP que inicie una nova sessi\u00f3 o reprenga l'anterior. Anteriorment aquesta funci\u00f3 tornava sempre true , a partir de la versi\u00f3 5.3.0 de PHP el seu comportament \u00e9s m\u00e9s coherent: retorna false en cas de no poder iniciar o restaurar la sessi\u00f3. Com l'inici de sessi\u00f3 requereix utilitzar cookies , i aquestes es transmeten en els encap\u00e7alats HTTP, heu de tenir en compte que per poder iniciar una sessi\u00f3 utilitzant session_start , haur\u00e0s de fer les cridades a aquesta funci\u00f3 abans que la p\u00e0gina web mostre informaci\u00f3 al navegador. A m\u00e9s, totes les p\u00e0gines que necessiten utilitzar la informaci\u00f3 emmagatzemada en la sessi\u00f3, hauran d'executar la funci\u00f3 session_start . Mentre la sessi\u00f3 estiga oberta, pots utilitzar la variable superglobal $_SESSION per afegir informaci\u00f3 a la sessi\u00f3 de l'usuari, o per accedir a la informaci\u00f3 emmagatzemada en la sessi\u00f3. Per exemple, per comptar el nombre de vegades que l'usuari visita la p\u00e0gina, pots fer: <? php // Iniciamos la sesi\u00f3n o recuperamos la anterior sesi\u00f3n existente session_start (); // Comprobamos si la variable ya existe if ( isset ( $_SESSION [ 'visitas' ])) $_SESSION [ 'visitas' ] ++ ; else $_SESSION [ 'visitas' ] = 0 ; ?> Si en lloc de el nombre de visites, voldries emmagatzemar l'instant en qu\u00e8 es produeix cadascuna, la variable de sessi\u00f3 \"visites\" ha de ser una matriu i per tant haur\u00e0s de canviar el codi anterior per: <? php // Iniciamos la sesi\u00f3n o recuperamos la anterior sesi\u00f3n existente session_start (); // En cada visita a\u00f1adimos un valor al array \"visitas\" $_SESSION [ 'visitas' ][] = mktime (); ?> Encara que com ja has vist, pots configurar PHP perqu\u00e8 elimine de forma autom\u00e0tica les dades de una sessi\u00f3 passat cert temps, en ocasions pot ser necessari tancar-la de forma manual en un moment determinat. Per exemple, si utilitzes sessions per recordar la informaci\u00f3 d'autenticaci\u00f3 haur\u00e0s donar-li a l'usuari de la p\u00e0gina web la possibilitat de tancar la sessi\u00f3 quan ho crega convenient. En PHP tens dues funcions per eliminar la informaci\u00f3 emmagatzemada en la sessi\u00f3: session_unset . Elimina les variables emmagatzemades a la sessi\u00f3 actual, per\u00f2 no elimina la informaci\u00f3 de la sessi\u00f3 del dispositiu d'emmagatzematge usat. session_destroy . Elimina completament la informaci\u00f3 de la sessi\u00f3 del dispositiu d'emmagatzematge. Aplicacions pr\u00e0ctiques Autenticaci\u00f3 d'usuaris Gr\u00e0cies a les sessions podem emmagatzemar un token \u00fanic per poder saber si un usuari ha iniciat sessi\u00f3 correctament o no. Evitar atacs CSRF La falsificaci\u00f3 de sol\u00b7licituds entre llocs (CSRF) \u00e9s un tipus d'atac que es produeix quan un lloc web, correu electr\u00f2nic, bloc, missatge instantani o programa malici\u00f3s fa que el navegador web d'un usuari realitze una acci\u00f3 no desitjada en un lloc de confian\u00e7a quan l'usuari s'autentica. En el cas dels formularis hem d'assegurar-nos que l'origen de la petici\u00f3 prov\u00e9 de la nostra aplicaci\u00f3 web. Per a aconseguir-ho caldr\u00e0: Generar un token \u00fanic quan es sol\u00b7licite mostrar un formulari. Guardar el token en un variable de sessi\u00f3. Incloure en el formulari un camp ocult amb el token. En el moment de processar el formulari comprovarem que el token enviat pel formulari coincideix amb el token emmagatzemat en la variable de sessi\u00f3. Si no \u00e9s aix\u00ed, mostarem un error. Separar la l\u00f2gica dels formularis Fins ara, hem creat formularis ( self-processing forms ) que es processaven en el mateix fitxer. Combinant variables de sessi\u00f3 i redireccions podem aconseguir separar la l\u00f2gica del formulari en dos fitxer. Si agafem com a exemple la creaci\u00f3 de nous tuits: El fitxer tweet-new.php s'encarregar\u00e0 de mostrar el formulari i el fitxer tweet-process.php s'encarregar\u00e0 de processar-lo. En cas d'errors de validaci\u00f3 es redirigir\u00e0 a tweet-new.php guardant en una variable de sessi\u00f3 els errors i les dades correctament validades. En cas d'\u00e8xit, tweet-process.php redirigir\u00e0 a la p\u00e0gina index.php guardant en una variable de sessi\u00f3 el missatge d'\u00e8xit, que caldr\u00e0 mostrar en index.php . Redireccions Una redirecci\u00f3 \u00e9s una t\u00e8cnica que permet fer que el servidor web responga amb una URL diferent a l\u2019actual. Per a aconseguir s\u2019utilitza la funci\u00f3 header() . // Send to the browser a new url and send a HTTP redirect code (302) header ( 'Location: /index.php' ) // this function terminate the current script exit (); Compte amb les redireccions \u00c9s molt important fer una correcta gesti\u00f3 dels errors abans de fer una redirecci\u00f3, sin\u00f3 \u00e9s possible que s\u2019amaguen els errors i passen coses estranyes.","title":"Manteniment de l'estat"},{"location":"04-web-programming/04-02-state/#manteniment-de-lestat","text":"Recorda que HTTP \u00e9s un protocol sense estat, el que significa que un cop un servidor web completa la sol\u00b7licitud d\u2019un client d\u2019un recurs, la connexi\u00f3 entre els dos acaba. Dit d\u2019una altra manera, no hi ha manera que un servidor recorde una que una seq\u00fc\u00e8ncia de sol\u00b7licituds prov\u00e9 del mateix client. Info Mantenir l\u2019estat \u00e9s poder fer el seguiment d\u2019una sequ\u00e8ncia de sol\u00b7licituds d\u2019un client. No obstant aix\u00f2 mantenir l\u2019estat, poder fer el seguiment d\u2019una seq\u00fc\u00e8ncia de sol\u00b7licituds d\u2019un client, \u00e9s molt \u00fatil. No podeu crear una aplicaci\u00f3 que tinga cistella de la compra, per exemple, si no podeu mantenir l\u2019estat. Heu de saber quan un usuari afegeix articles a la cistella o els elimina i el contingut final de la cistella si el client decideix adquirir els productes. Per solucionar aquesta manca d\u2019estat de la web tenim disponibles diverses t\u00e8cniques com l\u2019\u00fas cookies o de sessions que veurem a continuaci\u00f3. Combinant mecanismes d\u2019autenticaci\u00f3 i t\u00e8cniques per a mantenir l\u2019estat podem crear aplicacions web segures.","title":"Manteniment de l\u2019estat"},{"location":"04-web-programming/04-02-state/#galletes-cookies","text":"Una galleta \u00e9s un fitxer de text que un lloc web guarda a l'entorn de l'usuari de navegador. El seu \u00fas m\u00e9s t\u00edpic \u00e9s l'emmagatzematge de les prefer\u00e8ncies de l'usuari (per exemple, l'idioma en que s'han de mostrar les p\u00e0gines), perqu\u00e8 no haja de tornar a indicar-les la propera vegada que visiteu el lloc. Si utilitzes Firefox com a navegador, pots accedir a Desenvolupador web \u2013 Inspector d'emmagatzematge des del men\u00fa principal. Entre les seves caracter\u00edstiques et permet consultar i editar les galetes emmagatzemades en el mateix. En PHP, per emmagatzemar una galleta al navegador de l'usuari, pots utilitzar la funci\u00f3 setcookie . L'\u00fanic par\u00e0metre obligatori que has de fer servir \u00e9s el nom de la galleta, per\u00f2 admet diversos par\u00e0metres m\u00e9s opcionals. setcookie ( string $name , string $value = \"\" , int $expires = 0 , string $path = \"\" , string $domain = \"\" , bool $secure = false , bool $httponly = false ) : bool Info Per a m\u00e9s informaci\u00f3 consulta: https://www.php.net/manual/es/function.setcookie.php . Per exemple, si vols emmagatzemar en una galleta la data del darrer acc\u00e9s d'un usuari, pots fer: setcookie ( \"last_visit_date\" , ( string ) time (), time () + 3600 ); Els dos primers par\u00e0metres s\u00f3n el nom de la galeta i el seu valor. El tercer \u00e9s la data de caducitat de la mateixa en format timestamp (en l'exemple, una hora des del moment en qu\u00e8 s'execute). En cas de no figurar aquest par\u00e0metre, la galeta s'eliminar\u00e0 quan es tanque el navegador. Tingues en compte que tamb\u00e9 es poden aplicar restriccions a les p\u00e0gines del lloc que poden accedir a una galeta en funci\u00f3 de la ruta. Les galetes es transmeten entre el navegador i el servidor web utilitzant les cap\u00e7aleres del protocol HTTP. Per aix\u00f2, les sent\u00e8ncies setcookie s'han d'enviar abans que el navegador mostre cap informaci\u00f3 a pantalla. Podeu trobar m\u00e9s informaci\u00f3 en Ultimate Guide to HTTP Cookies El proc\u00e9s de recuperaci\u00f3 de la informaci\u00f3 que emmagatzema una galleta \u00e9s molt simple. Quan accedeixes a un lloc web, el navegador li envia de forma autom\u00e0tica tot el contingut de les galetes que emmagatzema relatives a aquest lloc en concret. Des PHP pots accedir a aquesta informaci\u00f3 per mitj\u00e0 de la variable superglobal $_COOKIE . Warning Sempre que utilitzeu galetes en una aplicaci\u00f3 web, heu de tenir en compte que en \u00faltima inst\u00e0ncia la seva disponibilitat est\u00e0 controlada pel client. Per exemple, alguns usuaris deshabiliten les galetes al navegador perqu\u00e8 pensen que la informaci\u00f3 que emmagatzemen pot suposar un potencial problema de seguretat. O que la informaci\u00f3 que emmagatzemen pot arribar a perdre perqu\u00e8 l'usuari decideix formatar l'equip o simplement eliminar-les de sistema. Si un cop emmagatzemada una galeta al navegador vols eliminar-la abans que expire, pots utilitzar la mateixa funci\u00f3 setcookie per\u00f2 indicant una data de caducitat anterior a l'actual. Question Quina \u00e9s la durada per defecte d'una galeta si no s'indica la data de caducitat, com en la seg\u00fcent crida a la funci\u00f3 setcookie ? setcookie ( \"idioma\" , \"espanyol\" ); Fins que es tanque el navegador de l'usuari. 1 hora.","title":"Galletes (cookies)"},{"location":"04-web-programming/04-02-state/#problemes-de-seguretat-relacionats-amb-galletes","text":"A l'hora de fer \u00fas de galetes, cal ser conscient dels potencials problemes de seguretat que poden patir. En l'article Ultimate Guide to HTTP Cookies s'exposen tres dels problemes m\u00e9s rellevants i la seua sol\u00b7luci\u00f3. Aquest article \u00e9s una refer\u00e8ncia molt completa dels possibles valors i atributs que es poden fer servir les galetes: Set-Cookie headers","title":"Problemes de seguretat relacionats amb galletes"},{"location":"04-web-programming/04-02-state/#maneig-de-sessions","text":"Com acabes de veure, una forma per guardar informaci\u00f3 particular de cada usuari \u00e9s utilitzar galetes ( cookies ). No obstant aix\u00f2, hi ha diversos problemes associats a les galetes, com el nombre d'elles que admet el navegador, o la seva grand\u00e0ria m\u00e0xima. Per solucionar aquests inconvenients, existeixen les sessions. El terme sessi\u00f3 fa refer\u00e8ncia al conjunt d'informaci\u00f3 relativa a un usuari concret. Aquesta informaci\u00f3 pot ser tan simple com el nom de l'usuari mateix, o m\u00e9s complexa, com els articles que ha dipositat a la cistella de compra d'una botiga en l\u00ednia. Cada usuari diferent d'un lloc web t\u00e9 la seva pr\u00f2pia informaci\u00f3 de sessi\u00f3. Per distingir una sessi\u00f3 d'una altra s'usen els identificadors de sessi\u00f3 (SID). Un SID \u00e9s un atribut que s'assigna a cada un dels visitants d'un lloc web i l'identifica. D'aquesta manera, si el servidor web coneix el SID d'un usuari, pot relacionar-lo amb tota la informaci\u00f3 que posseeix sobre ell, que es mant\u00e9 en la sessi\u00f3 de l'usuari. Aquesta informaci\u00f3 s'emmagatzema en el servidor web, generalment en fitxers tot i que tamb\u00e9 es poden utilitzar altres mecanismes d'emmagatzematge com bases de dades. Com ja haur\u00e0s suposat, la q\u00fcesti\u00f3 ara \u00e9s: \u00bfi on s'emmagatzema aquest SID, identificador de la sessi\u00f3, que \u00e9s \u00fanic per a cada usuari? Doncs hi ha dues maneres de mantenir el SID entre les p\u00e0gines d'un lloc web que visita l'usuari: Utilitzant galetes. Propagant el SID en un par\u00e0metre de la URL. El SID s'afegeix com una part m\u00e9s de la URL, de la forma: http://www.misitioweb.com/tienda/listado.php& PHPSESSID=34534fg4ffg34ty En l'exemple anterior, el SID \u00e9s el valor del par\u00e0metre PHPSESSID . Cap de les dues maneres \u00e9s perfecta. Ja saps els problemes que t\u00e9 la utilitzaci\u00f3 de cookies. Malgrat aix\u00f2, \u00e9s el millor m\u00e8tode i el m\u00e9s utilitzat. Propagar el SID com a part de la URL comporta majors desavantatges, com la impossibilitat de mantenir el SID entre diferents sessions, o el fet que compartir la URL amb una altra persona implica compartir tamb\u00e9 l'identificador de sessi\u00f3. La bona not\u00edcia, \u00e9s que el proc\u00e9s de maneig de sessions en PHP est\u00e0 automatitzat en gran mida. Quan un usuari visita un lloc web, no cal programar un procediment per veure si hi ha un SID previ i carregar les dades associades amb el mateix. Tampoc has d'utilitzar la funci\u00f3 setcookie si vols emmagatzemar els SID en galetes, o anar passant el SID entre les p\u00e0gines web del teu lloc si et decideixes per propagar. Tot aix\u00f2 PHP ho fa autom\u00e0ticament. Server side cookies A la informaci\u00f3 que s'emmagatzema en la sessi\u00f3 d'un usuari tamb\u00e9 se li coneix com a galetes en la part de servidor ( server side cookies ). Has de tenir en compte que encara aquesta informaci\u00f3 no viatja entre el client i el servidor, s\u00ed que ho fa el SID, b\u00e9 com a part de l'URL o en una cap\u00e7alera HTTP si es guarda en una galleta. En tots dos casos, aix\u00f2 planteja un possible problema de seguretat. El SID pot ser aconseguit per una altra persona, i a partir de la mateixa obtenir la informaci\u00f3 de la sessi\u00f3 de l'usuari. La manera m\u00e9s segura d'utilitzar sessions \u00e9s emmagatzemant els SID en galetes i utilitzar HTTPS per a xifrar la informaci\u00f3 que es transmet entre el servidor web i el client.","title":"Maneig de sessions"},{"location":"04-web-programming/04-02-state/#configuracio","text":"Per defecte, PHP inclou suport per a la gesti\u00f3 de sessions. Abans, per\u00f2, d'utilitzar sessions en el teu lloc web, has de configurar correctament PHP utilitzant els seg\u00fcents directives en el fitxer php.ini segons corresponga: Directiva significat session.use_cookies Indica si s'han d'usar cookies (1) o propagaci\u00f3 a la URL (0) per emmagatzemar el SID. session.use_only_cookies S'ha d'activar (1) quan fas servir cookies per emmagatzemar els SID, i a m\u00e9s no vols que es reconeguin els SID que es puguin passar com part de la URL (aquest m\u00e8tode es pot usar per usurpar l'identificador d'un altre usuari) session.save_handler S'utilitza per indicar a PHP com ha de emmagatzemar les dades de la sessi\u00f3 de l'usuari. Hi ha quatre opcions: en fitxers (files), en mem\u00f2ria (Mm), en una base de dades SQLite (sqlite) o utilitzant per a aix\u00f2 funcions que ha de definir el programador (user). El valor per defecte (Files) funcionar\u00e0 sense problemes en la majoria dels casos. session.name Determina el nom de la galleta que s'utilitzar\u00e0 per guardar el SID. La seva valor per defecte \u00e9s PHPSESSID. session.auto_start El seu valor per defecte \u00e9s 0, i en aquest cas haur\u00e0s de fer servir la funci\u00f3 session_start per gestionar l'inici de les sessions. Si fas servir sessions al lloc web, pot ser bona idea canviar el seu valor a 1 per que PHP activi de forma autom\u00e0tica el maneig de sessions. session.cookie_lifetime Si utilitzes l'URL per propagar el SID, aquest es perdr\u00e0 quan tanque el navegador. No obstant aix\u00f2, si utilitzes galetes, el SID es mantindr\u00e0 mentre no es destruisca la galleta. En el seu valor per defecte (0), les galetes es destrueixen quan es tanca el navegador. Si vols que es mantingui el SID durant m\u00e9s temps, has d'indicar en aquesta directiva aquest temps en segons. session.gc_maxlifetime Indica el temps en segons que s'ha de mantenir activa la sessi\u00f3, encara que no hi hagi cap activitat per part de l'usuari. El seu valor per defecte \u00e9s 1440. \u00c9s a dir, passats 24 minuts des de l'\u00faltima activitat per part de l'usuari, es tanca la sessi\u00f3 autom\u00e0ticament. session.cookie_path Indica la ruta que ha d'existir per a enviar la galleta de sessi\u00f3. session.cookie_domain Domini que ha d'haver perqu\u00e8 s'envie la cookie . Quan no s'indica valor la galleta s'envia sols al nom complet de host que l'ha enviada. session.cookie_secure Quan t\u00e9 el valor On la galleta sols s'enviar\u00e0 si les urls s\u00f3n HTTPS. session.cookie_httponly Quan t\u00e9 el valor On s'indica als navegadors que el JavaScript no pot llegir-les. La funci\u00f3 phpinfo , de la qual ja vam parlar amb anterioritat, t'ofereix informaci\u00f3 sobre la configuraci\u00f3 actual de les directives de sessi\u00f3. Cal saber La majoria de directives de PHP es poden modificar en temps d'execuci\u00f3 amb la funci\u00f3 ini_set . En la documentaci\u00f3 de PHP tens informaci\u00f3 sobre aquestes i altres directives que permeten configurar el maneig de sessions. https://www.php.net/manual/es/session.configuration.php Question Si la informaci\u00f3 de l'usuari que vols emmagatzemar inclou contingut privat com una contrasenya, \u00bfqu\u00e8 utilitzaries, galetes o la sessi\u00f3 de l'usuari?","title":"Configuraci\u00f3"},{"location":"04-web-programming/04-02-state/#inici-i-fi-duna-sessio","text":"L'inici d'una sessi\u00f3 pot tenir lloc de dues maneres. Si has activat la directiva session.auto_start en la configuraci\u00f3 de PHP, la sessi\u00f3 comen\u00e7ar\u00e0 autom\u00e0ticament quan un usuari es connecte al teu lloc web. En el cas que aquest usuari ja haja obert una sessi\u00f3 amb anterioritat, i aquesta no s'haja eliminat, en lloc d'obrir una nova sessi\u00f3 es reprendr\u00e0 la anterior. Per a aix\u00f2 s'utilitzar\u00e0 el SID anterior, que estar\u00e0 emmagatzemat en una galleta (recorda que si fas servir propagaci\u00f3 de l'SID, no podr\u00e0s restaurar sessions anteriors; el SID figura a la URL i es perd quan tanques el navegador). Si per contra, decideixes no utilitzar l'inici autom\u00e0tic de sessions, haur\u00e0s executar la funci\u00f3 session_start() per indicar a PHP que inicie una nova sessi\u00f3 o reprenga l'anterior. Anteriorment aquesta funci\u00f3 tornava sempre true , a partir de la versi\u00f3 5.3.0 de PHP el seu comportament \u00e9s m\u00e9s coherent: retorna false en cas de no poder iniciar o restaurar la sessi\u00f3. Com l'inici de sessi\u00f3 requereix utilitzar cookies , i aquestes es transmeten en els encap\u00e7alats HTTP, heu de tenir en compte que per poder iniciar una sessi\u00f3 utilitzant session_start , haur\u00e0s de fer les cridades a aquesta funci\u00f3 abans que la p\u00e0gina web mostre informaci\u00f3 al navegador. A m\u00e9s, totes les p\u00e0gines que necessiten utilitzar la informaci\u00f3 emmagatzemada en la sessi\u00f3, hauran d'executar la funci\u00f3 session_start . Mentre la sessi\u00f3 estiga oberta, pots utilitzar la variable superglobal $_SESSION per afegir informaci\u00f3 a la sessi\u00f3 de l'usuari, o per accedir a la informaci\u00f3 emmagatzemada en la sessi\u00f3. Per exemple, per comptar el nombre de vegades que l'usuari visita la p\u00e0gina, pots fer: <? php // Iniciamos la sesi\u00f3n o recuperamos la anterior sesi\u00f3n existente session_start (); // Comprobamos si la variable ya existe if ( isset ( $_SESSION [ 'visitas' ])) $_SESSION [ 'visitas' ] ++ ; else $_SESSION [ 'visitas' ] = 0 ; ?> Si en lloc de el nombre de visites, voldries emmagatzemar l'instant en qu\u00e8 es produeix cadascuna, la variable de sessi\u00f3 \"visites\" ha de ser una matriu i per tant haur\u00e0s de canviar el codi anterior per: <? php // Iniciamos la sesi\u00f3n o recuperamos la anterior sesi\u00f3n existente session_start (); // En cada visita a\u00f1adimos un valor al array \"visitas\" $_SESSION [ 'visitas' ][] = mktime (); ?> Encara que com ja has vist, pots configurar PHP perqu\u00e8 elimine de forma autom\u00e0tica les dades de una sessi\u00f3 passat cert temps, en ocasions pot ser necessari tancar-la de forma manual en un moment determinat. Per exemple, si utilitzes sessions per recordar la informaci\u00f3 d'autenticaci\u00f3 haur\u00e0s donar-li a l'usuari de la p\u00e0gina web la possibilitat de tancar la sessi\u00f3 quan ho crega convenient. En PHP tens dues funcions per eliminar la informaci\u00f3 emmagatzemada en la sessi\u00f3: session_unset . Elimina les variables emmagatzemades a la sessi\u00f3 actual, per\u00f2 no elimina la informaci\u00f3 de la sessi\u00f3 del dispositiu d'emmagatzematge usat. session_destroy . Elimina completament la informaci\u00f3 de la sessi\u00f3 del dispositiu d'emmagatzematge.","title":"Inici i fi d'una sessi\u00f3"},{"location":"04-web-programming/04-02-state/#aplicacions-practiques","text":"","title":"Aplicacions pr\u00e0ctiques"},{"location":"04-web-programming/04-03-authentication/","text":"Autenticaci\u00f3 d\u2019usuaris Moltes vegades \u00e9s important verificar la identitat dels dos extrems d\u2019una comunicaci\u00f3, hi ha m\u00e8todes per identificar tant al servidor en el qual s\u2019allotja el lloc web, com a l\u2019usuari del navegador que es troba en l\u2019altre extrem. Els llocs web que necessiten emprar identificaci\u00f3 de servidor, com les botigues o els bancs, utilitzen el protocol HTTPS . Aquest protocol requereix un certificat digital v\u00e0lid, signat per una autoritat fiable, que \u00e9s verificat pel navegador quan s\u2019accedeix a la p\u00e0gina web. A m\u00e9s, HTTPS utilitza m\u00e8todes de xifrat per crear un canal segur entre el navegador i el servidor, de tal manera que no es puga interceptar la informaci\u00f3 que es transmet pel mateix. Per identificar els usuaris que visiten un lloc web, es poden utilitzar diferents m\u00e8todes com el DNI digital o certificats digitals d\u2019usuari (document digital que cont\u00e9 informaci\u00f3 sobre l\u2019usuari com el nom o l\u2019adre\u00e7a. Aquesta informaci\u00f3 est\u00e0 signada per una altra entitat, anomenada entitat certificadora, que ha de ser de confian\u00e7a i garanteix que la informaci\u00f3 que cont\u00e9 \u00e9s certa), per\u00f2 el m\u00e9s est\u00e8s \u00e9s sol\u00b7licitar a l\u2019usuari certa informaci\u00f3 que nom\u00e9s ell coneix: la combinaci\u00f3 d\u2019un nom d\u2019usuari i una contrasenya. \u00c9s tamb\u00e9 habitual usar un formulari d'inici de sessi\u00f3 que valide les credencials de l'usuari contra una base de dades. Una vegada identificat, es pot limitar l\u2019\u00fas que pot fer de la informaci\u00f3. Aix\u00ed, pot haver-hi llocs web en els quals els usuaris autenticats poden utilitzar nom\u00e9s una part de la informaci\u00f3 (com els bancs, que permeten als seus clients accedir \u00fanicament a la informaci\u00f3 relativa als seus comptes). Altres llocs web necessiten separar en grups o rols als usuaris autentificats, de tal manera que la informaci\u00f3 a la qual accedeix un usuari dep\u00e8n del grup o rol en qu\u00e8 aquest es trobe. Per exemple, una aplicaci\u00f3 de gesti\u00f3 d\u2019una empresa pot tenir un grup d\u2019usuaris als qui permet visualitzar la informaci\u00f3, i un altre grup d\u2019usuaris que, a m\u00e9s de visualitzar la informaci\u00f3, tamb\u00e9 la poden modificar. Els mecanismes per al manteniment de l'estat s\u00f3n fonamentals per poder dur a terme aquesta tasca . Tamb\u00e9 \u00e9s possible autenticar usuaris mitjan\u00e7ant l'autenticaci\u00f3 HTTP, la qual cosa excedeix l'abast d'aquest m\u00f2dul. Info Has de distingir l\u2019autenticaci\u00f3 dels usuaris i el control d\u2019acc\u00e9s, de la utilitzaci\u00f3 de mecanismes per assegurar les comunicacions entre l\u2019usuari del navegador i el servidor web. Encara que tots dos aspectes solen anar units, s\u00f3n independents. En els exemples d\u2019aquesta unitat, la informaci\u00f3 d\u2019autenticaci\u00f3 (nom i contrasenya dels usuaris) s\u2019envia en text pla des del navegador fins al servidor web. Aquesta pr\u00e0ctica \u00e9s altament insegura i mai s\u2019ha d\u2019usar sense un protocol com HTTPS que permeta xifrar les comunicacions amb el lloc web. No obstant aix\u00f2, la configuraci\u00f3 de servidors web que permeten fer servir el protocol HTTPS per xifrar la informaci\u00f3 que reben i transmeten no forma part dels continguts d\u2019aquest m\u00f2dul. Per aquest motiu, durant aquesta unitat utilitzarem \u00fanicament el protocol no segur HTTP. Sistema d'autenticaci\u00f3 Per a proveir d'un sistema d'autenticaci\u00f3 senzill necessitarem: Mostrar el formulari d\u2019inici de sessi\u00f3/contrasenya Comprovar les dades enviades Afegir algun tipus de token a la sessi\u00f3 Comprovar el token per a dur a terme tasques d\u2019usuari espec\u00edfiques Eliminar el token la sessi\u00f3 quan l\u2019usuari la tanque. El formulari d'inici de sessi\u00f3 podria ser semblant aquest: < form action = \"login.php\" method = \"post\" novalidate > < div > < label for = \"username\" > Username </ label > < input type = \"text\" name = \"username\" id = \"username\" required > </ div > < div > < label for = \"password\" > Contrasenya </ label > < input type = \"password\" name = \"password\" id = \"password\" required > </ div > < input type = \"submit\" value = \"Inicia sessi\u00f3\" > </ form > Una vegada enviat el processar\u00edem: <?php // Comprovem si el formulari ja s\u2019ha enviat if ( $_SERVER [ \"REQUEST_METHOD\" ] == \"POST\" ) { $username = $_POST [ 'username' ]; $password = $_POST [ 'password' ]; // Validem que rebem els dos par\u00e0metres if ( empty ( $usuario ) || empty ( $password )) { $errors [] = \"Heu d'introduir un usuari i una contrasenya\" ; } else { // Caldria adaptar-ho segons on tingam les credencials dels usuaris if ( $username == \"admin\" && $password == \"admin\" ) { // Emmagatzemem l\u2019usuari a la sessi\u00f3 session_start (); $_SESSION [ 'user' ] = $username ; } else { $errors [] = \"L'usuari o la contrasenya no s\u00f3n v\u00e0lides.\" ; } } } Una vegada iniciada la sessi\u00f3 podr\u00edem controlar que sols els usuaris autenticats pogueren entrar ho far\u00edem aix\u00ed. <?php // Recuperem la informaci\u00f3 de la sessi\u00f3 if ( ! isset ( $_SESSION )) { session_start (); } // I comprovem que l'usuari s'ha autenticat if ( empty ( $_SESSION [ 'user' ])) { die ( \"Error - debe <a href='login.php'>identificar-se</a>.<br />\" ); } ?> <!DOCTYPE html> < html lang = \"ca\" > < head > < meta charset = \"UTF-8\" > < meta name = \"viewport\" content = \"width=device-width, initial-scale=1.0\" > < title > Llista de productes </ title > </ head > < body > < h1 > Benvingut <? = $_SESSION [ 'usuario' ] ?> </ h1 > < p > Polse < a href = \"logout.php\" > ac\u00ed </ a > per a eixir </ p > < p > Tornar a l' < a href = \"index.php\" > inici </ a ></ p > < h2 > Llista de productes </ h2 > < ul > < li > Product 1 </ li > < li > Product 2 </ li > < li > Product 3 </ li > </ ul > </ body > </ html > Per a tancar la sessi\u00f3 eliminar\u00edem la variable de sessi\u00f3 user . <?php // Recuperem la informaci\u00f3 de la sessi\u00f3 session_start (); // I la destru\u00efm session_destroy (); header ( \"Location: index.php\" ); exit (); ?>","title":"Autenticaci\u00f3"},{"location":"04-web-programming/04-03-authentication/#autenticacio-dusuaris","text":"Moltes vegades \u00e9s important verificar la identitat dels dos extrems d\u2019una comunicaci\u00f3, hi ha m\u00e8todes per identificar tant al servidor en el qual s\u2019allotja el lloc web, com a l\u2019usuari del navegador que es troba en l\u2019altre extrem. Els llocs web que necessiten emprar identificaci\u00f3 de servidor, com les botigues o els bancs, utilitzen el protocol HTTPS . Aquest protocol requereix un certificat digital v\u00e0lid, signat per una autoritat fiable, que \u00e9s verificat pel navegador quan s\u2019accedeix a la p\u00e0gina web. A m\u00e9s, HTTPS utilitza m\u00e8todes de xifrat per crear un canal segur entre el navegador i el servidor, de tal manera que no es puga interceptar la informaci\u00f3 que es transmet pel mateix. Per identificar els usuaris que visiten un lloc web, es poden utilitzar diferents m\u00e8todes com el DNI digital o certificats digitals d\u2019usuari (document digital que cont\u00e9 informaci\u00f3 sobre l\u2019usuari com el nom o l\u2019adre\u00e7a. Aquesta informaci\u00f3 est\u00e0 signada per una altra entitat, anomenada entitat certificadora, que ha de ser de confian\u00e7a i garanteix que la informaci\u00f3 que cont\u00e9 \u00e9s certa), per\u00f2 el m\u00e9s est\u00e8s \u00e9s sol\u00b7licitar a l\u2019usuari certa informaci\u00f3 que nom\u00e9s ell coneix: la combinaci\u00f3 d\u2019un nom d\u2019usuari i una contrasenya. \u00c9s tamb\u00e9 habitual usar un formulari d'inici de sessi\u00f3 que valide les credencials de l'usuari contra una base de dades. Una vegada identificat, es pot limitar l\u2019\u00fas que pot fer de la informaci\u00f3. Aix\u00ed, pot haver-hi llocs web en els quals els usuaris autenticats poden utilitzar nom\u00e9s una part de la informaci\u00f3 (com els bancs, que permeten als seus clients accedir \u00fanicament a la informaci\u00f3 relativa als seus comptes). Altres llocs web necessiten separar en grups o rols als usuaris autentificats, de tal manera que la informaci\u00f3 a la qual accedeix un usuari dep\u00e8n del grup o rol en qu\u00e8 aquest es trobe. Per exemple, una aplicaci\u00f3 de gesti\u00f3 d\u2019una empresa pot tenir un grup d\u2019usuaris als qui permet visualitzar la informaci\u00f3, i un altre grup d\u2019usuaris que, a m\u00e9s de visualitzar la informaci\u00f3, tamb\u00e9 la poden modificar. Els mecanismes per al manteniment de l'estat s\u00f3n fonamentals per poder dur a terme aquesta tasca . Tamb\u00e9 \u00e9s possible autenticar usuaris mitjan\u00e7ant l'autenticaci\u00f3 HTTP, la qual cosa excedeix l'abast d'aquest m\u00f2dul. Info Has de distingir l\u2019autenticaci\u00f3 dels usuaris i el control d\u2019acc\u00e9s, de la utilitzaci\u00f3 de mecanismes per assegurar les comunicacions entre l\u2019usuari del navegador i el servidor web. Encara que tots dos aspectes solen anar units, s\u00f3n independents. En els exemples d\u2019aquesta unitat, la informaci\u00f3 d\u2019autenticaci\u00f3 (nom i contrasenya dels usuaris) s\u2019envia en text pla des del navegador fins al servidor web. Aquesta pr\u00e0ctica \u00e9s altament insegura i mai s\u2019ha d\u2019usar sense un protocol com HTTPS que permeta xifrar les comunicacions amb el lloc web. No obstant aix\u00f2, la configuraci\u00f3 de servidors web que permeten fer servir el protocol HTTPS per xifrar la informaci\u00f3 que reben i transmeten no forma part dels continguts d\u2019aquest m\u00f2dul. Per aquest motiu, durant aquesta unitat utilitzarem \u00fanicament el protocol no segur HTTP.","title":"Autenticaci\u00f3 d\u2019usuaris"},{"location":"04-web-programming/04-03-authentication/#sistema-dautenticacio","text":"Per a proveir d'un sistema d'autenticaci\u00f3 senzill necessitarem: Mostrar el formulari d\u2019inici de sessi\u00f3/contrasenya Comprovar les dades enviades Afegir algun tipus de token a la sessi\u00f3 Comprovar el token per a dur a terme tasques d\u2019usuari espec\u00edfiques Eliminar el token la sessi\u00f3 quan l\u2019usuari la tanque. El formulari d'inici de sessi\u00f3 podria ser semblant aquest: < form action = \"login.php\" method = \"post\" novalidate > < div > < label for = \"username\" > Username </ label > < input type = \"text\" name = \"username\" id = \"username\" required > </ div > < div > < label for = \"password\" > Contrasenya </ label > < input type = \"password\" name = \"password\" id = \"password\" required > </ div > < input type = \"submit\" value = \"Inicia sessi\u00f3\" > </ form > Una vegada enviat el processar\u00edem: <?php // Comprovem si el formulari ja s\u2019ha enviat if ( $_SERVER [ \"REQUEST_METHOD\" ] == \"POST\" ) { $username = $_POST [ 'username' ]; $password = $_POST [ 'password' ]; // Validem que rebem els dos par\u00e0metres if ( empty ( $usuario ) || empty ( $password )) { $errors [] = \"Heu d'introduir un usuari i una contrasenya\" ; } else { // Caldria adaptar-ho segons on tingam les credencials dels usuaris if ( $username == \"admin\" && $password == \"admin\" ) { // Emmagatzemem l\u2019usuari a la sessi\u00f3 session_start (); $_SESSION [ 'user' ] = $username ; } else { $errors [] = \"L'usuari o la contrasenya no s\u00f3n v\u00e0lides.\" ; } } } Una vegada iniciada la sessi\u00f3 podr\u00edem controlar que sols els usuaris autenticats pogueren entrar ho far\u00edem aix\u00ed. <?php // Recuperem la informaci\u00f3 de la sessi\u00f3 if ( ! isset ( $_SESSION )) { session_start (); } // I comprovem que l'usuari s'ha autenticat if ( empty ( $_SESSION [ 'user' ])) { die ( \"Error - debe <a href='login.php'>identificar-se</a>.<br />\" ); } ?> <!DOCTYPE html> < html lang = \"ca\" > < head > < meta charset = \"UTF-8\" > < meta name = \"viewport\" content = \"width=device-width, initial-scale=1.0\" > < title > Llista de productes </ title > </ head > < body > < h1 > Benvingut <? = $_SESSION [ 'usuario' ] ?> </ h1 > < p > Polse < a href = \"logout.php\" > ac\u00ed </ a > per a eixir </ p > < p > Tornar a l' < a href = \"index.php\" > inici </ a ></ p > < h2 > Llista de productes </ h2 > < ul > < li > Product 1 </ li > < li > Product 2 </ li > < li > Product 3 </ li > </ ul > </ body > </ html > Per a tancar la sessi\u00f3 eliminar\u00edem la variable de sessi\u00f3 user . <?php // Recuperem la informaci\u00f3 de la sessi\u00f3 session_start (); // I la destru\u00efm session_destroy (); header ( \"Location: index.php\" ); exit (); ?>","title":"Sistema d'autenticaci\u00f3"},{"location":"04-web-programming/04-04-best-practices/","text":"Bones pr\u00e0ctiques En la seg\u00fcent secci\u00f3 fem un recull d'algunes mesures que cal tenir en compte a l'hora de posar una aplicaci\u00f3 web en producci\u00f3. Usa sempre HTTPS Usa sempre HTTPS si no s'enviar\u00e0 tota la informaci\u00f3 en text pla. Contrasenyes incloses. Usa sessions A difer\u00e8ncia de les galetes les dades emmagatzemades en les sessions no s'envien mitjan\u00e7ant els encap\u00e7alats HTTP, romanen al servidor. El que s\u00ed s'envia \u00e9s l'identificador de sessi\u00f3. Caldr\u00e0 prendre mesures perqu\u00e8 l'identificador no puga ser accessible per tercers i aix\u00ed poder accedir a les dades emmagatzemades. Segons l' OWASP : Session settings are some of the MOST important values to concentrate on in configuring. It is a good practice to change session.name to something new. I proposen la seg\u00fcent configuraci\u00f3 b\u00e0sica: session.save_path = /path/PHP-session/ session.name = myPHPSESSID session.auto_start = Off session.use_trans_sid = 0 session.cookie_domain = full.qualified.domain.name #session.cookie_path = /application/path/ session.use_strict_mode = 1 session.use_cookies = 1 session.use_only_cookies = 1 session.cookie_lifetime = 14400 # 4 hours session.cookie_secure = 1 session.cookie_httponly = 1 session.cookie_samesite = Strict session.cache_expire = 30 session.sid_length = 256 session.sid_bits_per_character = 6 # PHP 7.2+ session.hash_function = 1 # PHP 7.0-7.1 session.hash_bits_per_character = 6 # PHP 7.0-7.1 Les recomanacions en major detall: Control de la vida de sessi\u00f3 Fes que expire la sessi\u00f3 despr\u00e9s d\u2019un curt per\u00edode d\u2019inactivitat : ajusteu el temps d\u2019inactivitat a 5 minuts per a aplicacions altament protegides fins a no m\u00e9s de 30 minuts per a aplicacions de baix risc. Habilita l\u2019opci\u00f3 de tancament de sessi\u00f3 : caduca i destrueix expl\u00edcitament la sessi\u00f3 en tancar la sessi\u00f3. Eviteu els inicis de sessi\u00f3 persistents (opci\u00f3 \"recordeu-me\") : opcionalment podeu restringir la informaci\u00f3 conservada i revelada per l'aplicaci\u00f3, \u00e9s a dir, obligar a l'usuari a tornar a iniciar sessi\u00f3 abans de realitzar cap operaci\u00f3 cr\u00edtica. Fes que expire la sessi\u00f3 quan hi haja error de seguretat : qualsevol error de seguretat de l'aplicaci\u00f3 hauria de donar lloc a la finalitzaci\u00f3 de la sessi\u00f3. Fes caducar la sessi\u00f3 quan siga de llarga durada : obligaci\u00f3 a reautentificar la sessi\u00f3, que tot i estar actiu ha arribat al temps m\u00e0xim perm\u00e8s, p.e. unes poques hores. Elimineu la galleta de sessi\u00f3 en destruir una sessi\u00f3 . Identificador de sessi\u00f3 Utilitzeu nom\u00e9s galetes per propagar l\u2019ID de sessi\u00f3 , ja que quan es transmeten mitjan\u00e7ant un par\u00e0metre URL, les sol\u00b7licituds GET poden ser emmagatzemades a l\u2019historial del navegador, a la mem\u00f2ria cau i als marcadors. Aleshores tamb\u00e9 es pot visualitzar f\u00e0cilment. Regenereu l'identificador de sessi\u00f3 : regenereu (substitu\u00efu-ne per un de nou) l'identificador de sessi\u00f3, almenys cada cop que canvie el nivell de privilegi de l'usuari. Generalment es pot regenerar abans de qualsevol transacci\u00f3 important, despr\u00e9s d\u2019un determinat nombre de sol\u00b7licituds o despr\u00e9s d\u2019un per\u00edode de temps. Comproveu si l'identificador de sessi\u00f3 \u00e9s v\u00e0lid (de mida i tipus previst) i que ha estat generat per l'aplicaci\u00f3 i no proporcionat per l'usuari. L'identificador de sessi\u00f3 hauria de ser adequadament llarg, imprevisible, dif\u00edcil de reproduir i creat a partir de fonts aleat\u00f2ries d'alta qualitat . Cookie de sessi\u00f3 Definiu el domini de la galleta a quelcom m\u00e9s espec\u00edfic que el domini de primer nivell. No emmagatzeneu res a la galleta (almenys qualsevol informaci\u00f3 sensible com el nom d\u2019usuari o la contrasenya) sols\u2019ID de sessi\u00f3. Definiu el senyalador nom\u00e9s http per desactivar la captura de l'identificador de sessi\u00f3 mitjan\u00e7ant XSS. Quan siga possible, utilitzeu un xifrat fort (SSL) i l'atribut cookie_secure per permetre la transmissi\u00f3 de cookies nom\u00e9s a trav\u00e9s de https. Emmagatzematge de dades de sessi\u00f3 Determineu on s'emmagatzemen les dades de sessi\u00f3 i si es tracta d\u2019un sistema de fitxers o d\u2019una base de dades, determineu qui m\u00e9s podria tenir acc\u00e9s a aquestes dades. Quan s'emmagatzemen les dades de sessi\u00f3 en fitxers, assegureu-vos que l'aplicaci\u00f3 est\u00e0 configurada per utilitzar un directori privat independent (per exemple, la directiva session.save_path ). Utilitzeu els permisos del sistema de fitxers per protegir aquests fitxers d\u2019observaci\u00f3 o modificaci\u00f3 d\u2019usuaris diferents dels comptes necessaris per operar el servidor web i les aplicacions. Si aix\u00f2 no \u00e9s possible, cal xifrar les dades de la sessi\u00f3 o contenir nom\u00e9s dades no sensibles. Tingueu en compte que PHP utilitza de manera predeterminada el directori temporal del sistema p\u00fablic. Totes les variables de sessi\u00f3 s\u2019han de validar i sanejar per assegurar-se que siguem correctes i que no cont\u00e9 car\u00e0cters inesperats. No con\u00e8ixer les contrasenyes Al final, tothom crea una aplicaci\u00f3 PHP que es basa en la sessi\u00f3 d\u2019usuari. Els noms d\u2019usuari i les contrasenyes s\u2019emmagatzemen en una base de dades i s\u2019utilitzen posteriorment per autentificar els usuaris despr\u00e9s de l\u2019inici de sessi\u00f3. \u00c9s important que fer hash de les contrasenyes correctament abans d\u2019emmagatzemar-les. El hashing i el xifrat s\u00f3n dues coses molt diferents que sovint es confonen. El hashing \u00e9s una funci\u00f3 irreversible i unidireccional. \u00c9s produeix una cadena de longitud fixa que no es pot invertir. Aix\u00f2 vol dir que podeu comparar un hash amb un altre per determinar si tots dos provenien de la mateixa cadena font, per\u00f2 no podeu determinar la cadena original. Si les contrasenyes no s'emmagatzemen amb hashing i un tercer no autoritzat accedeix a la vostra base de dades, tots els comptes d'usuari estaran compromesos. A difer\u00e8ncia del hashing , el xifrat \u00e9s reversible (sempre que tingueu la clau). El xifratge \u00e9s \u00fatil en altres \u00e0rees, per\u00f2 \u00e9s una estrat\u00e8gia deficient per emmagatzemar contrasenyes de forma segura. Les contrasenyes tamb\u00e9 han de salar-se individualment afegint una cadena aleat\u00f2ria a cada contrasenya abans d'aplicar hashing . Aix\u00f2 evita els atacs de diccionari i l'\u00fas de \"taules de l'arc de Sant Mart\u00ed\" (una llista inversa de hash criptogr\u00e0fics per a contrasenyes comunes.) El hashing i el salat s\u00f3n vitals, ja que sovint els usuaris utilitzen la mateixa contrasenya per a diversos serveis i la qualitat de la contrasenya \u00e9s deficient. Addicionalment, haureu d'utilitzar un algorisme especialitzat en hashing en lloc d'una funci\u00f3 de hash criptogr\u00e0fic de prop\u00f2sit general i r\u00e0pid (per exemple, SHA256). La llista breu d'algorismes de hashing de contrasenya acceptables (a juny de 2018) a utilitzar s\u00f3n: Argon2 (disponible a PHP 7.2 i versions posteriors) Scrypt Bcrypt (PHP us proporciona aquesta; vegeu m\u00e9s avall) PBKDF2 amb HMAC-SHA256 o HMAC-SHA512 Afortunadament, avui en dia PHP ens ho facilita. Hashing de contrasenyes amb password_hash A PHP 5.5 s'ha introdu\u00eft password_hash() . En aquest moment est\u00e0 utilitzant BCrypt, l'algorisme m\u00e9s fort actualment suportat per PHP. Tot i aix\u00f2, s'actualitzar\u00e0 en el futur per donar suport a m\u00e9s algoritmes. La biblioteca de password_compat es va crear per proporcionar una compatibilitat de PHP> = 5.3.7. A continuaci\u00f3 hem aplicat hashing a una cadena i, a continuaci\u00f3, apliquem el hashing contra una nova cadena. Com que les dues cadenes d'origen s\u00f3n diferents (\"contrasenya-secreta\" i \"contrasenya-err\u00f2nia\"), aquesta sessi\u00f3 fallar\u00e0. $passwordHash = password_hash ( \"contrasenya-secreta\" , PASSWORD_DEFAULT ); if ( password_verify ( \"contrasenya-err\u00f2nia\" , $passwordHash )) { // Contrasenya correcta } else { // Contrasenya incorrecta } password_hash() s'ocupa de la salificaci\u00f3 de contrasenyes. La sal s'emmagatzema, juntament amb l'algorisme i el \"cost\", com a part del hash. password_verify() extreu aix\u00f2 per determinar com comprovar la contrasenya, de manera que no necessiteu un camp de base de dades independent per emmagatzemar les vostres sals. PASSWORD_DEFAULT Actualment utilitza l\u2019algoritme bcrypt (predeterminat a partir de PHP 5.5.0). Observeu que aquesta constant est\u00e0 pensada per a adaptar-se sempre que hi haja un algoritme nou i m\u00e9s fort a PHP. Per aquesta ra\u00f3, la longitud del resultat d\u2019utilitzar aquest identificador pot canviar amb el temps. Per tant, es recomana emmagatzemar el resultat en una columna d\u2019una base de dades de m\u00e9s de 60 caracters (255 caracters seria una bona elecci\u00f3). Recursos The 2018 Guide to Building Secure PHP Software PHP: The Right Way. Security Session Management Basics Ultimate PHP Security Best Practices PHP Session Security Best Practices PHP Sessions in depth Session Management Cheat Sheet","title":"Bones pr\u00e0ctiques"},{"location":"04-web-programming/04-04-best-practices/#bones-practiques","text":"En la seg\u00fcent secci\u00f3 fem un recull d'algunes mesures que cal tenir en compte a l'hora de posar una aplicaci\u00f3 web en producci\u00f3.","title":"Bones pr\u00e0ctiques"},{"location":"04-web-programming/04-04-best-practices/#usa-sempre-https","text":"Usa sempre HTTPS si no s'enviar\u00e0 tota la informaci\u00f3 en text pla. Contrasenyes incloses.","title":"Usa sempre HTTPS"},{"location":"04-web-programming/04-04-best-practices/#usa-sessions","text":"A difer\u00e8ncia de les galetes les dades emmagatzemades en les sessions no s'envien mitjan\u00e7ant els encap\u00e7alats HTTP, romanen al servidor. El que s\u00ed s'envia \u00e9s l'identificador de sessi\u00f3. Caldr\u00e0 prendre mesures perqu\u00e8 l'identificador no puga ser accessible per tercers i aix\u00ed poder accedir a les dades emmagatzemades. Segons l' OWASP : Session settings are some of the MOST important values to concentrate on in configuring. It is a good practice to change session.name to something new. I proposen la seg\u00fcent configuraci\u00f3 b\u00e0sica: session.save_path = /path/PHP-session/ session.name = myPHPSESSID session.auto_start = Off session.use_trans_sid = 0 session.cookie_domain = full.qualified.domain.name #session.cookie_path = /application/path/ session.use_strict_mode = 1 session.use_cookies = 1 session.use_only_cookies = 1 session.cookie_lifetime = 14400 # 4 hours session.cookie_secure = 1 session.cookie_httponly = 1 session.cookie_samesite = Strict session.cache_expire = 30 session.sid_length = 256 session.sid_bits_per_character = 6 # PHP 7.2+ session.hash_function = 1 # PHP 7.0-7.1 session.hash_bits_per_character = 6 # PHP 7.0-7.1 Les recomanacions en major detall:","title":"Usa sessions"},{"location":"04-web-programming/04-04-best-practices/#control-de-la-vida-de-sessio","text":"Fes que expire la sessi\u00f3 despr\u00e9s d\u2019un curt per\u00edode d\u2019inactivitat : ajusteu el temps d\u2019inactivitat a 5 minuts per a aplicacions altament protegides fins a no m\u00e9s de 30 minuts per a aplicacions de baix risc. Habilita l\u2019opci\u00f3 de tancament de sessi\u00f3 : caduca i destrueix expl\u00edcitament la sessi\u00f3 en tancar la sessi\u00f3. Eviteu els inicis de sessi\u00f3 persistents (opci\u00f3 \"recordeu-me\") : opcionalment podeu restringir la informaci\u00f3 conservada i revelada per l'aplicaci\u00f3, \u00e9s a dir, obligar a l'usuari a tornar a iniciar sessi\u00f3 abans de realitzar cap operaci\u00f3 cr\u00edtica. Fes que expire la sessi\u00f3 quan hi haja error de seguretat : qualsevol error de seguretat de l'aplicaci\u00f3 hauria de donar lloc a la finalitzaci\u00f3 de la sessi\u00f3. Fes caducar la sessi\u00f3 quan siga de llarga durada : obligaci\u00f3 a reautentificar la sessi\u00f3, que tot i estar actiu ha arribat al temps m\u00e0xim perm\u00e8s, p.e. unes poques hores. Elimineu la galleta de sessi\u00f3 en destruir una sessi\u00f3 .","title":"Control de la vida de sessi\u00f3"},{"location":"04-web-programming/04-04-best-practices/#identificador-de-sessio","text":"Utilitzeu nom\u00e9s galetes per propagar l\u2019ID de sessi\u00f3 , ja que quan es transmeten mitjan\u00e7ant un par\u00e0metre URL, les sol\u00b7licituds GET poden ser emmagatzemades a l\u2019historial del navegador, a la mem\u00f2ria cau i als marcadors. Aleshores tamb\u00e9 es pot visualitzar f\u00e0cilment. Regenereu l'identificador de sessi\u00f3 : regenereu (substitu\u00efu-ne per un de nou) l'identificador de sessi\u00f3, almenys cada cop que canvie el nivell de privilegi de l'usuari. Generalment es pot regenerar abans de qualsevol transacci\u00f3 important, despr\u00e9s d\u2019un determinat nombre de sol\u00b7licituds o despr\u00e9s d\u2019un per\u00edode de temps. Comproveu si l'identificador de sessi\u00f3 \u00e9s v\u00e0lid (de mida i tipus previst) i que ha estat generat per l'aplicaci\u00f3 i no proporcionat per l'usuari. L'identificador de sessi\u00f3 hauria de ser adequadament llarg, imprevisible, dif\u00edcil de reproduir i creat a partir de fonts aleat\u00f2ries d'alta qualitat .","title":"Identificador de sessi\u00f3"},{"location":"04-web-programming/04-04-best-practices/#cookie-de-sessio","text":"Definiu el domini de la galleta a quelcom m\u00e9s espec\u00edfic que el domini de primer nivell. No emmagatzeneu res a la galleta (almenys qualsevol informaci\u00f3 sensible com el nom d\u2019usuari o la contrasenya) sols\u2019ID de sessi\u00f3. Definiu el senyalador nom\u00e9s http per desactivar la captura de l'identificador de sessi\u00f3 mitjan\u00e7ant XSS. Quan siga possible, utilitzeu un xifrat fort (SSL) i l'atribut cookie_secure per permetre la transmissi\u00f3 de cookies nom\u00e9s a trav\u00e9s de https.","title":"Cookie de sessi\u00f3"},{"location":"04-web-programming/04-04-best-practices/#emmagatzematge-de-dades-de-sessio","text":"Determineu on s'emmagatzemen les dades de sessi\u00f3 i si es tracta d\u2019un sistema de fitxers o d\u2019una base de dades, determineu qui m\u00e9s podria tenir acc\u00e9s a aquestes dades. Quan s'emmagatzemen les dades de sessi\u00f3 en fitxers, assegureu-vos que l'aplicaci\u00f3 est\u00e0 configurada per utilitzar un directori privat independent (per exemple, la directiva session.save_path ). Utilitzeu els permisos del sistema de fitxers per protegir aquests fitxers d\u2019observaci\u00f3 o modificaci\u00f3 d\u2019usuaris diferents dels comptes necessaris per operar el servidor web i les aplicacions. Si aix\u00f2 no \u00e9s possible, cal xifrar les dades de la sessi\u00f3 o contenir nom\u00e9s dades no sensibles. Tingueu en compte que PHP utilitza de manera predeterminada el directori temporal del sistema p\u00fablic. Totes les variables de sessi\u00f3 s\u2019han de validar i sanejar per assegurar-se que siguem correctes i que no cont\u00e9 car\u00e0cters inesperats.","title":"Emmagatzematge de dades de sessi\u00f3"},{"location":"04-web-programming/04-04-best-practices/#no-coneixer-les-contrasenyes","text":"Al final, tothom crea una aplicaci\u00f3 PHP que es basa en la sessi\u00f3 d\u2019usuari. Els noms d\u2019usuari i les contrasenyes s\u2019emmagatzemen en una base de dades i s\u2019utilitzen posteriorment per autentificar els usuaris despr\u00e9s de l\u2019inici de sessi\u00f3. \u00c9s important que fer hash de les contrasenyes correctament abans d\u2019emmagatzemar-les. El hashing i el xifrat s\u00f3n dues coses molt diferents que sovint es confonen. El hashing \u00e9s una funci\u00f3 irreversible i unidireccional. \u00c9s produeix una cadena de longitud fixa que no es pot invertir. Aix\u00f2 vol dir que podeu comparar un hash amb un altre per determinar si tots dos provenien de la mateixa cadena font, per\u00f2 no podeu determinar la cadena original. Si les contrasenyes no s'emmagatzemen amb hashing i un tercer no autoritzat accedeix a la vostra base de dades, tots els comptes d'usuari estaran compromesos. A difer\u00e8ncia del hashing , el xifrat \u00e9s reversible (sempre que tingueu la clau). El xifratge \u00e9s \u00fatil en altres \u00e0rees, per\u00f2 \u00e9s una estrat\u00e8gia deficient per emmagatzemar contrasenyes de forma segura. Les contrasenyes tamb\u00e9 han de salar-se individualment afegint una cadena aleat\u00f2ria a cada contrasenya abans d'aplicar hashing . Aix\u00f2 evita els atacs de diccionari i l'\u00fas de \"taules de l'arc de Sant Mart\u00ed\" (una llista inversa de hash criptogr\u00e0fics per a contrasenyes comunes.) El hashing i el salat s\u00f3n vitals, ja que sovint els usuaris utilitzen la mateixa contrasenya per a diversos serveis i la qualitat de la contrasenya \u00e9s deficient. Addicionalment, haureu d'utilitzar un algorisme especialitzat en hashing en lloc d'una funci\u00f3 de hash criptogr\u00e0fic de prop\u00f2sit general i r\u00e0pid (per exemple, SHA256). La llista breu d'algorismes de hashing de contrasenya acceptables (a juny de 2018) a utilitzar s\u00f3n: Argon2 (disponible a PHP 7.2 i versions posteriors) Scrypt Bcrypt (PHP us proporciona aquesta; vegeu m\u00e9s avall) PBKDF2 amb HMAC-SHA256 o HMAC-SHA512 Afortunadament, avui en dia PHP ens ho facilita.","title":"No con\u00e8ixer les contrasenyes"},{"location":"04-web-programming/04-04-best-practices/#hashing-de-contrasenyes-amb-password_hash","text":"A PHP 5.5 s'ha introdu\u00eft password_hash() . En aquest moment est\u00e0 utilitzant BCrypt, l'algorisme m\u00e9s fort actualment suportat per PHP. Tot i aix\u00f2, s'actualitzar\u00e0 en el futur per donar suport a m\u00e9s algoritmes. La biblioteca de password_compat es va crear per proporcionar una compatibilitat de PHP> = 5.3.7. A continuaci\u00f3 hem aplicat hashing a una cadena i, a continuaci\u00f3, apliquem el hashing contra una nova cadena. Com que les dues cadenes d'origen s\u00f3n diferents (\"contrasenya-secreta\" i \"contrasenya-err\u00f2nia\"), aquesta sessi\u00f3 fallar\u00e0. $passwordHash = password_hash ( \"contrasenya-secreta\" , PASSWORD_DEFAULT ); if ( password_verify ( \"contrasenya-err\u00f2nia\" , $passwordHash )) { // Contrasenya correcta } else { // Contrasenya incorrecta } password_hash() s'ocupa de la salificaci\u00f3 de contrasenyes. La sal s'emmagatzema, juntament amb l'algorisme i el \"cost\", com a part del hash. password_verify() extreu aix\u00f2 per determinar com comprovar la contrasenya, de manera que no necessiteu un camp de base de dades independent per emmagatzemar les vostres sals. PASSWORD_DEFAULT Actualment utilitza l\u2019algoritme bcrypt (predeterminat a partir de PHP 5.5.0). Observeu que aquesta constant est\u00e0 pensada per a adaptar-se sempre que hi haja un algoritme nou i m\u00e9s fort a PHP. Per aquesta ra\u00f3, la longitud del resultat d\u2019utilitzar aquest identificador pot canviar amb el temps. Per tant, es recomana emmagatzemar el resultat en una columna d\u2019una base de dades de m\u00e9s de 60 caracters (255 caracters seria una bona elecci\u00f3).","title":"Hashing de contrasenyes amb password_hash"},{"location":"04-web-programming/04-04-best-practices/#recursos","text":"The 2018 Guide to Building Secure PHP Software PHP: The Right Way. Security Session Management Basics Ultimate PHP Security Best Practices PHP Session Security Best Practices PHP Sessions in depth Session Management Cheat Sheet","title":"Recursos"},{"location":"04-web-programming/04-05-http-authentication/","text":"Autenticaci\u00f3 d'usuaris i control d'acc\u00e9s Moltes vegades \u00e9s important verificar la identitat dels dos extrems d'una comunicaci\u00f3, hi ha m\u00e8todes per identificar tant al servidor en el qual s'allotja el lloc web, com a l'usuari del navegador que es troba en l'altre extrem. Els llocs web que necessiten emprar identificaci\u00f3 de servidor, com les botigues o els bancs, utilitzen el protocol HTTPS . Aquest protocol requereix d'un certificat digital v\u00e0lid, signat per una autoritat fiable, que \u00e9s verificat pel navegador quan s'accedeix a la p\u00e0gina web. A m\u00e9s, HTTPS utilitza m\u00e8todes de xifrat per crear un canal segur entre el navegador i el servidor, de tal manera que no es puga interceptar la informaci\u00f3 que es transmet pel mateix. Per identificar els usuaris que visiten un lloc web, es poden utilitzar diferents m\u00e8todes com el DNI digital o certificats digitals d'usuari (document digital que cont\u00e9 informaci\u00f3 sobre l'usuari com el nom o l'adre\u00e7a. Aquesta informaci\u00f3 est\u00e0 signada per una altra entitat, anomenada entitat certificadora, que ha de ser de confian\u00e7a i garanteix que la informaci\u00f3 que cont\u00e9 \u00e9s certa), per\u00f2 el m\u00e9s est\u00e8s \u00e9s sol\u00b7licitar a l'usuari certa informaci\u00f3 que nom\u00e9s ell coneix: la combinaci\u00f3 d'un nom d'usuari i una contrasenya. En les unitats anteriors vas aprendre a utilitzar aplicacions web per gestionar informaci\u00f3 emmagatzemada en bases de dades. En la majoria dels casos \u00e9s important implantar en aquest tipus de aplicacions web, les que accedeixen a bases de dades, algun mecanisme de control d'acc\u00e9s que obligui a l'usuari a identificar-se. Un cop identificat, es pot limitar l'\u00fas que pot fer de la informaci\u00f3. Aix\u00ed, pot haver llocs web en els quals els usuaris autenticats poden utilitzar nom\u00e9s una part de la informaci\u00f3 (com els bancs, que permeten als seus clients accedir \u00fanicament a la informaci\u00f3 relativa als seus comptes). Altres llocs web necessiten separar en grups als usuaris autentificats, de tal manera que la informaci\u00f3 a la qual accedeix un usuari dep\u00e8n del grup en qu\u00e8 aquest es trobe. Per exemple, una aplicaci\u00f3 de gesti\u00f3 d'una empresa pot tenir un grup d'usuaris als qui permet visualitzar la informaci\u00f3, i un altre grup d'usuaris que, a m\u00e9s de visualitzar la informaci\u00f3, tamb\u00e9 la poden modificar. Autenticaci\u00f3, control d'acc\u00e9s i seguretat en les comunicacions Has distingir l'autenticaci\u00f3 dels usuaris i el control d'acc\u00e9s, de la utilitzaci\u00f3 de mecanismes per assegurar les comunicacions entre l'usuari de el navegador i el servidor web. Encara que tots dos aspectes solen anar units, s\u00f3n independents. En els exemples d'aquesta unitat, la informaci\u00f3 d'autenticaci\u00f3 (nom i contrasenya dels usuaris) s'envia en text pla des del navegador fins al servidor web. Aquesta pr\u00e0ctica \u00e9s altament insegura i mai s'ha d'usar sense un protocol com HTTPS que permeta xifrar les comunicacions amb el lloc web. No obstant aix\u00f2, la configuraci\u00f3 de servidors web que permeten fer servir el protocol HTTPS per xifrar la informaci\u00f3 que reben i transmeten no forma part dels continguts d'aquest m\u00f2dul. Per aquest motiu, durant aquesta unitat utilitzarem \u00fanicament el protocol no segur HTTP. Mecanismes d'autenticaci\u00f3 via HTTP El protocol HTTP ofereix un m\u00e8tode senzill per autenticar els usuaris. El proc\u00e9s \u00e9s el seg\u00fcent: El servidor web ha de proveir algun m\u00e8tode per definir els usuaris que s'utilitzaran i com es poden autentificar. A m\u00e9s, s'hauran de definir els recursos als quals es restringeix l'acc\u00e9s i quina llista de control d'acc\u00e9s (ACL - llista de permisos sobre un objecte (fitxer, directori, etc.), que indica quins usuaris poden utilitzar l'objecte i les accions concretes que poden realitzar amb el mateix (lectura, escriptura, esborrat, etc.)) s'aplica a cada un. Quan un usuari no autenticat intenta accedir a un recurs restringit, el servidor web respon amb un error de \"Acc\u00e9s no autoritzat\" (codi 401). El navegador rep l'error i obre una finestra per sol\u00b7licitar a l'usuari que es autentifiqui mitjan\u00e7ant el seu nom i contrasenya. La informaci\u00f3 d'autenticaci\u00f3 de l'usuari s'envia a servidor, que la verifica i decideix si permet o no l'acc\u00e9s a el recurs sol\u00b7licitat. Aquesta informaci\u00f3 es mant\u00e9 en el navegador per utilitzar-se en posteriors peticions a aquest servidor. Al servidor web Apache, el que has estat utilitzant en anteriors unitats, hi ha una utilitat en l\u00ednia d'ordres, htpasswd , que permet emmagatzemar en un fitxer una llista d'usuaris i els seus respectives contrasenyes. La informaci\u00f3 relativa a les contrasenyes s'emmagatzema xifrada; tot i aix\u00ed, \u00e9s convenient crear aquest fitxer en un lloc no accessible pels usuaris de servidor web. http://httpd.apache.org/docs/2.0/es/howto/auth.html Per exemple, per crear el fitxer d'usuari i afegir-li el usuari \"dwes\", pots fer: sudo htpasswd -c users dwes i introduir la contrasenya corresponent a aquest usuari. L'opci\u00f3 -c indica que s'ha de crear el fitxer, per la qual cosa nom\u00e9s haur\u00e0s de fer-la servir quan introdueixis el primer usuari i contrasenya. Fixa't que en l'exemple anterior, el fitxer es crea a la ruta /etc/apache2/users, que en principi no \u00e9s accessible via web. Per indicar-li a l'servidor Apache quins recursos tenen acc\u00e9s restringit, una opci\u00f3 \u00e9s crear un fitxer .htaccess en el directori en qu\u00e8 es trobin, amb les seg\u00fcents directives: AuthName \"Contingut restringit\" AuthType Basic AuthUserFile /etc/apache2/users requereix valid-user El significat de cadascuna de les directives anteriors \u00e9s el seg\u00fcent: Directiva significat AuthName Nom de domini que es far\u00e0 servir en l'autenticaci\u00f3. Si el client s'autentica correctament, aquesta mateixa informaci\u00f3 d'autenticaci\u00f3 s'utilitzar\u00e0 autom\u00e0ticament en la resta de les p\u00e0gines de el mateix domini. AuthType M\u00e8tode d'autenticaci\u00f3 que es far\u00e0 servir. A m\u00e9s de l'm\u00e8tode Basic, Apache tamb\u00e9 permet utilitzar el m\u00e8tode Digest. AuthUserFile Cam\u00ed de l'arxiu de credencials que has creat amb htpasswd. Require Permet indicar que nom\u00e9s puguin accedir alguns usuaris o grups d'usuaris concrets. Si indiquem \"valid-user\", podran accedir tots els usuaris que es s'autentifiquin correctament. A m\u00e9s, haur\u00e0s de assegurar-te que en la configuraci\u00f3 d'Apache s'utilitza la directiva AllowOverride perqu\u00e8 s'aplique correctament la configuraci\u00f3 que figura en els fitxers .htaccess . M\u00e9s detalls en http://httpd.apache.org/docs/2.0/es/mod/core.html#allowoverride A l'incloure l'opci\u00f3 -c el que fem \u00e9s crear un nou fitxer, amb la qual cosa eliminem el contingut anterior del mateix. Mecanismes d'autenticaci\u00f3 Des PHP pots accedir a la informaci\u00f3 d'autenticaci\u00f3 HTTP que ha introdu\u00eft l'usuari utilitzant l'array superglobal $_SERVER . valor contingut $_SERVER['PHP_AUTH_USER'] Nom d'usuari que s'ha introdu\u00eft. $_SERVER['PHP_AUTH_PW'] Clau introdu\u00efda. $_SERVER['AUTH_TYPE'] M\u00e8tode HTTP usat per autentificar. Pot ser Basic o Digest. \u00c9s a dir, que si crees una p\u00e0gina web que mostre els valors d'aquestes variables, i prepares el servidor web per utilitzar autenticaci\u00f3 HTTP, quan accedisques a aquesta p\u00e0gina amb l'usuari \"dwes\" obtindr\u00e0s alguna cosa com el seg\u00fcent: <!DOCTYPE html PUBLIC \"- // W3C // DTD HTML 4.01 Transitional // EN\" \"http://www.w3.org/TR/html4/loose.dtd \"> <!-- Desenvolupament Web a Entorn Servidor --> <!-- Tema 4: Desenvolupament d'aplicacions web amb PHP --> <!-- Exemple: Autenticaci\u00f3 HTTP --> < html > < head > < meta http-equiv = \"content-type\" content = \"text / html; charset = UTF-8\" /> < title > Exemple Tema 4: Autenticaci\u00f3 HTTP </ title > < link href = \"dwes.css\" rel = \"stylesheet\" type = \"text / css\" /> </ head > < body > <?php echo \"Nom d'usuari:\". $_ SERVER['PHP_AUTH_USER']. \"<br />\"; echo \"Contrasenya:\". $_ SERVER['PHP_AUTH_PW']. \"<br />\"; echo \"M\u00e8tode d'autenticaci\u00f3:\". $_SERVER['AUTH_TYPE']. \"<br />\"; ?> </ body > </ html > Si no introdueixes un usuari/contrasenya v\u00e0lids, el navegador et mostrar\u00e0 l'error 401. A m\u00e9s, en PHP pots utilitzar la funci\u00f3 header per for\u00e7ar que el servidor envie un error de \"Acc\u00e9s no autoritzat\" (codi 401). D'aquesta manera no cal utilitzar fitxers .htaccess per indicar-li a Apache quins recursos estan restringits. En el seu lloc, pots afegir les seg\u00fcents l\u00ednies en les teves p\u00e0gines PHP: <? php if ( ! isset ( $_ SERVER [ 'PHP_AUTH_USER' ])) { header ( 'WWW-Authenticate: Basic Realm = \"Contingut restringit\"' ); header ( 'HTTP/1.0 401 Unauthorized' ); echo \"Usuari no reconegut!\" ; exit ; } ?> La funci\u00f3 header envia cap\u00e7aleres HTTP (bloc de dades que forma part de l'protocol HTTP i s'envia abans de la informaci\u00f3 pr\u00f2pia que es transmet. Permet especificar codis d'estat, accions requerides a servidor, o el tipus d'informaci\u00f3 que es transmet), per\u00f2 s'ha d'utilitzar abans que es mostre res per pantalla. En cas contrari, obtindr\u00e0s un error. M\u00e9s informaci\u00f3: http://es.php.net/manual/es/function.header.php Amb el codi anterior, la p\u00e0gina envia un error 401, el que for\u00e7a al navegador a sol\u00b7licitar les credencials d'acc\u00e9s (nom d'usuari i contrasenya). Si s'introdueixen, s'executa la resta de la p\u00e0gina i es mostra el seu contingut. En aquest cas, caldria afegir algun codi per comprovar que el nom d'usuari i contrasenya s\u00f3n v\u00e0lids, tal com veurem a continuaci\u00f3. Si es prem el bot\u00f3 \"Cancel\", es mostra el missatge d'error que s'indica. Modifica la p\u00e0gina anterior utilitzant la funci\u00f3 header perqu\u00e8 sol\u00b7liciti les credencials a l'usuari. Haur\u00e0s de crear una p\u00e0gina similar a l'anterior, i afegir el codi per for\u00e7ar l'error 401 abans de qualsevol altre. <! DOCTYPE html PUBLIC \"- // W3C // DTD HTML 4.01 Transitional // EN\" \" http://www.w3.org/TR/html4/loose.dtd \" > <!-- Desenvolupament Web a Entorn Servidor --> <!-- Tema 4 : Desenvolupament d 'aplicacions web amb PHP --> <!-- Exemple: Funci\u00f3 header per autenticaci\u00f3 HTTP --> <?php if (!isset($_SERVER[' PHP_AUTH_USER '])) { header(' WWW - Authenticate : Basic Realm = \"Contingut restringit\" '); header(' HTTP / 1.0 401 Unauthorized '); echo \"Usuari no reconegut!\"; exit; } ?> <html> <head> <meta http-equiv = \"content-type\" content = \"text / html; charset = UTF-8\"> <title> Exercici: Funci\u00f3 header per autenticaci\u00f3 HTTP </ title> <link href = \"dwes.css\" rel = \"stylesheet\" type = \"text / css\"> </head> <body> <?php echo \"Nom d' usuari : \". $_ SERVER['PHP_AUTH_USER']. \" < br /> \"; echo \" Contrasenya : \". $_ SERVER['PHP_AUTH_PW']. \" < br /> \"; ?> </body> </html> Incorporaci\u00f3 de m\u00e8todes d'autenticaci\u00f3 a una aplicaci\u00f3 web Si utilitzes la funci\u00f3 header per for\u00e7ar el navegador a sol\u00b7licitar credencials HTTP, l'usuari introduir\u00e0 un nom i una contrasenya. Per\u00f2 el servidor no ha de verificar aquesta informaci\u00f3; haur\u00e0s de ser tu qui prove\u00efsca un m\u00e8tode per comprovar que les credencials que ha introdu\u00eft l'usuari s\u00f3n correctes. El m\u00e8tode m\u00e9s simple \u00e9s incloure en el codi PHP de la teva p\u00e0gina les sent\u00e8ncies necess\u00e0ries per comparar les dades introdu\u00efdes amb altres dades fixos. Per exemple, per a permetre l'acc\u00e9s a un usuari \"dwes\" amb contrasenya \"abc123.\", pots fer: if ( $_SERVER [ 'PHP_AUTH_USER' ] != 'dwes' || $_SERVER [ 'PHP_AUTH_PW' ] != 'abc123.' ) { header ( 'WWW-Authenticate: Basic Realm = \"Contingut restringit\"' ); header ( 'HTTP / 1.0 401 Unauthorized' ); echo \"Usuari no reconegut!\" ; exit ; } ?> Recorda que el codi PHP no s'envia al navegador, de manera que la informaci\u00f3 d'autenticaci\u00f3 que introdueixis en el codi no ser\u00e0 visible per l'usuari. No obstant aix\u00f2, aix\u00f2 far\u00e0 el teu codi menys portable. Si necessites modificar el nom d'usuari o la contrasenya, haur\u00e0s de fer modificacions en el codi. A m\u00e9s, no podr\u00e0s permetre a l'usuari introduir la seva pr\u00f2pia contrasenya. Una soluci\u00f3 millor \u00e9s utilitzar un emmagatzematge extern per als noms d'usuari i les seves contrasenyes. Per aix\u00f2 podries emprar un fitxer de text, o millor encara, una base de dades. La informaci\u00f3 d'autenticaci\u00f3 podr\u00e0 estar a\u00efllada en la seva pr\u00f2pia base de dades, o compartir espai d'emmagatzematge amb les dades que utilitze la teva aplicaci\u00f3 web. Si vols emmagatzemar la informaci\u00f3 dels usuaris a la base de dades \" dwes \", has de crear una nova taula en la seva estructura. Per a aix\u00f2, revisa i executa aquestes sent\u00e8ncies SQL. -- Seleccionem la base de dades USE dwes ; -- Creem la taula CREATE TABLE usuaris ( usuari VARCHAR ( 20 ) NOT NULL PRIMARY KEY , contrasenya VARCHAR ( 32 ) NOT NULL ) ENGINE = InnoDB ; -- Creem l'usuari dwes INSERT INTO usuaris ( usuari , contrasenya ) VALUES ( 'dwes' , 'e8dc8ccd5e5f9e3a54f07350ce8a2d3d' ); Tot i que es podrien emmagatzemar les contrasenyes en text pla, \u00e9s millor fer-ho en format encriptat. En l'exemple anterior, per a l'usuari \"dwes\" s'emmagatzema el hash MD5 (m\u00e8tode per generar un resum d'un text o un document, de tal manera que a partir de l'resum obtingut no \u00e9s possible recuperar el text original ni estar un altre text a partir de el qual s'obtingui el mateix resum. Es diu hash a el resum obtingut a l'aplicar una funci\u00f3 hash. Una de les funcions hash m\u00e9s esteses \u00e9s MD5, que genera 128 bits com a resum (normalment es representa mitjan\u00e7ant una cadena de text de 28 car\u00e0cters o mitjan\u00e7ant 32 d\u00edgits hexadecimals)) corresponent a la contrasenya \"abc123.\". En PHP pots utilitzar la funci\u00f3 md5 per calcular el hash MD5 d'una cadena de text. http://es.php.net/manual/es/function.md5.php // Si l'usuari encara no s'ha entrat, demanem les credencials if (!isset ($_SERVER [ 'PHP_AUTH_USER'])) { header ('WWW-Authenticate: Basic realm = \"Contingut restringit\"'); header (\"HTTP/1.0 401 Unauthorized\"); exit; } // Si ja ha enviat les credencials, les vam comprovar amb la base de dades else { // Connectem a la base de dades @$dwes = new mysqli(\"localhost\", \"dwes\", \"abc123.\", \"Dwes\"); $error = $dwes-> connect_errno; // Si es va establir la connexi\u00f3 if ($error == null) { // Executem la consulta per comprovar si existeix // aquesta combinaci\u00f3 d'usuari i contrasenya $sql \u200b\u200b= \"SELECT usuari FROM usuaris WHERE usuari = '$_ SERVER[PHP_AUTH_USER]' AND contrasenya = md5 ( '$_ SERVER[PHP_AUTH_PW]') \"; $resultat = $dwes-> query ($sql); // Si no existeix, es tornen a demanar les credencials if ($resultat-> num_rows == 0) { header ( 'WWW-Authenticate: Basic realm = \"Contingut restringit\"'); header ( \"HTTP / 1.0 401 Unauthorized\"); exit; } $resultat->close(); $dwes->close(); } } <!DOCTYPE html PUBLIC \"- // W3C // DTD HTML 4.01 Transitional // EN\" \"http://www.w3.org/TR/html4/loose.dtd \" > <!-- Desenvolupament Web a Entorn Servidor --> <!-- Tema 4: Desenvolupament d'aplicacions web amb PHP --> <!-- Exemple: Utilitzaci\u00f3 de MySQL per autenticaci\u00f3 HTTP --> < html > < head > < meta http-equiv = \"content-type\" content = \"text / html; charset = UTF-8\" > < title > Exemple Tema 4: Utilitzaci\u00f3 de MySQL per autenticaci\u00f3 HTTP </ title > < link href = \"dwes.css\" rel = \"stylesheet\" type = \"text / css\" > </ head > < body > <?php echo \"Nom d'usuari:\" . $_ SERVER [ 'PHP_AUTH_USER' ] . \"<br />\" ; echo \"Hash de la contrasenya:\" . md5 ( $_ SERVER [ 'PHP_AUTH_PW' ]) . \"<br />\" ; ?> </ body > </ html > Galetes ( cookies ) Una galleta \u00e9s un fitxer de text que un lloc web guarda a l'entorn de l'usuari de navegador. El seu \u00fas m\u00e9s t\u00edpic \u00e9s l'emmagatzematge de les prefer\u00e8ncies de l'usuari (per exemple, l'idioma en que s'han de mostrar les p\u00e0gines), perqu\u00e8 no hagi de tornar a indicar-les la propera vegada que visiteu el lloc. Si utilitzes Firefox com a navegador, pots accedir a Desenvolupador web \u2013 Inspector d'emmagatzematge des del men\u00fa principal. Entre les seves caracter\u00edstiques et permet consultar i editar les galetes emmagatzemades en el mateix. En PHP, per emmagatzemar una galleta al navegador de l'usuari, pots utilitzar la funci\u00f3 setcookie . L'\u00fanic par\u00e0metre obligatori que has de fer servir \u00e9s el nom de la galleta, per\u00f2 admet diversos par\u00e0metres m\u00e9s opcionals. setcookie Per a m\u00e9s informaci\u00f3 consulta: https://www.php.net/manual/es/function.setcookie.php . Per exemple, si vols emmagatzemar en una galleta el nom d'usuari que es va transmetre a les credencials HTTP (\u00e9s nom\u00e9s un exemple, no \u00e9s en absolut aconsellable emmagatzemar informaci\u00f3 relativa a la seguretat en les galetes), pots fer: setcookie ( \"nom_usuari\" , $_SERVER [ 'PHP_AUTH_USER' ], time () + 3600 ); Els dos primers par\u00e0metres s\u00f3n el nom de la galleta i el seu valor. El tercer \u00e9s la data de caducitat de la mateixa (una hora des del moment en qu\u00e8 s'execute). En cas de no figurar aquest par\u00e0metre, la galleta s'eliminar\u00e0 quan es tanqui el navegador. Tingues en compte que tamb\u00e9 es poden aplicar restriccions a les p\u00e0gines de el lloc que poden accedir a una galleta en funci\u00f3 de la ruta. Les galetes es transmeten entre el navegador i el servidor web de la mateixa manera que les credencials que acabes de veure; utilitzant les cap\u00e7aleres de el protocol HTTP. Per aix\u00f2, les sent\u00e8ncies setcookie s'han d'enviar abans que el navegador mostri cap informaci\u00f3 a pantalla. El proc\u00e9s de recuperaci\u00f3 de la informaci\u00f3 que emmagatzema una galleta \u00e9s molt simple. quan accedeixes a un lloc web, el navegador li envia de forma autom\u00e0tica tot el contingut de les galetes que emmagatzemi relatives a aquest lloc en concret. Des PHP pots accedir a aquesta informaci\u00f3 per mitj\u00e0 de l'array $_COOKIE . important Sempre que utilitzes galetes en una aplicaci\u00f3 web, heu de tenir en compte que en \u00faltima inst\u00e0ncia la seva disponibilitat est\u00e0 controlada pel client. Per exemple, alguns usuaris deshabiliten les galetes al navegador perqu\u00e8 pensen que la informaci\u00f3 que emmagatzemen pot suposar un potencial problema de seguretat. O la informaci\u00f3 que emmagatzemen pot arribar a perdre perqu\u00e8 el usuari decideix formatar l'equip o simplement eliminar-les de sistema. Si un cop emmagatzemada una galleta al navegador vols eliminar abans que expire, pots utilitzar la mateixa funci\u00f3 setcookie per\u00f2 indicant una data de caducitat anterior a l'actual. Sobre el mateix exercici anterior, emmagatzema en una galleta l'\u00faltim instant en qu\u00e8 el usuari va visitar la p\u00e0gina. Si \u00e9s la seva primera visita, mostra un missatge de benvinguda. En cas contrari, mostra la data i hora de la seva anterior visita. Revisa la soluci\u00f3 proposada. Haur\u00e0s utilitzar la funci\u00f3 setcookie per guardar l'instant de la seva anterior visita i mostrar el seu contingut utilitzant l'array $_COOKIE . // Si l'usuari encara no s'ha entrat, demanem les credencials if ( ! isset ( $_ SERVER [ 'PHP_AUTH_USER' ])) { header ( 'WWW-Authenticate: Basic realm = \"Contingut restringit\"' ); header ( \"HTTP / 1.0 401 Unauthorized\" ); exit ; } // Si ja ha enviat les credencials, les vam comprovar amb la base de dades else { // Connectem a la base de dades @ $dwes = new mysqli ( \"localhost\" , \"dwes\" , \"abc123.\" , \"Dwes\" ); $error = $dwes -> connect_errno ; // Si es va establir la connexi\u00f3 if ( $error == null ) { date_default_timezone_set ( 'Europe/Madrid' ); // Executem la consulta per comprovar si existeix // aquesta combinaci\u00f3 d'usuari i contrasenya $sql \u200b\u200b = \"SELECT usuari FROM usuaris WHERE usuari = '${_ SERVER [' PHP_AUTH_USER ']}' AND contrasenya = md5 ( '${_ SERVER [' PHP_AUTH_PW ']}') \" ; $resultat = $dwes -> query ( $sql ); // Si no existeix, es tornen a demanar les credencials if ( $resultat -> num_rows == 0 ) { header ( 'WWW-Authenticate: Basic realm = \"Contingut restringit\"' ); header ( \"HTTP / 1.0 401 Unauthorized\" ); exit ; } else { if ( isset ( $_ COOKIE [ 'ultimo_login' ])) { $ultimo_login = $_COOKIE [ 'ultimo_login' ]; } setcookie ( \"ultimo_login\" , time (), time () + 3600 ); } $resultat -> close (); $dwes -> close (); } } ?> <!DOCTYPE html PUBLIC \"- // W3C // DTD HTML 4.01 Transitional // EN\" \" http://www.w3.org/TR/html4/loose.dtd \"> <!-- Desenvolupament Web a Entorn Servidor --> <!-- Tema 4: Desenvolupament d'aplicacions web amb PHP --> <!-- Exemple: Galetes al autenticaci\u00f3 HTTP --> <html> <head> <meta http-equiv = \"content-type\" content = \"text / html; charset = UTF-8\"> <title> Exemple Tema 4: Galetes al autenticaci\u00f3 HTTP </ title> <link href = \"dwes.css\" rel = \"stylesheet\" type = \"text / css\"> </head> <body> <?php if ( $error == null ) { echo \"Nom d'usuari:\" . $_ SERVER [ 'PHP_AUTH_USER' ] . \"<br />\" ; echo \"Hash de la contrasenya:\" . md5 ( $_ SERVER [ 'PHP_AUTH_PW' ]) . \"<br />\" ; if ( isset ( $ultimo_login )) echo \"Darrer login:\" . date ( \"d/m/ i \\ a \\ l \\ a \\ s H: i\" , $ultimo_login ); else echo \"Benvingut. Aquesta \u00e9s la seva primera visita.\" ; } else echo \"S'ha produ\u00eft l'error $error . <br />\" ; ?> </body> </html> Reflexiona Quina \u00e9s la durada per defecte d'una galleta si no s'indica la data de caducitat, com en la seg\u00fcent crida a la funci\u00f3 setcookie? setcookie ( \"idioma\" , \"espanyol\" ); Fins que es tanque el navegador de l'usuari. 1 hora. Maneig de sessions Com acabes de veure, una forma per guardar informaci\u00f3 particular de cada usuari \u00e9s utilitzar galetes ( cookies ). No obstant aix\u00f2, hi ha diversos problemes associats a les galetes, com el nombre d'elles que admet el navegador, o la seva grand\u00e0ria m\u00e0xima. Per solucionar aquests inconvenients, existeixen les sessions. El terme sessi\u00f3 fa refer\u00e8ncia al conjunt d'informaci\u00f3 relativa a un usuari concret. Aquesta informaci\u00f3 pot ser tan simple com el nom de l'usuari mateix, o m\u00e9s complexa, com els articles que ha dipositat a la cistella de compra d'una botiga en l\u00ednia. Cada usuari diferent d'un lloc web t\u00e9 la seva pr\u00f2pia informaci\u00f3 de sessi\u00f3. Per distingir una sessi\u00f3 d'una altra s'usen els identificadors de sessi\u00f3 (SID). Un SID \u00e9s un atribut que s'assigna a cada un dels visitants d'un lloc web i l'identifica. D'aquesta manera, si el servidor web coneix el SID d'un usuari, pot relacionar-lo amb tota la informaci\u00f3 que posseeix sobre ell, que es mant\u00e9 en la sessi\u00f3 de l'usuari. Aquesta informaci\u00f3 s'emmagatzema en el servidor web, generalment en fitxers tot i que tamb\u00e9 es poden utilitzar altres mecanismes d'emmagatzematge com bases de dades. Com ja haur\u00e0s suposat, la q\u00fcesti\u00f3 ara \u00e9s: \u00bfi on s'emmagatzema aquest SID, identificador de la sessi\u00f3, que \u00e9s \u00fanic per a cada usuari? Doncs hi ha dues maneres de mantenir el SID entre les p\u00e0gines d'un lloc web que visita l'usuari: Utilitzant galetes. Propagant el SID en un par\u00e0metre de la URL. El SID s'afegeix com una part m\u00e9s de la URL, de la forma: http://www.misitioweb.com/tienda/listado.php& PHPSESSID=34534fg4ffg34ty En l'exemple anterior, el SID \u00e9s el valor del par\u00e0metre PHPSESSID. Cap de les dues maneres \u00e9s perfecta. Ja saps els problemes que t\u00e9 la utilitzaci\u00f3 de cookies. Malgrat aix\u00f2, \u00e9s el millor m\u00e8tode i el m\u00e9s utilitzat. Propagar el SID com a part de la URL comporta majors desavantatges, com la impossibilitat de mantenir el SID entre diferents sessions, o el fet que compartir la URL amb una altra persona implica compartir tamb\u00e9 l'identificador de sessi\u00f3. La bona not\u00edcia, \u00e9s que el proc\u00e9s de maneig de sessions en PHP est\u00e0 automatitzat en gran mida. Quan un usuari visita un lloc web, no cal programar un procediment per veure si hi ha un SID previ i carregar les dades associades amb el mateix. Tampoc has d'utilitzar la funci\u00f3 setcookie si vols emmagatzemar els SID en galetes, o anar passant el SID entre les p\u00e0gines web del teu lloc si et decideixes per propagar. Tot aix\u00f2 PHP ho fa autom\u00e0ticament. Server side cookies A la informaci\u00f3 que s'emmagatzema en la sessi\u00f3 d'un usuari tamb\u00e9 se li coneix com a galetes en la part de servidor ( server side cookies ). Has de tenir en compte que encara aquesta informaci\u00f3 no viatja entre el client i el servidor, s\u00ed que ho fa el SID, b\u00e9 com a part de l'URL o en una cap\u00e7alera HTTP si es guarda en una galleta. En tots dos casos, aix\u00f2 planteja un possible problema de seguretat. El SID pot ser aconseguit per una altra persona, i a partir de la mateixa obtenir la informaci\u00f3 de la sessi\u00f3 de l'usuari. La manera m\u00e9s segura d'utilitzar sessions \u00e9s emmagatzemant els SID en galetes i utilitzar HTTPS per a xifrar la informaci\u00f3 que es transmet entre el servidor web i el client. Configuraci\u00f3 Per defecte, PHP inclou suport de sessions incorporat. Abans, per\u00f2, d'utilitzar sessions en el teu lloc web, has de configurar correctament PHP utilitzant els seg\u00fcents directives en el fitxer php.ini segons correspongui: Directiva significat session.use_cookies Indica si s'han d'usar cookies (1) o propagaci\u00f3 a la URL (0) per emmagatzemar el SID. session.use_only_cookies S'ha d'activar (1) quan fas servir cookies per emmagatzemar els SID, i a m\u00e9s no vols que es reconeguin els SID que es puguin passar com part de la URL (aquest m\u00e8tode es pot usar per usurpar l'identificador d'un altre usuari) session.save_handler S'utilitza per indicar a PHP com ha de emmagatzemar les dades de la sessi\u00f3 de l'usuari. Hi ha quatre opcions: en fitxers (files), en mem\u00f2ria (Mm), en una base de dades SQLite (sqlite) o utilitzant per a aix\u00f2 funcions que ha de definir el programador (user). El valor per defecte (Files) funcionar\u00e0 sense problemes en la majoria dels casos. session.name Determina el nom de la galleta que s'utilitzar\u00e0 per guardar el SID. La seva valor per defecte \u00e9s PHPSESSID. session.auto_start El seu valor per defecte \u00e9s 0, i en aquest cas haur\u00e0s de fer servir la funci\u00f3 session_start per gestionar l'inici de les sessions. Si fas servir sessions al lloc web, pot ser bona idea canviar el seu valor a 1 per que PHP activi de forma autom\u00e0tica el maneig de sessions. session.cookie_lifetime Si utilitzes l'URL per propagar el SID, aquest es perdr\u00e0 quan tanqui el navegador. No obstant aix\u00f2, si utilitzes galetes, el SID es mantindr\u00e0 mentre no es destrueixi la galleta. En el seu valor per defecte (0), les galetes es destrueixen quan es tanca el navegador. Si vols que es mantingui el SID durant m\u00e9s temps, has d'indicar en aquesta directiva aquest temps en segons. session.gc_maxlifetime Indica el temps en segons que s'ha de mantenir activa la sessi\u00f3, encara que no hi hagi cap activitat per part de l'usuari. El seu valor per defecte \u00e9s 1440. \u00c9s a dir, passats 24 minuts des de l'\u00faltima activitat per part de l'usuari, es tanca la sessi\u00f3 autom\u00e0ticament. session.cookie_path URL path prefix that must match for the cookie to be sent. session.cookie_domain Domain suffix that must match for the cookie to be sent. No value means the cookie is sent back only to the full hostname that sent it. session.cookie_secure Set to On to have the cookie only sent back with HTTPS URLs. session.cookie_httponly Set to On to tell browsers to prevent JavaScript from reading the cookie. La funci\u00f3 phpinfo , de la qual ja vam parlar amb anterioritat, t'ofereix informaci\u00f3 sobre la configuraci\u00f3 actual de les directives de sessi\u00f3. En la documentaci\u00f3 de PHP tens informaci\u00f3 sobre aquestes i altres directives que permeten configurar el maneig de sessions. https://www.php.net/manual/es/session.configuration.php Question Si la informaci\u00f3 de l'usuari que vols emmagatzemar inclou contingut privat com una contrasenya, \u00bfqu\u00e8 utilitzaries, galetes o la sessi\u00f3 de l'usuari? Inici i fi d'una sessi\u00f3 L'inici d'una sessi\u00f3 pot tenir lloc de dues maneres. Si has activat la directiva session.auto_start en la configuraci\u00f3 de PHP, la sessi\u00f3 comen\u00e7ar\u00e0 autom\u00e0ticament quan un usuari es connecte al teu lloc web. En el cas que aquest usuari ja haja obert una sessi\u00f3 amb anterioritat, i aquesta no s'haja eliminat, en lloc d'obrir una nova sessi\u00f3 es reprendr\u00e0 la anterior. Per a aix\u00f2 s'utilitzar\u00e0 el SID anterior, que estar\u00e0 emmagatzemat en una galleta (recorda que si fas servir propagaci\u00f3 de l'SID, no podr\u00e0s restaurar sessions anteriors; el SID figura a la URL i es perd quan tanques el navegador). Si per contra, decideixes no utilitzar l'inici autom\u00e0tic de sessions, haur\u00e0s executar la funci\u00f3 session_start() per indicar a PHP que inicie una nova sessi\u00f3 o reprenga l'anterior. Anteriorment aquesta funci\u00f3 tornava sempre true , a partir de la versi\u00f3 5.3.0 de PHP el seu comportament \u00e9s m\u00e9s coherent: retorna false en cas de no poder iniciar o restaurar la sessi\u00f3. Com l'inici de sessi\u00f3 requereix utilitzar cookies , i aquestes es transmeten en els encap\u00e7alats HTTP, heu de tenir en compte que per poder iniciar una sessi\u00f3 utilitzant session_start , haur\u00e0s de fer les cridades a aquesta funci\u00f3 abans que la p\u00e0gina web mostre informaci\u00f3 al navegador. A m\u00e9s, totes les p\u00e0gines que necessiten utilitzar la informaci\u00f3 emmagatzemada en la sessi\u00f3, hauran d'executar la funci\u00f3 session_start . Mentre la sessi\u00f3 estiga oberta, pots utilitzar la variable superglobal $_SESSION per afegir informaci\u00f3 a la sessi\u00f3 de l'usuari, o per accedir a la informaci\u00f3 emmagatzemada en la sessi\u00f3. Per exemple, per comptar el nombre de vegades que l'usuari visita la p\u00e0gina, pots fer: <? php // Iniciamos la sesi\u00f3n o recuperamos la anterior sesi\u00f3n existente session_start (); // Comprobamos si la variable ya existe if ( isset ( $_SESSION [ 'visitas' ])) $_SESSION [ 'visitas' ] ++ ; else $_SESSION [ 'visitas' ] = 0 ; ?> Si en lloc de el nombre de visites, voldries emmagatzemar l'instant en qu\u00e8 es produeix cadascuna, la variable de sessi\u00f3 \"visites\" ha de ser una matriu i per tant haur\u00e0s de canviar el codi anterior per: <? php // Iniciamos la sesi\u00f3n o recuperamos la anterior sesi\u00f3n existente session_start (); // En cada visita a\u00f1adimos un valor al array \"visitas\" $_SESSION [ 'visitas' ][] = mktime (); ?> Encara que com ja has vist, pots configurar PHP perqu\u00e8 elimine de forma autom\u00e0tica les dades de una sessi\u00f3 passat cert temps, en ocasions pot ser necessari tancar-la de forma manual en un moment determinat. Per exemple, si utilitzes sessions per recordar la informaci\u00f3 d'autenticaci\u00f3 haur\u00e0s donar-li a l'usuari de la p\u00e0gina web la possibilitat de tancar la sessi\u00f3 quan ho crega convenient. En PHP tens dues funcions per eliminar la informaci\u00f3 emmagatzemada en la sessi\u00f3: session_unset . Elimina les variables emmagatzemades a la sessi\u00f3 actual, per\u00f2 no elimina la informaci\u00f3 de la sessi\u00f3 del dispositiu d'emmagatzematge usat. session_destroy . Elimina completament la informaci\u00f3 de la sessi\u00f3 del dispositiu de emmagatzematge. Activitat Crea una p\u00e0gina similar a l'anterior, emmagatzemant en la sessi\u00f3 d'usuari els instants de totes les seves \u00faltimes visites. Si \u00e9s la seva primera visita, mostra un missatge de benvinguda. En cas contrari, mostra la data i hora de totes les seves visites anteriors. Afegeix un bot\u00f3 a la p\u00e0gina que permeti esborrar el registre de visites. Utilitza tamb\u00e9 una variable de sessi\u00f3 per a comprovar si l'usuari ja ha iniciat correctament. D'aquesta manera no caldr\u00e0 comprovar les credencials amb la base de dades constantment. Gesti\u00f3 de la informaci\u00f3 de la sessi\u00f3 Ara veurem pas a pas un exemple d'utilitzaci\u00f3 de sessions per a emmagatzemar informaci\u00f3 de l'usuari. Utilitzar\u00e0s la base de dades \"blog\", usada anteriorment, per a crear un prototip d'elements favorits. Les p\u00e0gines de qu\u00e8 constar\u00e0 l'aplicaci\u00f3 web seran: Login ( SecurityController::login ). La seva funci\u00f3 \u00e9s autentificar a l'usuari de l'aplicaci\u00f3 web. Tots els usuaris de l'aplicaci\u00f3 s'hauran autentificar utilitzant aquesta p\u00e0gina abans de poder marcar algun post com a favorit. Afegir a preferits ( PostController::addToFavourite ). Cada entrada disposar\u00e0 d'un bot\u00f3 per a afegir a favorits sempre que el usuari s'haja validat. Llistat de posts favorits ( PostController::favourite ). Presenta un llistat de les entrades favorites. Logoff ( SecurityController::logout ). Aquesta p\u00e0gina desconnecta a l'usuari de l'aplicaci\u00f3 i redirigeix \u200b\u200ba l'usuari de forma autom\u00e0tica a la p\u00e0gina d'inici. No mostra cap informaci\u00f3 en pantalla, pel que no \u00e9s visible per a l'usuari. Abans de comen\u00e7ar tingues en compte que l'aplicaci\u00f3 que vas a desenvolupar no \u00e9s completament funcional. Per exemple: No tindr\u00e0s en compte la possibilitat que l'usuari afegisca diverses vegades la mateixa entrada. Un cop afegida una entrada no es podr\u00e0 eliminar, sols buidar. No es mostraran imatges dels productes. Es mostraran tots els posts en una \u00fanica p\u00e0gina, sense paginaci\u00f3. Encara que redu\u00efm en aquest exemple la funcionalitat, t'animem a que un cop finalitzat el mateix, afegisques pel teu compte totes aquelles opcions que vulguis. Recorda que la millor manera d'aprendre programaci\u00f3 \u00e9s ... programant! Autenticar l'usuari La primera p\u00e0gina que vas a programar \u00e9s la d'autenticaci\u00f3 de l'usuari ( SecurityController::login ). Per variar, far\u00e0s servir les capacitats de maneig de sessions de PHP per emmagatzemar la identificaci\u00f3 dels usuaris. A m\u00e9s, utilitzarem la informaci\u00f3 de la taula \"User\" a la base de dades \"bloc\", accedint mitjan\u00e7ant PDO. Vas a crear a la p\u00e0gina un formulari amb dos camps, un de tipus text per a l'usuari, i un altre de tipus password per a la contrasenya. En pr\u00e9mer el bot\u00f3 Enviar, el formulari s'enviar\u00e0 a aquesta mateixa p\u00e0gina, on es compararan les credencials proporcionades per l'usuari amb les emmagatzemades en la base de dades. Si les dades s\u00f3n correctes, s'iniciar\u00e0 una nova sessi\u00f3 i s'emmagatzemar\u00e0 en ella el nom de l'usuari que s'acaba de connectar. Anem per passos. El codi HTML per crear el formulari, que anir\u00e0 dins el cos de la p\u00e0gina (entre les etiquetes ) ser\u00e0 el seg\u00fcent: {% raw %} < form action = \"{{ router.generateURL('User', 'login') }}\" method = \"post\" > {{ message }} < div class = \"form-group\" > < input name = \"username\" type = \"text\" placeholder = \"Nom d'usuari\" class = \"form-control\" > </ div > < div class = \"form-group\" > < input name = \"password\" type = \"password\" placeholder = \"Contrasenya\" class = \"form-control\" > </ div > < p class = \"text-center\" > < button class = \"btn btn-primary\" name = \"login\" type = \"submit\" >< i class = \"fa fa-sign-in\" ></ i > Iniciar sessi\u00f3 </ button > </ p > </ form > {% endraw %} Fixa't que hi ha un espai per posar els possibles missatges d'error que es produeixin, com la falta d'alguna dada necessari, o un error de credencials err\u00f2nies. El codi PHP que ha de figurar a l'comen\u00e7ament d'aquesta mateixa p\u00e0gina (abans que es mostri qualsevol text), s'encarregar\u00e0 de: Comprovar que s'han introdu\u00eft tant el nom d'usuari com la contrasenya. # UserController.php if (( $this -> request -> getParams () -> has ( 'username' ) && $this -> request -> getParams () -> has ( 'password' )) && $this -> request -> isPost () ) { //Cogemos datos del formulario y validamos $username = $this -> request -> getParams () -> getString ( 'username' ); $password = $this -> request -> getParams () -> getString ( 'password' ); $user = new User (); $user -> setUsername ( $username ); $user -> setPassword ( $password ); // Comprovem que els valors s\u00f3n correctes. $errors = $userModel -> validateLogin ( $user ); Comprovem les credencials. // UserController.php // Si no hi ha errors comprovem les credancials if ( count ( $errors ) == 0 ) { //Cogemos los datos del formulario para comprobar que existe el usuario $loginOk = $userModel -> checkUser ( $user -> getUsername (), $user -> getPassword ()); // UserModel.php try { $loginUsuario = $this -> pdo -> prepare ( \"SELECT * FROM user WHERE username=:username AND password=:password\" ); $loginUsuario -> bindParam ( ':username' , $email , PDO :: PARAM_STR ); $loginUsuario -> bindParam ( ':password' , $password , PDO :: PARAM_STR ); $loginUsuario -> execute (); return $loginUsuario -> rowCount (); } catch ( PDOException $e ) { echo \"Error: \" . $e -> getMessage (); } Si les credencials s\u00f3n correctes carreguem en les dades d'usuari en \\$_SESSION if ( $loginOk > 0 ) { $dataUser = $userModel -> getByUsername ( $user -> getUsername ()); session_start (); $_SESSION [ 'loggedin' ] = true ; $_SESSION [ 'iduser' ] = $dataUser -> getId (); $_SESSION [ 'email' ] = $dataUser -> getEmail (); $_SESSION [ 'nombre' ] = $dataUser -> getUsername (); $_SESSION [ 'id_rol' ] = $dataUser -> getRoles (); header ( \"Location: \" . $GLOBALS [ 'router' ] -> generateUrl ( 'Post' , 'favourite' )); } else { $errors [] = \"Les credencials s\u00f3n inv\u00e0lides\" ; } I redirigir a la p\u00e0gina de les entrades favorites. header ( \"Location: \" . $GLOBALS [ 'router' ] -> generateUrl ( 'Post' , 'favourite' )); Enten b\u00e9 el codi abans de seguir endavant. {: .alert .alert-question } En el codi anterior, la sessi\u00f3 de l'usuari s'inicia s\u00f2l si es proporciona un nom d'usuari i contrasenya correctes. \u00bfPodria haver-se iniciat la sessi\u00f3 en comen\u00e7ar el codi encara que l'usuari no haja proporcionat les credencials? P\u00e0gina de favorits Quan un usuari proporciona unes credencials d'inici de sessi\u00f3 correctes (recorda que tu ja havies afegit l'usuari \"jane_admin\" amb contrasenya \"admin\"), se li redirigeix \u200b\u200bautom\u00e0ticament a la p\u00e0gina de la llista d'entrades favorites. Aquesta \u00e9s la p\u00e0gina que vas a programar a continuaci\u00f3. // PostController.php public function favourite () { global $router ; // Recuperem la informaci\u00f3 de la sessi\u00f3 session_start (); // Comprovem si l'usuari s'ha autenticat if ( ! isset ( $_SESSION [ 'loggedin' ])) { die ( \"Error - cal autenticar-se <a href= \\\" \" . $router -> generateURL ( 'User' , 'login' ) . \" \\\" \" ); } $postModel = new PostModel ( $this -> db ); $posts = []; if ( ! empty ( $_SESSION [ 'Posts' ])) { foreach ( $_SESSION [ 'Posts' ] as $postId ) { $posts [] = $postModel -> getById ( $postId ); } } $image_dir = $this -> config -> get ( 'image_path' ); $header = '\u00daltimes entrades' ; $properties = [ 'image_dir' => $image_dir , 'header' => 'Entrades favorites' , 'posts' => $posts , 'tags' => $tags ]; return $this -> render ( 'posts/favourite.twig' , $properties ); } public function addToFavourite () { global $router ; // Recuperem la informaci\u00f3 de la sessi\u00f3 session_start (); // Comprovem si l'usuari s'ha autenticat if ( ! isset ( $_SESSION [ 'loggedin' ])) { die ( \"Error - cal autenticar-se <a href= \\\" \" . $router -> generateURL ( 'User' , 'login' ) . \" \\\" \" ); } if ( $this -> request -> isPost ()) { $postId = $this -> request -> getParams () -> getInt ( 'post' ); if ( $postId > 0 ) $_SESSION [ 'Posts' ][] = $postId ; } header ( 'Location: ' . $router -> generateURL ( 'Posts' , 'index' )); } public function emptyFavourite () { global $router ; // Recuperem la informaci\u00f3 de la sessi\u00f3 session_start (); // Buidem l'array amb les entrades favorites unset ( $_SESSION [ 'Posts' ]); header ( 'Location: ' . $router -> generateURL ( 'Posts' , 'index' )); } Les plantilles de Twig {%raw%} #posts/favourite.twig { % block body %} <!-- MOSTREM LES ENTRADES --> {% for post in posts %} < div > < h2 > {{ post . title }} < /h2> <p>Escrit per:<strong>{{ post.user.fullname }} </s trong > {{ post . published_at | date ( \"d/m/Y\" ) }} { % if admin %} <a class=\"btn px-2 secondary-link\" href=\"{{ router.generateURL('Post', 'search') } } \"> <span class=\" fa fa - pencil - square - o \"></span></a> <a class=\" btn px - 2 secondary - link \" href=\" {{ router . generateURL ( 'Post' , 'search' ) }} \"> <span class=\" fa fa - trash - o \"></span></a> {% endif %} </p> <div class=\" fakeimg \"><img class=\" w - 25 img - thumbnail float - left mr - 2 \" src=\" {{ image_dir ~ post . image }} \"/></div> <p>{{ post.summary }}</p> <p><a href=\" {{ router . generateURL ( 'Post' , 'showById' , { id : post . id }) }} \">Llegir m\u00e9s</a> </p> <div class=\" mb - 4 \"> <!-- MOSTREM ELS TAGS --> {% for tag in post.tags %} <a class=\" btn btn - light \" href=\" {{ router . generateURL ( 'Post' , 'showByTag' , { id : tag . id }) }} \"> <span class=\" fa fa - tags \" aria-hidden=\" true \">{{ tag.name }} </a> {% endfor %} </div> </div> <div class=\" clearfix \"></div> {% endfor %} <form class=\" mb - 4 \" action=\" {{ router . generateUrl ( 'Post' , 'emptyFavourite' ) }} \" method=\" post \"> <input type=\" submit \" class=\" btn btn - info \" value=\" Buidar favorits \"> </form> {% endblock %} # posts/show.twig { % extends \"base.twig\" %} {% block body %} <!-- MOSTREM LES ENTRADES --> < div > < h2 > {{ post . title }} < /h2> <p>Escrit per:<strong>{{ post.user.fullname }} </s trong > {{ post . published_at | date ( \"d/m/Y\" ) }} { % if admin %} <a class=\"btn px-2 secondary-link\" href=\"{{ router.generateURL('Post', 'search') } } \"> <span class=\" fa fa - pencil - square - o \"></span></a> <a class=\" btn px - 2 secondary - link \" href=\" {{ router . generateURL ( 'Post' , 'search' ) }} \"> <span class=\" fa fa - trash - o \"></span></a> {% endif %} </p> <div class=\" fakeimg \"><img class=\" w - 25 img - thumbnail float - left mr - 2 \" src=\" {{ image_dir ~ post . image }} \"/></div> <p>{{ post.content|markdown_to_html }}</p> <form class=\" mb - 4 \" action=\" {{ router . generateUrl ( 'Post' , 'addToFavourite' ) }} \" method=\" post \"> <input type=\" hidden \" name=\" post \" value=\" {{ post . id }} \" /> <input type=\" submit \" class=\" btn btn - info \" value=\" Afegir a favorits \"> </form> <p class=\" mb - 4 \"><a href=\" {{ router . generateURL ( 'Post' , 'index' ) }} \">P\u00e0gina principal</a> </p> </div> {% endblock %} {% endraw %} En cada entrada es crea un formulario amb un bot\u00f3 \"Afegir a favorits\" que envia a la p\u00e0gina /favourite/add l'identificador de cada entrada que activa el m\u00e8tode addToFavourite() . Quan s'executa es comprova si s'ha enviat la p\u00e0gina i s'afegeix a \\$_SESSION['Posts] l'idenficador rebut. if ( $this -> request -> isPost ()) { $postId = $this -> request -> getParams () -> getInt ( 'post' ); if ( $postId > 0 ) $_SESSION [ 'Posts' ][] = $postId ; } L'array $_SESSION['Posts'] \u00e9s la variable de sessi\u00f3 en la que emmagatzemarem els identificadors de totes les entrades que l'usuari afegeix a favorits. // Si hi ha elements a favorits els mostrarem if ( ! empty ( $_SESSION [ 'Posts' ])) { foreach ( $_SESSION [ 'Posts' ] as $postId ) { $posts [] = $postModel -> getById ( $postId ); } // Si no, mostrarem un missatge else { $message = \"No hi ha elements favorits\" ; } La p\u00e0gina cont\u00e9 un formulari per a buidar els elements favorits: unset ( $_SESSION [ 'Posts' ]); A m\u00e9s a m\u00e9s, tant en aquesta p\u00e0gina como en la resta, caldr\u00e0 comprovar si la variable \\$_SESSION['loggedin'] existeix per a verificar que l'usuari s'ha autenticat correctament. Para ello, debes incluir el siguiente c\u00f3digo al inicio de la p\u00e1gina. // Recuperem la informaci\u00f3 de la sessi\u00f3 session_start (); // Comprovem si l'usuari s'ha autenticat if ( ! isset ( $_SESSION [ 'loggedin' ])) { die ( \"Error - cal autenticar-se <a href= \\\" \" . $router -> generateURL ( 'User' , 'login' ) . \" \\\" \" ); } Si l'usuari no s'ha autenticat, es mostra un missatge d'error junt amb l'enlla\u00e7 a la p\u00e0gina d'inici de sessi\u00f3. Si des de qualsevol p\u00e0gina l'usuari prem l'opci\u00f3 del men\u00fa \"Favorits\", activar\u00e0 el m\u00e8tode favourite() de PostController en la que se vor\u00e0 totes les entrades que ha marcat com a favorites. // PostController.php public function favourite () { global $router ; // Recuperem la informaci\u00f3 de la sessi\u00f3 session_start (); // Comprovem si l'usuari s'ha autenticat if ( ! isset ( $_SESSION [ 'loggedin' ])) { die ( \"Error - cal autenticar-se <a href= \\\" \" . $router -> generateURL ( 'User' , 'login' ) . \" \\\" \" ); } $postModel = new PostModel ( $this -> db ); $posts = []; if ( ! empty ( $_SESSION [ 'Posts' ])) { foreach ( $_SESSION [ 'Posts' ] as $postId ) { $posts [] = $postModel -> getById ( $postId ); } } $image_dir = $this -> config -> get ( 'image_path' ); $header = '\u00daltimes entrades' ; $properties = [ 'image_dir' => $image_dir , 'header' => 'Entrades favorites' , 'posts' => $posts , 'tags' => $tags ]; return $this -> render ( 'posts/favourite.twig' , $properties ); } Les entrades que es mostren en la p\u00e0gina s'obtenen de la informaci\u00f3 emmagatzemada en la sessi\u00f3. Usarem PostModel per a carregar les dades de cada entrada. En acabar, l'usuari podr\u00e0 tancar sessi\u00f3 activant el m\u00e8tode logout de SecurityController : // Recuperamos la informaci\u00f3n de la sesi\u00f3n session_start (); // Y la eliminamos session_unset (); header ( \"Location: login.php\" ); M\u00e9s informaci\u00f3 sobre les sessions en PHP: Maneig de sessions (PHP) Bones pr\u00e0ctiques Usa sempre HTTPS Usa sempre HTTPS si no s'enviar\u00e0 tota la informaci\u00f3 en text pla. Contrasenyes incloses. Usa sessions A difer\u00e8ncia de les galetes les dades emmagatzemades en les sessions no s'envien mitjan\u00e7ant els encap\u00e7alats HTTP, romanen al servidor. El que s\u00ed s'envia \u00e9s l'identificador de sessi\u00f3. Caldr\u00e0 prendre mesures perqu\u00e8 l'identificador no puga ser accessible per tercers i aix\u00ed poder accedir a les dades emmagatzemades. Segons l' OWASP : Session settings are some of the MOST important values to concentrate on in configuring. It is a good practice to change session.name to something new. I proposen la seg\u00fcent configuraci\u00f3 b\u00e0sica: session.save_path = /path/PHP-session/ session.name = myPHPSESSID session.auto_start = Off session.use_trans_sid = 0 session.cookie_domain = full.qualified.domain.name #session.cookie_path = /application/path/ session.use_strict_mode = 1 session.use_cookies = 1 session.use_only_cookies = 1 session.cookie_lifetime = 14400 # 4 hours session.cookie_secure = 1 session.cookie_httponly = 1 session.cookie_samesite = Strict session.cache_expire = 30 session.sid_length = 256 session.sid_bits_per_character = 6 # PHP 7.2+ session.hash_function = 1 # PHP 7.0-7.1 session.hash_bits_per_character = 6 # PHP 7.0-7.1 Les recomanacions en major detall: Control de la vida de sessi\u00f3 Fes que expire la sessi\u00f3 despr\u00e9s d\u2019un curt per\u00edode d\u2019inactivitat : ajusteu el temps d\u2019inactivitat a 5 minuts per a aplicacions altament protegides fins a no m\u00e9s de 30 minuts per a aplicacions de baix risc. Habilita l\u2019opci\u00f3 de tancament de sessi\u00f3 : caduca i destrueix expl\u00edcitament la sessi\u00f3 en tancar la sessi\u00f3. Eviteu els inicis de sessi\u00f3 persistents (opci\u00f3 \"recordeu-me\") : opcionalment podeu restringir la informaci\u00f3 conservada i revelada per l'aplicaci\u00f3, \u00e9s a dir, obligar a l'usuari a tornar a iniciar sessi\u00f3 abans de realitzar cap operaci\u00f3 cr\u00edtica. Fes que expire la sessi\u00f3 quan hi haja error de seguretat : qualsevol error de seguretat de l'aplicaci\u00f3 hauria de donar lloc a la finalitzaci\u00f3 de la sessi\u00f3. Fes caducar la sessi\u00f3 quan siga de llarga durada : obligaci\u00f3 a reautentificar la sessi\u00f3, que tot i estar actiu ha arribat al temps m\u00e0xim perm\u00e8s, p.e. unes poques hores. Elimineu la galleta de sessi\u00f3 en destruir una sessi\u00f3 . Identificador de sessi\u00f3 Utilitzeu nom\u00e9s galetes per propagar l\u2019ID de sessi\u00f3 , ja que quan es transmeten mitjan\u00e7ant un par\u00e0metre URL, les sol\u00b7licituds GET poden ser emmagatzemades a l\u2019historial del navegador, a la mem\u00f2ria cau i als marcadors. Aleshores tamb\u00e9 es pot visualitzar f\u00e0cilment. Regenereu l'identificador de sessi\u00f3 : regenereu (substitu\u00efu-ne per un de nou) l'identificador de sessi\u00f3, almenys cada cop que canvie el nivell de privilegi de l'usuari. Generalment es pot regenerar abans de qualsevol transacci\u00f3 important, despr\u00e9s d\u2019un determinat nombre de sol\u00b7licituds o despr\u00e9s d\u2019un per\u00edode de temps. Comproveu si l'identificador de sessi\u00f3 \u00e9s v\u00e0lid (de mida i tipus previst) i que ha estat generat per l'aplicaci\u00f3 i no proporcionat per l'usuari. L'identificador de sessi\u00f3 hauria de ser adequadament llarg, imprevisible, dif\u00edcil de reproduir i creat a partir de fonts aleat\u00f2ries d'alta qualitat . Cookie de sessi\u00f3 Definiu el domini de la galleta a quelcom m\u00e9s espec\u00edfic que el domini de primer nivell. No emmagatzeneu res a la galleta (almenys qualsevol informaci\u00f3 sensible com el nom d\u2019usuari o la contrasenya) sols\u2019ID de sessi\u00f3. Definiu el senyalador nom\u00e9s http per desactivar la captura de l'identificador de sessi\u00f3 mitjan\u00e7ant XSS. Quan siga possible, utilitzeu un xifrat fort (SSL) i l'atribut cookie_secure per permetre la transmissi\u00f3 de cookies nom\u00e9s a trav\u00e9s de https. Emmagatzematge de dades de sessi\u00f3 Determineu on s'emmagatzemen les dades de sessi\u00f3 i si es tracta d\u2019un sistema de fitxers o d\u2019una base de dades, determineu qui m\u00e9s podria tenir acc\u00e9s a aquestes dades. Quan s'emmagatzemen les dades de sessi\u00f3 en fitxers, assegureu-vos que l'aplicaci\u00f3 est\u00e0 configurada per utilitzar un directori privat independent (per exemple, la directiva session.save_path ). Utilitzeu els permisos del sistema de fitxers per protegir aquests fitxers d\u2019observaci\u00f3 o modificaci\u00f3 d\u2019usuaris diferents dels comptes necessaris per operar el servidor web i les aplicacions. Si aix\u00f2 no \u00e9s possible, cal xifrar les dades de la sessi\u00f3 o contenir nom\u00e9s dades no sensibles. Tingueu en compte que PHP utilitza de manera predeterminada el directori temporal del sistema p\u00fablic. Totes les variables de sessi\u00f3 s\u2019han de validar i sanejar per assegurar-se que siguem correctes i que no cont\u00e9 car\u00e0cters inesperats. No con\u00e8ixer les contrasenyes Al final, tothom crea una aplicaci\u00f3 PHP que es basa en la sessi\u00f3 d\u2019usuari. Els noms d\u2019usuari i les contrasenyes s\u2019emmagatzemen en una base de dades i s\u2019utilitzen posteriorment per autentificar els usuaris despr\u00e9s de l\u2019inici de sessi\u00f3. \u00c9s important que fer hash de les contrasenyes correctament abans d\u2019emmagatzemar-les. El hashing i el xifrat s\u00f3n dues coses molt diferents que sovint es confonen. El hashing \u00e9s una funci\u00f3 irreversible i unidireccional. \u00c9s produeix una cadena de longitud fixa que no es pot invertir. Aix\u00f2 vol dir que podeu comparar un hash amb un altre per determinar si tots dos provenien de la mateixa cadena font, per\u00f2 no podeu determinar la cadena original. Si les contrasenyes no s'emmagatzemen amb hashing i un tercer no autoritzat accedeix a la vostra base de dades, tots els comptes d'usuari estaran compromesos. A difer\u00e8ncia del hashing , el xifrat \u00e9s reversible (sempre que tingueu la clau). El xifratge \u00e9s \u00fatil en altres \u00e0rees, per\u00f2 \u00e9s una estrat\u00e8gia deficient per emmagatzemar contrasenyes de forma segura. Les contrasenyes tamb\u00e9 han de salar-se individualment afegint una cadena aleat\u00f2ria a cada contrasenya abans d'aplicar hashing . Aix\u00f2 evita els atacs de diccionari i l'\u00fas de \"taules de l'arc de Sant Mart\u00ed\" (una llista inversa de hash criptogr\u00e0fics per a contrasenyes comunes.) El hashing i el salat s\u00f3n vitals, ja que sovint els usuaris utilitzen la mateixa contrasenya per a diversos serveis i la qualitat de la contrasenya \u00e9s deficient. Addicionalment, haureu d'utilitzar un algorisme especialitzat en hashing en lloc d'una funci\u00f3 de hash criptogr\u00e0fic de prop\u00f2sit general i r\u00e0pid (per exemple, SHA256). La llista breu d'algorismes de hashing de contrasenya acceptables (a juny de 2018) a utilitzar s\u00f3n: Argon2 (disponible a PHP 7.2 i versions posteriors) Scrypt Bcrypt (PHP us proporciona aquesta; vegeu m\u00e9s avall) PBKDF2 amb HMAC-SHA256 o HMAC-SHA512 Afortunadament, avui en dia PHP ens ho facilita. Hashing de contrasenyes amb password_hash A PHP 5.5 s'ha introdu\u00eft password_hash() . En aquest moment est\u00e0 utilitzant BCrypt, l'algorisme m\u00e9s fort actualment suportat per PHP. Tot i aix\u00f2, s'actualitzar\u00e0 en el futur per donar suport a m\u00e9s algoritmes. La biblioteca de password_compat es va crear per proporcionar una compatibilitat de PHP> = 5.3.7. A continuaci\u00f3 hem aplicat hashing a una cadena i, a continuaci\u00f3, apliquem el hashing contra una nova cadena. Com que les dues cadenes d'origen s\u00f3n diferents (\"contrasenya-secreta\" i \"contrasenya-err\u00f2nia\"), aquesta sessi\u00f3 fallar\u00e0. $passwordHash = password_hash ( \"contrasenya-secreta\" , PASSWORD_DEFAULT ); if ( password_verify ( \"contrenya-err\u00f2nia\" , $passwordHash )) { // Contrasenya correcta } else { // Contrasenya incorrecta } password_hash() s'ocupa de la salificaci\u00f3 de contrasenyes. La sal s'emmagatzema, juntament amb l'algorisme i el \"cost\", com a part del hash. password_verify() extreu aix\u00f2 per determinar com comprovar la contrasenya, de manera que no necessiteu un camp de base de dades independent per emmagatzemar les vostres sals. PASSWORD_DEFAULT PASSWORD_DEFAULT . Actualment utilitza l\u2019algoritme bcrypt (predeterminat a partir de PHP 5.5.0). Observeu que aquesta constant est\u00e0 pensada per a adaptar-se sempre que hi haja un algoritme nou i m\u00e9s fort a PHP. Per aquesta ra\u00f3, la longitud del resultat d\u2019utilitzar aquest identificador pot canviar amb el temps. Per tant, es recomana emmagatzemar el resultat en una columna d\u2019una base de dades de m\u00e9s de 60 caracters (255 caracters seria una bona elecci\u00f3). Activitat Adapta el projecte de forma que: Cada 15 minuts es regenere la sessi\u00f3. Sols use http per accedir a la cookie de sessi\u00f3. Les constrasenyes s'encripten amb bcrypt . Es tanque la sessi\u00f3 tal com s'indica. Recursos The 2018 Guide to Building Secure PHP Software PHP: The Right Way. Security Session Management Basics Ultimate PHP Security Best Practices PHP Session Security Best Practices PHP Sessions in depth Session Management Cheat Sheet","title":"Autenticaci\u00f3 d'usuaris i control d'acc\u00e9s"},{"location":"04-web-programming/04-05-http-authentication/#autenticacio-dusuaris-i-control-dacces","text":"Moltes vegades \u00e9s important verificar la identitat dels dos extrems d'una comunicaci\u00f3, hi ha m\u00e8todes per identificar tant al servidor en el qual s'allotja el lloc web, com a l'usuari del navegador que es troba en l'altre extrem. Els llocs web que necessiten emprar identificaci\u00f3 de servidor, com les botigues o els bancs, utilitzen el protocol HTTPS . Aquest protocol requereix d'un certificat digital v\u00e0lid, signat per una autoritat fiable, que \u00e9s verificat pel navegador quan s'accedeix a la p\u00e0gina web. A m\u00e9s, HTTPS utilitza m\u00e8todes de xifrat per crear un canal segur entre el navegador i el servidor, de tal manera que no es puga interceptar la informaci\u00f3 que es transmet pel mateix. Per identificar els usuaris que visiten un lloc web, es poden utilitzar diferents m\u00e8todes com el DNI digital o certificats digitals d'usuari (document digital que cont\u00e9 informaci\u00f3 sobre l'usuari com el nom o l'adre\u00e7a. Aquesta informaci\u00f3 est\u00e0 signada per una altra entitat, anomenada entitat certificadora, que ha de ser de confian\u00e7a i garanteix que la informaci\u00f3 que cont\u00e9 \u00e9s certa), per\u00f2 el m\u00e9s est\u00e8s \u00e9s sol\u00b7licitar a l'usuari certa informaci\u00f3 que nom\u00e9s ell coneix: la combinaci\u00f3 d'un nom d'usuari i una contrasenya. En les unitats anteriors vas aprendre a utilitzar aplicacions web per gestionar informaci\u00f3 emmagatzemada en bases de dades. En la majoria dels casos \u00e9s important implantar en aquest tipus de aplicacions web, les que accedeixen a bases de dades, algun mecanisme de control d'acc\u00e9s que obligui a l'usuari a identificar-se. Un cop identificat, es pot limitar l'\u00fas que pot fer de la informaci\u00f3. Aix\u00ed, pot haver llocs web en els quals els usuaris autenticats poden utilitzar nom\u00e9s una part de la informaci\u00f3 (com els bancs, que permeten als seus clients accedir \u00fanicament a la informaci\u00f3 relativa als seus comptes). Altres llocs web necessiten separar en grups als usuaris autentificats, de tal manera que la informaci\u00f3 a la qual accedeix un usuari dep\u00e8n del grup en qu\u00e8 aquest es trobe. Per exemple, una aplicaci\u00f3 de gesti\u00f3 d'una empresa pot tenir un grup d'usuaris als qui permet visualitzar la informaci\u00f3, i un altre grup d'usuaris que, a m\u00e9s de visualitzar la informaci\u00f3, tamb\u00e9 la poden modificar. Autenticaci\u00f3, control d'acc\u00e9s i seguretat en les comunicacions Has distingir l'autenticaci\u00f3 dels usuaris i el control d'acc\u00e9s, de la utilitzaci\u00f3 de mecanismes per assegurar les comunicacions entre l'usuari de el navegador i el servidor web. Encara que tots dos aspectes solen anar units, s\u00f3n independents. En els exemples d'aquesta unitat, la informaci\u00f3 d'autenticaci\u00f3 (nom i contrasenya dels usuaris) s'envia en text pla des del navegador fins al servidor web. Aquesta pr\u00e0ctica \u00e9s altament insegura i mai s'ha d'usar sense un protocol com HTTPS que permeta xifrar les comunicacions amb el lloc web. No obstant aix\u00f2, la configuraci\u00f3 de servidors web que permeten fer servir el protocol HTTPS per xifrar la informaci\u00f3 que reben i transmeten no forma part dels continguts d'aquest m\u00f2dul. Per aquest motiu, durant aquesta unitat utilitzarem \u00fanicament el protocol no segur HTTP.","title":"Autenticaci\u00f3 d'usuaris i control d'acc\u00e9s"},{"location":"04-web-programming/04-05-http-authentication/#mecanismes-dautenticacio-via-http","text":"El protocol HTTP ofereix un m\u00e8tode senzill per autenticar els usuaris. El proc\u00e9s \u00e9s el seg\u00fcent: El servidor web ha de proveir algun m\u00e8tode per definir els usuaris que s'utilitzaran i com es poden autentificar. A m\u00e9s, s'hauran de definir els recursos als quals es restringeix l'acc\u00e9s i quina llista de control d'acc\u00e9s (ACL - llista de permisos sobre un objecte (fitxer, directori, etc.), que indica quins usuaris poden utilitzar l'objecte i les accions concretes que poden realitzar amb el mateix (lectura, escriptura, esborrat, etc.)) s'aplica a cada un. Quan un usuari no autenticat intenta accedir a un recurs restringit, el servidor web respon amb un error de \"Acc\u00e9s no autoritzat\" (codi 401). El navegador rep l'error i obre una finestra per sol\u00b7licitar a l'usuari que es autentifiqui mitjan\u00e7ant el seu nom i contrasenya. La informaci\u00f3 d'autenticaci\u00f3 de l'usuari s'envia a servidor, que la verifica i decideix si permet o no l'acc\u00e9s a el recurs sol\u00b7licitat. Aquesta informaci\u00f3 es mant\u00e9 en el navegador per utilitzar-se en posteriors peticions a aquest servidor. Al servidor web Apache, el que has estat utilitzant en anteriors unitats, hi ha una utilitat en l\u00ednia d'ordres, htpasswd , que permet emmagatzemar en un fitxer una llista d'usuaris i els seus respectives contrasenyes. La informaci\u00f3 relativa a les contrasenyes s'emmagatzema xifrada; tot i aix\u00ed, \u00e9s convenient crear aquest fitxer en un lloc no accessible pels usuaris de servidor web. http://httpd.apache.org/docs/2.0/es/howto/auth.html Per exemple, per crear el fitxer d'usuari i afegir-li el usuari \"dwes\", pots fer: sudo htpasswd -c users dwes i introduir la contrasenya corresponent a aquest usuari. L'opci\u00f3 -c indica que s'ha de crear el fitxer, per la qual cosa nom\u00e9s haur\u00e0s de fer-la servir quan introdueixis el primer usuari i contrasenya. Fixa't que en l'exemple anterior, el fitxer es crea a la ruta /etc/apache2/users, que en principi no \u00e9s accessible via web. Per indicar-li a l'servidor Apache quins recursos tenen acc\u00e9s restringit, una opci\u00f3 \u00e9s crear un fitxer .htaccess en el directori en qu\u00e8 es trobin, amb les seg\u00fcents directives: AuthName \"Contingut restringit\" AuthType Basic AuthUserFile /etc/apache2/users requereix valid-user El significat de cadascuna de les directives anteriors \u00e9s el seg\u00fcent: Directiva significat AuthName Nom de domini que es far\u00e0 servir en l'autenticaci\u00f3. Si el client s'autentica correctament, aquesta mateixa informaci\u00f3 d'autenticaci\u00f3 s'utilitzar\u00e0 autom\u00e0ticament en la resta de les p\u00e0gines de el mateix domini. AuthType M\u00e8tode d'autenticaci\u00f3 que es far\u00e0 servir. A m\u00e9s de l'm\u00e8tode Basic, Apache tamb\u00e9 permet utilitzar el m\u00e8tode Digest. AuthUserFile Cam\u00ed de l'arxiu de credencials que has creat amb htpasswd. Require Permet indicar que nom\u00e9s puguin accedir alguns usuaris o grups d'usuaris concrets. Si indiquem \"valid-user\", podran accedir tots els usuaris que es s'autentifiquin correctament. A m\u00e9s, haur\u00e0s de assegurar-te que en la configuraci\u00f3 d'Apache s'utilitza la directiva AllowOverride perqu\u00e8 s'aplique correctament la configuraci\u00f3 que figura en els fitxers .htaccess . M\u00e9s detalls en http://httpd.apache.org/docs/2.0/es/mod/core.html#allowoverride A l'incloure l'opci\u00f3 -c el que fem \u00e9s crear un nou fitxer, amb la qual cosa eliminem el contingut anterior del mateix.","title":"Mecanismes d'autenticaci\u00f3 via HTTP"},{"location":"04-web-programming/04-05-http-authentication/#mecanismes-dautenticacio","text":"Des PHP pots accedir a la informaci\u00f3 d'autenticaci\u00f3 HTTP que ha introdu\u00eft l'usuari utilitzant l'array superglobal $_SERVER . valor contingut $_SERVER['PHP_AUTH_USER'] Nom d'usuari que s'ha introdu\u00eft. $_SERVER['PHP_AUTH_PW'] Clau introdu\u00efda. $_SERVER['AUTH_TYPE'] M\u00e8tode HTTP usat per autentificar. Pot ser Basic o Digest. \u00c9s a dir, que si crees una p\u00e0gina web que mostre els valors d'aquestes variables, i prepares el servidor web per utilitzar autenticaci\u00f3 HTTP, quan accedisques a aquesta p\u00e0gina amb l'usuari \"dwes\" obtindr\u00e0s alguna cosa com el seg\u00fcent: <!DOCTYPE html PUBLIC \"- // W3C // DTD HTML 4.01 Transitional // EN\" \"http://www.w3.org/TR/html4/loose.dtd \"> <!-- Desenvolupament Web a Entorn Servidor --> <!-- Tema 4: Desenvolupament d'aplicacions web amb PHP --> <!-- Exemple: Autenticaci\u00f3 HTTP --> < html > < head > < meta http-equiv = \"content-type\" content = \"text / html; charset = UTF-8\" /> < title > Exemple Tema 4: Autenticaci\u00f3 HTTP </ title > < link href = \"dwes.css\" rel = \"stylesheet\" type = \"text / css\" /> </ head > < body > <?php echo \"Nom d'usuari:\". $_ SERVER['PHP_AUTH_USER']. \"<br />\"; echo \"Contrasenya:\". $_ SERVER['PHP_AUTH_PW']. \"<br />\"; echo \"M\u00e8tode d'autenticaci\u00f3:\". $_SERVER['AUTH_TYPE']. \"<br />\"; ?> </ body > </ html > Si no introdueixes un usuari/contrasenya v\u00e0lids, el navegador et mostrar\u00e0 l'error 401. A m\u00e9s, en PHP pots utilitzar la funci\u00f3 header per for\u00e7ar que el servidor envie un error de \"Acc\u00e9s no autoritzat\" (codi 401). D'aquesta manera no cal utilitzar fitxers .htaccess per indicar-li a Apache quins recursos estan restringits. En el seu lloc, pots afegir les seg\u00fcents l\u00ednies en les teves p\u00e0gines PHP: <? php if ( ! isset ( $_ SERVER [ 'PHP_AUTH_USER' ])) { header ( 'WWW-Authenticate: Basic Realm = \"Contingut restringit\"' ); header ( 'HTTP/1.0 401 Unauthorized' ); echo \"Usuari no reconegut!\" ; exit ; } ?> La funci\u00f3 header envia cap\u00e7aleres HTTP (bloc de dades que forma part de l'protocol HTTP i s'envia abans de la informaci\u00f3 pr\u00f2pia que es transmet. Permet especificar codis d'estat, accions requerides a servidor, o el tipus d'informaci\u00f3 que es transmet), per\u00f2 s'ha d'utilitzar abans que es mostre res per pantalla. En cas contrari, obtindr\u00e0s un error. M\u00e9s informaci\u00f3: http://es.php.net/manual/es/function.header.php Amb el codi anterior, la p\u00e0gina envia un error 401, el que for\u00e7a al navegador a sol\u00b7licitar les credencials d'acc\u00e9s (nom d'usuari i contrasenya). Si s'introdueixen, s'executa la resta de la p\u00e0gina i es mostra el seu contingut. En aquest cas, caldria afegir algun codi per comprovar que el nom d'usuari i contrasenya s\u00f3n v\u00e0lids, tal com veurem a continuaci\u00f3. Si es prem el bot\u00f3 \"Cancel\", es mostra el missatge d'error que s'indica. Modifica la p\u00e0gina anterior utilitzant la funci\u00f3 header perqu\u00e8 sol\u00b7liciti les credencials a l'usuari. Haur\u00e0s de crear una p\u00e0gina similar a l'anterior, i afegir el codi per for\u00e7ar l'error 401 abans de qualsevol altre. <! DOCTYPE html PUBLIC \"- // W3C // DTD HTML 4.01 Transitional // EN\" \" http://www.w3.org/TR/html4/loose.dtd \" > <!-- Desenvolupament Web a Entorn Servidor --> <!-- Tema 4 : Desenvolupament d 'aplicacions web amb PHP --> <!-- Exemple: Funci\u00f3 header per autenticaci\u00f3 HTTP --> <?php if (!isset($_SERVER[' PHP_AUTH_USER '])) { header(' WWW - Authenticate : Basic Realm = \"Contingut restringit\" '); header(' HTTP / 1.0 401 Unauthorized '); echo \"Usuari no reconegut!\"; exit; } ?> <html> <head> <meta http-equiv = \"content-type\" content = \"text / html; charset = UTF-8\"> <title> Exercici: Funci\u00f3 header per autenticaci\u00f3 HTTP </ title> <link href = \"dwes.css\" rel = \"stylesheet\" type = \"text / css\"> </head> <body> <?php echo \"Nom d' usuari : \". $_ SERVER['PHP_AUTH_USER']. \" < br /> \"; echo \" Contrasenya : \". $_ SERVER['PHP_AUTH_PW']. \" < br /> \"; ?> </body> </html>","title":"Mecanismes d'autenticaci\u00f3"},{"location":"04-web-programming/04-05-http-authentication/#incorporacio-de-metodes-dautenticacio-a-una-aplicacio-web","text":"Si utilitzes la funci\u00f3 header per for\u00e7ar el navegador a sol\u00b7licitar credencials HTTP, l'usuari introduir\u00e0 un nom i una contrasenya. Per\u00f2 el servidor no ha de verificar aquesta informaci\u00f3; haur\u00e0s de ser tu qui prove\u00efsca un m\u00e8tode per comprovar que les credencials que ha introdu\u00eft l'usuari s\u00f3n correctes. El m\u00e8tode m\u00e9s simple \u00e9s incloure en el codi PHP de la teva p\u00e0gina les sent\u00e8ncies necess\u00e0ries per comparar les dades introdu\u00efdes amb altres dades fixos. Per exemple, per a permetre l'acc\u00e9s a un usuari \"dwes\" amb contrasenya \"abc123.\", pots fer: if ( $_SERVER [ 'PHP_AUTH_USER' ] != 'dwes' || $_SERVER [ 'PHP_AUTH_PW' ] != 'abc123.' ) { header ( 'WWW-Authenticate: Basic Realm = \"Contingut restringit\"' ); header ( 'HTTP / 1.0 401 Unauthorized' ); echo \"Usuari no reconegut!\" ; exit ; } ?> Recorda que el codi PHP no s'envia al navegador, de manera que la informaci\u00f3 d'autenticaci\u00f3 que introdueixis en el codi no ser\u00e0 visible per l'usuari. No obstant aix\u00f2, aix\u00f2 far\u00e0 el teu codi menys portable. Si necessites modificar el nom d'usuari o la contrasenya, haur\u00e0s de fer modificacions en el codi. A m\u00e9s, no podr\u00e0s permetre a l'usuari introduir la seva pr\u00f2pia contrasenya. Una soluci\u00f3 millor \u00e9s utilitzar un emmagatzematge extern per als noms d'usuari i les seves contrasenyes. Per aix\u00f2 podries emprar un fitxer de text, o millor encara, una base de dades. La informaci\u00f3 d'autenticaci\u00f3 podr\u00e0 estar a\u00efllada en la seva pr\u00f2pia base de dades, o compartir espai d'emmagatzematge amb les dades que utilitze la teva aplicaci\u00f3 web. Si vols emmagatzemar la informaci\u00f3 dels usuaris a la base de dades \" dwes \", has de crear una nova taula en la seva estructura. Per a aix\u00f2, revisa i executa aquestes sent\u00e8ncies SQL. -- Seleccionem la base de dades USE dwes ; -- Creem la taula CREATE TABLE usuaris ( usuari VARCHAR ( 20 ) NOT NULL PRIMARY KEY , contrasenya VARCHAR ( 32 ) NOT NULL ) ENGINE = InnoDB ; -- Creem l'usuari dwes INSERT INTO usuaris ( usuari , contrasenya ) VALUES ( 'dwes' , 'e8dc8ccd5e5f9e3a54f07350ce8a2d3d' ); Tot i que es podrien emmagatzemar les contrasenyes en text pla, \u00e9s millor fer-ho en format encriptat. En l'exemple anterior, per a l'usuari \"dwes\" s'emmagatzema el hash MD5 (m\u00e8tode per generar un resum d'un text o un document, de tal manera que a partir de l'resum obtingut no \u00e9s possible recuperar el text original ni estar un altre text a partir de el qual s'obtingui el mateix resum. Es diu hash a el resum obtingut a l'aplicar una funci\u00f3 hash. Una de les funcions hash m\u00e9s esteses \u00e9s MD5, que genera 128 bits com a resum (normalment es representa mitjan\u00e7ant una cadena de text de 28 car\u00e0cters o mitjan\u00e7ant 32 d\u00edgits hexadecimals)) corresponent a la contrasenya \"abc123.\". En PHP pots utilitzar la funci\u00f3 md5 per calcular el hash MD5 d'una cadena de text. http://es.php.net/manual/es/function.md5.php // Si l'usuari encara no s'ha entrat, demanem les credencials if (!isset ($_SERVER [ 'PHP_AUTH_USER'])) { header ('WWW-Authenticate: Basic realm = \"Contingut restringit\"'); header (\"HTTP/1.0 401 Unauthorized\"); exit; } // Si ja ha enviat les credencials, les vam comprovar amb la base de dades else { // Connectem a la base de dades @$dwes = new mysqli(\"localhost\", \"dwes\", \"abc123.\", \"Dwes\"); $error = $dwes-> connect_errno; // Si es va establir la connexi\u00f3 if ($error == null) { // Executem la consulta per comprovar si existeix // aquesta combinaci\u00f3 d'usuari i contrasenya $sql \u200b\u200b= \"SELECT usuari FROM usuaris WHERE usuari = '$_ SERVER[PHP_AUTH_USER]' AND contrasenya = md5 ( '$_ SERVER[PHP_AUTH_PW]') \"; $resultat = $dwes-> query ($sql); // Si no existeix, es tornen a demanar les credencials if ($resultat-> num_rows == 0) { header ( 'WWW-Authenticate: Basic realm = \"Contingut restringit\"'); header ( \"HTTP / 1.0 401 Unauthorized\"); exit; } $resultat->close(); $dwes->close(); } } <!DOCTYPE html PUBLIC \"- // W3C // DTD HTML 4.01 Transitional // EN\" \"http://www.w3.org/TR/html4/loose.dtd \" > <!-- Desenvolupament Web a Entorn Servidor --> <!-- Tema 4: Desenvolupament d'aplicacions web amb PHP --> <!-- Exemple: Utilitzaci\u00f3 de MySQL per autenticaci\u00f3 HTTP --> < html > < head > < meta http-equiv = \"content-type\" content = \"text / html; charset = UTF-8\" > < title > Exemple Tema 4: Utilitzaci\u00f3 de MySQL per autenticaci\u00f3 HTTP </ title > < link href = \"dwes.css\" rel = \"stylesheet\" type = \"text / css\" > </ head > < body > <?php echo \"Nom d'usuari:\" . $_ SERVER [ 'PHP_AUTH_USER' ] . \"<br />\" ; echo \"Hash de la contrasenya:\" . md5 ( $_ SERVER [ 'PHP_AUTH_PW' ]) . \"<br />\" ; ?> </ body > </ html >","title":"Incorporaci\u00f3 de m\u00e8todes d'autenticaci\u00f3 a una aplicaci\u00f3 web"},{"location":"04-web-programming/04-05-http-authentication/#galetes-cookies","text":"Una galleta \u00e9s un fitxer de text que un lloc web guarda a l'entorn de l'usuari de navegador. El seu \u00fas m\u00e9s t\u00edpic \u00e9s l'emmagatzematge de les prefer\u00e8ncies de l'usuari (per exemple, l'idioma en que s'han de mostrar les p\u00e0gines), perqu\u00e8 no hagi de tornar a indicar-les la propera vegada que visiteu el lloc. Si utilitzes Firefox com a navegador, pots accedir a Desenvolupador web \u2013 Inspector d'emmagatzematge des del men\u00fa principal. Entre les seves caracter\u00edstiques et permet consultar i editar les galetes emmagatzemades en el mateix. En PHP, per emmagatzemar una galleta al navegador de l'usuari, pots utilitzar la funci\u00f3 setcookie . L'\u00fanic par\u00e0metre obligatori que has de fer servir \u00e9s el nom de la galleta, per\u00f2 admet diversos par\u00e0metres m\u00e9s opcionals. setcookie Per a m\u00e9s informaci\u00f3 consulta: https://www.php.net/manual/es/function.setcookie.php . Per exemple, si vols emmagatzemar en una galleta el nom d'usuari que es va transmetre a les credencials HTTP (\u00e9s nom\u00e9s un exemple, no \u00e9s en absolut aconsellable emmagatzemar informaci\u00f3 relativa a la seguretat en les galetes), pots fer: setcookie ( \"nom_usuari\" , $_SERVER [ 'PHP_AUTH_USER' ], time () + 3600 ); Els dos primers par\u00e0metres s\u00f3n el nom de la galleta i el seu valor. El tercer \u00e9s la data de caducitat de la mateixa (una hora des del moment en qu\u00e8 s'execute). En cas de no figurar aquest par\u00e0metre, la galleta s'eliminar\u00e0 quan es tanqui el navegador. Tingues en compte que tamb\u00e9 es poden aplicar restriccions a les p\u00e0gines de el lloc que poden accedir a una galleta en funci\u00f3 de la ruta. Les galetes es transmeten entre el navegador i el servidor web de la mateixa manera que les credencials que acabes de veure; utilitzant les cap\u00e7aleres de el protocol HTTP. Per aix\u00f2, les sent\u00e8ncies setcookie s'han d'enviar abans que el navegador mostri cap informaci\u00f3 a pantalla. El proc\u00e9s de recuperaci\u00f3 de la informaci\u00f3 que emmagatzema una galleta \u00e9s molt simple. quan accedeixes a un lloc web, el navegador li envia de forma autom\u00e0tica tot el contingut de les galetes que emmagatzemi relatives a aquest lloc en concret. Des PHP pots accedir a aquesta informaci\u00f3 per mitj\u00e0 de l'array $_COOKIE . important Sempre que utilitzes galetes en una aplicaci\u00f3 web, heu de tenir en compte que en \u00faltima inst\u00e0ncia la seva disponibilitat est\u00e0 controlada pel client. Per exemple, alguns usuaris deshabiliten les galetes al navegador perqu\u00e8 pensen que la informaci\u00f3 que emmagatzemen pot suposar un potencial problema de seguretat. O la informaci\u00f3 que emmagatzemen pot arribar a perdre perqu\u00e8 el usuari decideix formatar l'equip o simplement eliminar-les de sistema. Si un cop emmagatzemada una galleta al navegador vols eliminar abans que expire, pots utilitzar la mateixa funci\u00f3 setcookie per\u00f2 indicant una data de caducitat anterior a l'actual. Sobre el mateix exercici anterior, emmagatzema en una galleta l'\u00faltim instant en qu\u00e8 el usuari va visitar la p\u00e0gina. Si \u00e9s la seva primera visita, mostra un missatge de benvinguda. En cas contrari, mostra la data i hora de la seva anterior visita. Revisa la soluci\u00f3 proposada. Haur\u00e0s utilitzar la funci\u00f3 setcookie per guardar l'instant de la seva anterior visita i mostrar el seu contingut utilitzant l'array $_COOKIE . // Si l'usuari encara no s'ha entrat, demanem les credencials if ( ! isset ( $_ SERVER [ 'PHP_AUTH_USER' ])) { header ( 'WWW-Authenticate: Basic realm = \"Contingut restringit\"' ); header ( \"HTTP / 1.0 401 Unauthorized\" ); exit ; } // Si ja ha enviat les credencials, les vam comprovar amb la base de dades else { // Connectem a la base de dades @ $dwes = new mysqli ( \"localhost\" , \"dwes\" , \"abc123.\" , \"Dwes\" ); $error = $dwes -> connect_errno ; // Si es va establir la connexi\u00f3 if ( $error == null ) { date_default_timezone_set ( 'Europe/Madrid' ); // Executem la consulta per comprovar si existeix // aquesta combinaci\u00f3 d'usuari i contrasenya $sql \u200b\u200b = \"SELECT usuari FROM usuaris WHERE usuari = '${_ SERVER [' PHP_AUTH_USER ']}' AND contrasenya = md5 ( '${_ SERVER [' PHP_AUTH_PW ']}') \" ; $resultat = $dwes -> query ( $sql ); // Si no existeix, es tornen a demanar les credencials if ( $resultat -> num_rows == 0 ) { header ( 'WWW-Authenticate: Basic realm = \"Contingut restringit\"' ); header ( \"HTTP / 1.0 401 Unauthorized\" ); exit ; } else { if ( isset ( $_ COOKIE [ 'ultimo_login' ])) { $ultimo_login = $_COOKIE [ 'ultimo_login' ]; } setcookie ( \"ultimo_login\" , time (), time () + 3600 ); } $resultat -> close (); $dwes -> close (); } } ?> <!DOCTYPE html PUBLIC \"- // W3C // DTD HTML 4.01 Transitional // EN\" \" http://www.w3.org/TR/html4/loose.dtd \"> <!-- Desenvolupament Web a Entorn Servidor --> <!-- Tema 4: Desenvolupament d'aplicacions web amb PHP --> <!-- Exemple: Galetes al autenticaci\u00f3 HTTP --> <html> <head> <meta http-equiv = \"content-type\" content = \"text / html; charset = UTF-8\"> <title> Exemple Tema 4: Galetes al autenticaci\u00f3 HTTP </ title> <link href = \"dwes.css\" rel = \"stylesheet\" type = \"text / css\"> </head> <body> <?php if ( $error == null ) { echo \"Nom d'usuari:\" . $_ SERVER [ 'PHP_AUTH_USER' ] . \"<br />\" ; echo \"Hash de la contrasenya:\" . md5 ( $_ SERVER [ 'PHP_AUTH_PW' ]) . \"<br />\" ; if ( isset ( $ultimo_login )) echo \"Darrer login:\" . date ( \"d/m/ i \\ a \\ l \\ a \\ s H: i\" , $ultimo_login ); else echo \"Benvingut. Aquesta \u00e9s la seva primera visita.\" ; } else echo \"S'ha produ\u00eft l'error $error . <br />\" ; ?> </body> </html> Reflexiona Quina \u00e9s la durada per defecte d'una galleta si no s'indica la data de caducitat, com en la seg\u00fcent crida a la funci\u00f3 setcookie? setcookie ( \"idioma\" , \"espanyol\" ); Fins que es tanque el navegador de l'usuari. 1 hora.","title":"Galetes (cookies)"},{"location":"04-web-programming/04-05-http-authentication/#maneig-de-sessions","text":"Com acabes de veure, una forma per guardar informaci\u00f3 particular de cada usuari \u00e9s utilitzar galetes ( cookies ). No obstant aix\u00f2, hi ha diversos problemes associats a les galetes, com el nombre d'elles que admet el navegador, o la seva grand\u00e0ria m\u00e0xima. Per solucionar aquests inconvenients, existeixen les sessions. El terme sessi\u00f3 fa refer\u00e8ncia al conjunt d'informaci\u00f3 relativa a un usuari concret. Aquesta informaci\u00f3 pot ser tan simple com el nom de l'usuari mateix, o m\u00e9s complexa, com els articles que ha dipositat a la cistella de compra d'una botiga en l\u00ednia. Cada usuari diferent d'un lloc web t\u00e9 la seva pr\u00f2pia informaci\u00f3 de sessi\u00f3. Per distingir una sessi\u00f3 d'una altra s'usen els identificadors de sessi\u00f3 (SID). Un SID \u00e9s un atribut que s'assigna a cada un dels visitants d'un lloc web i l'identifica. D'aquesta manera, si el servidor web coneix el SID d'un usuari, pot relacionar-lo amb tota la informaci\u00f3 que posseeix sobre ell, que es mant\u00e9 en la sessi\u00f3 de l'usuari. Aquesta informaci\u00f3 s'emmagatzema en el servidor web, generalment en fitxers tot i que tamb\u00e9 es poden utilitzar altres mecanismes d'emmagatzematge com bases de dades. Com ja haur\u00e0s suposat, la q\u00fcesti\u00f3 ara \u00e9s: \u00bfi on s'emmagatzema aquest SID, identificador de la sessi\u00f3, que \u00e9s \u00fanic per a cada usuari? Doncs hi ha dues maneres de mantenir el SID entre les p\u00e0gines d'un lloc web que visita l'usuari: Utilitzant galetes. Propagant el SID en un par\u00e0metre de la URL. El SID s'afegeix com una part m\u00e9s de la URL, de la forma: http://www.misitioweb.com/tienda/listado.php& PHPSESSID=34534fg4ffg34ty En l'exemple anterior, el SID \u00e9s el valor del par\u00e0metre PHPSESSID. Cap de les dues maneres \u00e9s perfecta. Ja saps els problemes que t\u00e9 la utilitzaci\u00f3 de cookies. Malgrat aix\u00f2, \u00e9s el millor m\u00e8tode i el m\u00e9s utilitzat. Propagar el SID com a part de la URL comporta majors desavantatges, com la impossibilitat de mantenir el SID entre diferents sessions, o el fet que compartir la URL amb una altra persona implica compartir tamb\u00e9 l'identificador de sessi\u00f3. La bona not\u00edcia, \u00e9s que el proc\u00e9s de maneig de sessions en PHP est\u00e0 automatitzat en gran mida. Quan un usuari visita un lloc web, no cal programar un procediment per veure si hi ha un SID previ i carregar les dades associades amb el mateix. Tampoc has d'utilitzar la funci\u00f3 setcookie si vols emmagatzemar els SID en galetes, o anar passant el SID entre les p\u00e0gines web del teu lloc si et decideixes per propagar. Tot aix\u00f2 PHP ho fa autom\u00e0ticament. Server side cookies A la informaci\u00f3 que s'emmagatzema en la sessi\u00f3 d'un usuari tamb\u00e9 se li coneix com a galetes en la part de servidor ( server side cookies ). Has de tenir en compte que encara aquesta informaci\u00f3 no viatja entre el client i el servidor, s\u00ed que ho fa el SID, b\u00e9 com a part de l'URL o en una cap\u00e7alera HTTP si es guarda en una galleta. En tots dos casos, aix\u00f2 planteja un possible problema de seguretat. El SID pot ser aconseguit per una altra persona, i a partir de la mateixa obtenir la informaci\u00f3 de la sessi\u00f3 de l'usuari. La manera m\u00e9s segura d'utilitzar sessions \u00e9s emmagatzemant els SID en galetes i utilitzar HTTPS per a xifrar la informaci\u00f3 que es transmet entre el servidor web i el client.","title":"Maneig de sessions"},{"location":"04-web-programming/04-05-http-authentication/#configuracio","text":"Per defecte, PHP inclou suport de sessions incorporat. Abans, per\u00f2, d'utilitzar sessions en el teu lloc web, has de configurar correctament PHP utilitzant els seg\u00fcents directives en el fitxer php.ini segons correspongui: Directiva significat session.use_cookies Indica si s'han d'usar cookies (1) o propagaci\u00f3 a la URL (0) per emmagatzemar el SID. session.use_only_cookies S'ha d'activar (1) quan fas servir cookies per emmagatzemar els SID, i a m\u00e9s no vols que es reconeguin els SID que es puguin passar com part de la URL (aquest m\u00e8tode es pot usar per usurpar l'identificador d'un altre usuari) session.save_handler S'utilitza per indicar a PHP com ha de emmagatzemar les dades de la sessi\u00f3 de l'usuari. Hi ha quatre opcions: en fitxers (files), en mem\u00f2ria (Mm), en una base de dades SQLite (sqlite) o utilitzant per a aix\u00f2 funcions que ha de definir el programador (user). El valor per defecte (Files) funcionar\u00e0 sense problemes en la majoria dels casos. session.name Determina el nom de la galleta que s'utilitzar\u00e0 per guardar el SID. La seva valor per defecte \u00e9s PHPSESSID. session.auto_start El seu valor per defecte \u00e9s 0, i en aquest cas haur\u00e0s de fer servir la funci\u00f3 session_start per gestionar l'inici de les sessions. Si fas servir sessions al lloc web, pot ser bona idea canviar el seu valor a 1 per que PHP activi de forma autom\u00e0tica el maneig de sessions. session.cookie_lifetime Si utilitzes l'URL per propagar el SID, aquest es perdr\u00e0 quan tanqui el navegador. No obstant aix\u00f2, si utilitzes galetes, el SID es mantindr\u00e0 mentre no es destrueixi la galleta. En el seu valor per defecte (0), les galetes es destrueixen quan es tanca el navegador. Si vols que es mantingui el SID durant m\u00e9s temps, has d'indicar en aquesta directiva aquest temps en segons. session.gc_maxlifetime Indica el temps en segons que s'ha de mantenir activa la sessi\u00f3, encara que no hi hagi cap activitat per part de l'usuari. El seu valor per defecte \u00e9s 1440. \u00c9s a dir, passats 24 minuts des de l'\u00faltima activitat per part de l'usuari, es tanca la sessi\u00f3 autom\u00e0ticament. session.cookie_path URL path prefix that must match for the cookie to be sent. session.cookie_domain Domain suffix that must match for the cookie to be sent. No value means the cookie is sent back only to the full hostname that sent it. session.cookie_secure Set to On to have the cookie only sent back with HTTPS URLs. session.cookie_httponly Set to On to tell browsers to prevent JavaScript from reading the cookie. La funci\u00f3 phpinfo , de la qual ja vam parlar amb anterioritat, t'ofereix informaci\u00f3 sobre la configuraci\u00f3 actual de les directives de sessi\u00f3. En la documentaci\u00f3 de PHP tens informaci\u00f3 sobre aquestes i altres directives que permeten configurar el maneig de sessions. https://www.php.net/manual/es/session.configuration.php Question Si la informaci\u00f3 de l'usuari que vols emmagatzemar inclou contingut privat com una contrasenya, \u00bfqu\u00e8 utilitzaries, galetes o la sessi\u00f3 de l'usuari?","title":"Configuraci\u00f3"},{"location":"04-web-programming/04-05-http-authentication/#inici-i-fi-duna-sessio","text":"L'inici d'una sessi\u00f3 pot tenir lloc de dues maneres. Si has activat la directiva session.auto_start en la configuraci\u00f3 de PHP, la sessi\u00f3 comen\u00e7ar\u00e0 autom\u00e0ticament quan un usuari es connecte al teu lloc web. En el cas que aquest usuari ja haja obert una sessi\u00f3 amb anterioritat, i aquesta no s'haja eliminat, en lloc d'obrir una nova sessi\u00f3 es reprendr\u00e0 la anterior. Per a aix\u00f2 s'utilitzar\u00e0 el SID anterior, que estar\u00e0 emmagatzemat en una galleta (recorda que si fas servir propagaci\u00f3 de l'SID, no podr\u00e0s restaurar sessions anteriors; el SID figura a la URL i es perd quan tanques el navegador). Si per contra, decideixes no utilitzar l'inici autom\u00e0tic de sessions, haur\u00e0s executar la funci\u00f3 session_start() per indicar a PHP que inicie una nova sessi\u00f3 o reprenga l'anterior. Anteriorment aquesta funci\u00f3 tornava sempre true , a partir de la versi\u00f3 5.3.0 de PHP el seu comportament \u00e9s m\u00e9s coherent: retorna false en cas de no poder iniciar o restaurar la sessi\u00f3. Com l'inici de sessi\u00f3 requereix utilitzar cookies , i aquestes es transmeten en els encap\u00e7alats HTTP, heu de tenir en compte que per poder iniciar una sessi\u00f3 utilitzant session_start , haur\u00e0s de fer les cridades a aquesta funci\u00f3 abans que la p\u00e0gina web mostre informaci\u00f3 al navegador. A m\u00e9s, totes les p\u00e0gines que necessiten utilitzar la informaci\u00f3 emmagatzemada en la sessi\u00f3, hauran d'executar la funci\u00f3 session_start . Mentre la sessi\u00f3 estiga oberta, pots utilitzar la variable superglobal $_SESSION per afegir informaci\u00f3 a la sessi\u00f3 de l'usuari, o per accedir a la informaci\u00f3 emmagatzemada en la sessi\u00f3. Per exemple, per comptar el nombre de vegades que l'usuari visita la p\u00e0gina, pots fer: <? php // Iniciamos la sesi\u00f3n o recuperamos la anterior sesi\u00f3n existente session_start (); // Comprobamos si la variable ya existe if ( isset ( $_SESSION [ 'visitas' ])) $_SESSION [ 'visitas' ] ++ ; else $_SESSION [ 'visitas' ] = 0 ; ?> Si en lloc de el nombre de visites, voldries emmagatzemar l'instant en qu\u00e8 es produeix cadascuna, la variable de sessi\u00f3 \"visites\" ha de ser una matriu i per tant haur\u00e0s de canviar el codi anterior per: <? php // Iniciamos la sesi\u00f3n o recuperamos la anterior sesi\u00f3n existente session_start (); // En cada visita a\u00f1adimos un valor al array \"visitas\" $_SESSION [ 'visitas' ][] = mktime (); ?> Encara que com ja has vist, pots configurar PHP perqu\u00e8 elimine de forma autom\u00e0tica les dades de una sessi\u00f3 passat cert temps, en ocasions pot ser necessari tancar-la de forma manual en un moment determinat. Per exemple, si utilitzes sessions per recordar la informaci\u00f3 d'autenticaci\u00f3 haur\u00e0s donar-li a l'usuari de la p\u00e0gina web la possibilitat de tancar la sessi\u00f3 quan ho crega convenient. En PHP tens dues funcions per eliminar la informaci\u00f3 emmagatzemada en la sessi\u00f3: session_unset . Elimina les variables emmagatzemades a la sessi\u00f3 actual, per\u00f2 no elimina la informaci\u00f3 de la sessi\u00f3 del dispositiu d'emmagatzematge usat. session_destroy . Elimina completament la informaci\u00f3 de la sessi\u00f3 del dispositiu de emmagatzematge.","title":"Inici i fi d'una sessi\u00f3"},{"location":"04-web-programming/04-05-http-authentication/#activitat","text":"Crea una p\u00e0gina similar a l'anterior, emmagatzemant en la sessi\u00f3 d'usuari els instants de totes les seves \u00faltimes visites. Si \u00e9s la seva primera visita, mostra un missatge de benvinguda. En cas contrari, mostra la data i hora de totes les seves visites anteriors. Afegeix un bot\u00f3 a la p\u00e0gina que permeti esborrar el registre de visites. Utilitza tamb\u00e9 una variable de sessi\u00f3 per a comprovar si l'usuari ja ha iniciat correctament. D'aquesta manera no caldr\u00e0 comprovar les credencials amb la base de dades constantment.","title":"Activitat"},{"location":"04-web-programming/04-05-http-authentication/#gestio-de-la-informacio-de-la-sessio","text":"Ara veurem pas a pas un exemple d'utilitzaci\u00f3 de sessions per a emmagatzemar informaci\u00f3 de l'usuari. Utilitzar\u00e0s la base de dades \"blog\", usada anteriorment, per a crear un prototip d'elements favorits. Les p\u00e0gines de qu\u00e8 constar\u00e0 l'aplicaci\u00f3 web seran: Login ( SecurityController::login ). La seva funci\u00f3 \u00e9s autentificar a l'usuari de l'aplicaci\u00f3 web. Tots els usuaris de l'aplicaci\u00f3 s'hauran autentificar utilitzant aquesta p\u00e0gina abans de poder marcar algun post com a favorit. Afegir a preferits ( PostController::addToFavourite ). Cada entrada disposar\u00e0 d'un bot\u00f3 per a afegir a favorits sempre que el usuari s'haja validat. Llistat de posts favorits ( PostController::favourite ). Presenta un llistat de les entrades favorites. Logoff ( SecurityController::logout ). Aquesta p\u00e0gina desconnecta a l'usuari de l'aplicaci\u00f3 i redirigeix \u200b\u200ba l'usuari de forma autom\u00e0tica a la p\u00e0gina d'inici. No mostra cap informaci\u00f3 en pantalla, pel que no \u00e9s visible per a l'usuari. Abans de comen\u00e7ar tingues en compte que l'aplicaci\u00f3 que vas a desenvolupar no \u00e9s completament funcional. Per exemple: No tindr\u00e0s en compte la possibilitat que l'usuari afegisca diverses vegades la mateixa entrada. Un cop afegida una entrada no es podr\u00e0 eliminar, sols buidar. No es mostraran imatges dels productes. Es mostraran tots els posts en una \u00fanica p\u00e0gina, sense paginaci\u00f3. Encara que redu\u00efm en aquest exemple la funcionalitat, t'animem a que un cop finalitzat el mateix, afegisques pel teu compte totes aquelles opcions que vulguis. Recorda que la millor manera d'aprendre programaci\u00f3 \u00e9s ... programant!","title":"Gesti\u00f3 de la informaci\u00f3 de la sessi\u00f3"},{"location":"04-web-programming/04-05-http-authentication/#autenticar-lusuari","text":"La primera p\u00e0gina que vas a programar \u00e9s la d'autenticaci\u00f3 de l'usuari ( SecurityController::login ). Per variar, far\u00e0s servir les capacitats de maneig de sessions de PHP per emmagatzemar la identificaci\u00f3 dels usuaris. A m\u00e9s, utilitzarem la informaci\u00f3 de la taula \"User\" a la base de dades \"bloc\", accedint mitjan\u00e7ant PDO. Vas a crear a la p\u00e0gina un formulari amb dos camps, un de tipus text per a l'usuari, i un altre de tipus password per a la contrasenya. En pr\u00e9mer el bot\u00f3 Enviar, el formulari s'enviar\u00e0 a aquesta mateixa p\u00e0gina, on es compararan les credencials proporcionades per l'usuari amb les emmagatzemades en la base de dades. Si les dades s\u00f3n correctes, s'iniciar\u00e0 una nova sessi\u00f3 i s'emmagatzemar\u00e0 en ella el nom de l'usuari que s'acaba de connectar. Anem per passos. El codi HTML per crear el formulari, que anir\u00e0 dins el cos de la p\u00e0gina (entre les etiquetes ) ser\u00e0 el seg\u00fcent: {% raw %} < form action = \"{{ router.generateURL('User', 'login') }}\" method = \"post\" > {{ message }} < div class = \"form-group\" > < input name = \"username\" type = \"text\" placeholder = \"Nom d'usuari\" class = \"form-control\" > </ div > < div class = \"form-group\" > < input name = \"password\" type = \"password\" placeholder = \"Contrasenya\" class = \"form-control\" > </ div > < p class = \"text-center\" > < button class = \"btn btn-primary\" name = \"login\" type = \"submit\" >< i class = \"fa fa-sign-in\" ></ i > Iniciar sessi\u00f3 </ button > </ p > </ form > {% endraw %} Fixa't que hi ha un espai per posar els possibles missatges d'error que es produeixin, com la falta d'alguna dada necessari, o un error de credencials err\u00f2nies. El codi PHP que ha de figurar a l'comen\u00e7ament d'aquesta mateixa p\u00e0gina (abans que es mostri qualsevol text), s'encarregar\u00e0 de: Comprovar que s'han introdu\u00eft tant el nom d'usuari com la contrasenya. # UserController.php if (( $this -> request -> getParams () -> has ( 'username' ) && $this -> request -> getParams () -> has ( 'password' )) && $this -> request -> isPost () ) { //Cogemos datos del formulario y validamos $username = $this -> request -> getParams () -> getString ( 'username' ); $password = $this -> request -> getParams () -> getString ( 'password' ); $user = new User (); $user -> setUsername ( $username ); $user -> setPassword ( $password ); // Comprovem que els valors s\u00f3n correctes. $errors = $userModel -> validateLogin ( $user ); Comprovem les credencials. // UserController.php // Si no hi ha errors comprovem les credancials if ( count ( $errors ) == 0 ) { //Cogemos los datos del formulario para comprobar que existe el usuario $loginOk = $userModel -> checkUser ( $user -> getUsername (), $user -> getPassword ()); // UserModel.php try { $loginUsuario = $this -> pdo -> prepare ( \"SELECT * FROM user WHERE username=:username AND password=:password\" ); $loginUsuario -> bindParam ( ':username' , $email , PDO :: PARAM_STR ); $loginUsuario -> bindParam ( ':password' , $password , PDO :: PARAM_STR ); $loginUsuario -> execute (); return $loginUsuario -> rowCount (); } catch ( PDOException $e ) { echo \"Error: \" . $e -> getMessage (); } Si les credencials s\u00f3n correctes carreguem en les dades d'usuari en \\$_SESSION if ( $loginOk > 0 ) { $dataUser = $userModel -> getByUsername ( $user -> getUsername ()); session_start (); $_SESSION [ 'loggedin' ] = true ; $_SESSION [ 'iduser' ] = $dataUser -> getId (); $_SESSION [ 'email' ] = $dataUser -> getEmail (); $_SESSION [ 'nombre' ] = $dataUser -> getUsername (); $_SESSION [ 'id_rol' ] = $dataUser -> getRoles (); header ( \"Location: \" . $GLOBALS [ 'router' ] -> generateUrl ( 'Post' , 'favourite' )); } else { $errors [] = \"Les credencials s\u00f3n inv\u00e0lides\" ; } I redirigir a la p\u00e0gina de les entrades favorites. header ( \"Location: \" . $GLOBALS [ 'router' ] -> generateUrl ( 'Post' , 'favourite' )); Enten b\u00e9 el codi abans de seguir endavant. {: .alert .alert-question } En el codi anterior, la sessi\u00f3 de l'usuari s'inicia s\u00f2l si es proporciona un nom d'usuari i contrasenya correctes. \u00bfPodria haver-se iniciat la sessi\u00f3 en comen\u00e7ar el codi encara que l'usuari no haja proporcionat les credencials?","title":"Autenticar l'usuari"},{"location":"04-web-programming/04-05-http-authentication/#pagina-de-favorits","text":"Quan un usuari proporciona unes credencials d'inici de sessi\u00f3 correctes (recorda que tu ja havies afegit l'usuari \"jane_admin\" amb contrasenya \"admin\"), se li redirigeix \u200b\u200bautom\u00e0ticament a la p\u00e0gina de la llista d'entrades favorites. Aquesta \u00e9s la p\u00e0gina que vas a programar a continuaci\u00f3. // PostController.php public function favourite () { global $router ; // Recuperem la informaci\u00f3 de la sessi\u00f3 session_start (); // Comprovem si l'usuari s'ha autenticat if ( ! isset ( $_SESSION [ 'loggedin' ])) { die ( \"Error - cal autenticar-se <a href= \\\" \" . $router -> generateURL ( 'User' , 'login' ) . \" \\\" \" ); } $postModel = new PostModel ( $this -> db ); $posts = []; if ( ! empty ( $_SESSION [ 'Posts' ])) { foreach ( $_SESSION [ 'Posts' ] as $postId ) { $posts [] = $postModel -> getById ( $postId ); } } $image_dir = $this -> config -> get ( 'image_path' ); $header = '\u00daltimes entrades' ; $properties = [ 'image_dir' => $image_dir , 'header' => 'Entrades favorites' , 'posts' => $posts , 'tags' => $tags ]; return $this -> render ( 'posts/favourite.twig' , $properties ); } public function addToFavourite () { global $router ; // Recuperem la informaci\u00f3 de la sessi\u00f3 session_start (); // Comprovem si l'usuari s'ha autenticat if ( ! isset ( $_SESSION [ 'loggedin' ])) { die ( \"Error - cal autenticar-se <a href= \\\" \" . $router -> generateURL ( 'User' , 'login' ) . \" \\\" \" ); } if ( $this -> request -> isPost ()) { $postId = $this -> request -> getParams () -> getInt ( 'post' ); if ( $postId > 0 ) $_SESSION [ 'Posts' ][] = $postId ; } header ( 'Location: ' . $router -> generateURL ( 'Posts' , 'index' )); } public function emptyFavourite () { global $router ; // Recuperem la informaci\u00f3 de la sessi\u00f3 session_start (); // Buidem l'array amb les entrades favorites unset ( $_SESSION [ 'Posts' ]); header ( 'Location: ' . $router -> generateURL ( 'Posts' , 'index' )); } Les plantilles de Twig {%raw%} #posts/favourite.twig { % block body %} <!-- MOSTREM LES ENTRADES --> {% for post in posts %} < div > < h2 > {{ post . title }} < /h2> <p>Escrit per:<strong>{{ post.user.fullname }} </s trong > {{ post . published_at | date ( \"d/m/Y\" ) }} { % if admin %} <a class=\"btn px-2 secondary-link\" href=\"{{ router.generateURL('Post', 'search') } } \"> <span class=\" fa fa - pencil - square - o \"></span></a> <a class=\" btn px - 2 secondary - link \" href=\" {{ router . generateURL ( 'Post' , 'search' ) }} \"> <span class=\" fa fa - trash - o \"></span></a> {% endif %} </p> <div class=\" fakeimg \"><img class=\" w - 25 img - thumbnail float - left mr - 2 \" src=\" {{ image_dir ~ post . image }} \"/></div> <p>{{ post.summary }}</p> <p><a href=\" {{ router . generateURL ( 'Post' , 'showById' , { id : post . id }) }} \">Llegir m\u00e9s</a> </p> <div class=\" mb - 4 \"> <!-- MOSTREM ELS TAGS --> {% for tag in post.tags %} <a class=\" btn btn - light \" href=\" {{ router . generateURL ( 'Post' , 'showByTag' , { id : tag . id }) }} \"> <span class=\" fa fa - tags \" aria-hidden=\" true \">{{ tag.name }} </a> {% endfor %} </div> </div> <div class=\" clearfix \"></div> {% endfor %} <form class=\" mb - 4 \" action=\" {{ router . generateUrl ( 'Post' , 'emptyFavourite' ) }} \" method=\" post \"> <input type=\" submit \" class=\" btn btn - info \" value=\" Buidar favorits \"> </form> {% endblock %} # posts/show.twig { % extends \"base.twig\" %} {% block body %} <!-- MOSTREM LES ENTRADES --> < div > < h2 > {{ post . title }} < /h2> <p>Escrit per:<strong>{{ post.user.fullname }} </s trong > {{ post . published_at | date ( \"d/m/Y\" ) }} { % if admin %} <a class=\"btn px-2 secondary-link\" href=\"{{ router.generateURL('Post', 'search') } } \"> <span class=\" fa fa - pencil - square - o \"></span></a> <a class=\" btn px - 2 secondary - link \" href=\" {{ router . generateURL ( 'Post' , 'search' ) }} \"> <span class=\" fa fa - trash - o \"></span></a> {% endif %} </p> <div class=\" fakeimg \"><img class=\" w - 25 img - thumbnail float - left mr - 2 \" src=\" {{ image_dir ~ post . image }} \"/></div> <p>{{ post.content|markdown_to_html }}</p> <form class=\" mb - 4 \" action=\" {{ router . generateUrl ( 'Post' , 'addToFavourite' ) }} \" method=\" post \"> <input type=\" hidden \" name=\" post \" value=\" {{ post . id }} \" /> <input type=\" submit \" class=\" btn btn - info \" value=\" Afegir a favorits \"> </form> <p class=\" mb - 4 \"><a href=\" {{ router . generateURL ( 'Post' , 'index' ) }} \">P\u00e0gina principal</a> </p> </div> {% endblock %} {% endraw %} En cada entrada es crea un formulario amb un bot\u00f3 \"Afegir a favorits\" que envia a la p\u00e0gina /favourite/add l'identificador de cada entrada que activa el m\u00e8tode addToFavourite() . Quan s'executa es comprova si s'ha enviat la p\u00e0gina i s'afegeix a \\$_SESSION['Posts] l'idenficador rebut. if ( $this -> request -> isPost ()) { $postId = $this -> request -> getParams () -> getInt ( 'post' ); if ( $postId > 0 ) $_SESSION [ 'Posts' ][] = $postId ; } L'array $_SESSION['Posts'] \u00e9s la variable de sessi\u00f3 en la que emmagatzemarem els identificadors de totes les entrades que l'usuari afegeix a favorits. // Si hi ha elements a favorits els mostrarem if ( ! empty ( $_SESSION [ 'Posts' ])) { foreach ( $_SESSION [ 'Posts' ] as $postId ) { $posts [] = $postModel -> getById ( $postId ); } // Si no, mostrarem un missatge else { $message = \"No hi ha elements favorits\" ; } La p\u00e0gina cont\u00e9 un formulari per a buidar els elements favorits: unset ( $_SESSION [ 'Posts' ]); A m\u00e9s a m\u00e9s, tant en aquesta p\u00e0gina como en la resta, caldr\u00e0 comprovar si la variable \\$_SESSION['loggedin'] existeix per a verificar que l'usuari s'ha autenticat correctament. Para ello, debes incluir el siguiente c\u00f3digo al inicio de la p\u00e1gina. // Recuperem la informaci\u00f3 de la sessi\u00f3 session_start (); // Comprovem si l'usuari s'ha autenticat if ( ! isset ( $_SESSION [ 'loggedin' ])) { die ( \"Error - cal autenticar-se <a href= \\\" \" . $router -> generateURL ( 'User' , 'login' ) . \" \\\" \" ); } Si l'usuari no s'ha autenticat, es mostra un missatge d'error junt amb l'enlla\u00e7 a la p\u00e0gina d'inici de sessi\u00f3. Si des de qualsevol p\u00e0gina l'usuari prem l'opci\u00f3 del men\u00fa \"Favorits\", activar\u00e0 el m\u00e8tode favourite() de PostController en la que se vor\u00e0 totes les entrades que ha marcat com a favorites. // PostController.php public function favourite () { global $router ; // Recuperem la informaci\u00f3 de la sessi\u00f3 session_start (); // Comprovem si l'usuari s'ha autenticat if ( ! isset ( $_SESSION [ 'loggedin' ])) { die ( \"Error - cal autenticar-se <a href= \\\" \" . $router -> generateURL ( 'User' , 'login' ) . \" \\\" \" ); } $postModel = new PostModel ( $this -> db ); $posts = []; if ( ! empty ( $_SESSION [ 'Posts' ])) { foreach ( $_SESSION [ 'Posts' ] as $postId ) { $posts [] = $postModel -> getById ( $postId ); } } $image_dir = $this -> config -> get ( 'image_path' ); $header = '\u00daltimes entrades' ; $properties = [ 'image_dir' => $image_dir , 'header' => 'Entrades favorites' , 'posts' => $posts , 'tags' => $tags ]; return $this -> render ( 'posts/favourite.twig' , $properties ); } Les entrades que es mostren en la p\u00e0gina s'obtenen de la informaci\u00f3 emmagatzemada en la sessi\u00f3. Usarem PostModel per a carregar les dades de cada entrada. En acabar, l'usuari podr\u00e0 tancar sessi\u00f3 activant el m\u00e8tode logout de SecurityController : // Recuperamos la informaci\u00f3n de la sesi\u00f3n session_start (); // Y la eliminamos session_unset (); header ( \"Location: login.php\" ); M\u00e9s informaci\u00f3 sobre les sessions en PHP: Maneig de sessions (PHP)","title":"P\u00e0gina de favorits"},{"location":"04-web-programming/04-05-http-authentication/#bones-practiques","text":"","title":"Bones pr\u00e0ctiques"},{"location":"04-web-programming/04-05-http-authentication/#usa-sempre-https","text":"Usa sempre HTTPS si no s'enviar\u00e0 tota la informaci\u00f3 en text pla. Contrasenyes incloses.","title":"Usa sempre HTTPS"},{"location":"04-web-programming/04-05-http-authentication/#usa-sessions","text":"A difer\u00e8ncia de les galetes les dades emmagatzemades en les sessions no s'envien mitjan\u00e7ant els encap\u00e7alats HTTP, romanen al servidor. El que s\u00ed s'envia \u00e9s l'identificador de sessi\u00f3. Caldr\u00e0 prendre mesures perqu\u00e8 l'identificador no puga ser accessible per tercers i aix\u00ed poder accedir a les dades emmagatzemades. Segons l' OWASP : Session settings are some of the MOST important values to concentrate on in configuring. It is a good practice to change session.name to something new. I proposen la seg\u00fcent configuraci\u00f3 b\u00e0sica: session.save_path = /path/PHP-session/ session.name = myPHPSESSID session.auto_start = Off session.use_trans_sid = 0 session.cookie_domain = full.qualified.domain.name #session.cookie_path = /application/path/ session.use_strict_mode = 1 session.use_cookies = 1 session.use_only_cookies = 1 session.cookie_lifetime = 14400 # 4 hours session.cookie_secure = 1 session.cookie_httponly = 1 session.cookie_samesite = Strict session.cache_expire = 30 session.sid_length = 256 session.sid_bits_per_character = 6 # PHP 7.2+ session.hash_function = 1 # PHP 7.0-7.1 session.hash_bits_per_character = 6 # PHP 7.0-7.1 Les recomanacions en major detall:","title":"Usa sessions"},{"location":"04-web-programming/04-05-http-authentication/#control-de-la-vida-de-sessio","text":"Fes que expire la sessi\u00f3 despr\u00e9s d\u2019un curt per\u00edode d\u2019inactivitat : ajusteu el temps d\u2019inactivitat a 5 minuts per a aplicacions altament protegides fins a no m\u00e9s de 30 minuts per a aplicacions de baix risc. Habilita l\u2019opci\u00f3 de tancament de sessi\u00f3 : caduca i destrueix expl\u00edcitament la sessi\u00f3 en tancar la sessi\u00f3. Eviteu els inicis de sessi\u00f3 persistents (opci\u00f3 \"recordeu-me\") : opcionalment podeu restringir la informaci\u00f3 conservada i revelada per l'aplicaci\u00f3, \u00e9s a dir, obligar a l'usuari a tornar a iniciar sessi\u00f3 abans de realitzar cap operaci\u00f3 cr\u00edtica. Fes que expire la sessi\u00f3 quan hi haja error de seguretat : qualsevol error de seguretat de l'aplicaci\u00f3 hauria de donar lloc a la finalitzaci\u00f3 de la sessi\u00f3. Fes caducar la sessi\u00f3 quan siga de llarga durada : obligaci\u00f3 a reautentificar la sessi\u00f3, que tot i estar actiu ha arribat al temps m\u00e0xim perm\u00e8s, p.e. unes poques hores. Elimineu la galleta de sessi\u00f3 en destruir una sessi\u00f3 .","title":"Control de la vida de sessi\u00f3"},{"location":"04-web-programming/04-05-http-authentication/#identificador-de-sessio","text":"Utilitzeu nom\u00e9s galetes per propagar l\u2019ID de sessi\u00f3 , ja que quan es transmeten mitjan\u00e7ant un par\u00e0metre URL, les sol\u00b7licituds GET poden ser emmagatzemades a l\u2019historial del navegador, a la mem\u00f2ria cau i als marcadors. Aleshores tamb\u00e9 es pot visualitzar f\u00e0cilment. Regenereu l'identificador de sessi\u00f3 : regenereu (substitu\u00efu-ne per un de nou) l'identificador de sessi\u00f3, almenys cada cop que canvie el nivell de privilegi de l'usuari. Generalment es pot regenerar abans de qualsevol transacci\u00f3 important, despr\u00e9s d\u2019un determinat nombre de sol\u00b7licituds o despr\u00e9s d\u2019un per\u00edode de temps. Comproveu si l'identificador de sessi\u00f3 \u00e9s v\u00e0lid (de mida i tipus previst) i que ha estat generat per l'aplicaci\u00f3 i no proporcionat per l'usuari. L'identificador de sessi\u00f3 hauria de ser adequadament llarg, imprevisible, dif\u00edcil de reproduir i creat a partir de fonts aleat\u00f2ries d'alta qualitat .","title":"Identificador de sessi\u00f3"},{"location":"04-web-programming/04-05-http-authentication/#cookie-de-sessio","text":"Definiu el domini de la galleta a quelcom m\u00e9s espec\u00edfic que el domini de primer nivell. No emmagatzeneu res a la galleta (almenys qualsevol informaci\u00f3 sensible com el nom d\u2019usuari o la contrasenya) sols\u2019ID de sessi\u00f3. Definiu el senyalador nom\u00e9s http per desactivar la captura de l'identificador de sessi\u00f3 mitjan\u00e7ant XSS. Quan siga possible, utilitzeu un xifrat fort (SSL) i l'atribut cookie_secure per permetre la transmissi\u00f3 de cookies nom\u00e9s a trav\u00e9s de https.","title":"Cookie de sessi\u00f3"},{"location":"04-web-programming/04-05-http-authentication/#emmagatzematge-de-dades-de-sessio","text":"Determineu on s'emmagatzemen les dades de sessi\u00f3 i si es tracta d\u2019un sistema de fitxers o d\u2019una base de dades, determineu qui m\u00e9s podria tenir acc\u00e9s a aquestes dades. Quan s'emmagatzemen les dades de sessi\u00f3 en fitxers, assegureu-vos que l'aplicaci\u00f3 est\u00e0 configurada per utilitzar un directori privat independent (per exemple, la directiva session.save_path ). Utilitzeu els permisos del sistema de fitxers per protegir aquests fitxers d\u2019observaci\u00f3 o modificaci\u00f3 d\u2019usuaris diferents dels comptes necessaris per operar el servidor web i les aplicacions. Si aix\u00f2 no \u00e9s possible, cal xifrar les dades de la sessi\u00f3 o contenir nom\u00e9s dades no sensibles. Tingueu en compte que PHP utilitza de manera predeterminada el directori temporal del sistema p\u00fablic. Totes les variables de sessi\u00f3 s\u2019han de validar i sanejar per assegurar-se que siguem correctes i que no cont\u00e9 car\u00e0cters inesperats.","title":"Emmagatzematge de dades de sessi\u00f3"},{"location":"04-web-programming/04-05-http-authentication/#no-coneixer-les-contrasenyes","text":"Al final, tothom crea una aplicaci\u00f3 PHP que es basa en la sessi\u00f3 d\u2019usuari. Els noms d\u2019usuari i les contrasenyes s\u2019emmagatzemen en una base de dades i s\u2019utilitzen posteriorment per autentificar els usuaris despr\u00e9s de l\u2019inici de sessi\u00f3. \u00c9s important que fer hash de les contrasenyes correctament abans d\u2019emmagatzemar-les. El hashing i el xifrat s\u00f3n dues coses molt diferents que sovint es confonen. El hashing \u00e9s una funci\u00f3 irreversible i unidireccional. \u00c9s produeix una cadena de longitud fixa que no es pot invertir. Aix\u00f2 vol dir que podeu comparar un hash amb un altre per determinar si tots dos provenien de la mateixa cadena font, per\u00f2 no podeu determinar la cadena original. Si les contrasenyes no s'emmagatzemen amb hashing i un tercer no autoritzat accedeix a la vostra base de dades, tots els comptes d'usuari estaran compromesos. A difer\u00e8ncia del hashing , el xifrat \u00e9s reversible (sempre que tingueu la clau). El xifratge \u00e9s \u00fatil en altres \u00e0rees, per\u00f2 \u00e9s una estrat\u00e8gia deficient per emmagatzemar contrasenyes de forma segura. Les contrasenyes tamb\u00e9 han de salar-se individualment afegint una cadena aleat\u00f2ria a cada contrasenya abans d'aplicar hashing . Aix\u00f2 evita els atacs de diccionari i l'\u00fas de \"taules de l'arc de Sant Mart\u00ed\" (una llista inversa de hash criptogr\u00e0fics per a contrasenyes comunes.) El hashing i el salat s\u00f3n vitals, ja que sovint els usuaris utilitzen la mateixa contrasenya per a diversos serveis i la qualitat de la contrasenya \u00e9s deficient. Addicionalment, haureu d'utilitzar un algorisme especialitzat en hashing en lloc d'una funci\u00f3 de hash criptogr\u00e0fic de prop\u00f2sit general i r\u00e0pid (per exemple, SHA256). La llista breu d'algorismes de hashing de contrasenya acceptables (a juny de 2018) a utilitzar s\u00f3n: Argon2 (disponible a PHP 7.2 i versions posteriors) Scrypt Bcrypt (PHP us proporciona aquesta; vegeu m\u00e9s avall) PBKDF2 amb HMAC-SHA256 o HMAC-SHA512 Afortunadament, avui en dia PHP ens ho facilita.","title":"No con\u00e8ixer les contrasenyes"},{"location":"04-web-programming/04-05-http-authentication/#hashing-de-contrasenyes-amb-password_hash","text":"A PHP 5.5 s'ha introdu\u00eft password_hash() . En aquest moment est\u00e0 utilitzant BCrypt, l'algorisme m\u00e9s fort actualment suportat per PHP. Tot i aix\u00f2, s'actualitzar\u00e0 en el futur per donar suport a m\u00e9s algoritmes. La biblioteca de password_compat es va crear per proporcionar una compatibilitat de PHP> = 5.3.7. A continuaci\u00f3 hem aplicat hashing a una cadena i, a continuaci\u00f3, apliquem el hashing contra una nova cadena. Com que les dues cadenes d'origen s\u00f3n diferents (\"contrasenya-secreta\" i \"contrasenya-err\u00f2nia\"), aquesta sessi\u00f3 fallar\u00e0. $passwordHash = password_hash ( \"contrasenya-secreta\" , PASSWORD_DEFAULT ); if ( password_verify ( \"contrenya-err\u00f2nia\" , $passwordHash )) { // Contrasenya correcta } else { // Contrasenya incorrecta } password_hash() s'ocupa de la salificaci\u00f3 de contrasenyes. La sal s'emmagatzema, juntament amb l'algorisme i el \"cost\", com a part del hash. password_verify() extreu aix\u00f2 per determinar com comprovar la contrasenya, de manera que no necessiteu un camp de base de dades independent per emmagatzemar les vostres sals. PASSWORD_DEFAULT PASSWORD_DEFAULT . Actualment utilitza l\u2019algoritme bcrypt (predeterminat a partir de PHP 5.5.0). Observeu que aquesta constant est\u00e0 pensada per a adaptar-se sempre que hi haja un algoritme nou i m\u00e9s fort a PHP. Per aquesta ra\u00f3, la longitud del resultat d\u2019utilitzar aquest identificador pot canviar amb el temps. Per tant, es recomana emmagatzemar el resultat en una columna d\u2019una base de dades de m\u00e9s de 60 caracters (255 caracters seria una bona elecci\u00f3).","title":"Hashing de contrasenyes amb password_hash"},{"location":"04-web-programming/04-05-http-authentication/#activitat_1","text":"Adapta el projecte de forma que: Cada 15 minuts es regenere la sessi\u00f3. Sols use http per accedir a la cookie de sessi\u00f3. Les constrasenyes s'encripten amb bcrypt . Es tanque la sessi\u00f3 tal com s'indica.","title":"Activitat"},{"location":"04-web-programming/04-05-http-authentication/#recursos","text":"The 2018 Guide to Building Secure PHP Software PHP: The Right Way. Security Session Management Basics Ultimate PHP Security Best Practices PHP Session Security Best Practices PHP Sessions in depth Session Management Cheat Sheet","title":"Recursos"},{"location":"04-web-programming/04-99-tasks/","text":"Activitats Formularis 401ExempleGet.php : Crea una p\u00e0gina que reba com a par\u00e0metre un nom i mostre el text Benvingut [nom]!!! sent [nom] el nom has passat com a par\u00e0metre. 402formulari.html i 402formulari.php : Crea un formulari que tinga els seg\u00fcents camps: Nom i cognoms ( name ) Correu electr\u00f2nic ( email ) Tel\u00e8fon ( phone ) URL de la p\u00e0gina personal ( url ). En l'atribut action del formulari posarem el seg\u00fcent: < form action = \"402formulari.php\" method = \"POST\" ... /> A\u00e7\u00f2 far\u00e0 que siga la p\u00e0gina 402formulari.php la que processe les dades del formulari. En pr\u00e9mer Enviar han d'apar\u00e8ixer en la p\u00e0gina les dades que s'han introdu\u00eft en format de taula. 403formulariReparat.php : Soluciona el problema dels par\u00e0metres no enviats en accedir directament a la p\u00e0gina de processament del formulari. 404formulariValidat.php : Modifica l'exercici anterior realitzant les seg\u00fcents validacions: Tots els camps s\u00f3n obligatoris. name , no pot superar els 100 caracters. phone , ser\u00e0 un string i ha de contenir 9 digits (expressi\u00f3 regular: ^\\d{9}$ ). email , ha de ser una adre\u00e7a electr\u00f2nica correcta. url , ha de ser una url v\u00e0lida. S'avaluaran tots els camps i si hi ha error/s caldr\u00e0 mostrar-lo/s. Si no hi ha errors es mostraran les dades introdu\u00efdes per l'usuari. 405formulariOpcions.html i 405formulariOpcions.php : Modifica l'exercici anterior afegint els seg\u00fcents camps al formulari: genre : ser\u00e0 un radio button i podr\u00e0 ser home , dona i no binari . hobbies : ser\u00e0 un checkbox amb aficions de la que podr\u00e0s triar-ne m\u00e9s d'una: Lectura Programaci\u00f3 Ciclisme C\u00f3rrer ... contact_time : ser\u00e0 una llista de les millores hores per a contactar: Primera hora (08:00 a 10:00) Abans de dinar (12:00 a 13:00) Despr\u00e9s de dinar (14:00 a 16:00) A la nit (20:00 a 22:00) En els tres casos s\u00f3n obligatoris. 406formulariUnic.php . Modifica l'exercici anterior de forma que tant el formulari com el seu processament es realitze en el mateix fitxer. Si totes les dades enviades s\u00f3n correctes es mostrar\u00e0 la taula amb la informaci\u00f3 enviada. En cas d'error es mostraran dalt i el formulari guardar\u00e0 els valors v\u00e0lids en cas d'error ( sticky form ). 407formulariArray : Modifica l'exercici anterior de forma que el contingut dels camps de selecci\u00f3 es genere din\u00e0micament des d'arrays associatius. Les claus seran man , woman , nobinary per als g\u00e8neres, reading , programming , cycling , running per a les aficions i morning , before_lunch , after_lunch i evening per a les hores de contacte. A m\u00e9s, els valors rebuts s'haurien de validar-se contra l' array , \u00e9s a dir, que el valor enviat \u00e9s una clau v\u00e0lida de l'array. Tamb\u00e9 caldr\u00e0 mostrar en la taula els valors dels arrays, no les claus. Inclusi\u00f3 de fitxers 410formulari.php : Basant-te en l'activitat 407formulariArray.php modifica les validacions perqu\u00e8 es facen mitjan\u00e7ant funcions. Les funcions es guardaran en el fitxer helpers.php i s'hauran d'incloure en fitxer 410formulari.php . 411formulari.php : Basant-te en l'activitat 410formulari.php separa la part de codi de la presentaci\u00f3 de forma que tota la l\u00f2gica estiga en un fitxer i la part de presentaci\u00f3 en altre fitxer 411formulari.view.php . Pujada de fitxers 420formulariImatge.php : Modifica l'activitat anterior afegint un camp de tipus FILE per a pujar una imatge al servidor. Es guardar\u00e0 en la carpeta uploads i es mostrar\u00e0 amb la resta de dades. 421FormulariImage.php : Modifica l'activitat anterior de forma que es controle el seg\u00fcent: Les imatges sols podran ser jpg . No podran superar 1MB de grand\u00e0ria Es guardaran en un nom aleatori \u00fanic. Projecte Truiter Formularis P\u00e0gina d'inici de sessi\u00f3. Crea en login.php un formulari d'inici de sessi\u00f3: En un \u00fanic fitxer es mostrar\u00e0 i processar\u00e0 el formulari. Les dades d'usuari estaran en un array associatiu. Si la validaci\u00f3 \u00e9s correcta es mostrar\u00e0 un missatge de confirmaci\u00f3. De no ser-ho es mostrar\u00e0 un missatge d'error. Cookies \u00daltima visita. Modifica la p\u00e0gina index.php de forma que emmagatzeme en una galleta l'\u00faltim instant en qu\u00e8 l'usuari va visitar la p\u00e0gina. Si \u00e9s la seva primera visita, mostra un missatge de benvinguda. En cas contrari, mostra la data i hora de la seva anterior visita. La galleta tindr\u00e0 una durada d'una setmana. Comprova que la galleta s'ha creat correctament. Emmagatzematge del nom de l'usuari. L'objectiu \u00e9s que quan un usuari inicie sessi\u00f3 s'emmagatzeme el nom introdu\u00eft en un galleta, de forma que quan torne a accedir al formulari d'inici de sessi\u00f3 aparega el nom autom\u00e0ticament. El nom de la cookie ser\u00e0 last_used_name i la durada ser\u00e0 de 30 dies. Crea la p\u00e0gina logout.php que en accedir eliminar\u00e0 la cookie . Assegurant les galetes. Despr\u00e9s de llegir l'article enlla\u00e7at als apunts, aplica els canvis oportuns per a fer m\u00e9s segures les cookies . Maneig de sessions Registre de visites Modifica la p\u00e0gina inicial del projecte ( index.php ) de forma que s'emmagatzeme en la sessi\u00f3 d'usuari els instants de totes les seves \u00faltimes visites. Si \u00e9s la seva primera visita, mostra un missatge de benvinguda. En cas contrari, mostra la data i hora de totes les seves visites anteriors. Afegeix un bot\u00f3 a la p\u00e0gina que permeta esborrar el registre de visites. Control d'acc\u00e9s Modifica el projecte de forma que en iniciar sessi\u00f3 ( login.php ) s'emmagatzeme un token en una variable de sessi\u00f3. Aquesta variable ens servir\u00e0 per comprovar si l'usuari ja ha iniciat sessi\u00f3 correctament. Un usuari sols podr\u00e0 accedir a la p\u00e0gina logout.php si ha iniciat sessi\u00f3. En aquest cas, en inicar la sessi\u00f3 correctament caldr\u00e0 redirigir a l'usuari a la p\u00e0gina principal mitjan\u00e7ant un missatge flaix que mostre el text: \"L'usuari administrador ha iniciat sessi\u00f3 correctament\". Nous tuits Crea la p\u00e0gina tweet-new.php que contindr\u00e0 un formulari per a la creaci\u00f3 d'un tweet. Evitar atacts CSRF Implementa en el formulari de creaci\u00f3 de tuits la soluci\u00f3 proposada en els apunts. Gesti\u00f3 de formularis en dos fitxers. Modifica el formulari de creaci\u00f3 de tuits de forma que es gestione en dos fitxers tal com s'indica en els apunts. Bones pr\u00e0ctiques Adapta el projecte de forma que: Cada 15 minuts es regenere la sessi\u00f3. Sols use http per accedir a la cookie de sessi\u00f3. Les constrasenyes s'encripten amb bcrypt . Es tanque la sessi\u00f3 tal com s'indica. Sessions Fes una c\u00f2pia del formulari de l'activitat 407 i modifica'l de forma que es gestione en tres p\u00e0gines: form.php que mostrar\u00e0 el formulari amb els errors quan hi hagen. form_process.php que processar\u00e0 el formulari de forma que: En cas d'error redirigir\u00e0 a form.php emmagatzemant en una variable de sessi\u00f3 els errors i les dades correctes. En cas d'\u00e8xit redirigir\u00e0 a form_success.php que mostrar\u00e0 en format de taula les dades enviades. form_success.php que mostrar\u00e0 en format de taula les dades del formulari Truiter Clona el repositori https://github.com/corriol/2023-truiter i integra, respectant l'estructura definida, totes les activitats que han de vore amb el projecte: inici i tancament de sessi\u00f3 i creaci\u00f3 de nous tweets.","title":"Activitats"},{"location":"04-web-programming/04-99-tasks/#activitats","text":"","title":"Activitats"},{"location":"04-web-programming/04-99-tasks/#formularis","text":"401ExempleGet.php : Crea una p\u00e0gina que reba com a par\u00e0metre un nom i mostre el text Benvingut [nom]!!! sent [nom] el nom has passat com a par\u00e0metre. 402formulari.html i 402formulari.php : Crea un formulari que tinga els seg\u00fcents camps: Nom i cognoms ( name ) Correu electr\u00f2nic ( email ) Tel\u00e8fon ( phone ) URL de la p\u00e0gina personal ( url ). En l'atribut action del formulari posarem el seg\u00fcent: < form action = \"402formulari.php\" method = \"POST\" ... /> A\u00e7\u00f2 far\u00e0 que siga la p\u00e0gina 402formulari.php la que processe les dades del formulari. En pr\u00e9mer Enviar han d'apar\u00e8ixer en la p\u00e0gina les dades que s'han introdu\u00eft en format de taula. 403formulariReparat.php : Soluciona el problema dels par\u00e0metres no enviats en accedir directament a la p\u00e0gina de processament del formulari. 404formulariValidat.php : Modifica l'exercici anterior realitzant les seg\u00fcents validacions: Tots els camps s\u00f3n obligatoris. name , no pot superar els 100 caracters. phone , ser\u00e0 un string i ha de contenir 9 digits (expressi\u00f3 regular: ^\\d{9}$ ). email , ha de ser una adre\u00e7a electr\u00f2nica correcta. url , ha de ser una url v\u00e0lida. S'avaluaran tots els camps i si hi ha error/s caldr\u00e0 mostrar-lo/s. Si no hi ha errors es mostraran les dades introdu\u00efdes per l'usuari. 405formulariOpcions.html i 405formulariOpcions.php : Modifica l'exercici anterior afegint els seg\u00fcents camps al formulari: genre : ser\u00e0 un radio button i podr\u00e0 ser home , dona i no binari . hobbies : ser\u00e0 un checkbox amb aficions de la que podr\u00e0s triar-ne m\u00e9s d'una: Lectura Programaci\u00f3 Ciclisme C\u00f3rrer ... contact_time : ser\u00e0 una llista de les millores hores per a contactar: Primera hora (08:00 a 10:00) Abans de dinar (12:00 a 13:00) Despr\u00e9s de dinar (14:00 a 16:00) A la nit (20:00 a 22:00) En els tres casos s\u00f3n obligatoris. 406formulariUnic.php . Modifica l'exercici anterior de forma que tant el formulari com el seu processament es realitze en el mateix fitxer. Si totes les dades enviades s\u00f3n correctes es mostrar\u00e0 la taula amb la informaci\u00f3 enviada. En cas d'error es mostraran dalt i el formulari guardar\u00e0 els valors v\u00e0lids en cas d'error ( sticky form ). 407formulariArray : Modifica l'exercici anterior de forma que el contingut dels camps de selecci\u00f3 es genere din\u00e0micament des d'arrays associatius. Les claus seran man , woman , nobinary per als g\u00e8neres, reading , programming , cycling , running per a les aficions i morning , before_lunch , after_lunch i evening per a les hores de contacte. A m\u00e9s, els valors rebuts s'haurien de validar-se contra l' array , \u00e9s a dir, que el valor enviat \u00e9s una clau v\u00e0lida de l'array. Tamb\u00e9 caldr\u00e0 mostrar en la taula els valors dels arrays, no les claus.","title":"Formularis"},{"location":"04-web-programming/04-99-tasks/#inclusio-de-fitxers","text":"410formulari.php : Basant-te en l'activitat 407formulariArray.php modifica les validacions perqu\u00e8 es facen mitjan\u00e7ant funcions. Les funcions es guardaran en el fitxer helpers.php i s'hauran d'incloure en fitxer 410formulari.php . 411formulari.php : Basant-te en l'activitat 410formulari.php separa la part de codi de la presentaci\u00f3 de forma que tota la l\u00f2gica estiga en un fitxer i la part de presentaci\u00f3 en altre fitxer 411formulari.view.php .","title":"Inclusi\u00f3 de fitxers"},{"location":"04-web-programming/04-99-tasks/#pujada-de-fitxers","text":"420formulariImatge.php : Modifica l'activitat anterior afegint un camp de tipus FILE per a pujar una imatge al servidor. Es guardar\u00e0 en la carpeta uploads i es mostrar\u00e0 amb la resta de dades. 421FormulariImage.php : Modifica l'activitat anterior de forma que es controle el seg\u00fcent: Les imatges sols podran ser jpg . No podran superar 1MB de grand\u00e0ria Es guardaran en un nom aleatori \u00fanic.","title":"Pujada de fitxers"},{"location":"04-web-programming/04-99-tasks/#projecte-truiter","text":"","title":"Projecte Truiter"},{"location":"04-web-programming/04-99-tasks/#formularis_1","text":"P\u00e0gina d'inici de sessi\u00f3. Crea en login.php un formulari d'inici de sessi\u00f3: En un \u00fanic fitxer es mostrar\u00e0 i processar\u00e0 el formulari. Les dades d'usuari estaran en un array associatiu. Si la validaci\u00f3 \u00e9s correcta es mostrar\u00e0 un missatge de confirmaci\u00f3. De no ser-ho es mostrar\u00e0 un missatge d'error.","title":"Formularis"},{"location":"04-web-programming/04-99-tasks/#cookies","text":"\u00daltima visita. Modifica la p\u00e0gina index.php de forma que emmagatzeme en una galleta l'\u00faltim instant en qu\u00e8 l'usuari va visitar la p\u00e0gina. Si \u00e9s la seva primera visita, mostra un missatge de benvinguda. En cas contrari, mostra la data i hora de la seva anterior visita. La galleta tindr\u00e0 una durada d'una setmana. Comprova que la galleta s'ha creat correctament. Emmagatzematge del nom de l'usuari. L'objectiu \u00e9s que quan un usuari inicie sessi\u00f3 s'emmagatzeme el nom introdu\u00eft en un galleta, de forma que quan torne a accedir al formulari d'inici de sessi\u00f3 aparega el nom autom\u00e0ticament. El nom de la cookie ser\u00e0 last_used_name i la durada ser\u00e0 de 30 dies. Crea la p\u00e0gina logout.php que en accedir eliminar\u00e0 la cookie . Assegurant les galetes. Despr\u00e9s de llegir l'article enlla\u00e7at als apunts, aplica els canvis oportuns per a fer m\u00e9s segures les cookies .","title":"Cookies"},{"location":"04-web-programming/04-99-tasks/#maneig-de-sessions","text":"Registre de visites Modifica la p\u00e0gina inicial del projecte ( index.php ) de forma que s'emmagatzeme en la sessi\u00f3 d'usuari els instants de totes les seves \u00faltimes visites. Si \u00e9s la seva primera visita, mostra un missatge de benvinguda. En cas contrari, mostra la data i hora de totes les seves visites anteriors. Afegeix un bot\u00f3 a la p\u00e0gina que permeta esborrar el registre de visites. Control d'acc\u00e9s Modifica el projecte de forma que en iniciar sessi\u00f3 ( login.php ) s'emmagatzeme un token en una variable de sessi\u00f3. Aquesta variable ens servir\u00e0 per comprovar si l'usuari ja ha iniciat sessi\u00f3 correctament. Un usuari sols podr\u00e0 accedir a la p\u00e0gina logout.php si ha iniciat sessi\u00f3. En aquest cas, en inicar la sessi\u00f3 correctament caldr\u00e0 redirigir a l'usuari a la p\u00e0gina principal mitjan\u00e7ant un missatge flaix que mostre el text: \"L'usuari administrador ha iniciat sessi\u00f3 correctament\". Nous tuits Crea la p\u00e0gina tweet-new.php que contindr\u00e0 un formulari per a la creaci\u00f3 d'un tweet. Evitar atacts CSRF Implementa en el formulari de creaci\u00f3 de tuits la soluci\u00f3 proposada en els apunts. Gesti\u00f3 de formularis en dos fitxers. Modifica el formulari de creaci\u00f3 de tuits de forma que es gestione en dos fitxers tal com s'indica en els apunts. Bones pr\u00e0ctiques Adapta el projecte de forma que: Cada 15 minuts es regenere la sessi\u00f3. Sols use http per accedir a la cookie de sessi\u00f3. Les constrasenyes s'encripten amb bcrypt . Es tanque la sessi\u00f3 tal com s'indica.","title":"Maneig de sessions"},{"location":"04-web-programming/04-99-tasks/#sessions","text":"Fes una c\u00f2pia del formulari de l'activitat 407 i modifica'l de forma que es gestione en tres p\u00e0gines: form.php que mostrar\u00e0 el formulari amb els errors quan hi hagen. form_process.php que processar\u00e0 el formulari de forma que: En cas d'error redirigir\u00e0 a form.php emmagatzemant en una variable de sessi\u00f3 els errors i les dades correctes. En cas d'\u00e8xit redirigir\u00e0 a form_success.php que mostrar\u00e0 en format de taula les dades enviades. form_success.php que mostrar\u00e0 en format de taula les dades del formulari","title":"Sessions"},{"location":"04-web-programming/04-99-tasks/#truiter","text":"Clona el repositori https://github.com/corriol/2023-truiter i integra, respectant l'estructura definida, totes les activitats que han de vore amb el projecte: inici i tancament de sessi\u00f3 i creaci\u00f3 de nous tweets.","title":"Truiter"},{"location":"04-web-programming/05-03-sessions/","text":"","title":"05 03 sessions"},{"location":"04-web-programming/assets/04-01-forms/","text":"Processament de formularis Fins ara ens hem centrat a con\u00e8ixer les caracter\u00edstiques del llenguatge PHP. En aquesta unitat posarem el focus en les caracter\u00edstiques pr\u00f2pies de les aplicacions web i com podem gestionar-les amb PHP. Aix\u00ed, veurem com enviar informaci\u00f3 mitjan\u00e7ant formularis, com processar-la i com podem mantenir informaci\u00f3 entre sol\u00b7licituds, \u00e9s a dir, mantenir l'estat. Variables predefinides Les variables predefinides s\u00f3n variables internes de PHP que poden usar-se des de qualsevol \u00e0mbit, per aix\u00f2 s'anomenen variables superglobals . Es tracta d' arrays associatius que contenen un conjunt de valors. $_SERVER . Cont\u00e9 informaci\u00f3 sobre l'entorn del servidor web i d'execuci\u00f3. $_GET, $_POST i $_COOKIE contenen les variables que s'han passat al script actual utilitzant, respectivament, els m\u00e8todes GET (par\u00e0metres en la URL), HTTP POST i Cookies HTTP $_REQUEST junta en un solament el contingut dels tres *arrays anteriors, $_GET , $_POST i $_COOKIE . $_ENV cont\u00e9 les variables que es puguen haver passat a PHP des de l'entorn en qu\u00e8 s'executa. $_FILES cont\u00e9 els fitxers que es puguen haver pujat al servidor utilitzant el m\u00e8tode POST. $_SESSION cont\u00e9 les variables de sessi\u00f3 disponibles per al gui\u00f3 actual. http://es.php.net/manual/es/language.variables.superglobals.php Qu\u00e8 \u00e9s una petici\u00f3 HTTP? Una petici\u00f3 HTTP \u00e9s una sol\u00b7licitud d'un recurs a un servidor. La petici\u00f3 es realitza a trav\u00e9s d'unes URL. Amb la petici\u00f3 s'envien tamb\u00e9 par\u00e0metres. Hi ha diferents m\u00e8todes ( METHOD ) per a realitzar una petici\u00f3 ( GET , POST , PUT , DELETE , PATCH , etc.). Els m\u00e9s habituals s\u00f3n GET , que ja coneixes, i POST . La resta s\u00f3n m\u00e9s utilitzats en les RESTful API. M\u00e8tode GET El m\u00e8todo de sol\u00b7licitud GET t\u00e9 les seg\u00fcents caracter\u00edstiques: S'utilitza per a sol\u00b7licitar dades d'un recurs. Mostren els par\u00e0metres que s'envien en la url. Es poden utilitzar directament en enlla\u00e7os. El resultat es pot emmagatzemar en cache. Romanen en l'historial del navegador. La grand\u00e0ria dels par\u00e0metres est\u00e0 limitat a 2048 car\u00e0cters. Exemple de petici\u00f3 GET Inspecci\u00f3 de la petici\u00f3 Inspecci\u00f3 de la petici\u00f3 Accedir a les dades de la petici\u00f3 GET Per a accedir a les dades usem la variable superglobal $_GET . $_GET \u00e9s un array associatiu les claus del qual coincidiran amb els noms que li hem donat als par\u00e0metres. Per a accedir als par\u00e0metres de la petici\u00f3 anterior: echo $_GET [ 'nom' ] . ' ' . $_GET [ 'cognom' ]; // Homer Simpson M\u00e8tode POST El m\u00e8tode POST t\u00e9 les seg\u00fcents caracter\u00edstiques: S'utilitza per a enviar dades a un recurs. Els par\u00e0metres van en el cos de la petici\u00f3, no s\u00f3n visibles per a l'usuari. La petici\u00f3 no es guarda en cache. No es pot utilitzar en un enlla\u00e7. No roman en l'historial. No tenim la limitaci\u00f3 de grand\u00e0ria dels par\u00e0metres. Es solen utilitzar en els formularis. Evitar el CSRF En tota p\u00e0gina que reba par\u00e0metres POST has de comprovar el HTTP referer del navegador, i que aquest siga de dins de la teua web. En PHP el referer que envia el navegador s'emmagatzema en $_SERVER['HTTP_REFERER'] . \u00c9s a dir, sols processarem peticions que vinguen del teu lloc web. M\u00e9s informaci\u00f3 En el seg\u00fcent enlla\u00e7 trobareu m\u00e9s informaci\u00f3 relativa als atacs CSRF CSRF: explicaci\u00f3n del ataque Cross Site Request Forgery Seria tal com: if ( parse_url ( $_SERVER [ 'HTTP_REFERER' ], PHP_URL_HOST ) != $_SERVER [ 'HTTP_HOST' ]) die ( 'Anti-CSRF' ); Important Amb aquest codi estem obligant que el navegador envie un referer si o s\u00ed. Per tant nom\u00e9s ha d'utilitzar-se en p\u00e0gines a les quals el navegador accedisca des d'una altra p\u00e0gina de la nostra web. \u00d2bviament no podem col\u00b7locar-ho en la primera p\u00e0gina a la qual s'accedeix a la nostra web ( index.php o similar), ja que si l'usuari a escrit l'adre\u00e7a a m\u00e0 en la barra del navegador no s'enviar\u00e0 referer cap i saltar\u00e0 el sistema. Definici\u00f3 de formularis Com hem dit abans el m\u00e8tode POST s'empra en els formularis. El formulari seg\u00fcent enviar\u00e0 les dades a la p\u00e0gina index.php (atribut action de l'element form ). Utilitza el m\u00e8tode post indicat en l'atribut method : < form action = \"index.php\" method = \"post\" > < label for = \"nom\" > Nom </ label > < input type = \"text\" name = \"nom\" value = \"\" > < br /> < label for = \"cognom\" > Cognom </ label > < input type = \"text\" name = \"cognom\" value = \"\" > < br /> < input type = \"submit\" value = \"Enviar\" > </ form > Inspecci\u00f3 de la petici\u00f3: Headers Inspecci\u00f3 de la petici\u00f3: Param\u00e8tres Accedir a les dades de la petici\u00f3 POST Usem la variable superglobal $_POST . Funciona igual que $_GET , per\u00f2 amb els noms (atribut name ) que li hem donat als camps del formulari. En depuraci\u00f3 podem mostar totes les dades rebudes: var_dump ( $_POST ); print_r ( $_POST ) Per a mostrar les dades individualment: echo $_POST [ 'nom' ]; echo $_POST [ 'cognom' ]; Accedir a par\u00e0metres no existents Errors del tipus Notice: Undefined index: nom in /home/ubuntu/index.php on line 6 ens indiquen que la clau nom no existeix en l'array $_POST . La variable supergloblal $_POST est\u00e0 buida si no s'ha enviat el formulari. Per a evitar aquest tipus d'errors \u00e9s important verificar que s'haja enviat el formulari pr\u00e8viament: if ( $_SERVER [ 'REQUEST_METHOD' ] === 'POST' ) { } Validaci\u00f3 de formularis Hem de comprovar que les dades que envia el formulari s\u00f3n correctes. Les validacions a realitzar s\u00f3n les seg\u00fcents: Els camps requerits no han de quedar buits. Ni contenir espais en blanc a l'inici i al final. Els camps email i data han de tenir el format esperat. Tots els camps s'han de filtrar amb htmlspecialchars per a evitar atacs de Cross-site Scripting (XSS). Aquest article sobre Cross-site Scripting \u00e9s molt il\u00b7lustratiu: PHP Form Validation Valors buits Els camps requerits no deurien quedar-se buits. Per a verificar que un valor no queda buit podem utilitzar la funci\u00f3 empty() de PHP. Espais en blanc Hem d'eliminar els espais en blanc del principi i final dels camps. S'utilitza la funci\u00f3 trim Escapar l'entrada Sempre hem de filtrar l'entrada amb htmlspecialchars abans de mostrar el camp amb echo o similar. Ac\u00f2 convertir\u00e0 qualsevol car\u00e0cter especial d'html en la entitat corresponent, aix\u00ed no interferir\u00e0 en el el programa. Comprovar l'email Per a verificar si un email \u00e9s correcte podem utilitzar la funci\u00f3 filter_var filter_var ( $email , FILTER_VALIDATE_EMAIL ) o la funci\u00f3 filter_input quan obtenin les dades directament d'una variable extern. // suposem que rebem les dades d'un formulari que t\u00e9 un quadre de text de nom 'email' $email = filter_input ( INPUT_POST , 'email' , FILTER_VALIDATE_EMAIL ) filter_input filter_input ( int $type , string $variable_name [, int $filter = FILTER_DEFAULT [, mixed $options ]]) : mixed La funci\u00f3 filter_input agafa una variable externa ( $_GET , $_POST , etc) concreta pel seu nom i aplica el filtre indicat. Els filtres poden sanejar o validar les variables externes. Per exemple, si volem agafar el valor del par\u00e0metre nom del querystring ( http://localhost/index.php?nom=<h1>Homer</h1> ) usarem el tipus INPUT_GET . El filtre FILTER_SANITIZE_STRING elimina etiquetes, i opcionalment elimina o codifica caracters especials. $nom = filter_input ( INPUT_GET , 'nom' , FILTER_SANITIZE_STRING ) . // $nom = Homer M\u00e9s informaci\u00f3 en: filter_var filter_input Comprovar la data Per a comprovar la data hem de crear una funci\u00f3 a aquest efecte. Podem utilitzar el m\u00e8tode est\u00e0tic createFromFormat de la classe DateTime M\u00e9s informaci\u00f3: http://php.net/manual/es/datetime.createfromformat.php Exemple $data1 = \"2001-05-02\" ; // Data \u00e9s de tipus string // DateTime::createFromFormat converteix una cadena de text a on objecte DateTime // ens tornar\u00e0 una inst\u00e0ncia de DateTime o FALSE en cas d'error. $dt1 = DateTime :: createFromFormat ( 'Y-m-d' , $data1 ); if ( $dt1 === false ) { echo \"La data d'inici \u00e9s incorrecta\" ; } https://www.php.net/manual/es/function.strtotime.php Tamb\u00e9 \u00e9s habitual trobar els controls de data separats en 3 elements input. Un per a l\u2019any, l\u2019altre per a mes i l\u2019altre per al dia. Bones pr\u00e0ctiques en l\u2019obtenci\u00f3 de dades des de l\u2019exterior Cal seguir les seg\u00fcents bones pr\u00e0ctiques: No confieu mai (mai) en l\u2019entrada des de l\u2019exterior del vostre PHP. Sanegeu i valideu l\u2019entrada de dades sempre. Les funcions filter_var() i filter_input() poden sanejar el text i validar els formats de text (per exemple, adreces de correu electr\u00f2nic, enters). Recordeu que l\u2019entrada de dades no es limita a formularis enviats per l\u2019usuari. Els fitxers carregats i descarregats, els valors de sessi\u00f3, les dades de galetes i les dades de serveis web de tercers tamb\u00e9 s\u00f3n dades que venen de l'exterior. A mode de resum pod\u00edem resumir la gesti\u00f3 de formularis en el seg\u00fcent diagrama de flux. En els seg\u00fcents recursos trobar\u00e0s informaci\u00f3 addicional sobre els controls de formularis en HTML5: Formularios en HTML en MDN web docs. Formularios en HTML5 en MDN web docs. HTML Forms en W3CSchools. Pujada de fitxers Per a pujar fitxers PHP implementa un mecanisme senzill a trav\u00e9s de la variable superglobal $_FILES . En Pujada d'arxius disposeu de tota la informaci\u00f3 necess\u00e0ria per a gestionar la pujada d'arxius. Formulari Per poder utilitzar el tipus file en l'element input cal que el formulari incloga l'atribut enctype amb el valor multipart/form-data . El valor de l'atribut name de l'element input ser\u00e0 l'\u00edndex de l'array associatiu $_FILES que ens permetr\u00e0 obtenir tota la informaci\u00f3 del proc\u00e9s de pujada del fitxer. En el seg\u00fcent exemple: < form action = \"upload.php\" enctype = \"multipart/form-data\" method = \"POST\" > < input type = \"hidden\" name = \"MAX_FILE_SIZE\" value = \"10240\" > < input type = \"file\" name = \"image\" /> < input type = \"submit\" value = \"Upload\" /> </ form > Emprarem $_FILES['image'] per obtenir les dades de l'arxiu penjat. Variable superglobal $_FILES Cada element en $_FILES \u00e9s un array que aporta informaci\u00f3 sobre el fitxer pujat. Les claus m\u00e9s importants s\u00f3n: name . El nom original del fitxer pujat. No \u00e9s massa \u00fatil perqu\u00e8 el sistema original pot tindre convencions diferents i pot generar col\u00b7lisions si l'utilitzem per a emmagatzemar-lo en la seua ubicaci\u00f3 definitiva. type . El tipus MIME del fitxer dedu\u00eft pel navegador. size . La grand\u00e0ria en bytes del fitxer. Si el fitxer \u00e9s massa gran el valor enviat ser\u00e0 0. tmp_name . El nom temporal del fitxer en el servidor on s'ha emmagatzemat el fitxer pujat. Moure el fitxer Com que el fitxer pujat es guarda en una carpeta temporal hem d'emprar la funci\u00f3 move_uploaded_file per a guardar-lo en la ubicaci\u00f3 definitiva. La funci\u00f3 is_uploaded_file ens permet a assegurar-nos que el fitxer ha estat pujat usant HTTP POST i no es tracta d'un fitxer malici\u00f3s. move_uploaded_file ja fa eixa comprovaci\u00f3 en executar-se. Gesti\u00f3 d'errors PHP torna un codi d'error en $_FILES . El codi es pot trabar en la clau error . Per exemple: $_FILES['image']['error'] . Els missates d'error m\u00e9s importants s\u00f3n: UPLOAD_ERR_OK : La pujada ha sigut correcta. UPLOAD_ERR_INI_SIZE : La grand\u00e0ria del fitxer que s'intenta pujar \u00e9s major que el valor indicat en la directiva upload_max_filesize . UPLOAD_ERR_FORM_SIZE : La grand\u00e0ria del fitxer que s'intenta pujar \u00e9s major que el valor indicat en el formulari en max_file_size . UPLOAD_ERR_NO_FILE : No s'ha enviat cap fitxer. En Explicaci\u00f3 dels missatges d'error teniu m\u00e9s informaci\u00f3.","title":"Processament de formularis"},{"location":"04-web-programming/assets/04-01-forms/#processament-de-formularis","text":"Fins ara ens hem centrat a con\u00e8ixer les caracter\u00edstiques del llenguatge PHP. En aquesta unitat posarem el focus en les caracter\u00edstiques pr\u00f2pies de les aplicacions web i com podem gestionar-les amb PHP. Aix\u00ed, veurem com enviar informaci\u00f3 mitjan\u00e7ant formularis, com processar-la i com podem mantenir informaci\u00f3 entre sol\u00b7licituds, \u00e9s a dir, mantenir l'estat.","title":"Processament de formularis"},{"location":"04-web-programming/assets/04-01-forms/#variables-predefinides","text":"Les variables predefinides s\u00f3n variables internes de PHP que poden usar-se des de qualsevol \u00e0mbit, per aix\u00f2 s'anomenen variables superglobals . Es tracta d' arrays associatius que contenen un conjunt de valors. $_SERVER . Cont\u00e9 informaci\u00f3 sobre l'entorn del servidor web i d'execuci\u00f3. $_GET, $_POST i $_COOKIE contenen les variables que s'han passat al script actual utilitzant, respectivament, els m\u00e8todes GET (par\u00e0metres en la URL), HTTP POST i Cookies HTTP $_REQUEST junta en un solament el contingut dels tres *arrays anteriors, $_GET , $_POST i $_COOKIE . $_ENV cont\u00e9 les variables que es puguen haver passat a PHP des de l'entorn en qu\u00e8 s'executa. $_FILES cont\u00e9 els fitxers que es puguen haver pujat al servidor utilitzant el m\u00e8tode POST. $_SESSION cont\u00e9 les variables de sessi\u00f3 disponibles per al gui\u00f3 actual. http://es.php.net/manual/es/language.variables.superglobals.php","title":"Variables predefinides"},{"location":"04-web-programming/assets/04-01-forms/#que-es-una-peticio-http","text":"Una petici\u00f3 HTTP \u00e9s una sol\u00b7licitud d'un recurs a un servidor. La petici\u00f3 es realitza a trav\u00e9s d'unes URL. Amb la petici\u00f3 s'envien tamb\u00e9 par\u00e0metres. Hi ha diferents m\u00e8todes ( METHOD ) per a realitzar una petici\u00f3 ( GET , POST , PUT , DELETE , PATCH , etc.). Els m\u00e9s habituals s\u00f3n GET , que ja coneixes, i POST . La resta s\u00f3n m\u00e9s utilitzats en les RESTful API.","title":"Qu\u00e8 \u00e9s una petici\u00f3 HTTP?"},{"location":"04-web-programming/assets/04-01-forms/#metode-get","text":"El m\u00e8todo de sol\u00b7licitud GET t\u00e9 les seg\u00fcents caracter\u00edstiques: S'utilitza per a sol\u00b7licitar dades d'un recurs. Mostren els par\u00e0metres que s'envien en la url. Es poden utilitzar directament en enlla\u00e7os. El resultat es pot emmagatzemar en cache. Romanen en l'historial del navegador. La grand\u00e0ria dels par\u00e0metres est\u00e0 limitat a 2048 car\u00e0cters. Exemple de petici\u00f3 GET Inspecci\u00f3 de la petici\u00f3 Inspecci\u00f3 de la petici\u00f3","title":"M\u00e8tode GET"},{"location":"04-web-programming/assets/04-01-forms/#definicio-de-formularis","text":"Com hem dit abans el m\u00e8tode POST s'empra en els formularis. El formulari seg\u00fcent enviar\u00e0 les dades a la p\u00e0gina index.php (atribut action de l'element form ). Utilitza el m\u00e8tode post indicat en l'atribut method : < form action = \"index.php\" method = \"post\" > < label for = \"nom\" > Nom </ label > < input type = \"text\" name = \"nom\" value = \"\" > < br /> < label for = \"cognom\" > Cognom </ label > < input type = \"text\" name = \"cognom\" value = \"\" > < br /> < input type = \"submit\" value = \"Enviar\" > </ form > Inspecci\u00f3 de la petici\u00f3: Headers Inspecci\u00f3 de la petici\u00f3: Param\u00e8tres","title":"Definici\u00f3 de formularis"},{"location":"04-web-programming/assets/04-01-forms/#accedir-a-les-dades-de-la-peticio-post","text":"Usem la variable superglobal $_POST . Funciona igual que $_GET , per\u00f2 amb els noms (atribut name ) que li hem donat als camps del formulari. En depuraci\u00f3 podem mostar totes les dades rebudes: var_dump ( $_POST ); print_r ( $_POST ) Per a mostrar les dades individualment: echo $_POST [ 'nom' ]; echo $_POST [ 'cognom' ];","title":"Accedir a les dades de la petici\u00f3 POST"},{"location":"04-web-programming/assets/04-01-forms/#validacio-de-formularis","text":"Hem de comprovar que les dades que envia el formulari s\u00f3n correctes. Les validacions a realitzar s\u00f3n les seg\u00fcents: Els camps requerits no han de quedar buits. Ni contenir espais en blanc a l'inici i al final. Els camps email i data han de tenir el format esperat. Tots els camps s'han de filtrar amb htmlspecialchars per a evitar atacs de Cross-site Scripting (XSS). Aquest article sobre Cross-site Scripting \u00e9s molt il\u00b7lustratiu: PHP Form Validation","title":"Validaci\u00f3 de formularis"},{"location":"04-web-programming/assets/04-01-forms/#comprovar-la-data","text":"Per a comprovar la data hem de crear una funci\u00f3 a aquest efecte. Podem utilitzar el m\u00e8tode est\u00e0tic createFromFormat de la classe DateTime M\u00e9s informaci\u00f3: http://php.net/manual/es/datetime.createfromformat.php","title":"Comprovar la data"},{"location":"04-web-programming/assets/04-01-forms/#bones-practiques-en-lobtencio-de-dades-des-de-lexterior","text":"Cal seguir les seg\u00fcents bones pr\u00e0ctiques: No confieu mai (mai) en l\u2019entrada des de l\u2019exterior del vostre PHP. Sanegeu i valideu l\u2019entrada de dades sempre. Les funcions filter_var() i filter_input() poden sanejar el text i validar els formats de text (per exemple, adreces de correu electr\u00f2nic, enters). Recordeu que l\u2019entrada de dades no es limita a formularis enviats per l\u2019usuari. Els fitxers carregats i descarregats, els valors de sessi\u00f3, les dades de galetes i les dades de serveis web de tercers tamb\u00e9 s\u00f3n dades que venen de l'exterior. A mode de resum pod\u00edem resumir la gesti\u00f3 de formularis en el seg\u00fcent diagrama de flux. En els seg\u00fcents recursos trobar\u00e0s informaci\u00f3 addicional sobre els controls de formularis en HTML5: Formularios en HTML en MDN web docs. Formularios en HTML5 en MDN web docs. HTML Forms en W3CSchools.","title":"Bones pr\u00e0ctiques en l\u2019obtenci\u00f3 de dades des de l\u2019exterior"},{"location":"04-web-programming/assets/04-01-forms/#pujada-de-fitxers","text":"Per a pujar fitxers PHP implementa un mecanisme senzill a trav\u00e9s de la variable superglobal $_FILES . En Pujada d'arxius disposeu de tota la informaci\u00f3 necess\u00e0ria per a gestionar la pujada d'arxius.","title":"Pujada de fitxers"},{"location":"04-web-programming/assets/04-01-forms/#formulari","text":"Per poder utilitzar el tipus file en l'element input cal que el formulari incloga l'atribut enctype amb el valor multipart/form-data . El valor de l'atribut name de l'element input ser\u00e0 l'\u00edndex de l'array associatiu $_FILES que ens permetr\u00e0 obtenir tota la informaci\u00f3 del proc\u00e9s de pujada del fitxer. En el seg\u00fcent exemple: < form action = \"upload.php\" enctype = \"multipart/form-data\" method = \"POST\" > < input type = \"hidden\" name = \"MAX_FILE_SIZE\" value = \"10240\" > < input type = \"file\" name = \"image\" /> < input type = \"submit\" value = \"Upload\" /> </ form > Emprarem $_FILES['image'] per obtenir les dades de l'arxiu penjat.","title":"Formulari"},{"location":"04-web-programming/assets/04-01-forms/#variable-superglobal-_files","text":"Cada element en $_FILES \u00e9s un array que aporta informaci\u00f3 sobre el fitxer pujat. Les claus m\u00e9s importants s\u00f3n: name . El nom original del fitxer pujat. No \u00e9s massa \u00fatil perqu\u00e8 el sistema original pot tindre convencions diferents i pot generar col\u00b7lisions si l'utilitzem per a emmagatzemar-lo en la seua ubicaci\u00f3 definitiva. type . El tipus MIME del fitxer dedu\u00eft pel navegador. size . La grand\u00e0ria en bytes del fitxer. Si el fitxer \u00e9s massa gran el valor enviat ser\u00e0 0. tmp_name . El nom temporal del fitxer en el servidor on s'ha emmagatzemat el fitxer pujat.","title":"Variable superglobal $_FILES"},{"location":"04-web-programming/assets/04-01-forms/#moure-el-fitxer","text":"Com que el fitxer pujat es guarda en una carpeta temporal hem d'emprar la funci\u00f3 move_uploaded_file per a guardar-lo en la ubicaci\u00f3 definitiva. La funci\u00f3 is_uploaded_file ens permet a assegurar-nos que el fitxer ha estat pujat usant HTTP POST i no es tracta d'un fitxer malici\u00f3s. move_uploaded_file ja fa eixa comprovaci\u00f3 en executar-se.","title":"Moure el fitxer"},{"location":"04-web-programming/assets/04-01-forms/#gestio-derrors","text":"PHP torna un codi d'error en $_FILES . El codi es pot trabar en la clau error . Per exemple: $_FILES['image']['error'] . Els missates d'error m\u00e9s importants s\u00f3n: UPLOAD_ERR_OK : La pujada ha sigut correcta. UPLOAD_ERR_INI_SIZE : La grand\u00e0ria del fitxer que s'intenta pujar \u00e9s major que el valor indicat en la directiva upload_max_filesize . UPLOAD_ERR_FORM_SIZE : La grand\u00e0ria del fitxer que s'intenta pujar \u00e9s major que el valor indicat en el formulari en max_file_size . UPLOAD_ERR_NO_FILE : No s'ha enviat cap fitxer. En Explicaci\u00f3 dels missatges d'error teniu m\u00e9s informaci\u00f3.","title":"Gesti\u00f3 d'errors"},{"location":"05-data-access/0500-intro/","text":"Acc\u00e9s a dades Duraci\u00f3: 16 hores Objectius Establir connexions amb la base de dades des de PHP Executar sent\u00e8ncies SQL utilitzant PDO. Fer consultes preparades. Obtenir registres afectats o retornats per una sent\u00e8ncia SQL. Gestionar errors i excepcions que es produ\u00efsquen durant la connexi\u00f3 o establiment de la mateixa aix\u00ed com en l\u2019execuci\u00f3 del codi del nostre projecte. Emprar transaccions per a assegurar la integritat de la BD. Configurar i administrar b\u00e0sicament PhpMyAdmin. Con\u00e9ixer el llenguatge SQL. Continguts conceptuals Maneig de PhpMyAdmin Creaci\u00f3 de Bases de dades Creaci\u00f3 de taules i relacions Manipulaci\u00f3 de dades Importaci\u00f3 i exportaci\u00f3 de dades Gesti\u00f3 d\u2019usuaris Acc\u00e9s a la base de dades mitjan\u00e7ant PHP amb la llibreria PDO Connexi\u00f3 a la base de dades Execuci\u00f3 de consultes Mostrar dades din\u00e0miques Inserci\u00f3, modificaci\u00f3 i eliminaci\u00f3 de dades de la BBDD Altres m\u00e8todes interessants. LastInsertId() quote() rowCount() Gesti\u00f3 d\u2019errors en l\u2019acc\u00e9s Continguts procedimentals Creaci\u00f3 de la base de dades, taules i relacions amb PhpMyAdmin. Creaci\u00f3 i \u00fas de l\u2019arxiu de configuraci\u00f3 de la base de dades per establir connexi\u00f3 amb la base de dades. Creaci\u00f3 de consultes preparades mitjan\u00e7ant el m\u00e8tode prepare. Criteris d\u2019avaluaci\u00f3 RA06. A) S\u2019han analitzat les tecnologies que permeten l\u2019acc\u00e9s mitjan\u00e7ant programaci\u00f3 a la informaci\u00f3 disponible en magatzems de dades. RA06. B) S\u2019han creat aplicacions que establisquen connexions amb bases de dades. RA06. C) S\u2019ha recuperat informaci\u00f3 emmagatzemada en bases de dades. RA06. D )S\u2019ha publicat en aplicacions web la informaci\u00f3 recuperada. RA06. E) S\u2019han utilitzat conjunts de dades per a emmagatzemar la informaci\u00f3. RA06. F) S\u2019han creat aplicacions web que permeten l\u2019actualitzaci\u00f3 i l\u2019eliminaci\u00f3 d\u2019informaci\u00f3 disponible en una base de dades. RA06. G) S\u2019han utilitzat transaccions per a mantenir la consist\u00e8ncia de la informaci\u00f3. RA06. H) S\u2019han provat i documentat les aplicacions.","title":"Introducci\u00f3"},{"location":"05-data-access/0500-intro/#acces-a-dades","text":"Duraci\u00f3: 16 hores Objectius Establir connexions amb la base de dades des de PHP Executar sent\u00e8ncies SQL utilitzant PDO. Fer consultes preparades. Obtenir registres afectats o retornats per una sent\u00e8ncia SQL. Gestionar errors i excepcions que es produ\u00efsquen durant la connexi\u00f3 o establiment de la mateixa aix\u00ed com en l\u2019execuci\u00f3 del codi del nostre projecte. Emprar transaccions per a assegurar la integritat de la BD. Configurar i administrar b\u00e0sicament PhpMyAdmin. Con\u00e9ixer el llenguatge SQL. Continguts conceptuals Maneig de PhpMyAdmin Creaci\u00f3 de Bases de dades Creaci\u00f3 de taules i relacions Manipulaci\u00f3 de dades Importaci\u00f3 i exportaci\u00f3 de dades Gesti\u00f3 d\u2019usuaris Acc\u00e9s a la base de dades mitjan\u00e7ant PHP amb la llibreria PDO Connexi\u00f3 a la base de dades Execuci\u00f3 de consultes Mostrar dades din\u00e0miques Inserci\u00f3, modificaci\u00f3 i eliminaci\u00f3 de dades de la BBDD Altres m\u00e8todes interessants. LastInsertId() quote() rowCount() Gesti\u00f3 d\u2019errors en l\u2019acc\u00e9s Continguts procedimentals Creaci\u00f3 de la base de dades, taules i relacions amb PhpMyAdmin. Creaci\u00f3 i \u00fas de l\u2019arxiu de configuraci\u00f3 de la base de dades per establir connexi\u00f3 amb la base de dades. Creaci\u00f3 de consultes preparades mitjan\u00e7ant el m\u00e8tode prepare. Criteris d\u2019avaluaci\u00f3 RA06. A) S\u2019han analitzat les tecnologies que permeten l\u2019acc\u00e9s mitjan\u00e7ant programaci\u00f3 a la informaci\u00f3 disponible en magatzems de dades. RA06. B) S\u2019han creat aplicacions que establisquen connexions amb bases de dades. RA06. C) S\u2019ha recuperat informaci\u00f3 emmagatzemada en bases de dades. RA06. D )S\u2019ha publicat en aplicacions web la informaci\u00f3 recuperada. RA06. E) S\u2019han utilitzat conjunts de dades per a emmagatzemar la informaci\u00f3. RA06. F) S\u2019han creat aplicacions web que permeten l\u2019actualitzaci\u00f3 i l\u2019eliminaci\u00f3 d\u2019informaci\u00f3 disponible en una base de dades. RA06. G) S\u2019han utilitzat transaccions per a mantenir la consist\u00e8ncia de la informaci\u00f3. RA06. H) S\u2019han provat i documentat les aplicacions.","title":"Acc\u00e9s a dades"},{"location":"05-data-access/0501-data-access/","text":"Acc\u00e9s a dades mitjan\u00e7ant PHP PDO PHP permet treballar en base de dades MySQL gr\u00e0cies a dues llibreries. MySQLi i PDO. Com que MySQLi est\u00e0 dissenyada exclusivament per a MySQL nosaltres aprofundirem en PDO, que permet connectar fins amb 12 sistemes gestors de base de dades diferents. Les sigles PDO ( PHP Data Objects ) fan refer\u00e8ncia a una interf\u00edcie de PHP que ens permet accedir a bases de dades de qualsevol tipus en PHP. Cada controlador de bases de dades que implemente la interf\u00edcie PDO pot exposar caracter\u00edstiques espec\u00edfiques de la base de dades, com les funcions habituals de l'extensi\u00f3. Un controlador per SGDB Cal observar que no es pot realitzar cap de les funcions de la bases de dades utilitzant l'extensi\u00f3 PDO per si mateixa; s'ha d'utilitzar-ne una de PDO espec\u00edfica de la base de dades per tenir acc\u00e9s a un servidor de base de dades. Capes PDO PDO proporciona una capa d'abstracci\u00f3 d'acc\u00e9s a dades, el que significa que, independentment de la base de dades que s'estiga utilitzant, s'usen les mateixes funcions per fer consultes i obtenir dades. Per saber els controladors PDO disponibles en el nostre sistema: print_r ( PDO :: getAvailableDrivers ()); La informaci\u00f3 oficial sobre PDO es troba en http://php.net/manual/es/book.pdo.php Classes PDO, PDOStatement i PDOException PDO proporciona 3 classes per a gestionar l'acc\u00e9s a la base de dades PDO : S'utilitza per representar la connexi\u00f3 entre PHP i un servidor de bases de dades. PDOStatement : representa una sent\u00e8ncia preparada i tamb\u00e9 ens permet accedir al conjunt de resultats associat. PDOException : representa els errors generats PDO. Connexi\u00f3 a la base de dades Per a crear una nova connexi\u00f3 s'utilitza la classe PDO : public __construct ( string $dsn [, string $username [, string $passwd [, array $options ]]] ) El constructor t\u00e9 els seg\u00fcents par\u00e0metres: dsn : cadena de connexi\u00f3 username : nom d'usuari passwd : contrasenya d'usuari options : permet afegir altres opcions de la connexi\u00f3 $pdo = new PDO ( \"mysql:host=localhost; dbname=test\" , \"dbuser\" , \"1234\" ); En l'exemple anterior mysql representa una connexi\u00f3 a una base de dades MySQL ( podria ser: MSSQL, Sybase, sqlite, etc.) anomenada test que es troba al servidor localhost . La connexi\u00f3 es realitzar\u00e0 mitjan\u00e7ant l'usuari dbuser i la contrasenya 1234 . // Exemple de connexi\u00f3 a diferents tipus de bases de dades. # Connectem a la base de dades $host = 'www.local' ; $hbname = 'cxbasex' ; $user = 'cxbasex' ; $pass = 'xxxxxx' ; try { # MS SQL Server y Sybase amb PDO_DBLIB $pdo = new PDO ( \"MSSQL:host= $host ;dbname= $dbname , $user , $pass \" ); $pdo = new PDO ( \"Sybase:host= $host ;dbname= $dbname , $user , $pass \" ); /* MySQL amb PDO_MYSQL Perqu\u00e8 la connexi\u00f3 a mysql utilitzi les collation UTF-8 afegir charset = utf8 a string de la connexi\u00f3. */ $pdo = new PDO ( \"mysql:host= $host ;dbname= $dbname ;charset=utf8\" , $user , $pass ); // Perqu\u00e8 generi excepcions a l'hora de reportar errors. $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); # SQLite Database $pdo = new PDO ( \"sqlite:my/database/path/database.db\" ); } catch ( PDOException $e ) { die ( $e -> getMessage ()); } // Si tot va b\u00e9 en $pdo tindrem el objecte que gestionar\u00e0 la connexi\u00f3 amb la base de dades. Tancar la connexi\u00f3 a la base de dades Es recomana tancar sempre la connexi\u00f3 a la base de dades quan no es vaja a utilitzar m\u00e9s durant el nostre proc\u00e9s. Cal recordar que els recursos s\u00f3n limitats i quan hi ha pocs usuaris no hi ha cap problema, per\u00f2 si tenim molts usuaris simultanis llavors \u00e9s quan sorgeixen problemes en haver assolit el nombre m\u00e0xim de connexions amb el servidor, per exemple. En tancar la connexi\u00f3 de forma expl\u00edcita accelerem l'alliberament de recursos perqu\u00e8 estiguin disponibles per a altres usuaris. // Si vullguerem tancar la connexi\u00f3 amb la base de dades simplement podr\u00edem fer al final del fitxer. $pdo = null ; Execuci\u00f3 de consultes Per a realitzar consultes PDO proporciona tres m\u00e8todes: PDO::query() per a consultes de recuperaci\u00f3 de dades (SELECT). PDO::exec() per a consultes d'inserci\u00f3, modificaci\u00f3 i esborrat de dades (INSERT, UPDATE i DELETE) PDO::prepare() per a consultes de tot tipus amb par\u00e0metres. Aquest \u00e9s el m\u00e8tode recomanat si la consulta t\u00e9 par\u00e0metres o si s'ha d'executar divereses vegades per\u00f2 aix\u00f2 hem dedicat un apartat espec\u00edfic. Una vegada executada la consulta les dades s'obtenen a trav\u00e9s del m\u00e8tode PDOStatement::fetch() o PDOStatement::fetchAll() . fetch() : Obt\u00e9 la seg\u00fcent fila d'un recordset (conjunt de resultats). http://php.net/manual/es/pdostatement.fetch.php fetchAll() : Retorna un array que cont\u00e9 totes les files del conjunt de resultats (el tipus de dades a retornar es pot indicar com a par\u00e0metre). http://php.net/manual/es/pdostatement.fetchall.php Estil de b\u00fasqueda ( fetch style ) Abans de cridar al m\u00e8tode fetch() una bona idea \u00e9s indicar-li com volem que ens torne les dades de la base de dades. Tindrem les seg\u00fcents opcions en el m\u00e8tode fetch() : PDO::FETCH_ASSOC : Torna les dades en un array associatiu pel nom de camp de la taula. PDO::FETCH_NUM : Retorna un array indexat per la posici\u00f3 del camp. PDO::FETCH_BOTH : Retorna un array associatiu pel nom de camp de la taula i un indexat per la posici\u00f3 del camp. \u00c9s una combinaci\u00f3 dels dos estils anteriors. \u00c9s l'estil per defecte. PDO::FETCH_BOUND : Assigna els valors retornats a les variables assignades amb el m\u00e8tode bindColumn() . PDO::FETCH_CLASS : Assigna els valors dels camps a les propietats d'una classe. Si les propietats no existeixen en aquesta classe, les crear\u00e0. PDO::FETCH_INTO : Actualitza una inst\u00e0ncia existent d'una classe. PDO::FETCH_LAZY : Combina PDO::FETCH_BOTH / PDO::FETCH_OBJ , creant les variables de l'objecte a mesura que es van fent servir. PDO::FETCH_OBJ : Retorna un objecte an\u00f2nim amb els noms de les propietats que es corresponen amb els noms de columnes. Podem ajustar l'estil de b\u00fasqueda de dues formes: Abans de recuperar registres: $stmt -> setFetchMode ( PDO :: FETCH_ASSOC ); En el moment de recuperar-los: $stmt -> fetch ( PDO :: FETCH_ASSOC ); $stmt -> fechtall ( PDO :: FETCH_ASSOC ); PDO::FETCH_CLASS Cal saber que no podem usar PDO::FETCH_CLASS com a par\u00e0metre de PDOStatement::fetch() . Cal controlar l'estil de b\u00fasqueda amb PDOStatement::setFetchMode() . Array associatiu FETCH_ASSOC Per executar la consulta SELECT si no tenim par\u00e0metres en la consulta podrem usar PDO::query() Vegem un exemple de consulta SELECT: try { #Per executar la consulta SELECT si no tenim par\u00e0metres en la consulta podrem usar -> query () $stmt = $pdo -> query ( \"SELECT name, addr, city from colleague\" ); /* Indiquem en quin format volem obtenir les dades de la taula en format d'array associatiu. Si no indiquem res per defecte s'usar\u00e0 FETCH_BOTH el que ens permetr\u00e0 accedir com a vector associatiu o array num\u00e8ric. */ $stmt -> setFetchMode ( PDO :: FETCH_ASSOC ); #Llegim les dades del recordset amb el m\u00e8tode->fetch () while ( $row = $stmt -> fetch ()) { echo $row [ 'name' ] . \"<br/>\" ; echo $row [ 'addr' ] . \"<br/>\" ; echo $row [ 'city' ] . \"<br/>\" ; } #Per alliberar els recursos utilitzats en la consulta SELECT $stmt = null ; } catch ( PDOException $err ) { // Mostrem un missatge gen\u00e8ric d'error. echo \"Error: executant consulta SQL.\" ; } Objecte ( FETCH_OBJ ) En aquest estil de b\u00fasqueda es crear\u00e0 un objecte est\u00e0ndard ( stdClass ) per cada fila que llegim del recordset. Per exemple: try { #Creem la consulta $stmt = $pdo -> query ( 'SELECT name, addr, city from colleague' ); #Ajustem la manera d'obtenci\u00f3 de dades $stmt -> setFetchMode ( PDO :: FETCH_OBJ ); #Mostrem els resultats. #Fixeu-vos que es torna un objecte cada vegada que es llegeix una fila del recordset. while ( $row = $stmt -> fetch ()) { echo $row -> name . \"<br/>\" ; echo $row -> addr . \"<br/>\" ; echo $row -> city . \"<br/>\" ; } #Alliberem els recursos utilitzats per $stmt $stmt = null ; } catch ( PDOException $err ) { // Mostrem un missatge gen\u00e8ric d'error. echo \"Error: executant consulta SQL.\" ; } Classe ( FETCH_CLASS ) En aquest estil de b\u00fasqueda els registres es tornaran en una nova inst\u00e0ncia de la classe indicada en el segon par\u00e0metre, fent correspondre les columnes del conjunt de resultats amb els noms de les propietats de la classe, i cridant al constructor despr\u00e9s, a menys que tambi\u00e9n es proporcione l'opci\u00f3 PDO::FETCH_PROPS_LATE . Si algun nom de camp no existeix com a propietat en la classe es crear\u00e0 din\u00e0micament. class Persona { private $name ; public function __construct () { $this -> decir (); } public function decir () { if ( isset ( $this -> name )) { echo \"Soy { $this -> name } . \\n \" ; } else { echo \"A\u00fan no tengo nombre. \\n \" ; } } } $sth = $dbh -> query ( \"SELECT * FROM people\" ); $sth -> setFetchMode ( PDO :: FETCH_CLASS , 'Persona' ); $persona = $sth -> fetch (); $persona -> decir (); $sth -> setFetchMode ( PDO :: FETCH_CLASS | PDO :: FETCH_PROPS_LATE , 'Persona' ); $persona = $sth -> fetch (); $persona -> decir (); Mostrar\u00e0: Soy Alice. Soy Alice. A\u00fan no tengo nombre. Soy Bob. Consultes preparades Com hem vist en l'apartat anterior les consultes poden acceptar par\u00e0metres. La millor forma de realitzar aquestes consultes \u00e9s mitjan\u00e7ant les consultes preparades . Les consultes preparades ens aporten dues avantatges importants: Per a sent\u00e8ncies que seran executades en m\u00faltiples ocasions amb diferents par\u00e0metres optimitza el rendiment de la aplicaci\u00f3. Ajuda a prevenir injeccions SQL eliminant la necessitat de posar entre cometes manualment els par\u00e0metres. Per a construir una sent\u00e8ncia preparada cal incloure uns marcadors en la sent\u00e8ncia SQL. Hi ha tres formes de fer-ho: # Marcadors an\u00f2nims $stmt = $pdo -> prepare ( \"INSERT INTO colleague (name, addr, city) values (?, ?, ?)\" ); # Marcadors coneguts $stmt = $pdo -> prepare ( \"INSERT INTO colleague (name, addr, city) values (:name, :addr, :city)\" ); # Sense marcadors. Aquest m\u00e8tode est\u00e0 desaconsellat! Prohibit en el nostre cas. $stmt = $pdo -> prepare ( \"INSERT INTO colleague (name, addr, city) values ( $name , $addr , $city )\" ); Haur\u00e0s d'usar el primer o el segon m\u00e8tode dels que es mostren anteriorment. El tipus de marcadors que utilitzem afectaran a la forma d'assignar els valors d'eixos marcadors. Assignaci\u00f3 amb marcadors an\u00f2nims Per enlla\u00e7ar els marcadors an\u00f2nims amb el seu corresponent valor es pot utilitzar bindParam o bindValue : Marcadors an\u00f2nims $pdo->prepare() usant marcadors an\u00f2nims ? , tracta totes les variables com si foren string , per la qual cosa far\u00e0 servir cometes per delimitar els seus valors per defecte. # Marcadors an\u00f2nims $stmt = $pdo -> prepare ( \"INSERT INTO colleague (name, addr, city) values (?, ?, ?)\" ); # Assignem variables a cada marcador, indexats l'1 al 3 $stmt -> bindParam ( 1 , $name ); $stmt -> bindParam ( 2 , $addr ); $stmt -> bindParam ( 3 , $city ); # Inserim una fila. $name = \"Daniel\" ; $addr = \"1 Wicked Way\" ; $city = \"Arlington Heights\" ; $stmt -> execute (); # Inserim un altra fila con valores diferents. $name = \"Steve\" $addr = \"5 Circle Drive\" ; $city = \"Schaumburg\" ; $stmt -> execute (); Un altra forma d'assignaci\u00f3 amb marcadors an\u00f2nims \u00e9s mitjan\u00e7ant un array associatiu: # Les dades que volem inserir $dades = [ 'Cathy' , '9 Dark and Twisty Road' , 'Cardiff' ]; $stmt = $pdo -> prepare ( \"INSERT INTO colleague (name, addr, city) values (?, ?, ?)\" ); $stmt -> execute ( $dades ); Difer\u00e8ncia entre l'\u00fas de bindParam i bindValue Amb bindParam es vincula la variable al par\u00e0metre i en el moment de fer l' execute \u00e9s quan s'assigna realment el valor de la variable a aquest par\u00e0metre. Amb bindValue s'assigna el valor de la variable a aquest par\u00e0metre just en el moment d'executar la instrucci\u00f3 bindValue . Exemple de difer\u00e8ncia entre bindParam i bindValue : // Ejemplo con bindParam: $sex = 'hombre' ; $s = $dbh -> prepare ( 'SELECT name FROM estudiantes WHERE sexo = :sexo' ); $s -> bindParam ( ':sexo' , $sex ); $sex = 'mujer' ; $s -> execute (); // se ejecut\u00f3 con el valor WHERE sexo = 'mujer' // El mismo ejemplo con bindValue: $sex = 'hombre' ; $s = $dbh -> prepare ( 'SELECT name FROM students WHERE sexo = :sexo' ); $s -> bindValue ( ':sexo' , $sex ); $sex = 'mujer' ; $s -> execute (); // se ejecut\u00f3 con el valor WHERE sexo = 'hombre' Assignaci\u00f3 amb marcadors coneguts Els marcadors coneguts s\u00f3n la forma m\u00e9s recomanable de treballar amb PDO, ja que a l'hora de fer el bindParam o el bindValue es pot especificar el tipus de dada i la seua longitud. Format de bindParam amb marcadors coneguts: bindParam ( ':marcador' , $variableVincular , TIPO DATOS PDO ) Exemple d'\u00fas de bindParam : $stmt -> bindParam ( ':calorias' , $misCalorias , PDO :: PARAM_INT ); $stmt -> bindParam ( ':apellidos' , $misApellidos , PDO :: PARAM_STR , 35 ); // 35 caracteres como m\u00e1ximo. Amb marcadors coneguts quedaria de la seg\u00fcent forma: $stmt = $pdo -> prepare ( \"INSERT INTO colleague (name, addr, city) value (:name, :addr, :city)\" ); # El primer argument de bindParam \u00e9s el nom del marcador i el segon la variable # que contindr\u00e0 les dades. # Els marcadors conocidos siempre comienzan con : $stmt -> bindParam ( ':name' , $name ); $name = 'Pepito' ; $stmt -> bindParam ( ':addr' , $addr ); $addr = 'Duanes, 17' ; $stmt -> bindParam ( ':city' , $city ); $city = 'Pego' ; $stmt -> execute (); # Tamb\u00e9 podem fer-ho mitjan\u00e7ant un array associatiu $dades = [ 'name' => 'Pepito' , 'addr' => 'Duanes, 17' , 'city' => 'Pego' ); # Fixeu-vos es passa l'array de dades en execute(). $stmt = $pdo -> prepare ( \"INSERT INTO colleague (name, addr, city) value (:name, :addr, :city)\" ); $stmt -> execute ( $dades ); # La \u00faltima instrucci\u00f3n se podr\u00eda poner tambi\u00e9n as\u00ed: $stmt -> execute ([ 'name' => 'Pepito' , 'addr' => 'Duanes, 17' , 'city' => 'Pego' ]); Una altra caracter\u00edstica dels marcadors coneguts \u00e9s que ens permetran treballar amb objectes directament a la base de dades, assumint que les propietats d'aquest objecte coincideixen amb els noms dels camps de la taula a la base de dades. Exemple d'\u00fas de marcadors coneguts i objectes: # Un objeto sencillo class Person { public $name ; public $addr ; public $city ; function __construct ( $n , $a , $c ) { $this -> name = $n ; $this -> addr = $a ; $this -> city = $c ; } # etc ... } $cathy = new Person ( 'Pepito' , 'Duanes, 17' , 'Pego' ); # Preparaci\u00f3n de la consulta $stmt = $pdo -> prepare ( \"INSERT INTO colegas (name, addr, city) value (:name, :addr, :city)\" ); # Inserci\u00f3n del objeto $stmt -> execute (( array ) $cathy ); Exemple d'\u00fas Per a utilitzar les consultes preparades seguirem sempre aquest esquema: $pdo = new PDO ( 'sqlite:/path/db/users.db' ); # 1. Preparem la connexi\u00f3 $stmt = $pdo -> prepare ( 'SELECT name FROM users WHERE id = :id' ); $id = 5 ; # 2. Vinculem els par\u00e0metres $stmt -> bindParam ( ':id' , $id , PDO :: PARAM_INT ); # 3. Executem la consulta $stmt -> execute (); # 4. Obtenim els registres # Un a un $row = $stmt -> fetch (); # Tots a l'hora $rows = $stmt -> fetchAll (); Dates en MySQL Recorda que el tipus DATE de MySQL es recupera com un string en format \"YYYY-MM-DD\" i a l'hora d'emmagatzemar-lo cal que tinga el mateix format. Si f\u00f3ra DATETIME tamb\u00e9 caldria afegir l'hora \"YY-MM-DD hh:mm:ss\". Inserci\u00f3, modificaci\u00f3 i eliminaci\u00f3 de dades de la BBDD Inserir noves dades, actualitzar-les o esborrar-les s\u00f3n algunes de les operacions m\u00e9s comunes en una base de dades. Amb PDO podem fer aquestes aquestes operacions en 3 passos. Exemple d'\u00fas: # $stmt ser\u00e0 un objecte de tipus PDOStatement (consulta preparada) $stmt = $pdo -> prepare ( \"INSERT INTO colleague(name, addr, city) values (:name, :addr, :city)\" ); # Assignem els valors dels marcadors $name = \"Josep\" $addr = \"Duanes, 17\" $city = \"Pego\" $stmt -> BindValue ( \"name\" , $name ); $stmt -> BindValue ( \"addr\" , $addr ); $stmt -> BindValue ( \"city\" , $city ); # Executem la consulta amb ->execute() m\u00e8tode de l'objecte PDOStatement # Este m\u00e8tode devuelve true o false. $result = $stmt -> execute (); Exemples CRUD ( C reate, R ead, U pdate, D elete): INSERT, UPDATE y DELETE INSERT try { $pdo = new PDO ( \"mysql:host= $host ;dbname= $dbname ;charset=utf8\" , $username , $password ); $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); $stmt = $pdo -> prepare ( 'INSERT INTO colleague (name, addr, city ) VALUES(:name, :addr, :city)' ); $stmt -> execute ([ ':name' => 'Josep' , ':addr' => 'Duanes, 17' , ':city' => 'Pego' ]); # Affected Rows? echo $stmt -> rowCount (); // 1 } catch ( PDOException $e ) { echo 'Error: ' . $e -> getMessage (); } UPDATE $id = 5 ; $name = \"Joe the Plumber\" ; try { $pdo = new PDO ( \"mysql:host= $host ;dbname= $dbname ;charset=utf8\" , $username , $password ); $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); $stmt = $pdo -> prepare ( 'UPDATE someTable SET name = :name WHERE id = :id' ); $stmt -> execute ( array ( ':id' => $id , ':name' => $name )); echo $stmt -> rowCount (); // 1 } catch ( PDOException $e ) { echo 'Error: ' . $e -> getMessage (); } DELETE $id = 5 ; // From a form or something similar try { $pdo = new PDO ( \"mysql:host= $host ;dbname= $dbname ;charset=utf8\" , $username , $password ); $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); $stmt = $pdo -> prepare ( 'DELETE FROM someTable WHERE id = :id' ); $stmt -> bindParam ( ':id' , $id ); // this time, we'll use the bindParam method $stmt -> execute (); echo $stmt -> rowCount (); // 1 } catch ( PDOException $e ) { echo 'Error: ' . $e -> getMessage (); } Alguns m\u00e8todes d'inter\u00e8s Alguns m\u00e8todes interessant i que podem utilitzar per a millorar la gesti\u00f3 de l'acc\u00e9s a dades s\u00f3n: PDO::lastInsertId() , ens torna la clau prim\u00e0ria ( id ) del \u00faltim registre inserit en la base de dades. PDOStatement::rowCount() , ens torna el n\u00famero de files afectades por una sent\u00e8ncia DELETE, INSERT, o UPDATE. Gesti\u00f3 d'errors en l'acc\u00e9s PDO pot utilitzar les excepcions per gestionar els errors, el que significa que qualsevol cosa que fem amb PDO podr\u00edem encapsular en un bloc try/catch per gestionar si produeix algun error. Podem for\u00e7ar PDO perqu\u00e8 treballi en qualsevol de les tres maneres seg\u00fcents: PDO::ERRMODE_SILENT . \u00c9s el mode per defecte. Aqu\u00ed haurem de revisar els errors usant errorCode() i errorInfo() . PDO::ERRMODE_WARNING . Genera errors de revisi\u00f3 de resultats PHP per\u00f2 permetria l'execuci\u00f3 normal de l'aplicaci\u00f3. PDO::ERRMODE_EXCEPTION . Ser\u00e0 la forma m\u00e9s utilitzada en PDO. Dispara una excepci\u00f3 permetent-nos gestionar l'error de forma amigable. //Activaci\u00f3 de la manera de treball de PDO $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_SILENT ); $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_WARNING ); // Es recomana activar aquesta opci\u00f3 per gestionar els errors amb PDOException $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); Excepcions Es recomana activar aquesta opci\u00f3 per gestionar els errors amb PDOException , d'altra forma no apareixer\u00e0 cap missatge i ser\u00e0 complicat detectar-los. $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); Exemple d'\u00fas: # Connectem a la base de dades $host = 'www.local' ; $dbname = 'cxbasex' ; $user = 'cxbasex' ; $pass = 'xxxxxx' ; try { $pdo = new PDO ( \"mysql:host= $host ;dbname= $dbname ;charset=utf8\" , $user , $pass ); $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); } catch ( PDOException $e ) { echo \"S'ha produ\u00eft un error en intentar connectar al servidor MySQL:\" . $e -> getMessage (); } try { # Un altre Exemple d'error! DELECT en lloc de SELECT! $pdo -> exec ( 'DELECT name FROM people' ); } catch ( PDOException $e ) { echo \"S'ha produ\u00eft un error en l'execuci\u00f3 de la consulta:\" . $e -> getMessage (); /* En aquest cas hem mostrat el missatge d'error i, a m\u00e9s emmagatzemem en un fitxer els errors generats. */ file_put_contents ( 'PDOErrors.txt' , $e -> getMessage (), FILE_APPEND ); } Transaccions Una transacci\u00f3 en un Sistema de Gesti\u00f3 de Bases de Dades \u00e9s un conjunt d'ordres que s'executen formant una unitat de treball, \u00e9s a dir, en forma indivisible o at\u00f2mica. Un SGBD es diu transaccional si \u00e9s capa\u00e7 de mantenir la integritat de dades, fent que aquestes transaccions no puguin finalitzar en un estat intermedi. Quan per alguna causa el sistema ha de cancel\u00b7lar la transacci\u00f3, comen\u00e7a a desfer les ordres executades fins a deixar la base de dades en el seu estat inicial (anomenat punt d'integritat), com si l'ordre de la transacci\u00f3 mai s'hagu\u00e9s realitzat. Una transacci\u00f3 ha de comptar amb ACID (un acr\u00f2nim angl\u00e8s) que vol dir: Atomicidad, consist\u00e8ncia, a\u00efllament i durabilitat. Transaccions en PDO Com ja hem comentat, no tots els SGBD s\u00f3n transaccionals. Per\u00f2 tamb\u00e9 es possible que tot i que el SGBD ho siga el motor d'emmagatzemat no ho suporte. Per la qual cosa si necessites utilitzar transaccions haur\u00e0s d'assegurar-se que estiguen suportades pel motor d'emmagatzematge que gestiona les teves taules en MySQL. Per exemple el motor MyISAM no les suporta. Per defecte PDO treballa en mode autocommit. Confirma autom\u00e0ticament cada sent\u00e8ncia que executa el servidor. Per treballar amb transaccions, PDO incorpora tres m\u00e8todes: beginTransaction . Deshabilita la manera autocommit i comen\u00e7a una nova transacci\u00f3, que finalitzar\u00e0 quan executis un dels dos m\u00e8todes seg\u00fcents. commit . Confirma la transacci\u00f3 actual. rollback . Reverteix els canvis duts a terme a la transacci\u00f3 actual. Un cop executat un commit o rollback , es tornar\u00e0 al mode de confirmaci\u00f3 autom\u00e0tica. Si utilitzem un motor que no suporta transaccions PDO no mostrar\u00e0 cap error, simplement ser\u00e0 incapa\u00e7 de realitzar un rollback si fora necessari. Esquema b\u00e0sic d'\u00fas de transaccions amb PDO #Esquema b\u00e0sic d'\u00fas de PDO try { $pdo -> beginTransaction (); $pdo -> exec ( 'DELETE ...' ); $pdo -> exec ( 'UPDATE ...' ); $pdo -> commit (); } catch ( PDOException $exception ) { $pdo -> rollback (); } Exemple $mbd = new PDO ( 'odbc:SAMPLE' , 'db2inst1' , 'ibmdb2' , array ( PDO :: ATTR_PERSISTENT => true )); echo \"Conectado \\n \" ; } catch ( Exception $e ) { die ( \"No se pudo conectar: \" . $e -> getMessage ()); } try { $mbd -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); $mbd -> beginTransaction (); $mbd -> exec ( \"insert into staff (id, first, last) values (23, 'Joe', 'Bloggs')\" ); $mbd -> exec ( \"insert into salarychange (id, amount, changedate) values (23, 50000, NOW())\" ); $mbd -> commit (); } catch ( Exception $e ) { $mbd -> rollBack (); echo \"Fallo: \" . $e -> getMessage (); }","title":"Acc\u00e9s a dades amb PHP"},{"location":"05-data-access/0501-data-access/#acces-a-dades-mitjancant-php-pdo","text":"PHP permet treballar en base de dades MySQL gr\u00e0cies a dues llibreries. MySQLi i PDO. Com que MySQLi est\u00e0 dissenyada exclusivament per a MySQL nosaltres aprofundirem en PDO, que permet connectar fins amb 12 sistemes gestors de base de dades diferents. Les sigles PDO ( PHP Data Objects ) fan refer\u00e8ncia a una interf\u00edcie de PHP que ens permet accedir a bases de dades de qualsevol tipus en PHP. Cada controlador de bases de dades que implemente la interf\u00edcie PDO pot exposar caracter\u00edstiques espec\u00edfiques de la base de dades, com les funcions habituals de l'extensi\u00f3. Un controlador per SGDB Cal observar que no es pot realitzar cap de les funcions de la bases de dades utilitzant l'extensi\u00f3 PDO per si mateixa; s'ha d'utilitzar-ne una de PDO espec\u00edfica de la base de dades per tenir acc\u00e9s a un servidor de base de dades. Capes PDO PDO proporciona una capa d'abstracci\u00f3 d'acc\u00e9s a dades, el que significa que, independentment de la base de dades que s'estiga utilitzant, s'usen les mateixes funcions per fer consultes i obtenir dades. Per saber els controladors PDO disponibles en el nostre sistema: print_r ( PDO :: getAvailableDrivers ()); La informaci\u00f3 oficial sobre PDO es troba en http://php.net/manual/es/book.pdo.php","title":"Acc\u00e9s a dades mitjan\u00e7ant PHP PDO"},{"location":"05-data-access/0501-data-access/#classes-pdo-pdostatement-i-pdoexception","text":"PDO proporciona 3 classes per a gestionar l'acc\u00e9s a la base de dades PDO : S'utilitza per representar la connexi\u00f3 entre PHP i un servidor de bases de dades. PDOStatement : representa una sent\u00e8ncia preparada i tamb\u00e9 ens permet accedir al conjunt de resultats associat. PDOException : representa els errors generats PDO.","title":"Classes PDO, PDOStatement i PDOException"},{"location":"05-data-access/0501-data-access/#connexio-a-la-base-de-dades","text":"Per a crear una nova connexi\u00f3 s'utilitza la classe PDO : public __construct ( string $dsn [, string $username [, string $passwd [, array $options ]]] ) El constructor t\u00e9 els seg\u00fcents par\u00e0metres: dsn : cadena de connexi\u00f3 username : nom d'usuari passwd : contrasenya d'usuari options : permet afegir altres opcions de la connexi\u00f3 $pdo = new PDO ( \"mysql:host=localhost; dbname=test\" , \"dbuser\" , \"1234\" ); En l'exemple anterior mysql representa una connexi\u00f3 a una base de dades MySQL ( podria ser: MSSQL, Sybase, sqlite, etc.) anomenada test que es troba al servidor localhost . La connexi\u00f3 es realitzar\u00e0 mitjan\u00e7ant l'usuari dbuser i la contrasenya 1234 . // Exemple de connexi\u00f3 a diferents tipus de bases de dades. # Connectem a la base de dades $host = 'www.local' ; $hbname = 'cxbasex' ; $user = 'cxbasex' ; $pass = 'xxxxxx' ; try { # MS SQL Server y Sybase amb PDO_DBLIB $pdo = new PDO ( \"MSSQL:host= $host ;dbname= $dbname , $user , $pass \" ); $pdo = new PDO ( \"Sybase:host= $host ;dbname= $dbname , $user , $pass \" ); /* MySQL amb PDO_MYSQL Perqu\u00e8 la connexi\u00f3 a mysql utilitzi les collation UTF-8 afegir charset = utf8 a string de la connexi\u00f3. */ $pdo = new PDO ( \"mysql:host= $host ;dbname= $dbname ;charset=utf8\" , $user , $pass ); // Perqu\u00e8 generi excepcions a l'hora de reportar errors. $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); # SQLite Database $pdo = new PDO ( \"sqlite:my/database/path/database.db\" ); } catch ( PDOException $e ) { die ( $e -> getMessage ()); } // Si tot va b\u00e9 en $pdo tindrem el objecte que gestionar\u00e0 la connexi\u00f3 amb la base de dades.","title":"Connexi\u00f3 a la base de dades"},{"location":"05-data-access/0501-data-access/#tancar-la-connexio-a-la-base-de-dades","text":"Es recomana tancar sempre la connexi\u00f3 a la base de dades quan no es vaja a utilitzar m\u00e9s durant el nostre proc\u00e9s. Cal recordar que els recursos s\u00f3n limitats i quan hi ha pocs usuaris no hi ha cap problema, per\u00f2 si tenim molts usuaris simultanis llavors \u00e9s quan sorgeixen problemes en haver assolit el nombre m\u00e0xim de connexions amb el servidor, per exemple. En tancar la connexi\u00f3 de forma expl\u00edcita accelerem l'alliberament de recursos perqu\u00e8 estiguin disponibles per a altres usuaris. // Si vullguerem tancar la connexi\u00f3 amb la base de dades simplement podr\u00edem fer al final del fitxer. $pdo = null ;","title":"Tancar la connexi\u00f3 a la base de dades"},{"location":"05-data-access/0501-data-access/#execucio-de-consultes","text":"Per a realitzar consultes PDO proporciona tres m\u00e8todes: PDO::query() per a consultes de recuperaci\u00f3 de dades (SELECT). PDO::exec() per a consultes d'inserci\u00f3, modificaci\u00f3 i esborrat de dades (INSERT, UPDATE i DELETE) PDO::prepare() per a consultes de tot tipus amb par\u00e0metres. Aquest \u00e9s el m\u00e8tode recomanat si la consulta t\u00e9 par\u00e0metres o si s'ha d'executar divereses vegades per\u00f2 aix\u00f2 hem dedicat un apartat espec\u00edfic. Una vegada executada la consulta les dades s'obtenen a trav\u00e9s del m\u00e8tode PDOStatement::fetch() o PDOStatement::fetchAll() . fetch() : Obt\u00e9 la seg\u00fcent fila d'un recordset (conjunt de resultats). http://php.net/manual/es/pdostatement.fetch.php fetchAll() : Retorna un array que cont\u00e9 totes les files del conjunt de resultats (el tipus de dades a retornar es pot indicar com a par\u00e0metre). http://php.net/manual/es/pdostatement.fetchall.php","title":"Execuci\u00f3 de consultes"},{"location":"05-data-access/0501-data-access/#estil-de-busqueda-fetch-style","text":"Abans de cridar al m\u00e8tode fetch() una bona idea \u00e9s indicar-li com volem que ens torne les dades de la base de dades. Tindrem les seg\u00fcents opcions en el m\u00e8tode fetch() : PDO::FETCH_ASSOC : Torna les dades en un array associatiu pel nom de camp de la taula. PDO::FETCH_NUM : Retorna un array indexat per la posici\u00f3 del camp. PDO::FETCH_BOTH : Retorna un array associatiu pel nom de camp de la taula i un indexat per la posici\u00f3 del camp. \u00c9s una combinaci\u00f3 dels dos estils anteriors. \u00c9s l'estil per defecte. PDO::FETCH_BOUND : Assigna els valors retornats a les variables assignades amb el m\u00e8tode bindColumn() . PDO::FETCH_CLASS : Assigna els valors dels camps a les propietats d'una classe. Si les propietats no existeixen en aquesta classe, les crear\u00e0. PDO::FETCH_INTO : Actualitza una inst\u00e0ncia existent d'una classe. PDO::FETCH_LAZY : Combina PDO::FETCH_BOTH / PDO::FETCH_OBJ , creant les variables de l'objecte a mesura que es van fent servir. PDO::FETCH_OBJ : Retorna un objecte an\u00f2nim amb els noms de les propietats que es corresponen amb els noms de columnes. Podem ajustar l'estil de b\u00fasqueda de dues formes: Abans de recuperar registres: $stmt -> setFetchMode ( PDO :: FETCH_ASSOC ); En el moment de recuperar-los: $stmt -> fetch ( PDO :: FETCH_ASSOC ); $stmt -> fechtall ( PDO :: FETCH_ASSOC ); PDO::FETCH_CLASS Cal saber que no podem usar PDO::FETCH_CLASS com a par\u00e0metre de PDOStatement::fetch() . Cal controlar l'estil de b\u00fasqueda amb PDOStatement::setFetchMode() .","title":"Estil de b\u00fasqueda (fetch style)"},{"location":"05-data-access/0501-data-access/#consultes-preparades","text":"Com hem vist en l'apartat anterior les consultes poden acceptar par\u00e0metres. La millor forma de realitzar aquestes consultes \u00e9s mitjan\u00e7ant les consultes preparades . Les consultes preparades ens aporten dues avantatges importants: Per a sent\u00e8ncies que seran executades en m\u00faltiples ocasions amb diferents par\u00e0metres optimitza el rendiment de la aplicaci\u00f3. Ajuda a prevenir injeccions SQL eliminant la necessitat de posar entre cometes manualment els par\u00e0metres. Per a construir una sent\u00e8ncia preparada cal incloure uns marcadors en la sent\u00e8ncia SQL. Hi ha tres formes de fer-ho: # Marcadors an\u00f2nims $stmt = $pdo -> prepare ( \"INSERT INTO colleague (name, addr, city) values (?, ?, ?)\" ); # Marcadors coneguts $stmt = $pdo -> prepare ( \"INSERT INTO colleague (name, addr, city) values (:name, :addr, :city)\" ); # Sense marcadors. Aquest m\u00e8tode est\u00e0 desaconsellat! Prohibit en el nostre cas. $stmt = $pdo -> prepare ( \"INSERT INTO colleague (name, addr, city) values ( $name , $addr , $city )\" ); Haur\u00e0s d'usar el primer o el segon m\u00e8tode dels que es mostren anteriorment. El tipus de marcadors que utilitzem afectaran a la forma d'assignar els valors d'eixos marcadors.","title":"Consultes preparades"},{"location":"05-data-access/0501-data-access/#assignacio-amb-marcadors-anonims","text":"Per enlla\u00e7ar els marcadors an\u00f2nims amb el seu corresponent valor es pot utilitzar bindParam o bindValue : Marcadors an\u00f2nims $pdo->prepare() usant marcadors an\u00f2nims ? , tracta totes les variables com si foren string , per la qual cosa far\u00e0 servir cometes per delimitar els seus valors per defecte. # Marcadors an\u00f2nims $stmt = $pdo -> prepare ( \"INSERT INTO colleague (name, addr, city) values (?, ?, ?)\" ); # Assignem variables a cada marcador, indexats l'1 al 3 $stmt -> bindParam ( 1 , $name ); $stmt -> bindParam ( 2 , $addr ); $stmt -> bindParam ( 3 , $city ); # Inserim una fila. $name = \"Daniel\" ; $addr = \"1 Wicked Way\" ; $city = \"Arlington Heights\" ; $stmt -> execute (); # Inserim un altra fila con valores diferents. $name = \"Steve\" $addr = \"5 Circle Drive\" ; $city = \"Schaumburg\" ; $stmt -> execute (); Un altra forma d'assignaci\u00f3 amb marcadors an\u00f2nims \u00e9s mitjan\u00e7ant un array associatiu: # Les dades que volem inserir $dades = [ 'Cathy' , '9 Dark and Twisty Road' , 'Cardiff' ]; $stmt = $pdo -> prepare ( \"INSERT INTO colleague (name, addr, city) values (?, ?, ?)\" ); $stmt -> execute ( $dades );","title":"Assignaci\u00f3 amb marcadors an\u00f2nims"},{"location":"05-data-access/0501-data-access/#diferencia-entre-lus-de-bindparam-i-bindvalue","text":"Amb bindParam es vincula la variable al par\u00e0metre i en el moment de fer l' execute \u00e9s quan s'assigna realment el valor de la variable a aquest par\u00e0metre. Amb bindValue s'assigna el valor de la variable a aquest par\u00e0metre just en el moment d'executar la instrucci\u00f3 bindValue . Exemple de difer\u00e8ncia entre bindParam i bindValue : // Ejemplo con bindParam: $sex = 'hombre' ; $s = $dbh -> prepare ( 'SELECT name FROM estudiantes WHERE sexo = :sexo' ); $s -> bindParam ( ':sexo' , $sex ); $sex = 'mujer' ; $s -> execute (); // se ejecut\u00f3 con el valor WHERE sexo = 'mujer' // El mismo ejemplo con bindValue: $sex = 'hombre' ; $s = $dbh -> prepare ( 'SELECT name FROM students WHERE sexo = :sexo' ); $s -> bindValue ( ':sexo' , $sex ); $sex = 'mujer' ; $s -> execute (); // se ejecut\u00f3 con el valor WHERE sexo = 'hombre'","title":"Difer\u00e8ncia entre l'\u00fas de bindParam i bindValue"},{"location":"05-data-access/0501-data-access/#assignacio-amb-marcadors-coneguts","text":"Els marcadors coneguts s\u00f3n la forma m\u00e9s recomanable de treballar amb PDO, ja que a l'hora de fer el bindParam o el bindValue es pot especificar el tipus de dada i la seua longitud. Format de bindParam amb marcadors coneguts: bindParam ( ':marcador' , $variableVincular , TIPO DATOS PDO ) Exemple d'\u00fas de bindParam : $stmt -> bindParam ( ':calorias' , $misCalorias , PDO :: PARAM_INT ); $stmt -> bindParam ( ':apellidos' , $misApellidos , PDO :: PARAM_STR , 35 ); // 35 caracteres como m\u00e1ximo. Amb marcadors coneguts quedaria de la seg\u00fcent forma: $stmt = $pdo -> prepare ( \"INSERT INTO colleague (name, addr, city) value (:name, :addr, :city)\" ); # El primer argument de bindParam \u00e9s el nom del marcador i el segon la variable # que contindr\u00e0 les dades. # Els marcadors conocidos siempre comienzan con : $stmt -> bindParam ( ':name' , $name ); $name = 'Pepito' ; $stmt -> bindParam ( ':addr' , $addr ); $addr = 'Duanes, 17' ; $stmt -> bindParam ( ':city' , $city ); $city = 'Pego' ; $stmt -> execute (); # Tamb\u00e9 podem fer-ho mitjan\u00e7ant un array associatiu $dades = [ 'name' => 'Pepito' , 'addr' => 'Duanes, 17' , 'city' => 'Pego' ); # Fixeu-vos es passa l'array de dades en execute(). $stmt = $pdo -> prepare ( \"INSERT INTO colleague (name, addr, city) value (:name, :addr, :city)\" ); $stmt -> execute ( $dades ); # La \u00faltima instrucci\u00f3n se podr\u00eda poner tambi\u00e9n as\u00ed: $stmt -> execute ([ 'name' => 'Pepito' , 'addr' => 'Duanes, 17' , 'city' => 'Pego' ]); Una altra caracter\u00edstica dels marcadors coneguts \u00e9s que ens permetran treballar amb objectes directament a la base de dades, assumint que les propietats d'aquest objecte coincideixen amb els noms dels camps de la taula a la base de dades. Exemple d'\u00fas de marcadors coneguts i objectes: # Un objeto sencillo class Person { public $name ; public $addr ; public $city ; function __construct ( $n , $a , $c ) { $this -> name = $n ; $this -> addr = $a ; $this -> city = $c ; } # etc ... } $cathy = new Person ( 'Pepito' , 'Duanes, 17' , 'Pego' ); # Preparaci\u00f3n de la consulta $stmt = $pdo -> prepare ( \"INSERT INTO colegas (name, addr, city) value (:name, :addr, :city)\" ); # Inserci\u00f3n del objeto $stmt -> execute (( array ) $cathy );","title":"Assignaci\u00f3 amb marcadors coneguts"},{"location":"05-data-access/0501-data-access/#exemple-dus","text":"Per a utilitzar les consultes preparades seguirem sempre aquest esquema: $pdo = new PDO ( 'sqlite:/path/db/users.db' ); # 1. Preparem la connexi\u00f3 $stmt = $pdo -> prepare ( 'SELECT name FROM users WHERE id = :id' ); $id = 5 ; # 2. Vinculem els par\u00e0metres $stmt -> bindParam ( ':id' , $id , PDO :: PARAM_INT ); # 3. Executem la consulta $stmt -> execute (); # 4. Obtenim els registres # Un a un $row = $stmt -> fetch (); # Tots a l'hora $rows = $stmt -> fetchAll (); Dates en MySQL Recorda que el tipus DATE de MySQL es recupera com un string en format \"YYYY-MM-DD\" i a l'hora d'emmagatzemar-lo cal que tinga el mateix format. Si f\u00f3ra DATETIME tamb\u00e9 caldria afegir l'hora \"YY-MM-DD hh:mm:ss\".","title":"Exemple d'\u00fas"},{"location":"05-data-access/0501-data-access/#insercio-modificacio-i-eliminacio-de-dades-de-la-bbdd","text":"Inserir noves dades, actualitzar-les o esborrar-les s\u00f3n algunes de les operacions m\u00e9s comunes en una base de dades. Amb PDO podem fer aquestes aquestes operacions en 3 passos. Exemple d'\u00fas: # $stmt ser\u00e0 un objecte de tipus PDOStatement (consulta preparada) $stmt = $pdo -> prepare ( \"INSERT INTO colleague(name, addr, city) values (:name, :addr, :city)\" ); # Assignem els valors dels marcadors $name = \"Josep\" $addr = \"Duanes, 17\" $city = \"Pego\" $stmt -> BindValue ( \"name\" , $name ); $stmt -> BindValue ( \"addr\" , $addr ); $stmt -> BindValue ( \"city\" , $city ); # Executem la consulta amb ->execute() m\u00e8tode de l'objecte PDOStatement # Este m\u00e8tode devuelve true o false. $result = $stmt -> execute ();","title":"Inserci\u00f3, modificaci\u00f3 i eliminaci\u00f3 de dades de la BBDD"},{"location":"05-data-access/0501-data-access/#exemples-crud-create-read-update-delete-insert-update-y-delete","text":"INSERT try { $pdo = new PDO ( \"mysql:host= $host ;dbname= $dbname ;charset=utf8\" , $username , $password ); $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); $stmt = $pdo -> prepare ( 'INSERT INTO colleague (name, addr, city ) VALUES(:name, :addr, :city)' ); $stmt -> execute ([ ':name' => 'Josep' , ':addr' => 'Duanes, 17' , ':city' => 'Pego' ]); # Affected Rows? echo $stmt -> rowCount (); // 1 } catch ( PDOException $e ) { echo 'Error: ' . $e -> getMessage (); } UPDATE $id = 5 ; $name = \"Joe the Plumber\" ; try { $pdo = new PDO ( \"mysql:host= $host ;dbname= $dbname ;charset=utf8\" , $username , $password ); $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); $stmt = $pdo -> prepare ( 'UPDATE someTable SET name = :name WHERE id = :id' ); $stmt -> execute ( array ( ':id' => $id , ':name' => $name )); echo $stmt -> rowCount (); // 1 } catch ( PDOException $e ) { echo 'Error: ' . $e -> getMessage (); } DELETE $id = 5 ; // From a form or something similar try { $pdo = new PDO ( \"mysql:host= $host ;dbname= $dbname ;charset=utf8\" , $username , $password ); $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); $stmt = $pdo -> prepare ( 'DELETE FROM someTable WHERE id = :id' ); $stmt -> bindParam ( ':id' , $id ); // this time, we'll use the bindParam method $stmt -> execute (); echo $stmt -> rowCount (); // 1 } catch ( PDOException $e ) { echo 'Error: ' . $e -> getMessage (); }","title":"Exemples CRUD (Create, Read, Update, Delete): INSERT, UPDATE y DELETE"},{"location":"05-data-access/0501-data-access/#alguns-metodes-dinteres","text":"Alguns m\u00e8todes interessant i que podem utilitzar per a millorar la gesti\u00f3 de l'acc\u00e9s a dades s\u00f3n: PDO::lastInsertId() , ens torna la clau prim\u00e0ria ( id ) del \u00faltim registre inserit en la base de dades. PDOStatement::rowCount() , ens torna el n\u00famero de files afectades por una sent\u00e8ncia DELETE, INSERT, o UPDATE.","title":"Alguns m\u00e8todes d'inter\u00e8s"},{"location":"05-data-access/0501-data-access/#gestio-derrors-en-lacces","text":"PDO pot utilitzar les excepcions per gestionar els errors, el que significa que qualsevol cosa que fem amb PDO podr\u00edem encapsular en un bloc try/catch per gestionar si produeix algun error. Podem for\u00e7ar PDO perqu\u00e8 treballi en qualsevol de les tres maneres seg\u00fcents: PDO::ERRMODE_SILENT . \u00c9s el mode per defecte. Aqu\u00ed haurem de revisar els errors usant errorCode() i errorInfo() . PDO::ERRMODE_WARNING . Genera errors de revisi\u00f3 de resultats PHP per\u00f2 permetria l'execuci\u00f3 normal de l'aplicaci\u00f3. PDO::ERRMODE_EXCEPTION . Ser\u00e0 la forma m\u00e9s utilitzada en PDO. Dispara una excepci\u00f3 permetent-nos gestionar l'error de forma amigable. //Activaci\u00f3 de la manera de treball de PDO $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_SILENT ); $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_WARNING ); // Es recomana activar aquesta opci\u00f3 per gestionar els errors amb PDOException $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); Excepcions Es recomana activar aquesta opci\u00f3 per gestionar els errors amb PDOException , d'altra forma no apareixer\u00e0 cap missatge i ser\u00e0 complicat detectar-los. $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); Exemple d'\u00fas: # Connectem a la base de dades $host = 'www.local' ; $dbname = 'cxbasex' ; $user = 'cxbasex' ; $pass = 'xxxxxx' ; try { $pdo = new PDO ( \"mysql:host= $host ;dbname= $dbname ;charset=utf8\" , $user , $pass ); $pdo -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); } catch ( PDOException $e ) { echo \"S'ha produ\u00eft un error en intentar connectar al servidor MySQL:\" . $e -> getMessage (); } try { # Un altre Exemple d'error! DELECT en lloc de SELECT! $pdo -> exec ( 'DELECT name FROM people' ); } catch ( PDOException $e ) { echo \"S'ha produ\u00eft un error en l'execuci\u00f3 de la consulta:\" . $e -> getMessage (); /* En aquest cas hem mostrat el missatge d'error i, a m\u00e9s emmagatzemem en un fitxer els errors generats. */ file_put_contents ( 'PDOErrors.txt' , $e -> getMessage (), FILE_APPEND ); }","title":"Gesti\u00f3 d'errors en l'acc\u00e9s"},{"location":"05-data-access/0501-data-access/#transaccions","text":"Una transacci\u00f3 en un Sistema de Gesti\u00f3 de Bases de Dades \u00e9s un conjunt d'ordres que s'executen formant una unitat de treball, \u00e9s a dir, en forma indivisible o at\u00f2mica. Un SGBD es diu transaccional si \u00e9s capa\u00e7 de mantenir la integritat de dades, fent que aquestes transaccions no puguin finalitzar en un estat intermedi. Quan per alguna causa el sistema ha de cancel\u00b7lar la transacci\u00f3, comen\u00e7a a desfer les ordres executades fins a deixar la base de dades en el seu estat inicial (anomenat punt d'integritat), com si l'ordre de la transacci\u00f3 mai s'hagu\u00e9s realitzat. Una transacci\u00f3 ha de comptar amb ACID (un acr\u00f2nim angl\u00e8s) que vol dir: Atomicidad, consist\u00e8ncia, a\u00efllament i durabilitat.","title":"Transaccions"},{"location":"05-data-access/0501-data-access/#transaccions-en-pdo","text":"Com ja hem comentat, no tots els SGBD s\u00f3n transaccionals. Per\u00f2 tamb\u00e9 es possible que tot i que el SGBD ho siga el motor d'emmagatzemat no ho suporte. Per la qual cosa si necessites utilitzar transaccions haur\u00e0s d'assegurar-se que estiguen suportades pel motor d'emmagatzematge que gestiona les teves taules en MySQL. Per exemple el motor MyISAM no les suporta. Per defecte PDO treballa en mode autocommit. Confirma autom\u00e0ticament cada sent\u00e8ncia que executa el servidor. Per treballar amb transaccions, PDO incorpora tres m\u00e8todes: beginTransaction . Deshabilita la manera autocommit i comen\u00e7a una nova transacci\u00f3, que finalitzar\u00e0 quan executis un dels dos m\u00e8todes seg\u00fcents. commit . Confirma la transacci\u00f3 actual. rollback . Reverteix els canvis duts a terme a la transacci\u00f3 actual. Un cop executat un commit o rollback , es tornar\u00e0 al mode de confirmaci\u00f3 autom\u00e0tica. Si utilitzem un motor que no suporta transaccions PDO no mostrar\u00e0 cap error, simplement ser\u00e0 incapa\u00e7 de realitzar un rollback si fora necessari.","title":"Transaccions en PDO"},{"location":"05-data-access/0501-data-access/#esquema-basic-dus-de-transaccions-amb-pdo","text":"#Esquema b\u00e0sic d'\u00fas de PDO try { $pdo -> beginTransaction (); $pdo -> exec ( 'DELETE ...' ); $pdo -> exec ( 'UPDATE ...' ); $pdo -> commit (); } catch ( PDOException $exception ) { $pdo -> rollback (); }","title":"Esquema b\u00e0sic d'\u00fas de transaccions amb PDO"},{"location":"05-data-access/0501-data-access/#exemple","text":"$mbd = new PDO ( 'odbc:SAMPLE' , 'db2inst1' , 'ibmdb2' , array ( PDO :: ATTR_PERSISTENT => true )); echo \"Conectado \\n \" ; } catch ( Exception $e ) { die ( \"No se pudo conectar: \" . $e -> getMessage ()); } try { $mbd -> setAttribute ( PDO :: ATTR_ERRMODE , PDO :: ERRMODE_EXCEPTION ); $mbd -> beginTransaction (); $mbd -> exec ( \"insert into staff (id, first, last) values (23, 'Joe', 'Bloggs')\" ); $mbd -> exec ( \"insert into salarychange (id, amount, changedate) values (23, 50000, NOW())\" ); $mbd -> commit (); } catch ( Exception $e ) { $mbd -> rollBack (); echo \"Fallo: \" . $e -> getMessage (); }","title":"Exemple"},{"location":"05-data-access/0599-tasks/","text":"Activitats 501-querying.php . Importa mitjan\u00e7ant PHPMyAdmin la base de dades movies.sql . Crea la connexi\u00f3 i fes les seg\u00fcents consultes usant consultes preparades amb marcadors coneguts: Mostra en un array associatiu (pots usar var_dump ) el id i el t\u00edtol de totes les pel\u00b7l\u00edcules. A partir de l'activitat anterior, modifica la sent\u00e8ncia SQL perqu\u00e8 les pel\u00b7l\u00edcules apareguen ordenades pel t\u00edtol . Mostra en una array associatiu el id , el t\u00edtol i el nom del g\u00e8nere de totes les pel\u00b7l\u00edcules ordenades per la data d'estrena de forma descendent (pista: caldr\u00e0 fer un JOIN ). Mostra en un array associatiu les dades de la pel\u00b7l\u00edcula amb id igual a 459489 . Cal que uses bindValue per vincular el par\u00e0metre a la consulta preparada. Mostra en un array associatiu el id i el t\u00edtol de les pel\u00b7l\u00edcules que tinguen en el t\u00edtol el text Te , han d'eixir-ne 2. Cal vincular els par\u00e0metres mitjan\u00e7ant un par\u00e0metre del m\u00e8tode execute . Mostra en un array associatiu el id i el t\u00edtol de les pel\u00b7l\u00edcules que anteriors a 2020. Mostra en una taula els generes. 502-manipulating.php . Realitza, sobre la base de dades Movies les seg\u00fcents accions: Insereix una nova pel\u00b7l\u00edcula indicant el nou identificador assignat. Mostra-la en un array associatiu ( var_dump ). Modifica el t\u00edtol de la pel\u00b7l\u00edcula que acabes d'inserir afegint-li \"(c\u00f2pia)\" al t\u00edtol actual. Associa els par\u00e0metres en l' execute . Insereix un nou g\u00e8nere i assigna-li'l a la pel\u00b7l\u00edcula. Usa en aquest cas bindParam per associar els par\u00e0metres. Elimina el nou g\u00e8nere. \u00c9s possible? Per qu\u00e8? Elimina la pel\u00b7l\u00edcula i, despr\u00e9s, el g\u00e8nere. 503-contact-info . Crea una base dades anomenada contact-info on emmagatzemarem les dades recollides en el formulari de l'activitat 440. Tingues en compte que el g\u00e8nere, les hores de contacte i les aficions seran taules independents (utilitza les claus dels arrays com a clau prim\u00e0ria) que estaran relacionades amb la taula principal. C\u00f2pia l'activitat 440 i modifica-la perqu\u00e8 les dades s'emmagatzemem en la base de dades. Projecte Truiter Implementa la seg\u00fcent base de dades truiter : erDiagram User ||--o{ Tweet : publishes User { int id varchar[50] name varchar[15] username varchar[255] password datetime created_at boolean verified } Tweet ||--o{ Media : contains Tweet { int id varchar[280] text datetime created_at int like_count } Media { int id varchar[255] alt_text int height int width varchar[255] url } Adapta el projecte Truiter perqu\u00e8 extraga la informaci\u00f3 de la base de dades: index.php mostrar\u00e0 tots els tuits per ordenats per data de forma descendent. login.php comprovar\u00e0 les credencials dels usuaris en la base de dades. tweet-new.php permetr\u00e0 als usuaris autenticats crear un nou tuit. Afig al projecte una p\u00e0gina de registre ( register.php i register-process.php ) que sol\u00b7licite a l'usuari les dades requerides per registrar-se tenint en compte el seg\u00fcent: La data de creaci\u00f3 ser\u00e0 per defecte el moment actual. Per defecte el compte no ser\u00e0 verificat. El nom d'usuari haur\u00e0 de ser \u00fanic. La contrasenya haur\u00e0 de sol\u00b7licitar-se dues vegades, per comprovar que l'usuari les ha escrit b\u00e9, i s'haur\u00e0 d'emmagatzemar despr\u00e9s d'aplicar-li una funci\u00f3 resum ( hash ). Veure l'apartat No con\u00e8ixer les contrasenyes de la unitat 4. Afig al projecte una p\u00e0gina de perfil d'usuari ( profile.php ) des de la que l'usuari podr\u00e0 editar el seu nom d'usuari i el seu nom i eliminar, amb confirmaci\u00f3, el seu compte. Afig al projecte un buscador de tweets pel seu contingut.","title":"Activitats"},{"location":"05-data-access/0599-tasks/#activitats","text":"501-querying.php . Importa mitjan\u00e7ant PHPMyAdmin la base de dades movies.sql . Crea la connexi\u00f3 i fes les seg\u00fcents consultes usant consultes preparades amb marcadors coneguts: Mostra en un array associatiu (pots usar var_dump ) el id i el t\u00edtol de totes les pel\u00b7l\u00edcules. A partir de l'activitat anterior, modifica la sent\u00e8ncia SQL perqu\u00e8 les pel\u00b7l\u00edcules apareguen ordenades pel t\u00edtol . Mostra en una array associatiu el id , el t\u00edtol i el nom del g\u00e8nere de totes les pel\u00b7l\u00edcules ordenades per la data d'estrena de forma descendent (pista: caldr\u00e0 fer un JOIN ). Mostra en un array associatiu les dades de la pel\u00b7l\u00edcula amb id igual a 459489 . Cal que uses bindValue per vincular el par\u00e0metre a la consulta preparada. Mostra en un array associatiu el id i el t\u00edtol de les pel\u00b7l\u00edcules que tinguen en el t\u00edtol el text Te , han d'eixir-ne 2. Cal vincular els par\u00e0metres mitjan\u00e7ant un par\u00e0metre del m\u00e8tode execute . Mostra en un array associatiu el id i el t\u00edtol de les pel\u00b7l\u00edcules que anteriors a 2020. Mostra en una taula els generes. 502-manipulating.php . Realitza, sobre la base de dades Movies les seg\u00fcents accions: Insereix una nova pel\u00b7l\u00edcula indicant el nou identificador assignat. Mostra-la en un array associatiu ( var_dump ). Modifica el t\u00edtol de la pel\u00b7l\u00edcula que acabes d'inserir afegint-li \"(c\u00f2pia)\" al t\u00edtol actual. Associa els par\u00e0metres en l' execute . Insereix un nou g\u00e8nere i assigna-li'l a la pel\u00b7l\u00edcula. Usa en aquest cas bindParam per associar els par\u00e0metres. Elimina el nou g\u00e8nere. \u00c9s possible? Per qu\u00e8? Elimina la pel\u00b7l\u00edcula i, despr\u00e9s, el g\u00e8nere. 503-contact-info . Crea una base dades anomenada contact-info on emmagatzemarem les dades recollides en el formulari de l'activitat 440. Tingues en compte que el g\u00e8nere, les hores de contacte i les aficions seran taules independents (utilitza les claus dels arrays com a clau prim\u00e0ria) que estaran relacionades amb la taula principal. C\u00f2pia l'activitat 440 i modifica-la perqu\u00e8 les dades s'emmagatzemem en la base de dades.","title":"Activitats"},{"location":"05-data-access/0599-tasks/#projecte-truiter","text":"Implementa la seg\u00fcent base de dades truiter : erDiagram User ||--o{ Tweet : publishes User { int id varchar[50] name varchar[15] username varchar[255] password datetime created_at boolean verified } Tweet ||--o{ Media : contains Tweet { int id varchar[280] text datetime created_at int like_count } Media { int id varchar[255] alt_text int height int width varchar[255] url } Adapta el projecte Truiter perqu\u00e8 extraga la informaci\u00f3 de la base de dades: index.php mostrar\u00e0 tots els tuits per ordenats per data de forma descendent. login.php comprovar\u00e0 les credencials dels usuaris en la base de dades. tweet-new.php permetr\u00e0 als usuaris autenticats crear un nou tuit. Afig al projecte una p\u00e0gina de registre ( register.php i register-process.php ) que sol\u00b7licite a l'usuari les dades requerides per registrar-se tenint en compte el seg\u00fcent: La data de creaci\u00f3 ser\u00e0 per defecte el moment actual. Per defecte el compte no ser\u00e0 verificat. El nom d'usuari haur\u00e0 de ser \u00fanic. La contrasenya haur\u00e0 de sol\u00b7licitar-se dues vegades, per comprovar que l'usuari les ha escrit b\u00e9, i s'haur\u00e0 d'emmagatzemar despr\u00e9s d'aplicar-li una funci\u00f3 resum ( hash ). Veure l'apartat No con\u00e8ixer les contrasenyes de la unitat 4. Afig al projecte una p\u00e0gina de perfil d'usuari ( profile.php ) des de la que l'usuari podr\u00e0 editar el seu nom d'usuari i el seu nom i eliminar, amb confirmaci\u00f3, el seu compte. Afig al projecte un buscador de tweets pel seu contingut.","title":"Projecte Truiter"},{"location":"06-composer/06-01-intro/","text":"Composer. Introducci\u00f3 al testing Objectius Gestionar depend\u00e8ncies amb llibreries de tercers. Utilitzar el autoloading de Composer en el nostre projecte. Utilitzar llibreries de tercers: Monolog, WebMozart. Realitzar test unitaris Continguts Instalaci\u00f3n de Composer a) Packagist b) Semantic Versioning Uso de librer\u00edas de terceros a) Monolog Namespaces Introducci\u00f3 al testing . Refactoring Criteris d'avaluaci\u00f3 RA09. A) S'han reconegut els avantatges que proporciona la reutilitzaci\u00f3 de codi i l'aprofitament d'informaci\u00f3 ja existent. RA09. B) S'han identificat llibreries de codi i tecnologies aplicables en la creaci\u00f3 d'aplicacions web h\u00edbrides. RA09. E) S'han utilitzat llibreries de codi per a incorporar funcionalitats espec\u00edfiques a una aplicaci\u00f3 web Introducci\u00f3 Fins ara hem apr\u00e9s a usar les diferents funcionalitats de PHP d'una forma molt b\u00e0sica. Ara anem a introduir una s\u00e8rie de ferraments i conceptes que ens ajudaran a realitzar les aplicacions d'una forma m\u00e9s \u00e0gil i segura. Refacci\u00f3 En enginyeria del programari, el terme refacci\u00f3, en angl\u00e8s refactoring , s'empra per a descriure el fet de modificar codi font sense canviar-ne el comportament observat des de l'exterior. La refacci\u00f3 sovint \u00e9s una part del cicle de vida del programari: els desenvolupadors alternen entre la producci\u00f3 de noves funcionalitats i la refacci\u00f3 de codi ja existent per tal de millorar-ne la consist\u00e8ncia interna i la claredat. Les proves de regressi\u00f3 asseguren que la refacci\u00f3 no ha canviat el comportament del codi observat des d'altres m\u00f2duls del programa. Patrons de disseny Segons Viquip\u00e8dia: En enginyeria de programari, un patr\u00f3 de disseny \u00e9s una soluci\u00f3 general a un problema com\u00fa i recurrent en el disseny de programari. Un patr\u00f3 de disseny no \u00e9s un disseny acabat que es pot transformar directament en codi; \u00e9s una descripci\u00f3 o plantilla per resoldre un problema que es pot utilitzar en moltes situacions diferents. \u00c9s a dir, s\u00f3n solucions als problemes habituals que podem trobar-nos en desenvolupar el nostre programari. Hi ha molts patrons de disseny com podeu trobar en les seg\u00fcents p\u00e0gines: Refactoring guru Design Patters PHP En el nostre cas en vorem alguns senzills, f\u00e0cils d'aplicar i que despr\u00e9s trobarem en els framewoks m\u00e9s habituals. Registry El prop\u00f2sit del patr\u00f3 Registry \u00e9s implementar un emmagatzematge central per als objectes que s'utilitzen sovint a tota l'aplicaci\u00f3, normalment s'implementa utilitzant una classe abstracta amb nom\u00e9s m\u00e8todes est\u00e0tics (o utilitzant el patr\u00f3 Singleton ). Estat global El patr\u00f3 Registry introdueix un estat global, \u00e9s a dir, crea un objecte d'\u00e0mbit global, la qual cosa s'hauri d'evitar tot moment! No obstant aix\u00f2, en projectes xicotets i senzills pot utilitzar-se perfectament. M\u00e9s avant del patr\u00f3 Dependency Injection que seria el recomanat en aquestos casos. En Registry teniu un exemple d'implementaci\u00f3. Adapter/Wrapper El prop\u00f2sit \u00e9s traduir una interf\u00edcie d'una classe a una interf\u00edcie compatible. Un adaptador permet que les classes treballen juntes ja que normalment no podrien ja que tenen interf\u00edcies incompatibles proporcionant la seua interf\u00edcie als clients mentre s'utilitza la interf\u00edcie original. Teniu m\u00e9s informaci\u00f3 en Adapter/Wrapper i en Adapter in PHP DataMapper Un DataMapper , \u00e9s una capa d'acc\u00e9s a dades que realitza la transfer\u00e8ncia bidireccional de dades entre un magatzem de dades persistent (sovint una base de dades relacional) i una representaci\u00f3 de dades en mem\u00f2ria (la capa de domini). L'objectiu del patr\u00f3 \u00e9s mantenir la representaci\u00f3 a la mem\u00f2ria i el magatzem de dades persistent independents entre s\u00ed i del propi mapejador de dades. La capa est\u00e0 formada per un o m\u00e9s mapeadors (o objectes d'acc\u00e9s a dades), que realitzen la transfer\u00e8ncia de dades. Les implementacions de mapper varien. Els mapeadors gen\u00e8rics gestionaran molts tipus d'entitats de domini diferents, els mapejadors dedicats en gestionaran un o alguns. M\u00e9s detalls en https://designpatternsphp.readthedocs.io/en/latest/Structural/DataMapper/README.html Repository Media entre el domini i les capes de mapatge de dades mitjan\u00e7ant una interf\u00edcie semblant a una col\u00b7lecci\u00f3 per accedir als objectes del domini. El repositori encapsula el conjunt d'objectes que persisteixen en un magatzem de dades i les operacions que s'hi duen a terme, proporcionant una visi\u00f3 m\u00e9s orientada a objectes de la capa de persist\u00e8ncia. El repositori tamb\u00e9 admet l'objectiu d'aconseguir una separaci\u00f3 neta i una depend\u00e8ncia unidireccional entre el domini i les capes de mapatge de dades. M\u00e9s detalls en https://designpatternsphp.readthedocs.io/en/latest/More/Repository/README.html .","title":"Composer. Introducci\u00f3 al _testing_"},{"location":"06-composer/06-01-intro/#composer-introduccio-al-testing","text":"Objectius Gestionar depend\u00e8ncies amb llibreries de tercers. Utilitzar el autoloading de Composer en el nostre projecte. Utilitzar llibreries de tercers: Monolog, WebMozart. Realitzar test unitaris Continguts Instalaci\u00f3n de Composer a) Packagist b) Semantic Versioning Uso de librer\u00edas de terceros a) Monolog Namespaces Introducci\u00f3 al testing . Refactoring Criteris d'avaluaci\u00f3 RA09. A) S'han reconegut els avantatges que proporciona la reutilitzaci\u00f3 de codi i l'aprofitament d'informaci\u00f3 ja existent. RA09. B) S'han identificat llibreries de codi i tecnologies aplicables en la creaci\u00f3 d'aplicacions web h\u00edbrides. RA09. E) S'han utilitzat llibreries de codi per a incorporar funcionalitats espec\u00edfiques a una aplicaci\u00f3 web","title":"Composer. Introducci\u00f3 al testing"},{"location":"06-composer/06-01-intro/#introduccio","text":"Fins ara hem apr\u00e9s a usar les diferents funcionalitats de PHP d'una forma molt b\u00e0sica. Ara anem a introduir una s\u00e8rie de ferraments i conceptes que ens ajudaran a realitzar les aplicacions d'una forma m\u00e9s \u00e0gil i segura. Refacci\u00f3 En enginyeria del programari, el terme refacci\u00f3, en angl\u00e8s refactoring , s'empra per a descriure el fet de modificar codi font sense canviar-ne el comportament observat des de l'exterior. La refacci\u00f3 sovint \u00e9s una part del cicle de vida del programari: els desenvolupadors alternen entre la producci\u00f3 de noves funcionalitats i la refacci\u00f3 de codi ja existent per tal de millorar-ne la consist\u00e8ncia interna i la claredat. Les proves de regressi\u00f3 asseguren que la refacci\u00f3 no ha canviat el comportament del codi observat des d'altres m\u00f2duls del programa.","title":"Introducci\u00f3"},{"location":"06-composer/06-01-intro/#patrons-de-disseny","text":"Segons Viquip\u00e8dia: En enginyeria de programari, un patr\u00f3 de disseny \u00e9s una soluci\u00f3 general a un problema com\u00fa i recurrent en el disseny de programari. Un patr\u00f3 de disseny no \u00e9s un disseny acabat que es pot transformar directament en codi; \u00e9s una descripci\u00f3 o plantilla per resoldre un problema que es pot utilitzar en moltes situacions diferents. \u00c9s a dir, s\u00f3n solucions als problemes habituals que podem trobar-nos en desenvolupar el nostre programari. Hi ha molts patrons de disseny com podeu trobar en les seg\u00fcents p\u00e0gines: Refactoring guru Design Patters PHP En el nostre cas en vorem alguns senzills, f\u00e0cils d'aplicar i que despr\u00e9s trobarem en els framewoks m\u00e9s habituals.","title":"Patrons de disseny"},{"location":"06-composer/06-01-intro/#registry","text":"El prop\u00f2sit del patr\u00f3 Registry \u00e9s implementar un emmagatzematge central per als objectes que s'utilitzen sovint a tota l'aplicaci\u00f3, normalment s'implementa utilitzant una classe abstracta amb nom\u00e9s m\u00e8todes est\u00e0tics (o utilitzant el patr\u00f3 Singleton ). Estat global El patr\u00f3 Registry introdueix un estat global, \u00e9s a dir, crea un objecte d'\u00e0mbit global, la qual cosa s'hauri d'evitar tot moment! No obstant aix\u00f2, en projectes xicotets i senzills pot utilitzar-se perfectament. M\u00e9s avant del patr\u00f3 Dependency Injection que seria el recomanat en aquestos casos. En Registry teniu un exemple d'implementaci\u00f3.","title":"Registry"},{"location":"06-composer/06-01-intro/#adapterwrapper","text":"El prop\u00f2sit \u00e9s traduir una interf\u00edcie d'una classe a una interf\u00edcie compatible. Un adaptador permet que les classes treballen juntes ja que normalment no podrien ja que tenen interf\u00edcies incompatibles proporcionant la seua interf\u00edcie als clients mentre s'utilitza la interf\u00edcie original. Teniu m\u00e9s informaci\u00f3 en Adapter/Wrapper i en Adapter in PHP","title":"Adapter/Wrapper"},{"location":"06-composer/06-01-intro/#datamapper","text":"Un DataMapper , \u00e9s una capa d'acc\u00e9s a dades que realitza la transfer\u00e8ncia bidireccional de dades entre un magatzem de dades persistent (sovint una base de dades relacional) i una representaci\u00f3 de dades en mem\u00f2ria (la capa de domini). L'objectiu del patr\u00f3 \u00e9s mantenir la representaci\u00f3 a la mem\u00f2ria i el magatzem de dades persistent independents entre s\u00ed i del propi mapejador de dades. La capa est\u00e0 formada per un o m\u00e9s mapeadors (o objectes d'acc\u00e9s a dades), que realitzen la transfer\u00e8ncia de dades. Les implementacions de mapper varien. Els mapeadors gen\u00e8rics gestionaran molts tipus d'entitats de domini diferents, els mapejadors dedicats en gestionaran un o alguns. M\u00e9s detalls en https://designpatternsphp.readthedocs.io/en/latest/Structural/DataMapper/README.html","title":"DataMapper"},{"location":"06-composer/06-01-intro/#repository","text":"Media entre el domini i les capes de mapatge de dades mitjan\u00e7ant una interf\u00edcie semblant a una col\u00b7lecci\u00f3 per accedir als objectes del domini. El repositori encapsula el conjunt d'objectes que persisteixen en un magatzem de dades i les operacions que s'hi duen a terme, proporcionant una visi\u00f3 m\u00e9s orientada a objectes de la capa de persist\u00e8ncia. El repositori tamb\u00e9 admet l'objectiu d'aconseguir una separaci\u00f3 neta i una depend\u00e8ncia unidireccional entre el domini i les capes de mapatge de dades. M\u00e9s detalls en https://designpatternsphp.readthedocs.io/en/latest/More/Repository/README.html .","title":"Repository"},{"location":"06-composer/06-02-composer/","text":"Composer Introducci\u00f3 Abans de tot cal definir qu\u00e8 \u00e9s un compoment o paquet en PHP. Un component PHP \u00e9s un conjunt de codi reutilitzable que t\u2019ajuda a solucionar un problema espec\u00edfic de la teua aplicaci\u00f3. Aquests components solen estar formats per diverses classes. Composer \u00e9s una eina que permet gestionar components en PHP. Composer permet declarar els components dels que dep\u00e8n el nostre projecte i gestionar-los (instal\u00b7lar/actualitzar). A difer\u00e8ncia dels gestors de paquets com Apt o Yum, Composer gestiona els paquets per projecte, instal\u00b7lant-los en el directori ( vendor ) del projecte. Per defecte, no instal\u00b7la res de forma global. Per tant, \u00e9s un gestor de depend\u00e8ncies. Aquesta idea no \u00e9s nova i Composer s\u2019inspira fortament en npm de node i el bundler de ruby. Composer ens soluciona dos problemes: Gestionar les depend\u00e8ncies amb llibreries de tercers. Nom\u00e9s cal que declarem les depend\u00e8ncies i Composer s'encarregar\u00e0 de descarregar i instal\u00b7lar tot el que siga necessari Autoloading del nostre codi. Ja no haurem de fer m\u00e9s require , Composer ho far\u00e0 per nosaltres \u00das b\u00e0sic Composer mant\u00e9 la seua configuraci\u00f3 en dos fitxers: composer.json i composer.lock . Per usar Composer el primer que necessitem \u00e9s disposar de l\u2019arxiu composer.json . En aquest fitxer existeixen un seguit d'estructures d'informaci\u00f3: { \"require\" : { \"monolog/monolog\" : \"2.0.*\" } } require indica els paquets que requerix la aplicaci\u00f3 i els mapeja (en l\u2019exemple, monolog/monolog ) a la versi\u00f3 requerida (en aquest cas: 2.0.* ). Si necessit\u00e0rem usar en un projecte el component monolog executariem en la carpeta del projecte: composer require monolog/monolog Com haur\u00e0s observat el nom del paquet est\u00e0 format per dues parts: La primera indica qui \u00e9s el seu \"vendor\" o creador. La segona indica el nom del projecte. composer require vendor/package Sovint les dues parts s\u00f3n id\u00e8ntiques. El fitxer composer.lock guarda la versi\u00f3 exacta que s'ha instal\u00b7lat de cada paquet. El projecte es fixa a unes determinades versions. Tant el composer.lock com el composer.json han d'estar al repositori. Limitar la versi\u00f3 dels paquets En alguns casos \u00e9s necessari limitar les versions dels paquetes per mantindre compatibilitat. Hi ha diverses formes d'expressar dites limitacions: Restricci\u00f3 de la versi\u00f3 exacta Exemple: 1.0.2 #MAJOR.MINOR.PATCH. Rang de versions Exemples: >=1.0 >=1.0 <2.0 >=1.0 <1.1 || >=1.2 Rang de versions comodins (.*) Es pot especificar una patr\u00f3 en un * comod\u00ed. 1.0.* \u00e9s l'equivalent de >=1.0 <1.1 . Exemple: 1.0.* Rang amb tilde (~) L'operador ~ s'explica millor en un exemple: ~1.2 \u00e9s equivalent a >=1.2 <2.0.0 , mentre que ~1.2.3 \u00e9s equivalent a >=1.2.3 <1.3.0 . Exemple: ~1.2 Rang de versi\u00f3 amb cimcurflex ( ^ ) Per exemple ^1.2.3 \u00e9s equivalent a >=1.2.3 <2.0.0 ja que ninguna de les releases fins a la 2.0 deuria trencar compatibilitat en versions anteriors. Exemple: ^1.2.3 Versionat sem\u00e0ntic (semver) Els n\u00fameros de versi\u00f3 i la forma en que canvien informen sobre el que va ser modificat d'una versi\u00f3 a una altra. Veure l'especificaci\u00f3 en el seg\u00fcent document: http://semver.org/lang/es/ Instal\u00b7lant depend\u00e8ncies L\u2019ordre install comprova primer si existeix el fitxer composer.lock , i si existeix, desc\u00e0rrega exactament les versions que s'indiquen en aquest l'arxiu composer.lock . Si treballem en equip, tot l'equip tindr\u00e0 les mateixes versions. Executem la seg\u00fcent ordre: composer install Es generar\u00e0 el directori vendor/ amb les llibreries de les quals dep\u00e8n el projecte. directori vendor Hem d'afegir el directori vendor/ a l'arxiu .gitignore , perqu\u00e8 crea gran quantitat de fitxers que despr\u00e9s s'han de descarregar amb composer install . L\u2019ordre tamb\u00e9 crea un fitxer composer.lock Actualitzar versions Si tenim l'arxiu composer.lock sempre s'instal\u00b7laran les mateixes versions dels paquets. Per actualitzar a noves versions, fem servir l\u2019ordre composer update . Aquesta ordre fa que Composer busque les versions m\u00e9s recents de les llibreries sempre que segueixin complint les restriccions de les versions indicades a l'arxiu composer.json . Tamb\u00e9 actualitza l'arxiu composer.lock . Si nom\u00e9s volem instal\u00b7lar o actualitzar una depend\u00e8ncia, podem indicar el seu nom despr\u00e9s de l\u2019ordre: composer update monolog/monolog No actualitzar en producci\u00f3 Quan desplegues una aplicaci\u00f3 basada en Composer a producci\u00f3, usa sempre composer install . No haurieu d'usar mai composer update ja que podria ser que s'actualitzara algun paquet a una versi\u00f3 no provada. Afegint depend\u00e8ncies L\u2019ordre que afegeix noves depend\u00e8ncies en el arxiu composer.json : composer require Ens preguntar\u00e0 quines llibreries volem afegir. Despr\u00e9s d'afegir aquestes noves depend\u00e8ncies, s\u2019instal\u00b7len o actualitzen les depend\u00e8ncies que siguen necess\u00e0ries. Podem passar les noves depend\u00e8ncies com argument de l'ordre. composer require monolog/monolog: Packagist Packagist \u00e9s el repositori central de paquets que pot gestionar Composer. Lloc Web: http://packagist.org Carrega autom\u00e0tica de classes Normalment les llibreries proporcionen informaci\u00f3 sobre la c\u00e0rrega autom\u00e0tica de les seves classes. Composer genera un arxiu vendor/autoload.php . Incloent aquest fitxer en el projecte, podem utilitzar qualsevol classe instal\u00b7lada a trav\u00e9s de Composer sense haver de incloure-la expl\u00edcitament: require 'vendor/autoload.php' ; En el nostre cas, afegirem el require anterior en el fitxer bootsrap.php . vendor/autoload.php autoload.php \u00e9s el punt d'entrada de l'aplicaci\u00f3 a totes les funcionalitats que ens oferix Composer . Classes personalitzades Podem emprar l\u2019 autoloader de Composer per a carregar les nostres classes. Si el nostre namespace \u00e9s App i els arxius estan en src afegirem: \"autoload\" : { \"psr-4\" : { \"App\\\\\" : \"src/\" } } Despr\u00e9s executarem composer dump-autoload perqu\u00e8 \u00e9s regenere vendor/autoload.php . PSR-4 PSR-4 ( PHP Standard Recommendation ) \u00e9s una de les recomanacions del PHP-FIG per a implementar el sistema de c\u00e0rrega autom\u00e0tica de classes. PHP-FIG ( Framework Interoperability Group ). La idea del grup \u00e9s que els representants del projecte parlen sobre els punts en com\u00fa entre els seus projectes i troben maneres de treballar junts.","title":"Composer"},{"location":"06-composer/06-02-composer/#composer","text":"","title":"Composer"},{"location":"06-composer/06-02-composer/#introduccio","text":"Abans de tot cal definir qu\u00e8 \u00e9s un compoment o paquet en PHP. Un component PHP \u00e9s un conjunt de codi reutilitzable que t\u2019ajuda a solucionar un problema espec\u00edfic de la teua aplicaci\u00f3. Aquests components solen estar formats per diverses classes. Composer \u00e9s una eina que permet gestionar components en PHP. Composer permet declarar els components dels que dep\u00e8n el nostre projecte i gestionar-los (instal\u00b7lar/actualitzar). A difer\u00e8ncia dels gestors de paquets com Apt o Yum, Composer gestiona els paquets per projecte, instal\u00b7lant-los en el directori ( vendor ) del projecte. Per defecte, no instal\u00b7la res de forma global. Per tant, \u00e9s un gestor de depend\u00e8ncies. Aquesta idea no \u00e9s nova i Composer s\u2019inspira fortament en npm de node i el bundler de ruby. Composer ens soluciona dos problemes: Gestionar les depend\u00e8ncies amb llibreries de tercers. Nom\u00e9s cal que declarem les depend\u00e8ncies i Composer s'encarregar\u00e0 de descarregar i instal\u00b7lar tot el que siga necessari Autoloading del nostre codi. Ja no haurem de fer m\u00e9s require , Composer ho far\u00e0 per nosaltres","title":"Introducci\u00f3"},{"location":"06-composer/06-02-composer/#us-basic","text":"Composer mant\u00e9 la seua configuraci\u00f3 en dos fitxers: composer.json i composer.lock . Per usar Composer el primer que necessitem \u00e9s disposar de l\u2019arxiu composer.json . En aquest fitxer existeixen un seguit d'estructures d'informaci\u00f3: { \"require\" : { \"monolog/monolog\" : \"2.0.*\" } } require indica els paquets que requerix la aplicaci\u00f3 i els mapeja (en l\u2019exemple, monolog/monolog ) a la versi\u00f3 requerida (en aquest cas: 2.0.* ). Si necessit\u00e0rem usar en un projecte el component monolog executariem en la carpeta del projecte: composer require monolog/monolog Com haur\u00e0s observat el nom del paquet est\u00e0 format per dues parts: La primera indica qui \u00e9s el seu \"vendor\" o creador. La segona indica el nom del projecte. composer require vendor/package Sovint les dues parts s\u00f3n id\u00e8ntiques. El fitxer composer.lock guarda la versi\u00f3 exacta que s'ha instal\u00b7lat de cada paquet. El projecte es fixa a unes determinades versions. Tant el composer.lock com el composer.json han d'estar al repositori.","title":"\u00das b\u00e0sic"},{"location":"06-composer/06-02-composer/#limitar-la-versio-dels-paquets","text":"En alguns casos \u00e9s necessari limitar les versions dels paquetes per mantindre compatibilitat. Hi ha diverses formes d'expressar dites limitacions: Restricci\u00f3 de la versi\u00f3 exacta Exemple: 1.0.2 #MAJOR.MINOR.PATCH. Rang de versions Exemples: >=1.0 >=1.0 <2.0 >=1.0 <1.1 || >=1.2 Rang de versions comodins (.*) Es pot especificar una patr\u00f3 en un * comod\u00ed. 1.0.* \u00e9s l'equivalent de >=1.0 <1.1 . Exemple: 1.0.* Rang amb tilde (~) L'operador ~ s'explica millor en un exemple: ~1.2 \u00e9s equivalent a >=1.2 <2.0.0 , mentre que ~1.2.3 \u00e9s equivalent a >=1.2.3 <1.3.0 . Exemple: ~1.2 Rang de versi\u00f3 amb cimcurflex ( ^ ) Per exemple ^1.2.3 \u00e9s equivalent a >=1.2.3 <2.0.0 ja que ninguna de les releases fins a la 2.0 deuria trencar compatibilitat en versions anteriors. Exemple: ^1.2.3","title":"Limitar la versi\u00f3 dels paquets"},{"location":"06-composer/06-02-composer/#versionat-semantic-semver","text":"Els n\u00fameros de versi\u00f3 i la forma en que canvien informen sobre el que va ser modificat d'una versi\u00f3 a una altra. Veure l'especificaci\u00f3 en el seg\u00fcent document: http://semver.org/lang/es/","title":"Versionat sem\u00e0ntic (semver)"},{"location":"06-composer/06-02-composer/#installant-dependencies","text":"L\u2019ordre install comprova primer si existeix el fitxer composer.lock , i si existeix, desc\u00e0rrega exactament les versions que s'indiquen en aquest l'arxiu composer.lock . Si treballem en equip, tot l'equip tindr\u00e0 les mateixes versions. Executem la seg\u00fcent ordre: composer install Es generar\u00e0 el directori vendor/ amb les llibreries de les quals dep\u00e8n el projecte. directori vendor Hem d'afegir el directori vendor/ a l'arxiu .gitignore , perqu\u00e8 crea gran quantitat de fitxers que despr\u00e9s s'han de descarregar amb composer install . L\u2019ordre tamb\u00e9 crea un fitxer composer.lock","title":"Instal\u00b7lant depend\u00e8ncies"},{"location":"06-composer/06-02-composer/#actualitzar-versions","text":"Si tenim l'arxiu composer.lock sempre s'instal\u00b7laran les mateixes versions dels paquets. Per actualitzar a noves versions, fem servir l\u2019ordre composer update . Aquesta ordre fa que Composer busque les versions m\u00e9s recents de les llibreries sempre que segueixin complint les restriccions de les versions indicades a l'arxiu composer.json . Tamb\u00e9 actualitza l'arxiu composer.lock . Si nom\u00e9s volem instal\u00b7lar o actualitzar una depend\u00e8ncia, podem indicar el seu nom despr\u00e9s de l\u2019ordre: composer update monolog/monolog No actualitzar en producci\u00f3 Quan desplegues una aplicaci\u00f3 basada en Composer a producci\u00f3, usa sempre composer install . No haurieu d'usar mai composer update ja que podria ser que s'actualitzara algun paquet a una versi\u00f3 no provada.","title":"Actualitzar versions"},{"location":"06-composer/06-02-composer/#afegint-dependencies","text":"L\u2019ordre que afegeix noves depend\u00e8ncies en el arxiu composer.json : composer require Ens preguntar\u00e0 quines llibreries volem afegir. Despr\u00e9s d'afegir aquestes noves depend\u00e8ncies, s\u2019instal\u00b7len o actualitzen les depend\u00e8ncies que siguen necess\u00e0ries. Podem passar les noves depend\u00e8ncies com argument de l'ordre. composer require monolog/monolog:","title":"Afegint depend\u00e8ncies"},{"location":"06-composer/06-02-composer/#packagist","text":"Packagist \u00e9s el repositori central de paquets que pot gestionar Composer. Lloc Web: http://packagist.org","title":"Packagist"},{"location":"06-composer/06-02-composer/#carrega-automatica-de-classes","text":"Normalment les llibreries proporcionen informaci\u00f3 sobre la c\u00e0rrega autom\u00e0tica de les seves classes. Composer genera un arxiu vendor/autoload.php . Incloent aquest fitxer en el projecte, podem utilitzar qualsevol classe instal\u00b7lada a trav\u00e9s de Composer sense haver de incloure-la expl\u00edcitament: require 'vendor/autoload.php' ; En el nostre cas, afegirem el require anterior en el fitxer bootsrap.php . vendor/autoload.php autoload.php \u00e9s el punt d'entrada de l'aplicaci\u00f3 a totes les funcionalitats que ens oferix Composer .","title":"Carrega autom\u00e0tica de classes"},{"location":"06-composer/06-02-composer/#classes-personalitzades","text":"Podem emprar l\u2019 autoloader de Composer per a carregar les nostres classes. Si el nostre namespace \u00e9s App i els arxius estan en src afegirem: \"autoload\" : { \"psr-4\" : { \"App\\\\\" : \"src/\" } } Despr\u00e9s executarem composer dump-autoload perqu\u00e8 \u00e9s regenere vendor/autoload.php . PSR-4 PSR-4 ( PHP Standard Recommendation ) \u00e9s una de les recomanacions del PHP-FIG per a implementar el sistema de c\u00e0rrega autom\u00e0tica de classes. PHP-FIG ( Framework Interoperability Group ). La idea del grup \u00e9s que els representants del projecte parlen sobre els punts en com\u00fa entre els seus projectes i troben maneres de treballar junts.","title":"Classes personalitzades"},{"location":"06-composer/06-03-third-part/","text":"\u00das del paquet Monolog Per utilitzar la llibreria Monolog podem usar les seves classes i Composer s'encarregar\u00e0 de carregar-les: $log = new Monolog\\Logger ( 'name' ); $log -> pushHandler ( new Monolog\\Handler\\StreamHandler ( 'app.log' , Monolog\\Logger :: INFO ) ); $log\u2192info ( 'Foo' ); M\u00e9s informaci\u00f3: https://packagist.org/packages/monolog/monolog https://github.com/Seldaek/monolog/blob/HEAD/doc/01-usage.md","title":"\u00das del paquet Monolog"},{"location":"06-composer/06-03-third-part/#us-del-paquet-monolog","text":"Per utilitzar la llibreria Monolog podem usar les seves classes i Composer s'encarregar\u00e0 de carregar-les: $log = new Monolog\\Logger ( 'name' ); $log -> pushHandler ( new Monolog\\Handler\\StreamHandler ( 'app.log' , Monolog\\Logger :: INFO ) ); $log\u2192info ( 'Foo' ); M\u00e9s informaci\u00f3: https://packagist.org/packages/monolog/monolog https://github.com/Seldaek/monolog/blob/HEAD/doc/01-usage.md","title":"\u00das del paquet Monolog"},{"location":"06-composer/06-04-namespaces/","text":"Espais de noms ( namespaces ) En el m\u00f3n de PHP, els espais de noms estan dissenyats per a solucionar dos problemes amb qu\u00e8 es troben els autors de biblioteques i d'aplicacions en crear elements de codi reusable, com ara classes o funcions: El conflicte de noms entre el codi que es crea i les classes/funcions/constants internes de PHP o les classes/funcions/constants de tercers. La capacitat de sobrenomenar (o abreujar) Noms_Extra_Llargs dissenyada per alleugerir el primer problema, millorant la llegibilitat del codi font. Els espais de noms de PHP proporcionen una manera per agrupar classes, interf\u00edcies, funcions i constants relacionades. En la seva definici\u00f3 m\u00e9s acceptada, els espais de noms s\u00f3n una manera d'encapsular elements. Exemple: directoris en els sistemes de fitxers. El fitxer foo.txt pot existir en els directoris /home/Greg i /home/altre , per\u00f2 no poden coexistir dues c\u00f2pies de foo.txt en el mateix directori. A m\u00e9s, per accedir al fitxer foo.txt fora de directori /home/Greg , s'ha d'avantposar el nom de directori al nom del fitxer, emprant el separador de directoris per aix\u00ed obtenir /home/greg/foo.txt . Aquest mateix principi s'est\u00e9n als espais de noms en el m\u00f3n de la programaci\u00f3. Definir namespaces Usar namespaces Namespaces alias Namespaces i autoloading Per a entendre la relaci\u00f3 entre els espais de noms i la c\u00e0rrega autom\u00e0tica de classes res millor que anar a la font original: PSR-4 Autoloader","title":"Espais de noms (_namespaces_)"},{"location":"06-composer/06-04-namespaces/#espais-de-noms-namespaces","text":"En el m\u00f3n de PHP, els espais de noms estan dissenyats per a solucionar dos problemes amb qu\u00e8 es troben els autors de biblioteques i d'aplicacions en crear elements de codi reusable, com ara classes o funcions: El conflicte de noms entre el codi que es crea i les classes/funcions/constants internes de PHP o les classes/funcions/constants de tercers. La capacitat de sobrenomenar (o abreujar) Noms_Extra_Llargs dissenyada per alleugerir el primer problema, millorant la llegibilitat del codi font. Els espais de noms de PHP proporcionen una manera per agrupar classes, interf\u00edcies, funcions i constants relacionades. En la seva definici\u00f3 m\u00e9s acceptada, els espais de noms s\u00f3n una manera d'encapsular elements. Exemple: directoris en els sistemes de fitxers. El fitxer foo.txt pot existir en els directoris /home/Greg i /home/altre , per\u00f2 no poden coexistir dues c\u00f2pies de foo.txt en el mateix directori. A m\u00e9s, per accedir al fitxer foo.txt fora de directori /home/Greg , s'ha d'avantposar el nom de directori al nom del fitxer, emprant el separador de directoris per aix\u00ed obtenir /home/greg/foo.txt . Aquest mateix principi s'est\u00e9n als espais de noms en el m\u00f3n de la programaci\u00f3.","title":"Espais de noms (namespaces)"},{"location":"06-composer/06-04-namespaces/#definir-namespaces","text":"","title":"Definir namespaces"},{"location":"06-composer/06-04-namespaces/#usar-namespaces","text":"","title":"Usar namespaces"},{"location":"06-composer/06-04-namespaces/#namespaces-alias","text":"","title":"Namespaces alias"},{"location":"06-composer/06-04-namespaces/#namespaces-i-autoloading","text":"Per a entendre la relaci\u00f3 entre els espais de noms i la c\u00e0rrega autom\u00e0tica de classes res millor que anar a la font original: PSR-4 Autoloader","title":"Namespaces i autoloading"},{"location":"06-composer/06-05-tdd-intro/","text":"Introducci\u00f3 al testing Tests?! \u00a1No tinc temps per a aix\u00f2! Moltes vegades quan s'intenta ensenyar a fer proves o s'explica com aix\u00f2 millorar\u00e0 la qualitat del programari la resposta que obtenim \u00e9s \"No tinc temps per aix\u00f2\", \"L'aplicaci\u00f3 ja est\u00e0 en producci\u00f3, perqu\u00e8 provar-la ara?\" i altres respostes similars que s\u00f3n una mostra de que el testing no es compr\u00e8n correctament. No obstant aix\u00f2, en aquests mateixos ambients on se'ns diu que no hi ha temps per al testing , podem veure com els desenvolupadors fan servir gran part de la seva jornada laboral en fer proves i altres activitats que podrien ser minimitzades amb un bon conjunt de tests: Proves manuals. Debugging Compilacions I aquestes s\u00f3n les m\u00e9s \u00f2bvies. Per exemple, les proves manuals s\u00f3n molt lentes, tedioses i solen provar pocs casos. En el cas del debugging arriba a ser tedi\u00f3s i moltes vegades el problema que busquem \u00e9s dif\u00edcil de localitzar i, tanmateix, si hi hagu\u00e9s un Test Autom\u00e0tic haur\u00edem pogut detectar-ho de manera m\u00e9s r\u00e0pida i perdre aix\u00ed menys temps. \u00bfQu\u00e8 s\u00f3n els Test? Una definici\u00f3 que destaca per la seua simplicitat i concrecci\u00f3 \u00e9s la seg\u00fcent: Un test \u00e9s una especificaci\u00f3 de l'aplicaci\u00f3 Qu\u00e8 vol dir aix\u00f2? Doncs que un test \u00e9s simplement un requisit que, a part de definir-nos una necessitat fa una segona funci\u00f3 que consisteix a verificar que aquest es compleix . Anem a veure alguns exemples. Partim de la idea d'una funci\u00f3 que sume dos n\u00fameros: function sum ( int $a , int $b ){ return $a + $b ; } Quins serien els requisits d'aquesta funci\u00f3? Un primer requisit podria ser que, efectivament, la funci\u00f3n ha de sumar dos n\u00fameros qualsevols. Representant-ho com un test seria: function shouldAddAPairOfNumbers (){ return 5 === sum ( 2 , 3 ) } Un altre requisit podria ser que sume n\u00fameros negatius. Per assegurar que aquest requisit s'est\u00e0 complint, podem crear un altre test: function shouldAddNegativeNumbers (){ return 3 === sum ( 5 , - 2 ) } En els anteriors exemples hem vist el que b\u00e0sicament \u00e9s un test (unitari en aquest cas): una funci\u00f3 que comprova que una caracter\u00edstica o especificaci\u00f3 de l'aplicaci\u00f3 es compleix. Altres definicions m\u00e9s acad\u00e8miques s\u00f3n: El Testing de Software es una investigaci\u00f3 dirigida a proporcionar a les parts interessades ( stakeholders ) informaci\u00f3 sobre la qualitat del producte o servei que est\u00e0 provant-se. Kaner, Cem (November 17, 2006). Exploratory Testing. Quality Assurance Institute Worldwide Annual Software Testing Conference . Orlando, FL. Retrieved November 22, 2014. En el camp del testing de programari, l'automatizaci\u00f3n de test \u00e9s l'uso de programari (separat del que s'est\u00e0 provant) per a controlar l'execuci\u00f3 de les proves i la comparaci\u00f3 dels resultats reals amb els previstos Kolawa, Adam; Huizinga, Dorota (2007). Automated Defect Prevention: Best Practices in Software Management . Wiley-IEEE Computer Society Press. Avantatges dels Test Els test es poden executar, els requisits no. Aix\u00f2 ens permet mantindre un cert grau de qualitat en el funcionament de la nostra aplicaci\u00f3 al llarg de tot el desenvolupament. Es pot executar diverses vegades. Quan realitzem proves a m\u00e0 moltes vegades per f\u00e0stig o el repetitiu del proc\u00e9s acabem provant sempre el mateix o fins i tot podem trobar un error i no recordar quins par\u00e0metres usem per a reproduir-lo. En executar-los provem altres funcionalitats. Quan provem a m\u00e0 una caracter\u00edstica de l'aplicaci\u00f3 moltes vegades no som conscients de l'abast d'aquesta, no obstant aix\u00f2, si tenim una bona bateria de Tests \u00e9s altament probable que en executar-los estiguem provant altres \u00e0rees de l'aplicaci\u00f3 que es poden veure compromeses amb els nostres canvis. Eviten que molts bugs arriben a producci\u00f3. Quan s'introdueixen fallades en el programari sense tindre Tests \u00e9s com\u00fa que aquests arriben fins a l'entorn productiu i passen latents mesos fins que un usuari o proc\u00e9s, amb els par\u00e0metres adequats, provoque l'error i isca a la llum (provocant perdudes d'usuaris, benefici per a l'empresa de programari, etc). Tenint Tests podrem minimitzar notablement aquest tipus de situacions. Hi ha molts m\u00e9s avantatges per\u00f2 aquestes s\u00f3n algunes de les m\u00e9s notables. Tipus de proves Existeixen multitud de casos de Test, ac\u00ed n'introduirem uns pocs i els acompanyarem d'una xicoteta explicaci\u00f3. \u00c9s important aclarir que sol haver-hi un error en la denominaci\u00f3 general, desembocant en una definici\u00f3 err\u00f2nia del que \u00e9s un test funcional . En el seg\u00fcent llistat podrem veure diferents test funcionals (ja que proven funcionalitat del nostre programari). Test Unitaris : S'encarreguen de provar una unitat de codi de forma a\u00efllada. Aquesta unitat no ha d'estar lligada a cap mena d'entrada/eixida (ja siga aquesta una base de dades, disc...). S\u00f3n les proves m\u00e9s concretes i les m\u00e9s r\u00e0pides, per aix\u00f2 tendeixen a ser els m\u00e9s nombrosos. Integraci\u00f3 : Proven una unitat per\u00f2 permetent contacte amb entrada/eixida. S\u00f3n mitjanament r\u00e0pids per\u00f2 no tant com els unitaris. Tamb\u00e9 es poden considerar test d'integraci\u00f3 (o de Components/Sistema) els que proven diferents parts del programari interdependent entre s\u00ed. Intef\u00edcie d'usuari (UI) : S\u00f3n els test que fan comprovacions sobre la base de la interf\u00edcie d'usuari del nostre sistema. End to End (e2e) : Test que comproven la nostra aplicaci\u00f3 de punta a punta. \u00c9s a dir, des de la interacci\u00f3 de l'Usuari o l'Actor que desencadene l'execuci\u00f3 del programari fins que se li retorna algun tipus de resposta. Al costat dels de UI s\u00f3n els m\u00e9s costosos (dels automatitzats) ja que solen implicar al\u00e7ar serveis, bases de dades i fins i tot navegadors per a simular la petici\u00f3. Manuals : S\u00f3n tamb\u00e9 funcionals ja que proven el mateix que els de UI o EndToEnd per\u00f2 en lloc de ser executats per un codi que interactua amb una API o un navegador s\u00f3n executats per un hum\u00e0 amb la conseq\u00fcent lentitud extra. Solen ser limitats pel cost monetari i de temps, limitant-se a uns certs tipus com a Test d'Exploraci\u00f3 o Monkey Testing . I quins s\u00f3n els test no funcionals? S\u00f3n test que no proven funcionalitats de l'aplicaci\u00f3 si no que ens asseguren un altre tipus de comportaments. A continuaci\u00f3 llistem alguns: - Test d'Estr\u00e9s: Comproven el rendiment de la nostra aplicaci\u00f3 sota estr\u00e9s. - Test de C\u00e0rrega: Comproven on est\u00e0 el l\u00edmit de c\u00e0rrega de la nostra aplicaci\u00f3. - Test d'Escalabilitat: Comproven que l'aplicaci\u00f3 escala correctament. \u00c9s \u00fatil en aplicacions Distribu\u00efdes, *Serverless... Hi ha molts m\u00e9s tipus de Test, tant funcionals com no funcionals per\u00f2 hem nomenat els m\u00e9s coneguts i comuns. Test Manuals en el flux de desenvolupament Donat un formulari com el de la seg\u00fcent imatge i assumint que no tenim test automatitzats i sols fem test manuals: Quants noms serem capa\u00e7os de provar per a assegurar el correcte funcionament? Podrem cerciorar-nos que provem suficients DNIs? I dates? El m\u00e9s probable \u00e9s que provem tres o quatre diferents casos durant el desenvolupament i altres punts al final d'aquest per a comprovar que la funcionalitat s'executa aparentment sense problemes. Problemes dels test manuals Necessitem que l'aplicaci\u00f3 siga funcional. Fins que l'aplicaci\u00f3 no siga executable d'alguna manera no podrem realitzar cap prova. Necessitem configurar depend\u00e8ncies, dades inicials, infraestructura (base de dades, configuracions...) Provem una quantitat de casos bastant limitat. Amb Test automatitzats podr\u00edem aconseguir que es proven un rang de valors aleatoris o que el valor que s'use en la prova canvie amb cada execuci\u00f3, etc. \u00c9s dif\u00edcil repetir tests i encara m\u00e9s realitzar proves anteriors. Amb els test manuals es dificulta el poder passar casos de prova d'una altra persona, implicant documents, processos, etc amb la lentitud que aix\u00f2 provoca i la inviabilitat d'introduir-ho en el proc\u00e9s de desenvolupament. Caracter\u00edstiques dels tests unitaris Els test unitaris proven una unitat de codi o System Under Test(SUT) . En l'exemple que v\u00e8iem a l'inici prov\u00e0vem una funci\u00f3 que sumava dos n\u00fameros. Aquesta unitat es prova de forma a\u00efllada. Si la unitat sota test tinguera algun tipus de depend\u00e8ncia haur\u00edem de falsejar-la. El mateix si necessitara accedir a alguna mena de base de dades o similar. D'aquesta aconseguirem independ\u00e8ncia per a la prova de la unitat que ens resulta d'inter\u00e9s en el test. Utilitzen dobles de test ( Test Doubles ) . Per a realitzar el que comentem en l'anterior pas podem fer \u00fas de dobles de tests. Aquest concepte represensta els objectes, classes o funcions que falsegen a la seua contrapart real per a enganyar la unitat sota proves i obtindre el comportament que ens interessa assegurar. En la seg\u00fcent imatge veiem com creem objectes que falsegen cert comportament per a provar el que ens interessa, en aquest cas que si creem un \"Conductor\" a partir de un objecte \"User\" menor d'edat, obtenim una Excepci\u00f3. public function testOnlyAdultCanDrive (){ $this -> expectException ( MinorsAreNotAllowedToDrive :: class ); $userStub = $this -> createMock ( User :: class ); $userStub -> method ( 'getAge' ) -> willReturn ( 16 ); $carStub = $this -> createMock ( Car :: class ); new Drive ( $userMock , $carStub ); } S\u00f3n r\u00e0pids . Una bateria de milers de Test Unitaris pot executar-se en q\u00fcesti\u00f3 de minuts. Aix\u00f2 permet que siga f\u00e0cil d'incorporar al proc\u00e9s de desenvolupament i s'executen amb cada canvi que realitzem. S\u00f3n repetibles . En estar programats podem repetir un mateix test les vegades que siga necessari. Comproven que res s'haja trencat \u00c9s a dir, comproven que els canvis que introdu\u00efm no afecten altres parts de l'aplicaci\u00f3. Feedback Loop m\u00e9s curt . Per la seua velocitat i la possibilitat d'executar-los cada poc temps acurten el temps que passa des que s'introdueix un bug en el programari fins que aquest \u00e9s detectat i solucionat. Pipelines de CI, Hooks... Donada la seua velocitat d'execuci\u00f3 aquest tipus de test \u00e9s perfecte per a ser introdu\u00eft en una Pipeline d'Integraci\u00f3 Cont\u00ednua o un Hook de Git que, per exemple, controle que abans de fer un push dels canvis al servidor passen tots els test. Faciliten el codi desacoblat . Com veurem resulta molt m\u00e9s f\u00e0cil provar codi desacoblat pel que si ens acostumem a fer test Unitaris el nostre codi acabar\u00e0 sent m\u00e9s desacoblat. *refactoritzar sense por de trencar alguna cosa . Tindre una bona bateria de Tests ens permet fer refactoring sense tindre p\u00e0nic al fet que es trenquen altres parts de l'aplicaci\u00f3. Si es donara el cas un test fallaria i immediatament podr\u00edem veure com \u00e9s el problema i actuar en conseq\u00fc\u00e8ncia. Pir\u00e0mide de Test i Gelat de Test En la seg\u00fcent imatge veiem una contraposici\u00f3 de dues distribucions de Test. En l'esquerra podem veure el que es coneix com a \"Gelat de Testing\", en el qual abunden els test manuals i els pocs que hi ha automatitzats s\u00f3n els test End to End o de UI . El Testing ice-cream \u00e9s un antipatr\u00f3 de Testing (en la majoria de casos) en el qual s\u00f3n nombrosos els test que m\u00e9s costa realitzar i brillen per la seua abs\u00e8ncia els Test m\u00e9s lleugers i r\u00e0pids (integraci\u00f3 i, sobretot, unitaris). A la dreta tenim la Pir\u00e0mide de Test. Ac\u00ed podem veure com els test m\u00e9s abundants s\u00f3n Unitaris i d'Integraci\u00f3, els m\u00e9s r\u00e0pids, mentre que el n\u00famero de test lents com els d'Acceptaci\u00f3 \u00e9s molt menor i els test manuals estan reservats a test Exploratoris. Introducci\u00f3 a TDD Desenvolupament guiat per proves de programari, en angl\u00e8s: Test-driven development (TDD) , \u00e9s una pr\u00e0ctica d'enginyeria de programari que involucra unes altres dues pr\u00e0ctiques: Escriure les proves primer ( Test First Development ) i Refacci\u00f3 ( Refactoring ). Per escriure les proves generalment s'utilitzen les proves unit\u00e0ries (unit test en angl\u00e8s). En primer lloc, s'escriu una prova i es verifica que les proves fallen. A continuaci\u00f3, s'implementa el codi que fa que la prova passi satisfact\u00f2riament i seguidament es refacciona el codi escrit. El prop\u00f2sit del desenvolupament guiat per proves \u00e9s aconseguir un codi net que funcioni. La idea \u00e9s que els requisits siguin tradu\u00efts a proves, d'aquesta manera, quan les proves passin es garantir\u00e0 que el programari compleix amb els requisits que s'han establert. Com que no \u00e9s l'objectiu d'aquest curs aprofundir trobarem m\u00e9s informaci\u00f3 en els seg\u00fcents recursos: Desenvolupament guiat per proves. (2021, 19 de novembre). Viquip\u00e8dia, l'Enciclop\u00e8dia Lliure . Data de consulta: 21:25, novembre 19, 2021 de //ca.wikipedia.org/w/index.php?title=Desenvolupament_guiat_per_proves&oldid=28627832 . La kata del DNI para aprendre TDD. (2018, 12 de desembre). Fran Iglesias . https://franiglesias.github.io/iniciacion-tdd/ . Curso Testing. Andros Fenollosa https://programadorwebvalencia.com/cursos/testing/introducci%C3%B3n/","title":"Introducci\u00f3 al testing"},{"location":"06-composer/06-05-tdd-intro/#introduccio-al-testing","text":"","title":"Introducci\u00f3 al testing"},{"location":"06-composer/06-05-tdd-intro/#tests-no-tinc-temps-per-a-aixo","text":"Moltes vegades quan s'intenta ensenyar a fer proves o s'explica com aix\u00f2 millorar\u00e0 la qualitat del programari la resposta que obtenim \u00e9s \"No tinc temps per aix\u00f2\", \"L'aplicaci\u00f3 ja est\u00e0 en producci\u00f3, perqu\u00e8 provar-la ara?\" i altres respostes similars que s\u00f3n una mostra de que el testing no es compr\u00e8n correctament. No obstant aix\u00f2, en aquests mateixos ambients on se'ns diu que no hi ha temps per al testing , podem veure com els desenvolupadors fan servir gran part de la seva jornada laboral en fer proves i altres activitats que podrien ser minimitzades amb un bon conjunt de tests: Proves manuals. Debugging Compilacions I aquestes s\u00f3n les m\u00e9s \u00f2bvies. Per exemple, les proves manuals s\u00f3n molt lentes, tedioses i solen provar pocs casos. En el cas del debugging arriba a ser tedi\u00f3s i moltes vegades el problema que busquem \u00e9s dif\u00edcil de localitzar i, tanmateix, si hi hagu\u00e9s un Test Autom\u00e0tic haur\u00edem pogut detectar-ho de manera m\u00e9s r\u00e0pida i perdre aix\u00ed menys temps.","title":"Tests?! \u00a1No tinc temps per a aix\u00f2!"},{"location":"06-composer/06-05-tdd-intro/#que-son-els-test","text":"Una definici\u00f3 que destaca per la seua simplicitat i concrecci\u00f3 \u00e9s la seg\u00fcent: Un test \u00e9s una especificaci\u00f3 de l'aplicaci\u00f3 Qu\u00e8 vol dir aix\u00f2? Doncs que un test \u00e9s simplement un requisit que, a part de definir-nos una necessitat fa una segona funci\u00f3 que consisteix a verificar que aquest es compleix . Anem a veure alguns exemples. Partim de la idea d'una funci\u00f3 que sume dos n\u00fameros: function sum ( int $a , int $b ){ return $a + $b ; } Quins serien els requisits d'aquesta funci\u00f3? Un primer requisit podria ser que, efectivament, la funci\u00f3n ha de sumar dos n\u00fameros qualsevols. Representant-ho com un test seria: function shouldAddAPairOfNumbers (){ return 5 === sum ( 2 , 3 ) } Un altre requisit podria ser que sume n\u00fameros negatius. Per assegurar que aquest requisit s'est\u00e0 complint, podem crear un altre test: function shouldAddNegativeNumbers (){ return 3 === sum ( 5 , - 2 ) } En els anteriors exemples hem vist el que b\u00e0sicament \u00e9s un test (unitari en aquest cas): una funci\u00f3 que comprova que una caracter\u00edstica o especificaci\u00f3 de l'aplicaci\u00f3 es compleix. Altres definicions m\u00e9s acad\u00e8miques s\u00f3n: El Testing de Software es una investigaci\u00f3 dirigida a proporcionar a les parts interessades ( stakeholders ) informaci\u00f3 sobre la qualitat del producte o servei que est\u00e0 provant-se. Kaner, Cem (November 17, 2006). Exploratory Testing. Quality Assurance Institute Worldwide Annual Software Testing Conference . Orlando, FL. Retrieved November 22, 2014. En el camp del testing de programari, l'automatizaci\u00f3n de test \u00e9s l'uso de programari (separat del que s'est\u00e0 provant) per a controlar l'execuci\u00f3 de les proves i la comparaci\u00f3 dels resultats reals amb els previstos Kolawa, Adam; Huizinga, Dorota (2007). Automated Defect Prevention: Best Practices in Software Management . Wiley-IEEE Computer Society Press.","title":"\u00bfQu\u00e8 s\u00f3n els Test?"},{"location":"06-composer/06-05-tdd-intro/#avantatges-dels-test","text":"Els test es poden executar, els requisits no. Aix\u00f2 ens permet mantindre un cert grau de qualitat en el funcionament de la nostra aplicaci\u00f3 al llarg de tot el desenvolupament. Es pot executar diverses vegades. Quan realitzem proves a m\u00e0 moltes vegades per f\u00e0stig o el repetitiu del proc\u00e9s acabem provant sempre el mateix o fins i tot podem trobar un error i no recordar quins par\u00e0metres usem per a reproduir-lo. En executar-los provem altres funcionalitats. Quan provem a m\u00e0 una caracter\u00edstica de l'aplicaci\u00f3 moltes vegades no som conscients de l'abast d'aquesta, no obstant aix\u00f2, si tenim una bona bateria de Tests \u00e9s altament probable que en executar-los estiguem provant altres \u00e0rees de l'aplicaci\u00f3 que es poden veure compromeses amb els nostres canvis. Eviten que molts bugs arriben a producci\u00f3. Quan s'introdueixen fallades en el programari sense tindre Tests \u00e9s com\u00fa que aquests arriben fins a l'entorn productiu i passen latents mesos fins que un usuari o proc\u00e9s, amb els par\u00e0metres adequats, provoque l'error i isca a la llum (provocant perdudes d'usuaris, benefici per a l'empresa de programari, etc). Tenint Tests podrem minimitzar notablement aquest tipus de situacions. Hi ha molts m\u00e9s avantatges per\u00f2 aquestes s\u00f3n algunes de les m\u00e9s notables.","title":"Avantatges dels Test"},{"location":"06-composer/06-05-tdd-intro/#tipus-de-proves","text":"Existeixen multitud de casos de Test, ac\u00ed n'introduirem uns pocs i els acompanyarem d'una xicoteta explicaci\u00f3. \u00c9s important aclarir que sol haver-hi un error en la denominaci\u00f3 general, desembocant en una definici\u00f3 err\u00f2nia del que \u00e9s un test funcional . En el seg\u00fcent llistat podrem veure diferents test funcionals (ja que proven funcionalitat del nostre programari). Test Unitaris : S'encarreguen de provar una unitat de codi de forma a\u00efllada. Aquesta unitat no ha d'estar lligada a cap mena d'entrada/eixida (ja siga aquesta una base de dades, disc...). S\u00f3n les proves m\u00e9s concretes i les m\u00e9s r\u00e0pides, per aix\u00f2 tendeixen a ser els m\u00e9s nombrosos. Integraci\u00f3 : Proven una unitat per\u00f2 permetent contacte amb entrada/eixida. S\u00f3n mitjanament r\u00e0pids per\u00f2 no tant com els unitaris. Tamb\u00e9 es poden considerar test d'integraci\u00f3 (o de Components/Sistema) els que proven diferents parts del programari interdependent entre s\u00ed. Intef\u00edcie d'usuari (UI) : S\u00f3n els test que fan comprovacions sobre la base de la interf\u00edcie d'usuari del nostre sistema. End to End (e2e) : Test que comproven la nostra aplicaci\u00f3 de punta a punta. \u00c9s a dir, des de la interacci\u00f3 de l'Usuari o l'Actor que desencadene l'execuci\u00f3 del programari fins que se li retorna algun tipus de resposta. Al costat dels de UI s\u00f3n els m\u00e9s costosos (dels automatitzats) ja que solen implicar al\u00e7ar serveis, bases de dades i fins i tot navegadors per a simular la petici\u00f3. Manuals : S\u00f3n tamb\u00e9 funcionals ja que proven el mateix que els de UI o EndToEnd per\u00f2 en lloc de ser executats per un codi que interactua amb una API o un navegador s\u00f3n executats per un hum\u00e0 amb la conseq\u00fcent lentitud extra. Solen ser limitats pel cost monetari i de temps, limitant-se a uns certs tipus com a Test d'Exploraci\u00f3 o Monkey Testing .","title":"Tipus de proves"},{"location":"06-composer/06-05-tdd-intro/#test-manuals-en-el-flux-de-desenvolupament","text":"Donat un formulari com el de la seg\u00fcent imatge i assumint que no tenim test automatitzats i sols fem test manuals: Quants noms serem capa\u00e7os de provar per a assegurar el correcte funcionament? Podrem cerciorar-nos que provem suficients DNIs? I dates? El m\u00e9s probable \u00e9s que provem tres o quatre diferents casos durant el desenvolupament i altres punts al final d'aquest per a comprovar que la funcionalitat s'executa aparentment sense problemes.","title":"Test Manuals en el flux de desenvolupament"},{"location":"06-composer/06-05-tdd-intro/#problemes-dels-test-manuals","text":"Necessitem que l'aplicaci\u00f3 siga funcional. Fins que l'aplicaci\u00f3 no siga executable d'alguna manera no podrem realitzar cap prova. Necessitem configurar depend\u00e8ncies, dades inicials, infraestructura (base de dades, configuracions...) Provem una quantitat de casos bastant limitat. Amb Test automatitzats podr\u00edem aconseguir que es proven un rang de valors aleatoris o que el valor que s'use en la prova canvie amb cada execuci\u00f3, etc. \u00c9s dif\u00edcil repetir tests i encara m\u00e9s realitzar proves anteriors. Amb els test manuals es dificulta el poder passar casos de prova d'una altra persona, implicant documents, processos, etc amb la lentitud que aix\u00f2 provoca i la inviabilitat d'introduir-ho en el proc\u00e9s de desenvolupament.","title":"Problemes dels test manuals"},{"location":"06-composer/06-05-tdd-intro/#caracteristiques-dels-tests-unitaris","text":"Els test unitaris proven una unitat de codi o System Under Test(SUT) . En l'exemple que v\u00e8iem a l'inici prov\u00e0vem una funci\u00f3 que sumava dos n\u00fameros. Aquesta unitat es prova de forma a\u00efllada. Si la unitat sota test tinguera algun tipus de depend\u00e8ncia haur\u00edem de falsejar-la. El mateix si necessitara accedir a alguna mena de base de dades o similar. D'aquesta aconseguirem independ\u00e8ncia per a la prova de la unitat que ens resulta d'inter\u00e9s en el test. Utilitzen dobles de test ( Test Doubles ) . Per a realitzar el que comentem en l'anterior pas podem fer \u00fas de dobles de tests. Aquest concepte represensta els objectes, classes o funcions que falsegen a la seua contrapart real per a enganyar la unitat sota proves i obtindre el comportament que ens interessa assegurar. En la seg\u00fcent imatge veiem com creem objectes que falsegen cert comportament per a provar el que ens interessa, en aquest cas que si creem un \"Conductor\" a partir de un objecte \"User\" menor d'edat, obtenim una Excepci\u00f3. public function testOnlyAdultCanDrive (){ $this -> expectException ( MinorsAreNotAllowedToDrive :: class ); $userStub = $this -> createMock ( User :: class ); $userStub -> method ( 'getAge' ) -> willReturn ( 16 ); $carStub = $this -> createMock ( Car :: class ); new Drive ( $userMock , $carStub ); } S\u00f3n r\u00e0pids . Una bateria de milers de Test Unitaris pot executar-se en q\u00fcesti\u00f3 de minuts. Aix\u00f2 permet que siga f\u00e0cil d'incorporar al proc\u00e9s de desenvolupament i s'executen amb cada canvi que realitzem. S\u00f3n repetibles . En estar programats podem repetir un mateix test les vegades que siga necessari. Comproven que res s'haja trencat \u00c9s a dir, comproven que els canvis que introdu\u00efm no afecten altres parts de l'aplicaci\u00f3. Feedback Loop m\u00e9s curt . Per la seua velocitat i la possibilitat d'executar-los cada poc temps acurten el temps que passa des que s'introdueix un bug en el programari fins que aquest \u00e9s detectat i solucionat. Pipelines de CI, Hooks... Donada la seua velocitat d'execuci\u00f3 aquest tipus de test \u00e9s perfecte per a ser introdu\u00eft en una Pipeline d'Integraci\u00f3 Cont\u00ednua o un Hook de Git que, per exemple, controle que abans de fer un push dels canvis al servidor passen tots els test. Faciliten el codi desacoblat . Com veurem resulta molt m\u00e9s f\u00e0cil provar codi desacoblat pel que si ens acostumem a fer test Unitaris el nostre codi acabar\u00e0 sent m\u00e9s desacoblat. *refactoritzar sense por de trencar alguna cosa . Tindre una bona bateria de Tests ens permet fer refactoring sense tindre p\u00e0nic al fet que es trenquen altres parts de l'aplicaci\u00f3. Si es donara el cas un test fallaria i immediatament podr\u00edem veure com \u00e9s el problema i actuar en conseq\u00fc\u00e8ncia.","title":"Caracter\u00edstiques dels tests unitaris"},{"location":"06-composer/06-05-tdd-intro/#piramide-de-test-i-gelat-de-test","text":"En la seg\u00fcent imatge veiem una contraposici\u00f3 de dues distribucions de Test. En l'esquerra podem veure el que es coneix com a \"Gelat de Testing\", en el qual abunden els test manuals i els pocs que hi ha automatitzats s\u00f3n els test End to End o de UI . El Testing ice-cream \u00e9s un antipatr\u00f3 de Testing (en la majoria de casos) en el qual s\u00f3n nombrosos els test que m\u00e9s costa realitzar i brillen per la seua abs\u00e8ncia els Test m\u00e9s lleugers i r\u00e0pids (integraci\u00f3 i, sobretot, unitaris). A la dreta tenim la Pir\u00e0mide de Test. Ac\u00ed podem veure com els test m\u00e9s abundants s\u00f3n Unitaris i d'Integraci\u00f3, els m\u00e9s r\u00e0pids, mentre que el n\u00famero de test lents com els d'Acceptaci\u00f3 \u00e9s molt menor i els test manuals estan reservats a test Exploratoris.","title":"Pir\u00e0mide de Test i Gelat de Test"},{"location":"06-composer/06-05-tdd-intro/#introduccio-a-tdd","text":"Desenvolupament guiat per proves de programari, en angl\u00e8s: Test-driven development (TDD) , \u00e9s una pr\u00e0ctica d'enginyeria de programari que involucra unes altres dues pr\u00e0ctiques: Escriure les proves primer ( Test First Development ) i Refacci\u00f3 ( Refactoring ). Per escriure les proves generalment s'utilitzen les proves unit\u00e0ries (unit test en angl\u00e8s). En primer lloc, s'escriu una prova i es verifica que les proves fallen. A continuaci\u00f3, s'implementa el codi que fa que la prova passi satisfact\u00f2riament i seguidament es refacciona el codi escrit. El prop\u00f2sit del desenvolupament guiat per proves \u00e9s aconseguir un codi net que funcioni. La idea \u00e9s que els requisits siguin tradu\u00efts a proves, d'aquesta manera, quan les proves passin es garantir\u00e0 que el programari compleix amb els requisits que s'han establert. Com que no \u00e9s l'objectiu d'aquest curs aprofundir trobarem m\u00e9s informaci\u00f3 en els seg\u00fcents recursos: Desenvolupament guiat per proves. (2021, 19 de novembre). Viquip\u00e8dia, l'Enciclop\u00e8dia Lliure . Data de consulta: 21:25, novembre 19, 2021 de //ca.wikipedia.org/w/index.php?title=Desenvolupament_guiat_per_proves&oldid=28627832 . La kata del DNI para aprendre TDD. (2018, 12 de desembre). Fran Iglesias . https://franiglesias.github.io/iniciacion-tdd/ . Curso Testing. Andros Fenollosa https://programadorwebvalencia.com/cursos/testing/introducci%C3%B3n/","title":"Introducci\u00f3 a TDD"},{"location":"06-composer/06-98-notes-on-model-layer/","text":"Notes on model layer implementation https://stackoverflow.com/questions/48805723/repository-and-data-mapper-coupling The db operations should be performed through adapters (MySqliAdapter, PdoAdapter, etc). So, the db connections are injected into adapters, not into the mappers. And certainly not in the repositories, because then the abstraction purpose of the repositories would be pointless. A mapper receives adapter(s) as dependencies and can receive other mappers too. The mappers are passed as dependencies to the repositories. A repository name is semantically related to the domain layer names, not really to the ones of the service layer. E.g: \"InputService\": ok. \"InputRepository\": wrong. \"CountryRepository\": correct. A service can receive more repositories. Or mappers, if you don't want to apply the extra layer of repositories. In the code, the only tightly coupled structure is the Country object (entity or domain object) - dynamically created for each fetched table row. Even this could be avoided through the use of a domain objects factory, but I, personally, don't see it really necessary. P.S: Sorry for not providing a more documented code. Service class InputService { private $countryRepository ; private $productRepository ; public function __construct ( CountryRepositoryInterface $countryRepository , ProductRepositoryInterface $productRepository ) { $this -> countryRepository = $countryRepository ; $this -> productRepository = $productRepository ; } public function getInitialData () { $products = $this -> productRepository -> findAll (); $country = $this -> countryRepository -> findByName ( 'England' ); //... return // resulted data } } Repository class CountryRepository implements CountryRepositoryInterface { private $countryMapper ; public function __construct ( CountryMapperInterface $countryMapper ) { $this -> countryMapper = $countryMapper ; } public function findByPrefix ( $prefix ) { return $this -> countryMapper -> find ([ 'prefix' => $prefix ]); } public function findByName ( $name ) { return $this -> countryMapper -> find ([ 'name' => $name ]); } public function findAll () { return $this -> countryMapper -> find (); } public function store ( CountryInterface $country ) { return $this -> countryMapper -> save ( $country ); } public function remove ( CountryInterface $country ) { return $this -> countryMapper -> delete ( $country ); } } Data mapper class CountryMapper implements CountryMapperInterface { private $adapter ; private $countryCollection ; public function __construct ( AdapterInterface $adapter , CountryCollectionInterface $countryCollection ) { $this -> adapter = $adapter ; $this -> countryCollection = $countryCollection ; } public function find ( array $filter = [], $one = FALSE ) { // If $one is TRUE then add limit to sql statement, or so... $rows = $this -> adapter -> find ( $sql , $bindings ); // If $one is TRUE return a domain object, else a domain objects list. if ( $one ) { return $this -> createCountry ( $row [ 0 ]); } return $this -> createCountryCollection ( $rows ); } public function save ( CountryInterface $country ) { if ( NULL === $country -> id ) { // Build the INSERT statement and the bindings array... $this -> adapter -> insert ( $sql , $bindings ); $lastInsertId = $this -> adapter -> getLastInsertId (); return $this -> find ([ 'id' => $lastInsertId ], true ); } // Build the UPDATE statement and the bindings array... $this -> adapter -> update ( $sql , $bindings ); return $this -> find ([ 'id' => $country -> id ], true ); } public function delete ( CountryInterface $country ) { $sql = 'DELETE FROM countries WHERE id=:id' ; $bindings = [ ':id' => $country -> id ]; $rowCount = $this -> adapter -> delete ( $sql , $bindings ); return $rowCount > 0 ; } // Create a Country (domain object) from row. public function createCountry ( array $row = []) { $country = new Country (); /* * Iterate through the row items. * Assign a property to Country object for each item's name/value. */ return $country ; } // Create a Country[] list from rows list. public function createCountryCollection ( array $rows ) { /* * Iterate through rows. * Create a Country object for each row, with column names/values as properties. * Push Country object object to collection. * Return collection's content. */ return $this -> countryCollection -> all (); } } Db adapter class PdoAdapter implements AdapterInterface { private $connection ; public function __construct ( PDO $connection ) { $this -> connection = $connection ; } public function find ( string $sql , array $bindings = [], int $fetchMode = PDO :: FETCH_ASSOC , $fetchArgument = NULL , array $fetchConstructorArguments = []) { $statement = $this -> connection -> prepare ( $sql ); $statement -> execute ( $bindings ); return $statement -> fetchAll ( $fetchMode , $fetchArgument , $fetchConstructorArguments ); } //... } Domain objects collection class CountryCollection implements CountryCollectionInterface { private $countries = []; public function push ( CountryInterface $country ) { $this -> countries [] = $country ; return $this ; } public function all () { return $this -> countries ; } public function getIterator () { return new ArrayIterator ( $this -> countries ); } //... } Domain object class Country implements CountryInterface { // Business logic: properties and methods... } DataMapper is a layer to isolate an application from a concrete database. It transforms an object into a record of a database and a record into an object. DataMapper gives us the ability to work with Database and be unaware of what RDBMS we use. Example: interface DataMapperInterface { /** * Find objects by a criteria * * @param array $criteria Search params * @return Quote[] Found entities */ public function find ( array $criteria ); /** * Insert an object into a database * * @param Quote $object Object that will be inserted */ public function insert ( Quote $object ); /** * Update an object date in a database * * @param Quote $object Object that will be updated */ public function update ( Quote $object ); /** * Remove an object from a database * * @param Quote $object Object that will be removed */ public function delete ( Quote $object ); } Repository is a layer for encapsulation of logic of a query building. It gives us the ability to work with a collection of objects and be unaware to work with Database anything. class Repository { /** * @var DataMapperInterface Mapper to transform objects */ protected $mapper ; /** * Constructor * * @param DataMapperInterface $mapper Mapper to transform objects */ public function __construct ( DataMapperInterface $mapper ) { $this -> mapper = $mapper ; } /** * Find all objects * * @return Quote[] Found entities */ public function findAll () { return $this -> mapper -> find ([]); } /** * Find an object by an identifier * * @return Quote[] Found entities */ public function findById ( integer $id ) { $criteria = [ 'id' => $id ]; return $this -> mapper -> find ( $criteria ); } /** * Find objects by an author name * * @return Quote[] Found entities */ public function findByAuthor ( $name ) { $criteria = [ 'author' => $name ]; return $this -> mapper -> find ( $criteria ); } /** * Save an object into the repository */ public function save ( Quote $object ) { if ( empty ( $object -> id )) { $this -> mapper -> insert ( $object ); } else { $this -> mapper -> update ( $object ); } a } /** * Remove an object from the repository */ public function remove ( Quote $object ) { $this -> mapper -> delete ( $object ); } } This is the very simple instance and all is more difficult in a real application: queries are bigger, repository can cooperate with many other patterns (Query Object to query building, Unit of Work to track changes, Identity Map to avoid repeatedly-load of objects, etc.)","title":"Notes on model layer implementation"},{"location":"06-composer/06-98-notes-on-model-layer/#notes-on-model-layer-implementation","text":"https://stackoverflow.com/questions/48805723/repository-and-data-mapper-coupling The db operations should be performed through adapters (MySqliAdapter, PdoAdapter, etc). So, the db connections are injected into adapters, not into the mappers. And certainly not in the repositories, because then the abstraction purpose of the repositories would be pointless. A mapper receives adapter(s) as dependencies and can receive other mappers too. The mappers are passed as dependencies to the repositories. A repository name is semantically related to the domain layer names, not really to the ones of the service layer. E.g: \"InputService\": ok. \"InputRepository\": wrong. \"CountryRepository\": correct. A service can receive more repositories. Or mappers, if you don't want to apply the extra layer of repositories. In the code, the only tightly coupled structure is the Country object (entity or domain object) - dynamically created for each fetched table row. Even this could be avoided through the use of a domain objects factory, but I, personally, don't see it really necessary. P.S: Sorry for not providing a more documented code. Service class InputService { private $countryRepository ; private $productRepository ; public function __construct ( CountryRepositoryInterface $countryRepository , ProductRepositoryInterface $productRepository ) { $this -> countryRepository = $countryRepository ; $this -> productRepository = $productRepository ; } public function getInitialData () { $products = $this -> productRepository -> findAll (); $country = $this -> countryRepository -> findByName ( 'England' ); //... return // resulted data } } Repository class CountryRepository implements CountryRepositoryInterface { private $countryMapper ; public function __construct ( CountryMapperInterface $countryMapper ) { $this -> countryMapper = $countryMapper ; } public function findByPrefix ( $prefix ) { return $this -> countryMapper -> find ([ 'prefix' => $prefix ]); } public function findByName ( $name ) { return $this -> countryMapper -> find ([ 'name' => $name ]); } public function findAll () { return $this -> countryMapper -> find (); } public function store ( CountryInterface $country ) { return $this -> countryMapper -> save ( $country ); } public function remove ( CountryInterface $country ) { return $this -> countryMapper -> delete ( $country ); } } Data mapper class CountryMapper implements CountryMapperInterface { private $adapter ; private $countryCollection ; public function __construct ( AdapterInterface $adapter , CountryCollectionInterface $countryCollection ) { $this -> adapter = $adapter ; $this -> countryCollection = $countryCollection ; } public function find ( array $filter = [], $one = FALSE ) { // If $one is TRUE then add limit to sql statement, or so... $rows = $this -> adapter -> find ( $sql , $bindings ); // If $one is TRUE return a domain object, else a domain objects list. if ( $one ) { return $this -> createCountry ( $row [ 0 ]); } return $this -> createCountryCollection ( $rows ); } public function save ( CountryInterface $country ) { if ( NULL === $country -> id ) { // Build the INSERT statement and the bindings array... $this -> adapter -> insert ( $sql , $bindings ); $lastInsertId = $this -> adapter -> getLastInsertId (); return $this -> find ([ 'id' => $lastInsertId ], true ); } // Build the UPDATE statement and the bindings array... $this -> adapter -> update ( $sql , $bindings ); return $this -> find ([ 'id' => $country -> id ], true ); } public function delete ( CountryInterface $country ) { $sql = 'DELETE FROM countries WHERE id=:id' ; $bindings = [ ':id' => $country -> id ]; $rowCount = $this -> adapter -> delete ( $sql , $bindings ); return $rowCount > 0 ; } // Create a Country (domain object) from row. public function createCountry ( array $row = []) { $country = new Country (); /* * Iterate through the row items. * Assign a property to Country object for each item's name/value. */ return $country ; } // Create a Country[] list from rows list. public function createCountryCollection ( array $rows ) { /* * Iterate through rows. * Create a Country object for each row, with column names/values as properties. * Push Country object object to collection. * Return collection's content. */ return $this -> countryCollection -> all (); } } Db adapter class PdoAdapter implements AdapterInterface { private $connection ; public function __construct ( PDO $connection ) { $this -> connection = $connection ; } public function find ( string $sql , array $bindings = [], int $fetchMode = PDO :: FETCH_ASSOC , $fetchArgument = NULL , array $fetchConstructorArguments = []) { $statement = $this -> connection -> prepare ( $sql ); $statement -> execute ( $bindings ); return $statement -> fetchAll ( $fetchMode , $fetchArgument , $fetchConstructorArguments ); } //... } Domain objects collection class CountryCollection implements CountryCollectionInterface { private $countries = []; public function push ( CountryInterface $country ) { $this -> countries [] = $country ; return $this ; } public function all () { return $this -> countries ; } public function getIterator () { return new ArrayIterator ( $this -> countries ); } //... } Domain object class Country implements CountryInterface { // Business logic: properties and methods... } DataMapper is a layer to isolate an application from a concrete database. It transforms an object into a record of a database and a record into an object. DataMapper gives us the ability to work with Database and be unaware of what RDBMS we use. Example: interface DataMapperInterface { /** * Find objects by a criteria * * @param array $criteria Search params * @return Quote[] Found entities */ public function find ( array $criteria ); /** * Insert an object into a database * * @param Quote $object Object that will be inserted */ public function insert ( Quote $object ); /** * Update an object date in a database * * @param Quote $object Object that will be updated */ public function update ( Quote $object ); /** * Remove an object from a database * * @param Quote $object Object that will be removed */ public function delete ( Quote $object ); } Repository is a layer for encapsulation of logic of a query building. It gives us the ability to work with a collection of objects and be unaware to work with Database anything. class Repository { /** * @var DataMapperInterface Mapper to transform objects */ protected $mapper ; /** * Constructor * * @param DataMapperInterface $mapper Mapper to transform objects */ public function __construct ( DataMapperInterface $mapper ) { $this -> mapper = $mapper ; } /** * Find all objects * * @return Quote[] Found entities */ public function findAll () { return $this -> mapper -> find ([]); } /** * Find an object by an identifier * * @return Quote[] Found entities */ public function findById ( integer $id ) { $criteria = [ 'id' => $id ]; return $this -> mapper -> find ( $criteria ); } /** * Find objects by an author name * * @return Quote[] Found entities */ public function findByAuthor ( $name ) { $criteria = [ 'author' => $name ]; return $this -> mapper -> find ( $criteria ); } /** * Save an object into the repository */ public function save ( Quote $object ) { if ( empty ( $object -> id )) { $this -> mapper -> insert ( $object ); } else { $this -> mapper -> update ( $object ); } a } /** * Remove an object from the repository */ public function remove ( Quote $object ) { $this -> mapper -> delete ( $object ); } } This is the very simple instance and all is more difficult in a real application: queries are bigger, repository can cooperate with many other patterns (Query Object to query building, Unit of Work to track changes, Identity Map to avoid repeatedly-load of objects, etc.)","title":"Notes on model layer implementation"},{"location":"06-composer/06-99-activities/","text":"Activitats Projecte MovieFX Introducci\u00f3 La classe FlashMessage . Fins ara, hem gestionat la comunicaci\u00f3 entre p\u00e0gines mitjan\u00e7ant sessions. La gesti\u00f3 la f\u00e8iem escrivint i llegint en les variables de sessi\u00f3. L'objectiu de la seg\u00fcent classe \u00e9s proporcionar-nos un mecanisme que ens facilite l'enviament de missatges entre p\u00e0gines. Una vegada implementada utilitza-la en la creaci\u00f3 de pel\u00b7l\u00edcules. # src/App/Helpers/FlashMessage.php /** * Class FlashMessage * Aquesta classe llig i escriu directament en una variable de sessi\u00f3 * que ser\u00e0 un array, la clau ser\u00e0 $sessionKey de forma que evitem * possible col\u00b7lisions. */ class FlashMessage { /** * string */ const SESSION_KEY = \"flash-message\" ; /** * obtenim el valor de l'array associat a la clau. * despr\u00e9s de llegir-lo l'esborrem * si no existeix tornem el valor indicat per defecte. * @param string $key * @param mixed $defaultValue * @return mixed|string */ public static function get ( string $key , $defaultValue = '' ); /** * @param string $key * @param $value */ public static function set ( string $key , $value ); /** * @param string $key */ private static function unset ( string $key ); } Tenint en compte tot el proc\u00e9s de gesti\u00f3 de pujada de fixers, les restriccions que es poden aplicar, i les dades que ens interessen una vegada el proc\u00e9s s'ha efectuat exitosament, crea una classe que encapsule totes les funcionalitats requerides. Implementa el patr\u00f3 Registry en una classe amb el mateix nom i afegeix una instancia de PDO associada a la clau \"PDO\". L'objecte PDO l'haur\u00e0s de crear i inserir-lo en el Registre en un nou fitxer anomenat bootstrap.php . Aquest fitxer ser\u00e0 requerit en totes els fitxers que tinguen acc\u00e9s a la base de dades. En un fitxer de configuraci\u00f3 (JSON, YAML, INI o XML, segons t'haja assignat el professor) emmagatzema el DSN ( Data Source Name ) d'acc\u00e9s a la base de dades. Despr\u00e9s, crea una classe Config que llija el fitxer i extraga el DSN. Utilitza Config en bootstrap.php en lloc d'usar un literal en instanciar la classe PDO. Afig tamb\u00e9 al fitxer de configuraci\u00f3 la ruta relativa on es guarden les fotos pujades. Implementa els m\u00e8todes Movie::toArray() , Movie::fromArray(Movie $obj) i la classe MovieMapper tenint en compte la seg\u00fcent signatura: class MovieMapper { private $pdo ; public function __construct () { $this -> pdo = Registry :: getPDO (); } public function find ( int $id ) : ? Movie { } public function findAll () : array { } public function insert ( Movie $obj ) { } public function update ( Movie $object ) { } } Implementa el repositori de pel\u00b7licules tenint en compte la seg\u00fcent signatura: declare ( strict_types = 1 ); class MovieRepository { public MovieMapper $mapper ; public function __construct () { $this -> mapper = new MovieMapper (); } public function save ( Movie $movie ) { } public function find ( int $id ) :? Movie { } public function findAll () : array { } public function delete ( Movie $movie ) { } } Composer En la seg\u00fcent activitat treballarem en Composer: Instal\u00b7la composer de forma global. Instal\u00b7la monolog . Configura bootstrap.php perqu\u00e8 use l\u2019autoloader de Composer . Configura composer.json perqu\u00e8 carregue les nostres classes. Configura monolog en index.php de forma que registre la activitat en directori del projecte/app.log i en Firefox amb l'extensi\u00f3 FirePHP. webmozart/assert \u00e9s un paquet que cont\u00e9 una llibreria de funcions de validaci\u00f3 (assercions/afirmacions). Instal\u00b7la el paquet. Configura'l si cal. Usa els seus m\u00e8todes per a validar els formularis.","title":"Activitats"},{"location":"06-composer/06-99-activities/#activitats","text":"","title":"Activitats"},{"location":"06-composer/06-99-activities/#projecte-moviefx","text":"","title":"Projecte MovieFX"},{"location":"06-composer/06-99-activities/#introduccio","text":"La classe FlashMessage . Fins ara, hem gestionat la comunicaci\u00f3 entre p\u00e0gines mitjan\u00e7ant sessions. La gesti\u00f3 la f\u00e8iem escrivint i llegint en les variables de sessi\u00f3. L'objectiu de la seg\u00fcent classe \u00e9s proporcionar-nos un mecanisme que ens facilite l'enviament de missatges entre p\u00e0gines. Una vegada implementada utilitza-la en la creaci\u00f3 de pel\u00b7l\u00edcules. # src/App/Helpers/FlashMessage.php /** * Class FlashMessage * Aquesta classe llig i escriu directament en una variable de sessi\u00f3 * que ser\u00e0 un array, la clau ser\u00e0 $sessionKey de forma que evitem * possible col\u00b7lisions. */ class FlashMessage { /** * string */ const SESSION_KEY = \"flash-message\" ; /** * obtenim el valor de l'array associat a la clau. * despr\u00e9s de llegir-lo l'esborrem * si no existeix tornem el valor indicat per defecte. * @param string $key * @param mixed $defaultValue * @return mixed|string */ public static function get ( string $key , $defaultValue = '' ); /** * @param string $key * @param $value */ public static function set ( string $key , $value ); /** * @param string $key */ private static function unset ( string $key ); } Tenint en compte tot el proc\u00e9s de gesti\u00f3 de pujada de fixers, les restriccions que es poden aplicar, i les dades que ens interessen una vegada el proc\u00e9s s'ha efectuat exitosament, crea una classe que encapsule totes les funcionalitats requerides. Implementa el patr\u00f3 Registry en una classe amb el mateix nom i afegeix una instancia de PDO associada a la clau \"PDO\". L'objecte PDO l'haur\u00e0s de crear i inserir-lo en el Registre en un nou fitxer anomenat bootstrap.php . Aquest fitxer ser\u00e0 requerit en totes els fitxers que tinguen acc\u00e9s a la base de dades. En un fitxer de configuraci\u00f3 (JSON, YAML, INI o XML, segons t'haja assignat el professor) emmagatzema el DSN ( Data Source Name ) d'acc\u00e9s a la base de dades. Despr\u00e9s, crea una classe Config que llija el fitxer i extraga el DSN. Utilitza Config en bootstrap.php en lloc d'usar un literal en instanciar la classe PDO. Afig tamb\u00e9 al fitxer de configuraci\u00f3 la ruta relativa on es guarden les fotos pujades. Implementa els m\u00e8todes Movie::toArray() , Movie::fromArray(Movie $obj) i la classe MovieMapper tenint en compte la seg\u00fcent signatura: class MovieMapper { private $pdo ; public function __construct () { $this -> pdo = Registry :: getPDO (); } public function find ( int $id ) : ? Movie { } public function findAll () : array { } public function insert ( Movie $obj ) { } public function update ( Movie $object ) { } } Implementa el repositori de pel\u00b7licules tenint en compte la seg\u00fcent signatura: declare ( strict_types = 1 ); class MovieRepository { public MovieMapper $mapper ; public function __construct () { $this -> mapper = new MovieMapper (); } public function save ( Movie $movie ) { } public function find ( int $id ) :? Movie { } public function findAll () : array { } public function delete ( Movie $movie ) { } }","title":"Introducci\u00f3"},{"location":"06-composer/06-99-activities/#composer","text":"En la seg\u00fcent activitat treballarem en Composer: Instal\u00b7la composer de forma global. Instal\u00b7la monolog . Configura bootstrap.php perqu\u00e8 use l\u2019autoloader de Composer . Configura composer.json perqu\u00e8 carregue les nostres classes. Configura monolog en index.php de forma que registre la activitat en directori del projecte/app.log i en Firefox amb l'extensi\u00f3 FirePHP. webmozart/assert \u00e9s un paquet que cont\u00e9 una llibreria de funcions de validaci\u00f3 (assercions/afirmacions). Instal\u00b7la el paquet. Configura'l si cal. Usa els seus m\u00e8todes per a validar els formularis.","title":"Composer"},{"location":"07-mvc/07-00-intro/","text":"Cap a un framework MVC En aquesta unitat implementarem els components b\u00e0sics del nostre framework . Explicarem la seua funci\u00f3 i com implementar-lo de forma b\u00e0sica. Tamb\u00e9 es veuran alguns conceptes molt utilitzats en els frameworks professionals. Model Vista Controlador Model\u2013view\u2013controller (MVC) \u00e9s un patr\u00f3 de disseny de programari que s'utilitza habitualment per desenvolupar interf\u00edcies d'usuari que divideixen la l\u00f2gica del programa relacionada en tres elements interconnectats. Aix\u00f2 es fa per separar les representacions internes de la informaci\u00f3 de la forma en que es presenta i accepta la informaci\u00f3 a l'usuari. Aquest patr\u00f3 es va fer popular per desenvolupar aplicacions web. Els llenguatges de programaci\u00f3 populars tenen frameworks MVC que faciliten el desenvolupament. Per exemple: En Python, Django. En Ruby, Ruby on Rails. En Javascript, Angular. En PHP, Symfony i Laravel. Esquema MVC Esquema MVC ampliat Model : El component central del patr\u00f3. \u00c9s l'estructura de dades din\u00e0miques de l'aplicaci\u00f3, independent de la interf\u00edcie d'usuari. Gestiona directament les dades, la l\u00f2gica i les regles de l'aplicaci\u00f3. Vista : Qualsevol representaci\u00f3 d'informaci\u00f3 com un gr\u00e0fic, un diagrama o una taula. S\u00f3n possibles diverses visualitzacions de la mateixa informaci\u00f3, com ara un gr\u00e0fic de barres per a la gesti\u00f3 i una vista tabular per als comptables. Controlador : Accepta l'entrada i la converteix en ordres per al model o la vista per a finalment tornar la resposta al client. A m\u00e9s de dividir l'aplicaci\u00f3 en aquests components defineix les interaccions entre ells. - El model s'encarrega de gestionar les dades de l'aplicaci\u00f3. Rep l'entrada de l'usuari mitjan\u00e7ant el controlador. - La vista fa la presentaci\u00f3 del model en un format determinat. - El controlador respon a l'entrada de l'usuari i realitza interaccions amb els objectes del model de dades. El controlador rep l'entrada, opcionalment la valida i despr\u00e9s passa l'entrada al model. Igual que amb altres patrons de programari, MVC expressa el \"nucli de la soluci\u00f3\" a un problema alhora que permet adaptar-lo a cada sistema. Els dissenys MVC particulars poden variar significativament de la descripci\u00f3 tradicional.","title":"Cap a un _framework_ MVC"},{"location":"07-mvc/07-00-intro/#cap-a-un-framework-mvc","text":"En aquesta unitat implementarem els components b\u00e0sics del nostre framework . Explicarem la seua funci\u00f3 i com implementar-lo de forma b\u00e0sica. Tamb\u00e9 es veuran alguns conceptes molt utilitzats en els frameworks professionals.","title":"Cap a un framework MVC"},{"location":"07-mvc/07-00-intro/#model-vista-controlador","text":"Model\u2013view\u2013controller (MVC) \u00e9s un patr\u00f3 de disseny de programari que s'utilitza habitualment per desenvolupar interf\u00edcies d'usuari que divideixen la l\u00f2gica del programa relacionada en tres elements interconnectats. Aix\u00f2 es fa per separar les representacions internes de la informaci\u00f3 de la forma en que es presenta i accepta la informaci\u00f3 a l'usuari. Aquest patr\u00f3 es va fer popular per desenvolupar aplicacions web. Els llenguatges de programaci\u00f3 populars tenen frameworks MVC que faciliten el desenvolupament. Per exemple: En Python, Django. En Ruby, Ruby on Rails. En Javascript, Angular. En PHP, Symfony i Laravel. Esquema MVC Esquema MVC ampliat Model : El component central del patr\u00f3. \u00c9s l'estructura de dades din\u00e0miques de l'aplicaci\u00f3, independent de la interf\u00edcie d'usuari. Gestiona directament les dades, la l\u00f2gica i les regles de l'aplicaci\u00f3. Vista : Qualsevol representaci\u00f3 d'informaci\u00f3 com un gr\u00e0fic, un diagrama o una taula. S\u00f3n possibles diverses visualitzacions de la mateixa informaci\u00f3, com ara un gr\u00e0fic de barres per a la gesti\u00f3 i una vista tabular per als comptables. Controlador : Accepta l'entrada i la converteix en ordres per al model o la vista per a finalment tornar la resposta al client. A m\u00e9s de dividir l'aplicaci\u00f3 en aquests components defineix les interaccions entre ells. - El model s'encarrega de gestionar les dades de l'aplicaci\u00f3. Rep l'entrada de l'usuari mitjan\u00e7ant el controlador. - La vista fa la presentaci\u00f3 del model en un format determinat. - El controlador respon a l'entrada de l'usuari i realitza interaccions amb els objectes del model de dades. El controlador rep l'entrada, opcionalment la valida i despr\u00e9s passa l'entrada al model. Igual que amb altres patrons de programari, MVC expressa el \"nucli de la soluci\u00f3\" a un problema alhora que permet adaptar-lo a cada sistema. Els dissenys MVC particulars poden variar significativament de la descripci\u00f3 tradicional.","title":"Model Vista Controlador"},{"location":"07-mvc/07-01-controlador-frontal/","text":"El controlador frontal El controlador frontal \u00e9s un patr\u00f3 de disseny que apareix en diversos cat\u00e0legs de patrons i est\u00e0 relacionat amb el disseny d\u2019aplicacions web. \u00c9s \"un controlador que gestiona totes les sol\u00b7licituds d'un lloc web\", que \u00e9s una estructura \u00fatil per als desenvolupadors d'aplicacions web per a aconseguir la flexibilitat i la reutilitzaci\u00f3 sense redund\u00e0ncia de codi. Normalment el controlador frontal s'implementa en la p\u00e0gina principal del lloc web: index.php . Perqu\u00e8 el controlador frontal siga funcional \u00e9s important que qualsevol petici\u00f3 al lloc web siga redirigida al controlador frontal. En eixe sentit les URL amigables tenen un paper esencial. Qu\u00e8 posa ah\u00ed? URL amigables Les URL sem\u00e0ntiques o URL amigables s\u00f3n aquelles URL que, dins del que cap, poden ser enteses pels usuaris. Lluny de les cl\u00e0ssiques URL de les p\u00e0gines din\u00e0miques plenes de variables en el querystring i nombres dif\u00edcils de recordar, les URL sem\u00e0ntiques estan formades amb paraules relacionades amb el contingut de la p\u00e0gina i f\u00e0cils de recordar. Aquestes s'utilitzen en els llocs web din\u00e0mics (no est\u00e0tics). Per aix\u00f2 s'estan utilitzant molt m\u00e9s que les URL extenses. Suposem que vols comprar una c\u00e0mera fotos. Has trobat dues botigues amb el model que busques. La direcci\u00f3 de l'producte a la primera botiga \u00e9s: http://www.example.com/B001G5ZTLS/ref=sr_1_5?s=foto&ie=UTF8&qid=1365525726&sr=1-5 I la direcci\u00f3 de la segona: http://www.example.com/camaras/reflex/canon-eos-5d-mark-2/ Quan desenvolupem una aplicaci\u00f3 web hem de tractar que les url tinguen c\u00e0rrega sem\u00e0ntica. Els seus principals avantatges s\u00f3n: F\u00e0cils de recordar i de deduir. Oculta de la tecnologia usada. \u00c9s conforme a l\u2019estil REST el que li dona consist\u00e8ncia. Crear URL netes i llegibles que s\u00f3n m\u00e9s f\u00e0cils de recordar i m\u00e9s adequades per al Search Engine Optimization (SEO). En el nostre projecte quina url tindr\u00e0 m\u00e9s c\u00e0rrega sem\u00e0tica? http://movies.local/movies/title/ava o http://movies.local/show-movie.php?id=1488 Reescriptura de rutes Com hem dit abans, per a disposar d'un lloc web en url amigables necessitem que totes les peticions a la la nostra aplicaci\u00f3 es redirigisquen al nostre controlador frontal ( index.php ) En index.php obtindrem el path (ruta) i cridarem al controlador adient. Per redirigir totes les cridades al controlador frontal haurem de configurar el m\u00f2dul de reescriptura d'Apache ( mod_rewrite ). Objectius de les regles de reescriptura Els objectius s\u00f3n diversos: Amagar la funcionalitat de PHP i, per tant, exposa menys les parts internes de el lloc. Restringir l'acc\u00e9s. Crear URL netes i llegibles que s\u00f3n m\u00e9s f\u00e0cils de recordar i m\u00e9s adequades per al Search Engine Optimization. La reescriptura d'URL \u00e9s la t\u00e8cnica utilitzada per \"traduir\" un URL amigable a una altra que el servidor puga entendre. Directives Perqu\u00e8 la reescriptura d'URL funcione tenim dues opcions: Introduir una s\u00e8rie de directives <Directory> en els fitxers de configuraci\u00f3 d'Apache Introduir aquestes directives en un fitxer .htaccess dins del directori en el que vulgues que es realitze la reescriptura. Nosaltres utilitzarem la segona opci\u00f3. D'aquesta manera, en producci\u00f3 n'hi haur\u00e0 prou amb pujar el .htaccess al servidor i no necessitarem tocar la configuraci\u00f3. Alert Perqu\u00e8 funcione .htaccess cal tindre activida la directiva AllowOverride d'Apache. Els passos a realitzar s\u00f3n: Comprovar si existeix el mod_rewrite Totes les directives de mod_rewrite les introduirem dins d\u2019una directiva IfModule: <IfModule mod_rewrite.c > Directives de reescriptura </IfModule> Deshabilitar l\u2019opci\u00f3 Multiviews \u00c9s convenient desactivar aquesta opci\u00f3 per evitar problemes amb fitxers que tenen noms semblants, teniu m\u00e9s informaci\u00f3 en What exactly does the multiviews option in htacces <IfModule mod_rewrite.c > options -MultiViews Directives de reescriptura </ IfModule > Directiva RewriteEngine Per indicar a Apache que fem servir el mod_rewrite : RewriteEngine on Si vols desactivar-lo i que el servidor ignore la resta de la configuraci\u00f3: RewriteEngine off Directiva RewriteCond La directiva RewriteCond ens permet especificar una condici\u00f3. Si es compleix, s'executa la directiva RewriteRule posterior. Es poden posar diverses condicions. Quan es compleixen totes les condicions (llevat que s'indique una altra cosa) s'executa la directiva RewriteRule posterior La seua sintaxi \u00e9s: RewriteCond variable_apache expresi\u00f3n_regular flags Hi ha diverses variables per a condicions com es pot observar en la imatge: . Nosaltres usarem REQUEST_FILENAME que emmagatzema la URL sol\u00b7licitada per l'usuari. Despr\u00e9s de la variable indicarem una expressi\u00f3 regular per seleccionar les adreces que es corresponen amb un determinat patr\u00f3. Existeixen tamb\u00e9 una s\u00e8rie de variables predefinides que es poden utilitzar en comptes d'introduir una expressi\u00f3 regular: -d : es tracta la URL com si fos una ruta d'el sistema d'arxius i es comprova si existeix i si \u00e9s un directori. -f : igual que l'anterior, per\u00f2 comprovant si \u00e9s un fitxer. -l : Igual que els anteriors, per\u00f2 comprovant si \u00e9s un enlla\u00e7 simb\u00f2lic. Etc. Si indiquem el s\u00edmbol ! Davant de l'expressi\u00f3 regular o la variable, l'estem negant, \u00e9s a dir, que s'avaluar\u00e0 la condici\u00f3 a cert quan no coincideixi amb l'expressi\u00f3 indicada. Flags (banderes) Podem indicar una llista de flags per especificar un comportament determinat: nocase | NC: El testeig \u00e9s insensible a maj\u00fascules i min\u00fascules(no case-sensitive ). ornext | OR: S'utilitza l'operaci\u00f3 OR (en lloc de AND que \u00e9s l'opci\u00f3 per defecte) per combinar el resta de condicions en les regles Per exemple: RewriteCond %{HTTP_USER_AGENT} ^exemple [OR, NC] RewriteCond %{HTTP_USER_AGENT} ^google [NC] La variable %{HTTP_USER_AGENT} representa el nom del navegador que utilitza l'usuari. L'expressi\u00f3 regular s'utilitza per determinar quin \u00e9s el valor de la variable que estem analitzant. En aquest exemple ^exemple indica que el nom del navegador comen\u00e7a per exemple . En els flags s'indica que les dues condicions s'agrupen com operacions OR, \u00e9s a dir, el nom de el navegador ha de comen\u00e7ar per exemple o per google . El valor NC indica que no ha de distingir entre maj\u00fascules i min\u00fascules. Directiva RewriteRule Aquesta directiva ser\u00e0 l'encarregada de realitzar la redirecci\u00f3 (reescriptura) corresponent. Sintaxi: RewriteRule expresi\u00f3n_regular redirecci\u00f3 flags Mitjan\u00e7ant el car\u00e0cter \"-\" indicarem que no volem cap p\u00e0gina de redirecci\u00f3 El nostre cas En el nostre crearem aquest fitxer .htacces en la carpeta on tingam el fitxer que implemente el controlador frontal. # .htaccess <IfModule mod_rewrite.c > Options -MultiViews RewriteEngine On RewriteCond %{REQUEST_FILENAME} !-f RewriteRule ^(.*)$ /index.php [QSA,L] </IfModule> RewriteCond indica qualsevol sol\u00b7licitud que no siga un fitxer. I en RewriteRule l'expressi\u00f3 regular selecciona qualsevol URI. Tenint en compte les seg\u00fcents que: ^ indica que l'inici $ indica el final. () representa una agrupaci\u00f3 . representa qualsevol car\u00e0cter excepte espai. * representa que el car\u00e0cter anterir es pot repetir. L'expressi\u00f3 regular ^(.*)$ indica que es seleccionar\u00e0 qualsevol cadena de text que entre l'inici i el final continga qualsevol car\u00e0cter que no siga espai, \u00e9s a dir, qualsevol URL. Els flags indiquen: QSA , les query strings , d'existir, es combinen en la reescritura. L , indica que aplicada la regla, s'ature l'execuci\u00f3. M\u00e9s informaci\u00f3: Apache mod_rewrite Protecci\u00f3 del nostre codi Per a protegir el nostre codi d'accessos mitjan\u00e7ant el navegador moure'm el DocumentRoot al directori public . Aquest directori sols contindr\u00e0 aquelles recursos que volem que siguen accessibles directament des del navegador: index.php que implementar\u00e0 el controlador frontal fitxers d'estils, imatges, etc. Per a aconseguir-ho caldr\u00e0 canviar la configuraci\u00f3 del DocumentRoot nostre servidor virtual perqu\u00e8 apunte al directori public .","title":"El controlador frontal"},{"location":"07-mvc/07-01-controlador-frontal/#el-controlador-frontal","text":"El controlador frontal \u00e9s un patr\u00f3 de disseny que apareix en diversos cat\u00e0legs de patrons i est\u00e0 relacionat amb el disseny d\u2019aplicacions web. \u00c9s \"un controlador que gestiona totes les sol\u00b7licituds d'un lloc web\", que \u00e9s una estructura \u00fatil per als desenvolupadors d'aplicacions web per a aconseguir la flexibilitat i la reutilitzaci\u00f3 sense redund\u00e0ncia de codi. Normalment el controlador frontal s'implementa en la p\u00e0gina principal del lloc web: index.php . Perqu\u00e8 el controlador frontal siga funcional \u00e9s important que qualsevol petici\u00f3 al lloc web siga redirigida al controlador frontal. En eixe sentit les URL amigables tenen un paper esencial.","title":"El controlador frontal"},{"location":"07-mvc/07-01-controlador-frontal/#que-posa-ahi-url-amigables","text":"Les URL sem\u00e0ntiques o URL amigables s\u00f3n aquelles URL que, dins del que cap, poden ser enteses pels usuaris. Lluny de les cl\u00e0ssiques URL de les p\u00e0gines din\u00e0miques plenes de variables en el querystring i nombres dif\u00edcils de recordar, les URL sem\u00e0ntiques estan formades amb paraules relacionades amb el contingut de la p\u00e0gina i f\u00e0cils de recordar. Aquestes s'utilitzen en els llocs web din\u00e0mics (no est\u00e0tics). Per aix\u00f2 s'estan utilitzant molt m\u00e9s que les URL extenses. Suposem que vols comprar una c\u00e0mera fotos. Has trobat dues botigues amb el model que busques. La direcci\u00f3 de l'producte a la primera botiga \u00e9s: http://www.example.com/B001G5ZTLS/ref=sr_1_5?s=foto&ie=UTF8&qid=1365525726&sr=1-5 I la direcci\u00f3 de la segona: http://www.example.com/camaras/reflex/canon-eos-5d-mark-2/ Quan desenvolupem una aplicaci\u00f3 web hem de tractar que les url tinguen c\u00e0rrega sem\u00e0ntica. Els seus principals avantatges s\u00f3n: F\u00e0cils de recordar i de deduir. Oculta de la tecnologia usada. \u00c9s conforme a l\u2019estil REST el que li dona consist\u00e8ncia. Crear URL netes i llegibles que s\u00f3n m\u00e9s f\u00e0cils de recordar i m\u00e9s adequades per al Search Engine Optimization (SEO). En el nostre projecte quina url tindr\u00e0 m\u00e9s c\u00e0rrega sem\u00e0tica? http://movies.local/movies/title/ava o http://movies.local/show-movie.php?id=1488","title":"Qu\u00e8 posa ah\u00ed? URL amigables"},{"location":"07-mvc/07-01-controlador-frontal/#reescriptura-de-rutes","text":"Com hem dit abans, per a disposar d'un lloc web en url amigables necessitem que totes les peticions a la la nostra aplicaci\u00f3 es redirigisquen al nostre controlador frontal ( index.php ) En index.php obtindrem el path (ruta) i cridarem al controlador adient. Per redirigir totes les cridades al controlador frontal haurem de configurar el m\u00f2dul de reescriptura d'Apache ( mod_rewrite ).","title":"Reescriptura de rutes"},{"location":"07-mvc/07-01-controlador-frontal/#objectius-de-les-regles-de-reescriptura","text":"Els objectius s\u00f3n diversos: Amagar la funcionalitat de PHP i, per tant, exposa menys les parts internes de el lloc. Restringir l'acc\u00e9s. Crear URL netes i llegibles que s\u00f3n m\u00e9s f\u00e0cils de recordar i m\u00e9s adequades per al Search Engine Optimization. La reescriptura d'URL \u00e9s la t\u00e8cnica utilitzada per \"traduir\" un URL amigable a una altra que el servidor puga entendre.","title":"Objectius de les regles de reescriptura"},{"location":"07-mvc/07-01-controlador-frontal/#directives","text":"Perqu\u00e8 la reescriptura d'URL funcione tenim dues opcions: Introduir una s\u00e8rie de directives <Directory> en els fitxers de configuraci\u00f3 d'Apache Introduir aquestes directives en un fitxer .htaccess dins del directori en el que vulgues que es realitze la reescriptura. Nosaltres utilitzarem la segona opci\u00f3. D'aquesta manera, en producci\u00f3 n'hi haur\u00e0 prou amb pujar el .htaccess al servidor i no necessitarem tocar la configuraci\u00f3. Alert Perqu\u00e8 funcione .htaccess cal tindre activida la directiva AllowOverride d'Apache. Els passos a realitzar s\u00f3n: Comprovar si existeix el mod_rewrite Totes les directives de mod_rewrite les introduirem dins d\u2019una directiva IfModule: <IfModule mod_rewrite.c > Directives de reescriptura </IfModule> Deshabilitar l\u2019opci\u00f3 Multiviews \u00c9s convenient desactivar aquesta opci\u00f3 per evitar problemes amb fitxers que tenen noms semblants, teniu m\u00e9s informaci\u00f3 en What exactly does the multiviews option in htacces <IfModule mod_rewrite.c > options -MultiViews Directives de reescriptura </ IfModule >","title":"Directives"},{"location":"07-mvc/07-01-controlador-frontal/#directiva-rewriteengine","text":"Per indicar a Apache que fem servir el mod_rewrite : RewriteEngine on Si vols desactivar-lo i que el servidor ignore la resta de la configuraci\u00f3: RewriteEngine off","title":"Directiva RewriteEngine"},{"location":"07-mvc/07-01-controlador-frontal/#directiva-rewritecond","text":"La directiva RewriteCond ens permet especificar una condici\u00f3. Si es compleix, s'executa la directiva RewriteRule posterior. Es poden posar diverses condicions. Quan es compleixen totes les condicions (llevat que s'indique una altra cosa) s'executa la directiva RewriteRule posterior La seua sintaxi \u00e9s: RewriteCond variable_apache expresi\u00f3n_regular flags Hi ha diverses variables per a condicions com es pot observar en la imatge: . Nosaltres usarem REQUEST_FILENAME que emmagatzema la URL sol\u00b7licitada per l'usuari. Despr\u00e9s de la variable indicarem una expressi\u00f3 regular per seleccionar les adreces que es corresponen amb un determinat patr\u00f3. Existeixen tamb\u00e9 una s\u00e8rie de variables predefinides que es poden utilitzar en comptes d'introduir una expressi\u00f3 regular: -d : es tracta la URL com si fos una ruta d'el sistema d'arxius i es comprova si existeix i si \u00e9s un directori. -f : igual que l'anterior, per\u00f2 comprovant si \u00e9s un fitxer. -l : Igual que els anteriors, per\u00f2 comprovant si \u00e9s un enlla\u00e7 simb\u00f2lic. Etc. Si indiquem el s\u00edmbol ! Davant de l'expressi\u00f3 regular o la variable, l'estem negant, \u00e9s a dir, que s'avaluar\u00e0 la condici\u00f3 a cert quan no coincideixi amb l'expressi\u00f3 indicada. Flags (banderes) Podem indicar una llista de flags per especificar un comportament determinat: nocase | NC: El testeig \u00e9s insensible a maj\u00fascules i min\u00fascules(no case-sensitive ). ornext | OR: S'utilitza l'operaci\u00f3 OR (en lloc de AND que \u00e9s l'opci\u00f3 per defecte) per combinar el resta de condicions en les regles Per exemple: RewriteCond %{HTTP_USER_AGENT} ^exemple [OR, NC] RewriteCond %{HTTP_USER_AGENT} ^google [NC] La variable %{HTTP_USER_AGENT} representa el nom del navegador que utilitza l'usuari. L'expressi\u00f3 regular s'utilitza per determinar quin \u00e9s el valor de la variable que estem analitzant. En aquest exemple ^exemple indica que el nom del navegador comen\u00e7a per exemple . En els flags s'indica que les dues condicions s'agrupen com operacions OR, \u00e9s a dir, el nom de el navegador ha de comen\u00e7ar per exemple o per google . El valor NC indica que no ha de distingir entre maj\u00fascules i min\u00fascules.","title":"Directiva RewriteCond"},{"location":"07-mvc/07-01-controlador-frontal/#directiva-rewriterule","text":"Aquesta directiva ser\u00e0 l'encarregada de realitzar la redirecci\u00f3 (reescriptura) corresponent. Sintaxi: RewriteRule expresi\u00f3n_regular redirecci\u00f3 flags Mitjan\u00e7ant el car\u00e0cter \"-\" indicarem que no volem cap p\u00e0gina de redirecci\u00f3","title":"Directiva RewriteRule"},{"location":"07-mvc/07-01-controlador-frontal/#el-nostre-cas","text":"En el nostre crearem aquest fitxer .htacces en la carpeta on tingam el fitxer que implemente el controlador frontal. # .htaccess <IfModule mod_rewrite.c > Options -MultiViews RewriteEngine On RewriteCond %{REQUEST_FILENAME} !-f RewriteRule ^(.*)$ /index.php [QSA,L] </IfModule> RewriteCond indica qualsevol sol\u00b7licitud que no siga un fitxer. I en RewriteRule l'expressi\u00f3 regular selecciona qualsevol URI. Tenint en compte les seg\u00fcents que: ^ indica que l'inici $ indica el final. () representa una agrupaci\u00f3 . representa qualsevol car\u00e0cter excepte espai. * representa que el car\u00e0cter anterir es pot repetir. L'expressi\u00f3 regular ^(.*)$ indica que es seleccionar\u00e0 qualsevol cadena de text que entre l'inici i el final continga qualsevol car\u00e0cter que no siga espai, \u00e9s a dir, qualsevol URL. Els flags indiquen: QSA , les query strings , d'existir, es combinen en la reescritura. L , indica que aplicada la regla, s'ature l'execuci\u00f3. M\u00e9s informaci\u00f3: Apache mod_rewrite","title":"El nostre cas"},{"location":"07-mvc/07-01-controlador-frontal/#proteccio-del-nostre-codi","text":"Per a protegir el nostre codi d'accessos mitjan\u00e7ant el navegador moure'm el DocumentRoot al directori public . Aquest directori sols contindr\u00e0 aquelles recursos que volem que siguen accessibles directament des del navegador: index.php que implementar\u00e0 el controlador frontal fitxers d'estils, imatges, etc. Per a aconseguir-ho caldr\u00e0 canviar la configuraci\u00f3 del DocumentRoot nostre servidor virtual perqu\u00e8 apunte al directori public .","title":"Protecci\u00f3 del nostre codi"},{"location":"07-mvc/07-02-classe-router/","text":"Routing i controladors Una de les tasques que ha de realitzar el nostre controlador frontal \u00e9s enrutar, \u00e9s a dir, analitzar la sol\u00b7licitud de l'usuari i activar el m\u00e8todo del controlador associat. Aix\u00ed una ruta ser\u00e0 una url que ens donar\u00e0 acc\u00e9s a un controlador. \u00c9s important, a l'hora de definir les rutes seguir una convenci\u00f3, nosaltres seguirem aquesta: REST resource naming . El router : AltoRouter Aquesta funci\u00f3 la realitzarem des d'un compoment que s'encarregar\u00e0 de: Gestionar la taula de rutes, on es vincula cada ruta a un controlador. Resoldre les sol\u00b7licituds, \u00e9s a dir, buscar el controlador vinculat a la ruta. En el projecte usarem AltoRouter un component que s'ajusta perfectament a les nostres necessitats. L'instal\u00b7lem: composer require altorouter/altorouter En aquest exemple podem vore les seues opcions de mapeig: $router = new AltoRouter (); // map homepage $router -> map ( 'GET' , '/' , function () { require __DIR__ . '/views/home.php' ; }); // dynamic named route $router -> map ( 'GET|POST' , '/users/[i:id]/' , function ( $id ) { $user = ..... require __DIR__ . '/views/user/details.php' ; }, 'user-details' ); // map controller $router -> map ( 'GET' , '/' , 'MovieController#list' , 'movie_list' ); // map controller with params $router -> map ( 'GET|POST' , '/movies/[i:id]/edit' , \"MovieController#edit\" , 'movie_edit' ); // echo URL to user-details page for ID 5 echo $router -> generate ( 'user-details' , [ 'id' => 5 ]); // Output: \"/users/5\" I la forma de resoldre les sol\u00b7licituds amb el m\u00e8tode match() que torna el nom del controlador a activar. $match = $router -> match (); Una vegada obtingut el controlador caldr\u00e0 executar-lo: if ( is_array ( $match )) { $temp = explode ( \"#\" , $match [ \"target\" ]); $controller = $prefix . $temp [ 0 ]; $action = $temp [ 1 ]; if ( method_exists ( $controller , $action )) { $object = new $controller ; call_user_func_array ([ $object , $action ], $match [ 'params' ]); } else { // no route was matched header ( $_SERVER [ \"SERVER_PROTOCOL\" ] . ' 404 Not Found' ); echo \"error\" ; } } else { // no route was matched header ( $_SERVER [ \"SERVER_PROTOCOL\" ] . ' 404 Not Found' ); echo \"error\" ; } Els controladors Com hem vist en la introducci\u00f3, el controlador \u00e9s el component del patr\u00f3 MVC que s'encarrega de rebre la sol\u00b7licitud de l'usuari, interactuar en el model i la vista i retornar la informaci\u00f3 al client. Els controladors solen implementar-se en una classe, els m\u00e8todes de la qual, s\u00f3n les diferents accions que es poden realitzar. Per exemple: namespace App\\Controller ; ... class MovieController { const MAX_SIZE = 1024 * 1000 ; private MovieRepository $movieRepository ; public function __construct () { $mapper = new MovieMapper (); $this -> movieRepository = new MovieRepository ( $mapper ); } public function list () { $movies = $this -> movieRepository -> findAll (); $logger = Registry :: get ( Registry :: LOGGER ); $logger -> info ( \"s'ha executat una consulta\" ); require __DIR__ . \"/../../views/index.view.php\" ; } ... } En aquest exemple, en sol\u00b7licitar la p\u00e0gina principal (\"/\"), el enrutador activaria el m\u00e8tode list del controlador MovieController que obt\u00e9 les pel\u00b7l\u00edcules mitjan\u00e7ant el repositori. Com que la vista, a hores d'ara, es troba en el mateix \u00e0mbit d'execuci\u00f3, podr\u00e0 accedir a les dades generades i mostrar-les.","title":"Routing i controladors"},{"location":"07-mvc/07-02-classe-router/#routing-i-controladors","text":"Una de les tasques que ha de realitzar el nostre controlador frontal \u00e9s enrutar, \u00e9s a dir, analitzar la sol\u00b7licitud de l'usuari i activar el m\u00e8todo del controlador associat. Aix\u00ed una ruta ser\u00e0 una url que ens donar\u00e0 acc\u00e9s a un controlador. \u00c9s important, a l'hora de definir les rutes seguir una convenci\u00f3, nosaltres seguirem aquesta: REST resource naming .","title":"Routing i controladors"},{"location":"07-mvc/07-02-classe-router/#el-router-altorouter","text":"Aquesta funci\u00f3 la realitzarem des d'un compoment que s'encarregar\u00e0 de: Gestionar la taula de rutes, on es vincula cada ruta a un controlador. Resoldre les sol\u00b7licituds, \u00e9s a dir, buscar el controlador vinculat a la ruta. En el projecte usarem AltoRouter un component que s'ajusta perfectament a les nostres necessitats. L'instal\u00b7lem: composer require altorouter/altorouter En aquest exemple podem vore les seues opcions de mapeig: $router = new AltoRouter (); // map homepage $router -> map ( 'GET' , '/' , function () { require __DIR__ . '/views/home.php' ; }); // dynamic named route $router -> map ( 'GET|POST' , '/users/[i:id]/' , function ( $id ) { $user = ..... require __DIR__ . '/views/user/details.php' ; }, 'user-details' ); // map controller $router -> map ( 'GET' , '/' , 'MovieController#list' , 'movie_list' ); // map controller with params $router -> map ( 'GET|POST' , '/movies/[i:id]/edit' , \"MovieController#edit\" , 'movie_edit' ); // echo URL to user-details page for ID 5 echo $router -> generate ( 'user-details' , [ 'id' => 5 ]); // Output: \"/users/5\" I la forma de resoldre les sol\u00b7licituds amb el m\u00e8tode match() que torna el nom del controlador a activar. $match = $router -> match (); Una vegada obtingut el controlador caldr\u00e0 executar-lo: if ( is_array ( $match )) { $temp = explode ( \"#\" , $match [ \"target\" ]); $controller = $prefix . $temp [ 0 ]; $action = $temp [ 1 ]; if ( method_exists ( $controller , $action )) { $object = new $controller ; call_user_func_array ([ $object , $action ], $match [ 'params' ]); } else { // no route was matched header ( $_SERVER [ \"SERVER_PROTOCOL\" ] . ' 404 Not Found' ); echo \"error\" ; } } else { // no route was matched header ( $_SERVER [ \"SERVER_PROTOCOL\" ] . ' 404 Not Found' ); echo \"error\" ; }","title":"El router: AltoRouter"},{"location":"07-mvc/07-02-classe-router/#els-controladors","text":"Com hem vist en la introducci\u00f3, el controlador \u00e9s el component del patr\u00f3 MVC que s'encarrega de rebre la sol\u00b7licitud de l'usuari, interactuar en el model i la vista i retornar la informaci\u00f3 al client. Els controladors solen implementar-se en una classe, els m\u00e8todes de la qual, s\u00f3n les diferents accions que es poden realitzar. Per exemple: namespace App\\Controller ; ... class MovieController { const MAX_SIZE = 1024 * 1000 ; private MovieRepository $movieRepository ; public function __construct () { $mapper = new MovieMapper (); $this -> movieRepository = new MovieRepository ( $mapper ); } public function list () { $movies = $this -> movieRepository -> findAll (); $logger = Registry :: get ( Registry :: LOGGER ); $logger -> info ( \"s'ha executat una consulta\" ); require __DIR__ . \"/../../views/index.view.php\" ; } ... } En aquest exemple, en sol\u00b7licitar la p\u00e0gina principal (\"/\"), el enrutador activaria el m\u00e8tode list del controlador MovieController que obt\u00e9 les pel\u00b7l\u00edcules mitjan\u00e7ant el repositori. Com que la vista, a hores d'ara, es troba en el mateix \u00e0mbit d'execuci\u00f3, podr\u00e0 accedir a les dades generades i mostrar-les.","title":"Els controladors"},{"location":"07-mvc/07-03-classe-request-response/","text":"Request i Response Altres classes que solen trobar-se en les frameworks MVC s\u00f3n les classes Request i Response . El seu objectiu \u00e9s encapsular les funcionalitats relacionades amb la sol\u00b7licitud de l'usuari i la resposta. La classe Request La classe Request ser\u00e0 la responsable de gestionar les sol\u00b7licituds dels usuaris. A m\u00e9s, pot tenir m\u00e8todes orientats a obtenir informaci\u00f3 de la sol\u00b7licitud. <? php namespace App ; class Request { const GET = 'GET' ; const POST = 'POST' ; private $domain ; private $path ; private $method ; private $request ; private $query ; private $cookies ; public function __construct () { $this -> domain = $_SERVER [ 'HTTP_HOST' ]; $this -> path = explode ( '?' , $_SERVER [ 'REQUEST_URI' ])[ 0 ]; $this -> method = $_SERVER [ 'REQUEST_METHOD' ]; $this -> query = new FilteredMap ( $_GET ); $this -> request = new FilteredMap ( $_POST ); $this -> cookies = new FilteredMap ( $_COOKIE ); } public function getUrl () : string { return $this -> domain . $this -> path ; } public function getDomain () : string { return $this -> domain ; } public function getPath () : string { return $this -> path ; } public function getMethod () : string { return $this -> method ; } public function isPost () : bool { return $this -> method === self :: POST ; } public function isGet () : bool { return $this -> method === self :: GET ; } public function getRequest () : FilteredMap { return $this -> request ; } public function getQuery () : FilteredMap { return $this -> query ; } public function getCookies () : FilteredMap { return $this -> cookies ; } } La classe FilteredMap facilita l'acc\u00e9s a les dades de la sol\u00b7licitud. lass FilteredMap { private $map ; public function __construct ( array $baseMap ) { $this -> map = $baseMap ; } public function has ( string $name ) : bool { return isset ( $this -> map [ $name ]); } public function getInt ( string $name ) { return ( int ) $this -> get ( $name ); } public function getNumber ( string $name ) { return ( float ) $this -> get ( $name ); } public function getString ( string $name , bool $filter = true ) { $value = ( string ) $this -> get ( $name ); return $filter ? addslashes ( $value ) : $value ; } public function get ( string $name ) { return $this -> map [ $name ] ?? null ; } } La classe Response Aquesta classe preparar\u00e0 la resposta al navegador. Establir\u00e0 el codi d'estat, el tipus del recurs i el propi recurs mitjan\u00e7ant un sistema de plantilles. class Response { private int $status ; private string $mime ; private string $layout = 'default' ; private string $view ; private array $data = []; public function __construct ( int $status = 200 , string $mime = \"text/html\" ) { $this -> status = $status ; $this -> mime = $mime ; } public function writeHeaders () { header ( $_SERVER [ \"SERVER_PROTOCOL\" ] . ' ' . $this -> status ); header ( 'Content-Type: {$this->mime}; charset=UTF-8' ); } /** * @param string $view * @param string $layout * @param array $data * @return string */ public function render () : string { extract ( $this -> data ); ob_start (); require __DIR__ . \"/../views/ { $this -> view } .view.php\" ; $content = ob_get_clean (); ob_start (); require __DIR__ . \"/../views/layouts/ { $this -> layout } .layout.php\" ; return ob_get_clean (); } public function setView ( string $view ) { $this -> view = $view ; } public function setLayout ( string $layout ) { $this -> layout = $layout ; } public function setData ( array $compact ) { $this -> data = $compact ; } En executar un controlador caldr\u00e0 que tornaren un objecte Response . // MovieController.php public function list () : Response { $message = FlashMessage :: get ( \"message\" ); $movies = $this -> movieRepository -> findAll (); $logger = Registry :: get ( Registry :: LOGGER ); $logger -> info ( \"s'ha executat una consulta\" ); $response = new Response (); $response -> setView ( \"index\" ); $response -> setLayout ( \"default\" ); $response -> setData ( compact ( 'movies' )); return $response ; //require __DIR__ . \"/../../views/index.view.php\"; } I caldr\u00e0 modificar el controlador frontal: if ( method_exists ( $controller , $method )) { $object = new $controller ; //call_user_func_array([$object, $method], $match['params']); $response = call_user_func_array ([ $object , $method ], $match [ 'params' ]); $response -> writeHeaders (); echo $response -> render ();","title":"Request i Response"},{"location":"07-mvc/07-03-classe-request-response/#request-i-response","text":"Altres classes que solen trobar-se en les frameworks MVC s\u00f3n les classes Request i Response . El seu objectiu \u00e9s encapsular les funcionalitats relacionades amb la sol\u00b7licitud de l'usuari i la resposta.","title":"Request i Response"},{"location":"07-mvc/07-03-classe-request-response/#la-classe-request","text":"La classe Request ser\u00e0 la responsable de gestionar les sol\u00b7licituds dels usuaris. A m\u00e9s, pot tenir m\u00e8todes orientats a obtenir informaci\u00f3 de la sol\u00b7licitud. <? php namespace App ; class Request { const GET = 'GET' ; const POST = 'POST' ; private $domain ; private $path ; private $method ; private $request ; private $query ; private $cookies ; public function __construct () { $this -> domain = $_SERVER [ 'HTTP_HOST' ]; $this -> path = explode ( '?' , $_SERVER [ 'REQUEST_URI' ])[ 0 ]; $this -> method = $_SERVER [ 'REQUEST_METHOD' ]; $this -> query = new FilteredMap ( $_GET ); $this -> request = new FilteredMap ( $_POST ); $this -> cookies = new FilteredMap ( $_COOKIE ); } public function getUrl () : string { return $this -> domain . $this -> path ; } public function getDomain () : string { return $this -> domain ; } public function getPath () : string { return $this -> path ; } public function getMethod () : string { return $this -> method ; } public function isPost () : bool { return $this -> method === self :: POST ; } public function isGet () : bool { return $this -> method === self :: GET ; } public function getRequest () : FilteredMap { return $this -> request ; } public function getQuery () : FilteredMap { return $this -> query ; } public function getCookies () : FilteredMap { return $this -> cookies ; } } La classe FilteredMap facilita l'acc\u00e9s a les dades de la sol\u00b7licitud. lass FilteredMap { private $map ; public function __construct ( array $baseMap ) { $this -> map = $baseMap ; } public function has ( string $name ) : bool { return isset ( $this -> map [ $name ]); } public function getInt ( string $name ) { return ( int ) $this -> get ( $name ); } public function getNumber ( string $name ) { return ( float ) $this -> get ( $name ); } public function getString ( string $name , bool $filter = true ) { $value = ( string ) $this -> get ( $name ); return $filter ? addslashes ( $value ) : $value ; } public function get ( string $name ) { return $this -> map [ $name ] ?? null ; } }","title":"La classe Request"},{"location":"07-mvc/07-03-classe-request-response/#la-classe-response","text":"Aquesta classe preparar\u00e0 la resposta al navegador. Establir\u00e0 el codi d'estat, el tipus del recurs i el propi recurs mitjan\u00e7ant un sistema de plantilles. class Response { private int $status ; private string $mime ; private string $layout = 'default' ; private string $view ; private array $data = []; public function __construct ( int $status = 200 , string $mime = \"text/html\" ) { $this -> status = $status ; $this -> mime = $mime ; } public function writeHeaders () { header ( $_SERVER [ \"SERVER_PROTOCOL\" ] . ' ' . $this -> status ); header ( 'Content-Type: {$this->mime}; charset=UTF-8' ); } /** * @param string $view * @param string $layout * @param array $data * @return string */ public function render () : string { extract ( $this -> data ); ob_start (); require __DIR__ . \"/../views/ { $this -> view } .view.php\" ; $content = ob_get_clean (); ob_start (); require __DIR__ . \"/../views/layouts/ { $this -> layout } .layout.php\" ; return ob_get_clean (); } public function setView ( string $view ) { $this -> view = $view ; } public function setLayout ( string $layout ) { $this -> layout = $layout ; } public function setData ( array $compact ) { $this -> data = $compact ; } En executar un controlador caldr\u00e0 que tornaren un objecte Response . // MovieController.php public function list () : Response { $message = FlashMessage :: get ( \"message\" ); $movies = $this -> movieRepository -> findAll (); $logger = Registry :: get ( Registry :: LOGGER ); $logger -> info ( \"s'ha executat una consulta\" ); $response = new Response (); $response -> setView ( \"index\" ); $response -> setLayout ( \"default\" ); $response -> setData ( compact ( 'movies' )); return $response ; //require __DIR__ . \"/../../views/index.view.php\"; } I caldr\u00e0 modificar el controlador frontal: if ( method_exists ( $controller , $method )) { $object = new $controller ; //call_user_func_array([$object, $method], $match['params']); $response = call_user_func_array ([ $object , $method ], $match [ 'params' ]); $response -> writeHeaders (); echo $response -> render ();","title":"La classe Response"},{"location":"07-mvc/07-04-injecci%C3%B3%20de%20depend%C3%A8ncies/","text":"Qu\u00e8 necessites? La injecci\u00f3 de depend\u00e8ncies La injecci\u00f3 de depend\u00e8ncies ( dependency injection ) \u00e9s un patr\u00f3 de disseny orientat a objectes en qu\u00e8 es subministren els objectes a una classe en lloc de ser la pr\u00f2pia classe la que creu aquests objectes. Aquests objectes compleixen contractes (interf\u00edcies, classes abstractes) que necessiten les nostres classes per poder funcionar (d'aqu\u00ed el concepte de depend\u00e8ncia). Les nostres classes no creen els objectes que necessiten, sin\u00f3 que se'ls subministra una altra classe 'contenidora' que injectar\u00e0 la implementaci\u00f3 desitjada al nostre contracte. Simplificant: La injecci\u00f3 de depend\u00e8ncies proporciona a una classe les seves depend\u00e8ncies ja siga mitjan\u00e7ant la injecci\u00f3 del constructor, crides a m\u00e8todes o l\u2019establiment de propietats. Exemple: https://github.com/Seldaek/monolog/blob/master/doc/01-usage.md Contenidor de serveis El contenidor de serveis \u00e9s una utilitat que ajuda a la implementaci\u00f3 de la injecci\u00f3 de depend\u00e8ncies. S'encarrega de registrar totes les deped\u00e8ncies (objectes) de l'aplicaci\u00f3 web en un array. L'aplicaci\u00f3 web les extraur\u00e0 i injectar\u00e0 quan les necessite. En el nostre cas el contenidor de serveis ser\u00e0 la classe App . # src/Core/App.php class App { private static $container = array (); public static function bind ( $key , $value ) { static :: $container [ $key ] = $value ; } public static function get ( $key ) { if ( ! array_key_exists ( $key , static :: $container )) { throw new Exception ( \"The $key doesn't in the container\" ); } return static :: $container [ $key ]; } } Autowiring Autowiring \u00e9s una palabra ex\u00f3tica que representa una cosa molt senzilla: la capacitat del contenidor per a crear i injectar depend\u00e8ncies autom\u00e0ticament. La idea b\u00e0sica \u00e9s que quan es cride un m\u00e8tode d'un classe, si s'ha indicat el tipus de dada de l'argument en la declaraci\u00f3 del m\u00e8tode, el contenidor busque una inst\u00e0ncia d'eixa classe i la injecte autom\u00e0ticament. Per exemple: class DatabaseConnection { // ... } class MovieModel { public function __construct ( DatabaseConnection $DBconnection ) { // ... } } Quan el contenidor necessite crear un objecte MovieModel, detectar\u00e0 que aquesta classe necessita un objecte DatabaseConnection i l'injectar\u00e0 autom\u00e0ticament. Aquesta \u00e9s una funcionalitat molt important en els frameworks PHP moderns, la posarem en pr\u00e0ctica quan treballem en un d'ells. En el nostre projecte accedirem a les inst\u00e0ncies mitjan\u00e7ant el m\u00e8tode App::get() ; M\u00e9s informaci\u00f3: * https://php-di.org/doc/autowiring.html","title":"Qu\u00e8 necessites? La injecci\u00f3 de depend\u00e8ncies"},{"location":"07-mvc/07-04-injecci%C3%B3%20de%20depend%C3%A8ncies/#que-necessites-la-injeccio-de-dependencies","text":"La injecci\u00f3 de depend\u00e8ncies ( dependency injection ) \u00e9s un patr\u00f3 de disseny orientat a objectes en qu\u00e8 es subministren els objectes a una classe en lloc de ser la pr\u00f2pia classe la que creu aquests objectes. Aquests objectes compleixen contractes (interf\u00edcies, classes abstractes) que necessiten les nostres classes per poder funcionar (d'aqu\u00ed el concepte de depend\u00e8ncia). Les nostres classes no creen els objectes que necessiten, sin\u00f3 que se'ls subministra una altra classe 'contenidora' que injectar\u00e0 la implementaci\u00f3 desitjada al nostre contracte. Simplificant: La injecci\u00f3 de depend\u00e8ncies proporciona a una classe les seves depend\u00e8ncies ja siga mitjan\u00e7ant la injecci\u00f3 del constructor, crides a m\u00e8todes o l\u2019establiment de propietats. Exemple: https://github.com/Seldaek/monolog/blob/master/doc/01-usage.md","title":"Qu\u00e8 necessites? La injecci\u00f3 de depend\u00e8ncies"},{"location":"07-mvc/07-04-injecci%C3%B3%20de%20depend%C3%A8ncies/#contenidor-de-serveis","text":"El contenidor de serveis \u00e9s una utilitat que ajuda a la implementaci\u00f3 de la injecci\u00f3 de depend\u00e8ncies. S'encarrega de registrar totes les deped\u00e8ncies (objectes) de l'aplicaci\u00f3 web en un array. L'aplicaci\u00f3 web les extraur\u00e0 i injectar\u00e0 quan les necessite. En el nostre cas el contenidor de serveis ser\u00e0 la classe App . # src/Core/App.php class App { private static $container = array (); public static function bind ( $key , $value ) { static :: $container [ $key ] = $value ; } public static function get ( $key ) { if ( ! array_key_exists ( $key , static :: $container )) { throw new Exception ( \"The $key doesn't in the container\" ); } return static :: $container [ $key ]; } }","title":"Contenidor de serveis"},{"location":"07-mvc/07-04-injecci%C3%B3%20de%20depend%C3%A8ncies/#autowiring","text":"Autowiring \u00e9s una palabra ex\u00f3tica que representa una cosa molt senzilla: la capacitat del contenidor per a crear i injectar depend\u00e8ncies autom\u00e0ticament. La idea b\u00e0sica \u00e9s que quan es cride un m\u00e8tode d'un classe, si s'ha indicat el tipus de dada de l'argument en la declaraci\u00f3 del m\u00e8tode, el contenidor busque una inst\u00e0ncia d'eixa classe i la injecte autom\u00e0ticament. Per exemple: class DatabaseConnection { // ... } class MovieModel { public function __construct ( DatabaseConnection $DBconnection ) { // ... } } Quan el contenidor necessite crear un objecte MovieModel, detectar\u00e0 que aquesta classe necessita un objecte DatabaseConnection i l'injectar\u00e0 autom\u00e0ticament. Aquesta \u00e9s una funcionalitat molt important en els frameworks PHP moderns, la posarem en pr\u00e0ctica quan treballem en un d'ells. En el nostre projecte accedirem a les inst\u00e0ncies mitjan\u00e7ant el m\u00e8tode App::get() ; M\u00e9s informaci\u00f3: * https://php-di.org/doc/autowiring.html","title":"Autowiring"},{"location":"07-mvc/07-98-bibliografia/","text":"Bibliografia WIKIPEDIA CONTRIBUTORS. Front controller [en l\u00ednia]. https://en.wikipedia.org/w/index.php?title=Front_controller&oldid=965938044 . Data de consulta: 20/11/2020.","title":"Bibliografia"},{"location":"07-mvc/07-98-bibliografia/#bibliografia","text":"WIKIPEDIA CONTRIBUTORS. Front controller [en l\u00ednia]. https://en.wikipedia.org/w/index.php?title=Front_controller&oldid=965938044 . Data de consulta: 20/11/2020.","title":"Bibliografia"},{"location":"07-mvc/07-99-activitats/","text":"Bibliografia WIKIPEDIA CONTRIBUTORS. Front controller [en l\u00ednia]. https://en.wikipedia.org/w/index.php?title=Front_controller&oldid=965938044 . Data de consulta: 20/11/2020.","title":"Bibliografia"},{"location":"07-mvc/07-99-activitats/#bibliografia","text":"WIKIPEDIA CONTRIBUTORS. Front controller [en l\u00ednia]. https://en.wikipedia.org/w/index.php?title=Front_controller&oldid=965938044 . Data de consulta: 20/11/2020.","title":"Bibliografia"},{"location":"08-symfony/00-index/","text":"Introducci\u00f3 a Symfony","title":"Introducci\u00f3 a Symfony"},{"location":"08-symfony/00-index/#introduccio-a-symfony","text":"","title":"Introducci\u00f3 a Symfony"},{"location":"08-symfony/01-introducci%C3%B3-va/","text":"Introducci\u00f3 als frameworks PHP i a Symfony Objectius Comprendre la import\u00e0ncia de l'\u00fas de frameworks per al desenvolupament d'aplicacions Entendre la arquitectura de les aplicacions Symfony. Desenvolupar una aplicaci\u00f3 amb Symfony. Continguts Instalaci\u00f3n y configuraci\u00f3n de Symfony Arquitectura MVC Introducci\u00f3 a YAML Vistes Motor de plantilles Twig Injecci\u00f3 de depend\u00e8ncies: Contenidors El model Doctrine Creaci\u00f3 i validaci\u00f3 de formularis Seguretat i Control d\u2019acc\u00e9s Bundles Continguts procedimentals Instal\u00b7laci\u00f3 i configuraci\u00f3 de Symfony 5. \u00das del motor de plantilles Twing per creaci\u00f3 de vistes. Implementaci\u00f3 de contenidors de serveis per a la injecci\u00f3 de depend\u00e8ncies. \u00das de l'ORM Doctrine per treballar amb la base de dades Creaci\u00f3 i validaci\u00f3 de formularis utilitzant form builder . Implementaci\u00f3 de control d'acc\u00e9s Inserci\u00f3 de bundles en el nostre projecte Frameworks PHP Un framework \u00e9s una eina que proporciona una s\u00e8rie de m\u00f2duls que ajuden a organitzar i desenvolupar un producte de programari. En el cas concret dels frameworks PHP, la majoria d'ells proporcionen una s\u00e8rie de comandos o eines per a crear projectes amb una estructura determinada (normalment, seguint el patr\u00f3 MVC), de manera que ja donen una base de treball feta, i facilitats per a poder crear el model de dades, la connexi\u00f3 a la base de dades, les rutes de les diferents seccions de l'aplicaci\u00f3, etc. Exemples de frameworks PHP Actualment existeix una gran varietat de frameworks PHP que triar per a desenvolupar les nostres aplicacions. Alguns dels m\u00e9s populars s\u00f3n: Laravel , un framework relativament recent (va ser creat en 2011), i que ha guanyat bastant popularitat en els \u00faltims anys. La seua filosofia \u00e9s el poder desenvolupar projectes de forma elegant i simple. Compta amb una \u00e0mplia comunitat de suport darrere, i se li augura un futur bastant consolidat. Symfony , el framework que emprarem en aquest curs. Creat en 2005, compta amb m\u00e9s cam\u00ed fet que Laravel, i una estructura m\u00e9s consolidada. En les seues primeres versions es presentava com un framework m\u00e9s monol\u00edtic (s'instal\u00b7laven massa m\u00f2duls que despr\u00e9s no necessit\u00e0vem), per\u00f2 recentment ha adaptat la seua estructura per a fer-la m\u00e9s modular. Est\u00e0 molt orientat al patr\u00f3 MVC, i a una estructura r\u00edgida i correcta de fer aplicacions. CodeIgniter , un framework m\u00e9s lleuger que els anteriors, per\u00f2 tamb\u00e9 amb un ampli grup de seguidors i desenvolupadors. Va ser creat en 2006 i, encara que ha patit una etapa d'aband\u00f3, ha tornat a agafar for\u00e7a en els \u00faltims anys, potser a causa de la seua simplicitat d'\u00fas. Phalcon , un altre framework de recent creaci\u00f3 (2012), amb una potent capacitat de processament de p\u00e0gines PHP, i la possibilitat de treballar com microframework (m\u00e9s lleuger, per a oferir funcionalitats molt espec\u00edfiques) o com framework complet. De fet, molts frameworks m\u00e9s antics tamb\u00e9 han incorporat recentment la possibilitat d'executar-los com microframeworks. CakePHP , creat en 2005, \u00e9s un altre framework similar a CodeIgniter quant a simplicitat i facilitat d'\u00fas. T\u00e9 una \u00e0mplia comunitat tamb\u00e9 darrere que li d\u00f3na suport. Zend , creat en 2006, \u00e9s un altre framework bastant popular, encara que potser amb menor visibilitat que els anteriors avui dia. ... etc. Quasi tots els frameworks PHP tenen una s\u00e8rie de caracter\u00edstiques comunes, com s\u00f3n l'\u00fas del patr\u00f3 MVC per a desenvolupar els seus projectes, la injecci\u00f3 de depend\u00e8ncies per a gestionar recursos tals com a connexions a bases de dades o elements compartits per tota l'aplicaci\u00f3, la possibilitat de desenvolupar tant webs completes com a serveis REST accessibles des de diversos clients, etc. En el seg\u00fcent article teniu una comparatova entre Laravel i Symfony: PHP Laravel VS Symfony: A Detailed Comparison of Web Development Frameworks Quin triar? A l'hora de decantar-nos per un o un altre framework, no ens haur\u00edem de deixar enganyar per la seua popularitat, en termes de quota de mercat. En aqueix terreny, Symfony i Laravel probablement siguen els m\u00e9s beneficiats, per\u00f2 la corba d'aprenentatge en ells pot ser que siga m\u00e9s pronunciada que en uns altres a priori m\u00e9s senzills, com CodeIgniter o CakePHP. Cada framework pot estar millor orientat que un altre para determinats tipus de projectes o necessitats. Si volem aprendre alguna cosa r\u00e0pida per a llan\u00e7ar l'aplicaci\u00f3 com m\u00e9s prompte millor, potser Symfony no siga la millor opci\u00f3. Si, per contra, preferim fer \u00fas d'un framework amb una comunitat important darrere que ens puga donar suport i ens garantisca un temps de vida llarg, llavors Symfony o Laravel poden ser millors candidats. Per qu\u00e8 Symfony? Arribats a aquest punt... quines caracter\u00edstiques t\u00e9 Symfony que ens hagen fet triar-ho per a aquest curs enfront d'altres frameworks ? El principal inconvenient que pot tenir aquest framework \u00e9s, potser, la seua corba d'aprenentatge, que \u00e9s bastant elevada comparada amb uns altres. No obstant aix\u00f2, els avantatges que ofereix compensen aquest inconvenient: \u00c9s un framework amb molt recorregut (creat en 2005). Desenvolupa versions LTS ( Long Term Support ) que garanteixen un suport a llarg termini. T\u00e9 una gran comunitat darrere, la qual cosa permet trobar f\u00e0cilment ajuda per a problemes que tinguem. T\u00e9 una bona documentaci\u00f3. De fet, en la mateixa p\u00e0gina de Symfony es tenen disponibles alguns llibres editats pel mateix equip de desenvolupament, i una web amb la documentaci\u00f3 oficial de l'actual versi\u00f3. Utilitza (i anima a utilitzar) bones pr\u00e0ctiques de programaci\u00f3 en els projectes. S'enlla\u00e7a b\u00e9 amb altres frameworks i llibreries de tercers molt \u00fatils, denominades bundles . Alguns exemples que utilitzarem en el curs s\u00f3n Twig (un potent motor de plantilles per a desenvolupar les nostres vistes) o Doctrine (un ORM per a poder mapejar les dades en objectes). En realitat, una vegada es coneix un d'aquests frameworks, \u00e9s m\u00e9s senzill assimilar la resta, arribat el moment. Aix\u00ed que Symfony pot ser un bon punt de partida. En concret, durant el curs utilitzarem la versi\u00f3 5 del framework, que es recolza en PHP 7 per a funcionar, com veurem a continuaci\u00f3. Recursos previs A l'hora de treballar amb Symfony 5, necessitem tenir pr\u00e8viament instal\u00b7lats en el nostre sistema una s\u00e8rie de recursos programari, com s\u00f3n: Un servidor web que suporte PHP 7.4 o posterior. En el nostre cas, utilitzarem Apache. Un servidor de bases de dades en el qual emmagatzemar la informaci\u00f3 de les nostres aplicacions. Emprarem un servidor MariaDB/MySQL. PHP (versi\u00f3 7.4 o posterior) El propi framework Symfony. Un IDE (entorn de desenvolupament) amb el qual editar el codi dels nostres projectes. Instal\u00b7lar Apache, MySQL i PHP Per a complir amb els tres primers requisits (Apache, MariaDB/MySQL i PHP) instal\u00b7larem un sistema XAMPP, des del seu web oficial . En el cas de la m\u00e0quina virtual que tenim disponible per al curs, podem instal\u00b7lar-ho descarregant la versi\u00f3 per a Linux. Es tracta d'un arxiu .run . Primer hem de fer-ho executable, escrivint aquest comando des de la carpeta on l'h\u00e0gem descarregat (per exemple, per a la versi\u00f3 7.4.14 de XAMPP, que \u00e9s la que est\u00e0 disponible en el moment d'escriure aquestes anotacions): chmod +x xampp-linux-x64-7.4.14-0-installer.run Despr\u00e9s, ho executem amb permisos de root : sudo ./xampp-linux-x64-7.4.14-0-installer.run S'iniciar\u00e0 un assistent que ens guiar\u00e0 en la instal\u00b7laci\u00f3. Podem deixar totes les opcions marcades per defecte, excepte l'opci\u00f3 sobre Bitnami, que podem desmarcar ja que no ho utilitzarem (\u00e9s una esp\u00e8cie d'assistent que permet instal\u00b7lar altres paquets com Wordpress, Joomla, Moodle... en els nostres projectes web). El panell de control ( manager ) de XAMPP Farem \u00fas del manager que s'haur\u00e0 instal\u00b7lat per a engegar els servidors. Haurem de cercar el manager en q\u00fcesti\u00f3 en la carpeta on s'haja instal\u00b7lat XAMPP. En el cas de Linux, el manager es troba en /opt/lampp/manager\u00ad-linux-\u00adx64.run , que podem executar directament des d'un terminal, amb permisos d'administrador. Si accedim a la carpeta on est\u00e0, el comando quedaria aix\u00ed: sudo ./manager-linux-x64.run Creant un acc\u00e9s directe per al manager en l'escriptori Com pot ser inc\u00f2mode anar a la carpeta de XAMPP per a engegar el manager cada vegada, podem crear un acc\u00e9s directe en l'escriptori. Per a Linux, existeixen diverses formes de fer-ho, vegem una: crearem un arxiu en l'escriptori (el podem cridar, per exemple \"xampp.desktop\"), i l'editem amb un editor de text, deixant-ho aix\u00ed: [Desktop Entry] Encoding=UTF-8 Name=XAMPP Manager Comment=Manager XAMPP Exec=sudo /opt/lampp/manager-linux-x64.run Icon=/opt/lampp/htdocs/favicon.ico Categories=Aplicacions;Programaci\u00f3;Web Version=7.4 Type=Application Terminal=true El que hem fet \u00e9s definir diversos par\u00e0metres de configuraci\u00f3 de l'acc\u00e9s directe. Entre ells, els m\u00e9s destacats s\u00f3n la ruta cap a l'executable (par\u00e0metre exec ) i la icona per a l'acc\u00e9s directe (par\u00e0metre Icon, on hem triat directament una icona que ja ve amb XAMPP). Despr\u00e9s d'a\u00e7\u00f2, fem que l'arxiu xampp.desktop siga executable (amb clic dret, en les seues propietats, podem fer-ho), i ho executem. Pot ser que ens demane la contrasenya per a llan\u00e7ar-ho, i despr\u00e9s ja podrem veure el manager . Instal\u00b7lant Symfony a trav\u00e9s de Composer L'\u00faltim requisit per a comen\u00e7ar a treballar amb Symfony \u00e9s, \u00f2bviament, disposar del framework Symfony. Per a a\u00e7\u00f2, la mateixa web ofereix algunes alternatives, per\u00f2 recomana instal\u00b7lar Symfony a trav\u00e9s de l'eina Composer , que \u00e9s un gestor de depend\u00e8ncies que permet instal\u00b7lar diferents m\u00f2duls o llibreries en un projecte. Cont\u00e9 una base de dades en l\u00ednia amb moltes llibreries disponibles centralitzades, amb el que podem indicar quin(es) volem per a cada projecte concret, i Composer les descarrega i instal\u00b7la per nosaltres. \u00c9s molt similar a altres gestors com NPM ( Node Package Manager ), que s'aplica a llibreries per a Node o Javascript en general. Composer pot instal\u00b7lar-se localment per a cada projecte web, o de forma global per a tot el sistema. Aquesta \u00faltima opci\u00f3 \u00e9s la recomanable en el cas de voler gestionar diversos projectes en el nostre equip, per a no haver d'instal\u00b7lar-ho en tots ells. Per a fer a\u00e7\u00f2, escrivim aquests comandos des de terminal: curl -sS https://getcomposer.org/installer | /opt/lampp/bin/php sudo mv composer.phar /usr/local/bin/composer El que hem fet \u00e9s descarregar Composer amb el comando curl (pot ser que necessites instal\u00b7lar el comando curl si no t'ho el sistema, mitjan\u00e7ant sudo apt-get install curl ). Despr\u00e9s, movem l'arxiu descarregat ( composer.phar ) a la carpeta /usr/local/bin , amb el nom \"composer\", perqu\u00e8 en executar-ho ho trobe en el PATH del sistema. PHP CLI Les ferramentes de Symfony fan \u00fas de l'int\u00e8rpret de PHP, aix\u00ed que hem de tenir configurat el sistema perqu\u00e8 siga capa\u00e7 d'executar la mateixa versi\u00f3 que tenim al servidor Apache, on executar\u00e0 l'aplicaci\u00f3 web. Com a \u00faltim pas, i ja que Composer utilitza l'executable de PHP, necessitem que l'executable estiga tamb\u00e9 en el PATH del sistema, per al que farem el seg\u00fcent: echo \"export PATH= $PATH :/opt/lampp/bin\" >> ~/.bashrc source ~/.bashrc La primera l\u00ednia afig la carpeta /opt/lampp/bin al PATH, amb el que ja es pot localitzar el comando php a nivell global. La segona recarrega el fitxer .bashrc per a fer efectius els canvis. Symfony CLI Opcionalment pots instal\u00b7lar Symfony CLI . Des de la versi\u00f3 5 Symfony inclou un binari anomenat symfony que proporciona totes les eines per a desevolupar aplicacions basades en Symfony de forma local. El IDE per a desenvolupar els projectes Finalment, per a poder desenvolupar els projectes, necessitem un entorn de desenvolupament que ens permeta editar el codi dels fitxers que necessitem. Podem treballar en Visual Studio Code instal\u00b7lant els plugins adients, per\u00f2 com tenim la llic\u00e8ncia educativa de PHPStorm l'emprarem per la seua facilitat d'\u00fas i versatilitat. Primers passos amb Symfony Ara que ja tenim tot el necessari per a comen\u00e7ar a treballar amb Symfony, \u00e9s hora de crear el nostre primer projecte de prova. Veurem quins passos seguir per a crear els projectes, quina estructura tenen i com provar-los. El nostre primer projecte Symfony Per a crear un projecte Symfony, podem descarregar directament el framework i instal\u00b7lar-lo en la nostra carpeta d'aplicaci\u00f3 web, o b\u00e9 utilitzar Composer (opci\u00f3 recomanada). En aquest \u00faltim cas, existeixen dues alternatives per a crear projectes Symfony: composer create-project symfony/skeleton project-name Que crear\u00e0 un projecte amb el nom indicat en la carpeta actual, contenint l'estructura m\u00ednima, sense llibreries de tercers. Ser\u00e0 la nostra responsabilitat afegir-les m\u00e9s tard. Aquesta funcionalitat ha sigut afegida en la versi\u00f3 4 de Symfony, per a permetre que s'instal\u00b7le com a microframework i no deixar un projecte massa pesat per a les nostres necessitats. composer create-project symfony/website-skeleton project-name Que fa el mateix que l'opci\u00f3 anterior, per\u00f2 emplena el projecte amb una s\u00e8rie de depend\u00e8ncies ja instal\u00b7lades de s\u00e8rie. Aquesta opci\u00f3 es deixa per comoditat, i per motius de \"tradici\u00f3\", perqu\u00e8 els desenvolupadors que venien utilitzant Symfony en les seues versions anteriors no aprecien canvis significatius en crear projectes amb les depend\u00e8ncies habituals ja instal\u00b7lades. En versions anteriors, s'instal\u00b7lava el que es coneixia com Symfony Standard Edition , que era una versi\u00f3 molt m\u00e9s extensa, amb diverses depend\u00e8ncies preinstaladas. Sol ser bastant habitual emprar aquesta segona opci\u00f3 per a crear projectes, ja que, encara que ens instal\u00b7la depend\u00e8ncies que pot ser que no arribem a utilitzar, s\u00ed ens instal\u00b7la autom\u00e0ticament unes altres molt requerides, com el motor de plantilles Twig, l'ORM Doctrine, o el gestor de logs Monolog. Per a comen\u00e7ar, crearem un projecte anomenat \"testing\" amb la segona opci\u00f3. Accedim a la carpeta de treball (podem crear una en /home/alumne/projectes-symfony, per exemple), i escrivim aquest comando des de dins d'aqueixa carpeta: composer create-project symfony/website-skeleton testing Estructura general d'un projecte Symfony Despr\u00e9s de completar el comando anterior, s'haur\u00e0 creat una estructura amb diverses carpetes i fitxers dins de /home/alumne/symfony-projects/testing . Si obrim aquesta carpeta des del nostre IDE, podrem veure en el panell esquerre (Explorador) l'estructura del projecte. Aquesta estructura ha variat lleugerament al llarg de les versions per a assemblar-se m\u00e9s a una estructura Unix. En el cas concret d'un projecte Symfony 5, l'estructura queda com segueix: La carpeta bin cont\u00e9 alguns executables del nostre projecte, com console per a escriure comandos de consola, o phpunit per a llan\u00e7ar les proves unit\u00e0ries. Analitzarem el primer d'ells m\u00e9s endavant en aquesta mateixa sessi\u00f3. La carpeta config cont\u00e9 els arxius de configuraci\u00f3 per als diferents \u00e0mbits en qu\u00e8 es desenvolupe el projecte. Per defecte es defineixen 3 \u00e0mbits: dev (per a desenvolupament), prod (per a posada en producci\u00f3) i test (per a proves), encara que podem afegir els que vulguem. Cada \u00e0mbit cont\u00e9 uns arxius de configuraci\u00f3 YAML (veurem m\u00e9s endavant en qu\u00e8 consisteix aquest format), per a poder especificar opcions concretes. Per exemple, en l'\u00e0mbit dev ens pot interessar que es mostre tota la informaci\u00f3 necess\u00e0ria per pantalla, o a un arxiu, mentre que en l'\u00e1mbido prod prevaldr\u00e0 m\u00e9s l'efici\u00e8ncia. En qualsevol cas, fonamentalment emprarem aquesta carpeta per a configurar rutes i serveis, com veurem en sessions posteriors. La carpeta migrations contindr\u00e0 els canvis en la base de dades i que veurem m\u00e9s avant. La carpeta public contindr\u00e0 la part p\u00fablica o est\u00e0tica de la web. Ac\u00ed col\u00b7locarem fulles d'estils CSS, arxius Javascript per a la part del client, p\u00e0gines est\u00e0tiques HTML o PHP... La carpeta src cont\u00e9 el codi font PHP pr\u00f2piament dit, \u00e9s a dir, les classes que conformaran el nostre model de dades, i els controladors de l'aplicaci\u00f3, fonamentalment. Tamb\u00e9 hi ha elements importants, com l'arxiu Kernel.php , que d'alguna forma controla la resta de la configuraci\u00f3: estableix quins bundles han d'activar-se, i per a quins \u00e0mbits, entre altres coses. La carpeta templates contindr\u00e0 les plantilles per a les vistes, \u00e9s a dir p\u00e0gines que es preprocesar\u00e1n pel motor de plantilles (Twig, en el nostre cas) per a generar les vistes de l'aplicaci\u00f3, com veurem m\u00e9s endavant. La carpeta tests es destina al desenvolupament de proves. La carpeta translations s'utilitza per a opcions d'internacionalitzaci\u00f3 La carpeta var s'empra per a arxius temporals, com per exemple arxius de cach\u00e9 o de log. La carpeta vendor s'empra per a instal\u00b7lar els bundles de tercers que ens descarreguem, com tamb\u00e9 veurem en sessions posteriors. Provant el nostre projecte Per a poder provar el projecte, i tenint en compte que ho hem creat fora de la carpeta de treball per defecte de XAMPP (/opt/lampp/htdocs), hem de crear un virtual host que apunte a la nostra carpeta. Per a a\u00e7\u00f2, seguim aquests passos: Edita l'arxiu /etc/hosts (amb permisos d'administrador) per a afegir un nou domini local per a la nostra aplicaci\u00f3. Cridarem al domini symfony-testing : 127.0.0.1 symfony-testing 2. Hem d'editar un arxiu de configuraci\u00f3 secundari de XAMPP per a donar permisos d'acc\u00e9s a la nostra carpeta de treball. L'arxiu en q\u00fcesti\u00f3 \u00e9s /opt/lampp/apache2/conf/httpd.conf , i hem d'afegir al final la seg\u00fcent entrada: <Directory \"/home/alumne/symfony-projects/testing\" > Options Indexes FollowSymLinks AllowOverride All Require all granted </Directory> 3. Habilita la creaci\u00f3 d'hosts virtuals en Apache, editant l'arxiu principal de configuraci\u00f3 /opt/lampp/etc/httpd.conf i descomentant la l\u00ednia que apareix en negreta, que est\u00e0 quasi al final de l'arxiu: # Virtual hosts Include etc/extra/httpd-vhosts.conf 4. Edita l'arxiu /opt/lampp/etc/extra/httpd-\u00advhosts.conf i afig un nou host virtual per a la nostra aplicaci\u00f3. En el nostre cas, haur\u00e0 de quedar-te aix\u00ed, si has seguit els passos anteriors per a crear el projecte en la carpeta corresponent: <VirtualHost *:80 > DocumentRoot \"/home/alumne/symfony-projects/testing/public\" ServerName symfony-testing </VirtualHost> 5. Reinicia el servidor Apache, i intenta accedir a http://symfony-testing , per a veure la p\u00e0gina d'inici: Nota Per a les seg\u00fcents aplicacions que faces, no ser\u00e0 necessari realitzar els passos 2 i 3, ja que amb a\u00e7\u00f2 ja haur\u00e0s donat permisos d'acc\u00e9s a la teua carpeta de treball, i deixat habilitats els hosts virtuals per al futur. Distribuir els nostres projectes Symfony Si fas una ullada a la grand\u00e0ria de la carpeta /home/alumne/symfony-projects/testing del projecte que hem creat, comprovar\u00e0s que ocupa bastants megues. Gran part d'aqueixa grand\u00e0ria es deu a les depend\u00e8ncies que per defecte s'instal\u00b7len en crear el projecte amb l'opci\u00f3 website-\u00adskeleton , i la grand\u00e0ria creixer\u00e0 m\u00e9s encara si necessitem instal\u00b7lar alguna altra depend\u00e8ncia addicional a les quals ja v\u00e9nen. omissi\u00f3 de directoris \u00d2bviament, distribuir una carpeta d'aqueixa grand\u00e0ria no \u00e9s c\u00f2mode, ni recomanable. En lloc d'a\u00e7\u00f2, el que pots fer \u00e9s ometre la subcarpeta vendor , que \u00e9s on s'instal\u00b7len totes les depend\u00e8ncies externes. Aquest fet no suposa cap problema, ja que, una vegada obtingut el projecte Symfony, es pot regenerar la carpeta amb aquest comando (des de la carpeta principal del projecte Symfony en q\u00fcesti\u00f3): composer install que simplement torna a crear la carpeta vendor i reinstal\u00b7la dins les depend\u00e8ncies que figuren en l'arxiu composer.json , que per defecte cont\u00e9 totes les depend\u00e8ncies necess\u00e0ries per al website-\u00adskeleton . M\u00e9s endavant veurem com afegir m\u00e9s depend\u00e8ncies als projectes Symfony. La consola de Symfony En analitzar l'estructura d'un projecte Symfony, hem vist que existeix una carpeta bin amb un parell d'arxius executables a trav\u00e9s de PHP. Un d'ells s'empra per a proves unit\u00e0ries (phpunit), i no ho veurem en el curs per motius de temps, i l'altre ( console ) s\u00ed \u00e9s m\u00e9s \u00e0mpliament utilitzat per a ajudar-nos a certes tasques, com per exemple crear entitats, engegar un servidor de proves, examinar serveis, etc. Per a comen\u00e7ar, prova a obrir un terminal i situar-te en la carpeta del projecte \"testing\" de Symfony que hem creat aquesta sessi\u00f3. Pots fer a\u00e7\u00f2 directament si obris el terminal integrat en l'IDE. Prova a executar aquest comando: php bin/console debug:autowiring Obtindr\u00e0s un llistat dels serveis que hi ha actualment predefinits en Symfony (m\u00e9s endavant veurem qu\u00e8 \u00e9s a\u00e7\u00f2 dels serveis). Existeixen altres comandos \u00fatils, com un petit servidor PHP per a poder provar r\u00e0pidament el projecte sense necessitat d'Apache, o altres comandos per a crear certs elements de l'aplicaci\u00f3 o examinar-los. Els anirem veient m\u00e9s endavant. Problemes amb permisos Els requeriments de permisos de Symfony s\u00f3n senzills d'aplicar, en cas que hi haja algun problema aquest article aporta informaci\u00f3 d'inter\u00e8s Setting up or Fixing file Permissions Introducci\u00f3 a YAML La configuraci\u00f3 dels projectes Symfony, per defecte, es defineix mitjan\u00e7ant arxius YAML. Aquests arxius s\u00f3n una alternativa al format XML, m\u00e9s llargs i enutjosos normalment, i al propi format PHP, m\u00e9s complicat d'escriure. Podr\u00edem dir que suposa un terme mitj\u00e0 quant a facilitat d'\u00fas i concreci\u00f3, i s\u00f3n arxius que es poden executar sobre la marxa. A\u00e7\u00f2 t\u00e9 l'incoveniente que els possibles errors (de sintaxis, per exemple) no es mostraran fins que l'aplicaci\u00f3 no s'execute. L'est\u00e0ndard YAML \u00e9s molt ampli (es pot consultar en el seu web oficial), per\u00f2 per a Symfony nom\u00e9s \u00e9s necessari emprar un subconjunt redu\u00eft. Com podem veure si editem qualsevol arxiu YAML d'un projecte Symfony, la informaci\u00f3 s'estructura en parelles clau, valor. Si la clau o el valor estan compostos per m\u00e9s d'una paraula separades per espais, es tanquen entre cometes dobles (encara que no \u00e9s habitual). driver : 'pdo_mysql' La jerarquia de la informaci\u00f3 s'estableix mitjan\u00e7ant indentacions, per\u00f2 aquestes no han de fer-se amb el tabulador, sin\u00f3 amb la barra espaciadora (quatre espais per nivell). default_table_options : charset : utf8mb collate : utf8mb4_unicode_ci Pot haver-hi grups d'elements clau: valor, formant arrays. Aquests arrays van entre claud\u00e0tors, en el cas d'arrays normals, o entre claus, en el cas d'arrays associatius: rols : [ ROLE_USER , ROLE_ADMIN ] users : admin : { password : adminpass , rols : [ ROLE_ADMIN ] } user : { password : userpass , rols : [ ROLE_USER ] } Tamb\u00e9 es pot indicar una matriu ( array ) escrivint cada element en una nova l\u00ednia que comence per - . App\\ : resource : '../src/' exclude : - '../src/DependencyInjection/' - '../src/Entity/' - '../src/Kernel.php' Els comentaris s'indiquen amb un coixinet al principi de cada l\u00ednia del comentari. # in-memory users users : admin : ... La primera clau de cada arxiu YAML \u00e9s la seua clau principal, que cont\u00e9 a la resta de claus i valors (la resta van indentadas un o diversos nivells respecte a aquesta). Quan s'executa l'aplicaci\u00f3, Symfony converteix aquests arxius YAML en arxius PHP amb un codi equivalent.","title":"Introducci\u00f3 als frameworks PHP i a Symfony"},{"location":"08-symfony/01-introducci%C3%B3-va/#introduccio-als-frameworks-php-i-a-symfony","text":"Objectius Comprendre la import\u00e0ncia de l'\u00fas de frameworks per al desenvolupament d'aplicacions Entendre la arquitectura de les aplicacions Symfony. Desenvolupar una aplicaci\u00f3 amb Symfony. Continguts Instalaci\u00f3n y configuraci\u00f3n de Symfony Arquitectura MVC Introducci\u00f3 a YAML Vistes Motor de plantilles Twig Injecci\u00f3 de depend\u00e8ncies: Contenidors El model Doctrine Creaci\u00f3 i validaci\u00f3 de formularis Seguretat i Control d\u2019acc\u00e9s Bundles Continguts procedimentals Instal\u00b7laci\u00f3 i configuraci\u00f3 de Symfony 5. \u00das del motor de plantilles Twing per creaci\u00f3 de vistes. Implementaci\u00f3 de contenidors de serveis per a la injecci\u00f3 de depend\u00e8ncies. \u00das de l'ORM Doctrine per treballar amb la base de dades Creaci\u00f3 i validaci\u00f3 de formularis utilitzant form builder . Implementaci\u00f3 de control d'acc\u00e9s Inserci\u00f3 de bundles en el nostre projecte","title":"Introducci\u00f3 als frameworks PHP i a Symfony"},{"location":"08-symfony/01-introducci%C3%B3-va/#frameworks-php","text":"Un framework \u00e9s una eina que proporciona una s\u00e8rie de m\u00f2duls que ajuden a organitzar i desenvolupar un producte de programari. En el cas concret dels frameworks PHP, la majoria d'ells proporcionen una s\u00e8rie de comandos o eines per a crear projectes amb una estructura determinada (normalment, seguint el patr\u00f3 MVC), de manera que ja donen una base de treball feta, i facilitats per a poder crear el model de dades, la connexi\u00f3 a la base de dades, les rutes de les diferents seccions de l'aplicaci\u00f3, etc.","title":"Frameworks PHP"},{"location":"08-symfony/01-introducci%C3%B3-va/#exemples-de-frameworks-php","text":"Actualment existeix una gran varietat de frameworks PHP que triar per a desenvolupar les nostres aplicacions. Alguns dels m\u00e9s populars s\u00f3n: Laravel , un framework relativament recent (va ser creat en 2011), i que ha guanyat bastant popularitat en els \u00faltims anys. La seua filosofia \u00e9s el poder desenvolupar projectes de forma elegant i simple. Compta amb una \u00e0mplia comunitat de suport darrere, i se li augura un futur bastant consolidat. Symfony , el framework que emprarem en aquest curs. Creat en 2005, compta amb m\u00e9s cam\u00ed fet que Laravel, i una estructura m\u00e9s consolidada. En les seues primeres versions es presentava com un framework m\u00e9s monol\u00edtic (s'instal\u00b7laven massa m\u00f2duls que despr\u00e9s no necessit\u00e0vem), per\u00f2 recentment ha adaptat la seua estructura per a fer-la m\u00e9s modular. Est\u00e0 molt orientat al patr\u00f3 MVC, i a una estructura r\u00edgida i correcta de fer aplicacions. CodeIgniter , un framework m\u00e9s lleuger que els anteriors, per\u00f2 tamb\u00e9 amb un ampli grup de seguidors i desenvolupadors. Va ser creat en 2006 i, encara que ha patit una etapa d'aband\u00f3, ha tornat a agafar for\u00e7a en els \u00faltims anys, potser a causa de la seua simplicitat d'\u00fas. Phalcon , un altre framework de recent creaci\u00f3 (2012), amb una potent capacitat de processament de p\u00e0gines PHP, i la possibilitat de treballar com microframework (m\u00e9s lleuger, per a oferir funcionalitats molt espec\u00edfiques) o com framework complet. De fet, molts frameworks m\u00e9s antics tamb\u00e9 han incorporat recentment la possibilitat d'executar-los com microframeworks. CakePHP , creat en 2005, \u00e9s un altre framework similar a CodeIgniter quant a simplicitat i facilitat d'\u00fas. T\u00e9 una \u00e0mplia comunitat tamb\u00e9 darrere que li d\u00f3na suport. Zend , creat en 2006, \u00e9s un altre framework bastant popular, encara que potser amb menor visibilitat que els anteriors avui dia. ... etc. Quasi tots els frameworks PHP tenen una s\u00e8rie de caracter\u00edstiques comunes, com s\u00f3n l'\u00fas del patr\u00f3 MVC per a desenvolupar els seus projectes, la injecci\u00f3 de depend\u00e8ncies per a gestionar recursos tals com a connexions a bases de dades o elements compartits per tota l'aplicaci\u00f3, la possibilitat de desenvolupar tant webs completes com a serveis REST accessibles des de diversos clients, etc. En el seg\u00fcent article teniu una comparatova entre Laravel i Symfony: PHP Laravel VS Symfony: A Detailed Comparison of Web Development Frameworks","title":"Exemples de frameworks PHP"},{"location":"08-symfony/01-introducci%C3%B3-va/#quin-triar","text":"A l'hora de decantar-nos per un o un altre framework, no ens haur\u00edem de deixar enganyar per la seua popularitat, en termes de quota de mercat. En aqueix terreny, Symfony i Laravel probablement siguen els m\u00e9s beneficiats, per\u00f2 la corba d'aprenentatge en ells pot ser que siga m\u00e9s pronunciada que en uns altres a priori m\u00e9s senzills, com CodeIgniter o CakePHP. Cada framework pot estar millor orientat que un altre para determinats tipus de projectes o necessitats. Si volem aprendre alguna cosa r\u00e0pida per a llan\u00e7ar l'aplicaci\u00f3 com m\u00e9s prompte millor, potser Symfony no siga la millor opci\u00f3. Si, per contra, preferim fer \u00fas d'un framework amb una comunitat important darrere que ens puga donar suport i ens garantisca un temps de vida llarg, llavors Symfony o Laravel poden ser millors candidats.","title":"Quin triar?"},{"location":"08-symfony/01-introducci%C3%B3-va/#recursos-previs","text":"A l'hora de treballar amb Symfony 5, necessitem tenir pr\u00e8viament instal\u00b7lats en el nostre sistema una s\u00e8rie de recursos programari, com s\u00f3n: Un servidor web que suporte PHP 7.4 o posterior. En el nostre cas, utilitzarem Apache. Un servidor de bases de dades en el qual emmagatzemar la informaci\u00f3 de les nostres aplicacions. Emprarem un servidor MariaDB/MySQL. PHP (versi\u00f3 7.4 o posterior) El propi framework Symfony. Un IDE (entorn de desenvolupament) amb el qual editar el codi dels nostres projectes.","title":"Recursos previs"},{"location":"08-symfony/01-introducci%C3%B3-va/#installar-apache-mysql-i-php","text":"Per a complir amb els tres primers requisits (Apache, MariaDB/MySQL i PHP) instal\u00b7larem un sistema XAMPP, des del seu web oficial . En el cas de la m\u00e0quina virtual que tenim disponible per al curs, podem instal\u00b7lar-ho descarregant la versi\u00f3 per a Linux. Es tracta d'un arxiu .run . Primer hem de fer-ho executable, escrivint aquest comando des de la carpeta on l'h\u00e0gem descarregat (per exemple, per a la versi\u00f3 7.4.14 de XAMPP, que \u00e9s la que est\u00e0 disponible en el moment d'escriure aquestes anotacions): chmod +x xampp-linux-x64-7.4.14-0-installer.run Despr\u00e9s, ho executem amb permisos de root : sudo ./xampp-linux-x64-7.4.14-0-installer.run S'iniciar\u00e0 un assistent que ens guiar\u00e0 en la instal\u00b7laci\u00f3. Podem deixar totes les opcions marcades per defecte, excepte l'opci\u00f3 sobre Bitnami, que podem desmarcar ja que no ho utilitzarem (\u00e9s una esp\u00e8cie d'assistent que permet instal\u00b7lar altres paquets com Wordpress, Joomla, Moodle... en els nostres projectes web).","title":"Instal\u00b7lar Apache, MySQL i PHP"},{"location":"08-symfony/01-introducci%C3%B3-va/#installant-symfony-a-traves-de-composer","text":"L'\u00faltim requisit per a comen\u00e7ar a treballar amb Symfony \u00e9s, \u00f2bviament, disposar del framework Symfony. Per a a\u00e7\u00f2, la mateixa web ofereix algunes alternatives, per\u00f2 recomana instal\u00b7lar Symfony a trav\u00e9s de l'eina Composer , que \u00e9s un gestor de depend\u00e8ncies que permet instal\u00b7lar diferents m\u00f2duls o llibreries en un projecte. Cont\u00e9 una base de dades en l\u00ednia amb moltes llibreries disponibles centralitzades, amb el que podem indicar quin(es) volem per a cada projecte concret, i Composer les descarrega i instal\u00b7la per nosaltres. \u00c9s molt similar a altres gestors com NPM ( Node Package Manager ), que s'aplica a llibreries per a Node o Javascript en general. Composer pot instal\u00b7lar-se localment per a cada projecte web, o de forma global per a tot el sistema. Aquesta \u00faltima opci\u00f3 \u00e9s la recomanable en el cas de voler gestionar diversos projectes en el nostre equip, per a no haver d'instal\u00b7lar-ho en tots ells. Per a fer a\u00e7\u00f2, escrivim aquests comandos des de terminal: curl -sS https://getcomposer.org/installer | /opt/lampp/bin/php sudo mv composer.phar /usr/local/bin/composer El que hem fet \u00e9s descarregar Composer amb el comando curl (pot ser que necessites instal\u00b7lar el comando curl si no t'ho el sistema, mitjan\u00e7ant sudo apt-get install curl ). Despr\u00e9s, movem l'arxiu descarregat ( composer.phar ) a la carpeta /usr/local/bin , amb el nom \"composer\", perqu\u00e8 en executar-ho ho trobe en el PATH del sistema. PHP CLI Les ferramentes de Symfony fan \u00fas de l'int\u00e8rpret de PHP, aix\u00ed que hem de tenir configurat el sistema perqu\u00e8 siga capa\u00e7 d'executar la mateixa versi\u00f3 que tenim al servidor Apache, on executar\u00e0 l'aplicaci\u00f3 web. Com a \u00faltim pas, i ja que Composer utilitza l'executable de PHP, necessitem que l'executable estiga tamb\u00e9 en el PATH del sistema, per al que farem el seg\u00fcent: echo \"export PATH= $PATH :/opt/lampp/bin\" >> ~/.bashrc source ~/.bashrc La primera l\u00ednia afig la carpeta /opt/lampp/bin al PATH, amb el que ja es pot localitzar el comando php a nivell global. La segona recarrega el fitxer .bashrc per a fer efectius els canvis.","title":"Instal\u00b7lant Symfony a trav\u00e9s de Composer"},{"location":"08-symfony/01-introducci%C3%B3-va/#el-ide-per-a-desenvolupar-els-projectes","text":"Finalment, per a poder desenvolupar els projectes, necessitem un entorn de desenvolupament que ens permeta editar el codi dels fitxers que necessitem. Podem treballar en Visual Studio Code instal\u00b7lant els plugins adients, per\u00f2 com tenim la llic\u00e8ncia educativa de PHPStorm l'emprarem per la seua facilitat d'\u00fas i versatilitat.","title":"El IDE per a desenvolupar els projectes"},{"location":"08-symfony/01-introducci%C3%B3-va/#primers-passos-amb-symfony","text":"Ara que ja tenim tot el necessari per a comen\u00e7ar a treballar amb Symfony, \u00e9s hora de crear el nostre primer projecte de prova. Veurem quins passos seguir per a crear els projectes, quina estructura tenen i com provar-los.","title":"Primers passos amb Symfony"},{"location":"08-symfony/01-introducci%C3%B3-va/#el-nostre-primer-projecte-symfony","text":"Per a crear un projecte Symfony, podem descarregar directament el framework i instal\u00b7lar-lo en la nostra carpeta d'aplicaci\u00f3 web, o b\u00e9 utilitzar Composer (opci\u00f3 recomanada). En aquest \u00faltim cas, existeixen dues alternatives per a crear projectes Symfony: composer create-project symfony/skeleton project-name Que crear\u00e0 un projecte amb el nom indicat en la carpeta actual, contenint l'estructura m\u00ednima, sense llibreries de tercers. Ser\u00e0 la nostra responsabilitat afegir-les m\u00e9s tard. Aquesta funcionalitat ha sigut afegida en la versi\u00f3 4 de Symfony, per a permetre que s'instal\u00b7le com a microframework i no deixar un projecte massa pesat per a les nostres necessitats. composer create-project symfony/website-skeleton project-name Que fa el mateix que l'opci\u00f3 anterior, per\u00f2 emplena el projecte amb una s\u00e8rie de depend\u00e8ncies ja instal\u00b7lades de s\u00e8rie. Aquesta opci\u00f3 es deixa per comoditat, i per motius de \"tradici\u00f3\", perqu\u00e8 els desenvolupadors que venien utilitzant Symfony en les seues versions anteriors no aprecien canvis significatius en crear projectes amb les depend\u00e8ncies habituals ja instal\u00b7lades. En versions anteriors, s'instal\u00b7lava el que es coneixia com Symfony Standard Edition , que era una versi\u00f3 molt m\u00e9s extensa, amb diverses depend\u00e8ncies preinstaladas. Sol ser bastant habitual emprar aquesta segona opci\u00f3 per a crear projectes, ja que, encara que ens instal\u00b7la depend\u00e8ncies que pot ser que no arribem a utilitzar, s\u00ed ens instal\u00b7la autom\u00e0ticament unes altres molt requerides, com el motor de plantilles Twig, l'ORM Doctrine, o el gestor de logs Monolog. Per a comen\u00e7ar, crearem un projecte anomenat \"testing\" amb la segona opci\u00f3. Accedim a la carpeta de treball (podem crear una en /home/alumne/projectes-symfony, per exemple), i escrivim aquest comando des de dins d'aqueixa carpeta: composer create-project symfony/website-skeleton testing","title":"El nostre primer projecte Symfony"},{"location":"08-symfony/01-introducci%C3%B3-va/#distribuir-els-nostres-projectes-symfony","text":"Si fas una ullada a la grand\u00e0ria de la carpeta /home/alumne/symfony-projects/testing del projecte que hem creat, comprovar\u00e0s que ocupa bastants megues. Gran part d'aqueixa grand\u00e0ria es deu a les depend\u00e8ncies que per defecte s'instal\u00b7len en crear el projecte amb l'opci\u00f3 website-\u00adskeleton , i la grand\u00e0ria creixer\u00e0 m\u00e9s encara si necessitem instal\u00b7lar alguna altra depend\u00e8ncia addicional a les quals ja v\u00e9nen. omissi\u00f3 de directoris \u00d2bviament, distribuir una carpeta d'aqueixa grand\u00e0ria no \u00e9s c\u00f2mode, ni recomanable. En lloc d'a\u00e7\u00f2, el que pots fer \u00e9s ometre la subcarpeta vendor , que \u00e9s on s'instal\u00b7len totes les depend\u00e8ncies externes. Aquest fet no suposa cap problema, ja que, una vegada obtingut el projecte Symfony, es pot regenerar la carpeta amb aquest comando (des de la carpeta principal del projecte Symfony en q\u00fcesti\u00f3): composer install que simplement torna a crear la carpeta vendor i reinstal\u00b7la dins les depend\u00e8ncies que figuren en l'arxiu composer.json , que per defecte cont\u00e9 totes les depend\u00e8ncies necess\u00e0ries per al website-\u00adskeleton . M\u00e9s endavant veurem com afegir m\u00e9s depend\u00e8ncies als projectes Symfony.","title":"Distribuir els nostres projectes Symfony"},{"location":"08-symfony/01-introducci%C3%B3-va/#introduccio-a-yaml","text":"La configuraci\u00f3 dels projectes Symfony, per defecte, es defineix mitjan\u00e7ant arxius YAML. Aquests arxius s\u00f3n una alternativa al format XML, m\u00e9s llargs i enutjosos normalment, i al propi format PHP, m\u00e9s complicat d'escriure. Podr\u00edem dir que suposa un terme mitj\u00e0 quant a facilitat d'\u00fas i concreci\u00f3, i s\u00f3n arxius que es poden executar sobre la marxa. A\u00e7\u00f2 t\u00e9 l'incoveniente que els possibles errors (de sintaxis, per exemple) no es mostraran fins que l'aplicaci\u00f3 no s'execute. L'est\u00e0ndard YAML \u00e9s molt ampli (es pot consultar en el seu web oficial), per\u00f2 per a Symfony nom\u00e9s \u00e9s necessari emprar un subconjunt redu\u00eft. Com podem veure si editem qualsevol arxiu YAML d'un projecte Symfony, la informaci\u00f3 s'estructura en parelles clau, valor. Si la clau o el valor estan compostos per m\u00e9s d'una paraula separades per espais, es tanquen entre cometes dobles (encara que no \u00e9s habitual). driver : 'pdo_mysql' La jerarquia de la informaci\u00f3 s'estableix mitjan\u00e7ant indentacions, per\u00f2 aquestes no han de fer-se amb el tabulador, sin\u00f3 amb la barra espaciadora (quatre espais per nivell). default_table_options : charset : utf8mb collate : utf8mb4_unicode_ci Pot haver-hi grups d'elements clau: valor, formant arrays. Aquests arrays van entre claud\u00e0tors, en el cas d'arrays normals, o entre claus, en el cas d'arrays associatius: rols : [ ROLE_USER , ROLE_ADMIN ] users : admin : { password : adminpass , rols : [ ROLE_ADMIN ] } user : { password : userpass , rols : [ ROLE_USER ] } Tamb\u00e9 es pot indicar una matriu ( array ) escrivint cada element en una nova l\u00ednia que comence per - . App\\ : resource : '../src/' exclude : - '../src/DependencyInjection/' - '../src/Entity/' - '../src/Kernel.php' Els comentaris s'indiquen amb un coixinet al principi de cada l\u00ednia del comentari. # in-memory users users : admin : ... La primera clau de cada arxiu YAML \u00e9s la seua clau principal, que cont\u00e9 a la resta de claus i valors (la resta van indentadas un o diversos nivells respecte a aquesta). Quan s'executa l'aplicaci\u00f3, Symfony converteix aquests arxius YAML en arxius PHP amb un codi equivalent.","title":"Introducci\u00f3 a YAML"},{"location":"08-symfony/02-mvc/","text":"El patr\u00f3 MVC en Symfony El patr\u00f3 MVC MVC s\u00f3n les sigles de Model-Vista-Controlador (o en angl\u00e8s, Model-View-Controller ), i \u00e9s el patr\u00f3 d'arquitectura de programari per excel\u00b7l\u00e8ncia ara mateix en el m\u00f3n de les aplicacions web, i fins i tot de moltes aplicacions d'escriptori. Com el seu nom indica, aquest patr\u00f3 es basa a dividir el disseny o l'estructura d'una aplicaci\u00f3 web en tres components fonamentals: El model , que podr\u00edem resumir com el conjunt de totes les dades o informaci\u00f3 que maneja l'aplicaci\u00f3. T\u00edpicament seran variables o objectes extrets d'una base de dades o qualsevol altre sistema d'emmagatzematge, per la qual cosa el codi del model normalment estar\u00e0 format per instruccions per a connectar amb la base de dades, recuperar informaci\u00f3 d'ella i emmagatzemar-la en algunes variables determinades. Per tant, no tindr\u00e0 coneixement de la resta de components del sistema. La vista , que \u00e9s l'intermediari entre l'aplicaci\u00f3 i l'usuari, \u00e9s a dir, la qual cosa l'usuari veu en pantalla de l'aplicaci\u00f3. Per tant, la vista la compondran les diferents p\u00e0gines, formularis, etc, que l'aplicaci\u00f3 mostrar\u00e0 a l'usuari per a interactuar amb ell. El controlador (o controladors), que s\u00f3n els fragments de codi encarregats de coordinar el funcionament general de l'aplicaci\u00f3. Davant peticions dels usuaris, les arrepleguen, les identifiquen, i accedeixen al model per a actualitzar o recuperar dades, i al seu torn, decideixen qu\u00e8 vestisca mostrar-li a l'usuari a continuaci\u00f3 de l'acci\u00f3 que acaba de realitzar. \u00c9s un patr\u00f3 arquitect\u00f2nic disseny molt conc\u00eds i ben estructurat, la qual cosa li ha valgut la fama que t\u00e9 avui dia. Entre els seus molts avantatges, permet a\u00efllar el codi dels tres elements involucrats (vista, model i controlador), de manera que el treball \u00e9s molt m\u00e9s modular i divisible, podent encarregar-se de les vistes, per exemple, un dissenyador web que no tinga molta idea de programaci\u00f3 en el servidor, i del controlador un programador PHP que no tinga moltes nocions d'HTML. En forma d'esquema, podr\u00edem representar-ho aix\u00ed: Components del framework MVC Les peticions de l'usuari arriben al controlador, que les identifica, i es comunica amb el model per a obtenir les dades necess\u00e0ries, i amb les vistes per a decidir qu\u00e8 mostrar a continuaci\u00f3 i omplir-la amb les dades del model, per a despr\u00e9s servir-li-la a l'usuari com a resposta. En aquesta sessi\u00f3 veurem com definir controladors en Symfony, i associar-los a rutes, de manera que mostren algun contingut o vista com a resposta. Controladors i rutes en Symfony Per a crear p\u00e0gines en una aplicaci\u00f3 Symfony es necessiten dos elements: una ruta (\u00e9s a dir, una URI que indique a quin contingut accedir de la web) i un controlador associat a ella, que ser\u00e0 l'encarregat de mostrar el resultat (la p\u00e0gina) per a aqueixa petici\u00f3 de ruta. El concepte de ruta en Symfony Les rutes en Symfony poden ser tradicionals o amigables. Una ruta tradicional \u00e9s aquella la part din\u00e0mica de la qual s'especifica en la query string. Per exemple, si volem saber la fitxa d'una pel\u00b7l\u00edcula a trav\u00e9s del seu codi, tindr\u00edem una URL com aquesta: http://movies-symfony/movie.php?id=34 Les rutes amigables s\u00f3n aquelles que separen els seus elements \u00fanicament per barres / , de manera que la part din\u00e0mica de la ruta s'intercala entre aqueixes barres. La URL anterior, en forma amigable, quedaria aix\u00ed: http://movies-symfony/movie/34 De pas, amb les rutes amigables se sol emmascarar el tipus d'arxiu que s'est\u00e0 sol\u00b7licitant, amb el que s'omet la informaci\u00f3 de si \u00e9s una p\u00e0gina PHP, o HTML, o de qualsevol altre tipus. Ens centrarem en aquestes altres rutes en aquest curs. El nostre primer controlador Un controlador en Symfony \u00e9s b\u00e0sicament una classe que cont\u00e9 m\u00e8todes PHP l'\u00fanic prop\u00f2sit dels quals \u00e9s obtenir la petici\u00f3 de l'usuari per a una ruta concreta, processar-la i enviar-li una resposta. Els controladors se situen dins de la carpeta src del nostre projecte Symfony, concretament en l'espai de noms Controller que ja est\u00e0 creat. namespace App\\Controller ; use Symfony\\Component\\HttpFoundation\\Response ; use Symfony\\Component\\Routing\\Annotation\\Route ; class HomeController { /** * @Route(\"/\", name=\"home\") */ public function home () { return new Response ( \"Welcome to movies web site\" ); } } Observa el codi de la classe, i el del m\u00e8tode home() en concret. Simplement mostra un missatge de benvinguda a trav\u00e9s d'un objecte Response , que s'empra per a definir la resposta a enviar. Si guardem els canvis i accedim a http://movies-symfony, veurem aquest missatge de benvinguda. Definir els espais de noms ( namespaces ) Si dones una ullada al codi del controlador anterior, veur\u00e0s que comen\u00e7a amb la l\u00ednia: namespace App ; El que estem fent \u00e9s situar la classe ( HomeController , en aquest cas) dins d'un espai de noms. Cada subcarpeta que hi ha dins de la carpeta src constitueix un espai de noms, de manera que quan situem un arxiu font dins d'una d'aqueixos subdirectoris, hem d'indicar que pertany a aquest espai de noms. Tots aquests espais de noms pengen d'una arrel App , per la qual cosa l'espai de noms per al nostre controlador \u00e9s App (els subespais se separen amb barres invertides). Els espais de noms s\u00f3n \u00fatils en aplicacions amb molts arxius font, com solen ser les aplicacions web m\u00e9s o menys importants, ja que es corre el risc de cridar exactament igual a dues classes que estiguen en carpetes diferents. Si les agrupem per espais de noms, no hi haur\u00e0 problema a cridar igual a les classes i als arxius. El concepte \u00e9s similar al de paquet ( package ) en llenguatges com Java. De fet, en Java tenim molts exemples de classes que es diuen igual i pertanyen a paquets diferents, amb el que s\u00f3n f\u00e0cilment diferenciables. Incloure altres espais de noms en el fitxer actual Tornem de nou al codi del controlador. Despr\u00e9s de definir a quin espai de noms pertany aquest controlador ( App ), podem necessitar utilitzar objectes d'altres espais de noms. En aquest cas, per exemple, utilitzem un objecte Response que pertany a l'espai Symfony . Per a poder utilitzar aquest objecte de forma c\u00f2moda i no haver de col\u00b7locar tot aquest prefix cada vegada que vulguem fer refer\u00e8ncia al tipus Response , hem d'afegir una instrucci\u00f3 use indicant la ruta completa fins a la classe que utilitzarem: use Symfony ; Despr\u00e9s d'a\u00e7\u00f2, ja podrem referenciar a la classe Response directament pel seu nom en qualsevol lloc d'aquest fitxer font. De la mateixa manera, podem afegir totes les l\u00ednies use que considerem, per a fer refer\u00e8ncia a tots els elements externs que anem a necessitar. Tamb\u00e9 podem definir un \u00e0lies per a nomenar a la classe incorporada dins del nostre arxiu font. Si, en lloc d'utilitzar Response , volem referenciar a aquest tipus amb una forma m\u00e9s abreujada (Res, per exemple), far\u00edem a\u00e7\u00f2: use Symfony as Res ; ... return new Res ( ... ); Crear controladors per l\u00ednia de comandos Mitjan\u00e7ant el comando bin/console podem crear un controlador, amb la instrucci\u00f3: php bin/console make:controller ControllerName Es crear\u00e0 autom\u00e0ticament un arxiu ControllerName.php en la carpeta src/Controller , i una plantilla associada al mateix, en la carpeta templates o alguna subcarpeta. Com a avantatge destacable d'aquesta forma de crear controladors, ens crea autom\u00e0ticament el namespace i afig els recursos externs ( use ) que necessitem. Per\u00f2, com a desavantatge, ens crea una plantilla i unes connexions amb ella que normalment no necessitarem, i haurem de retocar. Definint rutes Donem una ullada m\u00e9s al codi del controlador que hem fet. Abans del m\u00e8tode home hi ha un comentari, en el qual es veu una anotaci\u00f3 anomenada Route que est\u00e0 mapejant aqueix m\u00e8tode amb una ruta. /*** @Route(\"/\", name=\"home\") */ public function home () ... El que ve a dir aqueixa anotaci\u00f3 \u00e9s que, quan accedim a l'arrel de l'aplicaci\u00f3, s'activar\u00e0 aquest m\u00e8tode i s'enviar\u00e0 la resposta corresponent (el missatge de benvinguda). A m\u00e9s, associa la ruta amb un nom ( name ) home , la qual cosa ens servir\u00e0 per a fer que el controlador siga independent de la ruta, com veurem despr\u00e9s. Una altra forma de definir rutes: l'arxiu config/routes.yaml Existeix una forma alternativa de definir rutes sense utilitzar anotacions, que consisteix a editar l'arxiu config/routes.yaml i afegir la nova ruta amb el controlador i nom associats. Per exemple, per al cas anterior, si volem que en accedir a l'arrel de l'aplicaci\u00f3 s'active el m\u00e8tode home del controlador HomeController , assignant-li a la ruta el nom home (tal com hem fet en l'exemple anterior), afegir\u00edem aquestes l\u00ednies al fitxer: home : path : / controller : App\\Controller\\HomeController::home No obstant a\u00e7\u00f2, si atenem a la documentaci\u00f3 oficial de Symfony, es recomana definir les rutes mitjan\u00e7ant anotacions , per la qual cosa d'ara endavant utilitzarem aquest mecanisme en les anotacions. Comprovar les rutes de la nostra aplicaci\u00f3 Utilitzant la consola de Symfony (fitxer bin/console del nostre projecte) podem comprovar quines rutes hi ha actualment definides en la nostra aplicaci\u00f3, mitjan\u00e7ant aquest comando: php bin/console debug:router Mostrar\u00e0 el llistat de rutes, indicant el seu nom, i la ruta associada. A m\u00e9s de la nostra ruta arrel, apareixeran altres rutes creades per defecte per a opcions de depuraci\u00f3 i testeo, com per exemple les rutes profiler per a rastrejar i obtenir detalls de les peticions realitzades. No entrarem en aqueixos detalls en aquest curs. Configurar la reescriptura de rutes Abans de continuar, hi ha un cosa que hem de tenir en compte: el controlador que hem provat ( HomeController::home ) funciona perqu\u00e8 fa refer\u00e8ncia a l'arrel de l'aplicaci\u00f3. Si canviem la ruta per qualsevol altra, com per exemple /home , no funcionar\u00e0: El motiu \u00e9s que encara no tenim configurat el nostre projecte perqu\u00e8 reescriga les rutes de forma amigable. Per a a\u00e7\u00f2, haur\u00edem de tenir un arxiu .htaccess en la carpeta public amb els par\u00e0metres de configuraci\u00f3 d'Apache per a aqueixa reescriptura. Com aqueixa tasca \u00e9s una miqueta manual, l'eina composer posa a la nostra disposici\u00f3 un parell de comandos per a fer-ho per nosaltres. Des de la carpeta del nostre projecte escriurem: composer require symfony/apache-pack En executar-lo ens mostrar\u00e0 el seg\u00fcent missatge: Symfony operations: 1 recipe ( 5a8f9ff66bdb49d40606adc556254e91 ) - WARNING symfony/apache-pack ( > = 1 .0 ) : From github.com/symfony/recipes-contrib:master The recipe for this package comes from the \"contrib\" repository, which is open to community contributions. Review the recipe at https://github.com/symfony/recipes-contrib/tree/master/symfony/apache-pack/1.0 Do you want to execute this recipe? [ y ] Yes [ n ] No [ a ] Yes for all packages, only for the current installation session [ p ] Yes permanently, never ask again for this project ( defaults to n ) : Al que respondrem y o p si volem que no ens torne a preguntar. Les receptes de Symfony Les receptes de Symfony permeten automatitzar la configuraci\u00f3 de paquets Composer mitjan\u00e7ant el connector Symfony Flex Composer. Hi ha receptes oficials i contribucions de tercers ( contrib ) \u00e9s a dir, no s\u00f3n receptes dels desenvolupadors oficials de Symfony. Aquest \u00e9s el cas de la recepta symfony/apache-pack , per la qual cosa ens pregunta si volem instal\u00b7lar-la igualment. Podem executar composer recipes per veure les receptes que hi ha instal\u00b7lades i si cal actualitzar-les. A partir d'aquest punt, ja podrem crear les rutes amigables que vulguem en el nostre projecte. Recorda repetir aquests comandos en tots els projectes Symfony que utilitzen rutes amigables . Rutes amb par\u00e0metres Existeixen algunes rutes que tenen parts variables. Per exemple, si volgu\u00e9rem mostrar la fitxa d'una pel\u00b7l\u00edcula (el seu t\u00edtol, el poster i la seua sinopsi), a partir del seu codi, podr\u00edem plantejar una ruta com a http://movies-symfony/movies/54, i que el controlador ens mostrara la informaci\u00f3 de la pel\u00b7l\u00edcula n\u00famero 54. Per\u00f2, si cridem a aqueixa ruta amb un altre codi, haur\u00e0 de mostrar la informaci\u00f3 de la pel\u00b7l\u00edcula amb l'altre codi. Anem a crear un nou controlador en el nostre espai de noms Controller dins de la carpeta src . En aquest cas, cridarem a la classe MovieController . Definirem un m\u00e8tode anomenat show , que mostrar\u00e0 la fitxa de la pel\u00b7l\u00edcula en el codi del qual li arribe en la ruta, encara que de moment nom\u00e9s mostrar\u00e0 un missatge amb el codi de la pel\u00b7l\u00edcula indicat en la ruta: namespace App\\Controller ; use Symfony\\Component\\HttpFoundation\\Response ; use Symfony\\Component\\Routing\\Annotation\\Route ; class MovieController { /** * @Route(\"/movies/{id}\", name=\"movies_show\") */ public function show ( $id ) { return new Response ( \"Movie data with id: $id \" ); } } Observa com en la anotaci\u00f3 afegim el id de la pel\u00b7l\u00edcula com un element variable, gr\u00e0cies a les claus (a aquesta notaci\u00f3 se li crida wildcard ). El m\u00e8tode associat a la ruta ha de tenir un par\u00e0metre amb aqueixa mateixa dada (l'identificador), de manera que puguem utilitzar-lo dins del m\u00e8tode. Si ara accedim a la URI movies-symfony/movies/54 ens mostrar\u00e0 el missatge \"Movie data with id: 54\". Millorarem un poc aquest controlador, per a simular que accedeix a una font de dades per a obtenir la informaci\u00f3. Fins a veure en sessions posteriors com connectar amb MySQL, anem a crear-nos el nostre propi array de pel\u00b7l\u00edcules en la classe MovieController , i farem que el m\u00e8tode show mostre les dades del contacte el codi del qual s'haja indicat. El controlador quedar\u00e0 aix\u00ed: namespace App\\Controller ; use Symfony\\Component\\HttpFoundation\\Response ; use Symfony\\Component\\Routing\\Annotation\\Route ; class MovieController { private array $movies = [ [ \"id\" => \"2\" , \"title\" => \"Ava\" , \"tagline\" => \"Kill. Or be killed\" , \"release_date\" => \"2020-09-25\" ], [ \"id\" => \"3\" , \"title\" => \"Bill &Ted Face the Music\" , \"tagline\" => \"The future awaits\" , \"release_date\" => \"2020-09-24\" ], [ \"id\" => \"4\" , \"title\" => \"Hard Kill\" , \"tagline\" => \"Take on a madman. Save the world.\" , \"release_date\" => \"2020-09-14\" ], [ \"id\" => \"5\" , \"title\" => \"The Owners\" , \"tagline\" => \"\" , \"release_date\" => \"2020-05-10\" ], [ \"id\" => \"6\" , \"title\" => \"The New Mutants\" , \"tagline\" => \"It's time to face your demons.\" , \"release_date\" => \"2020-04-20\" ], ]; /** * @Route(\"/movies/{id}\", name=\"movies_show\") */ public function show ( $id ) { $result = array_filter ( $this -> movies , function ( $movie ) use ( $id ) { return $movie [ \"id\" ] == $id ; }); if ( count ( $result ) > 0 ) { $response = \"\" ; $result = array_shift ( $result ); $response .= \"<ul><li>\" . $result [ \"title\" ] . \"</li>\" . \"<li>\" . $result [ \"tagline\" ] . \"</li>\" . \"<li>\" . $result [ \"release_date\" ] . \"</li></ul>\" ; return new Response ( \"<html><body> $response </body></html>\" ); } else return new Response ( \"Movie not found\" ); } } Com veiem, hem definit un array de pel\u00b7l\u00edcules, i dins del m\u00e8tode filtrem amb array_filter aquell el codi del qual coincidisca amb l'indicat, mostrant les seues dades en la resposta. Observa tamb\u00e9 com podem incloure codi HTML en la mateixa resposta, encara que de seguida veurem que hi ha formes m\u00e9s c\u00f2modes de fer a\u00e7\u00f2. Afegir requisits a les wildcards Imaginem que volem definir un cercador de pel\u00b7l\u00edcules, de manera que li passem com a part variable de la ruta una part del nom, i ens retorna totes les pel\u00b7l\u00edcules que coincidisquen. Aix\u00ed, per a la \"base de dades\" anterior, si acced\u00edrem a la ruta /movies/The ens mostraria les pel\u00b7l\u00edcules \"The new mutants\" i \"The owners\". Definim un segon m\u00e8tode en la nostra classe MovieController per a processar aquesta ruta. Quedaria aix\u00ed: /** * @Route(\"/movies/{text}\", name=\"movies_filter\") */ public function filter ( $text ) { $result = array_filter ( $this -> movies , function ( $movie ) use ( $text ) { return strpos ( $movie [ \"title\" ], $text ) !== false ; }); $response = \"\" ; if ( count ( $result ) > 0 ) { foreach ( $result as $movie ) { $response .= \"<ul><li>\" . $movie [ \"title\" ] . \"</li>\" . \"<li>\" . $movie [ \"tagline\" ] . \"</li>\" . \"<li>\" . $movie [ \"release_date\" ] . \"</li></ul>\" ; } return new Response ( \"<html><body> $response </body></html>\" ); } else return new Response ( \"No movies found\" ); } } Si intentem llan\u00e7ar la URL anterior (http://movies-symfony/movies/The), obtindrem com a resultat \"Movie not found\", que \u00e9s el missatge corresponent al controlador anterior (la fitxa de pel\u00b7l\u00edcula) quan no es trobava la pel\u00b7l\u00edcula amb el codi indicat. \u00c9s a dir, s'ha llan\u00e7at el controlador equivocat, i el motiu \u00e9s simple, hem definit dues rutes a priori diferents: /movies/{id} per a la fitxa de la pel\u00b7l\u00edcula /movies/{text} per a cercar pel\u00b7l\u00edcules pel t\u00edtol No obstant aix\u00f2, a efectes pr\u00e0ctics, ambdues rutes s\u00f3n el mateix: el prefix /movies seguit del que siga. En aquesta situaci\u00f3, Symfony llan\u00e7a el primer dels controladors la ruta dels quals coincidisca amb la indicada (el de la fitxa de pel\u00b7l\u00edcules, en aquest cas). Per a diferenciar ambdues rutes, necessitem un criteri, i en aquest cas, el criteri ser\u00e0 que la fitxa de la pel\u00b7l\u00edcula necessita que el par\u00e0metre id siga num\u00e8ric. A\u00e7\u00f2 s'especifica mitjan\u00e7ant la propietat requirements i una expressi\u00f3 regular, en definir la ruta de la fitxa: @ Route ( \"/movies/{id}\" , name = \"movies_show\" , requirements = { \"id\" = \"\\d+\" }) Des de Symfony 4.1, tamb\u00e9 es pot emprar aquesta altra notaci\u00f3 m\u00e9s abreujada per a incloure el requeriment en el wildcard: @ Route ( \"/movies/{id}<\\d+>\" , name = \"movies_show\" ) Afegir valors per defecte a les wildcards En algunes ocasions, tamb\u00e9 ens pot interessar donar un valor per defecte a una wildcard perqu\u00e8, si en la ruta no s'especifica res, tinga aquest valor per defecte. A\u00e7\u00f2 s'aconsegueix assignant un valor per defecte al par\u00e0metre associat en el controlador. En el cas de la fitxa de la pel\u00b7l\u00edcula anterior, si volgu\u00e9rem que quan s'introdu\u00efsca la ruta /movies (sense id), es mostrara per defecte la pel\u00b7l\u00edcula amb codi 2, far\u00edem a\u00e7\u00f2: /** * @Route(\"/movies/{id}\", name=\"movies_show\", requirements={\"id\"=\"\\d+\"}) */ public function show ( $id = 2 ) encara que des de Symfony 4.1 tamb\u00e9 es pot especificar en la pr\u00f2pia anotaci\u00f3, d'aquesta altra forma: @ Route ( \"/movies/{id}<\\d+>?2\" , name = \"movies_show\" ) Per a m\u00e9s informaci\u00f3 podeu consultar la documentaci\u00f3 oficial de Symfony: Routing","title":"El patr\u00f3 MVC en Symfony"},{"location":"08-symfony/02-mvc/#el-patro-mvc-en-symfony","text":"","title":"El patr\u00f3 MVC en Symfony"},{"location":"08-symfony/02-mvc/#el-patro-mvc","text":"MVC s\u00f3n les sigles de Model-Vista-Controlador (o en angl\u00e8s, Model-View-Controller ), i \u00e9s el patr\u00f3 d'arquitectura de programari per excel\u00b7l\u00e8ncia ara mateix en el m\u00f3n de les aplicacions web, i fins i tot de moltes aplicacions d'escriptori. Com el seu nom indica, aquest patr\u00f3 es basa a dividir el disseny o l'estructura d'una aplicaci\u00f3 web en tres components fonamentals: El model , que podr\u00edem resumir com el conjunt de totes les dades o informaci\u00f3 que maneja l'aplicaci\u00f3. T\u00edpicament seran variables o objectes extrets d'una base de dades o qualsevol altre sistema d'emmagatzematge, per la qual cosa el codi del model normalment estar\u00e0 format per instruccions per a connectar amb la base de dades, recuperar informaci\u00f3 d'ella i emmagatzemar-la en algunes variables determinades. Per tant, no tindr\u00e0 coneixement de la resta de components del sistema. La vista , que \u00e9s l'intermediari entre l'aplicaci\u00f3 i l'usuari, \u00e9s a dir, la qual cosa l'usuari veu en pantalla de l'aplicaci\u00f3. Per tant, la vista la compondran les diferents p\u00e0gines, formularis, etc, que l'aplicaci\u00f3 mostrar\u00e0 a l'usuari per a interactuar amb ell. El controlador (o controladors), que s\u00f3n els fragments de codi encarregats de coordinar el funcionament general de l'aplicaci\u00f3. Davant peticions dels usuaris, les arrepleguen, les identifiquen, i accedeixen al model per a actualitzar o recuperar dades, i al seu torn, decideixen qu\u00e8 vestisca mostrar-li a l'usuari a continuaci\u00f3 de l'acci\u00f3 que acaba de realitzar. \u00c9s un patr\u00f3 arquitect\u00f2nic disseny molt conc\u00eds i ben estructurat, la qual cosa li ha valgut la fama que t\u00e9 avui dia. Entre els seus molts avantatges, permet a\u00efllar el codi dels tres elements involucrats (vista, model i controlador), de manera que el treball \u00e9s molt m\u00e9s modular i divisible, podent encarregar-se de les vistes, per exemple, un dissenyador web que no tinga molta idea de programaci\u00f3 en el servidor, i del controlador un programador PHP que no tinga moltes nocions d'HTML. En forma d'esquema, podr\u00edem representar-ho aix\u00ed: Components del framework MVC Les peticions de l'usuari arriben al controlador, que les identifica, i es comunica amb el model per a obtenir les dades necess\u00e0ries, i amb les vistes per a decidir qu\u00e8 mostrar a continuaci\u00f3 i omplir-la amb les dades del model, per a despr\u00e9s servir-li-la a l'usuari com a resposta. En aquesta sessi\u00f3 veurem com definir controladors en Symfony, i associar-los a rutes, de manera que mostren algun contingut o vista com a resposta.","title":"El patr\u00f3 MVC"},{"location":"08-symfony/02-mvc/#controladors-i-rutes-en-symfony","text":"Per a crear p\u00e0gines en una aplicaci\u00f3 Symfony es necessiten dos elements: una ruta (\u00e9s a dir, una URI que indique a quin contingut accedir de la web) i un controlador associat a ella, que ser\u00e0 l'encarregat de mostrar el resultat (la p\u00e0gina) per a aqueixa petici\u00f3 de ruta.","title":"Controladors i rutes en Symfony"},{"location":"08-symfony/02-mvc/#el-concepte-de-ruta-en-symfony","text":"Les rutes en Symfony poden ser tradicionals o amigables. Una ruta tradicional \u00e9s aquella la part din\u00e0mica de la qual s'especifica en la query string. Per exemple, si volem saber la fitxa d'una pel\u00b7l\u00edcula a trav\u00e9s del seu codi, tindr\u00edem una URL com aquesta: http://movies-symfony/movie.php?id=34 Les rutes amigables s\u00f3n aquelles que separen els seus elements \u00fanicament per barres / , de manera que la part din\u00e0mica de la ruta s'intercala entre aqueixes barres. La URL anterior, en forma amigable, quedaria aix\u00ed: http://movies-symfony/movie/34 De pas, amb les rutes amigables se sol emmascarar el tipus d'arxiu que s'est\u00e0 sol\u00b7licitant, amb el que s'omet la informaci\u00f3 de si \u00e9s una p\u00e0gina PHP, o HTML, o de qualsevol altre tipus. Ens centrarem en aquestes altres rutes en aquest curs.","title":"El concepte de ruta en Symfony"},{"location":"08-symfony/02-mvc/#el-nostre-primer-controlador","text":"Un controlador en Symfony \u00e9s b\u00e0sicament una classe que cont\u00e9 m\u00e8todes PHP l'\u00fanic prop\u00f2sit dels quals \u00e9s obtenir la petici\u00f3 de l'usuari per a una ruta concreta, processar-la i enviar-li una resposta. Els controladors se situen dins de la carpeta src del nostre projecte Symfony, concretament en l'espai de noms Controller que ja est\u00e0 creat. namespace App\\Controller ; use Symfony\\Component\\HttpFoundation\\Response ; use Symfony\\Component\\Routing\\Annotation\\Route ; class HomeController { /** * @Route(\"/\", name=\"home\") */ public function home () { return new Response ( \"Welcome to movies web site\" ); } } Observa el codi de la classe, i el del m\u00e8tode home() en concret. Simplement mostra un missatge de benvinguda a trav\u00e9s d'un objecte Response , que s'empra per a definir la resposta a enviar. Si guardem els canvis i accedim a http://movies-symfony, veurem aquest missatge de benvinguda.","title":"El nostre primer controlador"},{"location":"08-symfony/02-mvc/#definir-els-espais-de-noms-namespaces","text":"Si dones una ullada al codi del controlador anterior, veur\u00e0s que comen\u00e7a amb la l\u00ednia: namespace App ; El que estem fent \u00e9s situar la classe ( HomeController , en aquest cas) dins d'un espai de noms. Cada subcarpeta que hi ha dins de la carpeta src constitueix un espai de noms, de manera que quan situem un arxiu font dins d'una d'aqueixos subdirectoris, hem d'indicar que pertany a aquest espai de noms. Tots aquests espais de noms pengen d'una arrel App , per la qual cosa l'espai de noms per al nostre controlador \u00e9s App (els subespais se separen amb barres invertides). Els espais de noms s\u00f3n \u00fatils en aplicacions amb molts arxius font, com solen ser les aplicacions web m\u00e9s o menys importants, ja que es corre el risc de cridar exactament igual a dues classes que estiguen en carpetes diferents. Si les agrupem per espais de noms, no hi haur\u00e0 problema a cridar igual a les classes i als arxius. El concepte \u00e9s similar al de paquet ( package ) en llenguatges com Java. De fet, en Java tenim molts exemples de classes que es diuen igual i pertanyen a paquets diferents, amb el que s\u00f3n f\u00e0cilment diferenciables.","title":"Definir els espais de noms (namespaces)"},{"location":"08-symfony/02-mvc/#definint-rutes","text":"Donem una ullada m\u00e9s al codi del controlador que hem fet. Abans del m\u00e8tode home hi ha un comentari, en el qual es veu una anotaci\u00f3 anomenada Route que est\u00e0 mapejant aqueix m\u00e8tode amb una ruta. /*** @Route(\"/\", name=\"home\") */ public function home () ... El que ve a dir aqueixa anotaci\u00f3 \u00e9s que, quan accedim a l'arrel de l'aplicaci\u00f3, s'activar\u00e0 aquest m\u00e8tode i s'enviar\u00e0 la resposta corresponent (el missatge de benvinguda). A m\u00e9s, associa la ruta amb un nom ( name ) home , la qual cosa ens servir\u00e0 per a fer que el controlador siga independent de la ruta, com veurem despr\u00e9s.","title":"Definint rutes"},{"location":"08-symfony/02-mvc/#comprovar-les-rutes-de-la-nostra-aplicacio","text":"Utilitzant la consola de Symfony (fitxer bin/console del nostre projecte) podem comprovar quines rutes hi ha actualment definides en la nostra aplicaci\u00f3, mitjan\u00e7ant aquest comando: php bin/console debug:router Mostrar\u00e0 el llistat de rutes, indicant el seu nom, i la ruta associada. A m\u00e9s de la nostra ruta arrel, apareixeran altres rutes creades per defecte per a opcions de depuraci\u00f3 i testeo, com per exemple les rutes profiler per a rastrejar i obtenir detalls de les peticions realitzades. No entrarem en aqueixos detalls en aquest curs.","title":"Comprovar les rutes de la nostra aplicaci\u00f3"},{"location":"08-symfony/03-twig/","text":"Gesti\u00f3 de plantilles amb Twig Definint plantilles de vistes amb Twig Els exemples de controladors vistos fins ara queden un poc limitats, perqu\u00e8 el disseny brilla per la seua abs\u00e8ncia. Ens hem limitat a mostrar un text pla amb les dades per a comprovar que el controlador funciona, o en tot cas, a generar un HTML rudimentari en l'objecte Response per a mostrar una llista. Per\u00f2 si volem generar una vista m\u00e9s complicada, no \u00e9s bona idea fer-ho afegint els elements en la cadena de text per a la resposta. Ara veurem com podem generar vistes amb una mica de disseny, gr\u00e0cies al motor de plantilles Twig. La filosofia d'utilitzar motors de plantilles com Twig \u00e9s separar tot el possible el codi PHP de l'estructura HTML de la p\u00e0gina, de manera que tota la l\u00f2gica de negoci queda fora de la vista (en el controlador, normalment), i en aquesta deixem el necessari per a mostrar el contingut al client. Per a a\u00e7\u00f2, el que es sol fer \u00e9s, des del controlador, accedir al model per a obtenir o modificar les dades necess\u00e0ries, emmagatzemar-los en variables i passar aquestes variables a les vistes o plantilles, de manera que aquestes nom\u00e9s hagen d'encarregar-se de mostrar aqueixa informaci\u00f3 amb l'estructura i disseny adequats. A\u00efllem, per tant, el treball del programador d'una banda (controlador i model), i el del dissenyador per un altre (vistes) La nostra primera plantilla Anem a veure com renderitzar una plantilla amb Twig. En primer lloc, hem de fer alguns petits canvis en el controlador que vaja a usar Twig: farem que la classe del controlador herete d' AbstractController (incorporant aquesta classe del seu corresponent espai de noms): namespace App ; ... use Symfony ; class NameController extends AbstractController { A\u00e7\u00f2 ho farem per a poder utilitzar algunes de les facilitats que ens dona AbstractController , com per exemple el m\u00e8tode render per a renderitzar vistes. Com hem comentat en sessions anteriors, les vistes s'emmagatzemen en la carpeta templates del nostre projecte Symfony, i si emprem Twig com a motor de plantilles, tenen l'extensi\u00f3 .html.twig. Per exemple, crearem una plantilla anomenada home.html.twig en la nostra aplicaci\u00f3 de movies , amb aquest codi: < html > < body > < h1 > Movies </ h1 > < h2 > Welcome to Movie FX </ h2 > < p > Home </ p > </ body > </ html > Ara modificarem la classe src/Controller/HomeController perqu\u00e8 herete d' AbstractController . namespace App\\Controller ; use Symfony\\Component\\HttpFoundation\\Response ; use Symfony\\Component\\Routing\\Annotation\\Route ; use Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController ; class HomeController extends AbstractController { ... i modifiquem tamb\u00e9 el m\u00e8tode home perqu\u00e8, en lloc de mostrar una resposta de text pla, renderitze la vista home.html.twig que acabem de fer. Per a a\u00e7\u00f2, el codi ser\u00e0 el seg\u00fcent: /** * @Route(\"/\", name=\"home\") */ public function home () { return $this -> render ( 'home.html.twig' ); } Observa com emprem l'objecte $this (recorda, ara la nostra classe \u00e9s un subtipus d' AbstractController ) per a accedir al m\u00e8tode render i renderitzar la vista que li indiquem, que autom\u00e0ticament se cercar\u00e0 des de la carpeta templates . Plantilles amb parts variables La plantilla anterior no \u00e9s alguna cosa massa habitual, ja que \u00fanicament cont\u00e9 text est\u00e0tic. El normal \u00e9s que hi haja alguna part que varie, i que li siga proporcionada des del controlador. Anem a veure un altre exemple amb la fitxa de la pel\u00b7l\u00edcula: anem a la nostra classe src/Controller/MovieController i fem que tamb\u00e9 herete d' AbstractController: namespace App\\Controller ; use Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController ; use Symfony\\Component\\HttpFoundation\\Response ; use Symfony\\Component\\Routing\\Annotation\\Route ; class MovieController extends AbstractController Anem a generar una plantilla anomenada movies_show.html.twig en la nostra carpeta templates . Rebr\u00e0 com a par\u00e0metre del controlador la pel\u00b7l\u00edcula amb el codi indicat (despr\u00e9s veurem com), i mostrar\u00e0 en la plantilla les seues dades. El codi de la plantilla pot quedar aix\u00ed: < h1 > Movie data </ h1 > < h2 > {{ movie.title }} </ h2 > < p > Tagline: {{ movie.tagline }} </ p > < p > Release date: {{ movie.release_date }} </ p > Emprem la notaci\u00f3 de la doble clau {{ ... }} per a situar variables, que normalment s\u00f3n dades que esperem rebre de fora (del controlador, en aquest cas). Ens faltaria, en el m\u00e8tode show de MovieController , obtenir la pel\u00b7l\u00edcula desitjada (a\u00e7\u00f2 ja ho tenim fet) i passar-li-la a la vista, d'aquesta manera: /** * @Route(\"/movies/{id}\", name=\"movies_show\", requirements={\"id\"=\"\\d+\"}) */ public function show ( $id = 2 ) { $result = array_filter ( $this -> movies , function ( $movie ) use ( $id ) { return $movie [ \"id\" ] == $id ; }); if ( count ( $result ) > 0 ) { return $this -> render ( 'movies_show.html.twig' , array ( 'movie' => array_shift ( $result ) )); } else return new Response ( \"Movie not found\" ); } Com veus, n'hi ha prou amb utilitzar un array de par\u00e0metres en el m\u00e8tode render per a passar-li a la vista tot el que necessite, identificant cada cosa amb el nom que vulguem, i que coincidir\u00e0 amb el qual s'utilitzar\u00e0 en el codi de la vista (el par\u00e0metre movie , en aquest cas). Estructures de control en plantilles La plantilla anterior \u00e9s un exemple per a afegir parts din\u00e0miques en el contingut de la mateixa, per\u00f2 est\u00e0 alguna cosa \"coixa\": qu\u00e8 passa si no trobem la pel\u00b7l\u00edcula? En aquest cas, el controlador es limita a retornar una resposta de text pla que diu \"Movie not found\", per\u00f2 podr\u00edem emprar la mateixa vista (o una altra) per a mostrar aquesta informaci\u00f3 m\u00e9s elaborada. Aix\u00ed, el controlador renderizar\u00e1 la mateixa vista, passant-li una pel\u00b7l\u00edcula v\u00e0lida o null , segons el cas: public function show ( $id = 2 ) { $result = array_filter ( $this -> movies , function ( $movie ) use ( $id ) { return $movie [ \"id\" ] == $id ; }); if ( count ( $result ) > 0 ) { return $this -> render ( 'movies_show.html.twig' , array ( 'movie' => array_shift ( $result ) )); } else return $this -> render ( 'movies_show.html.twig' , array ( 'movie' => null )); } i la vista distingir\u00e0 si hi ha o no pel\u00b7l\u00edcula, per a mostrar una o una altra informaci\u00f3: < html > < body > < h1 > Movie data </ h1 > {% if movie %} < ul > < li >< strong > {{ movie.title }} </ strong ></ li > < li >< strong > Tagline </ strong > : {{ movie.tagline }} </ li > < li >< strong > Release date </ strong > : {{ movie.release_date }} </ li > </ ul > {% else %} < p > Movie not found </ p > {% endif %} </ body > </ html > Observa com hem incl\u00f2s un bloc {% ... %} , que s\u00f3n blocs d'acci\u00f3, emprats per a definir certes sent\u00e8ncies de control (condicions, bucles) i incloure dins el codi associat a aquesta sent\u00e8ncia. De la mateixa manera, per al controlador de filtratge de pel\u00b7l\u00edcules per t\u00edtol, podem crear una nova vista (per exemple, \"movies_filter.html.twig\"), que mostre el llistat de pel\u00b7l\u00edcules que reba ja filtrat del controlador: < h1 > Movies </ h1 > {% if movies %} < ul > {% for movie in movies %} < li >< strong > {{ movie.title }} </ strong ></ li > < li >< strong > Tagline </ strong > : {{ movie.tagline }} </ li > < li >< strong > Release date </ strong > : {{ movie.release_date }} </ li > </ ul > {% endfor %} {% else %} < p > No movies found </ p > {% endif %} Aix\u00ed, el codi del controlador es limitar\u00e0 a filtrar les i a passar-li'ls a la vista: public function filter ( $text ) { $result = array_filter ( $this -> movies , function ( $movie ) use ( $text ) { return strpos ( $movie [ \"title\" ], $text ) !== false ; }); $response = \"\" ; if ( count ( $result ) > 0 ) { foreach ( $result as $movie ) { $response .= \"<ul><li>\" . $movie [ \"title\" ] . \"</li>\" . \"<li>\" . $movie [ \"tagline\" ] . \"</li>\" . \"<li>\" . $movie [ \"release_date\" ] . \"</li></ul>\" ; } return $this -> render ( 'movies_filter.html.twig' , array ( 'movies' => $result )); } } Observa com podem emprar bucles en les plantilles per a rec\u00f3rrer col\u00b7leccions de dades passades des del controlador. Her\u00e8ncia de plantilles L'her\u00e8ncia de plantilles ens permet reaprofitar el codi d'unes en unes altres. En realitat, a\u00e7\u00f2 \u00e9s alguna cosa molt habitual en el disseny web: que totes les p\u00e0gines (o diverses) d'una web compartisquen la mateixa cap\u00e7alera i peu, per exemple. Aix\u00ed, podem definir una estructura o layout base en una plantilla, i fer que altres hereten d'ella per a emplenar certs buits. Vegem un exemple amb la nostra web de pel\u00b7l\u00edcules. En primer lloc, definirem la plantilla base. Teniu un exemple en qu\u00e8 basar-vos ja fet, en l'arxiu templates/base.html.twig , que proporciona un esquelet que podr\u00edem aprofitar per a moltes aplicacions: <!DOCTYPE html> < html > < head > < meta charset = \"UTF-8\" > < title > {% block title %} Welcome! {% endblock %} </ title > {% block stylesheets %}{% endblock %} {% block javascripts %}{% endblock %} </ head > < body > {% block body %}{% endblock %} </ body > </ html > Com podem observar, la part \"emplenable\" de la plantilla es defineix mitjan\u00e7ant blocs ( blocks ), de manera que en les diferents subplantilles podem indicar quins blocs de la plantilla pare volem emplenar. Per exemple, anem a definir una subplantilla per a la p\u00e0gina d'inici. Retoquem la nostra plantilla home.html.twig i la deixem aix\u00ed: {% extends 'base.html.twig' %} {% block title %} Movies {% endblock %} {% block body %} < h1 > Movies </ h1 > < p > Welcome to Movies FX Site! </ p > {% endblock %} \u00c9s important que, si una plantilla hereta d'una altra, el primer codi que hi haja en aqueixa plantilla (sense explicar comentaris previs) siga una instrucci\u00f3 {% raw %} {% extends ... %} {% endraw %} per a indicar que \u00e9s una her\u00e8ncia. Despr\u00e9s, n'hi ha prou amb emplenar els blocs que el seu contingut vulguem modificar o establir: en aquest exemple, els blocs title i body , definits en la plantilla base, encara que el bloc title es podria deixar predefinit com a \"Movies\" en la plantilla base tamb\u00e9. De la mateixa manera, definir\u00edem les plantilles movies_show.html.twig . {% extends 'base.html.twig' %} {% block title %} Movies {% endblock %} {% block body %} < h1 > Movie data </ h1 > {% if movie %} < ul > < li >< strong > {{ movie.title }} </ strong ></ li > < li >< strong > Tagline </ strong > : {{ movie.tagline }} </ li > < li >< strong > Release date </ strong > : {{ movie.release_date }} </ li > </ ul > {% else %} < p > Movie not found </ p > {% endif %} {% endblock %} ... i movies_filter.html.twig : {% extends 'base.html.twig' %} {% block title %} Movies {% endblock %} {% block body %} < h1 > Movies </ h1 > {% if movies %} {% for movie in movies %} < ul > < li >< strong > {{ movie.title }} </ strong ></ li > < li >< strong > Tagline </ strong > : {{ movie.tagline }} </ li > < li >< strong > Release date </ strong > : {{ movie.release_date }} </ li > </ ul > {% endfor %} {% else %} < p > No movies found </ p > {% endif %} {% endblock %} Incloure plantilles dins d'altres Altra opci\u00f3 interessant, a part de l'her\u00e8ncia, \u00e9s la de poder incloure una plantilla com a part del contingut d'una altra. N'hi ha prou amb utilitzar la instrucci\u00f3 include , seguida del nom de la plantilla i, si els necessita, els seus par\u00e0metres associats. Per exemple, podr\u00edem traure la llista de pel\u00b7l\u00edcules d'una plantilla anomenada movie_data.html.twig : < ul > < li >< strong > {{ movie.title }} </ strong ></ li > < li >< strong > Tagline </ strong > : {{ movie.tagline }} </ li > < li >< strong > Release date </ strong > : {{ movie.release_date }} </ li > </ ul > I incloure-la tant en movies_show ... {% extends 'base.html.twig' %} {% block title %} Movies {% endblock %} {% block body %} < h1 > Movie data </ h1 > {% if movie %} {{ include ( 'movie_data.html.twig' , { 'movie' : movie }) }} {% else %} < p > Movie not found </ p > {% endif %} {% endblock %} ... com en movies_filter : {% extends 'base.html.twig' %} {% block title %} Movies {% endblock %} {% block body %} < h1 > Movies </ h1 > {% if movies %} {% for movie in movies %} {{ include ( 'movie_data.html.twig' , { 'movie' : movie }) }} {% endfor %} {% else %} < p > No movies found </ p > {% endif %} {% endblock %} Enlla\u00e7os a rutes i a elements est\u00e0tics Per a finalitzar aquest apartat d'edici\u00f3 de plantilles, ens queden dos aspectes importants a tractar: Com incloure contingut est\u00e0tic (fulles d'estil, imatges... i tot el que, en general, estiga dins de la carpeta \"public\" del projecte) Com afegir enlla\u00e7os a altres rutes Afegir contingut est\u00e0tic en plantilles Per a il\u00b7lustrar com afegir contingut est\u00e0tic en plantilles, anem a definir en la nostra carpeta public de la web de pel\u00b7l\u00edcules una subcarpeta css , i dins un arxiu styles.css (que quedar\u00e0, per tant, en public/css/styles.css . Definim dins un estil b\u00e0sic per a provar. Per exemple: body { background-color : #99ccff ; } h1 { border-bottom : 1 px solid black ; } } Ara, anem a afegir aquest estil a la nostra web. Com tenim un bloc stylesheets en la nostra plantilla base.html.twig , podem aprofitar-ho i incloure el CSS dins d'aquest bloc, perqu\u00e8 ho utilitzen totes les subplantillas: <!DOCTYPE html> < html > < head > < meta charset = \"UTF-8\" > < title > {% block title %} Welcome! {% endblock %} </ title > {% block stylesheets %} < link href = \" {{ asset ( 'css/styles.css' ) }} \" rel = \"stylesheet\" /> {% endblock %} {% block javascripts %}{% endblock %} </ head > < body > {% block body %}{% endblock %} </ body > </ html > De la mateixa manera, si tingu\u00e9rem una imatge, per exemple, public/images/image.png , podr\u00edem afegir-la en la plantilla amb un cosa aix\u00ed: < img src = \" {{ asset ( 'images/image.png' ) }} \" /> Podem tamb\u00e9 emprar rutes absolutes, emprant la instrucci\u00f3 absolute_url : < img src = \" {{ absolute_url ( asset ( 'images/image.png' )) }} \" /> En el cas d'arxius javascript, s'afegirien en el bloc javascripts de la plantilla base (o d'alguna subplantilla, si es vol). Per exemple, suposant que tenim un arxiu library.js penjant de la subcarpeta public/js , far\u00edem alguna cosa aix\u00ed: {% block javascripts %} < script src = \" {{ asset ( 'js/library.js' ) }} \" ></ script > {% endblock %} Enlla\u00e7ar a altres rutes de l'aplicaci\u00f3 Si el que volem \u00e9s definir un enlla\u00e7 a una altra ruta o p\u00e0gina de la nostra aplicaci\u00f3, en aqueix cas utilitzem la funci\u00f3 path per a indicar el nom ( name ) que h\u00e0gem assignat a la ruta a la qual volem anar. Per exemple, si volem anar a la fitxa d'una pel\u00b7l\u00edcula el codi del qual est\u00e0 emmagatzemat en la variable id , far\u00edem alguna cosa aix\u00ed: < a href = \" {{ path ( 'movies_show' , { 'id' : id }) }} \" > ... </ a > Altres caracter\u00edstiques interessants de Twig A m\u00e9s de tot l'exposat durant aquest apartat, existeixen altres caracter\u00edstiques interessants de Twig. Vegem algunes d'elles r\u00e0pidament en aquesta subsecci\u00f3. \u00das de filtres Quan volem mostrar informaci\u00f3 en una plantilla amb la sintaxi de la doble clau {{...}} , podem emprar filtres per a processar la informaci\u00f3 a mostrar i donar-li cert format. Els filtres en Twig s'activen mitjan\u00e7ant la barra vertical ( | ), seguida del filtre a aplicar. Per exemple, si volem mostrar el nom del t\u00edtol en maj\u00fascules, far\u00edem alguna cosa aix\u00ed: {{ movie.title | upper }} Existeixen altres filtres \u00fatils, com lower (per a mostrar la informaci\u00f3 en min\u00fascules), o date , per a formatar dates amb el format que es vulga: {{ dada_de_tipus_data | date ( \"d/m/Y\" ) }} Comentaris \u00c9s possible tamb\u00e9 afegir l\u00ednies de comentaris en les plantilles Twig, mitjan\u00e7ant la sintaxi {# ... #} : {# A\u00e7\u00f2 \u00e9s un comentari #} Reutilitzar contingut de plantilles pare Hem vist que podem sobreescriure el contingut d'un bloc (block) d'una plantilla pare, simplement definint el mateix bloc en la subplantilla filla. Per\u00f2 tamb\u00e9 \u00e9s possible reutilitzar el contingut del pare i afegir el propi de la filla, cridant al pare amb parent . Per exemple, imaginem que, a m\u00e9s dels estils CSS que tinguem definits en base.html.twig , volem afegir altres particulars per a una plantilla, sense perdre els de el pare. Ho far\u00edem aix\u00ed: {% block stylesheets %} {{ parent () }} < link href = \" {{ asset ( 'css/some_styles.css' ) }} \" rel = \"stylesheet\" /> {% endblock %} {% endraw %} Cicles L'opci\u00f3 cycle \u00e9s molt \u00fatil quan volem alternar c\u00edclicament certs valors en un bucle. Per exemple, per a mostrar un llistat amb 10 files i estils de fila alterns, podem fer alguna cosa aix\u00ed: {% for i in 1..10 %} < div class = \" {{ cycle ([ 'par' , 'impar' ], i ) }} \" > ... </ div > {% endfor %} Altres opcions Existeixen altres opcions que no hem vist i podeu consultar en la web oficial de Twig .","title":"Gesti\u00f3 de plantilles amb Twig"},{"location":"08-symfony/03-twig/#gestio-de-plantilles-amb-twig","text":"","title":"Gesti\u00f3 de plantilles amb Twig"},{"location":"08-symfony/03-twig/#definint-plantilles-de-vistes-amb-twig","text":"Els exemples de controladors vistos fins ara queden un poc limitats, perqu\u00e8 el disseny brilla per la seua abs\u00e8ncia. Ens hem limitat a mostrar un text pla amb les dades per a comprovar que el controlador funciona, o en tot cas, a generar un HTML rudimentari en l'objecte Response per a mostrar una llista. Per\u00f2 si volem generar una vista m\u00e9s complicada, no \u00e9s bona idea fer-ho afegint els elements en la cadena de text per a la resposta. Ara veurem com podem generar vistes amb una mica de disseny, gr\u00e0cies al motor de plantilles Twig. La filosofia d'utilitzar motors de plantilles com Twig \u00e9s separar tot el possible el codi PHP de l'estructura HTML de la p\u00e0gina, de manera que tota la l\u00f2gica de negoci queda fora de la vista (en el controlador, normalment), i en aquesta deixem el necessari per a mostrar el contingut al client. Per a a\u00e7\u00f2, el que es sol fer \u00e9s, des del controlador, accedir al model per a obtenir o modificar les dades necess\u00e0ries, emmagatzemar-los en variables i passar aquestes variables a les vistes o plantilles, de manera que aquestes nom\u00e9s hagen d'encarregar-se de mostrar aqueixa informaci\u00f3 amb l'estructura i disseny adequats. A\u00efllem, per tant, el treball del programador d'una banda (controlador i model), i el del dissenyador per un altre (vistes)","title":"Definint plantilles de vistes amb Twig"},{"location":"08-symfony/03-twig/#la-nostra-primera-plantilla","text":"Anem a veure com renderitzar una plantilla amb Twig. En primer lloc, hem de fer alguns petits canvis en el controlador que vaja a usar Twig: farem que la classe del controlador herete d' AbstractController (incorporant aquesta classe del seu corresponent espai de noms): namespace App ; ... use Symfony ; class NameController extends AbstractController { A\u00e7\u00f2 ho farem per a poder utilitzar algunes de les facilitats que ens dona AbstractController , com per exemple el m\u00e8tode render per a renderitzar vistes. Com hem comentat en sessions anteriors, les vistes s'emmagatzemen en la carpeta templates del nostre projecte Symfony, i si emprem Twig com a motor de plantilles, tenen l'extensi\u00f3 .html.twig. Per exemple, crearem una plantilla anomenada home.html.twig en la nostra aplicaci\u00f3 de movies , amb aquest codi: < html > < body > < h1 > Movies </ h1 > < h2 > Welcome to Movie FX </ h2 > < p > Home </ p > </ body > </ html > Ara modificarem la classe src/Controller/HomeController perqu\u00e8 herete d' AbstractController . namespace App\\Controller ; use Symfony\\Component\\HttpFoundation\\Response ; use Symfony\\Component\\Routing\\Annotation\\Route ; use Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController ; class HomeController extends AbstractController { ... i modifiquem tamb\u00e9 el m\u00e8tode home perqu\u00e8, en lloc de mostrar una resposta de text pla, renderitze la vista home.html.twig que acabem de fer. Per a a\u00e7\u00f2, el codi ser\u00e0 el seg\u00fcent: /** * @Route(\"/\", name=\"home\") */ public function home () { return $this -> render ( 'home.html.twig' ); } Observa com emprem l'objecte $this (recorda, ara la nostra classe \u00e9s un subtipus d' AbstractController ) per a accedir al m\u00e8tode render i renderitzar la vista que li indiquem, que autom\u00e0ticament se cercar\u00e0 des de la carpeta templates .","title":"La nostra primera plantilla"},{"location":"08-symfony/03-twig/#plantilles-amb-parts-variables","text":"La plantilla anterior no \u00e9s alguna cosa massa habitual, ja que \u00fanicament cont\u00e9 text est\u00e0tic. El normal \u00e9s que hi haja alguna part que varie, i que li siga proporcionada des del controlador. Anem a veure un altre exemple amb la fitxa de la pel\u00b7l\u00edcula: anem a la nostra classe src/Controller/MovieController i fem que tamb\u00e9 herete d' AbstractController: namespace App\\Controller ; use Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController ; use Symfony\\Component\\HttpFoundation\\Response ; use Symfony\\Component\\Routing\\Annotation\\Route ; class MovieController extends AbstractController Anem a generar una plantilla anomenada movies_show.html.twig en la nostra carpeta templates . Rebr\u00e0 com a par\u00e0metre del controlador la pel\u00b7l\u00edcula amb el codi indicat (despr\u00e9s veurem com), i mostrar\u00e0 en la plantilla les seues dades. El codi de la plantilla pot quedar aix\u00ed: < h1 > Movie data </ h1 > < h2 > {{ movie.title }} </ h2 > < p > Tagline: {{ movie.tagline }} </ p > < p > Release date: {{ movie.release_date }} </ p > Emprem la notaci\u00f3 de la doble clau {{ ... }} per a situar variables, que normalment s\u00f3n dades que esperem rebre de fora (del controlador, en aquest cas). Ens faltaria, en el m\u00e8tode show de MovieController , obtenir la pel\u00b7l\u00edcula desitjada (a\u00e7\u00f2 ja ho tenim fet) i passar-li-la a la vista, d'aquesta manera: /** * @Route(\"/movies/{id}\", name=\"movies_show\", requirements={\"id\"=\"\\d+\"}) */ public function show ( $id = 2 ) { $result = array_filter ( $this -> movies , function ( $movie ) use ( $id ) { return $movie [ \"id\" ] == $id ; }); if ( count ( $result ) > 0 ) { return $this -> render ( 'movies_show.html.twig' , array ( 'movie' => array_shift ( $result ) )); } else return new Response ( \"Movie not found\" ); } Com veus, n'hi ha prou amb utilitzar un array de par\u00e0metres en el m\u00e8tode render per a passar-li a la vista tot el que necessite, identificant cada cosa amb el nom que vulguem, i que coincidir\u00e0 amb el qual s'utilitzar\u00e0 en el codi de la vista (el par\u00e0metre movie , en aquest cas).","title":"Plantilles amb parts variables"},{"location":"08-symfony/03-twig/#estructures-de-control-en-plantilles","text":"La plantilla anterior \u00e9s un exemple per a afegir parts din\u00e0miques en el contingut de la mateixa, per\u00f2 est\u00e0 alguna cosa \"coixa\": qu\u00e8 passa si no trobem la pel\u00b7l\u00edcula? En aquest cas, el controlador es limita a retornar una resposta de text pla que diu \"Movie not found\", per\u00f2 podr\u00edem emprar la mateixa vista (o una altra) per a mostrar aquesta informaci\u00f3 m\u00e9s elaborada. Aix\u00ed, el controlador renderizar\u00e1 la mateixa vista, passant-li una pel\u00b7l\u00edcula v\u00e0lida o null , segons el cas: public function show ( $id = 2 ) { $result = array_filter ( $this -> movies , function ( $movie ) use ( $id ) { return $movie [ \"id\" ] == $id ; }); if ( count ( $result ) > 0 ) { return $this -> render ( 'movies_show.html.twig' , array ( 'movie' => array_shift ( $result ) )); } else return $this -> render ( 'movies_show.html.twig' , array ( 'movie' => null )); } i la vista distingir\u00e0 si hi ha o no pel\u00b7l\u00edcula, per a mostrar una o una altra informaci\u00f3: < html > < body > < h1 > Movie data </ h1 > {% if movie %} < ul > < li >< strong > {{ movie.title }} </ strong ></ li > < li >< strong > Tagline </ strong > : {{ movie.tagline }} </ li > < li >< strong > Release date </ strong > : {{ movie.release_date }} </ li > </ ul > {% else %} < p > Movie not found </ p > {% endif %} </ body > </ html > Observa com hem incl\u00f2s un bloc {% ... %} , que s\u00f3n blocs d'acci\u00f3, emprats per a definir certes sent\u00e8ncies de control (condicions, bucles) i incloure dins el codi associat a aquesta sent\u00e8ncia. De la mateixa manera, per al controlador de filtratge de pel\u00b7l\u00edcules per t\u00edtol, podem crear una nova vista (per exemple, \"movies_filter.html.twig\"), que mostre el llistat de pel\u00b7l\u00edcules que reba ja filtrat del controlador: < h1 > Movies </ h1 > {% if movies %} < ul > {% for movie in movies %} < li >< strong > {{ movie.title }} </ strong ></ li > < li >< strong > Tagline </ strong > : {{ movie.tagline }} </ li > < li >< strong > Release date </ strong > : {{ movie.release_date }} </ li > </ ul > {% endfor %} {% else %} < p > No movies found </ p > {% endif %} Aix\u00ed, el codi del controlador es limitar\u00e0 a filtrar les i a passar-li'ls a la vista: public function filter ( $text ) { $result = array_filter ( $this -> movies , function ( $movie ) use ( $text ) { return strpos ( $movie [ \"title\" ], $text ) !== false ; }); $response = \"\" ; if ( count ( $result ) > 0 ) { foreach ( $result as $movie ) { $response .= \"<ul><li>\" . $movie [ \"title\" ] . \"</li>\" . \"<li>\" . $movie [ \"tagline\" ] . \"</li>\" . \"<li>\" . $movie [ \"release_date\" ] . \"</li></ul>\" ; } return $this -> render ( 'movies_filter.html.twig' , array ( 'movies' => $result )); } } Observa com podem emprar bucles en les plantilles per a rec\u00f3rrer col\u00b7leccions de dades passades des del controlador.","title":"Estructures de control en plantilles"},{"location":"08-symfony/03-twig/#herencia-de-plantilles","text":"L'her\u00e8ncia de plantilles ens permet reaprofitar el codi d'unes en unes altres. En realitat, a\u00e7\u00f2 \u00e9s alguna cosa molt habitual en el disseny web: que totes les p\u00e0gines (o diverses) d'una web compartisquen la mateixa cap\u00e7alera i peu, per exemple. Aix\u00ed, podem definir una estructura o layout base en una plantilla, i fer que altres hereten d'ella per a emplenar certs buits. Vegem un exemple amb la nostra web de pel\u00b7l\u00edcules. En primer lloc, definirem la plantilla base. Teniu un exemple en qu\u00e8 basar-vos ja fet, en l'arxiu templates/base.html.twig , que proporciona un esquelet que podr\u00edem aprofitar per a moltes aplicacions: <!DOCTYPE html> < html > < head > < meta charset = \"UTF-8\" > < title > {% block title %} Welcome! {% endblock %} </ title > {% block stylesheets %}{% endblock %} {% block javascripts %}{% endblock %} </ head > < body > {% block body %}{% endblock %} </ body > </ html > Com podem observar, la part \"emplenable\" de la plantilla es defineix mitjan\u00e7ant blocs ( blocks ), de manera que en les diferents subplantilles podem indicar quins blocs de la plantilla pare volem emplenar. Per exemple, anem a definir una subplantilla per a la p\u00e0gina d'inici. Retoquem la nostra plantilla home.html.twig i la deixem aix\u00ed: {% extends 'base.html.twig' %} {% block title %} Movies {% endblock %} {% block body %} < h1 > Movies </ h1 > < p > Welcome to Movies FX Site! </ p > {% endblock %} \u00c9s important que, si una plantilla hereta d'una altra, el primer codi que hi haja en aqueixa plantilla (sense explicar comentaris previs) siga una instrucci\u00f3 {% raw %} {% extends ... %} {% endraw %} per a indicar que \u00e9s una her\u00e8ncia. Despr\u00e9s, n'hi ha prou amb emplenar els blocs que el seu contingut vulguem modificar o establir: en aquest exemple, els blocs title i body , definits en la plantilla base, encara que el bloc title es podria deixar predefinit com a \"Movies\" en la plantilla base tamb\u00e9. De la mateixa manera, definir\u00edem les plantilles movies_show.html.twig . {% extends 'base.html.twig' %} {% block title %} Movies {% endblock %} {% block body %} < h1 > Movie data </ h1 > {% if movie %} < ul > < li >< strong > {{ movie.title }} </ strong ></ li > < li >< strong > Tagline </ strong > : {{ movie.tagline }} </ li > < li >< strong > Release date </ strong > : {{ movie.release_date }} </ li > </ ul > {% else %} < p > Movie not found </ p > {% endif %} {% endblock %} ... i movies_filter.html.twig : {% extends 'base.html.twig' %} {% block title %} Movies {% endblock %} {% block body %} < h1 > Movies </ h1 > {% if movies %} {% for movie in movies %} < ul > < li >< strong > {{ movie.title }} </ strong ></ li > < li >< strong > Tagline </ strong > : {{ movie.tagline }} </ li > < li >< strong > Release date </ strong > : {{ movie.release_date }} </ li > </ ul > {% endfor %} {% else %} < p > No movies found </ p > {% endif %} {% endblock %}","title":"Her\u00e8ncia de plantilles"},{"location":"08-symfony/03-twig/#incloure-plantilles-dins-daltres","text":"Altra opci\u00f3 interessant, a part de l'her\u00e8ncia, \u00e9s la de poder incloure una plantilla com a part del contingut d'una altra. N'hi ha prou amb utilitzar la instrucci\u00f3 include , seguida del nom de la plantilla i, si els necessita, els seus par\u00e0metres associats. Per exemple, podr\u00edem traure la llista de pel\u00b7l\u00edcules d'una plantilla anomenada movie_data.html.twig : < ul > < li >< strong > {{ movie.title }} </ strong ></ li > < li >< strong > Tagline </ strong > : {{ movie.tagline }} </ li > < li >< strong > Release date </ strong > : {{ movie.release_date }} </ li > </ ul > I incloure-la tant en movies_show ... {% extends 'base.html.twig' %} {% block title %} Movies {% endblock %} {% block body %} < h1 > Movie data </ h1 > {% if movie %} {{ include ( 'movie_data.html.twig' , { 'movie' : movie }) }} {% else %} < p > Movie not found </ p > {% endif %} {% endblock %} ... com en movies_filter : {% extends 'base.html.twig' %} {% block title %} Movies {% endblock %} {% block body %} < h1 > Movies </ h1 > {% if movies %} {% for movie in movies %} {{ include ( 'movie_data.html.twig' , { 'movie' : movie }) }} {% endfor %} {% else %} < p > No movies found </ p > {% endif %} {% endblock %}","title":"Incloure plantilles dins d'altres"},{"location":"08-symfony/03-twig/#enllacos-a-rutes-i-a-elements-estatics","text":"Per a finalitzar aquest apartat d'edici\u00f3 de plantilles, ens queden dos aspectes importants a tractar: Com incloure contingut est\u00e0tic (fulles d'estil, imatges... i tot el que, en general, estiga dins de la carpeta \"public\" del projecte) Com afegir enlla\u00e7os a altres rutes","title":"Enlla\u00e7os a rutes i a elements est\u00e0tics"},{"location":"08-symfony/03-twig/#afegir-contingut-estatic-en-plantilles","text":"Per a il\u00b7lustrar com afegir contingut est\u00e0tic en plantilles, anem a definir en la nostra carpeta public de la web de pel\u00b7l\u00edcules una subcarpeta css , i dins un arxiu styles.css (que quedar\u00e0, per tant, en public/css/styles.css . Definim dins un estil b\u00e0sic per a provar. Per exemple: body { background-color : #99ccff ; } h1 { border-bottom : 1 px solid black ; } } Ara, anem a afegir aquest estil a la nostra web. Com tenim un bloc stylesheets en la nostra plantilla base.html.twig , podem aprofitar-ho i incloure el CSS dins d'aquest bloc, perqu\u00e8 ho utilitzen totes les subplantillas: <!DOCTYPE html> < html > < head > < meta charset = \"UTF-8\" > < title > {% block title %} Welcome! {% endblock %} </ title > {% block stylesheets %} < link href = \" {{ asset ( 'css/styles.css' ) }} \" rel = \"stylesheet\" /> {% endblock %} {% block javascripts %}{% endblock %} </ head > < body > {% block body %}{% endblock %} </ body > </ html > De la mateixa manera, si tingu\u00e9rem una imatge, per exemple, public/images/image.png , podr\u00edem afegir-la en la plantilla amb un cosa aix\u00ed: < img src = \" {{ asset ( 'images/image.png' ) }} \" /> Podem tamb\u00e9 emprar rutes absolutes, emprant la instrucci\u00f3 absolute_url : < img src = \" {{ absolute_url ( asset ( 'images/image.png' )) }} \" /> En el cas d'arxius javascript, s'afegirien en el bloc javascripts de la plantilla base (o d'alguna subplantilla, si es vol). Per exemple, suposant que tenim un arxiu library.js penjant de la subcarpeta public/js , far\u00edem alguna cosa aix\u00ed: {% block javascripts %} < script src = \" {{ asset ( 'js/library.js' ) }} \" ></ script > {% endblock %}","title":"Afegir contingut est\u00e0tic en plantilles"},{"location":"08-symfony/03-twig/#enllacar-a-altres-rutes-de-laplicacio","text":"Si el que volem \u00e9s definir un enlla\u00e7 a una altra ruta o p\u00e0gina de la nostra aplicaci\u00f3, en aqueix cas utilitzem la funci\u00f3 path per a indicar el nom ( name ) que h\u00e0gem assignat a la ruta a la qual volem anar. Per exemple, si volem anar a la fitxa d'una pel\u00b7l\u00edcula el codi del qual est\u00e0 emmagatzemat en la variable id , far\u00edem alguna cosa aix\u00ed: < a href = \" {{ path ( 'movies_show' , { 'id' : id }) }} \" > ... </ a >","title":"Enlla\u00e7ar a altres rutes de l'aplicaci\u00f3"},{"location":"08-symfony/03-twig/#altres-caracteristiques-interessants-de-twig","text":"A m\u00e9s de tot l'exposat durant aquest apartat, existeixen altres caracter\u00edstiques interessants de Twig. Vegem algunes d'elles r\u00e0pidament en aquesta subsecci\u00f3.","title":"Altres caracter\u00edstiques interessants de Twig"},{"location":"08-symfony/03-twig/#us-de-filtres","text":"Quan volem mostrar informaci\u00f3 en una plantilla amb la sintaxi de la doble clau {{...}} , podem emprar filtres per a processar la informaci\u00f3 a mostrar i donar-li cert format. Els filtres en Twig s'activen mitjan\u00e7ant la barra vertical ( | ), seguida del filtre a aplicar. Per exemple, si volem mostrar el nom del t\u00edtol en maj\u00fascules, far\u00edem alguna cosa aix\u00ed: {{ movie.title | upper }} Existeixen altres filtres \u00fatils, com lower (per a mostrar la informaci\u00f3 en min\u00fascules), o date , per a formatar dates amb el format que es vulga: {{ dada_de_tipus_data | date ( \"d/m/Y\" ) }}","title":"\u00das de filtres"},{"location":"08-symfony/03-twig/#comentaris","text":"\u00c9s possible tamb\u00e9 afegir l\u00ednies de comentaris en les plantilles Twig, mitjan\u00e7ant la sintaxi {# ... #} : {# A\u00e7\u00f2 \u00e9s un comentari #}","title":"Comentaris"},{"location":"08-symfony/03-twig/#reutilitzar-contingut-de-plantilles-pare","text":"Hem vist que podem sobreescriure el contingut d'un bloc (block) d'una plantilla pare, simplement definint el mateix bloc en la subplantilla filla. Per\u00f2 tamb\u00e9 \u00e9s possible reutilitzar el contingut del pare i afegir el propi de la filla, cridant al pare amb parent . Per exemple, imaginem que, a m\u00e9s dels estils CSS que tinguem definits en base.html.twig , volem afegir altres particulars per a una plantilla, sense perdre els de el pare. Ho far\u00edem aix\u00ed: {% block stylesheets %} {{ parent () }} < link href = \" {{ asset ( 'css/some_styles.css' ) }} \" rel = \"stylesheet\" /> {% endblock %} {% endraw %}","title":"Reutilitzar contingut de plantilles pare"},{"location":"08-symfony/03-twig/#cicles","text":"L'opci\u00f3 cycle \u00e9s molt \u00fatil quan volem alternar c\u00edclicament certs valors en un bucle. Per exemple, per a mostrar un llistat amb 10 files i estils de fila alterns, podem fer alguna cosa aix\u00ed: {% for i in 1..10 %} < div class = \" {{ cycle ([ 'par' , 'impar' ], i ) }} \" > ... </ div > {% endfor %}","title":"Cicles"},{"location":"08-symfony/04-injeccio-dependencies/","text":"El contenidor de serveis i la injecci\u00f3 de depend\u00e8ncies Introducci\u00f3 La injecci\u00f3 de depend\u00e8ncies \u00e9s un concepte habitualment lligat a frameworks de desenvolupament web. Fa refer\u00e8ncia a un patr\u00f3 de disseny orientat a relacionar adequadament els objectes que componen l'aplicaci\u00f3 de manera que es comparteixen certs recursos globals o es subministren a cada classe que els necessite en lloc de ser la mateixa classe qui els crea. A\u00e7\u00f2 afavoreix el desacoblament de la nostra aplicaci\u00f3, en permetre que els elements que la componen siguen m\u00e9s independents entre si. Per exemple, imaginem que hem d'accedir des de diverses classes o fitxers font a una base de dades MySQL. Sense la injecci\u00f3 de depend\u00e8ncies, haur\u00edem de crear la connexi\u00f3 a la base de dades en cadascuna d'aqueixes classes o fitxers font.No obstant aix\u00f2, comptant amb aquesta caracter\u00edstica, algun element de l'aplicaci\u00f3 s'encarregar\u00e0 de crear la connexi\u00f3, i facilitar-la als altres elements que la necessiten. Per a gestionar aquesta injecci\u00f3 de depend\u00e8ncies Symfony utilitza un objecte anomenat contenidor de serveis que \u00e9s qui s'encarregar\u00e0 de crear les inst\u00e0ncies de tots aqueixos elements que seran compartits o accedits des de diferents llocs del codi, i que cridarem serveis . Symfony ja compta amb una s\u00e8rie de serveis predefinits, i cada m\u00f2dul de tercers ( bundle ) que afegim a l'aplicaci\u00f3 incorpora els seus propis. Configuraci\u00f3 general dels serveis De forma general, els serveis es configuren en l'arxiu services.yaml dins de la carpeta config de la nostra aplicaci\u00f3. Si fem una ullada a la configuraci\u00f3 d'inici, podem distingir quatre apartats: Configuraci\u00f3 de par\u00e0metres globals per a tots els serveis. Ac\u00ed definirem les propietats que podran ser accedides per tots els serveis que utilitzem o creem. Per exemple, hi ha un par\u00e0metre locale per a indicar que la localitzaci\u00f3 de l'aplicaci\u00f3 empra l'idioma angl\u00e9s per defecte parameters : locale : 'en' Despr\u00e9s es t\u00e9 la secci\u00f3 de services . El primer apartat dins d'aquesta secci\u00f3 indica la configuraci\u00f3 per defecte que tindran els serveis: services : _defaults : autowire : true autoconfigure : true public : false autowire fa refer\u00e8ncia al fet que els serveis s'auto-injecten, \u00e9s a dir, quan es passa com a par\u00e0metre un servei a un m\u00e8tode indicant el nom de la classe, autom\u00e0ticament Symfony crea l'objecte corresponent i el passa com a par\u00e0metre. Per exemple, si fem: use Psr ; class ... { public function method(LoggerInterface $logger) Symfony detectar\u00e0 la classe LoggerInterface com un servei existent, crear\u00e0 una inst\u00e0ncia del mateix i la passar\u00e0 al m\u00e8tode com a par\u00e0metre. * autoconfigure indica que els serveis que es creen es registren autom\u00e0ticament atenent al seu tipus. Per exemple, si vam crear una classe que hereta de Command, es registrar\u00e0 autom\u00e0ticament com un comando. * public indica el nivell de visibilitat dels serveis, que per defecte no \u00e9s p\u00fablic (opci\u00f3 recomanada). A continuaci\u00f3, hi ha una secci\u00f3 que permet que qualsevol cosa que definim en la carpeta src es puga utilitzar com a servei, i injectar-se en altres elements, a excepci\u00f3 dels elements indicats en la propietat exclude App\\ : resource : '../src/*' exclude : - '../src/DependencyInjection/' - '../src/Entity/' - '../src/Kernel.php' - '../src/Tests/' Finalment, hi ha un \u00faltim apartat dedicat als controladors, per a permetre que els serveis se'ls puguen injectar com a arguments, encara que no heretem de cap classe base de controlador. App\\Controller\\ : resource : '../src/Controller' tags : [ 'controller.service_arguments' ] Mostrar serveis actuals En sessions anteriors, en parlar del comando bin/console que tenim disponible en qualsevol projecte Symfony, vam posar com a exemple un comando que mostra tots els serveis que es tenen actualment disponibles en la nostra aplicaci\u00f3: php bin/console debug:autowiring Utilitzar serveis En Symfony existeixen multitud de serveis ja predefinits i llestos per a utilitzar-se, com per exemple un mailer per a enviar correus electr\u00f2nics, o un logger per a generar missatges de log de diferent \u00edndole (errors, warnings , etc). Per a utilitzar-los, n'hi ha prou amb passar com a par\u00e0metre al controlador que ho requerisca un objecte del tipus corresponent. Per exemple, si volem utilitzar un logger , Symfony posa a la nostra disposici\u00f3 el bundle Monolog, a trav\u00e9s de la classe LoggerInterface. N'hi ha prou que passem un par\u00e0metre d'aquest tipus al nostre controlador per a utilitzar-ho. Anem al nostre projecte de pel\u00b7l\u00edcules, en concret a la classe src/Controller/HomeController , i utilitzem aquest logger per a traure un missatge amb la data i hora de l'acc\u00e9s a la p\u00e0gina d'inici. La classe quedar\u00e0 aix\u00ed: <? php namespace App\\Controller ; use Psr\\Log\\LoggerInterface ; use Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController ; use Symfony\\Component\\Routing\\Annotation\\Route ; class HomeController extends AbstractController { private LoggerInterface $logger ; public function __construct ( LoggerInterface $logger ) { $this -> logger = $logger ; } /** * @Route(\"/\", name=\"home\") */ public function home () { $now = new \\DateTime (); $this -> logger -> info ( \"Access on { $now -> format ( \"Y/m/d H:i:s\" ) } \" ); return $this -> render ( \"home.html.twig\" ); } } nota Observa com hem emprat la classe DateTime de PHP, posant-li una barra invertida davant perqu\u00e8 la reconega com a pr\u00f2pia de PHP. Podr\u00edem haver passat directament l'objecte LoggerInterface al m\u00e8tode home , per\u00f2 \u00e9s m\u00e9s habitual passar els serveis a un constructor de la classe i guardar-los en atributs de la mateixa, per a poder ser utilitzats per m\u00e9s d'un m\u00e8tode. Si accedim a l'arrel de l'aplicaci\u00f3 ( http://movies-symfony ), es generar\u00e0 el corresponent missatge de registre ( log ). Aquests missatges es guarden per defecte en la subcarpeta var/log , en concret en l'arxiu dev.log si estem en mode desenvolupament, o en prod.log si estem en producci\u00f3. Es poden configurar aquests arxius i altres opcions, per\u00f2 l'\u00fas d'aquesta llibreria no forma part dels continguts d'aquest curs, l'emprarem nom\u00e9s com a exemple d'\u00fas de serveis, i per a alguna depuraci\u00f3 puntual d'algun controlador. A m\u00e9s del m\u00e8tode info vist en l'exemple, existeixen altres m\u00e8todes per a generar missatges de major o menor prioritat, com per exemple warning, error, critical... Es pot obtenir un llistat fent una ullada al codi de LoggerInterface. Crear serveis Ara vorem com crear els nostres propis serveis. Seguint amb la nostra aplicaci\u00f3 d'exemple (movies), extraurem la \"base de dades\" de pel\u00b7l\u00edcules a un servei. Si recordem, per a evitar de moment utilitzar una base de dades real, hav\u00edem creat a m\u00e0 un array de pel\u00b7l\u00edcules en la nostra classe src/Controller/MovieController . El que farem ara ser\u00e0 definir aquest array dins d'un servei, per a poder accedir a ell des de qualsevol element de l'aplicaci\u00f3. Els serveis es poden crear en qualsevol carpeta de src , ja que, com hem vist, qualsevol element d'aquesta carpeta (excepte uns pocs preconfigurats) autom\u00e0ticament es defineix com a servei. Per a agrupar-los tots, podem crear-los, per exemple, en la subcarpeta src/Service . En el nostre cas, cridarem a la classe del servei DBTest . Definim dins l'array, i un m\u00e8tode que ho retorne: namespace App\\Service ; class DBTest { private array $movies = [ [ \"id\" => \"2\" , \"title\" => \"Ava\" , \"tagline\" => \"Kill. Or be killed\" , \"release_date\" => \"25/09/2020\" ], [ \"id\" => \"3\" , \"title\" => \"Bill &Ted Face the Music\" , \"tagline\" => \"The future awaits\" , \"release_date\" => \"24/09/2020\" ], [ \"id\" => \"4\" , \"title\" => \"Hard Kill\" , \"tagline\" => \"Take on a madman. Save the world.\" , \"release_date\" => \"14/09/2020\" ], [ \"id\" => \"5\" , \"title\" => \"The Owners\" , \"tagline\" => \"\" , \"release_date\" => \"10/05/2020\" ], [ \"id\" => \"6\" , \"title\" => \"The New Mutants\" , \"tagline\" => \"It's time to face your demons.\" , \"release_date\" => \"20/04/2020\" ], ]; public function get () : array { return $this -> movies ; } } La nostra classe src/Controller/MovieController quedar\u00e0 d'aquesta manera: ... class MovieController extends AbstractController { private array $movies ; public function __construct ( DBTest $data ) { $this -> movies = $data -> get (); } ... Com veiem, el que s'ha fet \u00e9s utilitzar un constructor per a passar-li com a par\u00e0metre el servei (objecte de tipus DBTest ), i guardar les dades en un atribut intern de la classe, per a poder-lo usar tant en el m\u00e8tode show com en el m\u00e8tode filter . Recorda afegir tamb\u00e9 la corresponent l\u00ednia use per a utilitzar la classe DBTest . Altres opcions Ara que ja sabem com crear serveis propis i utilitzar-los, o b\u00e9 utilitzar serveis de Symfony o de bundles de tercers, anem a veure algunes opcions una mica m\u00e9s avan\u00e7ades que afecten al contenidor de serveis i als serveis que utilitzem i desenvolupem. Combinar serveis Qu\u00e8 ocorreria si en una classe o m\u00e8tode determinat necessitem emprar m\u00e9s d'un servei? Tenim dues alternatives: Passar tants par\u00e0metres com a serveis es requerisquen, normalment al constructor de la classe. Per exemple, si necessitem un objecte de tipus DBTest i un altre de tipus LoggerInterface en una mateixa classe, podem fer a\u00e7\u00f2: class MyClass { private array $movies ; private LoggerInterface $logger ; public function __construct ( DBTest $data , LoggerInterface $logger ) { $this -> movies = $data -> get (); $this -> logger = $logger ; } } Com a segona alternativa, tamb\u00e9 es pot crear una classe que encapsule els objectes necessaris (para no passar-los per separat com a par\u00e0metre), i despr\u00e9s utilitzar un objecte d'aqueixa classe en el constructor. Aix\u00ed, per al mateix exemple anterior primer crear\u00edem una classe que encapsulara un objecte DBTest i un altre LoggerInterface ... class CombinedService { private array $movies ; private LoggerInterface $logger ; public function __construct ( DBTest $data , LoggerInterface $logger ) { $this -> movies = $data -> get (); $this -> logger = $logger ; } // create getters or methods to acces ... i despr\u00e9s l'utilitzariem en la classe: class MyClass { private $service ; public function __construct ( CombinedService $service ) { $this -> $service = $service ; } ... Arguments sense \"autowiring\" Hem vist que l'opci\u00f3 de configuraci\u00f3 autowiring existent en l'arxiu config/services.yaml fa refer\u00e8ncia al fet que quan passem un objecte d'un servei determinat a un m\u00e8tode (indicant el tipus d'objecte) Symfony autom\u00e0ticament crea l'objecte per nosaltres i li'l passa al m\u00e8tode. No obstant aix\u00f2, existeixen alguns arguments per als quals Symfony no pot aplicar aquest mecanisme. Per exemple, suposem que en la nostra classe HomeController volem que el format de data per al missatge de registre ( log ) siga personalizable, i per tant, es puga passar com a argument. La classe quedaria aix\u00ed: ... class HomeController extends AbstractController { private LoggerInterface $logger ; private string $dateFormat ; public function __construct ( LoggerInterface $logger , string $dateFormat ) { $this -> logger = $logger ; $this -> dateFormat = $dateFormat ; } /** * @Route(\"/\", name=\"home\") */ public function home () { $now = new \\DateTime (); $this -> logger -> info ( \"Access on { $now -> format ( $this -> dateFormat ) } \" ); return $this -> render ( \"home.html.twig\" ); } } Per\u00f2 si intentem utilitzar-lo (accedint a movies-symfony ), obtindrem el seg\u00fcent missatge d'error: Cannot autowire service \"App\\Controller\\HomeController\": argument \"$dateFormat\" of method \"__construct()\" is type-hinted \"string\", you should configure its value explicitly. En realitat, el que ha ocorregut \u00e9s bastant simple: per al primer argument ( LoggerInterface ), Symfony sap on obtenir-lo i com construir-lo, per\u00f2 per al segon, al no estar tipat (no s'ha indicat el tipus) ni tenir un valor per defecte, Symfony no sap qu\u00e8 fer amb ell. Per a solucionar el problema, podem definir arguments propis d'un servei, \u00e9s a dir, arguments que va a utilitzar un servei determinat i que no s\u00f3n auto- injectables. Per a a\u00e7\u00f2, editem l'arxiu config/services.yaml indicant el nom de la classe afectada, i els par\u00e0metres no auto-injectables que pot rebre el constructor. En el nostre cas, afegim aquestes l\u00ednies al final de l'arxiu: App\\Controller\\HomeController : arguments : $dateFormat : 'Y/m/d H:i:s' Recorda no usar el tabulador per a indentar les propietats (si no quatre espais). El que hem fet ha sigut indicar que la classe HomeController tindr\u00e0 un argument anomenat formatoFecha en el seu constructor, el valor del qual per defecte \u00e9s l'indicat. Par\u00e0metres globals \u00c9s possible tamb\u00e9 definir par\u00e0metres de configuraci\u00f3 globals a tots els serveis, en la secci\u00f3 parameters de l'arxiu config/services.yaml . De fet, ja tenim un par\u00e0metre global definit que indica la localitzaci\u00f3 o idioma general de la p\u00e0gina: parameters : locale : 'en' Tornant a l'exemple anterior, podr\u00edem afegir un nou par\u00e0metre que indique que el format de data per defecte per a qualsevol servei que ho requerisca ser\u00e0 el vist abans: parameters : locale : 'en' default_date_format : 'Y/m/d H:i:s' I podr\u00edem utilitzar aquest par\u00e0metre en qualsevol arxiu de configuraci\u00f3 YAML. Per a comen\u00e7ar, ho podem utilitzar m\u00e9s a baix, quan especifiquem l'argument formatoFecha per a la classe HomeController . Ara farem que prenga el seu valor del par\u00e0metre global, en lloc de posar-li-ho a m\u00e0: App\\Controller\\HomeController : arguments : $dateFormat : '%default_date_format%' Podem accedir als par\u00e0metres globals des de qualsevol controlador, sempre que herete de la classe Controller (i no AbstractController ) accedint a la seua propietat container : use Symfony\\Bundle\\FrameworkBundle\\Controller\\Controller ; class MiController extends Controller { ... public function myFunction () { $format = $this -> container -> getParameter ( 'default_date_format' ); Associar arguments per nom o per tipus Per a finalitzar amb aquest apartat, veurem que es poden associar o establir els arguments dels serveis tant pel tipus d'argument (en el cas que s'especifique tipus) com pel nom del mateix. Per a a\u00e7\u00f2, dins de l'arxiu config/services.yaml , i en concret dins de l'apartat services > _defaults , afegim una propietat bind , i en ella indiquem tantes associacions com vulguem. Vegem un exemple amb l'objecte logger que hem usat per a mostrar missatges de log. Aquest objecte \u00e9s de tipus LoggerInterface , que en realitat \u00e9s una interf\u00edcie, i qualsevol llibreria que la implemente pot servir com a font per a generar aqueixos arxius de log . Una d'elles \u00e9s Monolog , i \u00e9s la que s'utilitza per defecte, per\u00f2 podrien ser unes altres. Associaci\u00f3 per nom Per exemple, podem fer que, sempre que un servei tinga un argument anomenat logger , s'utilitze la llibreria Monolog : services : _defaults : ... bind : $logger : '@monolog.logger.request' Si definim un servei amb un constructor aix\u00ed: private $logger ; public function __construct ( $logger ) { $this -> logger = $logger ; } autom\u00e0ticament a l'argument logger se li assignar\u00e0 un objecte del tipus LoggerInterface de Monolog , encara que no especifiquem el tipus. Associaci\u00f3 per tipus Alternativament, en lloc d'usar el nom de l'argument, podem fer que, sempre que un servei intente utilitzar la interf\u00edcie LoggerInterface (la que hem utilitzat en els exemples d'aquesta sessi\u00f3), s'empre per defecte la implementaci\u00f3 que fa d'ella la llibreria Monolog : services : _defaults : ... bind : Psr\\Log\\LoggerInterface : '@monolog.logger.request' D'aquesta manera, sempre que utilitzem un objecte de tipus LoggerInterface , se li associar\u00e0 una inst\u00e0ncia del logger de Monolog tamb\u00e9.","title":"El contenidor de serveis i la injecci\u00f3 de depend\u00e8ncies"},{"location":"08-symfony/04-injeccio-dependencies/#el-contenidor-de-serveis-i-la-injeccio-de-dependencies","text":"","title":"El contenidor de serveis i la injecci\u00f3 de depend\u00e8ncies"},{"location":"08-symfony/04-injeccio-dependencies/#introduccio","text":"La injecci\u00f3 de depend\u00e8ncies \u00e9s un concepte habitualment lligat a frameworks de desenvolupament web. Fa refer\u00e8ncia a un patr\u00f3 de disseny orientat a relacionar adequadament els objectes que componen l'aplicaci\u00f3 de manera que es comparteixen certs recursos globals o es subministren a cada classe que els necessite en lloc de ser la mateixa classe qui els crea. A\u00e7\u00f2 afavoreix el desacoblament de la nostra aplicaci\u00f3, en permetre que els elements que la componen siguen m\u00e9s independents entre si. Per exemple, imaginem que hem d'accedir des de diverses classes o fitxers font a una base de dades MySQL. Sense la injecci\u00f3 de depend\u00e8ncies, haur\u00edem de crear la connexi\u00f3 a la base de dades en cadascuna d'aqueixes classes o fitxers font.No obstant aix\u00f2, comptant amb aquesta caracter\u00edstica, algun element de l'aplicaci\u00f3 s'encarregar\u00e0 de crear la connexi\u00f3, i facilitar-la als altres elements que la necessiten. Per a gestionar aquesta injecci\u00f3 de depend\u00e8ncies Symfony utilitza un objecte anomenat contenidor de serveis que \u00e9s qui s'encarregar\u00e0 de crear les inst\u00e0ncies de tots aqueixos elements que seran compartits o accedits des de diferents llocs del codi, i que cridarem serveis . Symfony ja compta amb una s\u00e8rie de serveis predefinits, i cada m\u00f2dul de tercers ( bundle ) que afegim a l'aplicaci\u00f3 incorpora els seus propis.","title":"Introducci\u00f3"},{"location":"08-symfony/04-injeccio-dependencies/#configuracio-general-dels-serveis","text":"De forma general, els serveis es configuren en l'arxiu services.yaml dins de la carpeta config de la nostra aplicaci\u00f3. Si fem una ullada a la configuraci\u00f3 d'inici, podem distingir quatre apartats: Configuraci\u00f3 de par\u00e0metres globals per a tots els serveis. Ac\u00ed definirem les propietats que podran ser accedides per tots els serveis que utilitzem o creem. Per exemple, hi ha un par\u00e0metre locale per a indicar que la localitzaci\u00f3 de l'aplicaci\u00f3 empra l'idioma angl\u00e9s per defecte parameters : locale : 'en' Despr\u00e9s es t\u00e9 la secci\u00f3 de services . El primer apartat dins d'aquesta secci\u00f3 indica la configuraci\u00f3 per defecte que tindran els serveis: services : _defaults : autowire : true autoconfigure : true public : false autowire fa refer\u00e8ncia al fet que els serveis s'auto-injecten, \u00e9s a dir, quan es passa com a par\u00e0metre un servei a un m\u00e8tode indicant el nom de la classe, autom\u00e0ticament Symfony crea l'objecte corresponent i el passa com a par\u00e0metre. Per exemple, si fem: use Psr ; class ... { public function method(LoggerInterface $logger) Symfony detectar\u00e0 la classe LoggerInterface com un servei existent, crear\u00e0 una inst\u00e0ncia del mateix i la passar\u00e0 al m\u00e8tode com a par\u00e0metre. * autoconfigure indica que els serveis que es creen es registren autom\u00e0ticament atenent al seu tipus. Per exemple, si vam crear una classe que hereta de Command, es registrar\u00e0 autom\u00e0ticament com un comando. * public indica el nivell de visibilitat dels serveis, que per defecte no \u00e9s p\u00fablic (opci\u00f3 recomanada). A continuaci\u00f3, hi ha una secci\u00f3 que permet que qualsevol cosa que definim en la carpeta src es puga utilitzar com a servei, i injectar-se en altres elements, a excepci\u00f3 dels elements indicats en la propietat exclude App\\ : resource : '../src/*' exclude : - '../src/DependencyInjection/' - '../src/Entity/' - '../src/Kernel.php' - '../src/Tests/' Finalment, hi ha un \u00faltim apartat dedicat als controladors, per a permetre que els serveis se'ls puguen injectar com a arguments, encara que no heretem de cap classe base de controlador. App\\Controller\\ : resource : '../src/Controller' tags : [ 'controller.service_arguments' ]","title":"Configuraci\u00f3 general dels serveis"},{"location":"08-symfony/04-injeccio-dependencies/#mostrar-serveis-actuals","text":"En sessions anteriors, en parlar del comando bin/console que tenim disponible en qualsevol projecte Symfony, vam posar com a exemple un comando que mostra tots els serveis que es tenen actualment disponibles en la nostra aplicaci\u00f3: php bin/console debug:autowiring","title":"Mostrar serveis actuals"},{"location":"08-symfony/04-injeccio-dependencies/#utilitzar-serveis","text":"En Symfony existeixen multitud de serveis ja predefinits i llestos per a utilitzar-se, com per exemple un mailer per a enviar correus electr\u00f2nics, o un logger per a generar missatges de log de diferent \u00edndole (errors, warnings , etc). Per a utilitzar-los, n'hi ha prou amb passar com a par\u00e0metre al controlador que ho requerisca un objecte del tipus corresponent. Per exemple, si volem utilitzar un logger , Symfony posa a la nostra disposici\u00f3 el bundle Monolog, a trav\u00e9s de la classe LoggerInterface. N'hi ha prou que passem un par\u00e0metre d'aquest tipus al nostre controlador per a utilitzar-ho. Anem al nostre projecte de pel\u00b7l\u00edcules, en concret a la classe src/Controller/HomeController , i utilitzem aquest logger per a traure un missatge amb la data i hora de l'acc\u00e9s a la p\u00e0gina d'inici. La classe quedar\u00e0 aix\u00ed: <? php namespace App\\Controller ; use Psr\\Log\\LoggerInterface ; use Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController ; use Symfony\\Component\\Routing\\Annotation\\Route ; class HomeController extends AbstractController { private LoggerInterface $logger ; public function __construct ( LoggerInterface $logger ) { $this -> logger = $logger ; } /** * @Route(\"/\", name=\"home\") */ public function home () { $now = new \\DateTime (); $this -> logger -> info ( \"Access on { $now -> format ( \"Y/m/d H:i:s\" ) } \" ); return $this -> render ( \"home.html.twig\" ); } } nota Observa com hem emprat la classe DateTime de PHP, posant-li una barra invertida davant perqu\u00e8 la reconega com a pr\u00f2pia de PHP. Podr\u00edem haver passat directament l'objecte LoggerInterface al m\u00e8tode home , per\u00f2 \u00e9s m\u00e9s habitual passar els serveis a un constructor de la classe i guardar-los en atributs de la mateixa, per a poder ser utilitzats per m\u00e9s d'un m\u00e8tode. Si accedim a l'arrel de l'aplicaci\u00f3 ( http://movies-symfony ), es generar\u00e0 el corresponent missatge de registre ( log ). Aquests missatges es guarden per defecte en la subcarpeta var/log , en concret en l'arxiu dev.log si estem en mode desenvolupament, o en prod.log si estem en producci\u00f3. Es poden configurar aquests arxius i altres opcions, per\u00f2 l'\u00fas d'aquesta llibreria no forma part dels continguts d'aquest curs, l'emprarem nom\u00e9s com a exemple d'\u00fas de serveis, i per a alguna depuraci\u00f3 puntual d'algun controlador. A m\u00e9s del m\u00e8tode info vist en l'exemple, existeixen altres m\u00e8todes per a generar missatges de major o menor prioritat, com per exemple warning, error, critical... Es pot obtenir un llistat fent una ullada al codi de LoggerInterface.","title":"Utilitzar serveis"},{"location":"08-symfony/04-injeccio-dependencies/#crear-serveis","text":"Ara vorem com crear els nostres propis serveis. Seguint amb la nostra aplicaci\u00f3 d'exemple (movies), extraurem la \"base de dades\" de pel\u00b7l\u00edcules a un servei. Si recordem, per a evitar de moment utilitzar una base de dades real, hav\u00edem creat a m\u00e0 un array de pel\u00b7l\u00edcules en la nostra classe src/Controller/MovieController . El que farem ara ser\u00e0 definir aquest array dins d'un servei, per a poder accedir a ell des de qualsevol element de l'aplicaci\u00f3. Els serveis es poden crear en qualsevol carpeta de src , ja que, com hem vist, qualsevol element d'aquesta carpeta (excepte uns pocs preconfigurats) autom\u00e0ticament es defineix com a servei. Per a agrupar-los tots, podem crear-los, per exemple, en la subcarpeta src/Service . En el nostre cas, cridarem a la classe del servei DBTest . Definim dins l'array, i un m\u00e8tode que ho retorne: namespace App\\Service ; class DBTest { private array $movies = [ [ \"id\" => \"2\" , \"title\" => \"Ava\" , \"tagline\" => \"Kill. Or be killed\" , \"release_date\" => \"25/09/2020\" ], [ \"id\" => \"3\" , \"title\" => \"Bill &Ted Face the Music\" , \"tagline\" => \"The future awaits\" , \"release_date\" => \"24/09/2020\" ], [ \"id\" => \"4\" , \"title\" => \"Hard Kill\" , \"tagline\" => \"Take on a madman. Save the world.\" , \"release_date\" => \"14/09/2020\" ], [ \"id\" => \"5\" , \"title\" => \"The Owners\" , \"tagline\" => \"\" , \"release_date\" => \"10/05/2020\" ], [ \"id\" => \"6\" , \"title\" => \"The New Mutants\" , \"tagline\" => \"It's time to face your demons.\" , \"release_date\" => \"20/04/2020\" ], ]; public function get () : array { return $this -> movies ; } } La nostra classe src/Controller/MovieController quedar\u00e0 d'aquesta manera: ... class MovieController extends AbstractController { private array $movies ; public function __construct ( DBTest $data ) { $this -> movies = $data -> get (); } ... Com veiem, el que s'ha fet \u00e9s utilitzar un constructor per a passar-li com a par\u00e0metre el servei (objecte de tipus DBTest ), i guardar les dades en un atribut intern de la classe, per a poder-lo usar tant en el m\u00e8tode show com en el m\u00e8tode filter . Recorda afegir tamb\u00e9 la corresponent l\u00ednia use per a utilitzar la classe DBTest .","title":"Crear serveis"},{"location":"08-symfony/04-injeccio-dependencies/#altres-opcions","text":"Ara que ja sabem com crear serveis propis i utilitzar-los, o b\u00e9 utilitzar serveis de Symfony o de bundles de tercers, anem a veure algunes opcions una mica m\u00e9s avan\u00e7ades que afecten al contenidor de serveis i als serveis que utilitzem i desenvolupem.","title":"Altres opcions"},{"location":"08-symfony/04-injeccio-dependencies/#combinar-serveis","text":"Qu\u00e8 ocorreria si en una classe o m\u00e8tode determinat necessitem emprar m\u00e9s d'un servei? Tenim dues alternatives: Passar tants par\u00e0metres com a serveis es requerisquen, normalment al constructor de la classe. Per exemple, si necessitem un objecte de tipus DBTest i un altre de tipus LoggerInterface en una mateixa classe, podem fer a\u00e7\u00f2: class MyClass { private array $movies ; private LoggerInterface $logger ; public function __construct ( DBTest $data , LoggerInterface $logger ) { $this -> movies = $data -> get (); $this -> logger = $logger ; } } Com a segona alternativa, tamb\u00e9 es pot crear una classe que encapsule els objectes necessaris (para no passar-los per separat com a par\u00e0metre), i despr\u00e9s utilitzar un objecte d'aqueixa classe en el constructor. Aix\u00ed, per al mateix exemple anterior primer crear\u00edem una classe que encapsulara un objecte DBTest i un altre LoggerInterface ... class CombinedService { private array $movies ; private LoggerInterface $logger ; public function __construct ( DBTest $data , LoggerInterface $logger ) { $this -> movies = $data -> get (); $this -> logger = $logger ; } // create getters or methods to acces ... i despr\u00e9s l'utilitzariem en la classe: class MyClass { private $service ; public function __construct ( CombinedService $service ) { $this -> $service = $service ; } ...","title":"Combinar serveis"},{"location":"08-symfony/04-injeccio-dependencies/#arguments-sense-autowiring","text":"Hem vist que l'opci\u00f3 de configuraci\u00f3 autowiring existent en l'arxiu config/services.yaml fa refer\u00e8ncia al fet que quan passem un objecte d'un servei determinat a un m\u00e8tode (indicant el tipus d'objecte) Symfony autom\u00e0ticament crea l'objecte per nosaltres i li'l passa al m\u00e8tode. No obstant aix\u00f2, existeixen alguns arguments per als quals Symfony no pot aplicar aquest mecanisme. Per exemple, suposem que en la nostra classe HomeController volem que el format de data per al missatge de registre ( log ) siga personalizable, i per tant, es puga passar com a argument. La classe quedaria aix\u00ed: ... class HomeController extends AbstractController { private LoggerInterface $logger ; private string $dateFormat ; public function __construct ( LoggerInterface $logger , string $dateFormat ) { $this -> logger = $logger ; $this -> dateFormat = $dateFormat ; } /** * @Route(\"/\", name=\"home\") */ public function home () { $now = new \\DateTime (); $this -> logger -> info ( \"Access on { $now -> format ( $this -> dateFormat ) } \" ); return $this -> render ( \"home.html.twig\" ); } } Per\u00f2 si intentem utilitzar-lo (accedint a movies-symfony ), obtindrem el seg\u00fcent missatge d'error: Cannot autowire service \"App\\Controller\\HomeController\": argument \"$dateFormat\" of method \"__construct()\" is type-hinted \"string\", you should configure its value explicitly. En realitat, el que ha ocorregut \u00e9s bastant simple: per al primer argument ( LoggerInterface ), Symfony sap on obtenir-lo i com construir-lo, per\u00f2 per al segon, al no estar tipat (no s'ha indicat el tipus) ni tenir un valor per defecte, Symfony no sap qu\u00e8 fer amb ell. Per a solucionar el problema, podem definir arguments propis d'un servei, \u00e9s a dir, arguments que va a utilitzar un servei determinat i que no s\u00f3n auto- injectables. Per a a\u00e7\u00f2, editem l'arxiu config/services.yaml indicant el nom de la classe afectada, i els par\u00e0metres no auto-injectables que pot rebre el constructor. En el nostre cas, afegim aquestes l\u00ednies al final de l'arxiu: App\\Controller\\HomeController : arguments : $dateFormat : 'Y/m/d H:i:s' Recorda no usar el tabulador per a indentar les propietats (si no quatre espais). El que hem fet ha sigut indicar que la classe HomeController tindr\u00e0 un argument anomenat formatoFecha en el seu constructor, el valor del qual per defecte \u00e9s l'indicat.","title":"Arguments sense \"autowiring\""},{"location":"08-symfony/04-injeccio-dependencies/#parametres-globals","text":"\u00c9s possible tamb\u00e9 definir par\u00e0metres de configuraci\u00f3 globals a tots els serveis, en la secci\u00f3 parameters de l'arxiu config/services.yaml . De fet, ja tenim un par\u00e0metre global definit que indica la localitzaci\u00f3 o idioma general de la p\u00e0gina: parameters : locale : 'en' Tornant a l'exemple anterior, podr\u00edem afegir un nou par\u00e0metre que indique que el format de data per defecte per a qualsevol servei que ho requerisca ser\u00e0 el vist abans: parameters : locale : 'en' default_date_format : 'Y/m/d H:i:s' I podr\u00edem utilitzar aquest par\u00e0metre en qualsevol arxiu de configuraci\u00f3 YAML. Per a comen\u00e7ar, ho podem utilitzar m\u00e9s a baix, quan especifiquem l'argument formatoFecha per a la classe HomeController . Ara farem que prenga el seu valor del par\u00e0metre global, en lloc de posar-li-ho a m\u00e0: App\\Controller\\HomeController : arguments : $dateFormat : '%default_date_format%' Podem accedir als par\u00e0metres globals des de qualsevol controlador, sempre que herete de la classe Controller (i no AbstractController ) accedint a la seua propietat container : use Symfony\\Bundle\\FrameworkBundle\\Controller\\Controller ; class MiController extends Controller { ... public function myFunction () { $format = $this -> container -> getParameter ( 'default_date_format' );","title":"Par\u00e0metres globals"},{"location":"08-symfony/04-injeccio-dependencies/#associar-arguments-per-nom-o-per-tipus","text":"Per a finalitzar amb aquest apartat, veurem que es poden associar o establir els arguments dels serveis tant pel tipus d'argument (en el cas que s'especifique tipus) com pel nom del mateix. Per a a\u00e7\u00f2, dins de l'arxiu config/services.yaml , i en concret dins de l'apartat services > _defaults , afegim una propietat bind , i en ella indiquem tantes associacions com vulguem. Vegem un exemple amb l'objecte logger que hem usat per a mostrar missatges de log. Aquest objecte \u00e9s de tipus LoggerInterface , que en realitat \u00e9s una interf\u00edcie, i qualsevol llibreria que la implemente pot servir com a font per a generar aqueixos arxius de log . Una d'elles \u00e9s Monolog , i \u00e9s la que s'utilitza per defecte, per\u00f2 podrien ser unes altres.","title":"Associar arguments per nom o per tipus"},{"location":"08-symfony/05-doctrine/","text":"Gesti\u00f3 del model de dades amb Doctrine Introducci\u00f3 a Doctrine Qu\u00e8 \u00e9s un ORM? Un ORM ( Object Relational Mapping ) \u00e9s un framework encarregat de tractar amb una base de dades relacional (connectar amb ella, realitzar operacions de consulta, inserci\u00f3, etc.), de manera que, de cara a l'aplicaci\u00f3, es converteixen a objectes tots els elements que s'extraguen de la base de dades i viceversa (els objectes de l'aplicaci\u00f3 es transformen en registres de la base de dades, arribat el cas). D'aquesta forma, l'ORM s'encarregar\u00e0 de realitzar aquesta conversi\u00f3 o mapatge autom\u00e0ticament per nosaltres. Definint una s\u00e8rie de regles, indicarem quines taules de la base de dades relacional es corresponen amb quines classes del nostre model, i quins camps de cada taula es corresponen amb quins atributs de cada classe. A partir d'ac\u00ed, l'ORM s'encarregar\u00e0 d'extraure la informaci\u00f3 de la base de dades i crear els objectes corresponents, o de convertir els objectes amb els seus atributs en registres de la base de dades, amb les seues corresponents columnes. El principal avantatge d'utilitzar un ORM com Doctrine \u00e9s a\u00efllar l'aplicaci\u00f3 del gestor de base de dades que h\u00e0gem triat (MySQL, Oracle, PostgreSQL...) ja que a nivell d'aplicaci\u00f3 treballarem amb objectes , i ser\u00e0 Doctrine qui s'encarregue de connectar amb la base de dades triada, i transformar els objectes per a adaptar-los a la mateixa. Configuraci\u00f3 b\u00e0sica de Doctrine Per a poder utilitzar Doctrine, hem d'indicar com connectar al servidor de base de dades que anem a utilitzar. Aquests par\u00e0metres de connexi\u00f3 es poden configurar en l'arxiu .env del nostre projecte. Aquest \u00e9s un arxiu on es defineixen certes variables pr\u00f2pies d'entorn, que despr\u00e9s es processen i es converteixen en variables reals. En el nostre cas, definim una variable anomenada DATABASE_URL , amb una URL on s'especifiquen tant l'adre\u00e7a i port de connexi\u00f3 a la base de dades, com el login i password necessaris per a accedir, aix\u00ed com el nom de la base de dades a la qual connectar. Per exemple, per a una base de dades MySQL, l'estructura general ser\u00e0 aquesta: DATABASE_URL = mysql://db_user:db_password@127.0.0.1:3306/db_name Tenint en compte l'usuari i contrasenya per defecte de phpMyAdmin per a XAMPP (usuari root i contrasenya buida), aquest podria ser un valor v\u00e0lid per a connectar a la nostra base de dades de contactes: DATABASE_URL = mysql://root@127.0.0.1:3306/movies-symfony Aquest arxiu .env pot utilitzar-se tant en desenvolupament com en producci\u00f3, encara que en aquest \u00faltim cas es recomana definir variables d'entorn reals en el sistema, per a evitar p\u00e8rdua de rendiment en haver de traduir aquest arxiu per a cada petici\u00f3. Important Symfony suporta la noci\u00f3 d'entorns. Per defecte, t\u00e9 suport integrat per tres entorns, per\u00f2 pots afegir-ne tants com vulgues: dev , prod i test . Tots els entorns comparteixen el mateix codi, per\u00f2 treballen amb configuracions diferents. Per exemple, totes les eines de depuraci\u00f3 estan habilitades en l'entorn dev . En l'entorn prod l'aplicaci\u00f3 est\u00e0 optimitzada per al rendiment. El canvi d'un entorn a un altre pot realitzar-se modificant la variable d'entorn APP_ENV . Un arxiu .env amb uns valors acuradament escollits es genera autom\u00e0ticament quan es crea el projecte: ###> symfony/framework-bundle ### APP_ENV=dev APP_SECRET=f307a57c2c035484820f08a0494076dc ###< symfony/framework-bundle ### ###> symfony/mailer ### # MAILER_DSN=smtp://localhost ###< symfony/mailer ### DATABASE_URL=\"mysql://root@127.0.0.1:3306/symfony-movies\" Qualsevol paquet pot afegir m\u00e9s variables d'entorn a aquesta imatge gr\u00e0cies a la seva recepta utilitzada per Symfony Flex. El fitxer .env s'envia al repositori i descriu els valors per defecte de l'entorn de producci\u00f3. Podeu substituir aquests valors creant un fitxer .env.local . Aquest fitxer no ha de ser enviat a l'repositori i \u00e9s per aix\u00f2 que el fitxer .gitignore ja l'est\u00e0 ignorant. Mai guardis dades secretes o confidencials en aquests arxius. Per a obtenir m\u00e9s informaci\u00f3 consulta Configuring Symfony En el cas que la base de dades encara no existisca, Doctrine pot crear-la per nosaltres. Per a a\u00e7\u00f2, n'hi ha prou amb escriure el seg\u00fcent comando: php bin/console doctrine:database:create Created database 'movies-symfony' for connection named default Autom\u00e0ticament, es prendr\u00e0 el nom de la base de dades de la variable d'entorn anterior, es connectar\u00e0 al servidor i es crear\u00e0 (sense taules, de moment). Creaci\u00f3 d'entitats Les entitats, en Doctrine s\u00f3n objectes PHP que es poden identificar mitjan\u00e7ant un identificador \u00fanic o clau prim\u00e0ria. Aquestes classes no necessiten estendre cap classe base abstracta o interf\u00edcie. Una entitat cont\u00e9 propietats de persit\u00e8ncia. Una propietat de persist\u00e8ncia \u00e9s una inst\u00e0ncia de l'entitat que es desa i es recupera de la base de dades mitjan\u00e7ant les capacitats de mapeig de dades de Doctrine. En resum, podr\u00edem dir que les entitats s\u00f3n les classes que van a compondre el model de dades de la nostra aplicaci\u00f3. Per exemple, per a la nostra aplicaci\u00f3 de pel\u00b7licules, necessitarem una entitat/classe anomenada Movie que emmagatzeme les dades concretes de cada pel\u00edcula: classDiagram class Movie{ -init id -title string -overview text -poster string -releaseDate date -voters int = 0 -rating float = 0.0 } Per a crear una entitat, emprem el seg\u00fcent comando des del terminal (dins de la carpeta principal del nostre projecte Symfony): php bin/console make:entity S'iniciar\u00e0 un assistent que ens anir\u00e0 demanant informaci\u00f3 per a construir l'entitat: Nom de la classe o entitat. Propietats o atributs de la classe, per a cadascun, demanar\u00e0 el nom (si directament premem Intro deixar\u00e0 de demanar-nos m\u00e9s dades), el tipus de dada, la longitud o grand\u00e0ria del camp, si admet nuls... Per exemple, per al cas de la nostra classe Movie , el proc\u00e9s quedaria aix\u00ed: php bin/console make:entity Class name of the entity to create or update (e.g. FiercePuppy): > Movie created: src/Entity/Movie.php created: src/Repository/MovieRepository.php Entity generated! Now let's add some fields! You can always add more fields later manually or by re-running this command. New property name (press <return> to stop adding fields): > title Field type (enter ? to see all types) [string]: > string Field length [255]: > 100 Can this field be null in the database (nullable) (yes/no) [no]: > no updated: src/Entity/Movie.php Add another property? Enter the property name (or press <return> to stop adding fields): > tagline Field type (enter ? to see all types) [string]: > string Field length [255]: > 255 Can this field be null in the database (nullable) (yes/no) [no]: > yes updated: src/Entity/Movie.php Add another property? Enter the property name (or press <return> to stop adding fields): > poster Field type (enter ? to see all types) [string]: > string Field length [255]: > 100 Can this field be null in the database (nullable) (yes/no) [no]: > no updated: src/Entity/Movie.php Add another property? Enter the property name (or press <return> to stop adding fields): > releaseDate Field type (enter ? to see all types) [string]: > date Can this field be null in the database (nullable) (yes/no) [no]: > no updated: src/Entity/Movie.php Add another property? Enter the property name (or press <return> to stop adding fields): > overview Field type (enter ? to see all types) [string]: > text Can this field be null in the database (nullable) (yes/no) [no]: > no updated: src/Entity/Movie.php Add another property? Enter the property name (or press <return> to stop adding fields): > Success! Next: When you're ready, create a migration with php bin/console make:migration Com a resultat, es generar\u00e0 una classe Movie dins de la carpeta src/Entity . El codi queda com segueix: /** * @ORM\\Entity(repositoryClass=MovieRepository::class) */ class Movie { /** * @ORM\\Id * @ORM\\GeneratedValue * @ORM\\Column(type=\"integer\") */ private $id ; /** * @ORM\\Column(type=\"string\", length=100) */ private $title ; /** * @ORM\\Column(type=\"string\", length=255, nullable=true) */ private $tagline ; /** * @ORM\\Column(type=\"string\", length=100) */ private $poster ; /** * @ORM\\Column(type=\"text\") */ private $overview ; /** * @ORM\\Column(type=\"date\") */ private $releaseDate ; public function getId () : ? int { return $this -> id ; } public function getTitle () : ? string { return $this -> title ; } public function setTitle ( string $title ) : self { $this -> title = $title ; return $this ; } public function getTagline () : ? string { return $this -> tagline ; } public function setTagline ( ? string $tagline ) : self { $this -> tagline = $tagline ; return $this ; } public function getPoster () : ? string { return $this -> poster ; } public function setPoster ( string $poster ) : self { $this -> poster = $poster ; return $this ; } public function getOverview () : ? string { return $this -> overview ; } public function setOverview ( string $overview ) : self { $this -> overview = $overview ; return $this ; } public function getReleaseDate () : ? \\DateTimeInterface { return $this -> releaseDate ; } public function setReleaseDate ( \\DateTimeInterface $releaseDate ) : self { $this -> releaseDate = $releaseDate ; return $this ; } } Com podem observar, el camp id que us\u00e0vem en la nostra base de dades de prova (el servei creat a tal efecte) l'hem reempla\u00e7at per un camp enter que es genera autom\u00e0ticament com a clau principal de la classe. Per tant, nom\u00e9s hem hagut d'especificar el t\u00edtol, l'esl\u00f2gan, la sinopsi, la data d'estrena i el p\u00f2ster. Quant als tipus de dades que podem especificar, si premem ? i Intro quan especifique el tipus de dada, veurem un llistat complet dels tipus disponibles (tamb\u00e9 ho podeu consultar ac\u00ed). L'habitual ser\u00e0 treballar amb cadenes de text d'una longitud determinada ( string ), textos il\u00b7limitats ( text ), enters ( integer ), booleans ( boolean ), reals ( float ), dates ( timestamp o datetime , depenent del que vulguem emmagatzemar)... Repositori associat a l'entitat En crear l'entitat mitjan\u00e7at l'ordre make:entity \u00e9s crea tamb\u00e9 un repositori associat, que es vincula mitjan\u00e7ant el par\u00e0metre repositoryClass de la anotaci\u00f3 @ORM\\Entity . /** * @ ORM\\Entity ( repositoryClass = MovieRepository :: class ) * / Generaci\u00f3 de l'esquema Una vegada hem definit l'entitat, podem generar la corresponent taula en la base de dades. Per a a\u00e7\u00f2, escrivim aquest comando: php bin/console make:migration El que fa aquest comando \u00e9s aplicar els canvis entre el nostre model d'entitats i l'esquema de la base de dades, i generar un arxiu PHP que s'encarregar\u00e0 de bolcar aqueixos canvis a la base de dades. Per consola se'ns informar\u00e0 d'on est\u00e0 aquest arxiu perqu\u00e8 ho comprovem (estar\u00e0 en la carpeta src/Migrations ), i si tot \u00e9s correcte, executant aquest altre comando es reflectiran els canvis en la base de dades: php bin/console doctrine:migration:migrate Com podem comprovar, cada atribut de la nostra entitat Movie es correspon amb un camp del mateix nom en la taula movie . Conv\u00e9 esmentar tamb\u00e9 que aquest \u00faltim comando executar\u00e0 tots els arxius de migraci\u00f3 que encara no s'hagen migrat efectivament a la base de dades, per la qual cosa si hi ha algun que no vulguem migrar (perqu\u00e8 s'haja generat equivocadament, per exemple), haurem d'eliminar-la abans. Editar entitats Qu\u00e8 passa si, despr\u00e9s de crear una entitat, volem modificar la seua estructura? Podem editar la classe de l'entitat manualment per a afegir, modificar o esborrar camps, per\u00f2 tamb\u00e9 podem tornar a executar el comando make:entity , indicar el mateix nom de classe que volem modificar, i especificar els nous camps que vulguem afegir (en el cas que el que vulguem siga afegir camps). Despr\u00e9s de definir els canvis en la(s) entitat(s) desitjada(es), haurem de generar una nova migraci\u00f3 amb els comandos vistos en el subapartat anterior. Establir altres claus prim\u00e0ries Per defecte, hem vist que Doctrine agrega un camp id a les entitats, que \u00e9s autonum\u00e9ric i actua com a clau prim\u00e0ria. En el cas que no vulguem que siga aix\u00ed, i preferim triar un altre camp no autonum\u00e8ric com a clau prim\u00e0ria, hem de seguir aquests passos: Eliminar l'atribut id i el seu getter corresponent de l'entitat. Afegir la seg\u00fcent anotaci\u00f3 a l'atribut que h\u00e0gem triat com a clau prim\u00e0ria: /** * @ORM\\Id() * ... */ private $fieldName En el cas que siga una clau prim\u00e0ria composta per m\u00e9s d'un camp, haurem d'afegir aquesta anotaci\u00f3 en cada camp que forme part de la clau prim\u00e0ria. Operacions contra la base de dades Ara que ja hem vist com definir entitats simples, vegem com fer operacions amb elles, tals com a insercions, esborrats, modificacions i consultes. Per a realitzar aquestes operacions, ens valdrem d'un objecte molt important en Doctrine, el seu entity manager , a trav\u00e9s del que farem les insercions, esborrats, etc. Tamb\u00e9 utilitzarem el repositori de l'entitat corresponent, per a realitzar les cerques. Inserir objectes Si volem afegir objectes nous a la nostra base de dades, n'hi ha prou que creem un objecte de l'entitat corresponent en el m\u00e8tode oport\u00fa, i cridem al m\u00e8tode persist i flush de l' entity manager de Doctrine. Per exemple, per a provar, crearem un controlador en la nostra classe MovieController associat a una ruta /movies/create , que de moment ser\u00e0 de proves fins que fem un formulari d'inserci\u00f3. Dins d'aquest m\u00e8tode, crearem un objecte Movie amb dades prefixades, obtenim l' entity manager de Doctrine i persistim l'objecte: /** * @Route(\"/movies/create\", name=\"movies_create\") */ public function create () { $entityManager = $this -> getDoctrine () -> getManager (); $movie = new Movie (); $movie -> setTitle ( \"Ava\" ); $movie -> setOverview ( \"A black ops assassin is forced to fight for her own survival after a job goes dangerously wrong.\" ); $movie -> setReleaseDate ( new DateTime ( \"2020-09-25\" )); $movie -> setPoster ( \"noposter.jpg\" ); ... $entityManager -> persist ( $movie ); $entityManager -> flush (); return new Response ( \"The movie with id \" . $movie -> getId () . \" has been inserted successfully!\" ); } Si accedim des del navegador a movies-symfony/movies/create podrem veure el resultat en la taula movie de la nostra base de dades: \u00c9s important recalcar que la cridada persist per si sola no actualitza la base de dades, sin\u00f3 que indica que es vol persistir l'objecte indicat. \u00c9s la crida a flush la que fa efectiva aqueixa persist\u00e8ncia. Detectant errors en la inserci\u00f3 Si ocorre algun error en la inserci\u00f3 (per exemple, perqu\u00e8 algun camp \u00e9s nul i no puga ser-ho, o perqu\u00e8 es duplica la clau prim\u00e0ria), es provocar\u00e0 una excepci\u00f3 en cridar al m\u00e8tode flush . Podem tractar aquest error simplement capturant l'excepci\u00f3 i generant la resposta apropiada: $entityManager -> persist ( $object ); try { $entityManager -> flush (); return new Response ( \"Object inserted\" ); } catch ( Exception $e ) { return new Response ( \"Error inserting objects\" ); } Obtenir objectes A l'hora d'obtenir objectes d'una taula, existeixen diferents m\u00e8todes que podem emprar. Per exemple: El m\u00e8tode find localitza l'objecte per la clau prim\u00e0ria (normalment l' id ) que se li passa com a par\u00e0metre. Aix\u00ed cercar\u00edem la pel\u00b7l\u00edcula amb id 1: $movie = $repositori->find(1) ; El m\u00e8tode findOneBy localitza un objecte que complisca els criteris de cerca passats com a par\u00e0metre. Aix\u00ed cercar\u00edem la pel\u00b7l\u00edcula el t\u00edtol del qual siga \"Ava\": $movie = $repositori -> findOneBy ([ \"title\" => \"Ava\" ]); En el cas de voler definir m\u00e9s criteris de cerca, es passarien un darrere l'altre en l'array, separats per comes. El m\u00e8tode findBy localitza tots els objectes que complisquen els criteris de cerca passats com a par\u00e0metre. Aquesta instrucci\u00f3 \u00e9s com l'anterior, per\u00f2 retorna un array de pel\u00b7l\u00edcules amb tots els resultats coincidents (en el cas que hi haja un sol resultat, retorna un array d'un element): $movies = $repositori -> findBy ([ \"title\" => \"Ava\" ]); El m\u00e8tode findAll (sense par\u00e0metres), obt\u00e9 tots els objectes de la col\u00b7lecci\u00f3. $movies = $repositori -> findAll (); Tots aquests m\u00e8todes s'obtenen a partir d'un repositori de la classe, que ve a ser alguna cosa aix\u00ed com un assistent que ens ajuda a obtenir objectes que pertanguen a aqueixa classe. Vegem un exemple amb la nostra classe MovieController , modificarem el nostre m\u00e8tode show perqu\u00e8, en lloc de cercar en la base de dades de prova que hem vingut emprant en sessions anteriors, cerque per id en la base de dades real. Per a a\u00e7\u00f2, obtenim el repositori de la nostra classe Movie i cerquem ( find ) la pel\u00b7l\u00edcua amb l'identificador que hem rebut com a par\u00e0metre: /** * @Route(\"/movies/{id}\", name=\"movies_show\", requirements={\"id\"=\"\\d+\"}) */ public function show ( int $id ) { $movieRepository = $this -> getDoctrine () -> getRepository ( Movie :: class ); $movie = $movieRepository -> find ( $id ); if ( $movie ) { return $this -> render ( 'movies_show.html.twig' , [ \"movie\" => $movie ] ); } else return $this -> render ( 'movies_show.html.twig' , [ 'movie' => null ] ); } Consultes m\u00e9s avan\u00e7ades Amb els m\u00e8todes de consulta anteriors podem realitzar consultes que es limiten a comprovar si un o diversos camps d'un objecte s\u00f3n iguals a uns criteris de cerca determinats. Per\u00f2, com podr\u00edem, per exemple, cercar les pel\u00b7l\u00edcules el t\u00edtol dels quals continga un cert text, o les pel\u00b7licules estrenades en un per\u00edode determinat? Per a aquest tipus de consultes, necessitem ampliar el repositori de la nostra entitat. Per exemple, per a la nostra entitat Movie , imaginem que volem cercar les pel\u00b7l\u00edcules el t\u00edtol dels quals coincideix en un cert text. Per a aconseguir a\u00e7\u00f2, necessitem editar el repositori de l'entitat, que est\u00e0 en src/Repository/MovieRepository.php . Aquest arxiu cont\u00e9 comentats un parell de m\u00e8todes de prova que podr\u00edem definir per a ampliar les capacitats de l'entitat. En el nostre cas, afegirem un m\u00e8tode que s'encarregar\u00e0 d'obtenir les pel\u00b7l\u00edcules el t\u00edtol o la sinopsi dels quals continga un text determinat que li passem com a par\u00e0metre: /** * @return Movie[] Returns an array of Movie objects */ public function filterByText ( string $text ) : array { $qb = $this -> createQueryBuilder ( 'm' ) -> orWhere ( 'm.title LIKE :value' ) -> orWhere ( 'm.overview LIKE :value' ); $qb -> setParameter ( 'value' , \"%\" . $text . \"%\" ); $qb -> orderBy ( 'm.title' , 'ASC' ); $query = $qb -> getQuery (); return $query -> getResult (); } Emprem el query builder de Doctrine per a construir la consulta amb aqueixa sintaxi espec\u00edfica. En primer lloc, definim un element que hem cridat m (de Movie ) que usarem per a referenciar les propietats de les pel\u00b7l\u00edcules, per exemple, en la cl\u00e0usula where . El que ve a fer aquest codi \u00e9s cercar aquelles pel\u00b7l\u00edcules m el t\u00edtol de les quals coincideixca amb el par\u00e0metre text , i a continuaci\u00f3 espec\u00edfica que aquest par\u00e0metre text \u00e9s igual al par\u00e0metre que rebem en el m\u00e8tode, tancat entre s\u00edmbols '%', per a indicar que \u00e9s igual el que hi haja davant o darrere del text. Ara, ja podr\u00edem utilitzar aquest m\u00e8tode des d'on ho necessitem. Per exemple, podem modificar el m\u00e8tode filter de MovieController perqu\u00e8 cerque pel\u00b7l\u00edcules per t\u00edtol emprant aquest nou m\u00e8tode: /** * @Route(\"/movies/{text}\", name=\"movies_filter\") */ public function filter ( string $text ) { $movieRepository = $this -> getDoctrine () -> getRepository ( Movie :: class ); $movies = $movieRepository -> findByTitle ( $text ); return $this -> render ( 'movies_filter.html.twig' , array ( 'movies' => $movies )); } Si, per exemple, volgu\u00e9rem cercar per una propietat num\u00e8rica (per exemple, persones l'edat de les quals siga major que una donada), usar\u00edem una sintaxi com aquesta (tamb\u00e9 molt similar a SQL): $qb = $this -> createQueryBuilder ( 'p' ) -> andWhere ( 'p.edat > :edat' ) -> setParameter ( 'edat' , $edat ) -> getQuery (); Alternativament, tamb\u00e9 podem emprar un llenguatge anomenat DQL ( Doctrine Query Language ) per a realitzar la consulta anterior: $entityManager = $this -> getEntityManager (); $query = $entityManager -> createQuery ( 'SELECT m FROM App\\Movie m WHERE m.title LIKE :text' ) -> setParameter ( 'text' , '%' . $text . '%' ); return $query -> execute (); I, com a tercera via, tamb\u00e9 podem emprar SQL est\u00e0ndard, per\u00f2 en aquest cas el que obtindr\u00edem ja no seria un array d'objectes, sin\u00f3 un array de registres, com si empr\u00e0rem la llibreria PDO de PHP per a accedir a la base de dades. Ac\u00ed teniu enlla\u00e7os per a consultar informaci\u00f3 addicional tant de Query Builder com del llenguatge DQL . Actualitzar i esborrar objectes Actualitzar objectes Per a actualitzar un objecte en una base de dades, hem de seguir tres passos: Obtenir l'objecte de la base de dades (t\u00edpicament fent un find per la seua clau prim\u00e0ria) Modificar les dades necess\u00e0ries amb els respectius setters de l'objecte Fer un flush per a actualitzar els canvis en la base de dades. Si, per exemple, volgu\u00e9rem actualitzar les dades de la pel\u00b7l\u00edcula amb id = 1, far\u00edem a\u00e7\u00f2: $entityManager = $this -> getDoctrine () -> getManager (); $repository = $this -> getDoctrine () -> getRepository ( Movie :: class ); $movie = $repository -> find ( 1 ); if ( $movie ) { $movie -> setTitle ( \"Updated movie\" ); $entityManager -> flush (); } Esborrar objectes L'esborrat d'objectes \u00e9s similar a l'actualitzaci\u00f3: hem d'obtenir l'objecte tamb\u00e9, per\u00f2 despr\u00e9s cridem al m\u00e8tode remove per a esborrar-lo, i finalment a flush . Aix\u00ed esborrar\u00edem la pel\u00b7l\u00edcula amb id 1 $entityManager = $this -> getDoctrine () -> getManager (); $repository = $this -> getDoctrine () -> getRepository ( Movie :: class ); $movie = $repository -> find ( 1 ); if ( $movie ) { $entityManager -> remove ( $movie ); $entityManager -> flush (); } Novament, tant en l'actualitzaci\u00f3 com en l'esborrat, el m\u00e8tode flush pot provocar una excepci\u00f3 si l'operaci\u00f3 no ha pogut dur-se a terme. Hem de tenir-ho en compte per a capturar-la i generar la resposta oportuna. Relacions entre entitats Fins ara les operacions que hem fet s'han centrat en una \u00fanica taula o entitat (l'entitat/taula de pel\u00b7l\u00edcules en l'exemple de les anotacions). Vegem ara com podem treballar amb m\u00e9s d'una taula/entitat que estiguen relacionades entre s\u00ed. Existeixen dos tipus principals de relacions entre entitats: Molts a un: en aquest tipus s'englobarien les relacions \"un a molts\", \"molts a un\" i \"un a un\", ja que en qualsevol dels tres casos, la relaci\u00f3 es reflecteix afegint una clau ajeno en una de les dues entitats que referencie a l'altra. Molts a molts: en aquest tipus de relacions, es necessita d'una taula addicional per a reflectir la relaci\u00f3 entre les entitats. Anem a definir una relaci\u00f3 molts a un en la nostra base de dades de pel\u00b7l\u00edcules. Per a a\u00e7\u00f2, anem a crear primer una entitat anomenada Genre , que nom\u00e9s continga un id autoincremental i un nom ( string ): php bin/console make:entity Class name of the entity to create or update ( i.g. AgreeableGnome ) : >Genre created: src/Entity/Genre.php created: src/Repository/GenreRepository.php New property name ( press to stop adding fields ) : >name Field type ( enter? to see all types ) [ string ] : >string Field length [ 255 ] : >255 Can this field be null in the database ( nullable ) ( yes/no ) [ no ] : >no updated: src/Entity/Genre.php Add another property? Enter the property name ( or press to stop adding fields ) : Success! Despr\u00e9s de generar la nova entitat, crearem la corresponent taula en la base de dades a trav\u00e9s de la migraci\u00f3. php bin/console make:migration php bin/console doctrine:migration:migrate Ara, anem a fer que les pel\u00b7l\u00edcules tinguen un g\u00e8nere associat. Per a a\u00e7\u00f2, editem l'entitat Movie i li afegim un nou camp, anomenat g\u00e8nere, que ser\u00e0 de tipus relaci\u00f3 molts a un (una pel\u00b7l\u00edcula pertanyer\u00e0 a una categoria, i un g\u00e8nere pot tenir moltes pel\u00b7l\u00edcules). php bin/console make:entity Class name of the entity to create or update (i.g. DeliciousPuppy): > Movie Your entity already exists! So let's add some new fields! New property name (press to stop adding fields): >genre Field type (enter? to see all types) \\[string\\]: >relation What class should this entity be related to?: >Genre What type of relationship is this? --------------------------------------------------------------------- Type Description --------------------------------------------------------------------- ManyToOne Each Movie relates to (has) one Genre. Each Genre can relate/has to (have) many Movie objects OneToMany Each Movie can relate to (have) many Genre objects. Each Genre relates to (has) one Movie ManyToMany Each Movie can relate to (have) many Genre objects. Each Prov\u00edncia can also relate to (have) many Contacte objects OneToOne Each Movie relates to (has) exactly one Genre. Each Genre also relates to (has) exactly one Movie. Relation type? [ManyToOne, OneToMany, ManyToMany, OneToOne]: > ManyToOne Is the Movie.genre property allowed to be null (nullable)? (yes/no) [yes]: > no Do you want to add a new property to Genre so that you can access/update Movie objects from it - i.g. $genre-\\>getMovies()? (yes/no) [yes]: >no updated: src/Entity/Movie.php Add another property? Enter the property name (or press to stop adding fields): Success! Com pot veure's, a l'hora de triar el tipus de camp, indiquem que \u00e9s una relaci\u00f3 ( relation ), en aquest cas ens demana indicar a quina entitat est\u00e0 vinculada (Genre, en aquest cas), i quin tipus de relaci\u00f3 \u00e9s ( ManyToOne en el nostre cas, per\u00f2 podem triar qualsevol de les altres tres opcions OneToMany , OneToOne o ManyToMany ). Tamb\u00e9 podem comprovar que l'assistent ens pregunta si volem afegir un camp en l'altra entitat perqu\u00e8 la relaci\u00f3 siga bidireccional (\u00e9s a dir, perqu\u00e8 des d'un objecte de qualsevol de les dues entitats puguem consultar el/els objecte(s) associat(s) de l'altra. En aquest cas indiquem que no per a simplificar el codi. Important Cal tenir en compte que si la taula movie ja t\u00e9 pel\u00b7l\u00edcules, i a l'hora de crear la clau aliena decidim que no puga tenir valors nuls tindrem problemes, ja que fallar\u00e0 la integritat referencial. Hi ha diverses solucions com crear un g\u00e8nere amb id 0 o indicar que la clau aliena genre s\u00ed pot contenir valors nuls. I despr\u00e9s, canviar-ho. Despr\u00e9s d'aquests canvis, realitzem de nou la migraci\u00f3, i ja tindrem el nou camp afegit en la nostra entitat Movie i a la taula movie de la base de dades: /** * @ORM\\ManyToOne(targetEntity=\"App\\Entity\\Genre\") * @ORM\\JoinColumn(nullable=false) */ Treballar amb entitats relacionades Ara que ja sabem relacionar entitats entre s\u00ed. Com podem inserir una entitat que dep\u00e8n d'una altra, o accedir a les dades d'una entitat des de l'altra? Inserci\u00f3 d'entitats relacionades Per exemple, si volgu\u00e9rem inserir un pel\u00b7l\u00edcula assignant-li un g\u00e8nere: Si el g\u00e8nere no existeix, crearem un objecte de tipus Genre, i despr\u00e9s un altre de tipus Movie, establint com a genre l'objecte Genre recentment creat: $entityManager = $this -> getDoctrine () -> getManager (); $genre = new Genre (); $genre -> setName ( \"Western\" ); $movie = new Movie (); $movie -> setTitle ( \"A test title\" ); $movie -> setTagline ( \"A test tagline\" ); $movie -> setReleaseDate ( new \\DateTime ()); $movie -> setPoster -> setPoster ( \"noposter.jpg\" ); $movie -> setOverview -> setOverview ( \"A test overview\" ); $movie -> setGenre ( $genre ); $entityManager -> persist ( $genre ); $entityManager -> persist ( $movie ); $entityManager -> flush (); Si el g\u00e8nere s\u00ed existeix, el recuperem de la base de dades (amb algun m\u00e8tode find o similar) i despr\u00e9s crearem crear l'objecte Movie i li assignem aqueix objecte Genre: $entityManager = $this -> getDoctrine () -> getManager (); $repositori = $this -> getDoctrine () -> getRepository ( Genre :: class ); $genre = $repository -> find ( 1 ); $movie = new Movie (); $movie -> setTitle ( \"A test title\" ); $movie -> setTagline ( \"A test tagline\" ); $movie -> setReleaseDate ( new \\DateTime ()); $movie -> setPoster -> setPoster ( \"noposter.jpg\" ); $movie -> setOverview -> setOverview ( \"A test overview\" ); $movie -> setGenre ( $genre ); $entityManager -> persist ( $genre ); $entityManager -> persist ( $movie ); $entityManager -> flush (); Obtenir entitats relacionades En el cas que recuperem una entitat que est\u00e0 relacionada amb una altra, l'acc\u00e9s a aqueixa altra entitat \u00e9s immediat des de la primera. Per exemple, si volgu\u00e9rem saber el nom del g\u00e8nere d'una pel\u00b7l\u00edcula amb id 1, far\u00edem alguna cosa aix\u00ed: $repositori = $this -> getDoctrine () -> getRepository ( Movie :: class ); $movie = $repositori -> find ( 1 ); $genreName = $movie -> getGenre () -> getName (); En qualsevol cas, \u00e9s important recalcar que Doctrine no recupera les dades de l'entitat relacionada (la prov\u00edncia, en aquest cas), fins que es demanen efectivament (\u00e9s a dir, fins que no preguntem pel nom del genre, Doctrine no tracta d'obtenir l'objecte Genre complet). Aquesta estrat\u00e8gia de recuperaci\u00f3 d'entitats relacionades s'anomena lazy loading o c\u00e0rrega diferida.","title":"Gesti\u00f3 del model de dades amb Doctrine"},{"location":"08-symfony/05-doctrine/#gestio-del-model-de-dades-amb-doctrine","text":"","title":"Gesti\u00f3 del model de dades amb Doctrine"},{"location":"08-symfony/05-doctrine/#introduccio-a-doctrine","text":"","title":"Introducci\u00f3 a Doctrine"},{"location":"08-symfony/05-doctrine/#que-es-un-orm","text":"Un ORM ( Object Relational Mapping ) \u00e9s un framework encarregat de tractar amb una base de dades relacional (connectar amb ella, realitzar operacions de consulta, inserci\u00f3, etc.), de manera que, de cara a l'aplicaci\u00f3, es converteixen a objectes tots els elements que s'extraguen de la base de dades i viceversa (els objectes de l'aplicaci\u00f3 es transformen en registres de la base de dades, arribat el cas). D'aquesta forma, l'ORM s'encarregar\u00e0 de realitzar aquesta conversi\u00f3 o mapatge autom\u00e0ticament per nosaltres. Definint una s\u00e8rie de regles, indicarem quines taules de la base de dades relacional es corresponen amb quines classes del nostre model, i quins camps de cada taula es corresponen amb quins atributs de cada classe. A partir d'ac\u00ed, l'ORM s'encarregar\u00e0 d'extraure la informaci\u00f3 de la base de dades i crear els objectes corresponents, o de convertir els objectes amb els seus atributs en registres de la base de dades, amb les seues corresponents columnes. El principal avantatge d'utilitzar un ORM com Doctrine \u00e9s a\u00efllar l'aplicaci\u00f3 del gestor de base de dades que h\u00e0gem triat (MySQL, Oracle, PostgreSQL...) ja que a nivell d'aplicaci\u00f3 treballarem amb objectes , i ser\u00e0 Doctrine qui s'encarregue de connectar amb la base de dades triada, i transformar els objectes per a adaptar-los a la mateixa.","title":"Qu\u00e8 \u00e9s un ORM?"},{"location":"08-symfony/05-doctrine/#configuracio-basica-de-doctrine","text":"Per a poder utilitzar Doctrine, hem d'indicar com connectar al servidor de base de dades que anem a utilitzar. Aquests par\u00e0metres de connexi\u00f3 es poden configurar en l'arxiu .env del nostre projecte. Aquest \u00e9s un arxiu on es defineixen certes variables pr\u00f2pies d'entorn, que despr\u00e9s es processen i es converteixen en variables reals. En el nostre cas, definim una variable anomenada DATABASE_URL , amb una URL on s'especifiquen tant l'adre\u00e7a i port de connexi\u00f3 a la base de dades, com el login i password necessaris per a accedir, aix\u00ed com el nom de la base de dades a la qual connectar. Per exemple, per a una base de dades MySQL, l'estructura general ser\u00e0 aquesta: DATABASE_URL = mysql://db_user:db_password@127.0.0.1:3306/db_name Tenint en compte l'usuari i contrasenya per defecte de phpMyAdmin per a XAMPP (usuari root i contrasenya buida), aquest podria ser un valor v\u00e0lid per a connectar a la nostra base de dades de contactes: DATABASE_URL = mysql://root@127.0.0.1:3306/movies-symfony Aquest arxiu .env pot utilitzar-se tant en desenvolupament com en producci\u00f3, encara que en aquest \u00faltim cas es recomana definir variables d'entorn reals en el sistema, per a evitar p\u00e8rdua de rendiment en haver de traduir aquest arxiu per a cada petici\u00f3. Important Symfony suporta la noci\u00f3 d'entorns. Per defecte, t\u00e9 suport integrat per tres entorns, per\u00f2 pots afegir-ne tants com vulgues: dev , prod i test . Tots els entorns comparteixen el mateix codi, per\u00f2 treballen amb configuracions diferents. Per exemple, totes les eines de depuraci\u00f3 estan habilitades en l'entorn dev . En l'entorn prod l'aplicaci\u00f3 est\u00e0 optimitzada per al rendiment. El canvi d'un entorn a un altre pot realitzar-se modificant la variable d'entorn APP_ENV . Un arxiu .env amb uns valors acuradament escollits es genera autom\u00e0ticament quan es crea el projecte: ###> symfony/framework-bundle ### APP_ENV=dev APP_SECRET=f307a57c2c035484820f08a0494076dc ###< symfony/framework-bundle ### ###> symfony/mailer ### # MAILER_DSN=smtp://localhost ###< symfony/mailer ### DATABASE_URL=\"mysql://root@127.0.0.1:3306/symfony-movies\" Qualsevol paquet pot afegir m\u00e9s variables d'entorn a aquesta imatge gr\u00e0cies a la seva recepta utilitzada per Symfony Flex. El fitxer .env s'envia al repositori i descriu els valors per defecte de l'entorn de producci\u00f3. Podeu substituir aquests valors creant un fitxer .env.local . Aquest fitxer no ha de ser enviat a l'repositori i \u00e9s per aix\u00f2 que el fitxer .gitignore ja l'est\u00e0 ignorant. Mai guardis dades secretes o confidencials en aquests arxius. Per a obtenir m\u00e9s informaci\u00f3 consulta Configuring Symfony En el cas que la base de dades encara no existisca, Doctrine pot crear-la per nosaltres. Per a a\u00e7\u00f2, n'hi ha prou amb escriure el seg\u00fcent comando: php bin/console doctrine:database:create Created database 'movies-symfony' for connection named default Autom\u00e0ticament, es prendr\u00e0 el nom de la base de dades de la variable d'entorn anterior, es connectar\u00e0 al servidor i es crear\u00e0 (sense taules, de moment).","title":"Configuraci\u00f3 b\u00e0sica de Doctrine"},{"location":"08-symfony/05-doctrine/#creacio-dentitats","text":"Les entitats, en Doctrine s\u00f3n objectes PHP que es poden identificar mitjan\u00e7ant un identificador \u00fanic o clau prim\u00e0ria. Aquestes classes no necessiten estendre cap classe base abstracta o interf\u00edcie. Una entitat cont\u00e9 propietats de persit\u00e8ncia. Una propietat de persist\u00e8ncia \u00e9s una inst\u00e0ncia de l'entitat que es desa i es recupera de la base de dades mitjan\u00e7ant les capacitats de mapeig de dades de Doctrine. En resum, podr\u00edem dir que les entitats s\u00f3n les classes que van a compondre el model de dades de la nostra aplicaci\u00f3. Per exemple, per a la nostra aplicaci\u00f3 de pel\u00b7licules, necessitarem una entitat/classe anomenada Movie que emmagatzeme les dades concretes de cada pel\u00edcula: classDiagram class Movie{ -init id -title string -overview text -poster string -releaseDate date -voters int = 0 -rating float = 0.0 } Per a crear una entitat, emprem el seg\u00fcent comando des del terminal (dins de la carpeta principal del nostre projecte Symfony): php bin/console make:entity S'iniciar\u00e0 un assistent que ens anir\u00e0 demanant informaci\u00f3 per a construir l'entitat: Nom de la classe o entitat. Propietats o atributs de la classe, per a cadascun, demanar\u00e0 el nom (si directament premem Intro deixar\u00e0 de demanar-nos m\u00e9s dades), el tipus de dada, la longitud o grand\u00e0ria del camp, si admet nuls... Per exemple, per al cas de la nostra classe Movie , el proc\u00e9s quedaria aix\u00ed: php bin/console make:entity Class name of the entity to create or update (e.g. FiercePuppy): > Movie created: src/Entity/Movie.php created: src/Repository/MovieRepository.php Entity generated! Now let's add some fields! You can always add more fields later manually or by re-running this command. New property name (press <return> to stop adding fields): > title Field type (enter ? to see all types) [string]: > string Field length [255]: > 100 Can this field be null in the database (nullable) (yes/no) [no]: > no updated: src/Entity/Movie.php Add another property? Enter the property name (or press <return> to stop adding fields): > tagline Field type (enter ? to see all types) [string]: > string Field length [255]: > 255 Can this field be null in the database (nullable) (yes/no) [no]: > yes updated: src/Entity/Movie.php Add another property? Enter the property name (or press <return> to stop adding fields): > poster Field type (enter ? to see all types) [string]: > string Field length [255]: > 100 Can this field be null in the database (nullable) (yes/no) [no]: > no updated: src/Entity/Movie.php Add another property? Enter the property name (or press <return> to stop adding fields): > releaseDate Field type (enter ? to see all types) [string]: > date Can this field be null in the database (nullable) (yes/no) [no]: > no updated: src/Entity/Movie.php Add another property? Enter the property name (or press <return> to stop adding fields): > overview Field type (enter ? to see all types) [string]: > text Can this field be null in the database (nullable) (yes/no) [no]: > no updated: src/Entity/Movie.php Add another property? Enter the property name (or press <return> to stop adding fields): > Success! Next: When you're ready, create a migration with php bin/console make:migration Com a resultat, es generar\u00e0 una classe Movie dins de la carpeta src/Entity . El codi queda com segueix: /** * @ORM\\Entity(repositoryClass=MovieRepository::class) */ class Movie { /** * @ORM\\Id * @ORM\\GeneratedValue * @ORM\\Column(type=\"integer\") */ private $id ; /** * @ORM\\Column(type=\"string\", length=100) */ private $title ; /** * @ORM\\Column(type=\"string\", length=255, nullable=true) */ private $tagline ; /** * @ORM\\Column(type=\"string\", length=100) */ private $poster ; /** * @ORM\\Column(type=\"text\") */ private $overview ; /** * @ORM\\Column(type=\"date\") */ private $releaseDate ; public function getId () : ? int { return $this -> id ; } public function getTitle () : ? string { return $this -> title ; } public function setTitle ( string $title ) : self { $this -> title = $title ; return $this ; } public function getTagline () : ? string { return $this -> tagline ; } public function setTagline ( ? string $tagline ) : self { $this -> tagline = $tagline ; return $this ; } public function getPoster () : ? string { return $this -> poster ; } public function setPoster ( string $poster ) : self { $this -> poster = $poster ; return $this ; } public function getOverview () : ? string { return $this -> overview ; } public function setOverview ( string $overview ) : self { $this -> overview = $overview ; return $this ; } public function getReleaseDate () : ? \\DateTimeInterface { return $this -> releaseDate ; } public function setReleaseDate ( \\DateTimeInterface $releaseDate ) : self { $this -> releaseDate = $releaseDate ; return $this ; } } Com podem observar, el camp id que us\u00e0vem en la nostra base de dades de prova (el servei creat a tal efecte) l'hem reempla\u00e7at per un camp enter que es genera autom\u00e0ticament com a clau principal de la classe. Per tant, nom\u00e9s hem hagut d'especificar el t\u00edtol, l'esl\u00f2gan, la sinopsi, la data d'estrena i el p\u00f2ster. Quant als tipus de dades que podem especificar, si premem ? i Intro quan especifique el tipus de dada, veurem un llistat complet dels tipus disponibles (tamb\u00e9 ho podeu consultar ac\u00ed). L'habitual ser\u00e0 treballar amb cadenes de text d'una longitud determinada ( string ), textos il\u00b7limitats ( text ), enters ( integer ), booleans ( boolean ), reals ( float ), dates ( timestamp o datetime , depenent del que vulguem emmagatzemar)... Repositori associat a l'entitat En crear l'entitat mitjan\u00e7at l'ordre make:entity \u00e9s crea tamb\u00e9 un repositori associat, que es vincula mitjan\u00e7ant el par\u00e0metre repositoryClass de la anotaci\u00f3 @ORM\\Entity . /** * @ ORM\\Entity ( repositoryClass = MovieRepository :: class ) * /","title":"Creaci\u00f3 d'entitats"},{"location":"08-symfony/05-doctrine/#generacio-de-lesquema","text":"Una vegada hem definit l'entitat, podem generar la corresponent taula en la base de dades. Per a a\u00e7\u00f2, escrivim aquest comando: php bin/console make:migration El que fa aquest comando \u00e9s aplicar els canvis entre el nostre model d'entitats i l'esquema de la base de dades, i generar un arxiu PHP que s'encarregar\u00e0 de bolcar aqueixos canvis a la base de dades. Per consola se'ns informar\u00e0 d'on est\u00e0 aquest arxiu perqu\u00e8 ho comprovem (estar\u00e0 en la carpeta src/Migrations ), i si tot \u00e9s correcte, executant aquest altre comando es reflectiran els canvis en la base de dades: php bin/console doctrine:migration:migrate Com podem comprovar, cada atribut de la nostra entitat Movie es correspon amb un camp del mateix nom en la taula movie . Conv\u00e9 esmentar tamb\u00e9 que aquest \u00faltim comando executar\u00e0 tots els arxius de migraci\u00f3 que encara no s'hagen migrat efectivament a la base de dades, per la qual cosa si hi ha algun que no vulguem migrar (perqu\u00e8 s'haja generat equivocadament, per exemple), haurem d'eliminar-la abans.","title":"Generaci\u00f3 de l'esquema"},{"location":"08-symfony/05-doctrine/#editar-entitats","text":"Qu\u00e8 passa si, despr\u00e9s de crear una entitat, volem modificar la seua estructura? Podem editar la classe de l'entitat manualment per a afegir, modificar o esborrar camps, per\u00f2 tamb\u00e9 podem tornar a executar el comando make:entity , indicar el mateix nom de classe que volem modificar, i especificar els nous camps que vulguem afegir (en el cas que el que vulguem siga afegir camps). Despr\u00e9s de definir els canvis en la(s) entitat(s) desitjada(es), haurem de generar una nova migraci\u00f3 amb els comandos vistos en el subapartat anterior.","title":"Editar entitats"},{"location":"08-symfony/05-doctrine/#establir-altres-claus-primaries","text":"Per defecte, hem vist que Doctrine agrega un camp id a les entitats, que \u00e9s autonum\u00e9ric i actua com a clau prim\u00e0ria. En el cas que no vulguem que siga aix\u00ed, i preferim triar un altre camp no autonum\u00e8ric com a clau prim\u00e0ria, hem de seguir aquests passos: Eliminar l'atribut id i el seu getter corresponent de l'entitat. Afegir la seg\u00fcent anotaci\u00f3 a l'atribut que h\u00e0gem triat com a clau prim\u00e0ria: /** * @ORM\\Id() * ... */ private $fieldName En el cas que siga una clau prim\u00e0ria composta per m\u00e9s d'un camp, haurem d'afegir aquesta anotaci\u00f3 en cada camp que forme part de la clau prim\u00e0ria.","title":"Establir altres claus prim\u00e0ries"},{"location":"08-symfony/05-doctrine/#operacions-contra-la-base-de-dades","text":"Ara que ja hem vist com definir entitats simples, vegem com fer operacions amb elles, tals com a insercions, esborrats, modificacions i consultes. Per a realitzar aquestes operacions, ens valdrem d'un objecte molt important en Doctrine, el seu entity manager , a trav\u00e9s del que farem les insercions, esborrats, etc. Tamb\u00e9 utilitzarem el repositori de l'entitat corresponent, per a realitzar les cerques.","title":"Operacions contra la base de dades"},{"location":"08-symfony/05-doctrine/#inserir-objectes","text":"Si volem afegir objectes nous a la nostra base de dades, n'hi ha prou que creem un objecte de l'entitat corresponent en el m\u00e8tode oport\u00fa, i cridem al m\u00e8tode persist i flush de l' entity manager de Doctrine. Per exemple, per a provar, crearem un controlador en la nostra classe MovieController associat a una ruta /movies/create , que de moment ser\u00e0 de proves fins que fem un formulari d'inserci\u00f3. Dins d'aquest m\u00e8tode, crearem un objecte Movie amb dades prefixades, obtenim l' entity manager de Doctrine i persistim l'objecte: /** * @Route(\"/movies/create\", name=\"movies_create\") */ public function create () { $entityManager = $this -> getDoctrine () -> getManager (); $movie = new Movie (); $movie -> setTitle ( \"Ava\" ); $movie -> setOverview ( \"A black ops assassin is forced to fight for her own survival after a job goes dangerously wrong.\" ); $movie -> setReleaseDate ( new DateTime ( \"2020-09-25\" )); $movie -> setPoster ( \"noposter.jpg\" ); ... $entityManager -> persist ( $movie ); $entityManager -> flush (); return new Response ( \"The movie with id \" . $movie -> getId () . \" has been inserted successfully!\" ); } Si accedim des del navegador a movies-symfony/movies/create podrem veure el resultat en la taula movie de la nostra base de dades: \u00c9s important recalcar que la cridada persist per si sola no actualitza la base de dades, sin\u00f3 que indica que es vol persistir l'objecte indicat. \u00c9s la crida a flush la que fa efectiva aqueixa persist\u00e8ncia.","title":"Inserir objectes"},{"location":"08-symfony/05-doctrine/#obtenir-objectes","text":"A l'hora d'obtenir objectes d'una taula, existeixen diferents m\u00e8todes que podem emprar. Per exemple: El m\u00e8tode find localitza l'objecte per la clau prim\u00e0ria (normalment l' id ) que se li passa com a par\u00e0metre. Aix\u00ed cercar\u00edem la pel\u00b7l\u00edcula amb id 1: $movie = $repositori->find(1) ; El m\u00e8tode findOneBy localitza un objecte que complisca els criteris de cerca passats com a par\u00e0metre. Aix\u00ed cercar\u00edem la pel\u00b7l\u00edcula el t\u00edtol del qual siga \"Ava\": $movie = $repositori -> findOneBy ([ \"title\" => \"Ava\" ]); En el cas de voler definir m\u00e9s criteris de cerca, es passarien un darrere l'altre en l'array, separats per comes. El m\u00e8tode findBy localitza tots els objectes que complisquen els criteris de cerca passats com a par\u00e0metre. Aquesta instrucci\u00f3 \u00e9s com l'anterior, per\u00f2 retorna un array de pel\u00b7l\u00edcules amb tots els resultats coincidents (en el cas que hi haja un sol resultat, retorna un array d'un element): $movies = $repositori -> findBy ([ \"title\" => \"Ava\" ]); El m\u00e8tode findAll (sense par\u00e0metres), obt\u00e9 tots els objectes de la col\u00b7lecci\u00f3. $movies = $repositori -> findAll (); Tots aquests m\u00e8todes s'obtenen a partir d'un repositori de la classe, que ve a ser alguna cosa aix\u00ed com un assistent que ens ajuda a obtenir objectes que pertanguen a aqueixa classe. Vegem un exemple amb la nostra classe MovieController , modificarem el nostre m\u00e8tode show perqu\u00e8, en lloc de cercar en la base de dades de prova que hem vingut emprant en sessions anteriors, cerque per id en la base de dades real. Per a a\u00e7\u00f2, obtenim el repositori de la nostra classe Movie i cerquem ( find ) la pel\u00b7l\u00edcua amb l'identificador que hem rebut com a par\u00e0metre: /** * @Route(\"/movies/{id}\", name=\"movies_show\", requirements={\"id\"=\"\\d+\"}) */ public function show ( int $id ) { $movieRepository = $this -> getDoctrine () -> getRepository ( Movie :: class ); $movie = $movieRepository -> find ( $id ); if ( $movie ) { return $this -> render ( 'movies_show.html.twig' , [ \"movie\" => $movie ] ); } else return $this -> render ( 'movies_show.html.twig' , [ 'movie' => null ] ); }","title":"Obtenir objectes"},{"location":"08-symfony/05-doctrine/#consultes-mes-avancades","text":"Amb els m\u00e8todes de consulta anteriors podem realitzar consultes que es limiten a comprovar si un o diversos camps d'un objecte s\u00f3n iguals a uns criteris de cerca determinats. Per\u00f2, com podr\u00edem, per exemple, cercar les pel\u00b7l\u00edcules el t\u00edtol dels quals continga un cert text, o les pel\u00b7licules estrenades en un per\u00edode determinat? Per a aquest tipus de consultes, necessitem ampliar el repositori de la nostra entitat. Per exemple, per a la nostra entitat Movie , imaginem que volem cercar les pel\u00b7l\u00edcules el t\u00edtol dels quals coincideix en un cert text. Per a aconseguir a\u00e7\u00f2, necessitem editar el repositori de l'entitat, que est\u00e0 en src/Repository/MovieRepository.php . Aquest arxiu cont\u00e9 comentats un parell de m\u00e8todes de prova que podr\u00edem definir per a ampliar les capacitats de l'entitat. En el nostre cas, afegirem un m\u00e8tode que s'encarregar\u00e0 d'obtenir les pel\u00b7l\u00edcules el t\u00edtol o la sinopsi dels quals continga un text determinat que li passem com a par\u00e0metre: /** * @return Movie[] Returns an array of Movie objects */ public function filterByText ( string $text ) : array { $qb = $this -> createQueryBuilder ( 'm' ) -> orWhere ( 'm.title LIKE :value' ) -> orWhere ( 'm.overview LIKE :value' ); $qb -> setParameter ( 'value' , \"%\" . $text . \"%\" ); $qb -> orderBy ( 'm.title' , 'ASC' ); $query = $qb -> getQuery (); return $query -> getResult (); } Emprem el query builder de Doctrine per a construir la consulta amb aqueixa sintaxi espec\u00edfica. En primer lloc, definim un element que hem cridat m (de Movie ) que usarem per a referenciar les propietats de les pel\u00b7l\u00edcules, per exemple, en la cl\u00e0usula where . El que ve a fer aquest codi \u00e9s cercar aquelles pel\u00b7l\u00edcules m el t\u00edtol de les quals coincideixca amb el par\u00e0metre text , i a continuaci\u00f3 espec\u00edfica que aquest par\u00e0metre text \u00e9s igual al par\u00e0metre que rebem en el m\u00e8tode, tancat entre s\u00edmbols '%', per a indicar que \u00e9s igual el que hi haja davant o darrere del text. Ara, ja podr\u00edem utilitzar aquest m\u00e8tode des d'on ho necessitem. Per exemple, podem modificar el m\u00e8tode filter de MovieController perqu\u00e8 cerque pel\u00b7l\u00edcules per t\u00edtol emprant aquest nou m\u00e8tode: /** * @Route(\"/movies/{text}\", name=\"movies_filter\") */ public function filter ( string $text ) { $movieRepository = $this -> getDoctrine () -> getRepository ( Movie :: class ); $movies = $movieRepository -> findByTitle ( $text ); return $this -> render ( 'movies_filter.html.twig' , array ( 'movies' => $movies )); } Si, per exemple, volgu\u00e9rem cercar per una propietat num\u00e8rica (per exemple, persones l'edat de les quals siga major que una donada), usar\u00edem una sintaxi com aquesta (tamb\u00e9 molt similar a SQL): $qb = $this -> createQueryBuilder ( 'p' ) -> andWhere ( 'p.edat > :edat' ) -> setParameter ( 'edat' , $edat ) -> getQuery (); Alternativament, tamb\u00e9 podem emprar un llenguatge anomenat DQL ( Doctrine Query Language ) per a realitzar la consulta anterior: $entityManager = $this -> getEntityManager (); $query = $entityManager -> createQuery ( 'SELECT m FROM App\\Movie m WHERE m.title LIKE :text' ) -> setParameter ( 'text' , '%' . $text . '%' ); return $query -> execute (); I, com a tercera via, tamb\u00e9 podem emprar SQL est\u00e0ndard, per\u00f2 en aquest cas el que obtindr\u00edem ja no seria un array d'objectes, sin\u00f3 un array de registres, com si empr\u00e0rem la llibreria PDO de PHP per a accedir a la base de dades. Ac\u00ed teniu enlla\u00e7os per a consultar informaci\u00f3 addicional tant de Query Builder com del llenguatge DQL .","title":"Consultes m\u00e9s avan\u00e7ades"},{"location":"08-symfony/05-doctrine/#actualitzar-i-esborrar-objectes","text":"","title":"Actualitzar i esborrar objectes"},{"location":"08-symfony/05-doctrine/#relacions-entre-entitats","text":"Fins ara les operacions que hem fet s'han centrat en una \u00fanica taula o entitat (l'entitat/taula de pel\u00b7l\u00edcules en l'exemple de les anotacions). Vegem ara com podem treballar amb m\u00e9s d'una taula/entitat que estiguen relacionades entre s\u00ed. Existeixen dos tipus principals de relacions entre entitats: Molts a un: en aquest tipus s'englobarien les relacions \"un a molts\", \"molts a un\" i \"un a un\", ja que en qualsevol dels tres casos, la relaci\u00f3 es reflecteix afegint una clau ajeno en una de les dues entitats que referencie a l'altra. Molts a molts: en aquest tipus de relacions, es necessita d'una taula addicional per a reflectir la relaci\u00f3 entre les entitats. Anem a definir una relaci\u00f3 molts a un en la nostra base de dades de pel\u00b7l\u00edcules. Per a a\u00e7\u00f2, anem a crear primer una entitat anomenada Genre , que nom\u00e9s continga un id autoincremental i un nom ( string ): php bin/console make:entity Class name of the entity to create or update ( i.g. AgreeableGnome ) : >Genre created: src/Entity/Genre.php created: src/Repository/GenreRepository.php New property name ( press to stop adding fields ) : >name Field type ( enter? to see all types ) [ string ] : >string Field length [ 255 ] : >255 Can this field be null in the database ( nullable ) ( yes/no ) [ no ] : >no updated: src/Entity/Genre.php Add another property? Enter the property name ( or press to stop adding fields ) : Success! Despr\u00e9s de generar la nova entitat, crearem la corresponent taula en la base de dades a trav\u00e9s de la migraci\u00f3. php bin/console make:migration php bin/console doctrine:migration:migrate Ara, anem a fer que les pel\u00b7l\u00edcules tinguen un g\u00e8nere associat. Per a a\u00e7\u00f2, editem l'entitat Movie i li afegim un nou camp, anomenat g\u00e8nere, que ser\u00e0 de tipus relaci\u00f3 molts a un (una pel\u00b7l\u00edcula pertanyer\u00e0 a una categoria, i un g\u00e8nere pot tenir moltes pel\u00b7l\u00edcules). php bin/console make:entity Class name of the entity to create or update (i.g. DeliciousPuppy): > Movie Your entity already exists! So let's add some new fields! New property name (press to stop adding fields): >genre Field type (enter? to see all types) \\[string\\]: >relation What class should this entity be related to?: >Genre What type of relationship is this? --------------------------------------------------------------------- Type Description --------------------------------------------------------------------- ManyToOne Each Movie relates to (has) one Genre. Each Genre can relate/has to (have) many Movie objects OneToMany Each Movie can relate to (have) many Genre objects. Each Genre relates to (has) one Movie ManyToMany Each Movie can relate to (have) many Genre objects. Each Prov\u00edncia can also relate to (have) many Contacte objects OneToOne Each Movie relates to (has) exactly one Genre. Each Genre also relates to (has) exactly one Movie. Relation type? [ManyToOne, OneToMany, ManyToMany, OneToOne]: > ManyToOne Is the Movie.genre property allowed to be null (nullable)? (yes/no) [yes]: > no Do you want to add a new property to Genre so that you can access/update Movie objects from it - i.g. $genre-\\>getMovies()? (yes/no) [yes]: >no updated: src/Entity/Movie.php Add another property? Enter the property name (or press to stop adding fields): Success! Com pot veure's, a l'hora de triar el tipus de camp, indiquem que \u00e9s una relaci\u00f3 ( relation ), en aquest cas ens demana indicar a quina entitat est\u00e0 vinculada (Genre, en aquest cas), i quin tipus de relaci\u00f3 \u00e9s ( ManyToOne en el nostre cas, per\u00f2 podem triar qualsevol de les altres tres opcions OneToMany , OneToOne o ManyToMany ). Tamb\u00e9 podem comprovar que l'assistent ens pregunta si volem afegir un camp en l'altra entitat perqu\u00e8 la relaci\u00f3 siga bidireccional (\u00e9s a dir, perqu\u00e8 des d'un objecte de qualsevol de les dues entitats puguem consultar el/els objecte(s) associat(s) de l'altra. En aquest cas indiquem que no per a simplificar el codi. Important Cal tenir en compte que si la taula movie ja t\u00e9 pel\u00b7l\u00edcules, i a l'hora de crear la clau aliena decidim que no puga tenir valors nuls tindrem problemes, ja que fallar\u00e0 la integritat referencial. Hi ha diverses solucions com crear un g\u00e8nere amb id 0 o indicar que la clau aliena genre s\u00ed pot contenir valors nuls. I despr\u00e9s, canviar-ho. Despr\u00e9s d'aquests canvis, realitzem de nou la migraci\u00f3, i ja tindrem el nou camp afegit en la nostra entitat Movie i a la taula movie de la base de dades: /** * @ORM\\ManyToOne(targetEntity=\"App\\Entity\\Genre\") * @ORM\\JoinColumn(nullable=false) */","title":"Relacions entre entitats"},{"location":"08-symfony/05-doctrine/#treballar-amb-entitats-relacionades","text":"Ara que ja sabem relacionar entitats entre s\u00ed. Com podem inserir una entitat que dep\u00e8n d'una altra, o accedir a les dades d'una entitat des de l'altra?","title":"Treballar amb entitats relacionades"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/","text":"Generaci\u00f3 de formularis i validaci\u00f3 de dades Generaci\u00f3 de formularis Fins a aquesta sessi\u00f3 hem apr\u00e8s alguns conceptes \u00fatils de Symfony i alguns dels seus bundles m\u00e9s destacats, com per exemple la generaci\u00f3 de vistes amb el motor de plantilles Twig, el desenvolupament de serveis, o la comunicaci\u00f3 amb la base de dades a trav\u00e9s de l'ORM Doctrine. Hem fet alguns controladors d'exemple per a cercar dades, o per a inserir. Per\u00f2, en aquest \u00faltim cas, al no disposar encara d'un mecanisme perqu\u00e8 s'envien dades d'inserci\u00f3 des del client, hem optat ara com ara per inserir unes dades prefixades, \u00e9s a dir, una pel\u00b7l\u00edcula amb unes dades ja predefinides en el codi. En aquesta sessi\u00f3 veurem de quina forma es poden definir formularis en Symfony associats a una determinada entitat, perqu\u00e8 el que s'envie en el formulari s'associe a un objecte d'aquesta entitat, i perqu\u00e8 puguem pre\u00adcarregar el formulari amb les dades d'una entitat ja existent, amb la finalitat de poder-los modificar. Creaci\u00f3 del formulari en el controlador Els formularis poden crear-se f\u00e0cilment des de qualsevol controlador. N'hi ha prou que creem o obtinguem l'objecte associat al formulari (per exemple, una pel\u00b7l\u00edcula), i carreguem un formulari amb ell. En la nostra aplicaci\u00f3 de pel\u00b7l\u00edcules, anem a crear un nou controlador que responga a la URI /movies/create , i que cree una pel\u00b7l\u00edcula buida i la mostre al formulari. namespace App\\Controller ; ... use Symfony\\Component\\Form\\Extension\\Core\\Type\\TextType ; use Symfony\\Component\\Form\\Extension\\Core\\Type\\SubmitType ; class MovieController extends AbstractController { ... /** * @Route(\"/movies/create\", name=\"movies_create\") */ public function create () { $movie = new Movie (); $form = $this -> createFormBuilder ( $movie ) -> add ( 'title' , TextType :: class ) -> add ( 'overview' , TextareaType :: class ) -> add ( 'releaseDate' , DateType :: class ) -> add ( 'poster' , TextType :: class ) -> add ( 'create' , SubmitType :: class , array ( 'label' => 'Create' )) -> getForm (); return $this -> render ( 'create.html.twig' , array ( 'form' => $form -> createView ())); } ... Com podem veure, a trav\u00e9s del form builder de Symfony es crea el formulari. Despr\u00e9s, afegim tants camps com a atributs tinga l'entitat (normalment), associant cada atribut amb el seu camp pel nom. En cada camp especifiquem tamb\u00e9 de quin tipus \u00e9s. En el nostre cas, hem definit tres quadres de text ( TextType ) per al t\u00edtol, l'eslogan i el poster, un camp de data ( DateType ) per a la data de l'estrena, un camp ( TextareaType ) per a la sinopsi i un bot\u00f3 de submit ( SubmitType ) per a poder enviar el formulari. Podeu consultar en Form Types Reference un llistat m\u00e9s detallat dels tipus de camps que tenim disponibles. Alguns que poden resultar-nos interessants s\u00f3n: TextType (quadres de text d'una sola l\u00ednia, com l'exemple anterior) TextareaType (quadres de text de diverses l\u00ednies) EmailType (quadres de text de tipus email) IntegerType (quadres de text per a nombres enters) NumberType (quadres de text per a nombres en general) PasswordType (quadres emmascarats per a passwords) EntityType (desplegables per a triar valors vinculats a una altra entitat) DateType (per a dates) CheckboxType (per a checkboxes) RadioType (per a botons de radi o radi buttons) HiddenType (per a controls ocults) ... etc. Etiquetes personalitzades Com podem veure per al cas del bot\u00f3 de submit, podem especificar un tercer par\u00e0metre en el m\u00e8tode add que \u00e9s un array de propietats del control en q\u00fcesti\u00f3. Una d'elles \u00e9s la propietat label , que ens permet especificar quin text tindr\u00e0 associat el control. Per defecte, s'associa el nom de l'atribut corresponent en l'entitat, per\u00f2 podem canviar-ho per un text personalitzat. Per a l'i\u00admail, per exemple, podr\u00edem posar: -> add ( 'email' , EmailType :: class , array ( 'label' => 'Correu electr\u00f2nic' )) Millorant el nostre formulari Aprofitant la varietat de tipus de camps que ofereix Symfony, anem a millorar una mica el nostre formulari: Per al g\u00e8nere que afeg\u00edrem en la sessi\u00f3 de Doctrine, podem emprar un EntityType que prenga les seues dades de l'entitat Genre . Amb a\u00e7\u00f2, el formulari quedaria aix\u00ed: -> add ( 'genre' , EntityType :: class , [ 'class' => Genre :: class , 'choice_label' => 'name' ]) ... Renderitzant el formulari El codi del controlador anterior acaba renderitzant una vista cridada create.html.twig que, ara com ara, no existeix. En aquesta vista haurem de renderizar el formulari. Podria quedar-se aix\u00ed: {% extends 'base.html.twig' %} {% block title %} Movies {% endblock %} {% block body %} < h1 > New Movie </ h1 > {{ form_start ( form ) }} {{ form_widget ( form ) }} {{ form_end ( form ) }} {% endblock %} Les tres l\u00ednies sota l'encap\u00e7alat h1 s\u00f3n les responsables de la renderizaci\u00f3n del formulari, a partir del par\u00e0metre form que li passem des del controlador. Si ara accedim a http://movies-symfony/movies/create podrem veure el formulari: Emplenant els camps del formulari Tornem al nostre nou controlador. Si constru\u00efm un objecte farcit amb dades, veurem cada dada en el seu camp associat: public function create () { $movie = new Movie (); $movie -> setTitle ( \" Groundhog Day\" ); $movie -> setTagline ( \"He\u2019s having the worst day of his life \u2026 over, and over \u2026\" ); $movie -> setReleaseDate ( new \\DateTime ( \"1993-05-07\" )); $form = $this -> createFormBuilder ( $movie ) ... Enviament de formularis Parlem ara sobre com enviar el formulari. Per defecte, si no s'indica gens, el formulari s'envia per POST a la mateixa URI que el genera (en el nostre cas, a movies/create . De fet, si intentem enviar el formulari en aquest moment, amb les dades que siguen, es tornar\u00e0 a carregar la vista del formulari, per\u00f2 no haurem inserit res. Per a gestionar l'enviament d'aquestes dades, cal fer algunes modificacions sobre el nostre controlador: En primer lloc, el controlador rebr\u00e0 un objecte Request , que contindr\u00e0 les dades del formulari enviat (en el cas que s'haja enviat) En segon lloc, dins del codi del controlador, hem de processar aqueixes dades (si n'hi ha), validar-les (a\u00e7\u00f2 ho veurem a continuaci\u00f3) i si s\u00f3n v\u00e0lides, realitzar la corresponent inserci\u00f3 o modificaci\u00f3. Finalment, podem redirigir a una altra ruta en cas d'\u00e8xit, o tornar a renderizar el formulari en cas d'error, o en cas que no s'haja enviat (per exemple, quan carreguem el formulari per a emplenar-ho). Unint aquestes premisses, el nostre controlador quedaria aix\u00ed: # src/Controller/MovieController.php /** * @Route(\"/movies/create\", name=\"movies_create\") */ public function create ( Request $request ) { ... $form -> handleRequest ( $request ); if ( $form -> isSubmitted () && $form -> isValid ()) { $movie = $form -> getData (); $entityManager = $this -> getDoctrine () -> getManager (); $entityManager -> persist ( $movie ); $entityManager -> flush (); return $this -> redirectToRoute ( 'home' ); } return $this -> render ( 'movies_create.html.twig' , array ( 'form' => $form -> createView ())); ... } Si provem ara a carregar el formulari i realitzar una inserci\u00f3, ens enviar\u00e0 a la p\u00e0gina d'inici, i podrem veure la nova pel\u00b7l\u00edcula en la taula corresponent de la base de dades. Modificaci\u00f3 de dades El que hem fet en l'exemple anterior \u00e9s una inserci\u00f3 d'un nova pel\u00b7l\u00edcula, per\u00f2... com seria fer una modificaci\u00f3 de pel\u00b7l\u00edcula existent?. El funcionament seria molt similar, per\u00f2 amb un petit canvi: la ruta del controlador rebr\u00e0 com a par\u00e0metre l'identificador de la pel\u00b7l\u00edcula a modificar, i a partir d'ac\u00ed, cercar\u00edem la pel\u00b7l\u00edcula i el carregar\u00edem en el formulari, incloent el seu id en un camp ocult. D'aquesta forma, en fer persist es modificaria la pel\u00b7l\u00edcula existent. Podem provar-ho amb aquest controlador: /** * @Route(\"/movies/{id}/edit\", name=\"movies_edit\") */ public function edit ( int $id , Request $request ) { $movieRepository = $this -> getDoctrine () -> getRepository ( Movie :: class ); $movie = $movieRepository -> find ( $id ); $form = $this -> createFormBuilder ( $movie ) -> add ( 'id' , HiddenType :: class ) -> add ( 'title' , TextType :: class ) -> add ( 'tagline' , TextType :: class ) -> add ( 'overview' , TextareaType :: class ) -> add ( 'releaseDate' , DateType :: class , [ 'widget' => \"single_text\" ] ) -> add ( 'poster' , TextType :: class ) -> add ( 'genre' , EntityType :: class , [ 'class' => Genre :: class , 'choice_label' => 'name' , 'placeholder' => 'Select a genre' , ] ) -> add ( 'create' , SubmitType :: class , array ( 'label' => 'Create' )) -> getForm (); $form -> handleRequest ( $request ); ... } Veiem que el codi \u00e9s molt similar al de la inserci\u00f3, excepte pel par\u00e0metre id que rep el controlador amb el codi de la pel\u00b7l\u00edcula a editar, la cerca inicial d'aquesta pel\u00edcula en la base de dades, i el camp ocult id en el formulari. Recorda que Symfony ens proporciona la possibilitat de fer autowiring de les entitats, afegint-les com a par\u00e0metres en lloc del seu id . Recorda afegir el corresponent use al principi perqu\u00e8 reconega la classe HiddenType . Ara, si accedim a movies-symfony/movies/1/edit , per exemple (suposant que tinguem una pel\u00b7l\u00edcula amb id = 1 en la base de dades), es carregar\u00e0 el formulari amb les seues dades, i en enviar-lo, es modificaran els camps que h\u00e0gem canviat, i es carregar\u00e0 la p\u00e0gina d'inici. Validaci\u00f3 de formularis Ara que ja sabem crear, enviar i gestionar formularis, vegem un \u00faltim pas, que seria la validaci\u00f3 de dades d'aquests formularis pr\u00e8via al seu enviament. En el cas de Symfony, la validaci\u00f3 no s'aplica al formulari, sin\u00f3 a l'entitat subjacent (\u00e9s a dir, a la classe Movie , en el nostre cas). Per tant, la validaci\u00f3 l'obtindrem afegint una s\u00e8rie de restriccions o comprovacions a aquestes classes. Per exemple, per a indicar que el t\u00edtol, el poster i la data de l'estrena no poden estar buits, afegim aquestes anotacions en els atributs de la classe Movie : #src/Entity/Movie.php ... use Symfony\\Component\\Validator\\Constraints as Assert ; /** * @ORM\\Entity(repositoryClass=MovieRepository::class) */ class Movie { ... /** * @ORM\\Column(type=\"string\", length=100) * @Assert\\NotNull */ private $title ; /** * @ORM\\Column(type=\"string\", length=255, nullable=true) */ private $tagline ; /** * @ORM\\Column(type=\"string\", length=100) * @Assert\\NotNull */ private $poster ; /** * @ORM\\Column(type=\"date\") * @Assert\\NotNull */ private $releaseDate ; ... Perqu\u00e8 aquestes assercions s'activen caldr\u00e0 desactivar la validaci\u00f3 en el client indicant que el formulari ha de tindre l'atribut novalidate : # templates/movies-create.html.twig {{ form_start ( form , { attr : { 'novalidate' : 'novalidate' }} ) }} Aquestes funcions de validaci\u00f3 admeten una s\u00e8rie de par\u00e0metres \u00fatils. Un dels m\u00e9s \u00fatils \u00e9s `message`, que s'empra per a determinar el missatge d'error que mostrar a l'usuari en cas que la dada no siga v\u00e0lida. Per exemple, per al t\u00edtol, podem especificar aquest missatge d'error: ```php /** * @ORM\\Column(type=\"string\", length=100) * @Assert\\NotNull(message=\"The title is mandatory\") */ private $title; I es disparar\u00e0 quan no inserim t\u00edtol i intentem enviar el formulari: Podeu trobar m\u00e9s informaci\u00f3 sobre quines assercions es poden usar per a validar dades en la documentaci\u00f3 oficial de Symfony: Validation . Altres consideracions finals Per a finalitzar aquesta sessi\u00f3, vegem algunes q\u00fcestions que hem deixat en el tinter i no deixen de ser igualment importants. Creaci\u00f3 de classes per a formularis Fins ara, hem definit els formularis directament en els controladors afectats. Aix\u00ed, en el cas de l'aplicaci\u00f3 de pel\u00b7l\u00edcules, hem definit un formulari per a la ruta /movies/create i un altre (el mateix, pr\u00e0cticament) per a la ruta /movies/{id}/edit . El recomanat, segons la documentaci\u00f3 de Symfony, \u00e9s no situar els formularis directament en els controladors, sin\u00f3 crear-los en una classe a banda. D'aquesta forma, podr\u00edem reutilitzar els formularis en diversos controladors, i no repetir codi innecess\u00e0riament. Vegem com quedaria aquesta classe per al formulari d'inserci\u00f3 i edici\u00f3 de pel\u00b7l\u00edcules. Com sempre, podem crear el formulari on vulguem, per\u00f2 per unificar criteris, i seguint els exemples de la documentaci\u00f3 de Symfony, crearem una carpeta Form en la nostra carpeta src , i posarem dins els formularis. En el nostre cas, crearem una classe anomenada MovieType , que heretar\u00e0 d'una classe base gen\u00e8rica de Symfony cridada AbstractType . Dins, definim el m\u00e8tode buildForm que s'encarregar\u00e0 de crear el formulari, com f\u00e8iem abans en el m\u00e8tode nou o a editar: # src/Form/MovieType.php public function buildForm ( FormBuilderInterface $builder , array $options ) { $builder -> add ( 'title' , TextType :: class ) -> add ( 'tagline' , TextType :: class ) -> add ( 'overview' , TextareaType :: class ) -> add ( 'releaseDate' , DateType :: class , [ 'widget' => \"single_text\" ] ) -> add ( 'poster' , TextType :: class ) -> add ( 'genre' , EntityType :: class , [ 'class' => Genre :: class , 'choice_label' => 'name' , 'placeholder' => 'Select a genre' , ] ) -> add ( 'create' , SubmitType :: class , array ( 'label' => 'Create' )); } A m\u00e9s caldr\u00e0 crear el m\u00e8tode configureOptions : public function configureOptions ( OptionsResolver $resolver ) { $resolver -> setDefaults ([ 'data_class' => Movie :: class , ]); } Ara, nom\u00e9s ens queda reempla\u00e7ar el codi de crear el formulari en nou o editar per l'\u00fas d'aquesta nova classe: # src/Controller/MovieController.php public function create ( Request $request ) { $movie = new Movie (); $form = $this -> createForm ( MovieType :: class , $movie ); $form -> handleRequest ( $request ); if ( $form -> isSubmitted () && $form -> isValid ()) { $movie = $form -> getData (); $entityManager = $this -> getDoctrine () -> getManager (); $entityManager -> persist ( $movie ); $entityManager -> flush (); return $this -> redirectToRoute ( 'home' ); } return $this -> render ( 'movies_create.html.twig' , array ( 'form' => $form -> createView ())); } Afegint estil als formularis Els formularis que hem generat en aquesta sessi\u00f3 s\u00f3n molt funcionals, per\u00f2 poc vistosos, ja que manquen d'estils CSS propis. Si volgu\u00e9rem afegir CSS a aquests formularis, tenim diverses opcions. Una opci\u00f3 rudiment\u00e0ria consisteix a afegir classes (atribut class ) als controls del formulari per a donar estils personalitzats. Despr\u00e9s, en el nostre CSS caldria indicar l'estil per a la classe en q\u00fcesti\u00f3. A m\u00e9s, Symfony ofereix diversos temes ( themes ) que podem aplicar als formularis (i webs en general) per a donar-los una aparen\u00e7a general basada en algun framework conegut, com Bootstrap o Foundation. Si volem optar per l'aparen\u00e7a de Bootstrap, hem de fer el seg\u00fcent: Incloure la fulla d'estils CSS i l'arxiu Javascript de Bootstrap en les nostres plantilles. Una pr\u00e0ctica habitual \u00e9s fer-ho en la plantilla base.html.twig perqu\u00e8 qualsevol que herete d'ella adopte aquest estil. Per a a\u00e7\u00f2, en la secci\u00f3 stylesheets hem d'afegir el codi HTML que hi ha en la documentaci\u00f3 oficial de Bootstrap per a incloure la seua fulla d'estil, i en la secci\u00f3 javascripts els enlla\u00e7os a les diferents llibreries que s'indiquen en la documentaci\u00f3 de Bootstrap tamb\u00e9. Editar l'arxiu de configuraci\u00f3 config/packages/twig.yaml i indicar que els formularis usaran el tema de Bootstrap (en aquest cas, Bootstrap 5): twig : ... form_themes : [ 'bootstrap_5_layout.html.twig' ] Amb aquests dos canvis, l'aparen\u00e7a del nostre formulari de pel\u00b7l\u00edcules queda aix\u00ed: Hi ha altres alternatives, com per exemple no indicar aquesta configuraci\u00f3 general en config/packages/twig.yaml i indicar formulari per formulari el tema que es vol usar. {% form_theme form 'bootstrap_5_layout.html.twig' %} {{ form_start ( form ) }} ... Existeixen tamb\u00e9 altres temes disponibles per a utilitzar. I tamb\u00e9 \u00e9s possible crear els teus propis. Podeu consultar m\u00e9s informaci\u00f3 en Symfony built-in form themes Afegir estils per a les validacions En el cas de les validacions de dades del formulari, tamb\u00e9 podem definir estils perqu\u00e8 els missatges que d'error que es mostren (par\u00e0metre message o similars en les anotacions de l'entitat) tinguen un estil determinat. A\u00e7\u00f2 s'aconsegueix f\u00e0cilment triant algun dels temes predefinits de Symfony. Exercicis Exercici 6.1 Movies Implementa el formulari d'inserci\u00f3 de pel\u00b7l\u00edcules seguient les indicacions Projecte personal Implementa el formular d'inserci\u00f3 de la teua entitat principal, si t\u00e9 relacions tamb\u00e9. Exercici 6.2 Movies Partint del formulari anterior, crea el controlador d'edici\u00f3 de pel\u00b7l\u00edcules. Projecte personal Crea el formulari d'edici\u00f3 de l'entitat principal del teu projecte personal. Exercici 6.3 Movies Anem a validar la classe Movie de la nostra aplicaci\u00f3 de pel\u00b7l\u00edcules. Els criteris de validaci\u00f3 seran els seg\u00fcents: Cap camp pot ser null, llevat de l'esl\u00f2gan ( tagline ). El t\u00edtol no podr\u00e0 tindre una longitud superior a 100 caracters. Projecte personal Aplica la validaci\u00f3 a l'entitat principal del teu projecte personal. Exercici 6.4 Movies Crea la classe MovieType.php en el projecte de pel\u00b7l\u00edcules, on definir\u00e0s el formulari per a inserci\u00f3 i edici\u00f3 de pel\u00b7l\u00edcules basant-te en el vist en el punt anterior. Afegir l'estil de Bootstrap 4 al formulari de pel\u00b7l\u00edcules. Projecte personal Realitza en el teu projecte personal el mateix que has implementat en Movies.","title":"Generaci\u00f3 de formularis i validaci\u00f3 de dades"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#generacio-de-formularis-i-validacio-de-dades","text":"","title":"Generaci\u00f3 de formularis i validaci\u00f3 de dades"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#generacio-de-formularis","text":"Fins a aquesta sessi\u00f3 hem apr\u00e8s alguns conceptes \u00fatils de Symfony i alguns dels seus bundles m\u00e9s destacats, com per exemple la generaci\u00f3 de vistes amb el motor de plantilles Twig, el desenvolupament de serveis, o la comunicaci\u00f3 amb la base de dades a trav\u00e9s de l'ORM Doctrine. Hem fet alguns controladors d'exemple per a cercar dades, o per a inserir. Per\u00f2, en aquest \u00faltim cas, al no disposar encara d'un mecanisme perqu\u00e8 s'envien dades d'inserci\u00f3 des del client, hem optat ara com ara per inserir unes dades prefixades, \u00e9s a dir, una pel\u00b7l\u00edcula amb unes dades ja predefinides en el codi. En aquesta sessi\u00f3 veurem de quina forma es poden definir formularis en Symfony associats a una determinada entitat, perqu\u00e8 el que s'envie en el formulari s'associe a un objecte d'aquesta entitat, i perqu\u00e8 puguem pre\u00adcarregar el formulari amb les dades d'una entitat ja existent, amb la finalitat de poder-los modificar.","title":"Generaci\u00f3 de formularis"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#creacio-del-formulari-en-el-controlador","text":"Els formularis poden crear-se f\u00e0cilment des de qualsevol controlador. N'hi ha prou que creem o obtinguem l'objecte associat al formulari (per exemple, una pel\u00b7l\u00edcula), i carreguem un formulari amb ell. En la nostra aplicaci\u00f3 de pel\u00b7l\u00edcules, anem a crear un nou controlador que responga a la URI /movies/create , i que cree una pel\u00b7l\u00edcula buida i la mostre al formulari. namespace App\\Controller ; ... use Symfony\\Component\\Form\\Extension\\Core\\Type\\TextType ; use Symfony\\Component\\Form\\Extension\\Core\\Type\\SubmitType ; class MovieController extends AbstractController { ... /** * @Route(\"/movies/create\", name=\"movies_create\") */ public function create () { $movie = new Movie (); $form = $this -> createFormBuilder ( $movie ) -> add ( 'title' , TextType :: class ) -> add ( 'overview' , TextareaType :: class ) -> add ( 'releaseDate' , DateType :: class ) -> add ( 'poster' , TextType :: class ) -> add ( 'create' , SubmitType :: class , array ( 'label' => 'Create' )) -> getForm (); return $this -> render ( 'create.html.twig' , array ( 'form' => $form -> createView ())); } ... Com podem veure, a trav\u00e9s del form builder de Symfony es crea el formulari. Despr\u00e9s, afegim tants camps com a atributs tinga l'entitat (normalment), associant cada atribut amb el seu camp pel nom. En cada camp especifiquem tamb\u00e9 de quin tipus \u00e9s. En el nostre cas, hem definit tres quadres de text ( TextType ) per al t\u00edtol, l'eslogan i el poster, un camp de data ( DateType ) per a la data de l'estrena, un camp ( TextareaType ) per a la sinopsi i un bot\u00f3 de submit ( SubmitType ) per a poder enviar el formulari. Podeu consultar en Form Types Reference un llistat m\u00e9s detallat dels tipus de camps que tenim disponibles. Alguns que poden resultar-nos interessants s\u00f3n: TextType (quadres de text d'una sola l\u00ednia, com l'exemple anterior) TextareaType (quadres de text de diverses l\u00ednies) EmailType (quadres de text de tipus email) IntegerType (quadres de text per a nombres enters) NumberType (quadres de text per a nombres en general) PasswordType (quadres emmascarats per a passwords) EntityType (desplegables per a triar valors vinculats a una altra entitat) DateType (per a dates) CheckboxType (per a checkboxes) RadioType (per a botons de radi o radi buttons) HiddenType (per a controls ocults) ... etc.","title":"Creaci\u00f3 del formulari en el controlador"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#renderitzant-el-formulari","text":"El codi del controlador anterior acaba renderitzant una vista cridada create.html.twig que, ara com ara, no existeix. En aquesta vista haurem de renderizar el formulari. Podria quedar-se aix\u00ed: {% extends 'base.html.twig' %} {% block title %} Movies {% endblock %} {% block body %} < h1 > New Movie </ h1 > {{ form_start ( form ) }} {{ form_widget ( form ) }} {{ form_end ( form ) }} {% endblock %} Les tres l\u00ednies sota l'encap\u00e7alat h1 s\u00f3n les responsables de la renderizaci\u00f3n del formulari, a partir del par\u00e0metre form que li passem des del controlador. Si ara accedim a http://movies-symfony/movies/create podrem veure el formulari:","title":"Renderitzant el formulari"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#emplenant-els-camps-del-formulari","text":"Tornem al nostre nou controlador. Si constru\u00efm un objecte farcit amb dades, veurem cada dada en el seu camp associat: public function create () { $movie = new Movie (); $movie -> setTitle ( \" Groundhog Day\" ); $movie -> setTagline ( \"He\u2019s having the worst day of his life \u2026 over, and over \u2026\" ); $movie -> setReleaseDate ( new \\DateTime ( \"1993-05-07\" )); $form = $this -> createFormBuilder ( $movie ) ...","title":"Emplenant els camps del formulari"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#enviament-de-formularis","text":"Parlem ara sobre com enviar el formulari. Per defecte, si no s'indica gens, el formulari s'envia per POST a la mateixa URI que el genera (en el nostre cas, a movies/create . De fet, si intentem enviar el formulari en aquest moment, amb les dades que siguen, es tornar\u00e0 a carregar la vista del formulari, per\u00f2 no haurem inserit res. Per a gestionar l'enviament d'aquestes dades, cal fer algunes modificacions sobre el nostre controlador: En primer lloc, el controlador rebr\u00e0 un objecte Request , que contindr\u00e0 les dades del formulari enviat (en el cas que s'haja enviat) En segon lloc, dins del codi del controlador, hem de processar aqueixes dades (si n'hi ha), validar-les (a\u00e7\u00f2 ho veurem a continuaci\u00f3) i si s\u00f3n v\u00e0lides, realitzar la corresponent inserci\u00f3 o modificaci\u00f3. Finalment, podem redirigir a una altra ruta en cas d'\u00e8xit, o tornar a renderizar el formulari en cas d'error, o en cas que no s'haja enviat (per exemple, quan carreguem el formulari per a emplenar-ho). Unint aquestes premisses, el nostre controlador quedaria aix\u00ed: # src/Controller/MovieController.php /** * @Route(\"/movies/create\", name=\"movies_create\") */ public function create ( Request $request ) { ... $form -> handleRequest ( $request ); if ( $form -> isSubmitted () && $form -> isValid ()) { $movie = $form -> getData (); $entityManager = $this -> getDoctrine () -> getManager (); $entityManager -> persist ( $movie ); $entityManager -> flush (); return $this -> redirectToRoute ( 'home' ); } return $this -> render ( 'movies_create.html.twig' , array ( 'form' => $form -> createView ())); ... } Si provem ara a carregar el formulari i realitzar una inserci\u00f3, ens enviar\u00e0 a la p\u00e0gina d'inici, i podrem veure la nova pel\u00b7l\u00edcula en la taula corresponent de la base de dades.","title":"Enviament de formularis"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#modificacio-de-dades","text":"El que hem fet en l'exemple anterior \u00e9s una inserci\u00f3 d'un nova pel\u00b7l\u00edcula, per\u00f2... com seria fer una modificaci\u00f3 de pel\u00b7l\u00edcula existent?. El funcionament seria molt similar, per\u00f2 amb un petit canvi: la ruta del controlador rebr\u00e0 com a par\u00e0metre l'identificador de la pel\u00b7l\u00edcula a modificar, i a partir d'ac\u00ed, cercar\u00edem la pel\u00b7l\u00edcula i el carregar\u00edem en el formulari, incloent el seu id en un camp ocult. D'aquesta forma, en fer persist es modificaria la pel\u00b7l\u00edcula existent. Podem provar-ho amb aquest controlador: /** * @Route(\"/movies/{id}/edit\", name=\"movies_edit\") */ public function edit ( int $id , Request $request ) { $movieRepository = $this -> getDoctrine () -> getRepository ( Movie :: class ); $movie = $movieRepository -> find ( $id ); $form = $this -> createFormBuilder ( $movie ) -> add ( 'id' , HiddenType :: class ) -> add ( 'title' , TextType :: class ) -> add ( 'tagline' , TextType :: class ) -> add ( 'overview' , TextareaType :: class ) -> add ( 'releaseDate' , DateType :: class , [ 'widget' => \"single_text\" ] ) -> add ( 'poster' , TextType :: class ) -> add ( 'genre' , EntityType :: class , [ 'class' => Genre :: class , 'choice_label' => 'name' , 'placeholder' => 'Select a genre' , ] ) -> add ( 'create' , SubmitType :: class , array ( 'label' => 'Create' )) -> getForm (); $form -> handleRequest ( $request ); ... } Veiem que el codi \u00e9s molt similar al de la inserci\u00f3, excepte pel par\u00e0metre id que rep el controlador amb el codi de la pel\u00b7l\u00edcula a editar, la cerca inicial d'aquesta pel\u00edcula en la base de dades, i el camp ocult id en el formulari. Recorda que Symfony ens proporciona la possibilitat de fer autowiring de les entitats, afegint-les com a par\u00e0metres en lloc del seu id . Recorda afegir el corresponent use al principi perqu\u00e8 reconega la classe HiddenType . Ara, si accedim a movies-symfony/movies/1/edit , per exemple (suposant que tinguem una pel\u00b7l\u00edcula amb id = 1 en la base de dades), es carregar\u00e0 el formulari amb les seues dades, i en enviar-lo, es modificaran els camps que h\u00e0gem canviat, i es carregar\u00e0 la p\u00e0gina d'inici.","title":"Modificaci\u00f3 de dades"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#validacio-de-formularis","text":"Ara que ja sabem crear, enviar i gestionar formularis, vegem un \u00faltim pas, que seria la validaci\u00f3 de dades d'aquests formularis pr\u00e8via al seu enviament. En el cas de Symfony, la validaci\u00f3 no s'aplica al formulari, sin\u00f3 a l'entitat subjacent (\u00e9s a dir, a la classe Movie , en el nostre cas). Per tant, la validaci\u00f3 l'obtindrem afegint una s\u00e8rie de restriccions o comprovacions a aquestes classes. Per exemple, per a indicar que el t\u00edtol, el poster i la data de l'estrena no poden estar buits, afegim aquestes anotacions en els atributs de la classe Movie : #src/Entity/Movie.php ... use Symfony\\Component\\Validator\\Constraints as Assert ; /** * @ORM\\Entity(repositoryClass=MovieRepository::class) */ class Movie { ... /** * @ORM\\Column(type=\"string\", length=100) * @Assert\\NotNull */ private $title ; /** * @ORM\\Column(type=\"string\", length=255, nullable=true) */ private $tagline ; /** * @ORM\\Column(type=\"string\", length=100) * @Assert\\NotNull */ private $poster ; /** * @ORM\\Column(type=\"date\") * @Assert\\NotNull */ private $releaseDate ; ... Perqu\u00e8 aquestes assercions s'activen caldr\u00e0 desactivar la validaci\u00f3 en el client indicant que el formulari ha de tindre l'atribut novalidate : # templates/movies-create.html.twig {{ form_start ( form , { attr : { 'novalidate' : 'novalidate' }} ) }} Aquestes funcions de validaci\u00f3 admeten una s\u00e8rie de par\u00e0metres \u00fatils. Un dels m\u00e9s \u00fatils \u00e9s `message`, que s'empra per a determinar el missatge d'error que mostrar a l'usuari en cas que la dada no siga v\u00e0lida. Per exemple, per al t\u00edtol, podem especificar aquest missatge d'error: ```php /** * @ORM\\Column(type=\"string\", length=100) * @Assert\\NotNull(message=\"The title is mandatory\") */ private $title; I es disparar\u00e0 quan no inserim t\u00edtol i intentem enviar el formulari: Podeu trobar m\u00e9s informaci\u00f3 sobre quines assercions es poden usar per a validar dades en la documentaci\u00f3 oficial de Symfony: Validation .","title":"Validaci\u00f3 de formularis"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#altres-consideracions-finals","text":"Per a finalitzar aquesta sessi\u00f3, vegem algunes q\u00fcestions que hem deixat en el tinter i no deixen de ser igualment importants.","title":"Altres consideracions finals"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#creacio-de-classes-per-a-formularis","text":"Fins ara, hem definit els formularis directament en els controladors afectats. Aix\u00ed, en el cas de l'aplicaci\u00f3 de pel\u00b7l\u00edcules, hem definit un formulari per a la ruta /movies/create i un altre (el mateix, pr\u00e0cticament) per a la ruta /movies/{id}/edit . El recomanat, segons la documentaci\u00f3 de Symfony, \u00e9s no situar els formularis directament en els controladors, sin\u00f3 crear-los en una classe a banda. D'aquesta forma, podr\u00edem reutilitzar els formularis en diversos controladors, i no repetir codi innecess\u00e0riament. Vegem com quedaria aquesta classe per al formulari d'inserci\u00f3 i edici\u00f3 de pel\u00b7l\u00edcules. Com sempre, podem crear el formulari on vulguem, per\u00f2 per unificar criteris, i seguint els exemples de la documentaci\u00f3 de Symfony, crearem una carpeta Form en la nostra carpeta src , i posarem dins els formularis. En el nostre cas, crearem una classe anomenada MovieType , que heretar\u00e0 d'una classe base gen\u00e8rica de Symfony cridada AbstractType . Dins, definim el m\u00e8tode buildForm que s'encarregar\u00e0 de crear el formulari, com f\u00e8iem abans en el m\u00e8tode nou o a editar: # src/Form/MovieType.php public function buildForm ( FormBuilderInterface $builder , array $options ) { $builder -> add ( 'title' , TextType :: class ) -> add ( 'tagline' , TextType :: class ) -> add ( 'overview' , TextareaType :: class ) -> add ( 'releaseDate' , DateType :: class , [ 'widget' => \"single_text\" ] ) -> add ( 'poster' , TextType :: class ) -> add ( 'genre' , EntityType :: class , [ 'class' => Genre :: class , 'choice_label' => 'name' , 'placeholder' => 'Select a genre' , ] ) -> add ( 'create' , SubmitType :: class , array ( 'label' => 'Create' )); } A m\u00e9s caldr\u00e0 crear el m\u00e8tode configureOptions : public function configureOptions ( OptionsResolver $resolver ) { $resolver -> setDefaults ([ 'data_class' => Movie :: class , ]); } Ara, nom\u00e9s ens queda reempla\u00e7ar el codi de crear el formulari en nou o editar per l'\u00fas d'aquesta nova classe: # src/Controller/MovieController.php public function create ( Request $request ) { $movie = new Movie (); $form = $this -> createForm ( MovieType :: class , $movie ); $form -> handleRequest ( $request ); if ( $form -> isSubmitted () && $form -> isValid ()) { $movie = $form -> getData (); $entityManager = $this -> getDoctrine () -> getManager (); $entityManager -> persist ( $movie ); $entityManager -> flush (); return $this -> redirectToRoute ( 'home' ); } return $this -> render ( 'movies_create.html.twig' , array ( 'form' => $form -> createView ())); }","title":"Creaci\u00f3 de classes per a formularis"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#afegint-estil-als-formularis","text":"Els formularis que hem generat en aquesta sessi\u00f3 s\u00f3n molt funcionals, per\u00f2 poc vistosos, ja que manquen d'estils CSS propis. Si volgu\u00e9rem afegir CSS a aquests formularis, tenim diverses opcions. Una opci\u00f3 rudiment\u00e0ria consisteix a afegir classes (atribut class ) als controls del formulari per a donar estils personalitzats. Despr\u00e9s, en el nostre CSS caldria indicar l'estil per a la classe en q\u00fcesti\u00f3. A m\u00e9s, Symfony ofereix diversos temes ( themes ) que podem aplicar als formularis (i webs en general) per a donar-los una aparen\u00e7a general basada en algun framework conegut, com Bootstrap o Foundation. Si volem optar per l'aparen\u00e7a de Bootstrap, hem de fer el seg\u00fcent: Incloure la fulla d'estils CSS i l'arxiu Javascript de Bootstrap en les nostres plantilles. Una pr\u00e0ctica habitual \u00e9s fer-ho en la plantilla base.html.twig perqu\u00e8 qualsevol que herete d'ella adopte aquest estil. Per a a\u00e7\u00f2, en la secci\u00f3 stylesheets hem d'afegir el codi HTML que hi ha en la documentaci\u00f3 oficial de Bootstrap per a incloure la seua fulla d'estil, i en la secci\u00f3 javascripts els enlla\u00e7os a les diferents llibreries que s'indiquen en la documentaci\u00f3 de Bootstrap tamb\u00e9. Editar l'arxiu de configuraci\u00f3 config/packages/twig.yaml i indicar que els formularis usaran el tema de Bootstrap (en aquest cas, Bootstrap 5): twig : ... form_themes : [ 'bootstrap_5_layout.html.twig' ] Amb aquests dos canvis, l'aparen\u00e7a del nostre formulari de pel\u00b7l\u00edcules queda aix\u00ed: Hi ha altres alternatives, com per exemple no indicar aquesta configuraci\u00f3 general en config/packages/twig.yaml i indicar formulari per formulari el tema que es vol usar. {% form_theme form 'bootstrap_5_layout.html.twig' %} {{ form_start ( form ) }} ... Existeixen tamb\u00e9 altres temes disponibles per a utilitzar. I tamb\u00e9 \u00e9s possible crear els teus propis. Podeu consultar m\u00e9s informaci\u00f3 en Symfony built-in form themes","title":"Afegint estil als formularis"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#afegir-estils-per-a-les-validacions","text":"En el cas de les validacions de dades del formulari, tamb\u00e9 podem definir estils perqu\u00e8 els missatges que d'error que es mostren (par\u00e0metre message o similars en les anotacions de l'entitat) tinguen un estil determinat. A\u00e7\u00f2 s'aconsegueix f\u00e0cilment triant algun dels temes predefinits de Symfony.","title":"Afegir estils per a les validacions"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#exercicis","text":"","title":"Exercicis"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#exercici-61","text":"","title":"Exercici 6.1"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#exercici-62","text":"","title":"Exercici 6.2"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#exercici-63","text":"","title":"Exercici 6.3"},{"location":"08-symfony/06-formularis-i-validaci%C3%B3/#exercici-64","text":"","title":"Exercici 6.4"},{"location":"08-symfony/07-seguretat-control-acces/","text":"Seguretat i control d'acc\u00e9s Configuraci\u00f3 de la seguretat en Symfony El sistema de seguretat de Symfony \u00e9s molt potent i vers\u00e0til, encara que tamb\u00e9 pot resultar complicat d'entendre i configurar. En aquesta sessi\u00f3 aprendrem a establir els elements principals del mateix: El mecanisme d'autenticaci\u00f3 , \u00e9s a dir, establir on estan registrats els usuaris amb acc\u00e9s a l'aplicaci\u00f3, per poder accedir a ells i validar les credencials. El mecanisme d'autoritzaci\u00f3 , \u00e9s a dir, una vegada s'ha validat l'usuari que accedeix, i sempre que aquest siga correcte, determinar els seus permisos i a quins recursos pot accedir i a quins no. L'arxiu \"security.yaml\". El firewall de Symfony L'arxiu config/packages/security.yaml emmagatzema la configuraci\u00f3 general del sistema de seguretat de la nostra aplicaci\u00f3 Symfony. El seu contingut per defecte \u00e9s aquest: security : enable_authenticator_manager : true # https://symfony.com/doc/current/security.html#registering-the-user-hashing-passwords password_hashers : Symfony\\Component\\Security\\Core\\User\\PasswordAuthenticatedUserInterface : 'auto' # https://symfony.com/doc/current/security.html#loading-the-user-the-user-provider providers : users_in_memory : { memory : null } firewalls : dev : pattern : ^/(_(profiler|wdt)|css|images|js)/ security : false main : lazy : true provider : users_in_memory # activate different ways to authenticate # https://symfony.com/doc/current/security.html#the-firewall # https://symfony.com/doc/current/security/impersonating_user.html # switch_user: true # Easy way to control access for large sections of your site # Note: Only the *first* access control that matches will be used access_control : # - { path: ^/admin, roles: ROLE_ADMIN } # - { path: ^/profile, roles: ROLE_USER } Primerament cal dir que el sistema de seguretat de Symfony va canviar de forma significativa en la versi\u00f3 5.3. La clau enable_authenticator_manager: true indica que estem usant aquest nou sistema. La secci\u00f3 firewalls \u00e9s el nucli principal del nostre sistema de seguretat. Dins veiem dos subsecciones: dev , que simplement s'assegura que el profiler de Symfony i la barra de depuraci\u00f3 (WDT, Web Debug Toolbar ) no es veguen afectats pel nostre sistema de seguretat, de manera que puguem seguir tenint la informaci\u00f3 d'estat en la barra inferior que apareix en provar l'aplicaci\u00f3: La resta d'elements de l'aplicaci\u00f3 es gestionaran des de la subsecci\u00f3 main , on posarem la l\u00f2gica de seguretat de la nostra aplicaci\u00f3. De fet, el no tenir una subsecci\u00f3 pattern implica que autom\u00e0ticament absorbeix la resta d'URLs que no hagen coincidit amb cap patr\u00f3 anterior del firewall. La subsecci\u00f3 anonymous: true indica que es permet un acc\u00e9s an\u00f2nim a les seccions que no estiguen protegides. De fet, si accedim a movies-symfony i examinem la barra inferior d'estat, veurem que hem iniciat sessi\u00f3 com usuaris a an\u00f2nims ( anon. ). Veurem a continuaci\u00f3 com afegir elements d'autenticaci\u00f3 en aquest apartat de configuraci\u00f3. Establir la manera d'autenticaci\u00f3 i origen de dades Podem establir diferents formes d'autenticaci\u00f3, i diferents fonts de dades d'on obtenir els usuaris per a validar. El mecanisme m\u00e9s simple (i menys recomanat) consisteix a utilitzar una autenticaci\u00f3 b\u00e0sica d'HTTP (aquella que mostra un \"prompt\" b\u00e0sic per a introduir login i password ), i emmagatzemar els usuaris en el propi arxiu security.yaml . Els passwords poden (han de) estar encriptats en aquest arxiu, per\u00f2 encara aix\u00ed, no \u00e9s un mecanisme molt recomanable d'emmagatzematge. Ens saltarem aquesta opci\u00f3, i anirem a la qual realment ens interessa: tindrem els usuaris registrats en una taula d'una base de dades MySQL (en aquest cas, de la nostra base de dades de pel\u00b7l\u00edcules), i definirem un formulari d'inici de sessi\u00f3 que utilitzar per a validar-nos contra aqueixa taula a l'hora d'accedir a recursos protegits. Definir l'entitat i taula d'usuaris En la nostra aplicaci\u00f3 de pel\u00b7l\u00edcules anem a afegir una nova entitat per a emmagatzemar els usuaris de l'aplicaci\u00f3, i la seua corresponent taula associada, emprant Doctrine. Els usuaris tindran en aquest cas un identificador (autonum\u00e8ric generat per Doctrine), un nom d'usuari, una contrasenya, un correu electr\u00f2nic i un rol (m\u00e9s endavant veurem per a qu\u00e8 s'utilitza el rol). Per tant, crearem primer l'entitat d'aquesta forma: php bin/console make:entity Class name of the entity to create or update (e.g. TinyPizza): > User created: src/Entity/User.php created: src/Repository/UserRepository.php Entity generated! Now let's add some fields! You can always add more fields later manually or by re-running this command. New property name (press <return> to stop adding fields): > username Field type (enter ? to see all types) [string]: > string Field length [255]: > 100 Can this field be null in the database (nullable) (yes/no) [no]: > updated: src/Entity/User.php Add another property? Enter the property name (or press <return> to stop adding fields): > password Field type (enter ? to see all types) [string]: > string Field length [255]: > 255 Can this field be null in the database (nullable) (yes/no) [no]: > no updated: src/Entity/User.php Add another property? Enter the property name (or press <return> to stop adding fields): > email Field type (enter ? to see all types) [string]: > string Field length [255]: > 255 Can this field be null in the database (nullable) (yes/no) [no]: > yes updated: src/Entity/User.php Add another property? Enter the property name (or press <return> to stop adding fields): > role Field type (enter ? to see all types) [string]: > string Field length [255]: > 20 Can this field be null in the database (nullable) (yes/no) [no]: > no updated: src/Entity/User.php Add another property? Enter the property name (or press <return> to stop adding fields): > Success! Una vegada creada l'entitat, el seg\u00fcent pas \u00e9s migrar els canvis a la base de dades, com ja hem fet pr\u00e8viament: php bin/console make:migration php bin/console doctrine:migration:migrate Alternativament a aquests dos comandos, i en el cas que done algun conflicte amb migracions pr\u00e8vies, tamb\u00e9 podem executar aquests altres dos, que gestionen millor les difer\u00e8ncies o novetats a migrar: php bin/console doctrine:migrations:diff php bin/console doctrine:migrations:migrate Podem afegir a m\u00e0 un usuari de prova en la base de dades, amb aquests atributs: username: user password: user email: proves@proves.org role: ROLE_USER Insistim, tornarem a tractar els rols m\u00e9s endavant. De moment deixarem establit aquest per a aquest usuari de prova. Implementar les interf\u00edcies requerides Per a poder utilitzar una entitat com a font d'usuaris que puguen iniciar sessi\u00f3, \u00e9s necessari que aquesta entitat implemente la interf\u00edcie UserInterface i la interf\u00edcie PasswordAuthenticatedUserInterface , la qual cosa obliga a definir els m\u00e8todes: getRoles() , que retornar\u00e0 un array amb els rols de l'usuari (en aquest cas, cada usuari nom\u00e9s tindr\u00e0 un rol, que retornarem en un array) getPassword() , que retornar\u00e0 el password de l'usuari getUserIdentifier() , que retornar\u00e0 el login de l'usuari getSalt() , que en ocasions no \u00e9s necessari emprar. S'empra en mecanismes de codificaci\u00f3 de passwords m\u00e9s avan\u00e7ats que els que veurem en el curs. Aix\u00ed que en el nostre exemple retornarem null . eraseCredentials() , que s'empra per a eliminar informaci\u00f3 sensible o privada de l'usuari. Pot ser \u00fatil si, per exemple, s'emmagatzema el password de l'usuari sense encriptar. En primera inst\u00e0ncia ho farem aix\u00ed, per\u00f2 despr\u00e9s ho encriptarem, aix\u00ed que aquest m\u00e8tode ho deixarem buit. A m\u00e9s, conv\u00e9 implementar la interf\u00edcie Serializable per a poder serialitzar objectes de tipus User i enviar-los entre les parts de l'aplicaci\u00f3 (m\u00e9s endavant veurem com obtenir l'objecte User de l'usuari que ha iniciat sessi\u00f3). A\u00e7\u00f2 implica afegir dos m\u00e8todes m\u00e9s: serialize (per a convertir l'usuari en text que enviar entre components) i unserialize (per a convertir un text en un objecte User ). Amb tot a\u00e7\u00f2, la nostra entitat User queda aix\u00ed (eliminem els getters i setters generats autom\u00e0ticament i que no anem a emprar en realitat): # src/Entity/User.php ... * Alternatively , the roles might be stored on a `` roles `` property , * and populated in any number of different ways when the user object * is created . * * @ return string [] The user roles */ public function getRoles () { return [ $this -> role ]; } /** * Returns the salt that was originally used to encode the password. * * This can return null if the password was not encoded using a salt. * * @return string|null The salt */ public function getSalt () { return null ; } /** * Removes sensitive data from the user. * * This is important if, at any given point, sensitive information like * the plain-text password is stored on this object. */ public function eraseCredentials () { // TODO: Implement eraseCredentials() method. } /** * String representation of object. * @link https://php.net/manual/en/serializable.serialize.php * @return string|null The string representation of the object or null * @throws Exception Returning other type than string or null */ public function serialize () : ? string { return serialize ([ $this -> getId (), $this -> getUsername (), $this -> getPassword () ]); } /** * Constructs the object. * @link https://php.net/manual/en/serializable.unserialize.php * @param string $serialized The string representation of the object. * @return void */ public function unserialize ( $serialized ) { list ( $this -> id , $this -> username , $this -> password ) = unserialize ( $serialized , [ 'allowed_classes' => false ]); } En el cas de la funci\u00f3 unserialize , se li passa com a segon par\u00e0metre un array d'opcions. L'opci\u00f3 allowed_classes que s'utilitza en aquest exemple, posada a false , fa que no es permeta la serialitzaci\u00f3 d'objectes de cap classe (nom\u00e9s els tipus simples que componen els atributs de l'entitat User , en aquest cas). Configurar l'origen de dades i la manera d'autenticaci\u00f3 Anem ara a indicar on ha de buscar Symfony els usuaris quan alg\u00fa intente accedir al sistema. Per a a\u00e7\u00f2, anem a l'arxiu de configuraci\u00f3 config/packages/security.yaml , i afegim un nou prove\u00efdor de dades, enlla\u00e7at a l'entitat User : security : providers : ... user_provider : entity : class : App\\Entity\\User property : username Indiquem el nom de l'entitat, i el nom de l'atribut que s'usuar\u00e0 com a nom d'usuari en l'inici de sessi\u00f3. Despr\u00e9s, una mica m\u00e9s a baix en aqueix mateix fitxer (subsecci\u00f3n security > firewalls > main ), establim que inicie sessi\u00f3 mitjan\u00e7ant un formulari, que s'activar\u00e0 amb la ruta anomenada login que definirem despr\u00e9s: security : firewalls : dev : ... main : anonymous : ~ form_login : provider : user_provider login_path : login check_path : login En aquest cas, hem anul\u00b7lat (posat a null) l'acc\u00e9s an\u00f2nim (a\u00e7\u00f2 \u00e9s el que significa el s\u00edmbol \"~\" al costat d'anonymous. D'altra banda, indiquem que tant per a mostrar el formulari com per a verificar l'inici de sessi\u00f3, s'acudir\u00e0 a la mateixa ruta login , emprant com a prove\u00efdor d'usuaris l'element user_provider que hem definit abans, basat en l'entitat User . Podem, a m\u00e9s, definir quins recursos es protegiran amb aquest formulari. Conv\u00e9, almenys, especificar un patr\u00f3 de ruta que excloga al propi formulari d'inici de sessi\u00f3, ja que en cas contrari entrar\u00edem en un bucle infinit en el qual, per a accedir al formulari d'inici de sessi\u00f3, haur\u00edem d'iniciar sessi\u00f3 amb el formulari d'inici de sessi\u00f3. Per a a\u00e7\u00f2, editem la secci\u00f3 access_control al final de l'arxiu security.yaml , i indiquem, almenys, dues rutes: una sense protegir per a l'inici de sessi\u00f3, i l'altra protegida per al que vulguem (en aquest cas, la resta de l'aplicaci\u00f3): access_control : - { path : ^/login , rols : IS_AUTHENTICATED_ANONYMOUSLY } - { path : ^/ , rols : ROLE_USER } Finalment, tamb\u00e9 podem especificar el sistema de codificaci\u00f3 del password. Ara com ara no ho usar cap tipus de codificaci\u00f3, per la qual cosa afegim aquest subapartat al final (dins de la secci\u00f3 security ): encoders : App\\User\\Entity : plaintext Definir la ruta i el formulari d'inici de sessi\u00f3 Finalment, anem a crear un nou controlador anomenat SecurityController en la nostra carpeta de src/Controller , que definir\u00e0 una nova ruta /login per a mostrar el formulari d'inici de sessi\u00f3 i verificar l'error de validaci\u00f3, si \u00e9s el cas. Pot quedar m\u00e9s o menys aix\u00ed: class SecurityController extends AbstractController { /** * @Route(\"/login\", name=\"login\") */ public function login ( AuthenticationUtils $authenticationUtils ) { $error = $authenticationUtils -> getLastAuthenticationError (); $lastUsername = $authenticationUtils -> getLastUsername (); return $this -> render ( 'security/login.html.twig' , array ( 'error' => $error , 'lastUserName' => $lastUsername )); } } Podr\u00edem obtenir altres dades del proc\u00e9s de validaci\u00f3. Per exemple, en cas que l'usuari no es valide correctament, podr\u00edem recuperar el seu nom d'usuari per a tornar-lo a introduir autom\u00e0ticament en la plantilla del formulari, i aix\u00ed evitar que l'haja de tornar a escriure. Per a a\u00e7\u00f2, tenim el m\u00e8tode getLastUsername() de l'objecte AuthenticationUtils . N'hi ha prou amb recuperar la dada i passar-li-la a la plantilla: ... $lastUsername = $authenticationUtils -> getLastUsername (); return $this -> render ( 'security/login.html.twig' , array ( 'error' => $error , 'lastUserName' => $lastUsername )); El formulari d'inici de sessi\u00f3 estar\u00e0 en login.html.twig , pot ser alguna cosa aix\u00ed: {% extends 'base.html.twig' %} {% block title %} Movies - Login {% endblock %} {% block body %} < div class = \"container\" > < div class = \"row\" > < div class = \"col-sm-12\" > < h3 > Login </ h3 > < form method = \"post\" novalidate > {% if error %} < div class = \"alert alert-danger\" role = \"alert\" > {{ error.messageKey }} </ div > {% endif %} < div class = \"form-group\" > < label for = \"username\" > Username </ label > < input type = \"text\" class = \"form-control\" name = \"_username\" id = \"username\" value = \" {{ lastUserName }} \" placeholder = \"Username:\" required > </ div > < div class = \"form-group\" > < label for = \"password\" > Contrasenya </ label > < input type = \"password\" class = \"form-control\" name = \"_password\" id = \"password\" value = \"\" placeholder = \"Password:\" required > </ div > < input type = \"submit\" value = \"Login\" > </ form > </ div > </ div > </ div > {% endblock %} Com veiem, es t\u00e9 un bloc div condicional per a mostrar un error de validaci\u00f3 si \u00e9s el cas. A m\u00e9s, el formulari ha de complir unes normes: el camp de login ha de cridar-se _username (atribut \"name\"), i el camp de password ha de cridar-se _password . Aquestes opcions poden configurar-se i personalitzar-se. Despr\u00e9s de tots aquests passos, ja tindrem llest el sistema d'autenticaci\u00f3. Pot semblar estrany, per\u00f2 aix\u00ed \u00e9s... En realitat, Symfony es fa c\u00e0rrec autom\u00e0ticament de la validaci\u00f3 de l'usuari quan aquest envia el formulari d'inici de sessi\u00f3. Si hi ha algun error, es registrar\u00e0 dins del controlador login i es renderizar\u00e1 el formulari amb el missatge d'error. Si tot \u00e9s correcte, es redirigir\u00e0 a l'usuari autom\u00e0ticament cap a la p\u00e0gina que havia sol\u00b7licitat. Algunes opcions avan\u00e7ades Ara que ja hem apr\u00e9s a configurar una forma b\u00e0sica d'autenticaci\u00f3 amb formulari d'inici de sessi\u00f3ogin, vegem alguns aspectes una mica m\u00e9s avan\u00e7ats de la configuraci\u00f3 de la seguretat en Symfony. Encriptar les contrasenyes \u00c9s convenient que les contrasenyes dels usuaris registrats no estiguen en text pla sense encriptar, com en l'exemple anterior. Podem emprar, per exemple, un algorisme d'encriptaci\u00f3 Argon o bcrype per a xifrar-les. En el nostre cas, i seguint les recomanacions de la documentaci\u00f3 oficial de Symfony deixarem que siga Symfony qui trie el millor algorisme possible. A\u00e7\u00f2 suposa dos passos extra: Indicar a Symfony que els passwords estan encriptats perqu\u00e8 aplique un algorisme per a encriptar qualsevol contrasenya, incl\u00f2s el que introdu\u00efsca l'usuari en iniciar sessi\u00f3, i aix\u00ed poder comparar si les dos contrasenyes encriptades coincideixen. Per a fer a\u00e7\u00f2, hem d'editar l'arxiu de configuraci\u00f3 config/packages/security.yaml i indicar que l'entitat Usuari utilitzar\u00e0 el m\u00e8tode d'encriptaci\u00f3 que h\u00e0gem escollit: # config/packages/security.yaml security : # ... password_hashers : # auto hasher with default options for the User class (and children) App\\Entity\\User : 'auto' # auto hasher with custom options for all PasswordAuthenticatedUserInterface instances Symfony\\Component\\Security\\Core\\User\\PasswordAuthenticatedUserInterface : algorithm : 'auto' cost : 15 Encriptar de forma autom\u00e0tica els passwords dels usuaris quan es registren. Si tingu\u00e9rem un formulari de registre en la nostra aplicaci\u00f3, i tenim les dades de l'usuari guardats en un objecte usuari, i el password en s\u00ed en un objecte password , l'encriptaci\u00f3 seria com segueix: use Symfony ; public function register ( UserPasswordHasherInterface $encoder ) { ... $user = new User (); ... $plainTextPassword = \"...\" ; // Assignem ac\u00ed la resta d'atributs de l'usuari $hashedPassword = $encoder -> hashPassword ( $user , $plainTextPassword ); $user -> setPassword ( $hashedPassord ); // Guardar en la base de dades, si escau ... } public function delete ( UserPasswordHasherInterface $passwordHasher , UserInterface $user ) { // ... e.g. get the password from a \"confirm deletion\" dialog $plainTextPassword = ... ; if ( ! $passwordHasher -> isPasswordValid ( $user , $plaintextPassword )) { throw new AccessDeniedHttpException (); } } El que fem \u00e9s acudir a la configuraci\u00f3 de l'arxiu security.yaml anterior per a veure qu\u00e8 codificador s'ha establit, i mitjan\u00e7ant l'objecte de tipus UserPasswordHashInterface que rep com a par\u00e0metre del m\u00e8tode, i del seu m\u00e8tode hashPassword , codificar el password amb aqueix mateix algorisme. Aquest m\u00e8tode rep com a primer par\u00e0metre l'usuari sobre el qual s'est\u00e0 treballant, i com a segon par\u00e0metre el password a codificar. Una vegada codificat, se li assigna a l'usuari, i ja es podria guardar en la base de dades. Per a provar el nostre exemple de pel\u00b7l\u00edcules, com no tenim formulari de registre, codificarem manualment el/els password(s) que tinguem en la base de dades. Podem emprar webs com https://bcrypt-generator.com/ . Treballar amb rols En els exemples fets fins ara, ens hem limitat a definir un camp role en la nostra entitat User , i a emmagatzemar un usuari amb rol ROLE_USER , per\u00f2 sense prestar massa atenci\u00f3 al que aqueix rol significa. Per a comen\u00e7ar, hem de saber que tots els rols que definim en la nostra aplicaci\u00f3 han de comen\u00e7ar amb el prefix ROLE_ perqu\u00e8 Symfony els tracte com a tals. Existeix la possibilitat de configurar aquesta opci\u00f3 i posar rols m\u00e9s flexibles o arbitraris. Symfony permet definir diferents rols en una aplicaci\u00f3, i establir una jerarquia entre ells, de manera que un rol puga fer tot el que fa un altre m\u00e9s altres coses. A m\u00e9s, podem protegir l'acc\u00e9s a recursos per a determinats rols, de manera que nom\u00e9s certs rols (o rols que estiguen per sobre d'ells en la jerarquia) puguen accedir. Assignar diferents rols a diferents recursos protegits En el cas que cada zona protegida de la nostra aplicaci\u00f3 puga tenir assignats rols diferents, n'hi ha prou amb indicar el rol (o rols entre claud\u00e0tors) que tenen perm\u00eds per a cada zona. Per exemple, en aquest cas protegim l'acc\u00e9s a qualsevol ruta que comence per /admin perqu\u00e8 nom\u00e9s puguen accedir usuaris amb rol ROLE_ADMIN o ROLE_MANAGER, a m\u00e9s de la configuraci\u00f3 ja establida en exemples previs: security access_control : - { path : ^/login , roles : IS_AUTHENTICATED_ANONYMOUSLY } - { path : ^/ , roles : ROLE_USER } - { path : ^/admin , roles : [ ROLE_ADMIN , ROLE_MANAGER ] } Establir jerarquies entre rols Pot ser necessari tamb\u00e9 establir una jerarquia entre rols, de manera que, si es t\u00e9 un rol de nivell superior, es tindr\u00e0 acc\u00e9s a tots els recursos que exigisquen un rol de nivell inferior. Per a fer a\u00e7\u00f2, afegim un subapartat role_hierarchy en la nostra secci\u00f3 security de config/packages/security.yaml , establint aquesta jerarquia. En el seg\u00fcent exemple, el rol ROLE_ADMIN cont\u00e9 a ROLE_USER , i el ROLE_SUPERADMIN cont\u00e9 tant a ROLE_ADMIN (i, per tant, a ROLE_USER ), com a ROLE_MANAGER . security : ... role_hierarchy : ROLE_ADMIN : ROLE_USER ROLE_SUPER_ADMIN : [ ROLE_ADMIN , ROLE_MANAGER ] Comprovar rols des dels controladors i vistes Existeix tamb\u00e9 la possibilitat de for\u00e7ar una comprovaci\u00f3 de seguretat en el codi dels controladors, basant-se en si l'usuari registrat t\u00e9 cert rol o no, o simplement si s'ha autenticat o no. Per exemple, aquest controlador permet l'acc\u00e9s al seu codi si l'usuari t\u00e9 el ROLE_ADMIN : /** * @Route(\"/movies/create\", name=\"movies_create\") */ public function create ( Request $request ) { $this -> denyAccessUnlessGranted ( 'ROLE_ADMIN' , null , 'Acc\u00e9s restringit a administradors' ); ... Aquest altre controlador simplement comprova si l'usuari s'ha autenticat correctament abans de seguir: public function otherController () { $this -> denyAccessUnlessGranted ( 'IS_AUTHENTICATED_FULLY' ); ... En qualsevol cas, el m\u00e8tode denyAccessUnlessGranted provoca que: Si l'usuari encara no s'ha autenticat, se li redirigeix a la p\u00e0gina d'inici de sessi\u00f3. Si s'ha autenticat per\u00f2 no t\u00e9 el rol requerit, es genera una p\u00e0gina d'error HTTP 403 (acc\u00e9s prohibit). Aquesta p\u00e0gina es pot personalitzar. Tamb\u00e9 \u00e9s possible comprovar un determinat rol o autenticaci\u00f3 des del codi d'una plantilla Twig, mitjan\u00e7ant la funci\u00f3 is_granted . A\u00e7\u00f2 pot servir per a mostrar o no certs apartats de la vista. {% if is_granted ( 'ROLE_ADMIN' ) %} ... {% endif %} Obtenir l'objecte user Una vegada autenticats, l'objecte user es pot obtenir a trav\u00e9s del m\u00e8tode getUser , normalment des de dins d'un controlador. Aix\u00ed, podr\u00edem fer: /** * @Route(\"/admin\", name=\"admin\") */ public function admin () { $this -> denyAccessUnlessGranted ( 'IS_AUTHENTICATED_FULLY' ); $user = $this -> getUser (); return new Response ( \"Bienvenido a /admin, \" . $user -> getUserName ()); } Des d'una plantilla Twig tamb\u00e9 \u00e9s possible accedir a l'usuari que ha iniciat sessi\u00f3 i obtenir, per exemple, el seu nom d'usuari, amb l'objecte app.user : Benvingut/a, {{ app.user.username }} Eixint de l'aplicaci\u00f3 (logout) Podem configurar el tancament de sessi\u00f3 o logout a trav\u00e9s d'arxius YAML exclusivament. N'hi ha prou amb seguir aquests dos passos: En primer lloc, establim que quan s'isca de l'aplicaci\u00f3 es redirigir\u00e0, per exemple, a l'arrel de la mateixa. A\u00e7\u00f2 es fa en l'arxiu config/packages/security.yaml: . Per exemple, per a permetre tancar sessi\u00f3 en el firewall main , amb el qual estem treballant en el nostre exemple, far\u00edem a\u00e7\u00f2: firewalls : ... main : logout : path : /logout target : / En segon lloc, definim una ruta en l'arxiu config/routes.yaml que associe el nom \"logout\" (o com el vulguem cridar) amb la ruta que h\u00e0gem definit abans (en aquest cas, la ruta /logout ): logout : path : /logout Amb a\u00e7\u00f2, i algun enlla\u00e7 en les nostres plantilles per a poder tancar sessi\u00f3 (per exemple, en la plantilla base)... < a href = \" {{ path ( \"logout\" ) }} \" > Tancar sessi\u00f3 </ a > ... ja podrem canviar d'usuari o eixir de l'aplicaci\u00f3. Recursos El recurs d'informaci\u00f3 el trobar\u00e0s en el cap\u00edtol Security dins de la documentaci\u00f3 oficial de Symfony.","title":"Seguretat i control d'acc\u00e9s"},{"location":"08-symfony/07-seguretat-control-acces/#seguretat-i-control-dacces","text":"","title":"Seguretat i control d'acc\u00e9s"},{"location":"08-symfony/07-seguretat-control-acces/#configuracio-de-la-seguretat-en-symfony","text":"El sistema de seguretat de Symfony \u00e9s molt potent i vers\u00e0til, encara que tamb\u00e9 pot resultar complicat d'entendre i configurar. En aquesta sessi\u00f3 aprendrem a establir els elements principals del mateix: El mecanisme d'autenticaci\u00f3 , \u00e9s a dir, establir on estan registrats els usuaris amb acc\u00e9s a l'aplicaci\u00f3, per poder accedir a ells i validar les credencials. El mecanisme d'autoritzaci\u00f3 , \u00e9s a dir, una vegada s'ha validat l'usuari que accedeix, i sempre que aquest siga correcte, determinar els seus permisos i a quins recursos pot accedir i a quins no.","title":"Configuraci\u00f3 de la seguretat en Symfony"},{"location":"08-symfony/07-seguretat-control-acces/#larxiu-securityyaml-el-firewall-de-symfony","text":"L'arxiu config/packages/security.yaml emmagatzema la configuraci\u00f3 general del sistema de seguretat de la nostra aplicaci\u00f3 Symfony. El seu contingut per defecte \u00e9s aquest: security : enable_authenticator_manager : true # https://symfony.com/doc/current/security.html#registering-the-user-hashing-passwords password_hashers : Symfony\\Component\\Security\\Core\\User\\PasswordAuthenticatedUserInterface : 'auto' # https://symfony.com/doc/current/security.html#loading-the-user-the-user-provider providers : users_in_memory : { memory : null } firewalls : dev : pattern : ^/(_(profiler|wdt)|css|images|js)/ security : false main : lazy : true provider : users_in_memory # activate different ways to authenticate # https://symfony.com/doc/current/security.html#the-firewall # https://symfony.com/doc/current/security/impersonating_user.html # switch_user: true # Easy way to control access for large sections of your site # Note: Only the *first* access control that matches will be used access_control : # - { path: ^/admin, roles: ROLE_ADMIN } # - { path: ^/profile, roles: ROLE_USER } Primerament cal dir que el sistema de seguretat de Symfony va canviar de forma significativa en la versi\u00f3 5.3. La clau enable_authenticator_manager: true indica que estem usant aquest nou sistema. La secci\u00f3 firewalls \u00e9s el nucli principal del nostre sistema de seguretat. Dins veiem dos subsecciones: dev , que simplement s'assegura que el profiler de Symfony i la barra de depuraci\u00f3 (WDT, Web Debug Toolbar ) no es veguen afectats pel nostre sistema de seguretat, de manera que puguem seguir tenint la informaci\u00f3 d'estat en la barra inferior que apareix en provar l'aplicaci\u00f3: La resta d'elements de l'aplicaci\u00f3 es gestionaran des de la subsecci\u00f3 main , on posarem la l\u00f2gica de seguretat de la nostra aplicaci\u00f3. De fet, el no tenir una subsecci\u00f3 pattern implica que autom\u00e0ticament absorbeix la resta d'URLs que no hagen coincidit amb cap patr\u00f3 anterior del firewall. La subsecci\u00f3 anonymous: true indica que es permet un acc\u00e9s an\u00f2nim a les seccions que no estiguen protegides. De fet, si accedim a movies-symfony i examinem la barra inferior d'estat, veurem que hem iniciat sessi\u00f3 com usuaris a an\u00f2nims ( anon. ). Veurem a continuaci\u00f3 com afegir elements d'autenticaci\u00f3 en aquest apartat de configuraci\u00f3.","title":"L'arxiu \"security.yaml\". El firewall de Symfony"},{"location":"08-symfony/07-seguretat-control-acces/#establir-la-manera-dautenticacio-i-origen-de-dades","text":"Podem establir diferents formes d'autenticaci\u00f3, i diferents fonts de dades d'on obtenir els usuaris per a validar. El mecanisme m\u00e9s simple (i menys recomanat) consisteix a utilitzar una autenticaci\u00f3 b\u00e0sica d'HTTP (aquella que mostra un \"prompt\" b\u00e0sic per a introduir login i password ), i emmagatzemar els usuaris en el propi arxiu security.yaml . Els passwords poden (han de) estar encriptats en aquest arxiu, per\u00f2 encara aix\u00ed, no \u00e9s un mecanisme molt recomanable d'emmagatzematge. Ens saltarem aquesta opci\u00f3, i anirem a la qual realment ens interessa: tindrem els usuaris registrats en una taula d'una base de dades MySQL (en aquest cas, de la nostra base de dades de pel\u00b7l\u00edcules), i definirem un formulari d'inici de sessi\u00f3 que utilitzar per a validar-nos contra aqueixa taula a l'hora d'accedir a recursos protegits.","title":"Establir la manera d'autenticaci\u00f3 i origen de dades"},{"location":"08-symfony/07-seguretat-control-acces/#algunes-opcions-avancades","text":"Ara que ja hem apr\u00e9s a configurar una forma b\u00e0sica d'autenticaci\u00f3 amb formulari d'inici de sessi\u00f3ogin, vegem alguns aspectes una mica m\u00e9s avan\u00e7ats de la configuraci\u00f3 de la seguretat en Symfony.","title":"Algunes opcions avan\u00e7ades"},{"location":"08-symfony/07-seguretat-control-acces/#encriptar-les-contrasenyes","text":"\u00c9s convenient que les contrasenyes dels usuaris registrats no estiguen en text pla sense encriptar, com en l'exemple anterior. Podem emprar, per exemple, un algorisme d'encriptaci\u00f3 Argon o bcrype per a xifrar-les. En el nostre cas, i seguint les recomanacions de la documentaci\u00f3 oficial de Symfony deixarem que siga Symfony qui trie el millor algorisme possible. A\u00e7\u00f2 suposa dos passos extra: Indicar a Symfony que els passwords estan encriptats perqu\u00e8 aplique un algorisme per a encriptar qualsevol contrasenya, incl\u00f2s el que introdu\u00efsca l'usuari en iniciar sessi\u00f3, i aix\u00ed poder comparar si les dos contrasenyes encriptades coincideixen. Per a fer a\u00e7\u00f2, hem d'editar l'arxiu de configuraci\u00f3 config/packages/security.yaml i indicar que l'entitat Usuari utilitzar\u00e0 el m\u00e8tode d'encriptaci\u00f3 que h\u00e0gem escollit: # config/packages/security.yaml security : # ... password_hashers : # auto hasher with default options for the User class (and children) App\\Entity\\User : 'auto' # auto hasher with custom options for all PasswordAuthenticatedUserInterface instances Symfony\\Component\\Security\\Core\\User\\PasswordAuthenticatedUserInterface : algorithm : 'auto' cost : 15 Encriptar de forma autom\u00e0tica els passwords dels usuaris quan es registren. Si tingu\u00e9rem un formulari de registre en la nostra aplicaci\u00f3, i tenim les dades de l'usuari guardats en un objecte usuari, i el password en s\u00ed en un objecte password , l'encriptaci\u00f3 seria com segueix: use Symfony ; public function register ( UserPasswordHasherInterface $encoder ) { ... $user = new User (); ... $plainTextPassword = \"...\" ; // Assignem ac\u00ed la resta d'atributs de l'usuari $hashedPassword = $encoder -> hashPassword ( $user , $plainTextPassword ); $user -> setPassword ( $hashedPassord ); // Guardar en la base de dades, si escau ... } public function delete ( UserPasswordHasherInterface $passwordHasher , UserInterface $user ) { // ... e.g. get the password from a \"confirm deletion\" dialog $plainTextPassword = ... ; if ( ! $passwordHasher -> isPasswordValid ( $user , $plaintextPassword )) { throw new AccessDeniedHttpException (); } } El que fem \u00e9s acudir a la configuraci\u00f3 de l'arxiu security.yaml anterior per a veure qu\u00e8 codificador s'ha establit, i mitjan\u00e7ant l'objecte de tipus UserPasswordHashInterface que rep com a par\u00e0metre del m\u00e8tode, i del seu m\u00e8tode hashPassword , codificar el password amb aqueix mateix algorisme. Aquest m\u00e8tode rep com a primer par\u00e0metre l'usuari sobre el qual s'est\u00e0 treballant, i com a segon par\u00e0metre el password a codificar. Una vegada codificat, se li assigna a l'usuari, i ja es podria guardar en la base de dades. Per a provar el nostre exemple de pel\u00b7l\u00edcules, com no tenim formulari de registre, codificarem manualment el/els password(s) que tinguem en la base de dades. Podem emprar webs com https://bcrypt-generator.com/ .","title":"Encriptar les contrasenyes"},{"location":"08-symfony/07-seguretat-control-acces/#treballar-amb-rols","text":"En els exemples fets fins ara, ens hem limitat a definir un camp role en la nostra entitat User , i a emmagatzemar un usuari amb rol ROLE_USER , per\u00f2 sense prestar massa atenci\u00f3 al que aqueix rol significa. Per a comen\u00e7ar, hem de saber que tots els rols que definim en la nostra aplicaci\u00f3 han de comen\u00e7ar amb el prefix ROLE_ perqu\u00e8 Symfony els tracte com a tals. Existeix la possibilitat de configurar aquesta opci\u00f3 i posar rols m\u00e9s flexibles o arbitraris. Symfony permet definir diferents rols en una aplicaci\u00f3, i establir una jerarquia entre ells, de manera que un rol puga fer tot el que fa un altre m\u00e9s altres coses. A m\u00e9s, podem protegir l'acc\u00e9s a recursos per a determinats rols, de manera que nom\u00e9s certs rols (o rols que estiguen per sobre d'ells en la jerarquia) puguen accedir.","title":"Treballar amb rols"},{"location":"08-symfony/07-seguretat-control-acces/#obtenir-lobjecte-user","text":"Una vegada autenticats, l'objecte user es pot obtenir a trav\u00e9s del m\u00e8tode getUser , normalment des de dins d'un controlador. Aix\u00ed, podr\u00edem fer: /** * @Route(\"/admin\", name=\"admin\") */ public function admin () { $this -> denyAccessUnlessGranted ( 'IS_AUTHENTICATED_FULLY' ); $user = $this -> getUser (); return new Response ( \"Bienvenido a /admin, \" . $user -> getUserName ()); } Des d'una plantilla Twig tamb\u00e9 \u00e9s possible accedir a l'usuari que ha iniciat sessi\u00f3 i obtenir, per exemple, el seu nom d'usuari, amb l'objecte app.user : Benvingut/a, {{ app.user.username }}","title":"Obtenir l'objecte user"},{"location":"08-symfony/07-seguretat-control-acces/#eixint-de-laplicacio-logout","text":"Podem configurar el tancament de sessi\u00f3 o logout a trav\u00e9s d'arxius YAML exclusivament. N'hi ha prou amb seguir aquests dos passos: En primer lloc, establim que quan s'isca de l'aplicaci\u00f3 es redirigir\u00e0, per exemple, a l'arrel de la mateixa. A\u00e7\u00f2 es fa en l'arxiu config/packages/security.yaml: . Per exemple, per a permetre tancar sessi\u00f3 en el firewall main , amb el qual estem treballant en el nostre exemple, far\u00edem a\u00e7\u00f2: firewalls : ... main : logout : path : /logout target : / En segon lloc, definim una ruta en l'arxiu config/routes.yaml que associe el nom \"logout\" (o com el vulguem cridar) amb la ruta que h\u00e0gem definit abans (en aquest cas, la ruta /logout ): logout : path : /logout Amb a\u00e7\u00f2, i algun enlla\u00e7 en les nostres plantilles per a poder tancar sessi\u00f3 (per exemple, en la plantilla base)... < a href = \" {{ path ( \"logout\" ) }} \" > Tancar sessi\u00f3 </ a > ... ja podrem canviar d'usuari o eixir de l'aplicaci\u00f3.","title":"Eixint de l'aplicaci\u00f3 (logout)"},{"location":"08-symfony/07-seguretat-control-acces/#recursos","text":"El recurs d'informaci\u00f3 el trobar\u00e0s en el cap\u00edtol Security dins de la documentaci\u00f3 oficial de Symfony.","title":"Recursos"},{"location":"08-symfony/08-repositoris-paginacio/","text":"Extrendre els repositoris. Paginaci\u00f3 Introducci\u00f3 Com ja has vist, l'objecte Repository permet executar consultes senzilles sense pr\u00e0cticament cap treball: // from inside a controller $repository = $em -> getRepository ( Link :: class ); $movies = $repository -> findAll (); Els m\u00e8todes disponibles s\u00f3n els seg\u00fcents: /** * @method Movie|null find($id, $lockMode = null, $lockVersion = null) * @method Movie|null findOneBy(array $criteria, array $orderBy = null) * @method Movie[] findAll() * @method Movie[] findBy(array $criteria, array $orderBy = null, $limit = null, $offset = null) */ Per\u00f2, i si necessitem una consulta m\u00e9s complexa? Quan generem una entitat amb make:entity , el comandament tamb\u00e9 genera una classe anomenada MovieRepository . # src/Repository/MovieRepository.php namespace App\\Repository ; use App\\Entity\\Movie ; use Doctrine\\Bundle\\DoctrineBundle\\Repository\\ServiceEntityRepository ; use Doctrine\\Persistence\\ManagerRegistry ; class MovieRepository extends ServiceEntityRepository { public function __construct ( ManagerRegistry $registry ) { parent :: __construct ( $registry , Movie :: class ); } //... } Quan obtens el repositori (p.e. ->getRepository(Movie::class) ), est\u00e0s obtenint realment una inst\u00e0ncia d'aquest objecte! Anotacions Cal assegurar-se que l'entitat t\u00e9 correctament vinculat el repositori mitjan\u00e7ant una anotaci\u00f3. En el nostre exemple l'entitat Movie haur\u00e0 d'incloure: @ ORM\\Entity ( repositoryClass = \"App \\R epository\\MovieRepository\" ) QueryBuilder Suposem que vols fer una consulta que obtinga tots els objectes Link amb data posterior a certa data. Hauries d'afegir un nou m\u00e8tode dins del repositori: // src/Repository/MovieRepository.php // ... class MovieRepository extends ServiceEntityRepository { public function __construct ( ManagerRegistry $registry ) { parent :: __construct ( $registry , Product :: class ); } /** * @return Movie[] */ public function findAllAfterDate ( DateTime $date ) : array { $query = $this -> createQueryBuilder ( 'm' ) -> andwhere ( \"m.releaseDate >= :date\" ) -> orderBy ( 'l.releaseDate' , 'DESC' ) -> setParameter ( 'date' , $date ) -> getQuery (); return $query -> getResult (); } Query Builder , \u00e9s una forma orientada a objectes d'escriure consultes. Es recomana utilitzar-la quan les consultes es creen din\u00e0micament. Ara, pots cridar el m\u00e8tode del repositori: // from inside a controller $date = new DateTime ( \"2020-01-01\" ); $movies = $em -> getRepository ( Movie :: class ) -> findAllAfterDate ( $date ); // ... Query Tamb\u00e9 \u00e9s possible utilitzar l'objecte Query , aix\u00ed com executar consultes directament amb PDO. /** * @return Movie[] */ public function findAllAfterDate ( DateTime $date ) : array { $query = $this -> createQuery ( ' SELECT m FROM App\\Entity\\Movie m WHERE m.releaseDate >= :date ORDER BY m.releaseDate DESC' ) -> setParameter ( 'date' , $date ); return $query -> getResult (); } Consultes SQL Aquest tipus de consultes s'executen directament en PDO, fent \u00fas de les classes PDO , PDOStatement . // src/Repository/MovieRepository.php // ... public function findAllAfterDate ( DateTime $date ) : array { // TODO: Revisar com accedir a la connexi\u00f3 $conn = $this -> getEntityManager () -> getConnection (); $sql = ' SELECT * FROM movie m WHERE m.release_date > :date ORDER BY m.release_date DESC ' ; $stmt = $conn -> prepare ( $sql ); $stmt -> execute ([ 'date' => $date ]); // returns an array of arrays (i.e. a raw data set) return $stmt -> fetchAll (); } Aquestes consultes SQL tornen arrays, no objectes (a no ser que uses la funcionalitat NativeQuery ). M\u00e9s informaci\u00f3 en Querying for objects the repository Exemple En el seg\u00fcent exemple pots observar un \u00fas del nou m\u00e8tode del repositori. Hem modificat la ruta homepage perqu\u00e8 comprove si ha rebut pel querystring el par\u00e0metre start-date si \u00e9s aix\u00ed executar\u00e0 el m\u00e8tode findAllAfterDate() si no cridar\u00e0 findAll() . /** * @Route(\"/\", name=\"homepage\") */ public function index ( Request $request ) { $repo = $this -> getDoctrine () -> getRepository ( Link :: class ); if ( $request -> query -> has ( \"start-date\" )) { $date = new \\DateTime ( $request -> query -> get ( \"start-date\" )); $links = $repo -> findAllAfterDate ( $date ); // TODO: check if the par\u00e0meter start-date is a valid date } else { $links = $repo -> findAll (); } // now pass the array of default object to the view return $this -> render ( 'default/index.html.twig' , [ 'links' => $links , ]); } Paginaci\u00f3 Symfony no inclou un paginador de forma nativa per\u00f2 al incloure Doctrine permet implementar-ho f\u00e0cilment sense necessitat d'instal\u00b7lar nous components. A continuaci\u00f3 presentarem tres possibles opcions d'implementaci\u00f3. La classe Paginator de Doctrine En aquest cas crear\u00edem nous m\u00e8todes en el repositori. findAllPaginated crea la consulta i la passa al m\u00e8tode paginate que ser\u00e0 el que far\u00e0 la paginaci\u00f3. El m\u00e8tode paginate ens tornar\u00e0 un objecte Paginator que cont\u00e9 en la propietat Paginator::results els resultats. Ens faltaria obtenir el total de registres la qual cosa \u00e9s ben senzilla ja que la classe Paginator implementa la interf\u00edcie Countable i simplement usant el m\u00e8tode count() obtindrem el total de registres. use Doctrine\\ORM\\Tools\\Pagination\\Paginator ; ... public function findAllPaginated ( $currentPage = 1 ) :? Paginator { $query = $this -> createQueryBuilder ( 'l' ) -> orderBy ( 'l.createdAt' , 'DESC' ) -> getQuery (); // No need to manually get get the result ($query->getResult()) $paginator = $this -> paginate ( $query , $currentPage ); return $paginator ; } // Paginate results. public function paginate ( $dql , $page = 1 , $limit = 5 ) :? Paginator { $paginator = new Paginator ( $dql ); $paginator -> getQuery () -> setFirstResult ( $limit * ( $page - 1 )) // Offset -> setMaxResults ( $limit ); // Limit return $paginator ; } M\u00e9s informaci\u00f3 en Pagination i Symfony and Doctrine pagination with Twig Classe Paginator de symfony/demo Un altra opci\u00f3 \u00e9s fer \u00fas de la classe Paginator que s'utilitza en el projecte d'exemple de Symfony. Empra la classe Paginator de Doctrine i ens proporciona tots els m\u00e8todes necessaris per a fer la paginaci\u00f3. Classe Paginator . Repositori PostRepositori:findLatest . M\u00e8tode BlogController::index() . Plantilla de Twig blog/index.html.twig . knplabs/knp-paginator-bundle Paginator per a Symfony automatitza la paginaci\u00f3 i simplifica l'ordenaci\u00f3 i altres caracter\u00edstiques. En la descripci\u00f3 del paquet knplabs/knp-paginator-bundle obtindreu m\u00e9s informaci\u00f3. Recursos https://anil.io/blog/symfony/doctrine/symfony-and-doctrine-pagination-with-twig/ https://www.drauta.com/como-paginar-los-resultados-con-doctrine https://symfony.com/doc/current/components/http_foundation.html#request http://zetcode.com/symfony/request/","title":"Extrendre els repositoris. Paginaci\u00f3"},{"location":"08-symfony/08-repositoris-paginacio/#extrendre-els-repositoris-paginacio","text":"","title":"Extrendre els repositoris. Paginaci\u00f3"},{"location":"08-symfony/08-repositoris-paginacio/#introduccio","text":"Com ja has vist, l'objecte Repository permet executar consultes senzilles sense pr\u00e0cticament cap treball: // from inside a controller $repository = $em -> getRepository ( Link :: class ); $movies = $repository -> findAll (); Els m\u00e8todes disponibles s\u00f3n els seg\u00fcents: /** * @method Movie|null find($id, $lockMode = null, $lockVersion = null) * @method Movie|null findOneBy(array $criteria, array $orderBy = null) * @method Movie[] findAll() * @method Movie[] findBy(array $criteria, array $orderBy = null, $limit = null, $offset = null) */ Per\u00f2, i si necessitem una consulta m\u00e9s complexa? Quan generem una entitat amb make:entity , el comandament tamb\u00e9 genera una classe anomenada MovieRepository . # src/Repository/MovieRepository.php namespace App\\Repository ; use App\\Entity\\Movie ; use Doctrine\\Bundle\\DoctrineBundle\\Repository\\ServiceEntityRepository ; use Doctrine\\Persistence\\ManagerRegistry ; class MovieRepository extends ServiceEntityRepository { public function __construct ( ManagerRegistry $registry ) { parent :: __construct ( $registry , Movie :: class ); } //... } Quan obtens el repositori (p.e. ->getRepository(Movie::class) ), est\u00e0s obtenint realment una inst\u00e0ncia d'aquest objecte! Anotacions Cal assegurar-se que l'entitat t\u00e9 correctament vinculat el repositori mitjan\u00e7ant una anotaci\u00f3. En el nostre exemple l'entitat Movie haur\u00e0 d'incloure: @ ORM\\Entity ( repositoryClass = \"App \\R epository\\MovieRepository\" )","title":"Introducci\u00f3"},{"location":"08-symfony/08-repositoris-paginacio/#querybuilder","text":"Suposem que vols fer una consulta que obtinga tots els objectes Link amb data posterior a certa data. Hauries d'afegir un nou m\u00e8tode dins del repositori: // src/Repository/MovieRepository.php // ... class MovieRepository extends ServiceEntityRepository { public function __construct ( ManagerRegistry $registry ) { parent :: __construct ( $registry , Product :: class ); } /** * @return Movie[] */ public function findAllAfterDate ( DateTime $date ) : array { $query = $this -> createQueryBuilder ( 'm' ) -> andwhere ( \"m.releaseDate >= :date\" ) -> orderBy ( 'l.releaseDate' , 'DESC' ) -> setParameter ( 'date' , $date ) -> getQuery (); return $query -> getResult (); } Query Builder , \u00e9s una forma orientada a objectes d'escriure consultes. Es recomana utilitzar-la quan les consultes es creen din\u00e0micament. Ara, pots cridar el m\u00e8tode del repositori: // from inside a controller $date = new DateTime ( \"2020-01-01\" ); $movies = $em -> getRepository ( Movie :: class ) -> findAllAfterDate ( $date ); // ...","title":"QueryBuilder"},{"location":"08-symfony/08-repositoris-paginacio/#query","text":"Tamb\u00e9 \u00e9s possible utilitzar l'objecte Query , aix\u00ed com executar consultes directament amb PDO. /** * @return Movie[] */ public function findAllAfterDate ( DateTime $date ) : array { $query = $this -> createQuery ( ' SELECT m FROM App\\Entity\\Movie m WHERE m.releaseDate >= :date ORDER BY m.releaseDate DESC' ) -> setParameter ( 'date' , $date ); return $query -> getResult (); }","title":"Query"},{"location":"08-symfony/08-repositoris-paginacio/#consultes-sql","text":"Aquest tipus de consultes s'executen directament en PDO, fent \u00fas de les classes PDO , PDOStatement . // src/Repository/MovieRepository.php // ... public function findAllAfterDate ( DateTime $date ) : array { // TODO: Revisar com accedir a la connexi\u00f3 $conn = $this -> getEntityManager () -> getConnection (); $sql = ' SELECT * FROM movie m WHERE m.release_date > :date ORDER BY m.release_date DESC ' ; $stmt = $conn -> prepare ( $sql ); $stmt -> execute ([ 'date' => $date ]); // returns an array of arrays (i.e. a raw data set) return $stmt -> fetchAll (); } Aquestes consultes SQL tornen arrays, no objectes (a no ser que uses la funcionalitat NativeQuery ). M\u00e9s informaci\u00f3 en Querying for objects the repository","title":"Consultes SQL"},{"location":"08-symfony/08-repositoris-paginacio/#exemple","text":"En el seg\u00fcent exemple pots observar un \u00fas del nou m\u00e8tode del repositori. Hem modificat la ruta homepage perqu\u00e8 comprove si ha rebut pel querystring el par\u00e0metre start-date si \u00e9s aix\u00ed executar\u00e0 el m\u00e8tode findAllAfterDate() si no cridar\u00e0 findAll() . /** * @Route(\"/\", name=\"homepage\") */ public function index ( Request $request ) { $repo = $this -> getDoctrine () -> getRepository ( Link :: class ); if ( $request -> query -> has ( \"start-date\" )) { $date = new \\DateTime ( $request -> query -> get ( \"start-date\" )); $links = $repo -> findAllAfterDate ( $date ); // TODO: check if the par\u00e0meter start-date is a valid date } else { $links = $repo -> findAll (); } // now pass the array of default object to the view return $this -> render ( 'default/index.html.twig' , [ 'links' => $links , ]); }","title":"Exemple"},{"location":"08-symfony/08-repositoris-paginacio/#paginacio","text":"Symfony no inclou un paginador de forma nativa per\u00f2 al incloure Doctrine permet implementar-ho f\u00e0cilment sense necessitat d'instal\u00b7lar nous components. A continuaci\u00f3 presentarem tres possibles opcions d'implementaci\u00f3.","title":"Paginaci\u00f3"},{"location":"08-symfony/08-repositoris-paginacio/#la-classe-paginator-de-doctrine","text":"En aquest cas crear\u00edem nous m\u00e8todes en el repositori. findAllPaginated crea la consulta i la passa al m\u00e8tode paginate que ser\u00e0 el que far\u00e0 la paginaci\u00f3. El m\u00e8tode paginate ens tornar\u00e0 un objecte Paginator que cont\u00e9 en la propietat Paginator::results els resultats. Ens faltaria obtenir el total de registres la qual cosa \u00e9s ben senzilla ja que la classe Paginator implementa la interf\u00edcie Countable i simplement usant el m\u00e8tode count() obtindrem el total de registres. use Doctrine\\ORM\\Tools\\Pagination\\Paginator ; ... public function findAllPaginated ( $currentPage = 1 ) :? Paginator { $query = $this -> createQueryBuilder ( 'l' ) -> orderBy ( 'l.createdAt' , 'DESC' ) -> getQuery (); // No need to manually get get the result ($query->getResult()) $paginator = $this -> paginate ( $query , $currentPage ); return $paginator ; } // Paginate results. public function paginate ( $dql , $page = 1 , $limit = 5 ) :? Paginator { $paginator = new Paginator ( $dql ); $paginator -> getQuery () -> setFirstResult ( $limit * ( $page - 1 )) // Offset -> setMaxResults ( $limit ); // Limit return $paginator ; } M\u00e9s informaci\u00f3 en Pagination i Symfony and Doctrine pagination with Twig","title":"La classe Paginator de Doctrine"},{"location":"08-symfony/08-repositoris-paginacio/#classe-paginator-de-symfonydemo","text":"Un altra opci\u00f3 \u00e9s fer \u00fas de la classe Paginator que s'utilitza en el projecte d'exemple de Symfony. Empra la classe Paginator de Doctrine i ens proporciona tots els m\u00e8todes necessaris per a fer la paginaci\u00f3. Classe Paginator . Repositori PostRepositori:findLatest . M\u00e8tode BlogController::index() . Plantilla de Twig blog/index.html.twig .","title":"Classe Paginator de symfony/demo"},{"location":"08-symfony/08-repositoris-paginacio/#knplabsknp-paginator-bundle","text":"Paginator per a Symfony automatitza la paginaci\u00f3 i simplifica l'ordenaci\u00f3 i altres caracter\u00edstiques. En la descripci\u00f3 del paquet knplabs/knp-paginator-bundle obtindreu m\u00e9s informaci\u00f3.","title":"knplabs/knp-paginator-bundle"},{"location":"08-symfony/08-repositoris-paginacio/#recursos","text":"https://anil.io/blog/symfony/doctrine/symfony-and-doctrine-pagination-with-twig/ https://www.drauta.com/como-paginar-los-resultados-con-doctrine https://symfony.com/doc/current/components/http_foundation.html#request http://zetcode.com/symfony/request/","title":"Recursos"},{"location":"08-symfony/09-altres-funcionalitats/","text":"Altres funcionalitats. Bundles Pujar arxius El que recomana Symfony \u00e9s treballar amb el component VichUploader Redimensionar imatges Per a redimensionar les imatges podem usar el component LiipImagineBundle . Seguint el seg\u00fcent tutorial: Basic Usage crearem el grup de filtres my_thumb que realitza una miniatura de la imatge afegint-li una vora de color negre. El funcionament \u00e9s senzill: Es crea un un grup de filtres, my_thumb , en l'exemple, on s'indiquen els filtres que s'aplicaran, thumbnail i background en l'exemple. Despr\u00e9s s'utilitza el filtre en les plantilles de Twig: < img src = \" {{ asset ( '/relative/path/to/image.jpg' ) | imagine_filter ( 'my_thumb' ) }} \" /> Combinant-ho amb VichUploader la plantilla quedaria aix\u00ed: < img src = \" {{ vich_uploader_asset ( link , 'imageFile' ) | imagine_filter ( 'my_thumb' ) }} \" alt = \" {{ link.title }} \" /> En els formularis on s'usa VichUploader s'aplica de la seg\u00fcent forma: -> add ( 'imageFile' , VichImageType :: class , [ 'required' => false , 'allow_delete' => true , 'asset_helper' => true , 'imagine_pattern' => 'my_thumb' ]); El que fa LiipImagine \u00e9s crear en un directori temporal els resultats d'aplicar els filtres. Enviament de correu Symfony proporciona una funci\u00f3 d'enviament de correu electr\u00f2nic basat en el popular Swift Mailer. M\u00e9s informaci\u00f3: Sending Emails with Mailer Implementaci\u00f3 d'un formulari de contacte Implementa un formuari de contacte amb els camps nom, correu electr\u00f2nic, assumpte i text que envie la informaci\u00f3 per correu electr\u00f2nic a l'adre\u00e7a del administrador de la web. Frontend: Javascript i CSS Symfony incorpora una llibreria Javascript - anomenada Webpack Encore - que fa que treballar amb CSS i JavaScript siga pura joia. Pots usar-la o no. Tamb\u00e9 pots crear CSS static i arxius JS en el directori /public i despr\u00e9s incloure'l en les plantilles. Webpack Encore \u00e9s una forma senzilla d'integrar Webpack en la teua aplicaci\u00f3. Envolta Webpack, que us proporciona una API neta i potent per agrupar m\u00f2duls JavaScript, pre-processar CSS i JS i recopilar i minificar actius ( assets ). Encore us ofereix un sistema d\u2019actius professionals que \u00e9s una del\u00edcia d\u2019utilitzar. Encore s\u2019inspira en Webpacker i Mix, per\u00f2 es mant\u00e9 en l\u2019esperit de Webpack: utilitzant les seves caracter\u00edstiques, conceptes i convencions de denominaci\u00f3 per a una sensaci\u00f3 familiar. T\u00e9 com a objectiu resoldre els casos d\u2019\u00fas de Webpack m\u00e9s comuns. webpack webpack \u00e9s un empaquetador de m\u00f2duls. El seu objectiu principal \u00e9s agrupar fitxers JavaScript per al seu \u00fas en un navegador, per\u00f2 tamb\u00e9 \u00e9s capa\u00e7 de transformar, agrupar o empaquetar gaireb\u00e9 qualsevol recurs o actiu. Node.js i yarn Cal instal\u00b7lar nodejs i yarn per poder usar Webpack Encore. Node.js \u00e9s un entorn de programaci\u00f3 dissenyat per escriure aplicacions web escalables basat en javascript i yarn \u00e9s un gestor de paquets semblant a composer per\u00f2 orientat al frontend. M\u00e9s informaci\u00f3: Managing CSS and JavaScript Internatizonalitzaci\u00f3 La guia per internacionalitzar aplicacions de Symfony la trobareu en Translations .","title":"Altres funcionalitats. Bundles"},{"location":"08-symfony/09-altres-funcionalitats/#altres-funcionalitats-bundles","text":"","title":"Altres funcionalitats. Bundles"},{"location":"08-symfony/09-altres-funcionalitats/#pujar-arxius","text":"El que recomana Symfony \u00e9s treballar amb el component VichUploader","title":"Pujar arxius"},{"location":"08-symfony/09-altres-funcionalitats/#redimensionar-imatges","text":"Per a redimensionar les imatges podem usar el component LiipImagineBundle . Seguint el seg\u00fcent tutorial: Basic Usage crearem el grup de filtres my_thumb que realitza una miniatura de la imatge afegint-li una vora de color negre. El funcionament \u00e9s senzill: Es crea un un grup de filtres, my_thumb , en l'exemple, on s'indiquen els filtres que s'aplicaran, thumbnail i background en l'exemple. Despr\u00e9s s'utilitza el filtre en les plantilles de Twig: < img src = \" {{ asset ( '/relative/path/to/image.jpg' ) | imagine_filter ( 'my_thumb' ) }} \" /> Combinant-ho amb VichUploader la plantilla quedaria aix\u00ed: < img src = \" {{ vich_uploader_asset ( link , 'imageFile' ) | imagine_filter ( 'my_thumb' ) }} \" alt = \" {{ link.title }} \" /> En els formularis on s'usa VichUploader s'aplica de la seg\u00fcent forma: -> add ( 'imageFile' , VichImageType :: class , [ 'required' => false , 'allow_delete' => true , 'asset_helper' => true , 'imagine_pattern' => 'my_thumb' ]); El que fa LiipImagine \u00e9s crear en un directori temporal els resultats d'aplicar els filtres.","title":"Redimensionar imatges"},{"location":"08-symfony/09-altres-funcionalitats/#enviament-de-correu","text":"Symfony proporciona una funci\u00f3 d'enviament de correu electr\u00f2nic basat en el popular Swift Mailer. M\u00e9s informaci\u00f3: Sending Emails with Mailer Implementaci\u00f3 d'un formulari de contacte Implementa un formuari de contacte amb els camps nom, correu electr\u00f2nic, assumpte i text que envie la informaci\u00f3 per correu electr\u00f2nic a l'adre\u00e7a del administrador de la web.","title":"Enviament de correu"},{"location":"08-symfony/09-altres-funcionalitats/#frontend-javascript-i-css","text":"Symfony incorpora una llibreria Javascript - anomenada Webpack Encore - que fa que treballar amb CSS i JavaScript siga pura joia. Pots usar-la o no. Tamb\u00e9 pots crear CSS static i arxius JS en el directori /public i despr\u00e9s incloure'l en les plantilles. Webpack Encore \u00e9s una forma senzilla d'integrar Webpack en la teua aplicaci\u00f3. Envolta Webpack, que us proporciona una API neta i potent per agrupar m\u00f2duls JavaScript, pre-processar CSS i JS i recopilar i minificar actius ( assets ). Encore us ofereix un sistema d\u2019actius professionals que \u00e9s una del\u00edcia d\u2019utilitzar. Encore s\u2019inspira en Webpacker i Mix, per\u00f2 es mant\u00e9 en l\u2019esperit de Webpack: utilitzant les seves caracter\u00edstiques, conceptes i convencions de denominaci\u00f3 per a una sensaci\u00f3 familiar. T\u00e9 com a objectiu resoldre els casos d\u2019\u00fas de Webpack m\u00e9s comuns. webpack webpack \u00e9s un empaquetador de m\u00f2duls. El seu objectiu principal \u00e9s agrupar fitxers JavaScript per al seu \u00fas en un navegador, per\u00f2 tamb\u00e9 \u00e9s capa\u00e7 de transformar, agrupar o empaquetar gaireb\u00e9 qualsevol recurs o actiu. Node.js i yarn Cal instal\u00b7lar nodejs i yarn per poder usar Webpack Encore. Node.js \u00e9s un entorn de programaci\u00f3 dissenyat per escriure aplicacions web escalables basat en javascript i yarn \u00e9s un gestor de paquets semblant a composer per\u00f2 orientat al frontend. M\u00e9s informaci\u00f3: Managing CSS and JavaScript","title":"Frontend: Javascript i CSS"},{"location":"08-symfony/09-altres-funcionalitats/#internatizonalitzacio","text":"La guia per internacionalitzar aplicacions de Symfony la trobareu en Translations .","title":"Internatizonalitzaci\u00f3"},{"location":"08-symfony/10-bundles/","text":"Els bundles de Symfony Introducci\u00f3 Els bundles en Symfony s\u00f3n elements coneguts com a m\u00f2duls o plugins en altres frameworks. Es defineixen en l'arxiu config/bundles.php per a cada entorn (desenvolupament, producci\u00f3, etc), de manera que poden activar-se nom\u00e9s per a certs entorns. L'exemple m\u00e9s habitual de bundle espec\u00edfic per a un entorn \u00e9s el bundle profiler, que s'encarrega de mostrar la finestra d'error i depuraci\u00f3 cada vegada que es produeix un error en l'aplicaci\u00f3, mostrant el missatge i tra\u00e7a de l'error, usuari autenticat i altres dades que no s\u00f3n recomanables en un entorn de producci\u00f3. Aquest bundle nom\u00e9s est\u00e0 habilitat per a l'entorn de desenvolupament i proves, per\u00f2 no per a producci\u00f3. Bundles preinstal\u00b7lats Si tirem la vista arrere, a la primera sessi\u00f3 del curs, vam veure que existien dues formes de crear un projecte Symfony: composer create - project symfony / website - skeleton project - name composer create - project symfony / skeleton project - name La primera d'elles \u00e9s la que hem usat fins ara, i deixa preinstalado un conjunt de bundles \u00fatils per a desenvolupar una aplicaci\u00f3 web amb Symfony. Entre ells est\u00e0 el motor de plantilles Twig, l'ORM Doctrine i uns altres. Si optem per crear un projecte mitjan\u00e7ant la segona opci\u00f3, obtindrem un projecte sense (quasi) cap funcionalitat afegida. Aquesta forma de definir projectes s'ha habilitat des de Symfony 4 per a donar cabuda a projectes m\u00e9s lleugers, on nom\u00e9s s'instal\u00b7le el necessari. No obstant a\u00e7\u00f2, com ja comentem abans, s'ha deixat disponible l'altra alternativa per a desenvolupar projectes de forma c\u00f2moda, amb moltes funcionalitats preinstaladas, encara que realment algunes no les anem a utilitzar. En qualsevol cas, conv\u00e9 tenir present que totes aqueixes funcionalitats preinstaladas en el nostre projecte, i moltes altres que podem requerir, s\u00f3n bundles o plugins externs al nucli de Symfony. En aquesta sessi\u00f3 veurem com afegir aquests bundles als projectes, i parlarem d'alguns bundles interessants a m\u00e9s dels quals ja hem vist. Instal\u00b7laci\u00f3 de bundles Anem a provar a crear un projecte b\u00e0sic sense esquelet web. Per exemple, veu a la teua carpeta de treball (/home/alumne/symfony) i crea aquest projecte: composer create-project symfony/skeleton prova_bundles Si fas una ullada a l'estructura del projecte, veur\u00e0s que en la carpeta vendor amb prou faenes t\u00e9 un parell d'elements, mentre que aqueixa mateixa carpeta en l'aplicaci\u00f3 de contactes o llibres que hem vingut fent t\u00e9 molts m\u00e9s. Anem a fer ara el mateix que vam fer quan vam crear els projectes de contactes i llibres: configurar Apatxe per a poder accedir al projecte mitjan\u00e7ant un virtual host. Recordem els passos: Edita l'arxiu /etc/hosts (amb permisos de root) per a afegir un nou domini local per a la nostra aplicaci\u00f3. Cridarem a aquest domini symfony.bundles: 127.0.0.1 symfony.bundles Ja tindrem un parell de passos fets de projectes previs: configurar la carpeta /home/alumne/symfony amb els permisos d'acc\u00e9s necessaris per als projectes que tindrem dins, i habilitar la creaci\u00f3 d'hosts virtuals en Apatxe. Aix\u00ed que aquests passos podem saltar-los ara Edita l'arxiu /opt/lampp/etc/extra/httpd\u00advhosts.conf i afig un nou host virtual per a la nostra aplicaci\u00f3. Haur\u00e0 de quedar-te aix\u00ed: \\<VirtualHost *:80> DocumentRoot \"/home/alumne/symfony/prova_bundles/public\" ServerName symfony.bundles Reinicia el servidor Apatxe, i intenta accedir a http://symfony.bundles, per a veure la p\u00e0gina d'inici. . Exemple: Doctrine Anem a fer una prova per a treballar amb Doctrine en el nostre nou projecte. Per a comen\u00e7ar, anem a crear una base de dades anomenada peliculas per a emmagatzemar certa informaci\u00f3 b\u00e0sica de pel\u00b7l\u00edcules. Per a crear la base de dades, editem l'arxiu .env del projecte i definim la URL de connexi\u00f3 a la base de dades, com hem fet per als projectes anteriors: DATABASE_URL=mysql://root\\@127.0.0.1:3306/peliculas i despr\u00e9s, vam crear la base de dades amb el comando: php bin/console doctrine:database:create El que obtindrem en executar aquest comando \u00e9s un missatge d'error en la consola que indica que no troba el comando. Necessitem instal\u00b7lar el bundle Doctrine per a solucionar el problema. En realitat, instal\u00b7larem un bundle anomenat orm\u00adpack, que cont\u00e9 a Doctrine, juntament amb el bundle maker que \u00e9s el que permet generar cert codi autom\u00e0ticament, com per exemple les entitats. Per a a\u00e7\u00f2, escrivim aquests comandos des de la carpeta principal del projecte: composer require symfony/orm-pack composer require symfony/maker-bundle --dev Despr\u00e9s d'aquests passos, editem l'arxiu .env novament, i definim la URL de connexi\u00f3 a la base de dades (\u00e9s possible que s'haja duplicat amb aquesta instal\u00b7laci\u00f3). Despr\u00e9s, tornem a intentar crear la base de dades, i tot funcionar\u00e0 correctament. Intentem ara crear una entitat. En aquest cas, anem a crear una entitat anomenada Pelicula, amb un aneu autogenerado, un t\u00edtol (string) i un any. php bin/console make:entity Class name of the entity to create or update ( i.g. OrangePizza ) : Pelicula New property name ( press to stop adding fields ) : >titule Field type ( enter? to see all types ) [ string ] : string Field length [ 255 ] : >255 Can this field be null in the database ( nullable ) ( yes/no ) \\[ no \\] : >no Add another property? Enter the property name ( or press to stop adding fields ) : >anyo Field type ( enter? to see all types ) [ string ] : >integer Can this field be null in the database ( nullable ) ( yes/no ) \\[ no \\] : >no Add another property? Enter the property name ( or press to stop adding fields ) : Success! A continuaci\u00f3, migramos els canvis a la base de dades: ``` shell php bin/console make:migration php bin/console doctrine:migration:migrate Ja tenim la base de dades creada, amb la seua taula pelicula. Podem inserir ara un parell de pel\u00b7l\u00edcules de prova, a m\u00e0 des de phpMyAdmin: Definim ara un controlador que cerque totes les pel\u00b7l\u00edcules i les mostre en la p\u00e0gina. Creem una classe PeliculaController en la carpeta src/Controller, amb un codi com a est: getDoctrine () - \\ > getRepository ( Pelicula :: class ); \\ $peliculas = \\ $repositori - \\ > findAll (); if ( count ( \\ $peliculas ) \\ > 0 ) { \\ $resultat = \\ \" \\\" ; foreach( \\$ peliculas as \\$ pelicula) \\$ resultat .= \\$ pelicula-\\>getTitulo(). \\\" (\" . \\ $pelicula - \\ > getAnyo () . \\ \")\\<br /\\> \\\" ; return new Response( \\$ resultat); } else { return new Response(\" No s ' han trobat pel\u00b7l\u00edcules\\ \"); } } } ?\\> Abans de comprovar el funcionament, recorda configurar la reescriptura de rutes en l'aplicaci\u00f3, escrivint aquests comandos des de la carpeta principal del projecte: composer config extra.symfony.allow-contrib true composer req symfony/apache-pack Despr\u00e9s ja podrem accedir a movies-symfony/peliculas i veure el llistat en pantalla: En aquest punt, pots realitzar l'Exercici 1 dels proposats al final de la sessi\u00f3. Instal\u00b7laci\u00f3 d'altres bundles coneguts Al llarg d'aquestes sessions de curs hem estat utilitzant certs bundles de Symfony que tamb\u00e9 necessiten ser instal\u00b7lats (es van instal\u00b7lar autom\u00e0ticament a trav\u00e9s del website\u00adskeleton, i per a\u00e7\u00f2 no ens hem percatado). Fem un rep\u00e0s: Per a poder utilitzar anotacions (com l'anotaci\u00f3 \\@Route que emprem per a definir les rutes de l'aplicaci\u00f3), necessitem instal\u00b7lar el bundle annotations. Aquest bundle \u00e9s dels pocs que s'instal\u00b7len en el skeleton b \u00e1sico de Symfony. Encara aix\u00ed, per a instal\u00b7lar-ho manualment si f\u00f3ra el cas, haur\u00edem d'executar el comando: composer require annotations Per a poder emprar el gestor de formularis de Symfony, i crear-los i validar-los mitjan\u00e7ant codi, hem d'instal\u00b7lar els bundles forms i validator, respectivament, d'aquesta manera: composer require symfony/form composer require symfony/validator Per a aplicar la infraestructura de seguretat de Symfony en la nostra aplicaci\u00f3, i poder definir rols, rutes protegides, etc, necessitarem instal\u00b7lar el bundle security, as \u00ed: composer require symfony/security-bundle Per a poder disposar del motor de plantilles Twig , necessitarem instal\u00b7lar-ho tamb\u00e9: composer require twig-bundle Com diem, tots aquests bundles es preinstalan en crear el projecte a partir del website\u00adskeleton, per\u00f2 no estan disponibles (excepte les anotacions), si ho vam crear a partir del skeleton b \u00e1sico. En una secci\u00f3 posterior veurem altres bundles addicionals que puguen resultar-nos \u00fatils, a m\u00e9s d'aquests que ja hem vingut usant. M\u00e9s bundles interessants Ara que ja sabem com crear un projecte quasi buit en Symfony i instal\u00b7lar manualment els bundles que necessitem, vegem alguns bundles addicionals que poden resultar \u00fatils, a m\u00e9s dels quals hem comentat ja, i vingut usant en sessions pr\u00e8vies (Twig, Doctrine, seguretat...). Existeixen diferents webs on poder obtenir informaci\u00f3 d'aquests bundles: packagist.org, un repositori de paquets PHP en general, entre els quals podem trobar nombrosos bundles de Symfony, molts d'ells desenvolupats pel propi equip de Symfony, entre els quals s'inclouen els ja vistos (orm\u00adpack, validator, twig\u00adbundle, etc). knpbundles.com, una web mantinguda per la companyia KNP, que \u00e9s una de les quals m\u00e9s suport donen a Symfony quant a bundles es refereix. En ella trobarem tant bundles desenvolupats per aquesta companyia, com per unes altres, com per exemple FOS (FriendsOfSymfony), un grup de desenvolupament que va comen\u00e7ar formant part de l'equip de KNP, per\u00f2 que despr\u00e9s va decidir desenvolupar bundles sota un espai de noms propi. Exemple: EasyAdmin Vegem com instal\u00b7lar i treballar amb el bundle EasyAdmin. Aquest bundle permet definir de forma autom\u00e0tica un administrador per a gestionar les entitats de la nostra aplicaci\u00f3. La seua instal\u00b7laci\u00f3 \u00e9s molt senzilla, a trav\u00e9s d'aquest comando: composer require admin Despr\u00e9s, hem d'editar l'arxiu config/packages/easy_admin.yaml que s'haur\u00e0 creat, i afegir les entitats que vulguem gestionar: easy_admin : entities : \\# List the entity class name you want to manage - App I a\u00e7\u00f2 \u00e9s tot. Accedint a la URI /admin en la nostra aplicaci\u00f3, podrem gestionar les entitats indicades. Si seguim aquests passos en la nostra aplicaci\u00f3 symfony.bundles, i afegim l'entitat Pelicula com en l'exemple anterior, podem accedir a symfony.bundles/admin i gestionar aquesta taula i els seus elements: Existeixen altres opcions de configuraci\u00f3 del bundle, com per exemple protegir l'acc\u00e9s amb contrasenya i altres opcions. Per a m\u00e9s informaci\u00f3, podeu consultar la documentaci\u00f3 oficial. En aquest punt, pots realitzar l'Exercici 2 dels proposats al final de la sessi\u00f3. Exemple: Jens Segers Date Aquest altre bundle permet treballar amb dates de forma senzilla, convertint cadenes a dates amb un format determinat, establint locals per a diferents localitzacions, fent c\u00e0lculs entre dates, etc. S'instal\u00b7la amb el seg\u00fcent comando: composer require jenssegers/date Despr\u00e9s, n'hi ha prou amb utilitzar la classe Date per a accedir a les seues propietats i m\u00e8todes. Per a provar el seu \u00fas, crearem un nou m\u00e8tode en la nostra classe PeliculaController, associat a la ruta /dates. Dins, crearem la data actual, que mostrarem amb un format determinat per pantalla. Tamb\u00e9 crearem una data a partir d'una cadena de text, i calcularem la difer\u00e8ncia entre aqueixa data i avui. use Jenssegers ; ... / \\ * \\ * \\ * \\ @ Route ( \"/dates\" , name = \"dates\" ) \\ */ public function dates () { D\u00f3na 't::setLocale(' \u00e9s '); \\$avui = D\u00f3na' t :: now (); \\ $naixement = D\u00f3na 't::createFromFormat(' d / m / I ', ' 7 / 4 / 1978 '); \\$diferencia = \\$naixement-\\>timespan(); return new Response(' Avui \u00e9s '. \\$avui-\\>format(' d / m / I '). ''. ' Naixement el '. \\$naixement-\\>format(' d / m / i '). ''. ' Han passat : ' . \\ $difer\u00e8ncia ); } L'eixida ser\u00e0 alguna cosa semblat a a\u00e7\u00f2 (variar\u00e0 depenent de la data actual): Intenta realitzar l'Exercici 3 proposat al final de la sessi\u00f3, de car\u00e0cter opcional. Symfony Flex Symfony Flex \u00e9s una nova forma d'instal\u00b7lar i gestionar components en projectes Symfony, disponible des de la seua versi\u00f3 3.3. Ve a reempla\u00e7ar a l'anterior instal\u00b7lador de Symfony, i al Symfony Standard Edition, que, com comentem en la primera sessi\u00f3 del curs, suposava una instal\u00b7laci\u00f3 molt m\u00e9s extensa i monol\u00edtica del framework. Amb Symfony Flex s'automatitzen algunes tasques habituals, com instal\u00b7lar o desinstal\u00b7lar bundles. De fet, des de Symfony 4 \u00e9s el m\u00e8tode que s'empra per defecte per a aquestes instal\u00b7lacions (encara que el seu \u00fas segueix sent opcional), i ens evita haver d'editar a m\u00e0 l'arxiu config/bundles.php per a donar d'alta els nous bundles instal\u00b7lats, o llevar els que ja no estiguem emprant. Per aquest motiu hem pogut emprar Doctrine en un exemple anterior sense haver hagut de tocar la configuraci\u00f3 del projecte. No entrarem en els detalls sobre els arxius de configuraci\u00f3 i les dades que empra Flex per a gestionar aquestes tasques, ja que no forma part del nucli del curs, per\u00f2 s\u00ed considerem necessari que es conega la seua exist\u00e8ncia per a saber per qu\u00e8 s'autoconfiguran certes coses en els projectes sense que h\u00e0gem d'intervenir. 2.5. Creaci\u00f3 de bundles propis A m\u00e9s d'instal\u00b7lar i utilitzar bundles de tercers, tamb\u00e9 podem elaborar els nostres propis. De fet, fins a l'aparici\u00f3 de Symfony 4 es recomanava que tota l'aplicaci\u00f3 estiguera estructurada en bundles (\u00e9s a dir, que els propis components que desenvolup\u00e0rem per a l'aplicaci\u00f3 tamb\u00e9 anaren bundles), per\u00f2 a partir d'aquesta versi\u00f3 4 ja no es recomana aquesta estructura, i s'indica que els bundles s'empren per a compartir codi entre m\u00faltiples aplicacions. En qualsevol cas, per a crear el nostre bundle hem de seguir una estructura recomanada des de la documentaci\u00f3 oficial de Symfony. La creaci\u00f3 de bundles propis queda fora dels objectius principals del curs, per la qual cosa no la veurem amb detall. A m\u00e9s, existeixen multitud de bundles ja predefinits que permetran cobrir la immensa majoria de les nostres necessitats. En qualsevol cas, ac\u00ed teniu un punt de partida que seguir per a saber m\u00e9s sobre aquest tema. Exercicis 3.1. Exercici 1 Anem a crear un projecte similar al de proves que hem fet en el primer exemple d'aquesta sessi\u00f3. En aquest cas, anem a crear un projecte per a gestionar tasques pendents. El comando de creaci\u00f3 del projecte (des de la nostra carpeta /home/alumne/ symfony) ser\u00e0 aquest: composer create symfony/skeleton tasques Despr\u00e9s, segueix aquests passos: Fes que aquest nou projecte siga accessible des del domini symfony.tasques. Instal\u00b7la Doctrine (bundles orm\u00adpack i maker, com s'ha fet en l'exemple anterior), i crea i connecta amb una base de dades anomenada tasques, editant l'arxiu .env per a a\u00e7\u00f2. Crea una entitat anomenada Tasca amb aquests camps: \u25e6 Un aneu autogenerado \u25e6 La descripci\u00f3 de la tasca (string de 255 car\u00e0cters de longitud, sense nuls) \u25e6 La data de la tasca (tipus d\u00f3na't, sense nuls) \u25e6 La prioritat de la tasca (sencer, sense nuls) Actualitza la base de dades amb aquesta entitat, i crea a m\u00e0 un parell de tasques en ella a trav\u00e9s de phpMyAdmin. Procura que les prioritats tinguen valors entre 1 (ALTA) i 3 (BAIXA), ja que definirem aquest rang en la pr\u00f2xima sessi\u00f3. Crea un controlador en src/Controller anomenat TareaController. Defineix un m\u00e8tode que, en carregar-se la URI /tasques mostre un llistat de les tasques en pantalla, sense un format espec\u00edfic. Recorda configurar la reescriptura de rutes perqu\u00e8 aquesta URI funcione. NOTA : per a mostrar la data com a part d'una cadena, pots utilitzar el m\u00e8tode format del propi objecte DateTime: \\$tasca->getFecha()->format(\"d/m/I\"). 3.2. Exercici 2 Instal\u00b7la el bundle EasyAdmin, configura-ho per a treballar amb l'entitat Tasca i crea amb ell unes quantes tasques m\u00e9s en la base de dades. 3.3. Exercici 3 (opcional) Utilitza el bundle jenssegers/d\u00f3na't en l'aplicaci\u00f3 de tasques, i defineix un nou m\u00e8tode en TareaController amb URI /temps, que indique per a cada tasca de la base de dades quant temps falta perqu\u00e8 finalitze el termini. Per exemple:","title":"Els bundles de Symfony"},{"location":"08-symfony/10-bundles/#els-bundles-de-symfony","text":"","title":"Els bundles de Symfony"},{"location":"08-symfony/10-bundles/#introduccio","text":"Els bundles en Symfony s\u00f3n elements coneguts com a m\u00f2duls o plugins en altres frameworks. Es defineixen en l'arxiu config/bundles.php per a cada entorn (desenvolupament, producci\u00f3, etc), de manera que poden activar-se nom\u00e9s per a certs entorns. L'exemple m\u00e9s habitual de bundle espec\u00edfic per a un entorn \u00e9s el bundle profiler, que s'encarrega de mostrar la finestra d'error i depuraci\u00f3 cada vegada que es produeix un error en l'aplicaci\u00f3, mostrant el missatge i tra\u00e7a de l'error, usuari autenticat i altres dades que no s\u00f3n recomanables en un entorn de producci\u00f3. Aquest bundle nom\u00e9s est\u00e0 habilitat per a l'entorn de desenvolupament i proves, per\u00f2 no per a producci\u00f3.","title":"Introducci\u00f3"},{"location":"08-symfony/10-bundles/#bundles-preinstallats","text":"Si tirem la vista arrere, a la primera sessi\u00f3 del curs, vam veure que existien dues formes de crear un projecte Symfony: composer create - project symfony / website - skeleton project - name composer create - project symfony / skeleton project - name La primera d'elles \u00e9s la que hem usat fins ara, i deixa preinstalado un conjunt de bundles \u00fatils per a desenvolupar una aplicaci\u00f3 web amb Symfony. Entre ells est\u00e0 el motor de plantilles Twig, l'ORM Doctrine i uns altres. Si optem per crear un projecte mitjan\u00e7ant la segona opci\u00f3, obtindrem un projecte sense (quasi) cap funcionalitat afegida. Aquesta forma de definir projectes s'ha habilitat des de Symfony 4 per a donar cabuda a projectes m\u00e9s lleugers, on nom\u00e9s s'instal\u00b7le el necessari. No obstant a\u00e7\u00f2, com ja comentem abans, s'ha deixat disponible l'altra alternativa per a desenvolupar projectes de forma c\u00f2moda, amb moltes funcionalitats preinstaladas, encara que realment algunes no les anem a utilitzar. En qualsevol cas, conv\u00e9 tenir present que totes aqueixes funcionalitats preinstaladas en el nostre projecte, i moltes altres que podem requerir, s\u00f3n bundles o plugins externs al nucli de Symfony. En aquesta sessi\u00f3 veurem com afegir aquests bundles als projectes, i parlarem d'alguns bundles interessants a m\u00e9s dels quals ja hem vist.","title":"Bundles preinstal\u00b7lats"},{"location":"08-symfony/10-bundles/#installacio-de-bundles","text":"Anem a provar a crear un projecte b\u00e0sic sense esquelet web. Per exemple, veu a la teua carpeta de treball (/home/alumne/symfony) i crea aquest projecte: composer create-project symfony/skeleton prova_bundles Si fas una ullada a l'estructura del projecte, veur\u00e0s que en la carpeta vendor amb prou faenes t\u00e9 un parell d'elements, mentre que aqueixa mateixa carpeta en l'aplicaci\u00f3 de contactes o llibres que hem vingut fent t\u00e9 molts m\u00e9s. Anem a fer ara el mateix que vam fer quan vam crear els projectes de contactes i llibres: configurar Apatxe per a poder accedir al projecte mitjan\u00e7ant un virtual host. Recordem els passos: Edita l'arxiu /etc/hosts (amb permisos de root) per a afegir un nou domini local per a la nostra aplicaci\u00f3. Cridarem a aquest domini symfony.bundles: 127.0.0.1 symfony.bundles Ja tindrem un parell de passos fets de projectes previs: configurar la carpeta /home/alumne/symfony amb els permisos d'acc\u00e9s necessaris per als projectes que tindrem dins, i habilitar la creaci\u00f3 d'hosts virtuals en Apatxe. Aix\u00ed que aquests passos podem saltar-los ara Edita l'arxiu /opt/lampp/etc/extra/httpd\u00advhosts.conf i afig un nou host virtual per a la nostra aplicaci\u00f3. Haur\u00e0 de quedar-te aix\u00ed: \\<VirtualHost *:80> DocumentRoot \"/home/alumne/symfony/prova_bundles/public\" ServerName symfony.bundles Reinicia el servidor Apatxe, i intenta accedir a http://symfony.bundles, per a veure la p\u00e0gina d'inici.","title":"Instal\u00b7laci\u00f3 de bundles"},{"location":"08-symfony/10-bundles/#exemple-doctrine","text":"Anem a fer una prova per a treballar amb Doctrine en el nostre nou projecte. Per a comen\u00e7ar, anem a crear una base de dades anomenada peliculas per a emmagatzemar certa informaci\u00f3 b\u00e0sica de pel\u00b7l\u00edcules. Per a crear la base de dades, editem l'arxiu .env del projecte i definim la URL de connexi\u00f3 a la base de dades, com hem fet per als projectes anteriors: DATABASE_URL=mysql://root\\@127.0.0.1:3306/peliculas i despr\u00e9s, vam crear la base de dades amb el comando: php bin/console doctrine:database:create El que obtindrem en executar aquest comando \u00e9s un missatge d'error en la consola que indica que no troba el comando. Necessitem instal\u00b7lar el bundle Doctrine per a solucionar el problema. En realitat, instal\u00b7larem un bundle anomenat orm\u00adpack, que cont\u00e9 a Doctrine, juntament amb el bundle maker que \u00e9s el que permet generar cert codi autom\u00e0ticament, com per exemple les entitats. Per a a\u00e7\u00f2, escrivim aquests comandos des de la carpeta principal del projecte: composer require symfony/orm-pack composer require symfony/maker-bundle --dev Despr\u00e9s d'aquests passos, editem l'arxiu .env novament, i definim la URL de connexi\u00f3 a la base de dades (\u00e9s possible que s'haja duplicat amb aquesta instal\u00b7laci\u00f3). Despr\u00e9s, tornem a intentar crear la base de dades, i tot funcionar\u00e0 correctament. Intentem ara crear una entitat. En aquest cas, anem a crear una entitat anomenada Pelicula, amb un aneu autogenerado, un t\u00edtol (string) i un any. php bin/console make:entity Class name of the entity to create or update ( i.g. OrangePizza ) : Pelicula New property name ( press to stop adding fields ) : >titule Field type ( enter? to see all types ) [ string ] : string Field length [ 255 ] : >255 Can this field be null in the database ( nullable ) ( yes/no ) \\[ no \\] : >no Add another property? Enter the property name ( or press to stop adding fields ) : >anyo Field type ( enter? to see all types ) [ string ] : >integer Can this field be null in the database ( nullable ) ( yes/no ) \\[ no \\] : >no Add another property? Enter the property name ( or press to stop adding fields ) : Success! A continuaci\u00f3, migramos els canvis a la base de dades: ``` shell php bin/console make:migration php bin/console doctrine:migration:migrate Ja tenim la base de dades creada, amb la seua taula pelicula. Podem inserir ara un parell de pel\u00b7l\u00edcules de prova, a m\u00e0 des de phpMyAdmin: Definim ara un controlador que cerque totes les pel\u00b7l\u00edcules i les mostre en la p\u00e0gina. Creem una classe PeliculaController en la carpeta src/Controller, amb un codi com a est: getDoctrine () - \\ > getRepository ( Pelicula :: class ); \\ $peliculas = \\ $repositori - \\ > findAll (); if ( count ( \\ $peliculas ) \\ > 0 ) { \\ $resultat = \\ \" \\\" ; foreach( \\$ peliculas as \\$ pelicula) \\$ resultat .= \\$ pelicula-\\>getTitulo(). \\\" (\" . \\ $pelicula - \\ > getAnyo () . \\ \")\\<br /\\> \\\" ; return new Response( \\$ resultat); } else { return new Response(\" No s ' han trobat pel\u00b7l\u00edcules\\ \"); } } } ?\\> Abans de comprovar el funcionament, recorda configurar la reescriptura de rutes en l'aplicaci\u00f3, escrivint aquests comandos des de la carpeta principal del projecte: composer config extra.symfony.allow-contrib true composer req symfony/apache-pack Despr\u00e9s ja podrem accedir a movies-symfony/peliculas i veure el llistat en pantalla: En aquest punt, pots realitzar l'Exercici 1 dels proposats al final de la sessi\u00f3.","title":". Exemple: Doctrine"},{"location":"08-symfony/10-bundles/#installacio-daltres-bundles-coneguts","text":"Al llarg d'aquestes sessions de curs hem estat utilitzant certs bundles de Symfony que tamb\u00e9 necessiten ser instal\u00b7lats (es van instal\u00b7lar autom\u00e0ticament a trav\u00e9s del website\u00adskeleton, i per a\u00e7\u00f2 no ens hem percatado). Fem un rep\u00e0s: Per a poder utilitzar anotacions (com l'anotaci\u00f3 \\@Route que emprem per a definir les rutes de l'aplicaci\u00f3), necessitem instal\u00b7lar el bundle annotations. Aquest bundle \u00e9s dels pocs que s'instal\u00b7len en el skeleton b \u00e1sico de Symfony. Encara aix\u00ed, per a instal\u00b7lar-ho manualment si f\u00f3ra el cas, haur\u00edem d'executar el comando: composer require annotations Per a poder emprar el gestor de formularis de Symfony, i crear-los i validar-los mitjan\u00e7ant codi, hem d'instal\u00b7lar els bundles forms i validator, respectivament, d'aquesta manera: composer require symfony/form composer require symfony/validator Per a aplicar la infraestructura de seguretat de Symfony en la nostra aplicaci\u00f3, i poder definir rols, rutes protegides, etc, necessitarem instal\u00b7lar el bundle security, as \u00ed: composer require symfony/security-bundle Per a poder disposar del motor de plantilles Twig , necessitarem instal\u00b7lar-ho tamb\u00e9: composer require twig-bundle Com diem, tots aquests bundles es preinstalan en crear el projecte a partir del website\u00adskeleton, per\u00f2 no estan disponibles (excepte les anotacions), si ho vam crear a partir del skeleton b \u00e1sico. En una secci\u00f3 posterior veurem altres bundles addicionals que puguen resultar-nos \u00fatils, a m\u00e9s d'aquests que ja hem vingut usant.","title":"Instal\u00b7laci\u00f3 d'altres bundles coneguts"},{"location":"08-symfony/10-bundles/#mes-bundles-interessants","text":"Ara que ja sabem com crear un projecte quasi buit en Symfony i instal\u00b7lar manualment els bundles que necessitem, vegem alguns bundles addicionals que poden resultar \u00fatils, a m\u00e9s dels quals hem comentat ja, i vingut usant en sessions pr\u00e8vies (Twig, Doctrine, seguretat...). Existeixen diferents webs on poder obtenir informaci\u00f3 d'aquests bundles: packagist.org, un repositori de paquets PHP en general, entre els quals podem trobar nombrosos bundles de Symfony, molts d'ells desenvolupats pel propi equip de Symfony, entre els quals s'inclouen els ja vistos (orm\u00adpack, validator, twig\u00adbundle, etc). knpbundles.com, una web mantinguda per la companyia KNP, que \u00e9s una de les quals m\u00e9s suport donen a Symfony quant a bundles es refereix. En ella trobarem tant bundles desenvolupats per aquesta companyia, com per unes altres, com per exemple FOS (FriendsOfSymfony), un grup de desenvolupament que va comen\u00e7ar formant part de l'equip de KNP, per\u00f2 que despr\u00e9s va decidir desenvolupar bundles sota un espai de noms propi.","title":"M\u00e9s bundles interessants"},{"location":"08-symfony/10-bundles/#exemple-jens-segers-date","text":"Aquest altre bundle permet treballar amb dates de forma senzilla, convertint cadenes a dates amb un format determinat, establint locals per a diferents localitzacions, fent c\u00e0lculs entre dates, etc. S'instal\u00b7la amb el seg\u00fcent comando: composer require jenssegers/date Despr\u00e9s, n'hi ha prou amb utilitzar la classe Date per a accedir a les seues propietats i m\u00e8todes. Per a provar el seu \u00fas, crearem un nou m\u00e8tode en la nostra classe PeliculaController, associat a la ruta /dates. Dins, crearem la data actual, que mostrarem amb un format determinat per pantalla. Tamb\u00e9 crearem una data a partir d'una cadena de text, i calcularem la difer\u00e8ncia entre aqueixa data i avui. use Jenssegers ; ... / \\ * \\ * \\ * \\ @ Route ( \"/dates\" , name = \"dates\" ) \\ */ public function dates () { D\u00f3na 't::setLocale(' \u00e9s '); \\$avui = D\u00f3na' t :: now (); \\ $naixement = D\u00f3na 't::createFromFormat(' d / m / I ', ' 7 / 4 / 1978 '); \\$diferencia = \\$naixement-\\>timespan(); return new Response(' Avui \u00e9s '. \\$avui-\\>format(' d / m / I '). ''. ' Naixement el '. \\$naixement-\\>format(' d / m / i '). ''. ' Han passat : ' . \\ $difer\u00e8ncia ); } L'eixida ser\u00e0 alguna cosa semblat a a\u00e7\u00f2 (variar\u00e0 depenent de la data actual): Intenta realitzar l'Exercici 3 proposat al final de la sessi\u00f3, de car\u00e0cter opcional.","title":"Exemple: Jens Segers Date"},{"location":"08-symfony/10-bundles/#symfony-flex","text":"Symfony Flex \u00e9s una nova forma d'instal\u00b7lar i gestionar components en projectes Symfony, disponible des de la seua versi\u00f3 3.3. Ve a reempla\u00e7ar a l'anterior instal\u00b7lador de Symfony, i al Symfony Standard Edition, que, com comentem en la primera sessi\u00f3 del curs, suposava una instal\u00b7laci\u00f3 molt m\u00e9s extensa i monol\u00edtica del framework. Amb Symfony Flex s'automatitzen algunes tasques habituals, com instal\u00b7lar o desinstal\u00b7lar bundles. De fet, des de Symfony 4 \u00e9s el m\u00e8tode que s'empra per defecte per a aquestes instal\u00b7lacions (encara que el seu \u00fas segueix sent opcional), i ens evita haver d'editar a m\u00e0 l'arxiu config/bundles.php per a donar d'alta els nous bundles instal\u00b7lats, o llevar els que ja no estiguem emprant. Per aquest motiu hem pogut emprar Doctrine en un exemple anterior sense haver hagut de tocar la configuraci\u00f3 del projecte. No entrarem en els detalls sobre els arxius de configuraci\u00f3 i les dades que empra Flex per a gestionar aquestes tasques, ja que no forma part del nucli del curs, per\u00f2 s\u00ed considerem necessari que es conega la seua exist\u00e8ncia per a saber per qu\u00e8 s'autoconfiguran certes coses en els projectes sense que h\u00e0gem d'intervenir. 2.5. Creaci\u00f3 de bundles propis A m\u00e9s d'instal\u00b7lar i utilitzar bundles de tercers, tamb\u00e9 podem elaborar els nostres propis. De fet, fins a l'aparici\u00f3 de Symfony 4 es recomanava que tota l'aplicaci\u00f3 estiguera estructurada en bundles (\u00e9s a dir, que els propis components que desenvolup\u00e0rem per a l'aplicaci\u00f3 tamb\u00e9 anaren bundles), per\u00f2 a partir d'aquesta versi\u00f3 4 ja no es recomana aquesta estructura, i s'indica que els bundles s'empren per a compartir codi entre m\u00faltiples aplicacions. En qualsevol cas, per a crear el nostre bundle hem de seguir una estructura recomanada des de la documentaci\u00f3 oficial de Symfony. La creaci\u00f3 de bundles propis queda fora dels objectius principals del curs, per la qual cosa no la veurem amb detall. A m\u00e9s, existeixen multitud de bundles ja predefinits que permetran cobrir la immensa majoria de les nostres necessitats. En qualsevol cas, ac\u00ed teniu un punt de partida que seguir per a saber m\u00e9s sobre aquest tema. Exercicis 3.1. Exercici 1 Anem a crear un projecte similar al de proves que hem fet en el primer exemple d'aquesta sessi\u00f3. En aquest cas, anem a crear un projecte per a gestionar tasques pendents. El comando de creaci\u00f3 del projecte (des de la nostra carpeta /home/alumne/ symfony) ser\u00e0 aquest: composer create symfony/skeleton tasques Despr\u00e9s, segueix aquests passos: Fes que aquest nou projecte siga accessible des del domini symfony.tasques. Instal\u00b7la Doctrine (bundles orm\u00adpack i maker, com s'ha fet en l'exemple anterior), i crea i connecta amb una base de dades anomenada tasques, editant l'arxiu .env per a a\u00e7\u00f2. Crea una entitat anomenada Tasca amb aquests camps: \u25e6 Un aneu autogenerado \u25e6 La descripci\u00f3 de la tasca (string de 255 car\u00e0cters de longitud, sense nuls) \u25e6 La data de la tasca (tipus d\u00f3na't, sense nuls) \u25e6 La prioritat de la tasca (sencer, sense nuls) Actualitza la base de dades amb aquesta entitat, i crea a m\u00e0 un parell de tasques en ella a trav\u00e9s de phpMyAdmin. Procura que les prioritats tinguen valors entre 1 (ALTA) i 3 (BAIXA), ja que definirem aquest rang en la pr\u00f2xima sessi\u00f3. Crea un controlador en src/Controller anomenat TareaController. Defineix un m\u00e8tode que, en carregar-se la URI /tasques mostre un llistat de les tasques en pantalla, sense un format espec\u00edfic. Recorda configurar la reescriptura de rutes perqu\u00e8 aquesta URI funcione. NOTA : per a mostrar la data com a part d'una cadena, pots utilitzar el m\u00e8tode format del propi objecte DateTime: \\$tasca->getFecha()->format(\"d/m/I\"). 3.2. Exercici 2 Instal\u00b7la el bundle EasyAdmin, configura-ho per a treballar amb l'entitat Tasca i crea amb ell unes quantes tasques m\u00e9s en la base de dades. 3.3. Exercici 3 (opcional) Utilitza el bundle jenssegers/d\u00f3na't en l'aplicaci\u00f3 de tasques, i defineix un nou m\u00e8tode en TareaController amb URI /temps, que indique per a cada tasca de la base de dades quant temps falta perqu\u00e8 finalitze el termini. Per exemple:","title":"Symfony Flex"},{"location":"08-symfony/10-pujada-de-fitxers/","text":"Gesti\u00f3 de la pujada de fitxers En el nostre projecte de pel\u00b7l\u00edcules tenim definida la propistat p\u00f2ster que emmagatzema el nom del fitxer del p\u00f2ster d'una pel\u00b7l\u00edcula, en la seg\u00fcent sessi\u00f3 anem a implementar la gesti\u00f3 de fitxers sense utilitzar ningun bunble de tercer i poder emmagatzemar i mostrar els posters. En la seg\u00fcent sessi\u00f3 aprendr\u00e0s a: * Usar i gestionar les pujades de fitxers. * Crear missatges flash . * Crear par\u00e0metres globals de la aplicaci\u00f3. La classe FileType Per a generar el component de pujada de fitxers d'HTML5 Symfony disposa de la classe FileType , que cal implementar en el formularis. Com que el camp no existir\u00e0 en l'entitat, ja que en l'entitat emmagatzenem sols el nom del fiter cal indicar que ser\u00e0 un camp unmapped perqu\u00e8 Symfony no intente enlla\u00e7ar-lo. -> add ( 'poster' , TextType :: class , [ 'disabled' => true , 'required' => false ]) -> add ( 'posterFile' , FileType :: class , [ 'label' => 'Poster (image file)' , 'required' => false , 'mapped' => false , 'constraints' => [ new Image ([ 'maxSize' => '1024k' , 'mimeTypes' => [ 'image/jpeg' , 'image/jpg' , ],]) ], Com es pot observar hi ha dos camps que fan refer\u00e8ncia al p\u00f2ster: poster de tipus TextType que representa la propietat de la classe Movie , hem indicat que estar\u00e0 deshabilitat perqu\u00e8 s'emplenar\u00e0 autom\u00e0ticament en el controlador. Altra opci\u00f3 possible era definir-lo com a HiddenType per\u00f2 hem optat per un camp de text de sols lectura perqu\u00e8 \u00e9s la forma m\u00e9s senzill per mostar el valor en el formulari d'edici\u00f3. posterFile que ser\u00e0 el quadre de text que ens permetr\u00e0 pujar el fitxer, en el nostre cas una image menor de 1MB i en format jpg . Aquest camp t\u00e9 la propietat mapped igual a false perqu\u00e8 no es troba en l'entitat. Alert Com que en el formulari de creaci\u00f3 l'atribut poster s'enviar\u00e0 buit, hem de llevar la restricci\u00f3 de Assert\\NotNull de l'atribut. Els controladors Per a gestionar la pujada de fitxer cal afegir el seg\u00fcent codi: /** * @Route(\"/movies/create\", name=\"movies_create\") */ public function create ( Request $request ) { ... $form -> handleRequest ( $request ); if ( $form -> isSubmitted () && $form -> isValid ()) { $movie = $form -> getData (); if ( $posterFile = $form [ 'posterFile' ] -> getData ()) { $filename = bin2hex ( random_bytes ( 6 )) . '.' . $posterFile -> guessExtension (); try { $projectDir = $this -> getParameter ( 'kernel.project_dir' ); $posterFile -> move ( $projectDir . '/public/images/posters/' , $filename ); $movie -> setPoster ( $filename ); } catch ( FileException $e ) { $this -> addFlash ( 'danger' , $e -> getMessage () ); return $this -> redirectToRoute ( 'admin' ); } } ... return $this -> redirectToRoute ( 'admin' ); } return $this -> render ( 'movies_create.html.twig' , array ( 'form' => $form -> createView ())); } Obtenim en $posterFile el fitxer pujat des del formulari, recorda que tenia el nom posterFile . Si existeix generem un nom aleatori amb la combinaci\u00f3 de les funcions random_bytes i bin2hex . Amb el m\u00e8tode guessExtension obtenim l'extensi\u00f3 del fitxer. Despr\u00e9s obtenim el directori del projecte i afegim la ruta on volem guardar la imatge en el sistema de fitxers. Amb el m\u00e8tode move movem el fitxer de la seua ubicaci\u00f3 temporal a la carpeta i el nom indicat. Si tot ha funcionat correctament guardem el nom del fitxer a l'entitat $movie->setPoster($filename) . En cas d'haver una excepci\u00f3 escrivim un missatge flash i redigirim al panell de control. Missatges flash Els missatges flaix ja el coneixes, en Symfony, funcionen de la mateixa forma, s'escriuen en una variable de sessi\u00f3 i una vegada s\u00f3n llegits en la p\u00e0gina de dest\u00ed desapareixen. Per exemple: $this -> addFlash ( 'success' , 'Your changes were saved!' ); El primer par\u00e0metre pots qualsevol nom. En el nostre cas, com que usem bootstrap \u00e9s convenient que la etiqueta coincidisca amb les classes preestarblertes: success , danger , warning , info , etc. Canvis en la plantilla base Per a integrar-los en la plantilla base pots usar aquest codi: {% raw %} {# read and display all flash messages #} {% for label , messages in app.flashes %} {% for message in messages %} <div class=\"alert alert- {{ label }} alert-dismissible fade show\" role=\"alert\"> {{ message }} <button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"> <span aria-hidden=\"true\">&times;</span> </button> </div> {% endfor %} {% endfor %} Com es pot observar la variable label , ser\u00e0 la determinar\u00e0 la classe que s'aplicar\u00e0. M\u00e9s informaci\u00f3 en Flash Messages Par\u00e0meters globals Com ja hem vist en les sessions introduct\u00f2ries podem crear par\u00e0metres globlals per poder-los usar des de qualsevol lloc de l'aplicaci\u00f3. Anem a aplicar-ho al directori on es guarden els posters. Definirem un par\u00e0metre posters_directory que indicar\u00e0 quin \u00e9s el directori. parameters : posters_directory : '%kernel.project_dir%/public/images/posters' La variable d'entorn %kernel.project_dir% representa el directori on tenim el nostre projecte Symfony. Ara modificarem el controlador perqu\u00e8 agafe la ruta del par\u00e0metre: ... try { $postersDir = $this -> getParameter ( 'posters_directory' ); $posterFile -> move ( $postersDir , $filename ); $movie -> setPoster ( $filename ); } catch ( FileException $e ) { ... Tamb\u00e9 podem crear par\u00e0metres globals per a usar-los en les plantilles de Twig. Per exemple, per a indicar la ruta p\u00fablica dels p\u00f2sters: # config/packages/twig.yaml twig : ... globals : posters_public_directory : 'images/posters/' I l'usariem aix\u00ed: < img class = \"card-img-top\" src = \" {{ asset ( posters_public_directory ~ movie.poster ) }} \" title = \" {{ movie.title }} \" ></ a > M\u00e9s informaci\u00f3 How to Upload Files Step 14: Accepting Feedback with Forms, Symfony The Fast Track VichUploaderBundle LiipImagineBundle","title":"Gesti\u00f3 de la pujada de fitxers"},{"location":"08-symfony/10-pujada-de-fitxers/#gestio-de-la-pujada-de-fitxers","text":"En el nostre projecte de pel\u00b7l\u00edcules tenim definida la propistat p\u00f2ster que emmagatzema el nom del fitxer del p\u00f2ster d'una pel\u00b7l\u00edcula, en la seg\u00fcent sessi\u00f3 anem a implementar la gesti\u00f3 de fitxers sense utilitzar ningun bunble de tercer i poder emmagatzemar i mostrar els posters. En la seg\u00fcent sessi\u00f3 aprendr\u00e0s a: * Usar i gestionar les pujades de fitxers. * Crear missatges flash . * Crear par\u00e0metres globals de la aplicaci\u00f3.","title":"Gesti\u00f3 de la pujada de fitxers"},{"location":"08-symfony/10-pujada-de-fitxers/#la-classe-filetype","text":"Per a generar el component de pujada de fitxers d'HTML5 Symfony disposa de la classe FileType , que cal implementar en el formularis. Com que el camp no existir\u00e0 en l'entitat, ja que en l'entitat emmagatzenem sols el nom del fiter cal indicar que ser\u00e0 un camp unmapped perqu\u00e8 Symfony no intente enlla\u00e7ar-lo. -> add ( 'poster' , TextType :: class , [ 'disabled' => true , 'required' => false ]) -> add ( 'posterFile' , FileType :: class , [ 'label' => 'Poster (image file)' , 'required' => false , 'mapped' => false , 'constraints' => [ new Image ([ 'maxSize' => '1024k' , 'mimeTypes' => [ 'image/jpeg' , 'image/jpg' , ],]) ], Com es pot observar hi ha dos camps que fan refer\u00e8ncia al p\u00f2ster: poster de tipus TextType que representa la propietat de la classe Movie , hem indicat que estar\u00e0 deshabilitat perqu\u00e8 s'emplenar\u00e0 autom\u00e0ticament en el controlador. Altra opci\u00f3 possible era definir-lo com a HiddenType per\u00f2 hem optat per un camp de text de sols lectura perqu\u00e8 \u00e9s la forma m\u00e9s senzill per mostar el valor en el formulari d'edici\u00f3. posterFile que ser\u00e0 el quadre de text que ens permetr\u00e0 pujar el fitxer, en el nostre cas una image menor de 1MB i en format jpg . Aquest camp t\u00e9 la propietat mapped igual a false perqu\u00e8 no es troba en l'entitat. Alert Com que en el formulari de creaci\u00f3 l'atribut poster s'enviar\u00e0 buit, hem de llevar la restricci\u00f3 de Assert\\NotNull de l'atribut.","title":"La classe FileType"},{"location":"08-symfony/10-pujada-de-fitxers/#els-controladors","text":"Per a gestionar la pujada de fitxer cal afegir el seg\u00fcent codi: /** * @Route(\"/movies/create\", name=\"movies_create\") */ public function create ( Request $request ) { ... $form -> handleRequest ( $request ); if ( $form -> isSubmitted () && $form -> isValid ()) { $movie = $form -> getData (); if ( $posterFile = $form [ 'posterFile' ] -> getData ()) { $filename = bin2hex ( random_bytes ( 6 )) . '.' . $posterFile -> guessExtension (); try { $projectDir = $this -> getParameter ( 'kernel.project_dir' ); $posterFile -> move ( $projectDir . '/public/images/posters/' , $filename ); $movie -> setPoster ( $filename ); } catch ( FileException $e ) { $this -> addFlash ( 'danger' , $e -> getMessage () ); return $this -> redirectToRoute ( 'admin' ); } } ... return $this -> redirectToRoute ( 'admin' ); } return $this -> render ( 'movies_create.html.twig' , array ( 'form' => $form -> createView ())); } Obtenim en $posterFile el fitxer pujat des del formulari, recorda que tenia el nom posterFile . Si existeix generem un nom aleatori amb la combinaci\u00f3 de les funcions random_bytes i bin2hex . Amb el m\u00e8tode guessExtension obtenim l'extensi\u00f3 del fitxer. Despr\u00e9s obtenim el directori del projecte i afegim la ruta on volem guardar la imatge en el sistema de fitxers. Amb el m\u00e8tode move movem el fitxer de la seua ubicaci\u00f3 temporal a la carpeta i el nom indicat. Si tot ha funcionat correctament guardem el nom del fitxer a l'entitat $movie->setPoster($filename) . En cas d'haver una excepci\u00f3 escrivim un missatge flash i redigirim al panell de control.","title":"Els controladors"},{"location":"08-symfony/10-pujada-de-fitxers/#missatges-flash","text":"Els missatges flaix ja el coneixes, en Symfony, funcionen de la mateixa forma, s'escriuen en una variable de sessi\u00f3 i una vegada s\u00f3n llegits en la p\u00e0gina de dest\u00ed desapareixen. Per exemple: $this -> addFlash ( 'success' , 'Your changes were saved!' ); El primer par\u00e0metre pots qualsevol nom. En el nostre cas, com que usem bootstrap \u00e9s convenient que la etiqueta coincidisca amb les classes preestarblertes: success , danger , warning , info , etc.","title":"Missatges flash"},{"location":"08-symfony/10-pujada-de-fitxers/#canvis-en-la-plantilla-base","text":"Per a integrar-los en la plantilla base pots usar aquest codi: {% raw %} {# read and display all flash messages #} {% for label , messages in app.flashes %} {% for message in messages %} <div class=\"alert alert- {{ label }} alert-dismissible fade show\" role=\"alert\"> {{ message }} <button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"> <span aria-hidden=\"true\">&times;</span> </button> </div> {% endfor %} {% endfor %} Com es pot observar la variable label , ser\u00e0 la determinar\u00e0 la classe que s'aplicar\u00e0. M\u00e9s informaci\u00f3 en Flash Messages","title":"Canvis en la plantilla base"},{"location":"08-symfony/10-pujada-de-fitxers/#parameters-globals","text":"Com ja hem vist en les sessions introduct\u00f2ries podem crear par\u00e0metres globlals per poder-los usar des de qualsevol lloc de l'aplicaci\u00f3. Anem a aplicar-ho al directori on es guarden els posters. Definirem un par\u00e0metre posters_directory que indicar\u00e0 quin \u00e9s el directori. parameters : posters_directory : '%kernel.project_dir%/public/images/posters' La variable d'entorn %kernel.project_dir% representa el directori on tenim el nostre projecte Symfony. Ara modificarem el controlador perqu\u00e8 agafe la ruta del par\u00e0metre: ... try { $postersDir = $this -> getParameter ( 'posters_directory' ); $posterFile -> move ( $postersDir , $filename ); $movie -> setPoster ( $filename ); } catch ( FileException $e ) { ... Tamb\u00e9 podem crear par\u00e0metres globals per a usar-los en les plantilles de Twig. Per exemple, per a indicar la ruta p\u00fablica dels p\u00f2sters: # config/packages/twig.yaml twig : ... globals : posters_public_directory : 'images/posters/' I l'usariem aix\u00ed: < img class = \"card-img-top\" src = \" {{ asset ( posters_public_directory ~ movie.poster ) }} \" title = \" {{ movie.title }} \" ></ a >","title":"Par\u00e0meters globals"},{"location":"08-symfony/10-pujada-de-fitxers/#mes-informacio","text":"How to Upload Files Step 14: Accepting Feedback with Forms, Symfony The Fast Track VichUploaderBundle LiipImagineBundle","title":"M\u00e9s informaci\u00f3"},{"location":"08-symfony/11-relacions-molts-a-molts/","text":"Relacions molts a molts Introducci\u00f3 Fins ara hem treballat amb relacions senzilles ManyToOne , molts a una. En la seg\u00fcent sessi\u00f3 anem a implementar una relaci\u00f3 molts a molts ( ManyToMany ) en Doctrine. En el nostre cas volem que els usuaris de l'aplicaci\u00f3 de pel\u00b7l\u00edcules puguen valorar-les de 1 a 5. Aix\u00ed, per reflectir la nova estructura de dades necessitarem crear una relaci\u00f3 N:N entre usuaris i pel\u00b7l\u00edcules. Alert Si a banda de les claus alienes, en la nova taula volem afegir nous camps caldr\u00e0, des del punt de vista de Doctrine, convertir la relaci\u00f3 N:N en dues relacions N:1 amb la taula central de la relaci\u00f3. Aix\u00ed doncs, crearem una nova entitat Rating que a banda de les claus alienes contindr\u00e0 el camp value de tipus enter que emmagatzemar\u00e0 la valoraci\u00f3 de l'usuari per a una pel\u00b7l\u00edcula determinada. Entitat Rating Creem la entitat Rating : php bin/console make:entity Class name of the entity to create or update (e.g. VictoriousPizza): > Rating created: src/Entity/Rating.php created: src/Repository/RatingRepository.php Entity generated! Now let's add some fields! You can always add more fields later manually or by re-running this command. New property name (press <return> to stop adding fields): > user Field type (enter ? to see all types) [string]: > relation What class should this entity be related to?: > User What type of relationship is this? ------------ ------------------------------------------------------------------ Type Description ------------ ------------------------------------------------------------------ ManyToOne Each Rating relates to (has) one User. Each User can relate to (can have) many Rating objects OneToMany Each Rating can relate to (can have) many User objects. Each User relates to (has) one Rating ManyToMany Each Rating can relate to (can have) many User objects. Each User can also relate to (can also have) many Rating objects OneToOne Each Rating relates to (has) exactly one User. Each User also relates to (has) exactly one Rating. ------------ ------------------------------------------------------------------ Relation type? [ManyToOne, OneToMany, ManyToMany, OneToOne]: > ManyToOne Is the Rating.user property allowed to be null (nullable)? (yes/no) [yes]: > no Do you want to add a new property to User so that you can access/update Rating objects from it - e.g. $user->getRatings()? (yes/no) [yes]: > yes A new property will also be added to the User class so that you can access the related Rating objects from it. New field name inside User [ratings]: > ratings Do you want to activate orphanRemoval on your relationship? A Rating is \"orphaned\" when it is removed from its related User. e.g. $user->removeRating($rating) NOTE: If a Rating may *change* from one User to another, answer \"no\". Do you want to automatically delete orphaned App\\Entity\\Rating objects (orphanRemoval)? (yes/no) [no]: > no updated: src/Entity/Rating.php updated: src/Entity/User.php Add another property? Enter the property name (or press <return> to stop adding fields): > movie Field type (enter ? to see all types) [string]: > ManyToOne What class should this entity be related to?: > Movie Is the Rating.movie property allowed to be null (nullable)? (yes/no) [yes]: > no Do you want to add a new property to Movie so that you can access/update Rating objects from it - e.g. $movie->getRatings()? (yes/no) [yes]: > yes A new property will also be added to the Movie class so that you can access the related Rating objects from it. New field name inside Movie [ratings]: > ratings Do you want to activate orphanRemoval on your relationship? A Rating is \"orphaned\" when it is removed from its related Movie. e.g. $movie->removeRating($rating) NOTE: If a Rating may *change* from one Movie to another, answer \"no\". Do you want to automatically delete orphaned App\\Entity\\Rating objects (orphanRemoval)? (yes/no) [no]: > no updated: src/Entity/Rating.php updated: src/Entity/Movie.php Add another property? Enter the property name (or press <return> to stop adding fields): > value Field type (enter ? to see all types) [string]: > integer Can this field be null in the database (nullable) (yes/no) [no]: > no updated: src/Entity/Rating.php Add another property? Enter the property name (or press <return> to stop adding fields): > Success! La nova entitat Rating ser\u00e0 aix\u00ed: namespace App\\Entity ; use App\\Repository\\RatingRepository ; use Doctrine\\ORM\\Mapping as ORM ; /** * @ORM\\Entity(repositoryClass=RatingRepository::class) */ class Rating { /** * @ORM\\Id * @ORM\\GeneratedValue * @ORM\\Column(type=\"integer\") */ private $id ; /** * @ORM\\ManyToOne(targetEntity=User::class, inversedBy=\"ratings\") * @ORM\\JoinColumn(nullable=false) */ private $user ; /** * @ORM\\ManyToOne(targetEntity=Movie::class, inversedBy=\"ratings\") * @ORM\\JoinColumn(nullable=false) */ private $movie ; /** * @ORM\\Column(type=\"integer\") */ private $value ; public function getId () : ? int { return $this -> id ; } public function getUser () : ? User { return $this -> user ; } public function setUser ( ? User $user ) : self { $this -> user = $user ; return $this ; } public function getMovie () : ? Movie { return $this -> movie ; } public function setMovie ( ? Movie $movie ) : self { $this -> movie = $movie ; return $this ; } public function getValue () : ? int { return $this -> value ; } public function setValue ( int $value ) : self { $this -> value = $value ; return $this ; } } Destacar l'argument inversedBy=\"ratings\" que indica quin atribut de la classe relacionada, Movie en l'exemple, podrem usar per tindre totes les valoracions dels usuaris. Ara caldr\u00e0 fer les migracions: public function up ( Schema $schema ) : void { // this up() migration is auto-generated, please modify it to your needs $this -> addSql ( 'CREATE TABLE rating (id INT AUTO_INCREMENT NOT NULL, user_id INT NOT NULL, movie_id INT NOT NULL, value INT NOT NULL, INDEX IDX_D8892622A76ED395 (user_id), INDEX IDX_D88926228F93B6FC (movie_id), PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8mb4 COLLATE `utf8mb4_unicode_ci` ENGINE = InnoDB' ); $this -> addSql ( 'ALTER TABLE rating ADD CONSTRAINT FK_D8892622A76ED395 FOREIGN KEY (user_id) REFERENCES user (id)' ); $this -> addSql ( 'ALTER TABLE rating ADD CONSTRAINT FK_D88926228F93B6FC FOREIGN KEY (movie_id) REFERENCES movie (id)' ); } A banda d'aix\u00f2 caldr\u00e0 afegir una clau \u00fanica sobre els atributs movie i user perqu\u00e8 restringir que un usuari no puga valorar dues vegades la mateixa pel\u00b7l\u00edcula. /* * @Table(name=\"rating\", * uniqueConstraints={ * @UniqueConstraint(name=\"IDX_USER_MOVIE_UNIQUE\", * columns={\"user_id\", \"movie_id\"} * ) * } * ) */ Si observem les refer\u00e8ncies es realitzen als camps de la taula ja que es defineixen sobre la taula relacionada amb l'entitat. Ara crearem el formulari b\u00e0sic per permetre als usuaris valorar pel\u00b7l\u00edcules. Aquest formulari estar\u00e0 en la p\u00e0gina de detall de la pel\u00b7l\u00edcula. // src/Form/RatingType.php class RatingType extends AbstractType { public function buildForm ( FormBuilderInterface $builder , array $options ) { $builder -> add ( 'value' , ChoiceType :: class , [ 'label' => false , 'choices' => [ 1 => 1 , 2 => 2 , 3 => 3 , 4 => 4 , 5 => 5 ], 'placeholder' => 'Select a value' ]) ; } ... } En el formulari sols apareix l'atribut value perqu\u00e8 l'usuari i la pel\u00b7l\u00edcula els obtindrem internament. /** * @Route(\"/movies/{id}\", name=\"movies_show\", requirements={\"id\"=\"\\d+\"}) */ public function show ( Movie $movie , Request $request ) { $user = $this -> getUser (); $ratingRepository = $this -> getDoctrine () -> getRepository ( Rating :: class ); // we find a related rating $ratings = $ratingRepository -> findBy ([ \"movie\" => $movie , \"user\" => $user ]); // if not we created a new one if ( empty ( $ratings )) { $rating = new Rating (); $rating -> setMovie ( $movie ); $rating -> setUser ( $user ); } // if yes we extract the first element from the returned array else $rating = $ratings [ 0 ]; $form = $this -> createForm ( RatingType :: class , $rating ); $form -> handleRequest ( $request ); if ( $form -> isSubmitted () && $form -> isValid ()) { $entityManager = $this -> getDoctrine () -> getManager (); $entityManager -> persist ( $rating ); $entityManager -> flush (); $this -> addFlash ( 'success' , 'Your rating has been saved!' ); } if ( $movie ) { return $this -> render ( 'movies_show.html.twig' , [ 'movie' => $movie , 'form' => $form -> createView () ] ); } } ... } El que fem primer es veure si ja existeix una valoraci\u00f3 de l'usuari d'eixa pel\u00b7l\u00edcula, en cas d'existir la recuperem i si no hi ha en creem una. Amb eixa informaci\u00f3 generem el formulari: {% raw %} {% if app.user %} {{ form_start ( form , { attr : { class : 'form-inline' }} ) }} {{ form_widget ( form ) }} <button type=\"submit\" class=\"btn btn-primary\">Rate!</button> {{ form_end ( form ) }} {% endif %} {% endraw %} El formulari t\u00e9 la classe form-inline perqu\u00e8 aparega tot en una l\u00ednia. Calcular la valoraci\u00f3 per pel\u00b7l\u00edcula El c\u00e0lcul de la mitjana de les valoracions el realitzarem mitjan\u00e7ant un camp calculat, \u00e9s a dir, no el tindrem en la base da dades sin\u00f3 que el calcularem quan siga cridat. Ho farem en l'entitat Movie , afegint el m\u00e8tode getRating() . public function getRating () : ? float { $sum = 0 ; foreach ( $this -> getRatings () as $rating ) { $sum += $rating -> getValue (); } $count = count ( $this -> getRatings ()); if ( empty ( $count )) return null ; return ( $sum / $count ); } Aix\u00ed podrem mostrar la valoraci\u00f3 de cada pel\u00b7l\u00edcula en Twig indicat la propietat rating . {% raw %} <p class=\"text-muted\">Rating: {{ movie.rating }} </p>","title":"Relacions molts a molts"},{"location":"08-symfony/11-relacions-molts-a-molts/#relacions-molts-a-molts","text":"","title":"Relacions molts a molts"},{"location":"08-symfony/11-relacions-molts-a-molts/#introduccio","text":"Fins ara hem treballat amb relacions senzilles ManyToOne , molts a una. En la seg\u00fcent sessi\u00f3 anem a implementar una relaci\u00f3 molts a molts ( ManyToMany ) en Doctrine. En el nostre cas volem que els usuaris de l'aplicaci\u00f3 de pel\u00b7l\u00edcules puguen valorar-les de 1 a 5. Aix\u00ed, per reflectir la nova estructura de dades necessitarem crear una relaci\u00f3 N:N entre usuaris i pel\u00b7l\u00edcules. Alert Si a banda de les claus alienes, en la nova taula volem afegir nous camps caldr\u00e0, des del punt de vista de Doctrine, convertir la relaci\u00f3 N:N en dues relacions N:1 amb la taula central de la relaci\u00f3. Aix\u00ed doncs, crearem una nova entitat Rating que a banda de les claus alienes contindr\u00e0 el camp value de tipus enter que emmagatzemar\u00e0 la valoraci\u00f3 de l'usuari per a una pel\u00b7l\u00edcula determinada.","title":"Introducci\u00f3"},{"location":"08-symfony/11-relacions-molts-a-molts/#entitat-rating","text":"Creem la entitat Rating : php bin/console make:entity Class name of the entity to create or update (e.g. VictoriousPizza): > Rating created: src/Entity/Rating.php created: src/Repository/RatingRepository.php Entity generated! Now let's add some fields! You can always add more fields later manually or by re-running this command. New property name (press <return> to stop adding fields): > user Field type (enter ? to see all types) [string]: > relation What class should this entity be related to?: > User What type of relationship is this? ------------ ------------------------------------------------------------------ Type Description ------------ ------------------------------------------------------------------ ManyToOne Each Rating relates to (has) one User. Each User can relate to (can have) many Rating objects OneToMany Each Rating can relate to (can have) many User objects. Each User relates to (has) one Rating ManyToMany Each Rating can relate to (can have) many User objects. Each User can also relate to (can also have) many Rating objects OneToOne Each Rating relates to (has) exactly one User. Each User also relates to (has) exactly one Rating. ------------ ------------------------------------------------------------------ Relation type? [ManyToOne, OneToMany, ManyToMany, OneToOne]: > ManyToOne Is the Rating.user property allowed to be null (nullable)? (yes/no) [yes]: > no Do you want to add a new property to User so that you can access/update Rating objects from it - e.g. $user->getRatings()? (yes/no) [yes]: > yes A new property will also be added to the User class so that you can access the related Rating objects from it. New field name inside User [ratings]: > ratings Do you want to activate orphanRemoval on your relationship? A Rating is \"orphaned\" when it is removed from its related User. e.g. $user->removeRating($rating) NOTE: If a Rating may *change* from one User to another, answer \"no\". Do you want to automatically delete orphaned App\\Entity\\Rating objects (orphanRemoval)? (yes/no) [no]: > no updated: src/Entity/Rating.php updated: src/Entity/User.php Add another property? Enter the property name (or press <return> to stop adding fields): > movie Field type (enter ? to see all types) [string]: > ManyToOne What class should this entity be related to?: > Movie Is the Rating.movie property allowed to be null (nullable)? (yes/no) [yes]: > no Do you want to add a new property to Movie so that you can access/update Rating objects from it - e.g. $movie->getRatings()? (yes/no) [yes]: > yes A new property will also be added to the Movie class so that you can access the related Rating objects from it. New field name inside Movie [ratings]: > ratings Do you want to activate orphanRemoval on your relationship? A Rating is \"orphaned\" when it is removed from its related Movie. e.g. $movie->removeRating($rating) NOTE: If a Rating may *change* from one Movie to another, answer \"no\". Do you want to automatically delete orphaned App\\Entity\\Rating objects (orphanRemoval)? (yes/no) [no]: > no updated: src/Entity/Rating.php updated: src/Entity/Movie.php Add another property? Enter the property name (or press <return> to stop adding fields): > value Field type (enter ? to see all types) [string]: > integer Can this field be null in the database (nullable) (yes/no) [no]: > no updated: src/Entity/Rating.php Add another property? Enter the property name (or press <return> to stop adding fields): > Success! La nova entitat Rating ser\u00e0 aix\u00ed: namespace App\\Entity ; use App\\Repository\\RatingRepository ; use Doctrine\\ORM\\Mapping as ORM ; /** * @ORM\\Entity(repositoryClass=RatingRepository::class) */ class Rating { /** * @ORM\\Id * @ORM\\GeneratedValue * @ORM\\Column(type=\"integer\") */ private $id ; /** * @ORM\\ManyToOne(targetEntity=User::class, inversedBy=\"ratings\") * @ORM\\JoinColumn(nullable=false) */ private $user ; /** * @ORM\\ManyToOne(targetEntity=Movie::class, inversedBy=\"ratings\") * @ORM\\JoinColumn(nullable=false) */ private $movie ; /** * @ORM\\Column(type=\"integer\") */ private $value ; public function getId () : ? int { return $this -> id ; } public function getUser () : ? User { return $this -> user ; } public function setUser ( ? User $user ) : self { $this -> user = $user ; return $this ; } public function getMovie () : ? Movie { return $this -> movie ; } public function setMovie ( ? Movie $movie ) : self { $this -> movie = $movie ; return $this ; } public function getValue () : ? int { return $this -> value ; } public function setValue ( int $value ) : self { $this -> value = $value ; return $this ; } } Destacar l'argument inversedBy=\"ratings\" que indica quin atribut de la classe relacionada, Movie en l'exemple, podrem usar per tindre totes les valoracions dels usuaris. Ara caldr\u00e0 fer les migracions: public function up ( Schema $schema ) : void { // this up() migration is auto-generated, please modify it to your needs $this -> addSql ( 'CREATE TABLE rating (id INT AUTO_INCREMENT NOT NULL, user_id INT NOT NULL, movie_id INT NOT NULL, value INT NOT NULL, INDEX IDX_D8892622A76ED395 (user_id), INDEX IDX_D88926228F93B6FC (movie_id), PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8mb4 COLLATE `utf8mb4_unicode_ci` ENGINE = InnoDB' ); $this -> addSql ( 'ALTER TABLE rating ADD CONSTRAINT FK_D8892622A76ED395 FOREIGN KEY (user_id) REFERENCES user (id)' ); $this -> addSql ( 'ALTER TABLE rating ADD CONSTRAINT FK_D88926228F93B6FC FOREIGN KEY (movie_id) REFERENCES movie (id)' ); } A banda d'aix\u00f2 caldr\u00e0 afegir una clau \u00fanica sobre els atributs movie i user perqu\u00e8 restringir que un usuari no puga valorar dues vegades la mateixa pel\u00b7l\u00edcula. /* * @Table(name=\"rating\", * uniqueConstraints={ * @UniqueConstraint(name=\"IDX_USER_MOVIE_UNIQUE\", * columns={\"user_id\", \"movie_id\"} * ) * } * ) */ Si observem les refer\u00e8ncies es realitzen als camps de la taula ja que es defineixen sobre la taula relacionada amb l'entitat. Ara crearem el formulari b\u00e0sic per permetre als usuaris valorar pel\u00b7l\u00edcules. Aquest formulari estar\u00e0 en la p\u00e0gina de detall de la pel\u00b7l\u00edcula. // src/Form/RatingType.php class RatingType extends AbstractType { public function buildForm ( FormBuilderInterface $builder , array $options ) { $builder -> add ( 'value' , ChoiceType :: class , [ 'label' => false , 'choices' => [ 1 => 1 , 2 => 2 , 3 => 3 , 4 => 4 , 5 => 5 ], 'placeholder' => 'Select a value' ]) ; } ... } En el formulari sols apareix l'atribut value perqu\u00e8 l'usuari i la pel\u00b7l\u00edcula els obtindrem internament. /** * @Route(\"/movies/{id}\", name=\"movies_show\", requirements={\"id\"=\"\\d+\"}) */ public function show ( Movie $movie , Request $request ) { $user = $this -> getUser (); $ratingRepository = $this -> getDoctrine () -> getRepository ( Rating :: class ); // we find a related rating $ratings = $ratingRepository -> findBy ([ \"movie\" => $movie , \"user\" => $user ]); // if not we created a new one if ( empty ( $ratings )) { $rating = new Rating (); $rating -> setMovie ( $movie ); $rating -> setUser ( $user ); } // if yes we extract the first element from the returned array else $rating = $ratings [ 0 ]; $form = $this -> createForm ( RatingType :: class , $rating ); $form -> handleRequest ( $request ); if ( $form -> isSubmitted () && $form -> isValid ()) { $entityManager = $this -> getDoctrine () -> getManager (); $entityManager -> persist ( $rating ); $entityManager -> flush (); $this -> addFlash ( 'success' , 'Your rating has been saved!' ); } if ( $movie ) { return $this -> render ( 'movies_show.html.twig' , [ 'movie' => $movie , 'form' => $form -> createView () ] ); } } ... } El que fem primer es veure si ja existeix una valoraci\u00f3 de l'usuari d'eixa pel\u00b7l\u00edcula, en cas d'existir la recuperem i si no hi ha en creem una. Amb eixa informaci\u00f3 generem el formulari: {% raw %} {% if app.user %} {{ form_start ( form , { attr : { class : 'form-inline' }} ) }} {{ form_widget ( form ) }} <button type=\"submit\" class=\"btn btn-primary\">Rate!</button> {{ form_end ( form ) }} {% endif %} {% endraw %} El formulari t\u00e9 la classe form-inline perqu\u00e8 aparega tot en una l\u00ednia.","title":"Entitat Rating"},{"location":"08-symfony/11-relacions-molts-a-molts/#calcular-la-valoracio-per-pellicula","text":"El c\u00e0lcul de la mitjana de les valoracions el realitzarem mitjan\u00e7ant un camp calculat, \u00e9s a dir, no el tindrem en la base da dades sin\u00f3 que el calcularem quan siga cridat. Ho farem en l'entitat Movie , afegint el m\u00e8tode getRating() . public function getRating () : ? float { $sum = 0 ; foreach ( $this -> getRatings () as $rating ) { $sum += $rating -> getValue (); } $count = count ( $this -> getRatings ()); if ( empty ( $count )) return null ; return ( $sum / $count ); } Aix\u00ed podrem mostrar la valoraci\u00f3 de cada pel\u00b7l\u00edcula en Twig indicat la propietat rating . {% raw %} <p class=\"text-muted\">Rating: {{ movie.rating }} </p>","title":"Calcular la valoraci\u00f3 per pel\u00b7l\u00edcula"},{"location":"08-symfony/13-creaci%C3%B3-api-b%C3%A0sica/","text":"Creaci\u00f3 d'una API b\u00e0sica amb Symfony Abans d'entrar en mat\u00e8ria alguns conceptes: * Serialitzar . La serialitzaci\u00f3 \u00e9s el proc\u00e9s de convertir un objecte en una altre format per a emmagatzemar-lo o transmetre'l i posteriorment ser decodificat. * Normalitzar. Ajuden en el proc\u00e9s de serialitzaci\u00f3, convertint els objectes en un element intermig, com pot ser una array. El seg\u00fcent codi genera una API en la aplicaci\u00f3 de pel\u00b7l\u00edcules: ** * @ Route ( \"/api/v1/movies\" ) */ class ApiController extends AbstractController { /** * @Route(\"/\", name=\"api_movies_links\", methods={\"GET\"}) * @param Request $request * @param MovieRepository $movieRepository * @return JsonResponse */ public function index ( Request $request , MovieRepository $movieRepository ) : JsonResponse { $movies = $movieRepository -> findAll (); return new JsonResponse ( $movies , Response :: HTTP_OK ); } /** * @Route(\"/{id}\", name=\"api_moives_show\", methods={\"GET\"}) * @param Request $request * @return JsonResponse */ public function show ( Request $request , ? Movie $movie ) : JsonResponse { if ( ! empty ( $movie )) return new JsonResponse ( $movie , Response :: HTTP_OK ); else return new JsonResponse ( \"error\" , Response :: HTTP_NOT_FOUND ); } /** * * @Route(\"/\", name=\"api_movies_create\", methods={\"POST\"}) */ public function create ( Request $request ) : JsonResponse { $movie = new Movie (); $data = []; if ( $content = $request -> getContent ()) { $data = json_decode ( $content , true ); } try { $movie -> setTitle ( $data [ \"title\" ]); $movie -> setOverview ( $data [ \"overview\" ]); $movie -> setTagline ( $data [ \"tagline\" ]); $movie -> setPoster ( $data [ \"poster\" ]); $movie -> setReleaseDate ( new \\DateTime ( $data [ \"release_date\" ])); } catch ( \\Exception $e ) { $error [ \"code\" ] = $e -> getCode (); $error [ \"message\" ] = $e -> getMessage (); return new JsonResponse ( $error , Response :: HTTP_BAD_REQUEST ); } $em = $this -> getDoctrine () -> getManager (); $em -> persist ( $movie ); $em -> flush (); return new JsonResponse ( $movie , Response :: HTTP_CREATED ); } } Nelmio FOSRESTBundle ApiPlatform Recursos En Primeros pasos con Symfony 5 como API REST es genera una API basada en els mateixos components que hem utilitzat. En Getting started REST API with Symfony 4 s'utilitzen diversos components addicionals com el Fos-Rest-Bundle i JMS Serializer. En Curso de Symfony 5. Creando una API desde cero teniu un curs molt complet sobre com crear una API en Symfony 5 des de cero. API Platform \u00e9s un framework que permet crear API de forma quasi autom\u00e0tica en Symfony.","title":"12. Creaci\u00f3 d'una API b\u00e0sica amb Symfony"},{"location":"08-symfony/13-creaci%C3%B3-api-b%C3%A0sica/#creacio-duna-api-basica-amb-symfony","text":"Abans d'entrar en mat\u00e8ria alguns conceptes: * Serialitzar . La serialitzaci\u00f3 \u00e9s el proc\u00e9s de convertir un objecte en una altre format per a emmagatzemar-lo o transmetre'l i posteriorment ser decodificat. * Normalitzar. Ajuden en el proc\u00e9s de serialitzaci\u00f3, convertint els objectes en un element intermig, com pot ser una array. El seg\u00fcent codi genera una API en la aplicaci\u00f3 de pel\u00b7l\u00edcules: ** * @ Route ( \"/api/v1/movies\" ) */ class ApiController extends AbstractController { /** * @Route(\"/\", name=\"api_movies_links\", methods={\"GET\"}) * @param Request $request * @param MovieRepository $movieRepository * @return JsonResponse */ public function index ( Request $request , MovieRepository $movieRepository ) : JsonResponse { $movies = $movieRepository -> findAll (); return new JsonResponse ( $movies , Response :: HTTP_OK ); } /** * @Route(\"/{id}\", name=\"api_moives_show\", methods={\"GET\"}) * @param Request $request * @return JsonResponse */ public function show ( Request $request , ? Movie $movie ) : JsonResponse { if ( ! empty ( $movie )) return new JsonResponse ( $movie , Response :: HTTP_OK ); else return new JsonResponse ( \"error\" , Response :: HTTP_NOT_FOUND ); } /** * * @Route(\"/\", name=\"api_movies_create\", methods={\"POST\"}) */ public function create ( Request $request ) : JsonResponse { $movie = new Movie (); $data = []; if ( $content = $request -> getContent ()) { $data = json_decode ( $content , true ); } try { $movie -> setTitle ( $data [ \"title\" ]); $movie -> setOverview ( $data [ \"overview\" ]); $movie -> setTagline ( $data [ \"tagline\" ]); $movie -> setPoster ( $data [ \"poster\" ]); $movie -> setReleaseDate ( new \\DateTime ( $data [ \"release_date\" ])); } catch ( \\Exception $e ) { $error [ \"code\" ] = $e -> getCode (); $error [ \"message\" ] = $e -> getMessage (); return new JsonResponse ( $error , Response :: HTTP_BAD_REQUEST ); } $em = $this -> getDoctrine () -> getManager (); $em -> persist ( $movie ); $em -> flush (); return new JsonResponse ( $movie , Response :: HTTP_CREATED ); } }","title":"Creaci\u00f3 d'una API b\u00e0sica amb Symfony"},{"location":"08-symfony/13-creaci%C3%B3-api-b%C3%A0sica/#nelmio","text":"","title":"Nelmio"},{"location":"08-symfony/13-creaci%C3%B3-api-b%C3%A0sica/#fosrestbundle","text":"","title":"FOSRESTBundle"},{"location":"08-symfony/13-creaci%C3%B3-api-b%C3%A0sica/#apiplatform","text":"","title":"ApiPlatform"},{"location":"08-symfony/13-creaci%C3%B3-api-b%C3%A0sica/#recursos","text":"En Primeros pasos con Symfony 5 como API REST es genera una API basada en els mateixos components que hem utilitzat. En Getting started REST API with Symfony 4 s'utilitzen diversos components addicionals com el Fos-Rest-Bundle i JMS Serializer. En Curso de Symfony 5. Creando una API desde cero teniu un curs molt complet sobre com crear una API en Symfony 5 des de cero. API Platform \u00e9s un framework que permet crear API de forma quasi autom\u00e0tica en Symfony.","title":"Recursos"},{"location":"08-symfony/14-fixtures-bundle/","text":"Doctrine Fixtures Bundle Els fixtures s'utilitzen per carregar un conjunt de dades \"fals\" en una base de dades que despr\u00e9s es pot utilitzar per provar o per ajudar-vos a donar-vos dades interessants mentre desenvolupeu la vostra aplicaci\u00f3. Aquest paquet \u00e9s compatible amb qualsevol base de dades suportada per Doctrine ORM (MySQL, PostgreSQL, SQLite, etc.). Instal\u00b7laci\u00f3 composer require --dev orm-fixtures Escriure Fixtures // src/DataFixtures/AppFixtures.php namespace App\\DataFixtures ; use App\\Entity\\Movie ; use Doctrine\\Bundle\\FixturesBundle\\Fixture ; use Doctrine\\Persistence\\ObjectManager ; class AppFixtures extends Fixture { public function load ( ObjectManager $manager ) { // create 20 movies! Bam! for ( $i = 0 ; $i < 20 ; $i ++ ) { $movie = new Movie (); $movie -> setTitle ( 'Movie ' . $i ); $movie -> setReleaseDate ( new \\DateTime ()); .... $manager -> persist ( $movie ); } $manager -> flush (); } } Fixtures que accedeixen a serveis En alguns casos \u00e9s possible que h\u00e0geu d'accedir als serveis de la vostra aplicaci\u00f3 dins d'un fixture . Cap problema! La teua classe \u00e9s un servei, aix\u00ed que pots utilitzar la injecci\u00f3 normal de depend\u00e8ncia: // src/DataFixtures/AppFixtures.php use Symfony\\Component\\PasswordHasher\\Hasher\\UserPasswordHasherInterface ; class AppFixtures extends Fixture { private UserPasswordHasherInterface $hasher ; public function __construct ( UserPasswordHasherInterface $hasher ) { $this -> hasher = $hasher ; } // ... public function load ( ObjectManager $manager ) { // Usuari amb rol d'administrador $user = new User (); $user -> setUsername ( 'admin' ); $password = $this -> hasher -> hashPassword ( $user , 'admin' ); $user -> setPassword ( $password ); $user -> setRole ( \"ROLE_ADMIN\" ); $manager -> persist ( $user ); // Usuari amb rol d'usuari $user = new User (); $user -> setUsername ( 'user' ); $password = $this -> hasher -> hashPassword ( $user , 'user' ); $user -> setPassword ( $password ); $user -> setRole ( \"ROLE_USER\" ); $manager -> persist ( $user ); // apliquem els canvis a la base de dades $manager -> flush (); } } En aquest cas hem injectat la classe UserPasswordHasherInterface per poder aplicar una funci\u00f3-resum ( hash ) a les contrasenyes abans d'emmagatzemar-les. Carregant les Fixtures php bin/console doctrine:fixtures:load Danger Per defecte l'ordre load esborra les dades de totes les taules. Per afegir les dades afig l'opci\u00f3 --append . M\u00e9s informaci\u00f3 en DoctrineFixturesBundle en la documentaci\u00f3 oficial de Symfony. FakerPHP/Faker Faker \u00e9s una biblioteca PHP que genera dades falses per a tu. Tant si necessiteu arrancar la vostra base de dades, crear documents XML atractius, omplir la vostra capa de persist\u00e8ncia per provar-la d'estr\u00e8s o anonimitzar les dades extretes d'un servei de producci\u00f3, Faker \u00e9s per a vosaltres. Instal\u00b7laci\u00f3 composer require fakerphp / faker -- dev Info Recorda que usem el par\u00e0metre --dev per a aquells components que necessitem \u00fanicament en l'entorn de desenvolupament. \u00das # src/DataFixtures/AppFixtures.php namespace App\\DataFixtures ; ... use Doctrine\\Persistence\\ObjectManager ; use Faker\\Factory ; use Faker\\Generator ; use Symfony\\Component\\PasswordHasher\\Hasher\\UserPasswordHasherInterface ; class AppFixtures extends Fixture { private UserPasswordHasherInterface $hasher ; private Generator $faker ; public function __construct ( UserPasswordHasherInterface $hasher ) { $this -> hasher = $hasher ; $this -> faker = Factory :: create (); } ... public function load ( ObjectManager $manager ) : void { //guarde en un array els g\u00e8neres per despr\u00e9s poder-los assignar a les pel\u00b7l\u00edcules. $genres = []; // G\u00e9neres for ( $i = 0 ; $i < 4 ; $i ++ ) { $genre = new Genre (); $genre -> setName ( $this -> faker -> word ()); $manager -> persist ( $genre ); $genres [] = $genre ; } $manager -> flush (); for ( $i = 0 ; $i < 14 ; $i ++ ) { $movie = new Movie (); $movie -> setTitle ( ucwords ( $this -> faker -> words ( 3 , true ))); $movie -> setOverview ( $this -> faker -> text ( 500 )); $movie -> setReleaseDate ( $this -> faker -> dateTime ); $movie -> setPoster ( $this -> faker -> file ( 'assets' , 'public/images' , false )); $movie -> setGenre ( $genres [ \\array_rand ( $genres )]); $manager -> persist ( $movie ); } $manager -> flush (); ... } } En el codi anterior hi ha diversos exemples d'\u00fas, del context es pot extreure la seua funcionalitat. En la documentaci\u00f3 ofical de Faker trobareu m\u00e9s informaci\u00f3.","title":"Doctrine Fixtures Bundle"},{"location":"08-symfony/14-fixtures-bundle/#doctrine-fixtures-bundle","text":"Els fixtures s'utilitzen per carregar un conjunt de dades \"fals\" en una base de dades que despr\u00e9s es pot utilitzar per provar o per ajudar-vos a donar-vos dades interessants mentre desenvolupeu la vostra aplicaci\u00f3. Aquest paquet \u00e9s compatible amb qualsevol base de dades suportada per Doctrine ORM (MySQL, PostgreSQL, SQLite, etc.).","title":"Doctrine Fixtures Bundle"},{"location":"08-symfony/14-fixtures-bundle/#installacio","text":"composer require --dev orm-fixtures","title":"Instal\u00b7laci\u00f3"},{"location":"08-symfony/14-fixtures-bundle/#escriure-fixtures","text":"// src/DataFixtures/AppFixtures.php namespace App\\DataFixtures ; use App\\Entity\\Movie ; use Doctrine\\Bundle\\FixturesBundle\\Fixture ; use Doctrine\\Persistence\\ObjectManager ; class AppFixtures extends Fixture { public function load ( ObjectManager $manager ) { // create 20 movies! Bam! for ( $i = 0 ; $i < 20 ; $i ++ ) { $movie = new Movie (); $movie -> setTitle ( 'Movie ' . $i ); $movie -> setReleaseDate ( new \\DateTime ()); .... $manager -> persist ( $movie ); } $manager -> flush (); } }","title":"Escriure Fixtures"},{"location":"08-symfony/14-fixtures-bundle/#fixtures-que-accedeixen-a-serveis","text":"En alguns casos \u00e9s possible que h\u00e0geu d'accedir als serveis de la vostra aplicaci\u00f3 dins d'un fixture . Cap problema! La teua classe \u00e9s un servei, aix\u00ed que pots utilitzar la injecci\u00f3 normal de depend\u00e8ncia: // src/DataFixtures/AppFixtures.php use Symfony\\Component\\PasswordHasher\\Hasher\\UserPasswordHasherInterface ; class AppFixtures extends Fixture { private UserPasswordHasherInterface $hasher ; public function __construct ( UserPasswordHasherInterface $hasher ) { $this -> hasher = $hasher ; } // ... public function load ( ObjectManager $manager ) { // Usuari amb rol d'administrador $user = new User (); $user -> setUsername ( 'admin' ); $password = $this -> hasher -> hashPassword ( $user , 'admin' ); $user -> setPassword ( $password ); $user -> setRole ( \"ROLE_ADMIN\" ); $manager -> persist ( $user ); // Usuari amb rol d'usuari $user = new User (); $user -> setUsername ( 'user' ); $password = $this -> hasher -> hashPassword ( $user , 'user' ); $user -> setPassword ( $password ); $user -> setRole ( \"ROLE_USER\" ); $manager -> persist ( $user ); // apliquem els canvis a la base de dades $manager -> flush (); } } En aquest cas hem injectat la classe UserPasswordHasherInterface per poder aplicar una funci\u00f3-resum ( hash ) a les contrasenyes abans d'emmagatzemar-les.","title":"Fixtures que accedeixen a serveis"},{"location":"08-symfony/14-fixtures-bundle/#carregant-les-fixtures","text":"php bin/console doctrine:fixtures:load Danger Per defecte l'ordre load esborra les dades de totes les taules. Per afegir les dades afig l'opci\u00f3 --append . M\u00e9s informaci\u00f3 en DoctrineFixturesBundle en la documentaci\u00f3 oficial de Symfony.","title":"Carregant les Fixtures"},{"location":"08-symfony/14-fixtures-bundle/#fakerphpfaker","text":"Faker \u00e9s una biblioteca PHP que genera dades falses per a tu. Tant si necessiteu arrancar la vostra base de dades, crear documents XML atractius, omplir la vostra capa de persist\u00e8ncia per provar-la d'estr\u00e8s o anonimitzar les dades extretes d'un servei de producci\u00f3, Faker \u00e9s per a vosaltres.","title":"FakerPHP/Faker"},{"location":"08-symfony/14-fixtures-bundle/#installacio_1","text":"composer require fakerphp / faker -- dev Info Recorda que usem el par\u00e0metre --dev per a aquells components que necessitem \u00fanicament en l'entorn de desenvolupament.","title":"Instal\u00b7laci\u00f3"},{"location":"08-symfony/14-fixtures-bundle/#us","text":"# src/DataFixtures/AppFixtures.php namespace App\\DataFixtures ; ... use Doctrine\\Persistence\\ObjectManager ; use Faker\\Factory ; use Faker\\Generator ; use Symfony\\Component\\PasswordHasher\\Hasher\\UserPasswordHasherInterface ; class AppFixtures extends Fixture { private UserPasswordHasherInterface $hasher ; private Generator $faker ; public function __construct ( UserPasswordHasherInterface $hasher ) { $this -> hasher = $hasher ; $this -> faker = Factory :: create (); } ... public function load ( ObjectManager $manager ) : void { //guarde en un array els g\u00e8neres per despr\u00e9s poder-los assignar a les pel\u00b7l\u00edcules. $genres = []; // G\u00e9neres for ( $i = 0 ; $i < 4 ; $i ++ ) { $genre = new Genre (); $genre -> setName ( $this -> faker -> word ()); $manager -> persist ( $genre ); $genres [] = $genre ; } $manager -> flush (); for ( $i = 0 ; $i < 14 ; $i ++ ) { $movie = new Movie (); $movie -> setTitle ( ucwords ( $this -> faker -> words ( 3 , true ))); $movie -> setOverview ( $this -> faker -> text ( 500 )); $movie -> setReleaseDate ( $this -> faker -> dateTime ); $movie -> setPoster ( $this -> faker -> file ( 'assets' , 'public/images' , false )); $movie -> setGenre ( $genres [ \\array_rand ( $genres )]); $manager -> persist ( $movie ); } $manager -> flush (); ... } } En el codi anterior hi ha diversos exemples d'\u00fas, del context es pot extreure la seua funcionalitat. En la documentaci\u00f3 ofical de Faker trobareu m\u00e9s informaci\u00f3.","title":"\u00das"},{"location":"08-symfony/15-unit-testing/","text":"Unit testing en Symfony Introducci\u00f3 Symfony inclou una recepta que integra en el framework diferents ferramentes per a realitzar proves tant per a proves unit\u00e0ries (PHPUnit) com per a proves d'integraci\u00f3 i proves d'aplicaci\u00f3, com Panther i DOM crawler. En aquesta secci\u00f3 parlarem de les proves unit\u00e0ries. La secci\u00f3 Test de la documentaci\u00f3 de Symfony \u00e9s un bon lloc per on comen\u00e7ar.","title":"_Unit testing_ en Symfony"},{"location":"08-symfony/15-unit-testing/#unit-testing-en-symfony","text":"","title":"Unit testing en Symfony"},{"location":"08-symfony/15-unit-testing/#introduccio","text":"Symfony inclou una recepta que integra en el framework diferents ferramentes per a realitzar proves tant per a proves unit\u00e0ries (PHPUnit) com per a proves d'integraci\u00f3 i proves d'aplicaci\u00f3, com Panther i DOM crawler. En aquesta secci\u00f3 parlarem de les proves unit\u00e0ries. La secci\u00f3 Test de la documentaci\u00f3 de Symfony \u00e9s un bon lloc per on comen\u00e7ar.","title":"Introducci\u00f3"},{"location":"08-symfony/15-unit-testing/#_1","text":"","title":""},{"location":"08-symfony/99-activitats/","text":"Activitats Introducci\u00f3 Entorn de desenvolupament Despr\u00e9s dels tres primers apartats de la primera sessi\u00f3, ja hauries de tenir operativa la m\u00e0quina virtual amb XAMPP i Composer instal\u00b7lats. En qualsevol dels dos casos, i per a verificar que la teua instal\u00b7laci\u00f3 \u00e9s correcta abans de continuar, es demana que realitzes dues captures de pantalla: Engega Apache i MySQL des del manager de XAMPP, accedeix amb Firefox a la URL http://localhost i captura la pantalla que mostra el navegador. Guarda-la en un arxiu anomenat \"xampp.png\". Des d'un terminal, executa el comando: composer --version i fes captura on es veja la versi\u00f3 de Composer que tens instal\u00b7lada. Guarda-ho en \"composer.png\". El patr\u00f3 MVC Posada a punt dels projectes En aquest exercici crearem un projecte Symfony anomenat movies-symfony , que anirem completant en sessions posteriors, en la carpeta de treball amb l'estructura b\u00e0sica de website-\u00adskeleton . Despr\u00e9s de crear-lo, afig un virtual host per a poder accedir al projecte amb la URL http://movies-symfony Repeteix els mateixos passos per a un altre projecte anomenat 00-nom-symfony , tamb\u00e9 allotjat en la teua carpeta de treball. Afig el corresponent virtual host per a accedir a ell amb la URL http://00-nom-symfony Aquest projecte contindr\u00e0 el teu projecte personal, que anari\u00e0s completant a mesura que vages aprenents a utilitzar Symfony. Crea un repositori privat de Github per al projecte personal amb el mateix nom que el projecte. Comparteix-lo amb el professor. Com a resultat d'aquest exercici, haur\u00e0s d'adjuntar una captura de pantalla per a cada projecte, on es veja en el navegador la URL corresponent ( http://movies-symfony o http://00-nom-symfony , respectivament), i la p\u00e0gina de benvinguda per defecte de Symfony. Guarda les captures com a \"movies.png\" i \"projecte.png\". Controladors Seguint els passos de l'apartat El patr\u00f3 MVC en Symfony , implementa el controlador HomeController . Twig Plantilles en Twig Adapta la plantilla base ( templates/base.html.twig ) perqu\u00e8 importe Bootstrap 5.0. Afig a l'array de pel\u00b7l\u00edcules la clau poster amb el nom del fitxer i canvia el format de la data a DateTime o timestamp . Modifica les plantilles home.html.twig , movies_show.html.twig i movies_filter.html.twig perqu\u00e8 hereten de la plantilla base. Crea un plantilla _movie_data.html.twig que tinga les dades de la pel\u00b7l\u00edcula. Modificaci\u00f3 la resta de plantilles perqu\u00e8 mostren les dades de cada pel\u00b7l\u00edcula fent \u00fas d'aquesta. Contenidor de serveis DBTest Crea el servei DBTest vist en la sessi\u00f3 i fes-ne \u00fas en MovieController . D'aquesta forma l'array de pel\u00b7l\u00edcules l'obtindrem des del servei. A m\u00e9s, modifica HomeController perqu\u00e8 en fa\u00e7a \u00fas. Finalment, modifica home.html.twig perqu\u00e8 s'assemble a les de projecte Movies . Logger Implementa el sistema de registre en HomeController , de forma que cada vegada que s'accedisca a la p\u00e0gina principal quede registrada la data i l'hora d'acc\u00e9s. El format de la data es podr\u00e0 configurar globalment. Doctrine En l'aplicaci\u00f3 de pel\u00b7l\u00edcules, crea una nova entitat anomenada Movie amb els seg\u00fcents atributs: title ( string de grand\u00e0ria 255) poster ( string de grand\u00e0ria 255) overview ( text ) releaseDate( DateTime ) Recorda definir pr\u00e8viament la variable DATABASE_URL en les variables d'entorn, crear la base de dades, i despr\u00e9s migrar aquests canvis a la base de dades, emprant els comandos vistos en aquesta sessi\u00f3. El camp id ( enter , autonum\u00e8ric) es crea autom\u00e0ticament. Realitza l'exercici anterior en el teu projecte Symfony, creant la base de dades, l'entitat principal i la taula relacionada en la base de dades. Implementa el m\u00e8tode create vist anteriorment en el projecte Movies . Sobre la base de dades del teu projecte i l'entitat/taula principal que hem creat en l'exercici anterior, implementa mitjan\u00e7ant un controlador per a l'entitat: Implementa un nou m\u00e8tode del controlador anomenat create , que cree un element en la base de dades Implementa el m\u00e8tode show que obtindr\u00e0 un element de la base de dades pel seu id. Implementa el m\u00e8todo home() en la classe HomeController perqu\u00e8 mostre el llistat de la taula principal de MySQL en lloc de la base de dades de proves. Modifica el m\u00e8tode filter anterior de la classe MovieController i perqu\u00e8 cerque els elements que continguen una text determinat per\u00f2 enviat pel query string . Anir\u00e0 associat a la URI /movies/filter i renderizar\u00e1 una vista (pot ser la p\u00e0gina principal), passant-li com a par\u00e0metre el llistat filtrat. Per a obtenir els par\u00e0metres del query string has d'usar la classe Request creant l'objecte posant-lo com a par\u00e0metre tipat. Per exemple: public function filter ( Request $request ) { $text = $request -> query -> getAlnum ( \"text\" ); ... } Empra per a fer la consulta o b\u00e9 el Query Builder de Doctrine o b\u00e9 el seu llenguatge DQL, afegint el m\u00e8tode corresponent en el repositori de l'entitat. Implementa la relaci\u00f3 de Genre i Movie en el projecte movies-symfony . En el projecte personal crea una nova entitat relacionada i implementa la inserci\u00f3 amb d'un element amb l'entitat relacionada. En el projecte Movies afig la configuraci\u00f3 de seguretat seguint els seg\u00fcent requeriments: Crea una entitat User de forma similar a com hem fet per en els exemples, i la corresponent taula. L'entitat tindr\u00e0 els mateixos camps que en l'exemple. Defineix un formulari de login com el de l'exemple, i configura l'arxiu config/packages/security.yaml perqu\u00e8 utilitze aquest formulari, sota la ruta /login (defineix tamb\u00e9 el controlador associat a aqueixa ruta, com en l'exemple) Protegeix l'acc\u00e9s a la creaci\u00f3 de pel\u00b7licules (ruta /movies/create ), perqu\u00e8 nom\u00e9s usuaris de tipus ROLE_ADMIN puguen accedir. Crea un usuari d'aquest tipus en la base de dades manualment, per a poder-ho provar. Crea la jerarquia de rols de l'exemple i fes que a la ruta /admin sols hi puguen accedir els usuaris amb ROLE_ADMIN Canvia les routes dels CRUD de pel\u00b7l\u00edcules i g\u00e8neres de forma que comencen per /admin aix\u00ed s'aplicar\u00e0 la restricci\u00f3 anterior. Sobre l'autenticaci\u00f3 anterior, afegirem aquests canvis: Codifica els passwords de l'aplicaci\u00f3 amb l'algorisme triat per Symfony, i Codifica manualment els passwords dels usuaris que hages afegit a la base de dades, usant la web que s'ha proporcionat en els apunts. Afig un enlla\u00e7 per a \"Iniciar sessi\u00f3\" en la plantilla. Afig un enlla\u00e7 \"Tancar sessi\u00f3\" en la plantilla base.html.twig perqu\u00e8 es puga tancar sessi\u00f3 des de qualsevol vista de la web. Els dos enlla\u00e7os anteriors s\u00f3n incompatible, fes que si l'usuari ha iniciat sessi\u00f3 aparega el de tancar i viceversa. Opcionalment, fes que aparega el nom d'usuari al costat de l'enlla\u00e7 de tancar sessi\u00f3. Aplica els mateixos canvis en el projecte personal, respectant la funcionalitat de rols que havies previst.","title":"Activitats"},{"location":"08-symfony/99-activitats/#activitats","text":"","title":"Activitats"},{"location":"08-symfony/99-activitats/#introduccio","text":"Entorn de desenvolupament Despr\u00e9s dels tres primers apartats de la primera sessi\u00f3, ja hauries de tenir operativa la m\u00e0quina virtual amb XAMPP i Composer instal\u00b7lats. En qualsevol dels dos casos, i per a verificar que la teua instal\u00b7laci\u00f3 \u00e9s correcta abans de continuar, es demana que realitzes dues captures de pantalla: Engega Apache i MySQL des del manager de XAMPP, accedeix amb Firefox a la URL http://localhost i captura la pantalla que mostra el navegador. Guarda-la en un arxiu anomenat \"xampp.png\". Des d'un terminal, executa el comando: composer --version i fes captura on es veja la versi\u00f3 de Composer que tens instal\u00b7lada. Guarda-ho en \"composer.png\".","title":"Introducci\u00f3"},{"location":"08-symfony/99-activitats/#el-patro-mvc","text":"Posada a punt dels projectes En aquest exercici crearem un projecte Symfony anomenat movies-symfony , que anirem completant en sessions posteriors, en la carpeta de treball amb l'estructura b\u00e0sica de website-\u00adskeleton . Despr\u00e9s de crear-lo, afig un virtual host per a poder accedir al projecte amb la URL http://movies-symfony Repeteix els mateixos passos per a un altre projecte anomenat 00-nom-symfony , tamb\u00e9 allotjat en la teua carpeta de treball. Afig el corresponent virtual host per a accedir a ell amb la URL http://00-nom-symfony Aquest projecte contindr\u00e0 el teu projecte personal, que anari\u00e0s completant a mesura que vages aprenents a utilitzar Symfony. Crea un repositori privat de Github per al projecte personal amb el mateix nom que el projecte. Comparteix-lo amb el professor. Com a resultat d'aquest exercici, haur\u00e0s d'adjuntar una captura de pantalla per a cada projecte, on es veja en el navegador la URL corresponent ( http://movies-symfony o http://00-nom-symfony , respectivament), i la p\u00e0gina de benvinguda per defecte de Symfony. Guarda les captures com a \"movies.png\" i \"projecte.png\". Controladors Seguint els passos de l'apartat El patr\u00f3 MVC en Symfony , implementa el controlador HomeController .","title":"El patr\u00f3 MVC"},{"location":"08-symfony/99-activitats/#twig","text":"Plantilles en Twig Adapta la plantilla base ( templates/base.html.twig ) perqu\u00e8 importe Bootstrap 5.0. Afig a l'array de pel\u00b7l\u00edcules la clau poster amb el nom del fitxer i canvia el format de la data a DateTime o timestamp . Modifica les plantilles home.html.twig , movies_show.html.twig i movies_filter.html.twig perqu\u00e8 hereten de la plantilla base. Crea un plantilla _movie_data.html.twig que tinga les dades de la pel\u00b7l\u00edcula. Modificaci\u00f3 la resta de plantilles perqu\u00e8 mostren les dades de cada pel\u00b7l\u00edcula fent \u00fas d'aquesta.","title":"Twig"},{"location":"08-symfony/99-activitats/#contenidor-de-serveis","text":"DBTest Crea el servei DBTest vist en la sessi\u00f3 i fes-ne \u00fas en MovieController . D'aquesta forma l'array de pel\u00b7l\u00edcules l'obtindrem des del servei. A m\u00e9s, modifica HomeController perqu\u00e8 en fa\u00e7a \u00fas. Finalment, modifica home.html.twig perqu\u00e8 s'assemble a les de projecte Movies . Logger Implementa el sistema de registre en HomeController , de forma que cada vegada que s'accedisca a la p\u00e0gina principal quede registrada la data i l'hora d'acc\u00e9s. El format de la data es podr\u00e0 configurar globalment.","title":"Contenidor de serveis"},{"location":"08-symfony/99-activitats/#doctrine","text":"En l'aplicaci\u00f3 de pel\u00b7l\u00edcules, crea una nova entitat anomenada Movie amb els seg\u00fcents atributs: title ( string de grand\u00e0ria 255) poster ( string de grand\u00e0ria 255) overview ( text ) releaseDate( DateTime ) Recorda definir pr\u00e8viament la variable DATABASE_URL en les variables d'entorn, crear la base de dades, i despr\u00e9s migrar aquests canvis a la base de dades, emprant els comandos vistos en aquesta sessi\u00f3. El camp id ( enter , autonum\u00e8ric) es crea autom\u00e0ticament. Realitza l'exercici anterior en el teu projecte Symfony, creant la base de dades, l'entitat principal i la taula relacionada en la base de dades. Implementa el m\u00e8tode create vist anteriorment en el projecte Movies . Sobre la base de dades del teu projecte i l'entitat/taula principal que hem creat en l'exercici anterior, implementa mitjan\u00e7ant un controlador per a l'entitat: Implementa un nou m\u00e8tode del controlador anomenat create , que cree un element en la base de dades Implementa el m\u00e8tode show que obtindr\u00e0 un element de la base de dades pel seu id. Implementa el m\u00e8todo home() en la classe HomeController perqu\u00e8 mostre el llistat de la taula principal de MySQL en lloc de la base de dades de proves. Modifica el m\u00e8tode filter anterior de la classe MovieController i perqu\u00e8 cerque els elements que continguen una text determinat per\u00f2 enviat pel query string . Anir\u00e0 associat a la URI /movies/filter i renderizar\u00e1 una vista (pot ser la p\u00e0gina principal), passant-li com a par\u00e0metre el llistat filtrat. Per a obtenir els par\u00e0metres del query string has d'usar la classe Request creant l'objecte posant-lo com a par\u00e0metre tipat. Per exemple: public function filter ( Request $request ) { $text = $request -> query -> getAlnum ( \"text\" ); ... } Empra per a fer la consulta o b\u00e9 el Query Builder de Doctrine o b\u00e9 el seu llenguatge DQL, afegint el m\u00e8tode corresponent en el repositori de l'entitat. Implementa la relaci\u00f3 de Genre i Movie en el projecte movies-symfony . En el projecte personal crea una nova entitat relacionada i implementa la inserci\u00f3 amb d'un element amb l'entitat relacionada. En el projecte Movies afig la configuraci\u00f3 de seguretat seguint els seg\u00fcent requeriments: Crea una entitat User de forma similar a com hem fet per en els exemples, i la corresponent taula. L'entitat tindr\u00e0 els mateixos camps que en l'exemple. Defineix un formulari de login com el de l'exemple, i configura l'arxiu config/packages/security.yaml perqu\u00e8 utilitze aquest formulari, sota la ruta /login (defineix tamb\u00e9 el controlador associat a aqueixa ruta, com en l'exemple) Protegeix l'acc\u00e9s a la creaci\u00f3 de pel\u00b7licules (ruta /movies/create ), perqu\u00e8 nom\u00e9s usuaris de tipus ROLE_ADMIN puguen accedir. Crea un usuari d'aquest tipus en la base de dades manualment, per a poder-ho provar. Crea la jerarquia de rols de l'exemple i fes que a la ruta /admin sols hi puguen accedir els usuaris amb ROLE_ADMIN Canvia les routes dels CRUD de pel\u00b7l\u00edcules i g\u00e8neres de forma que comencen per /admin aix\u00ed s'aplicar\u00e0 la restricci\u00f3 anterior. Sobre l'autenticaci\u00f3 anterior, afegirem aquests canvis: Codifica els passwords de l'aplicaci\u00f3 amb l'algorisme triat per Symfony, i Codifica manualment els passwords dels usuaris que hages afegit a la base de dades, usant la web que s'ha proporcionat en els apunts. Afig un enlla\u00e7 per a \"Iniciar sessi\u00f3\" en la plantilla. Afig un enlla\u00e7 \"Tancar sessi\u00f3\" en la plantilla base.html.twig perqu\u00e8 es puga tancar sessi\u00f3 des de qualsevol vista de la web. Els dos enlla\u00e7os anteriors s\u00f3n incompatible, fes que si l'usuari ha iniciat sessi\u00f3 aparega el de tancar i viceversa. Opcionalment, fes que aparega el nom d'usuari al costat de l'enlla\u00e7 de tancar sessi\u00f3. Aplica els mateixos canvis en el projecte personal, respectant la funcionalitat de rols que havies previst.","title":"Doctrine"},{"location":"08-symfony/99-recursos-i-bibliografia/","text":"Recursos i bibliografia Webgrafia Cr\u00e8dits IBORRA BAEZA, Ignacio i MARTINEZ LUCAS, Julio Symfony. Desarrollo de aplicaciones MVC en el servidor con un framework PHP . Centre de Formaci\u00f3, Innovaci\u00f3 i Recursos per al professorat, 2018","title":"Recursos i bibliografia"},{"location":"08-symfony/99-recursos-i-bibliografia/#recursos-i-bibliografia","text":"","title":"Recursos i bibliografia"},{"location":"08-symfony/99-recursos-i-bibliografia/#webgrafia","text":"","title":"Webgrafia"},{"location":"08-symfony/99-recursos-i-bibliografia/#credits","text":"IBORRA BAEZA, Ignacio i MARTINEZ LUCAS, Julio Symfony. Desarrollo de aplicaciones MVC en el servidor con un framework PHP . Centre de Formaci\u00f3, Innovaci\u00f3 i Recursos per al professorat, 2018","title":"Cr\u00e8dits"},{"location":"09-rest-api/00-index/","text":"","title":"10. Serveis Web I Api Rest (JSON)"},{"location":"09-rest-api/01-introduccio-als-webservices/","text":"Serveis Web I API REST (JSON) Taula de continguts Continguts UD10. Serveis Web I Api Rest (JSON) Serveis Web i JSON. REST a) Verbs b) URL\u2019s c) Representaci\u00f3 de recursos. d) Codis de resposa. Seguretat amb JWT API Restful amb PHP De vegades, les aplicacions que desenvolupes necessitaran compartir informaci\u00f3 amb altres aplicacions. Sense anar m\u00e9s lluny, en una aplicaci\u00f3 de botiga en l\u00ednia segurament els prove\u00efdors als que es compren els articles manegen la mateixa o semblant informaci\u00f3. I potser pugues aprofitar aquesta informaci\u00f3 per a la teva pr\u00f2pia aplicaci\u00f3. O pot ser que, una vegada que estiga finalitzada i funcionant, vullgues programar una nova aplicaci\u00f3 (no necess\u00e0riament una aplicaci\u00f3 web) que la complemente per, per exemple, processar la informaci\u00f3 sobre les comandes realitzades. Per compartir la informaci\u00f3 que gestiona la teva aplicaci\u00f3, normalment n'hi ha prou amb donar acc\u00e9s a la base de dades en qu\u00e8 s'emmagatzema. Per\u00f2 aquesta generalment no \u00e9s una bona idea. Com m\u00e9s aplicacions utilitzen les mateixes dades, m\u00e9s possibilitats hi ha que es generen errors en els mateixos. A m\u00e9s, hi ha altres inconvenients: Si ja tens una aplicaci\u00f3 funcionant, ja has programat la l\u00f2gica de negoci corresponent, i aquesta no es podr\u00e0 aprofitar en altres aplicacions si utilitzen directament la informaci\u00f3 emmagatzemada a la base de dades. Si vols posar la base de dades a disposici\u00f3 de tercers, aquests necessitaran con\u00e8ixer la seva estructura. I al donar acc\u00e9s directe a les dades, ser\u00e0 complicat mantenir el control sobre les modificacions que es produeixin en els mateixos. D'altra banda, gran part de la informaci\u00f3 que gestionen les aplicacions web ja est\u00e0 disponible perqu\u00e8 altres la utilitzen (deixant de banda les consideracions relacionades amb el control d'acc\u00e9s). Per exemple, si alg\u00fa vol con\u00e8ixer el preu d'un producte a la botiga web, nom\u00e9s cal buscar aquest producte a la p\u00e0gina en qu\u00e8 es llisten tots els productes. Per\u00f2, perqu\u00e8 aquesta mateixa informaci\u00f3 (el preu d'un producte) la puga obtenir un programa, aquest hauria de contemplar un procediment per buscar el producte concret dins de les etiquetes HTML de la p\u00e0gina i extreure el seu preu. Per facilitar aquesta tasca existeixen els serveis web . Un servei web \u00e9s un m\u00e8tode que permet que dos equips intercanvien informaci\u00f3 a trav\u00e9s d'una xarxa inform\u00e0tica mitjan\u00e7ant el protocol http. A l'utilitzar serveis web, el servidor pot oferir un punt d'acc\u00e9s ( endpoint ) amb la informaci\u00f3 que vol compartir. D'aquesta manera controla i facilita l'acc\u00e9s a la mateixa per part d'altres aplicacions. Els clients del servei, per la seva banda, no necessiten con\u00e8ixer l'estructura interna d'emmagatzematge. En lloc d'haver de programar un mecanisme per localitzar la informaci\u00f3, tenen un punt de acc\u00e9s directe a la que els interessa. Tornant a l'exemple de la nostra botiga, si volgu\u00e9ssim aprofitar la informaci\u00f3 de qu\u00e8 disposen els nostres prove\u00efdors, aquests haurien d'oferir un servei web que ens permet\u00e9s recuperar-la. Per exemple, enviant-los el codi d'un producte, podr\u00edem obtenir el seu nom, vista general, preu, etc. Inversament, si volgu\u00e9ssim facilitar l'obtenci\u00f3 de dades de la nostra botiga per part d'altres aplicacions, podr\u00edem programar i oferir un servei web de manera que, per exemple, retorn\u00e9s el llistat de comandes de client que es requerisca. Caracter\u00edstiques Els serveis web es van crear per permetre l'intercanvi d'informaci\u00f3 sobre la base del protocol HTTP (per aix\u00f2 el terme web). En lloc de definir el seu propi protocol per transportar les peticions d'informaci\u00f3 utilitzen HTTP per a aquest fi. La resposta obtinguda no ser\u00e0 una p\u00e0gina web, sin\u00f3 la informaci\u00f3 que s'haja sol\u00b7licitat. D'aquesta manera poden funcionar sobre qualsevol servidor web; i, el que \u00e9s encara m\u00e9s important, utilitzant el port 80 (o 443) reservat per a aquest protocol. Per tant, qualsevol ordinador que puga consultar una p\u00e0gina web, podr\u00e0 tamb\u00e9 sol\u00b7licitar informaci\u00f3 d'un servei web. Si hi ha algun tallafocs a la xarxa, tractar\u00e0 la petici\u00f3 d'informaci\u00f3 igual que ho faria amb la sol\u00b7licitud d'una p\u00e0gina web. Existeixen al menys dues q\u00fcestions que hauria de resoldre un servei web per poder funcionar correctament: * Com es transmet la informaci\u00f3 . Si es va a utilitzar HTTP per a les peticions i les respostes, el client i el servidor hauran de posar-se d'acord en la forma d'enviar unes i altres. \u00c9s a dir, Com fa el client per indicar que vol con\u00e8ixer el PVP de l'article amb codi X?, i tamb\u00e9, com envia al servidor la resposta obtinguda? * Com es publiquen les funcions a qu\u00e8 es pot accedir a un servidor determinat . Aquest punt \u00e9s opcional, per\u00f2 molt \u00fatil. \u00c9s a dir, el client pot saber que la funci\u00f3 de servidor que ha d'utilitzar es diu getPVPArticulo , i que ha de rebre com a par\u00e0metre el codi de l'article. Per\u00f2 si no ho sap, seria \u00fatil que hi hagu\u00e9s un mecanisme on pogu\u00e9s consultar les funcions que hi ha al servidor i com s'utilitza cadascuna. Cadascun dels m\u00e8todes que podem utilitzar avui en dia per crear un servei web respon a aquestes preguntes de formes diferents. Respecte la primera q\u00fcesti\u00f3, el protocol SOAP utilitza el llenguatge XML per intercanviar informaci\u00f3. Quant a la segona q\u00fcesti\u00f3, es resol amb un llenguatge anomenat WSDL, que tamb\u00e9 est\u00e0 basat en XML i va ser creat per descriure serveis web, \u00e9s a dir, indicar com s'ha d'accedir a un servei i utilitzar-lo. Els serveis RESTful utilitzen normalment json i els serveis es descriuen mitjan\u00e7ant documentaci\u00f3. SOAP vs REST API En aquesta completa infografia podeu veure una interessant comparaci\u00f3: Font: https://www.soapui.org/resources/infographic/api-testing/soap-vs-rest-infographic.html En el nostre cas utilitzarem REST API. Bibliografia Jos\u00e9 Luis Comesa\u00f1a. _Apuntes de formaci\u00f3n a distancia del m\u00f3dulo \u00abDesarrollo web en entorno servidor\u00bb del CFGS DAW, elaborados y licenciados por el Ministerio de Educaci\u00f3n, Cultura y Deporte. [en l\u00ednia]. 2012 [data de consulta: 13 de setembre de 2019]. Disponible en https://github.com/statickidz/TemarioDAW/tree/master/DWES","title":"Serveis Web I API REST (JSON)"},{"location":"09-rest-api/01-introduccio-als-webservices/#serveis-web-i-api-rest-json","text":"","title":"Serveis Web I API REST (JSON)"},{"location":"09-rest-api/01-introduccio-als-webservices/#taula-de-continguts","text":"Continguts UD10. Serveis Web I Api Rest (JSON) Serveis Web i JSON. REST a) Verbs b) URL\u2019s c) Representaci\u00f3 de recursos. d) Codis de resposa. Seguretat amb JWT API Restful amb PHP De vegades, les aplicacions que desenvolupes necessitaran compartir informaci\u00f3 amb altres aplicacions. Sense anar m\u00e9s lluny, en una aplicaci\u00f3 de botiga en l\u00ednia segurament els prove\u00efdors als que es compren els articles manegen la mateixa o semblant informaci\u00f3. I potser pugues aprofitar aquesta informaci\u00f3 per a la teva pr\u00f2pia aplicaci\u00f3. O pot ser que, una vegada que estiga finalitzada i funcionant, vullgues programar una nova aplicaci\u00f3 (no necess\u00e0riament una aplicaci\u00f3 web) que la complemente per, per exemple, processar la informaci\u00f3 sobre les comandes realitzades. Per compartir la informaci\u00f3 que gestiona la teva aplicaci\u00f3, normalment n'hi ha prou amb donar acc\u00e9s a la base de dades en qu\u00e8 s'emmagatzema. Per\u00f2 aquesta generalment no \u00e9s una bona idea. Com m\u00e9s aplicacions utilitzen les mateixes dades, m\u00e9s possibilitats hi ha que es generen errors en els mateixos. A m\u00e9s, hi ha altres inconvenients: Si ja tens una aplicaci\u00f3 funcionant, ja has programat la l\u00f2gica de negoci corresponent, i aquesta no es podr\u00e0 aprofitar en altres aplicacions si utilitzen directament la informaci\u00f3 emmagatzemada a la base de dades. Si vols posar la base de dades a disposici\u00f3 de tercers, aquests necessitaran con\u00e8ixer la seva estructura. I al donar acc\u00e9s directe a les dades, ser\u00e0 complicat mantenir el control sobre les modificacions que es produeixin en els mateixos. D'altra banda, gran part de la informaci\u00f3 que gestionen les aplicacions web ja est\u00e0 disponible perqu\u00e8 altres la utilitzen (deixant de banda les consideracions relacionades amb el control d'acc\u00e9s). Per exemple, si alg\u00fa vol con\u00e8ixer el preu d'un producte a la botiga web, nom\u00e9s cal buscar aquest producte a la p\u00e0gina en qu\u00e8 es llisten tots els productes. Per\u00f2, perqu\u00e8 aquesta mateixa informaci\u00f3 (el preu d'un producte) la puga obtenir un programa, aquest hauria de contemplar un procediment per buscar el producte concret dins de les etiquetes HTML de la p\u00e0gina i extreure el seu preu. Per facilitar aquesta tasca existeixen els serveis web . Un servei web \u00e9s un m\u00e8tode que permet que dos equips intercanvien informaci\u00f3 a trav\u00e9s d'una xarxa inform\u00e0tica mitjan\u00e7ant el protocol http. A l'utilitzar serveis web, el servidor pot oferir un punt d'acc\u00e9s ( endpoint ) amb la informaci\u00f3 que vol compartir. D'aquesta manera controla i facilita l'acc\u00e9s a la mateixa per part d'altres aplicacions. Els clients del servei, per la seva banda, no necessiten con\u00e8ixer l'estructura interna d'emmagatzematge. En lloc d'haver de programar un mecanisme per localitzar la informaci\u00f3, tenen un punt de acc\u00e9s directe a la que els interessa. Tornant a l'exemple de la nostra botiga, si volgu\u00e9ssim aprofitar la informaci\u00f3 de qu\u00e8 disposen els nostres prove\u00efdors, aquests haurien d'oferir un servei web que ens permet\u00e9s recuperar-la. Per exemple, enviant-los el codi d'un producte, podr\u00edem obtenir el seu nom, vista general, preu, etc. Inversament, si volgu\u00e9ssim facilitar l'obtenci\u00f3 de dades de la nostra botiga per part d'altres aplicacions, podr\u00edem programar i oferir un servei web de manera que, per exemple, retorn\u00e9s el llistat de comandes de client que es requerisca.","title":"Taula de continguts"},{"location":"09-rest-api/01-introduccio-als-webservices/#caracteristiques","text":"Els serveis web es van crear per permetre l'intercanvi d'informaci\u00f3 sobre la base del protocol HTTP (per aix\u00f2 el terme web). En lloc de definir el seu propi protocol per transportar les peticions d'informaci\u00f3 utilitzen HTTP per a aquest fi. La resposta obtinguda no ser\u00e0 una p\u00e0gina web, sin\u00f3 la informaci\u00f3 que s'haja sol\u00b7licitat. D'aquesta manera poden funcionar sobre qualsevol servidor web; i, el que \u00e9s encara m\u00e9s important, utilitzant el port 80 (o 443) reservat per a aquest protocol. Per tant, qualsevol ordinador que puga consultar una p\u00e0gina web, podr\u00e0 tamb\u00e9 sol\u00b7licitar informaci\u00f3 d'un servei web. Si hi ha algun tallafocs a la xarxa, tractar\u00e0 la petici\u00f3 d'informaci\u00f3 igual que ho faria amb la sol\u00b7licitud d'una p\u00e0gina web. Existeixen al menys dues q\u00fcestions que hauria de resoldre un servei web per poder funcionar correctament: * Com es transmet la informaci\u00f3 . Si es va a utilitzar HTTP per a les peticions i les respostes, el client i el servidor hauran de posar-se d'acord en la forma d'enviar unes i altres. \u00c9s a dir, Com fa el client per indicar que vol con\u00e8ixer el PVP de l'article amb codi X?, i tamb\u00e9, com envia al servidor la resposta obtinguda? * Com es publiquen les funcions a qu\u00e8 es pot accedir a un servidor determinat . Aquest punt \u00e9s opcional, per\u00f2 molt \u00fatil. \u00c9s a dir, el client pot saber que la funci\u00f3 de servidor que ha d'utilitzar es diu getPVPArticulo , i que ha de rebre com a par\u00e0metre el codi de l'article. Per\u00f2 si no ho sap, seria \u00fatil que hi hagu\u00e9s un mecanisme on pogu\u00e9s consultar les funcions que hi ha al servidor i com s'utilitza cadascuna. Cadascun dels m\u00e8todes que podem utilitzar avui en dia per crear un servei web respon a aquestes preguntes de formes diferents. Respecte la primera q\u00fcesti\u00f3, el protocol SOAP utilitza el llenguatge XML per intercanviar informaci\u00f3. Quant a la segona q\u00fcesti\u00f3, es resol amb un llenguatge anomenat WSDL, que tamb\u00e9 est\u00e0 basat en XML i va ser creat per descriure serveis web, \u00e9s a dir, indicar com s'ha d'accedir a un servei i utilitzar-lo. Els serveis RESTful utilitzen normalment json i els serveis es descriuen mitjan\u00e7ant documentaci\u00f3.","title":"Caracter\u00edstiques"},{"location":"09-rest-api/01-introduccio-als-webservices/#soap-vs-rest-api","text":"En aquesta completa infografia podeu veure una interessant comparaci\u00f3: Font: https://www.soapui.org/resources/infographic/api-testing/soap-vs-rest-infographic.html En el nostre cas utilitzarem REST API.","title":"SOAP vs REST API"},{"location":"09-rest-api/01-introduccio-als-webservices/#bibliografia","text":"Jos\u00e9 Luis Comesa\u00f1a. _Apuntes de formaci\u00f3n a distancia del m\u00f3dulo \u00abDesarrollo web en entorno servidor\u00bb del CFGS DAW, elaborados y licenciados por el Ministerio de Educaci\u00f3n, Cultura y Deporte. [en l\u00ednia]. 2012 [data de consulta: 13 de setembre de 2019]. Disponible en https://github.com/statickidz/TemarioDAW/tree/master/DWES","title":"Bibliografia"},{"location":"09-rest-api/02-SOAP/","text":"","title":"SOAP"},{"location":"09-rest-api/03-rest-api/","text":"REST API Introducci\u00f3 La transfer\u00e8ncia d'estat representacional (en angl\u00e8s ReST) \u00e9s un estil d'arquitectura de programari per a sistemes hiperm\u00e8dia distribu\u00efts com la World Wide Web. El terme es va originar l'any 2000, en una tesi doctoral sobre la web escrita per Roy Fielding, un dels principals autors de l'especificaci\u00f3 del protocol HTTP i ha passat a ser \u00e0mpliament utilitzat per la comunitat de desenvolupament. Caracter\u00edstiques Si b\u00e9 el terme REST es referia originalment a un conjunt de principis d'arquitectura -descrits m\u00e9s baix-, en l'actualitat s'usa en el sentit m\u00e9s ampli per descriure qualsevol interf\u00edcie entre sistemes que utilitze directament HTTP per obtenir dades o indicar l'execuci\u00f3 d'operacions sobre les dades, en qualsevol format (XML, JSON, etc) sense les abstraccions addicionals dels protocols basats en patrons d'intercanvi de missatges, com ara SOAP. \u00c9s possible dissenyar sistemes de serveis web d'acord amb l'estil arquitectural REST de Fielding i tamb\u00e9 \u00e9s possible dissenyar interf\u00edcies XMLHTTP d'acord amb l'estil de crida a procediment remot (RPC), per\u00f2 sense usar SOAP. Aquests dos usos diferents del terme REST causen certa confusi\u00f3 en les discussions t\u00e8cniques, encara que RPC no \u00e9s un exemple de REST. REST afirma que la web ha gaudit d'escalabilitat com a resultat d'una s\u00e8rie de dissenys fonamentals clau: Un protocol client/servidor sense estat : cada missatge HTTP cont\u00e9 tota la informaci\u00f3 necess\u00e0ria per comprendre la petici\u00f3. Com a resultat, ni el client ni el servidor necessiten recordar cap estat de les comunicacions entre missatges. No obstant aix\u00f2, en la pr\u00e0ctica, moltes aplicacions basades en HTTP utilitzen cookies i altres mecanismes per mantenir l'estat de la sessi\u00f3. Un conjunt d'operacions ben definides que s'apliquen a tots els recursos d'informaci\u00f3: HTTP defineix un conjunt petit d'operacions, les m\u00e9s importants s\u00f3n POST, GET, PUT i DELETE. Sovint aquestes operacions s'equiparen a les operacions CRUD en bases de dades (CLAE en valenci\u00e0: crear, llegir, actualitzar, esborrar) que es requereixen per a la persist\u00e8ncia de dades, encara que POST no encaixa exactament en aquest esquema. Una sintaxi universal per identificar els recursos . En un sistema REST, cada recurs \u00e9s adre\u00e7able \u00fanicament a trav\u00e9s del seu URI. L'\u00fas d'hipermitjans , tant per a la informaci\u00f3 de l'aplicaci\u00f3 com per a les transicions d'estat de l'aplicaci\u00f3: la representaci\u00f3 d'aquest estat en un sistema REST s\u00f3n t\u00edpicament HTML o XML. Com a resultat d'aix\u00f2, \u00e9s possible navegar d'un recurs REST a molts altres, simplement seguint enlla\u00e7os sense requerir l'\u00fas de registres o una altra infraestructura addicional. Verbs Les API de REST ens permeten desenvolupar qualsevol tipus d\u2019aplicaci\u00f3 web amb totes les operacions possibles CRUD (crear, recuperar, actualitzar, suprimir). Les directrius REST suggereixen utilitzar un m\u00e8tode HTTP espec\u00edfic en un tipus espec\u00edfic de cridades realitzades al servidor (tot i que t\u00e8cnicament \u00e9s possible incomplir aquesta directriu, per\u00f2 est\u00e0 molt desaconsellat). Utilitzeu la informaci\u00f3 indicada a continuaci\u00f3 per trobar un m\u00e8tode HTTP adequat per a l'acci\u00f3 de l'API. HTTP GET Utilitzeu les sol\u00b7licituds GET per recuperar informaci\u00f3 o recursos i no modificar-los de cap manera. Com que les sol\u00b7licituds GET no canvien l\u2019estat del recurs es diu que s\u00f3n m\u00e8todes segurs . Addicionalment, les API GET haurien de ser idempotents, el que significa que fer m\u00faltiples sol\u00b7licituds id\u00e8ntiques ha de produir el mateix resultat cada vegada fins que una altra API (POST o PUT) haja canviat l'estat del recurs al servidor. Per a qualsevol API GET determinada, si el recurs es troba al servidor, ha de retornar el codi de resposta HTTP 200 (OK), juntament amb el cos de resposta, que normalment \u00e9s contingut XML o JSON (per la seva naturalesa independent de la plataforma). En cas que el recurs NO es trobe al servidor, ha de retornar el codi de resposta HTTP 404 (NO TROBAT). De la mateixa manera, si es determina que la sol\u00b7licitud GET no est\u00e0 formada correctament, el servidor retornar\u00e0 el codi de resposta HTTP 400 (BAD REQUEST). URI de sol\u00b7licitud d\u2019exemple HTTP GET http://www.appdomain.com/users HTTP GET http://www.appdomain.com/users?size=20&page=5 HTTP GET http://www.appdomain.com/users/123 HTTP GET http://www.appdomain.com/users/123/address HTTP POST Utilitzeu les API POST per crear nous recursos subordinats, per exemple, un fitxer est\u00e0 subordinat al directori que el cont\u00e9 o una fila est\u00e0 subordinada a una taula de bases de dades. Parlant estrictament en termes de REST, els m\u00e8todes POST s\u2019utilitzen per crear un nou recurs en la colecci\u00f3 de recursos. L\u2019ideal \u00e9s que, si s\u2019ha creat un recurs al servidor d\u2019origen, la resposta hauria de ser el codi de resposta HTTP 201 (Creat) i contindr\u00e0 una entitat que descriu l\u2019estat de la sol\u00b7licitud i fa refer\u00e8ncia al nou recurs i una cap\u00e7alera d\u2019ubicaci\u00f3. Moltes vegades, l\u2019acci\u00f3 realitzada pel m\u00e8tode POST pot no derivar en un recurs que puga ser identificat per un URI. En aquest cas, el codi de resposta HTTP 200 (OK) o el 204 (No Content) \u00e9s l'estat de resposta adequat. Les respostes a aquest m\u00e8tode no s\u00f3n emmagatzemades en mem\u00f2ria cau, tret que la resposta incloga els camps de cap\u00e7alera adequats de control de cach\u00e9 o caduca. Tingueu en compte que POST no \u00e9s segur ni idempotent i, si s'invoquen dues sol\u00b7licituds POST id\u00e8ntiques es produiran dos recursos diferents que continguin la mateixa informaci\u00f3 (excepte els identificadors de recursos). URI de sol\u00b7licitud d\u2019exemple HTTP POST http://www.appdomain.com/users HTTP POST http://www.appdomain.com/users/123/accounts HTTP PUT Utilitzeu les API PUT principalment per actualitzar un recurs existent (si el recurs no existeix, llavors l'API pot decidir crear un recurs nou o no). Si s'ha creat un recurs nou per l'API PUT, el servidor d'origen ha d'informar a l'agent d'usuari mitjan\u00e7ant la resposta del codi HTTP 201 (Creada) i si es modifica un recurs existent, els 200 (OK) o els 204 (Sense contingut). S'han d'enviar codis de resposta per indicar la finalitzaci\u00f3 correcta de la sol\u00b7licitud. Si la sol\u00b7licitud passa per una mem\u00f2ria cau i l'URI de sol\u00b7licitud identifica una o m\u00e9s entitats actualment en cach\u00e9, aquestes entitats haurien de ser considerades no vistes. Les respostes a aquest m\u00e8tode no s\u00f3n cach\u00e9. La difer\u00e8ncia entre les API de POST i PUT es pot observar en els URI de sol\u00b7licitud. Les sol\u00b7licituds POST es realitzen a les col\u00b7leccions de recursos, mentre que les peticions PUT es realitzen en un recurs individual. URI de sol\u00b7licitud d\u2019exemple HTTP PUT http://www.appdomain.com/users/123 HTTP PUT http://www.appdomain.com/users/123/accounts/456 HTTP DELETE Com el nom indica les API DELETE s\u2019utilitzen per eliminar recursos (identificats per l\u2019URI de la sol\u00b7licitud). Una resposta exitosa de les sol\u00b7licituds DELETE haria ser el codi de resposta HTTP 200 (D'acord) si la resposta inclou una entitat que descriu l'estat, 202 (Acceptat) si l'acci\u00f3 s'ha posat en qua, o 204 (Sense contingut) si l'acci\u00f3 s'ha realitzat, per\u00f2 la resposta no inclou una entitat. Les operacions DELETE s\u00f3n idempotents. Si suprimiu un recurs, se suprimir\u00e0 de la col\u00b7lecci\u00f3 de recursos. Cridar repetidament a la API en aquest recurs no canviar\u00e0 el resultat, per\u00f2, cridar a un recurs per segona vegada retornar\u00e0 un 404 (NO TROBAT) ja que ja es va eliminar. Alguns poden argumentar que fa aix\u00f2 que el m\u00e8tode DELETE no sigui idempotent. \u00c9s una q\u00fcesti\u00f3 de discussi\u00f3 i d\u2019opini\u00f3 personal. URI de sol\u00b7licitud d\u2019exemple HTTP DELETE http://www.appdomain.com/users/123 HTTP DELETE http://www.appdomain.com/users/123/accounts/456 Resum dels M\u00e8todes HTTP per a les API RESTful La taula seg\u00fcent resumeix l\u2019\u00fas dels m\u00e8todes HTTP comentats anteriorment. HTTP Method CRUD Entire Collection (e.g. /users) Specific Item (e.g. /users/123) POST Create 201 (Created), \u2018Location\u2019 header with link to /users/{id} containing new ID. Avoid using POST on single resource GET Read 200 (OK), list of users. Use pagination, sorting and filtering to navigate big lists. 200 (OK), single user. 404 (Not Found), if ID not found or invalid. PUT Update/Replace 405 (Method not allowed), unless you want to update every resource in the entire collection of resource. 200 (OK) or 204 (No Content). Use 404 (Not Found), if ID not found or invalid. PATCH Partial Update/Modify 405 (Method not allowed), unless you want to modify the collection itself. 200 (OK) or 204 (No Content). Use 404 (Not Found), if ID not found or invalid. DELETE Delete 405 (Method not allowed), unless you want to delete the whole collection \u2014 use with caution. 200 (OK). 404 (Not Found), if ID not found or invalid. Bibliografia Colaboradores de Wikipedia. Transferencia de Estado Representacional [en l\u00ednea]. Wikipedia, La enciclopedia libre, 2019 [fecha de consulta: 17 de febrero del 2020]. Disponible en https://es.wikipedia.org/w/index.php?title=Transferencia_de_Estado_Representacional&oldid=122090690 . WebConcepts. REST API concepts and examples. Youtube, 2014. Disponible en https://www.youtube.com/watch?v=7YcW25PHnAA RestfulApi.net. HTTP Methods. Disponible en https://restfulapi.net/http-methods/ .","title":"REST API"},{"location":"09-rest-api/03-rest-api/#rest-api","text":"","title":"REST API"},{"location":"09-rest-api/03-rest-api/#introduccio","text":"La transfer\u00e8ncia d'estat representacional (en angl\u00e8s ReST) \u00e9s un estil d'arquitectura de programari per a sistemes hiperm\u00e8dia distribu\u00efts com la World Wide Web. El terme es va originar l'any 2000, en una tesi doctoral sobre la web escrita per Roy Fielding, un dels principals autors de l'especificaci\u00f3 del protocol HTTP i ha passat a ser \u00e0mpliament utilitzat per la comunitat de desenvolupament.","title":"Introducci\u00f3"},{"location":"09-rest-api/03-rest-api/#caracteristiques","text":"Si b\u00e9 el terme REST es referia originalment a un conjunt de principis d'arquitectura -descrits m\u00e9s baix-, en l'actualitat s'usa en el sentit m\u00e9s ampli per descriure qualsevol interf\u00edcie entre sistemes que utilitze directament HTTP per obtenir dades o indicar l'execuci\u00f3 d'operacions sobre les dades, en qualsevol format (XML, JSON, etc) sense les abstraccions addicionals dels protocols basats en patrons d'intercanvi de missatges, com ara SOAP. \u00c9s possible dissenyar sistemes de serveis web d'acord amb l'estil arquitectural REST de Fielding i tamb\u00e9 \u00e9s possible dissenyar interf\u00edcies XMLHTTP d'acord amb l'estil de crida a procediment remot (RPC), per\u00f2 sense usar SOAP. Aquests dos usos diferents del terme REST causen certa confusi\u00f3 en les discussions t\u00e8cniques, encara que RPC no \u00e9s un exemple de REST. REST afirma que la web ha gaudit d'escalabilitat com a resultat d'una s\u00e8rie de dissenys fonamentals clau: Un protocol client/servidor sense estat : cada missatge HTTP cont\u00e9 tota la informaci\u00f3 necess\u00e0ria per comprendre la petici\u00f3. Com a resultat, ni el client ni el servidor necessiten recordar cap estat de les comunicacions entre missatges. No obstant aix\u00f2, en la pr\u00e0ctica, moltes aplicacions basades en HTTP utilitzen cookies i altres mecanismes per mantenir l'estat de la sessi\u00f3. Un conjunt d'operacions ben definides que s'apliquen a tots els recursos d'informaci\u00f3: HTTP defineix un conjunt petit d'operacions, les m\u00e9s importants s\u00f3n POST, GET, PUT i DELETE. Sovint aquestes operacions s'equiparen a les operacions CRUD en bases de dades (CLAE en valenci\u00e0: crear, llegir, actualitzar, esborrar) que es requereixen per a la persist\u00e8ncia de dades, encara que POST no encaixa exactament en aquest esquema. Una sintaxi universal per identificar els recursos . En un sistema REST, cada recurs \u00e9s adre\u00e7able \u00fanicament a trav\u00e9s del seu URI. L'\u00fas d'hipermitjans , tant per a la informaci\u00f3 de l'aplicaci\u00f3 com per a les transicions d'estat de l'aplicaci\u00f3: la representaci\u00f3 d'aquest estat en un sistema REST s\u00f3n t\u00edpicament HTML o XML. Com a resultat d'aix\u00f2, \u00e9s possible navegar d'un recurs REST a molts altres, simplement seguint enlla\u00e7os sense requerir l'\u00fas de registres o una altra infraestructura addicional.","title":"Caracter\u00edstiques"},{"location":"09-rest-api/03-rest-api/#verbs","text":"Les API de REST ens permeten desenvolupar qualsevol tipus d\u2019aplicaci\u00f3 web amb totes les operacions possibles CRUD (crear, recuperar, actualitzar, suprimir). Les directrius REST suggereixen utilitzar un m\u00e8tode HTTP espec\u00edfic en un tipus espec\u00edfic de cridades realitzades al servidor (tot i que t\u00e8cnicament \u00e9s possible incomplir aquesta directriu, per\u00f2 est\u00e0 molt desaconsellat). Utilitzeu la informaci\u00f3 indicada a continuaci\u00f3 per trobar un m\u00e8tode HTTP adequat per a l'acci\u00f3 de l'API.","title":"Verbs"},{"location":"09-rest-api/03-rest-api/#http-get","text":"Utilitzeu les sol\u00b7licituds GET per recuperar informaci\u00f3 o recursos i no modificar-los de cap manera. Com que les sol\u00b7licituds GET no canvien l\u2019estat del recurs es diu que s\u00f3n m\u00e8todes segurs . Addicionalment, les API GET haurien de ser idempotents, el que significa que fer m\u00faltiples sol\u00b7licituds id\u00e8ntiques ha de produir el mateix resultat cada vegada fins que una altra API (POST o PUT) haja canviat l'estat del recurs al servidor. Per a qualsevol API GET determinada, si el recurs es troba al servidor, ha de retornar el codi de resposta HTTP 200 (OK), juntament amb el cos de resposta, que normalment \u00e9s contingut XML o JSON (per la seva naturalesa independent de la plataforma). En cas que el recurs NO es trobe al servidor, ha de retornar el codi de resposta HTTP 404 (NO TROBAT). De la mateixa manera, si es determina que la sol\u00b7licitud GET no est\u00e0 formada correctament, el servidor retornar\u00e0 el codi de resposta HTTP 400 (BAD REQUEST).","title":"HTTP GET"},{"location":"09-rest-api/03-rest-api/#http-post","text":"Utilitzeu les API POST per crear nous recursos subordinats, per exemple, un fitxer est\u00e0 subordinat al directori que el cont\u00e9 o una fila est\u00e0 subordinada a una taula de bases de dades. Parlant estrictament en termes de REST, els m\u00e8todes POST s\u2019utilitzen per crear un nou recurs en la colecci\u00f3 de recursos. L\u2019ideal \u00e9s que, si s\u2019ha creat un recurs al servidor d\u2019origen, la resposta hauria de ser el codi de resposta HTTP 201 (Creat) i contindr\u00e0 una entitat que descriu l\u2019estat de la sol\u00b7licitud i fa refer\u00e8ncia al nou recurs i una cap\u00e7alera d\u2019ubicaci\u00f3. Moltes vegades, l\u2019acci\u00f3 realitzada pel m\u00e8tode POST pot no derivar en un recurs que puga ser identificat per un URI. En aquest cas, el codi de resposta HTTP 200 (OK) o el 204 (No Content) \u00e9s l'estat de resposta adequat. Les respostes a aquest m\u00e8tode no s\u00f3n emmagatzemades en mem\u00f2ria cau, tret que la resposta incloga els camps de cap\u00e7alera adequats de control de cach\u00e9 o caduca. Tingueu en compte que POST no \u00e9s segur ni idempotent i, si s'invoquen dues sol\u00b7licituds POST id\u00e8ntiques es produiran dos recursos diferents que continguin la mateixa informaci\u00f3 (excepte els identificadors de recursos).","title":"HTTP POST"},{"location":"09-rest-api/03-rest-api/#http-put","text":"Utilitzeu les API PUT principalment per actualitzar un recurs existent (si el recurs no existeix, llavors l'API pot decidir crear un recurs nou o no). Si s'ha creat un recurs nou per l'API PUT, el servidor d'origen ha d'informar a l'agent d'usuari mitjan\u00e7ant la resposta del codi HTTP 201 (Creada) i si es modifica un recurs existent, els 200 (OK) o els 204 (Sense contingut). S'han d'enviar codis de resposta per indicar la finalitzaci\u00f3 correcta de la sol\u00b7licitud. Si la sol\u00b7licitud passa per una mem\u00f2ria cau i l'URI de sol\u00b7licitud identifica una o m\u00e9s entitats actualment en cach\u00e9, aquestes entitats haurien de ser considerades no vistes. Les respostes a aquest m\u00e8tode no s\u00f3n cach\u00e9. La difer\u00e8ncia entre les API de POST i PUT es pot observar en els URI de sol\u00b7licitud. Les sol\u00b7licituds POST es realitzen a les col\u00b7leccions de recursos, mentre que les peticions PUT es realitzen en un recurs individual.","title":"HTTP PUT"},{"location":"09-rest-api/03-rest-api/#http-delete","text":"Com el nom indica les API DELETE s\u2019utilitzen per eliminar recursos (identificats per l\u2019URI de la sol\u00b7licitud). Una resposta exitosa de les sol\u00b7licituds DELETE haria ser el codi de resposta HTTP 200 (D'acord) si la resposta inclou una entitat que descriu l'estat, 202 (Acceptat) si l'acci\u00f3 s'ha posat en qua, o 204 (Sense contingut) si l'acci\u00f3 s'ha realitzat, per\u00f2 la resposta no inclou una entitat. Les operacions DELETE s\u00f3n idempotents. Si suprimiu un recurs, se suprimir\u00e0 de la col\u00b7lecci\u00f3 de recursos. Cridar repetidament a la API en aquest recurs no canviar\u00e0 el resultat, per\u00f2, cridar a un recurs per segona vegada retornar\u00e0 un 404 (NO TROBAT) ja que ja es va eliminar. Alguns poden argumentar que fa aix\u00f2 que el m\u00e8tode DELETE no sigui idempotent. \u00c9s una q\u00fcesti\u00f3 de discussi\u00f3 i d\u2019opini\u00f3 personal.","title":"HTTP DELETE"},{"location":"09-rest-api/03-rest-api/#bibliografia","text":"Colaboradores de Wikipedia. Transferencia de Estado Representacional [en l\u00ednea]. Wikipedia, La enciclopedia libre, 2019 [fecha de consulta: 17 de febrero del 2020]. Disponible en https://es.wikipedia.org/w/index.php?title=Transferencia_de_Estado_Representacional&oldid=122090690 . WebConcepts. REST API concepts and examples. Youtube, 2014. Disponible en https://www.youtube.com/watch?v=7YcW25PHnAA RestfulApi.net. HTTP Methods. Disponible en https://restfulapi.net/http-methods/ .","title":"Bibliografia"},{"location":"09-rest-api/04-implentacioAPIREST/","text":"Implementaci\u00f3 d'una API RESTful en PHP Anem a implementar una API senzilla basada en el nostre framework MVC. Tindrem els seg\u00fcents endpoints que caldr\u00e0 definir en la taula de rutes. POST /api/v1/movies GET /api/v1/movies GET /api/v1/movies/:id Tin en compte que aquesta versi\u00f3 \u00e9s molt b\u00e0sica i t\u00e9 mancances quant a validaci\u00f3 i filtratge de dades. Com hem vist en l'apartat anterior el servidor respon a les sol\u00b7licitud HTTP amb dades en format JSON i un codi d'estat. Per poder respondre en dades en format JSON hem implementat el m\u00e8tode Response::jsonResponse . /** * @param $element * @return false|string */ public function jsonResponse ( array $element , integer $code ) { header ( 'Content-Type: application/json; charset=UTF-8' ); return json_encode ( $element ); } Perqu\u00e8 un objecte puga convertir-se en un string JSON caldr\u00e0 implementar en la classe l'interf\u00edcie JsonSerializable que obliga a implmentar el m\u00e8tode jsonSerialize que haur\u00e0 de tornar un array que represente l'objecte. # src/Controllers/ApiController.php /** * @return string * @throws \\App\\Core\\Exception\\ModelException */ public function index () : string { $movieModel = App :: getModel ( MovieModel :: class ); $movies = $movieModel -> findAllPaginated ( 1 , 8 , [ \"release_date\" => \"DESC\" , \"title\" => \"ASC\" ]); return $this -> response -> jsonResponse ( $movies ); } Prova de la API amb Postman Documentaci\u00f3 de la API en OpenApi Consumir la API","title":"Implementaci\u00f3 d'una API REST."},{"location":"09-rest-api/04-implentacioAPIREST/#implementacio-duna-api-restful-en-php","text":"Anem a implementar una API senzilla basada en el nostre framework MVC. Tindrem els seg\u00fcents endpoints que caldr\u00e0 definir en la taula de rutes. POST /api/v1/movies GET /api/v1/movies GET /api/v1/movies/:id Tin en compte que aquesta versi\u00f3 \u00e9s molt b\u00e0sica i t\u00e9 mancances quant a validaci\u00f3 i filtratge de dades. Com hem vist en l'apartat anterior el servidor respon a les sol\u00b7licitud HTTP amb dades en format JSON i un codi d'estat. Per poder respondre en dades en format JSON hem implementat el m\u00e8tode Response::jsonResponse . /** * @param $element * @return false|string */ public function jsonResponse ( array $element , integer $code ) { header ( 'Content-Type: application/json; charset=UTF-8' ); return json_encode ( $element ); } Perqu\u00e8 un objecte puga convertir-se en un string JSON caldr\u00e0 implementar en la classe l'interf\u00edcie JsonSerializable que obliga a implmentar el m\u00e8tode jsonSerialize que haur\u00e0 de tornar un array que represente l'objecte. # src/Controllers/ApiController.php /** * @return string * @throws \\App\\Core\\Exception\\ModelException */ public function index () : string { $movieModel = App :: getModel ( MovieModel :: class ); $movies = $movieModel -> findAllPaginated ( 1 , 8 , [ \"release_date\" => \"DESC\" , \"title\" => \"ASC\" ]); return $this -> response -> jsonResponse ( $movies ); }","title":"Implementaci\u00f3 d'una API RESTful en PHP"},{"location":"09-rest-api/04-implentacioAPIREST/#prova-de-la-api-amb-postman","text":"","title":"Prova de la API amb Postman"},{"location":"09-rest-api/04-implentacioAPIREST/#documentacio-de-la-api-en-openapi","text":"","title":"Documentaci\u00f3 de la API en OpenApi"},{"location":"09-rest-api/04-implentacioAPIREST/#consumir-la-api","text":"","title":"Consumir la API"},{"location":"09-rest-api/05-rest-api-symfony/","text":"Desenvolupament de serveis REST amb Symfony Construint una API REST b\u00e0sica Vegem ara quins passos donar per a construir una API REST que done suport a les operacions b\u00e0siques sobre una o diverses entitats: consultes (GET), insercions (POST), modificacions (PUT) i esborrats (DELETE). A l'hora d'implementar una soluci\u00f3 en Symfony ens trobem en tres opcions: API senzilla amb els m\u00e8todes que ens proporciona la classe AbstractController . Fer \u00fas d'un bundle com FOSRestBundle que ens permet una major flexibilitat. Fer \u00fas d' API platform , una ferramenta molt completa basada en PHP per a crear REST API. L'elecci\u00f3 d'una soluci\u00f3 o altra dependr\u00e0 de cada projecte. En aquest curs emprarem FOSRestBundle . Arrencada del projecte El projecte d'exemple ser\u00e0 una projecte independent basat en Movies. Aix\u00ed podrem aprofitar el model de dades. Primerament crearem el projecte de Symfony: composer create-project symfony/skeleton api-movies-symfony ^5.4 En aquesta ordre crearem un projecte b\u00e0sic de Symfony en la versi\u00f3 5.4, es tracta d'un projecte que no inclou ni Doctrine, ni Twig, per exemple. Twig no ser\u00e0 necessari ja que es tracta d'una API per\u00f2 Doctrine, s\u00ed. A m\u00e9s, caldran altres components que instal\u00b7larem a continuaci\u00f3: composer require orm composer require orm-fixtures --dev composer require security composer require symfony/maker-bundle composer require symfony/validator composer require symfony/apache-pack composer require sensio/framework-extra-bundle El model del dades, les entitats i els repositoris el copiarem del projecte Movies. Caldr\u00e0 instal\u00b7lar tamb\u00e9 els components que s'usen per a la generaci\u00f3 de les dades: composer require woodsandwalker/faker-picture --dev composer require FakerPHP/Faker --dev Llevarem les refer\u00e8ncies a VichUploader, ja que usarem els formularis d'una altra forma. Instal\u00b7lant els bundles necessaris A m\u00e9s del que ja tenim instal\u00b7lat caldr\u00e0 fer \u00fas d'un bundle espec\u00edfic per a desenvolupar APIs, anomenat FOSRestBundle . Est\u00e0 creat per l'equip de desenvolupament Friends Of Symfony , responsable de diversos bundles populars per a aquest framework. A m\u00e9s, aquest bundle requereix d'un altre addicional, que s'encarregar\u00e0 de serializar/deserializar les dades que s'envien client i servidor, emprant el format JSON (encara que es pot triar un altre format, com XML o HTML, per\u00f2 ens centrarem en JSON). Aquest bundle s'anomena Serializer . Abans de continuar, alguns conceptes: Serialitzar . La serialitzaci\u00f3 \u00e9s el proc\u00e9s de convertir un objecte en una altre format per a emmagatzemar-lo o transmetre'l i posteriorment ser decodificat. Normalitzar. Ajuden en el proc\u00e9s de serialitzaci\u00f3, convertint els objectes en un element intermig, com pot ser una array. Resumint, aquests s\u00f3n els comandos que necessitarem (i en aquest ordre): composer require symfony/serializer composer require friendsofsymfony/rest-bundle Configurant el serialitzador # config/packages/framework.yaml framework : ... serializer : enabled : true mapping : paths : [ '%kernel.project_dir%/config/serializer/' ] Definim els grups de serialitzaci\u00f3 de les entitats. # config/serializer/Movie.yaml App\\Entity\\Movie : attributes : id : groups : [ 'movie' ] title : groups : [ 'movie' ] poster : groups : [ 'movie' ] overview : groups : [ 'movie' ] rating : groups : [ 'movie' ] releaseDate : groups : [ 'movie' ] Configurem FOSRestbundle . # config/packages/fos_rest.yaml # Read the documentation: https://symfony.com/doc/master/bundles/FOSRestBundle/index.html fos_rest : param_fetcher_listener : true view : empty_content : 200 view_response_listener : true failed_validation : HTTP_BAD_REQUEST formats : json : true xml : false body_listener : decoders : json : fos_rest.decoder.json format_listener : rules : - { path : '/api' , priorities : [ 'json' ], fallback_format : json , prefer_extension : false } - { path : '^/' , stop : true , fallback_format : html } exception : enabled : true serializer : serialize_null : true Definint els serveis Ara que ja tenim instal\u00b7lat el necessari per a comen\u00e7ar a definir els serveis, anem al que \u00e9s important. Crearem una nova classe, on definirem els serveis b\u00e0sics sobre l'entitat Movie . Cridarem a aquesta classe ApiMovieController , i l'afegirem en la carpeta src/Controller : La classe t\u00e9 una anotaci\u00f3 @Route , que implica que qualsevol ruta que indiquem dins va a tenir aqueix prefix (en aquest cas, totes les rutes dels m\u00e8todes interns tindran el prefix /api/v1/movies ). Llistat de tots els elements (GET /) Afegirem un m\u00e8tode a la nostra classe anterior perqu\u00e8 torne, en format JSON totes les pel\u00b7l\u00edcules de la base de dades. El codi del m\u00e8tode \u00e9s el seg\u00fcent: class ApiMovieController extends AbstractFOSRestController { /** * @Rest\\Get(path=\"/api/v1/movies\", name=\"api_movies\") * @Rest\\View(serializerGroups={\"movie\"}, serializerEnableMaxDepthChecks=true) */ public function list ( MovieRepository $movieRepository ) { return $movieRepository -> findAll (); } } Analitzem alguns aspectes importants que no hem vist abans: El m\u00e8tode list t\u00e9 una anotaci\u00f3 @Rest\\Get que \u00e9s similar a @Route per\u00f2 permet especificar la sol\u00b7licitud que s'atendr\u00e0 (GET, en aquest cas), i la ruta associada (hem indicat /api/v1/movies , la qual cosa significa que s'atenen peticions GET a /api/v1/movies , que \u00e9s la ruta base de la classe). Dins del m\u00e8tode, simplement obtenim, el llistat de totes les pel\u00b7l\u00edcules que ja es mostra serialitzat a JSON, gr\u00e0cies a la configuraci\u00f3 que hem realitzat. Inserci\u00f3 de recursos POST ( /api/v1/movies ) Hi ha diverses alternatives per\u00f2 per simplificar la gesti\u00f3 de les insercions la farem amb l'ajuda del component symfony/form que caldr\u00e0 instal\u00b7lar. composer require form Amb l'ordre make:form crearem un el formulari que quedar\u00e0 aix\u00ed: namespace App\\Form ; use App\\Entity\\Movie ; use Symfony\\Component\\Form\\AbstractType ; use Symfony\\Component\\Form\\Extension\\Core\\Type\\DateType ; use Symfony\\Component\\Form\\FormBuilderInterface ; use Symfony\\Component\\OptionsResolver\\OptionsResolver ; class MovieType extends AbstractType { public function buildForm ( FormBuilderInterface $builder , array $options ) : void { $builder -> add ( 'title' ) -> add ( 'poster' ) -> add ( 'overview' ) -> add ( 'releaseDate' , DateType :: class , [ \"widget\" => \"single_text\" ]) -> add ( 'updatedAt' ) -> add ( 'genre' ) -> add ( 'user' ) ; } public function configureOptions ( OptionsResolver $resolver ) : void { $resolver -> setDefaults ([ 'data_class' => Movie :: class , 'csrf_protection' => false ]); } } En aquest formulari no ens preocupem pel tipus de control a mostrar perqu\u00e8 no \u00e9s rellevant excepte en el cas de la data, que s\u00ed que cal especificar que espera la data com un text. Afegim tamb\u00e9 les propietats que formen part de relacions user i genre . En el cas de les opcions de configuraci\u00f3 cal indicar que no usarem protecci\u00f3 CSRF. El sistema de control d'acc\u00e9s l'implementarem m\u00e9s endavant. El controlador quedaria aix\u00ed /** * @Rest\\Post(path=\"/movies\", name=\"api_movies_create\") * @Rest\\View(serializerGroups={\"movie\"}, serializerEnableMaxDepthChecks=true) */ public function new ( Request $request , EntityManagerInterface $entityManager ) { $movie = new Movie (); $form = $this -> createForm ( MovieType :: class , $movie ); $data = json_decode ( $request -> getContent (), true ); $form -> submit ( $data ); if ( $form -> isSubmitted () && $form -> isValid ()) { $entityManager -> persist ( $movie ); $entityManager -> flush (); return $this -> view ( $movie , Response :: HTTP_CREATED ); } return $this -> view ( $form , Response :: HTTP_BAD_REQUEST ); } Despr\u00e9s de crear els dos objectes el que fem \u00e9s obtenir les dades del body de la sol\u00b7licitud, les convertim en un array associatiu i les processem mitjan\u00e7ant el formulari. Com que volem modificar el codi d'estat passem la informaci\u00f3 a la vista. Respecte a les entitats relacionades el que fem \u00e9s enviar l'identificador en sol\u00b7licitud JSON, per exemple: { \"title\" : \"Ava\" , \"releaseDate\" : \"2021-09-24\" , \"genre\" : 9 , \"overview\" : \"Lorem ipsum ...\" , \"poster\" : \"unnamed.jpg\" , \"user\" : 7 } La resta de verbs (PUT i DELETE) es poden implementar seguint la mateixa estructura. Recursos En Primeros pasos con Symfony 5 como API REST es genera una API basada en els mateixos components que hem utilitzat. En Getting started REST API with Symfony 4 s'utilitzen diversos components addicionals com el Fos-Rest-Bundle i JMS Serializer. En Curso de Symfony 5. Creando una API desde cero teniu un curs molt complet sobre com crear una API en Symfony 5 des de cero. API Platform \u00e9s un framework que permet crear API de forma quasi autom\u00e0tica en Symfony. https://medium.com/francisco-ugalde/restful-api-con-symfony-4-jwt-parte-1-2accdf59a0ae","title":"Desenvolupament de serveis REST amb Symfony"},{"location":"09-rest-api/05-rest-api-symfony/#desenvolupament-de-serveis-rest-amb-symfony","text":"","title":"Desenvolupament de serveis REST amb Symfony"},{"location":"09-rest-api/05-rest-api-symfony/#construint-una-api-rest-basica","text":"Vegem ara quins passos donar per a construir una API REST que done suport a les operacions b\u00e0siques sobre una o diverses entitats: consultes (GET), insercions (POST), modificacions (PUT) i esborrats (DELETE). A l'hora d'implementar una soluci\u00f3 en Symfony ens trobem en tres opcions: API senzilla amb els m\u00e8todes que ens proporciona la classe AbstractController . Fer \u00fas d'un bundle com FOSRestBundle que ens permet una major flexibilitat. Fer \u00fas d' API platform , una ferramenta molt completa basada en PHP per a crear REST API. L'elecci\u00f3 d'una soluci\u00f3 o altra dependr\u00e0 de cada projecte. En aquest curs emprarem FOSRestBundle .","title":"Construint una API REST b\u00e0sica"},{"location":"09-rest-api/05-rest-api-symfony/#arrencada-del-projecte","text":"El projecte d'exemple ser\u00e0 una projecte independent basat en Movies. Aix\u00ed podrem aprofitar el model de dades. Primerament crearem el projecte de Symfony: composer create-project symfony/skeleton api-movies-symfony ^5.4 En aquesta ordre crearem un projecte b\u00e0sic de Symfony en la versi\u00f3 5.4, es tracta d'un projecte que no inclou ni Doctrine, ni Twig, per exemple. Twig no ser\u00e0 necessari ja que es tracta d'una API per\u00f2 Doctrine, s\u00ed. A m\u00e9s, caldran altres components que instal\u00b7larem a continuaci\u00f3: composer require orm composer require orm-fixtures --dev composer require security composer require symfony/maker-bundle composer require symfony/validator composer require symfony/apache-pack composer require sensio/framework-extra-bundle El model del dades, les entitats i els repositoris el copiarem del projecte Movies. Caldr\u00e0 instal\u00b7lar tamb\u00e9 els components que s'usen per a la generaci\u00f3 de les dades: composer require woodsandwalker/faker-picture --dev composer require FakerPHP/Faker --dev Llevarem les refer\u00e8ncies a VichUploader, ja que usarem els formularis d'una altra forma.","title":"Arrencada del projecte"},{"location":"09-rest-api/05-rest-api-symfony/#installant-els-bundles-necessaris","text":"A m\u00e9s del que ja tenim instal\u00b7lat caldr\u00e0 fer \u00fas d'un bundle espec\u00edfic per a desenvolupar APIs, anomenat FOSRestBundle . Est\u00e0 creat per l'equip de desenvolupament Friends Of Symfony , responsable de diversos bundles populars per a aquest framework. A m\u00e9s, aquest bundle requereix d'un altre addicional, que s'encarregar\u00e0 de serializar/deserializar les dades que s'envien client i servidor, emprant el format JSON (encara que es pot triar un altre format, com XML o HTML, per\u00f2 ens centrarem en JSON). Aquest bundle s'anomena Serializer . Abans de continuar, alguns conceptes: Serialitzar . La serialitzaci\u00f3 \u00e9s el proc\u00e9s de convertir un objecte en una altre format per a emmagatzemar-lo o transmetre'l i posteriorment ser decodificat. Normalitzar. Ajuden en el proc\u00e9s de serialitzaci\u00f3, convertint els objectes en un element intermig, com pot ser una array. Resumint, aquests s\u00f3n els comandos que necessitarem (i en aquest ordre): composer require symfony/serializer composer require friendsofsymfony/rest-bundle","title":"Instal\u00b7lant els bundles necessaris"},{"location":"09-rest-api/05-rest-api-symfony/#configurant-el-serialitzador","text":"# config/packages/framework.yaml framework : ... serializer : enabled : true mapping : paths : [ '%kernel.project_dir%/config/serializer/' ] Definim els grups de serialitzaci\u00f3 de les entitats. # config/serializer/Movie.yaml App\\Entity\\Movie : attributes : id : groups : [ 'movie' ] title : groups : [ 'movie' ] poster : groups : [ 'movie' ] overview : groups : [ 'movie' ] rating : groups : [ 'movie' ] releaseDate : groups : [ 'movie' ] Configurem FOSRestbundle . # config/packages/fos_rest.yaml # Read the documentation: https://symfony.com/doc/master/bundles/FOSRestBundle/index.html fos_rest : param_fetcher_listener : true view : empty_content : 200 view_response_listener : true failed_validation : HTTP_BAD_REQUEST formats : json : true xml : false body_listener : decoders : json : fos_rest.decoder.json format_listener : rules : - { path : '/api' , priorities : [ 'json' ], fallback_format : json , prefer_extension : false } - { path : '^/' , stop : true , fallback_format : html } exception : enabled : true serializer : serialize_null : true","title":"Configurant el serialitzador"},{"location":"09-rest-api/05-rest-api-symfony/#definint-els-serveis","text":"Ara que ja tenim instal\u00b7lat el necessari per a comen\u00e7ar a definir els serveis, anem al que \u00e9s important. Crearem una nova classe, on definirem els serveis b\u00e0sics sobre l'entitat Movie . Cridarem a aquesta classe ApiMovieController , i l'afegirem en la carpeta src/Controller : La classe t\u00e9 una anotaci\u00f3 @Route , que implica que qualsevol ruta que indiquem dins va a tenir aqueix prefix (en aquest cas, totes les rutes dels m\u00e8todes interns tindran el prefix /api/v1/movies ).","title":"Definint els serveis"},{"location":"09-rest-api/05-rest-api-symfony/#llistat-de-tots-els-elements-get","text":"Afegirem un m\u00e8tode a la nostra classe anterior perqu\u00e8 torne, en format JSON totes les pel\u00b7l\u00edcules de la base de dades. El codi del m\u00e8tode \u00e9s el seg\u00fcent: class ApiMovieController extends AbstractFOSRestController { /** * @Rest\\Get(path=\"/api/v1/movies\", name=\"api_movies\") * @Rest\\View(serializerGroups={\"movie\"}, serializerEnableMaxDepthChecks=true) */ public function list ( MovieRepository $movieRepository ) { return $movieRepository -> findAll (); } } Analitzem alguns aspectes importants que no hem vist abans: El m\u00e8tode list t\u00e9 una anotaci\u00f3 @Rest\\Get que \u00e9s similar a @Route per\u00f2 permet especificar la sol\u00b7licitud que s'atendr\u00e0 (GET, en aquest cas), i la ruta associada (hem indicat /api/v1/movies , la qual cosa significa que s'atenen peticions GET a /api/v1/movies , que \u00e9s la ruta base de la classe). Dins del m\u00e8tode, simplement obtenim, el llistat de totes les pel\u00b7l\u00edcules que ja es mostra serialitzat a JSON, gr\u00e0cies a la configuraci\u00f3 que hem realitzat.","title":"Llistat de tots els elements (GET /)"},{"location":"09-rest-api/05-rest-api-symfony/#insercio-de-recursos-post-apiv1movies","text":"Hi ha diverses alternatives per\u00f2 per simplificar la gesti\u00f3 de les insercions la farem amb l'ajuda del component symfony/form que caldr\u00e0 instal\u00b7lar. composer require form Amb l'ordre make:form crearem un el formulari que quedar\u00e0 aix\u00ed: namespace App\\Form ; use App\\Entity\\Movie ; use Symfony\\Component\\Form\\AbstractType ; use Symfony\\Component\\Form\\Extension\\Core\\Type\\DateType ; use Symfony\\Component\\Form\\FormBuilderInterface ; use Symfony\\Component\\OptionsResolver\\OptionsResolver ; class MovieType extends AbstractType { public function buildForm ( FormBuilderInterface $builder , array $options ) : void { $builder -> add ( 'title' ) -> add ( 'poster' ) -> add ( 'overview' ) -> add ( 'releaseDate' , DateType :: class , [ \"widget\" => \"single_text\" ]) -> add ( 'updatedAt' ) -> add ( 'genre' ) -> add ( 'user' ) ; } public function configureOptions ( OptionsResolver $resolver ) : void { $resolver -> setDefaults ([ 'data_class' => Movie :: class , 'csrf_protection' => false ]); } } En aquest formulari no ens preocupem pel tipus de control a mostrar perqu\u00e8 no \u00e9s rellevant excepte en el cas de la data, que s\u00ed que cal especificar que espera la data com un text. Afegim tamb\u00e9 les propietats que formen part de relacions user i genre . En el cas de les opcions de configuraci\u00f3 cal indicar que no usarem protecci\u00f3 CSRF. El sistema de control d'acc\u00e9s l'implementarem m\u00e9s endavant. El controlador quedaria aix\u00ed /** * @Rest\\Post(path=\"/movies\", name=\"api_movies_create\") * @Rest\\View(serializerGroups={\"movie\"}, serializerEnableMaxDepthChecks=true) */ public function new ( Request $request , EntityManagerInterface $entityManager ) { $movie = new Movie (); $form = $this -> createForm ( MovieType :: class , $movie ); $data = json_decode ( $request -> getContent (), true ); $form -> submit ( $data ); if ( $form -> isSubmitted () && $form -> isValid ()) { $entityManager -> persist ( $movie ); $entityManager -> flush (); return $this -> view ( $movie , Response :: HTTP_CREATED ); } return $this -> view ( $form , Response :: HTTP_BAD_REQUEST ); } Despr\u00e9s de crear els dos objectes el que fem \u00e9s obtenir les dades del body de la sol\u00b7licitud, les convertim en un array associatiu i les processem mitjan\u00e7ant el formulari. Com que volem modificar el codi d'estat passem la informaci\u00f3 a la vista. Respecte a les entitats relacionades el que fem \u00e9s enviar l'identificador en sol\u00b7licitud JSON, per exemple: { \"title\" : \"Ava\" , \"releaseDate\" : \"2021-09-24\" , \"genre\" : 9 , \"overview\" : \"Lorem ipsum ...\" , \"poster\" : \"unnamed.jpg\" , \"user\" : 7 } La resta de verbs (PUT i DELETE) es poden implementar seguint la mateixa estructura.","title":"Inserci\u00f3 de recursos POST (/api/v1/movies)"},{"location":"09-rest-api/05-rest-api-symfony/#recursos","text":"En Primeros pasos con Symfony 5 como API REST es genera una API basada en els mateixos components que hem utilitzat. En Getting started REST API with Symfony 4 s'utilitzen diversos components addicionals com el Fos-Rest-Bundle i JMS Serializer. En Curso de Symfony 5. Creando una API desde cero teniu un curs molt complet sobre com crear una API en Symfony 5 des de cero. API Platform \u00e9s un framework que permet crear API de forma quasi autom\u00e0tica en Symfony. https://medium.com/francisco-ugalde/restful-api-con-symfony-4-jwt-parte-1-2accdf59a0ae","title":"Recursos"},{"location":"09-rest-api/06-JWT/","text":"JWT (JSON Web Token) Els mecanismes d'autenticaci\u00f3 tradicional en aplicacions web estan basats en sessions: l'usuari envia les seues credencials a trav\u00e9s d'algun formulari, el servidor ho valida i emmagatzema en la sessi\u00f3 les dades de l'usuari logueado, perqu\u00e8, mentre no caduque la sessi\u00f3 o la tanque l'usuari, puga seguir accedint sense haver de tornar a autenticar-se. No obstant a\u00e7\u00f2, aquest tipus d'autenticaci\u00f3 t\u00e9 la limitaci\u00f3 de ser exclusiva per a aplicacions web, \u00e9s a dir, per a clients web que es connecten a servidors web. Si volgu\u00e9rem adaptar l'aplicaci\u00f3 a m\u00f2bil, o a una versi\u00f3 d'escriptori, no podr\u00edem seguir emprant aquest mecanisme. Per a superar aquest escull, podem utilitzar l'autenticaci\u00f3 basada en tokens. Aquesta \u00e9s una autenticaci\u00f3 \"sense estat\" (stateless), la qual cosa significa que no s'emmagatzema gens entre client i servidor per a seguir accedint autenticats. El que es fa \u00e9s el seg\u00fcent: El client envia al servidor les seues credencials (usuari i password) El servidor les valguda, i si s\u00f3n correctes, genera una cadena xifrada anomenada token, que cont\u00e9 la validaci\u00f3 de l'usuari, a m\u00e9s de certa informaci\u00f3 addicional que puguem voler afegir (com el login de l'usuari, per exemple). Aquest token s'envia de tornada a l'usuari com a resposta a la seua autenticaci\u00f3. A partir d'aquest punt, cada vegada que el client vulga autenticar-se contra el servidor per a sol\u00b7licitar un recurs, n'hi ha prou que envie el token que el servidor li va proporcionar. El servidor s'encarregar\u00e0 de verificar-ho per a comprovar que \u00e9s correcte, i donar-li acc\u00e9s o denegar-li-ho. Igual que les sessions, els tokens tamb\u00e9 poden tenir una caducitat, que s'indica dins del propi token. Si, passat aqueix temps, el servidor rep el token, ho descartar\u00e0 com a inv\u00e0lid (caducat), i el client tornar\u00e0 a no estar autenticat. JSON Web Token \u00e9s un est\u00e0ndard obert (RFC 7519) que defineix un mode compacte i aut\u00f2nom de transmetre de forma segura la informaci\u00f3 entre dues parts com un objecte JSON. Aquesta informaci\u00f3 pot ser verificada i \u00e9s fiable perqu\u00e8 est\u00e0 signada digitalment. Els JWT es poden signar usant un secret (amb l'algoritme HMAC) o utilitzant un parell de claus p\u00fabliques/privades usant RSA i contenen la informaci\u00f3 de l'usuari autenticat (el nom d'usuari, per exemple) Estructura del token Exemple de token extret de jwt.io Cicle de vida del token JWT Intercanvi de missatges Implementaci\u00f3 en Symfony Per a poder treballar amb JWT en Symfony, podem emprar (entre uns altres) el bundle lexik/LexikJWTAuthenticationBundle , que s'instal\u00b7la d'aquesta manera: composer require jwt-auth A m\u00e9s, necessitarem afegir el bundle de seguretat de Symfony: composer require security Entitat User Caldr\u00e0 disposar d'una entitat que implemente la interf\u00edcie UserInterface que ja tenim del projecte anterior. Endpoints Usarem dos endpoints : /api/login ser\u00e0 la ruta on es troba el formulari. /api/login_check ser\u00e0 la ruta que valida les credencials. Generaci\u00f3 de certificats Per a poder codificar els tokens, \u00e9s necessari generar uns parell de certificats. Generarem un de privat per a generar el token quan l'usuari es valide, i un p\u00fablic per a poder-lo validar quan l'usuari ho envie. Per a a\u00e7\u00f2, executem aquestes ordre des del directori arrel del projecte. Quan ens ho demane, triarem com passphrase la paraula movies (\u00e9s nom\u00e9s una paraula o frase que utilitzar per a xifrar el contingut, triem aqueixa per exemple): mkdir config/jwt openssl genrsa -out config/jwt/private.pem -aes256 4096 openssl rsa -pubout -in config/jwt/private.pem -out config/jwt/public.pem Amb aquestes ordres hem creat (1) una clau privada basada en l'algorisme AES i (2) una p\u00fablica a partir de la privada. Configuraci\u00f3 del fitxer .env Ara hem d'editar tamb\u00e9 el fitxer .env o .env.local (millor aquest) i afegir aquestes l\u00ednies: JWT_SECRET_KEY=%kernel.project_dir%/config/jwt/private.pem JWT_PUBLIC_KEY=%kernel.project_dir%/config/jwt/public.pem JWT_PASSPHRASE=movies JWT_TOKENTTL=3600 L'atribut JWT_PASSPHRASE haur\u00e0 de coincidir amb el que hem indicat en generar els certificats en el pas anterior (movies, en el nostre cas). L'atribut JWT_TOKENTTL \u00e9s el temps de vida o caducitat del token, en segons. En aquest cas, li donem un temps de validesa d'una hora. Configuraci\u00f3 de config/packages/lexik_authentication.yaml Aquest fitxer quedar\u00e0 d'aquesta manera, en el qual indiquem on estan generades la clau privada i p\u00fablica, la paraula de xifrat i el temps de vida: lexik_jwt_authentication : secret_key : '%env(resolve:JWT_SECRET_KEY)%' # required for token creation public_key : '%env(resolve:JWT_PUBLIC_KEY)%' # required for token verification pass_phrase : '%env(JWT_PASSPHRASE)%' # required for token creation token_ttl : % env(JWT_TOKENTTL)% # in seconds, default is 3600 Configuraci\u00f3 de config/packages/security.yaml L'arxiu principal de seguretat config/packages/security.yaml haur\u00e0 de contenir aquests atributs per a l'autenticaci\u00f3 per token : # Symfony 5.3 and higher security : enable_authenticator_manager : true # ... # user provider, password hasher and so on... # # ... firewalls : login : pattern : ^/api/login stateless : true json_login : check_path : /api/login_check success_handler : lexik_jwt_authentication.handler.authentication_success failure_handler : lexik_jwt_authentication.handler.authentication_failure api : pattern : ^/api stateless : true jwt : ~ access_control : - { path : ^/api/login , roles : PUBLIC_ACCESS } - { path : ^/api , roles : IS_AUTHENTICATED_FULLY } Caldr\u00e0 afegir tamb\u00e9 la seg\u00fcent ruta en config/routes.yaml : api_login_check : path : /api/login_check El que hem definit en aquest fitxer \u00e9s: El firewall login que s'activar\u00e0 en accedir a la ruta api/login . Ruta que ser\u00e0 p\u00fablica, com s'observa en access_control . json_login indica que s'espera una sol\u00b7licitud via JSON. El firewall api s'activar\u00e0 en la resta de rutes de la API, on s'indicar\u00e0 que cap aplicar l'autenticaci\u00f3 jwt. jwt: ~ activa l'autenticador JWT. Provant l'autenticaci\u00f3 Per a provar que l'autenticaci\u00f3 funciona, crearem una nova petici\u00f3 POST en Postman a la URI /api/login_check , i li passem en el cos de la petici\u00f3 l'usuari ( username ) i la contrasenya ( password ). En aquest exemple, suposem que l'usuari \u00e9s user i la contrasenya (sense encriptar) \u00e9s user . Haurem d'afegir tamb\u00e9 una cap\u00e7alera (Header) amb l'atribut Content\u00adType establit a application/json. Si tot va correctament, rebrem com a resposta un token: Provant l'autenticaci\u00f3 amb Postman Si analitzem el token obtindrem: An\u00e0lisi del token La signatura \u00e9s inv\u00e0lida ja que no s'ha pogut verificar amb les claus p\u00fablica i privada. Provant l'autoritzaci\u00f3 Ara, provarem a obtenir un llistat de pel\u00b7l\u00edcules. Si llancem la petici\u00f3 en Postman sense cap tipus d'autoritzaci\u00f3, rebrem aquest missatge de tornada: { \"code\" : 401 , \"message\" : \"JWT Token not found\" } Hem d'afegir una cap\u00e7alera Authorization el valor de la qual siga el prefix \"Bearer \" (incloent l'espai final) seguit del token que ens ha enviat el servidor en autenticar-nos: Sol\u00b7licitud amb el token incl\u00f2s D'aquesta forma s\u00ed que obtindrem el llistat de pel\u00b7l\u00edcules. Haurem de procedir de la mateixa forma (enviant el token en la cap\u00e7alera Authorization ) per a poder emprar la resta de peticions. Recursos https://jwt.io/ LexikJWTAuthenticationBundle https://enmilocalfunciona.io/construyendo-una-web-api-rest-segura-con-json-web-token-en-net-parte-i/ https://www.adictosaltrabajo.com/2017/09/25/securizar-un-api-rest-utilizando-json-web-tokens/ https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS","title":"JWT (JSON Web Token)"},{"location":"09-rest-api/06-JWT/#jwt-json-web-token","text":"Els mecanismes d'autenticaci\u00f3 tradicional en aplicacions web estan basats en sessions: l'usuari envia les seues credencials a trav\u00e9s d'algun formulari, el servidor ho valida i emmagatzema en la sessi\u00f3 les dades de l'usuari logueado, perqu\u00e8, mentre no caduque la sessi\u00f3 o la tanque l'usuari, puga seguir accedint sense haver de tornar a autenticar-se. No obstant a\u00e7\u00f2, aquest tipus d'autenticaci\u00f3 t\u00e9 la limitaci\u00f3 de ser exclusiva per a aplicacions web, \u00e9s a dir, per a clients web que es connecten a servidors web. Si volgu\u00e9rem adaptar l'aplicaci\u00f3 a m\u00f2bil, o a una versi\u00f3 d'escriptori, no podr\u00edem seguir emprant aquest mecanisme. Per a superar aquest escull, podem utilitzar l'autenticaci\u00f3 basada en tokens. Aquesta \u00e9s una autenticaci\u00f3 \"sense estat\" (stateless), la qual cosa significa que no s'emmagatzema gens entre client i servidor per a seguir accedint autenticats. El que es fa \u00e9s el seg\u00fcent: El client envia al servidor les seues credencials (usuari i password) El servidor les valguda, i si s\u00f3n correctes, genera una cadena xifrada anomenada token, que cont\u00e9 la validaci\u00f3 de l'usuari, a m\u00e9s de certa informaci\u00f3 addicional que puguem voler afegir (com el login de l'usuari, per exemple). Aquest token s'envia de tornada a l'usuari com a resposta a la seua autenticaci\u00f3. A partir d'aquest punt, cada vegada que el client vulga autenticar-se contra el servidor per a sol\u00b7licitar un recurs, n'hi ha prou que envie el token que el servidor li va proporcionar. El servidor s'encarregar\u00e0 de verificar-ho per a comprovar que \u00e9s correcte, i donar-li acc\u00e9s o denegar-li-ho. Igual que les sessions, els tokens tamb\u00e9 poden tenir una caducitat, que s'indica dins del propi token. Si, passat aqueix temps, el servidor rep el token, ho descartar\u00e0 com a inv\u00e0lid (caducat), i el client tornar\u00e0 a no estar autenticat. JSON Web Token \u00e9s un est\u00e0ndard obert (RFC 7519) que defineix un mode compacte i aut\u00f2nom de transmetre de forma segura la informaci\u00f3 entre dues parts com un objecte JSON. Aquesta informaci\u00f3 pot ser verificada i \u00e9s fiable perqu\u00e8 est\u00e0 signada digitalment. Els JWT es poden signar usant un secret (amb l'algoritme HMAC) o utilitzant un parell de claus p\u00fabliques/privades usant RSA i contenen la informaci\u00f3 de l'usuari autenticat (el nom d'usuari, per exemple)","title":"JWT (JSON Web Token)"},{"location":"09-rest-api/06-JWT/#estructura-del-token","text":"Exemple de token extret de jwt.io","title":"Estructura del token"},{"location":"09-rest-api/06-JWT/#cicle-de-vida-del-token-jwt","text":"Intercanvi de missatges","title":"Cicle de vida del token JWT"},{"location":"09-rest-api/06-JWT/#implementacio-en-symfony","text":"Per a poder treballar amb JWT en Symfony, podem emprar (entre uns altres) el bundle lexik/LexikJWTAuthenticationBundle , que s'instal\u00b7la d'aquesta manera: composer require jwt-auth A m\u00e9s, necessitarem afegir el bundle de seguretat de Symfony: composer require security","title":"Implementaci\u00f3 en Symfony"},{"location":"09-rest-api/06-JWT/#entitat-user","text":"Caldr\u00e0 disposar d'una entitat que implemente la interf\u00edcie UserInterface que ja tenim del projecte anterior.","title":"Entitat User"},{"location":"09-rest-api/06-JWT/#endpoints","text":"Usarem dos endpoints : /api/login ser\u00e0 la ruta on es troba el formulari. /api/login_check ser\u00e0 la ruta que valida les credencials.","title":"Endpoints"},{"location":"09-rest-api/06-JWT/#generacio-de-certificats","text":"Per a poder codificar els tokens, \u00e9s necessari generar uns parell de certificats. Generarem un de privat per a generar el token quan l'usuari es valide, i un p\u00fablic per a poder-lo validar quan l'usuari ho envie. Per a a\u00e7\u00f2, executem aquestes ordre des del directori arrel del projecte. Quan ens ho demane, triarem com passphrase la paraula movies (\u00e9s nom\u00e9s una paraula o frase que utilitzar per a xifrar el contingut, triem aqueixa per exemple): mkdir config/jwt openssl genrsa -out config/jwt/private.pem -aes256 4096 openssl rsa -pubout -in config/jwt/private.pem -out config/jwt/public.pem Amb aquestes ordres hem creat (1) una clau privada basada en l'algorisme AES i (2) una p\u00fablica a partir de la privada.","title":"Generaci\u00f3 de certificats"},{"location":"09-rest-api/06-JWT/#configuracio-del-fitxer-env","text":"Ara hem d'editar tamb\u00e9 el fitxer .env o .env.local (millor aquest) i afegir aquestes l\u00ednies: JWT_SECRET_KEY=%kernel.project_dir%/config/jwt/private.pem JWT_PUBLIC_KEY=%kernel.project_dir%/config/jwt/public.pem JWT_PASSPHRASE=movies JWT_TOKENTTL=3600 L'atribut JWT_PASSPHRASE haur\u00e0 de coincidir amb el que hem indicat en generar els certificats en el pas anterior (movies, en el nostre cas). L'atribut JWT_TOKENTTL \u00e9s el temps de vida o caducitat del token, en segons. En aquest cas, li donem un temps de validesa d'una hora.","title":"Configuraci\u00f3 del fitxer .env"},{"location":"09-rest-api/06-JWT/#configuracio-de-configpackageslexik_authenticationyaml","text":"Aquest fitxer quedar\u00e0 d'aquesta manera, en el qual indiquem on estan generades la clau privada i p\u00fablica, la paraula de xifrat i el temps de vida: lexik_jwt_authentication : secret_key : '%env(resolve:JWT_SECRET_KEY)%' # required for token creation public_key : '%env(resolve:JWT_PUBLIC_KEY)%' # required for token verification pass_phrase : '%env(JWT_PASSPHRASE)%' # required for token creation token_ttl : % env(JWT_TOKENTTL)% # in seconds, default is 3600","title":"Configuraci\u00f3 de config/packages/lexik_authentication.yaml"},{"location":"09-rest-api/06-JWT/#configuracio-de-configpackagessecurityyaml","text":"L'arxiu principal de seguretat config/packages/security.yaml haur\u00e0 de contenir aquests atributs per a l'autenticaci\u00f3 per token : # Symfony 5.3 and higher security : enable_authenticator_manager : true # ... # user provider, password hasher and so on... # # ... firewalls : login : pattern : ^/api/login stateless : true json_login : check_path : /api/login_check success_handler : lexik_jwt_authentication.handler.authentication_success failure_handler : lexik_jwt_authentication.handler.authentication_failure api : pattern : ^/api stateless : true jwt : ~ access_control : - { path : ^/api/login , roles : PUBLIC_ACCESS } - { path : ^/api , roles : IS_AUTHENTICATED_FULLY } Caldr\u00e0 afegir tamb\u00e9 la seg\u00fcent ruta en config/routes.yaml : api_login_check : path : /api/login_check El que hem definit en aquest fitxer \u00e9s: El firewall login que s'activar\u00e0 en accedir a la ruta api/login . Ruta que ser\u00e0 p\u00fablica, com s'observa en access_control . json_login indica que s'espera una sol\u00b7licitud via JSON. El firewall api s'activar\u00e0 en la resta de rutes de la API, on s'indicar\u00e0 que cap aplicar l'autenticaci\u00f3 jwt. jwt: ~ activa l'autenticador JWT.","title":"Configuraci\u00f3 de config/packages/security.yaml"},{"location":"09-rest-api/06-JWT/#provant-lautenticacio","text":"Per a provar que l'autenticaci\u00f3 funciona, crearem una nova petici\u00f3 POST en Postman a la URI /api/login_check , i li passem en el cos de la petici\u00f3 l'usuari ( username ) i la contrasenya ( password ). En aquest exemple, suposem que l'usuari \u00e9s user i la contrasenya (sense encriptar) \u00e9s user . Haurem d'afegir tamb\u00e9 una cap\u00e7alera (Header) amb l'atribut Content\u00adType establit a application/json. Si tot va correctament, rebrem com a resposta un token: Provant l'autenticaci\u00f3 amb Postman Si analitzem el token obtindrem: An\u00e0lisi del token La signatura \u00e9s inv\u00e0lida ja que no s'ha pogut verificar amb les claus p\u00fablica i privada.","title":"Provant l'autenticaci\u00f3"},{"location":"09-rest-api/06-JWT/#provant-lautoritzacio","text":"Ara, provarem a obtenir un llistat de pel\u00b7l\u00edcules. Si llancem la petici\u00f3 en Postman sense cap tipus d'autoritzaci\u00f3, rebrem aquest missatge de tornada: { \"code\" : 401 , \"message\" : \"JWT Token not found\" } Hem d'afegir una cap\u00e7alera Authorization el valor de la qual siga el prefix \"Bearer \" (incloent l'espai final) seguit del token que ens ha enviat el servidor en autenticar-nos: Sol\u00b7licitud amb el token incl\u00f2s D'aquesta forma s\u00ed que obtindrem el llistat de pel\u00b7l\u00edcules. Haurem de procedir de la mateixa forma (enviant el token en la cap\u00e7alera Authorization ) per a poder emprar la resta de peticions.","title":"Provant l'autoritzaci\u00f3"},{"location":"09-rest-api/06-JWT/#recursos","text":"https://jwt.io/ LexikJWTAuthenticationBundle https://enmilocalfunciona.io/construyendo-una-web-api-rest-segura-con-json-web-token-en-net-parte-i/ https://www.adictosaltrabajo.com/2017/09/25/securizar-un-api-rest-utilizando-json-web-tokens/ https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS","title":"Recursos"},{"location":"UD11/","text":"1. Instal\u00b7laci\u00f3 i configuraci\u00f3 de Symfony a) Arquitectura MVC b) Introducci\u00f3 a YALM 2. Vistes a) Motor de plantilles Twig 3. Injecci\u00f3 de depend\u00e8ncies: Contenidors de serveis. 4. Model a) Doctrine 5. Creaci\u00f3 i validaci\u00f3 de formularis 6. Seguretat i Control d'acc\u00e9s 7. Bundles.","title":"11. Introducci\u00f3 a Symfony (old)"},{"location":"UD11/11.01/","text":"Introducci\u00f3 a Symfony {: .no_toc } Taula de continguts {: .no_toc .text-delta .nocount } TOC Introducci\u00f3 Symfony \u00e9s un framework dissenyat per desenvolupar aplicacions web basat en el patr\u00f3 Model Vista Controlador. Per comen\u00e7ar, separa la l\u00f2gica de negoci, la l\u00f2gica de servidor i la presentaci\u00f3 de l'aplicaci\u00f3 web. Proporciona diverses eines i classes encaminades a reduir el temps de desenvolupament d'una aplicaci\u00f3 web complexa. A m\u00e9s, automatitza les tasques m\u00e9s comunes, permetent el desenvolupador dedicar-se completament als aspectes espec\u00edfics de cada aplicaci\u00f3. {: .alert .alert-info} Qu\u00e8 \u00e9s un framework ? {: .no_toc .nocount } Un framework, entorn de treball o marc de treball \u00e9s un conjunt estandarditzat de conceptes, pr\u00e0ctiques i criteris per enfocar un tipus de problem\u00e0tica particular que serveix com a refer\u00e8ncia, per enfrontar i resoldre nous problemes d'\u00edndole similar. En el desenvolupament de programari, un entorn de treball \u00e9s una estructura conceptual i tecnol\u00f2gica d'assist\u00e8ncia definida, normalment, amb artefactes o m\u00f2duls concrets de programari, que pot servir de base per a l'organitzaci\u00f3 i desenvolupament de programari. T\u00edpicament, pot incloure suport de programes, biblioteques, i un llenguatge interpretat, entre d'altres eines, per aix\u00ed ajudar a desenvolupar i unir els diferents components d'un projecte. Representa una arquitectura de programari que modela les relacions generals de les entitats del domini, i proveeix una estructura i una especial metodologia de treball, la qual est\u00e9n o utilitza les aplicacions del domini. Symfony est\u00e0 desenvolupat completament en PHP 5.3. \u00c9s compatible amb la majoria de gestors de bases de dades, com MySQL, PostgreSQL, Oracle i Microsoft SQL Server. Es pot executar tant en plataformes * nix (Unix, Linux, etc.) com en plataformes Windows. Altres frameworks que podem trobar basats en l'arquitectura MVC s\u00f3n: PHP: Laravel, Phalcon, CakePHP Ruby: Ruby on Rails .NET: Spring.NET, ASP.NET MVC Java: Spring Python: Django, Zope3 Caracter\u00edstiques Symfony va ser dissenyat per ajustar-se als seg\u00fcents requisits: F\u00e0cil d'instal\u00b7lar i configurar en la majoria de plataformes (i amb la garantia que funciona correctament en els sistemes Windows i Unix-like est\u00e0ndards). Independent de el sistema gestor de bases de dades. La seva capa d'abstracci\u00f3 i l'\u00fas de ORM (Doctrine 2, Propel) , permeten canviar amb facilitat de SGBD en qualsevol fase de projecte. Utilitza programaci\u00f3 orientada a objectes i caracter\u00edstiques com els espais de noms, d'aqu\u00ed que sigui imprescindible PHP > 5.3. Senzill d'utilitzar en la majoria de casos, encara que \u00e9s preferible per al desenvolupament de grans aplicacions web que per a petits projectes. Encara que utilitza Model Vista Controlador (MVC), t\u00e9 la seva pr\u00f2pia forma de treball en aquest punt, amb variants del MVC cl\u00e0ssic com la capa d'abstracci\u00f3 de base de dades, el controlador frontal i les accions. Basat en la premissa de \"convenir en comptes de configurar\", en la qual el desenvolupador nom\u00e9s ha de configurar all\u00f2 que no \u00e9s convencional. Segueix la majoria de millors pr\u00e0ctiques i patrons de disseny per a la web. Preparat per a aplicacions empresarials i adaptable a les pol\u00edtiques i arquitectures pr\u00f2pies de cada empresa, a m\u00e9s de ser prou estable com per a desenvolupar aplicacions a llarg termini. Codi f\u00e0cil de llegir que inclou comentaris de phpDocumentor i que permet un manteniment molt senzill. F\u00e0cil d'estendre, el que permet la seva integraci\u00f3 amb les biblioteques d'altres fabricants. Una l\u00ednia d'ordres que facilita la generaci\u00f3 de codi. Symfony reutilitza conceptes i desenvolupaments de tercers que han tingut \u00e8xit: Doctrine : framework ORM per a PHP Twig : poder\u00f3s motor de plantilles Llenguatge YAML , competidor de l'XML, configuraci\u00f3 totalment separada del codi. Instruccions de consola denominades tasks (tasques), que ens permeten executar ordres a la terminal Subframework per treballar amb formularis Ampli suport per a la seguretat del lloc: SQL Injection, XSS o CSRF \u00das de Composer per generar les depend\u00e8ncies A partir de la versi\u00f3 4 s'utilitza una nova eina pr\u00f2pia de Symfony (Flex) que ens facilita aquesta tasca Introducci\u00f3 a YAML Els fitxers de configuraci\u00f3 de Symfony es poden escriure en PHP, en XML o en YAML. S\u00f3n equivalents a nivell de rendiment (tots es transformen a PHP abans d'executar l'aplicaci\u00f3). PHP \u00e9s m\u00e9s flexible, per\u00f2 m\u00e9s complicat XML \u00e9s el m\u00e9s llarg d'escriure, per\u00f2 es pot validar. YAML \u00e9s m\u00e9s conc\u00eds que XML, per\u00f2 no podem validar. En Symfony, per defecte s'utilitza YAML Sintaxis de YAML Cinc conceptes b\u00e0sics: * No admet tabulacions, nom\u00e9s espais * La informaci\u00f3 s'indica mitjan\u00e7ant parells clau: valor (si la clau o el valor tenen espais en blanc, es tanquen amb cometes simples o dobles) * La jerarquia de la informaci\u00f3 s'estableix escrivint 4 espais en blanc per davant del parell clau: valor * Els arrays normals s'indiquen amb els claud\u00e0tors [i] i els arrays associatius amb les claus {i} * Tamb\u00e9 podem indicar una matriu escrivint cada element en una nova l\u00ednia que comenci per - * Els comentaris s'indiquen prefixant el car\u00e0cter # per davant de cadascuna de les seves l\u00ednies Alguns exemples homepage : path : /{_locale} controller : Symfony\\Bundle\\FrameworkBundle\\Controller\\TemplateController::templateAction requirements : _locale : '%app_locales%' defaults : template : default/homepage.html.twig _locale : '%locale%' security : encoders : # Our user class and the algorithm we'll use to encode passwords # 'auto' means to let Symfony choose the best possible password hasher (Argon2 or Bcrypt) # https://symfony.com/doc/current/security.html#c-encoding-the-user-s-password App\\Entity\\User : 'auto' providers : # https://symfony.com/doc/current/security.html#b-configuring-how-users-are-loaded # In this example, users are stored via Doctrine in the database # To see the users at src/App/DataFixtures/ORM/LoadFixtures.php # To load users from somewhere else: https://symfony.com/doc/current/security/custom_provider.html database_users : entity : { class : App\\Entity\\User , property : username } # https://symfony.com/doc/current/security.html#initial-security-yml-setup-authentication firewalls : dev : pattern : ^/(_(profiler|wdt)|css|images|js)/ security : false main : # this firewall applies to all URLs pattern : ^/ # but the firewall does not require login on every page # denying access is done in access_control or in your controllers anonymous : true # This allows the user to login by submitting a username and password # Reference: https://symfony.com/doc/current/security/form_login_setup.html form_login : # The route name that the login form submits to check_path : security_login # The name of the route where the login form lives # When the user tries to access a protected page, they are redirected here login_path : security_login # Secure the login form against CSRF # Reference: https://symfony.com/doc/current/security/csrf_in_login_form.html csrf_token_generator : security.csrf.token_manager # The page users are redirect to when there is no previous page stored in the # session (for example when the users access directly to the login page). default_target_path : blog_index logout : # The route name the user can go to in order to logout path : security_logout # The name of the route to redirect to after logging out target : homepage access_control : # this is a catch-all for the admin area # additional security lives in the controllers - { path : '^/(%app_locales%)/admin' , roles : ROLE_ADMIN } role_hierarchy : ROLE_ADMIN : ROLE_USER Recursos https://es.wikipedia.org/wiki/Framework https://es.wikipedia.org/wiki/Symfony","title":"11.1. Introducci\u00f3"},{"location":"UD11/11.01/#introduccio-a-symfony","text":"{: .no_toc }","title":"Introducci\u00f3 a Symfony"},{"location":"UD11/11.01/#taula-de-continguts","text":"{: .no_toc .text-delta .nocount } TOC","title":"Taula de continguts"},{"location":"UD11/11.01/#introduccio","text":"Symfony \u00e9s un framework dissenyat per desenvolupar aplicacions web basat en el patr\u00f3 Model Vista Controlador. Per comen\u00e7ar, separa la l\u00f2gica de negoci, la l\u00f2gica de servidor i la presentaci\u00f3 de l'aplicaci\u00f3 web. Proporciona diverses eines i classes encaminades a reduir el temps de desenvolupament d'una aplicaci\u00f3 web complexa. A m\u00e9s, automatitza les tasques m\u00e9s comunes, permetent el desenvolupador dedicar-se completament als aspectes espec\u00edfics de cada aplicaci\u00f3. {: .alert .alert-info}","title":"Introducci\u00f3"},{"location":"UD11/11.01/#que-es-un-framework","text":"{: .no_toc .nocount } Un framework, entorn de treball o marc de treball \u00e9s un conjunt estandarditzat de conceptes, pr\u00e0ctiques i criteris per enfocar un tipus de problem\u00e0tica particular que serveix com a refer\u00e8ncia, per enfrontar i resoldre nous problemes d'\u00edndole similar. En el desenvolupament de programari, un entorn de treball \u00e9s una estructura conceptual i tecnol\u00f2gica d'assist\u00e8ncia definida, normalment, amb artefactes o m\u00f2duls concrets de programari, que pot servir de base per a l'organitzaci\u00f3 i desenvolupament de programari. T\u00edpicament, pot incloure suport de programes, biblioteques, i un llenguatge interpretat, entre d'altres eines, per aix\u00ed ajudar a desenvolupar i unir els diferents components d'un projecte. Representa una arquitectura de programari que modela les relacions generals de les entitats del domini, i proveeix una estructura i una especial metodologia de treball, la qual est\u00e9n o utilitza les aplicacions del domini. Symfony est\u00e0 desenvolupat completament en PHP 5.3. \u00c9s compatible amb la majoria de gestors de bases de dades, com MySQL, PostgreSQL, Oracle i Microsoft SQL Server. Es pot executar tant en plataformes * nix (Unix, Linux, etc.) com en plataformes Windows. Altres frameworks que podem trobar basats en l'arquitectura MVC s\u00f3n: PHP: Laravel, Phalcon, CakePHP Ruby: Ruby on Rails .NET: Spring.NET, ASP.NET MVC Java: Spring Python: Django, Zope3","title":"Qu\u00e8 \u00e9s un framework?"},{"location":"UD11/11.01/#caracteristiques","text":"Symfony va ser dissenyat per ajustar-se als seg\u00fcents requisits: F\u00e0cil d'instal\u00b7lar i configurar en la majoria de plataformes (i amb la garantia que funciona correctament en els sistemes Windows i Unix-like est\u00e0ndards). Independent de el sistema gestor de bases de dades. La seva capa d'abstracci\u00f3 i l'\u00fas de ORM (Doctrine 2, Propel) , permeten canviar amb facilitat de SGBD en qualsevol fase de projecte. Utilitza programaci\u00f3 orientada a objectes i caracter\u00edstiques com els espais de noms, d'aqu\u00ed que sigui imprescindible PHP > 5.3. Senzill d'utilitzar en la majoria de casos, encara que \u00e9s preferible per al desenvolupament de grans aplicacions web que per a petits projectes. Encara que utilitza Model Vista Controlador (MVC), t\u00e9 la seva pr\u00f2pia forma de treball en aquest punt, amb variants del MVC cl\u00e0ssic com la capa d'abstracci\u00f3 de base de dades, el controlador frontal i les accions. Basat en la premissa de \"convenir en comptes de configurar\", en la qual el desenvolupador nom\u00e9s ha de configurar all\u00f2 que no \u00e9s convencional. Segueix la majoria de millors pr\u00e0ctiques i patrons de disseny per a la web. Preparat per a aplicacions empresarials i adaptable a les pol\u00edtiques i arquitectures pr\u00f2pies de cada empresa, a m\u00e9s de ser prou estable com per a desenvolupar aplicacions a llarg termini. Codi f\u00e0cil de llegir que inclou comentaris de phpDocumentor i que permet un manteniment molt senzill. F\u00e0cil d'estendre, el que permet la seva integraci\u00f3 amb les biblioteques d'altres fabricants. Una l\u00ednia d'ordres que facilita la generaci\u00f3 de codi. Symfony reutilitza conceptes i desenvolupaments de tercers que han tingut \u00e8xit: Doctrine : framework ORM per a PHP Twig : poder\u00f3s motor de plantilles Llenguatge YAML , competidor de l'XML, configuraci\u00f3 totalment separada del codi. Instruccions de consola denominades tasks (tasques), que ens permeten executar ordres a la terminal Subframework per treballar amb formularis Ampli suport per a la seguretat del lloc: SQL Injection, XSS o CSRF \u00das de Composer per generar les depend\u00e8ncies A partir de la versi\u00f3 4 s'utilitza una nova eina pr\u00f2pia de Symfony (Flex) que ens facilita aquesta tasca","title":"Caracter\u00edstiques"},{"location":"UD11/11.01/#introduccio-a-yaml","text":"Els fitxers de configuraci\u00f3 de Symfony es poden escriure en PHP, en XML o en YAML. S\u00f3n equivalents a nivell de rendiment (tots es transformen a PHP abans d'executar l'aplicaci\u00f3). PHP \u00e9s m\u00e9s flexible, per\u00f2 m\u00e9s complicat XML \u00e9s el m\u00e9s llarg d'escriure, per\u00f2 es pot validar. YAML \u00e9s m\u00e9s conc\u00eds que XML, per\u00f2 no podem validar. En Symfony, per defecte s'utilitza YAML","title":"Introducci\u00f3 a YAML"},{"location":"UD11/11.01/#sintaxis-de-yaml","text":"Cinc conceptes b\u00e0sics: * No admet tabulacions, nom\u00e9s espais * La informaci\u00f3 s'indica mitjan\u00e7ant parells clau: valor (si la clau o el valor tenen espais en blanc, es tanquen amb cometes simples o dobles) * La jerarquia de la informaci\u00f3 s'estableix escrivint 4 espais en blanc per davant del parell clau: valor * Els arrays normals s'indiquen amb els claud\u00e0tors [i] i els arrays associatius amb les claus {i} * Tamb\u00e9 podem indicar una matriu escrivint cada element en una nova l\u00ednia que comenci per - * Els comentaris s'indiquen prefixant el car\u00e0cter # per davant de cadascuna de les seves l\u00ednies","title":"Sintaxis de YAML"},{"location":"UD11/11.01/#alguns-exemples","text":"homepage : path : /{_locale} controller : Symfony\\Bundle\\FrameworkBundle\\Controller\\TemplateController::templateAction requirements : _locale : '%app_locales%' defaults : template : default/homepage.html.twig _locale : '%locale%' security : encoders : # Our user class and the algorithm we'll use to encode passwords # 'auto' means to let Symfony choose the best possible password hasher (Argon2 or Bcrypt) # https://symfony.com/doc/current/security.html#c-encoding-the-user-s-password App\\Entity\\User : 'auto' providers : # https://symfony.com/doc/current/security.html#b-configuring-how-users-are-loaded # In this example, users are stored via Doctrine in the database # To see the users at src/App/DataFixtures/ORM/LoadFixtures.php # To load users from somewhere else: https://symfony.com/doc/current/security/custom_provider.html database_users : entity : { class : App\\Entity\\User , property : username } # https://symfony.com/doc/current/security.html#initial-security-yml-setup-authentication firewalls : dev : pattern : ^/(_(profiler|wdt)|css|images|js)/ security : false main : # this firewall applies to all URLs pattern : ^/ # but the firewall does not require login on every page # denying access is done in access_control or in your controllers anonymous : true # This allows the user to login by submitting a username and password # Reference: https://symfony.com/doc/current/security/form_login_setup.html form_login : # The route name that the login form submits to check_path : security_login # The name of the route where the login form lives # When the user tries to access a protected page, they are redirected here login_path : security_login # Secure the login form against CSRF # Reference: https://symfony.com/doc/current/security/csrf_in_login_form.html csrf_token_generator : security.csrf.token_manager # The page users are redirect to when there is no previous page stored in the # session (for example when the users access directly to the login page). default_target_path : blog_index logout : # The route name the user can go to in order to logout path : security_logout # The name of the route to redirect to after logging out target : homepage access_control : # this is a catch-all for the admin area # additional security lives in the controllers - { path : '^/(%app_locales%)/admin' , roles : ROLE_ADMIN } role_hierarchy : ROLE_ADMIN : ROLE_USER","title":"Alguns exemples"},{"location":"UD11/11.01/#recursos","text":"https://es.wikipedia.org/wiki/Framework https://es.wikipedia.org/wiki/Symfony","title":"Recursos"},{"location":"UD11/11.02/","text":"Motor de plantilles {: .no_toc } Taula de continguts {: .no_toc .text-delta .nocount } TOC Introducci\u00f3 Hi ha diversos motors de plantilles dins del m\u00f3n PHP Fabien Potencier, l\u00edder del projecte Symfony, va estar testejant les diferents opcions existents. El resultat el va publicar al seu bloc sota el t\u00edtol Templating Engines in PHP . Com a conclusi\u00f3 a aquestes proves es va adoptar el framework Twig com a motor de plantilles per Symfony. Documentaci\u00f3 oficial de Twig","title":"11.2. Motor de plantilles"},{"location":"UD11/11.02/#motor-de-plantilles","text":"{: .no_toc }","title":"Motor de plantilles"},{"location":"UD11/11.02/#taula-de-continguts","text":"{: .no_toc .text-delta .nocount } TOC","title":"Taula de continguts"},{"location":"UD11/11.02/#introduccio","text":"Hi ha diversos motors de plantilles dins del m\u00f3n PHP Fabien Potencier, l\u00edder del projecte Symfony, va estar testejant les diferents opcions existents. El resultat el va publicar al seu bloc sota el t\u00edtol Templating Engines in PHP . Com a conclusi\u00f3 a aquestes proves es va adoptar el framework Twig com a motor de plantilles per Symfony. Documentaci\u00f3 oficial de Twig","title":"Introducci\u00f3"},{"location":"UD11/11.03/","text":"Injecci\u00f3 de depend\u00e8ncies: Contenidor de serveis {: .no_toc } Taula de continguts {: .no_toc .text-delta .nocount } TOC Introducci\u00f3 Injecci\u00f3 de depend\u00e8ncies Contenidor de serveis","title":"11.3. Injecci\u00f3 de depend\u00e8ncies"},{"location":"UD11/11.03/#injeccio-de-dependencies-contenidor-de-serveis","text":"{: .no_toc }","title":"Injecci\u00f3 de depend\u00e8ncies: Contenidor de serveis"},{"location":"UD11/11.03/#taula-de-continguts","text":"{: .no_toc .text-delta .nocount } TOC","title":"Taula de continguts"},{"location":"UD11/11.03/#introduccio","text":"Injecci\u00f3 de depend\u00e8ncies Contenidor de serveis","title":"Introducci\u00f3"},{"location":"UD11/11.04/","text":"Model {: .no_toc } Taula de continguts {: .no_toc .text-delta .nocount } TOC Introducci\u00f3 Symfony no disposa de cap m\u00f2dul que s'encarregue de la capa de persist\u00e8ncia. Per aquest motiu, alguns desenvolupadors diuen que no \u00e9s un framework MVC pur. Per a aquesta tasca Symfony s'integra amb eines de tercers, com el ORM Doctrine. Doctrine Doctrine \u00e9s un Object Relational Mapping . La finalitat d'un ORM \u00e9s la de proporcionar una capa orientada a objectes sobre d'una base de dades relacional, de manera que les files o registres de les taules siguen tractats com a objectes. Les associacions que hi ha entre aquests objectes es correspon amb les relacions entre les taules de la base de dades. Caracter\u00edstiques dels ORM Entre les caracter\u00edstiques destaquem: * Fan independent l'aplicaci\u00f3 de l'SGBD utilitzat. * \u00c9s el propi ORM qui construeix la consulta (SQL) adequada a l'SGBD que en cada moment. * Els elements comuns a qualsevol ORM s\u00f3n les entitats. * Les metadades defineixen les relacions entre les entitats i la base de dades. * \u00c9s un producte molt potent, i per aix\u00f2, bastant complex La documentaci\u00f3 oficial \u00e9s molt completa: Documentaci\u00f3 de Doctrine No ho estudiarem en profunditat. Veurem la major part dels conceptes b\u00e0sics imprescindibles per fer \u00fas de Doctrine2 en una aplicaci\u00f3 constru\u00efda en Symfony. Exemples Aquestos exemples estan extrets de l'aplicaci\u00f3 demo de Symfony /* * This file is part of the Symfony package. * * (c) Fabien Potencier <fabien@symfony.com> * * For the full copyright and license information, please view the LICENSE * file that was distributed with this source code. */ namespace App\\Entity ; use Doctrine\\Common\\Collections\\ArrayCollection ; use Doctrine\\Common\\Collections\\Collection ; use Doctrine\\ORM\\Mapping as ORM ; use Symfony\\Bridge\\Doctrine\\Validator\\Constraints\\UniqueEntity ; use Symfony\\Component\\Validator\\Constraints as Assert ; /** * @ORM\\Entity(repositoryClass=\"App\\Repository\\PostRepository\") * @ORM\\Table(name=\"symfony_demo_post\") * @UniqueEntity(fields={\"slug\"}, errorPath=\"title\", message=\"This title was already used in another blog post, but they must be unique.\") * * Defines the properties of the Post entity to represent the blog posts. * * See https://symfony.com/doc/current/doctrine.html#creating-an-entity-class * * Tip: if you have an existing database, you can generate these entity class automatically. * See https://symfony.com/doc/current/doctrine/reverse_engineering.html * * @author Ryan Weaver <weaverryan@gmail.com> * @author Javier Eguiluz <javier.eguiluz@gmail.com> * @author Yonel Ceruto <yonelceruto@gmail.com> */ class Post { /** * Use constants to define configuration options that rarely change instead * of specifying them under parameters section in config/services.yaml file. * * See https://symfony.com/doc/current/best_practices.html#use-constants-to-define-options-that-rarely-change */ public const NUM_ITEMS = 10 ; /** * @var int * * @ORM\\Id * @ORM\\GeneratedValue * @ORM\\Column(type=\"integer\") */ private $id ; /** * @var string * * @ORM\\Column(type=\"string\") * @Assert\\NotBlank */ private $title ; /** * @var string * * @ORM\\Column(type=\"string\") */ private $slug ; /** * @var string * * @ORM\\Column(type=\"string\") * @Assert\\NotBlank(message=\"post.blank_summary\") * @Assert\\Length(max=255) */ private $summary ; /** * @var string * * @ORM\\Column(type=\"text\") * @Assert\\NotBlank(message=\"post.blank_content\") * @Assert\\Length(min=10, minMessage=\"post.too_short_content\") */ private $content ; /** * @var \\DateTime * * @ORM\\Column(type=\"datetime\") */ private $publishedAt ; /** * @var User * * @ORM\\ManyToOne(targetEntity=\"App\\Entity\\User\") * @ORM\\JoinColumn(nullable=false) */ private $author ; /** * @var Comment[]|ArrayCollection * * @ORM\\OneToMany( * targetEntity=\"Comment\", * mappedBy=\"post\", * orphanRemoval=true, * cascade={\"persist\"} * ) * @ORM\\OrderBy({\"publishedAt\": \"DESC\"}) */ private $comments ; /** * @var Tag[]|ArrayCollection * * @ORM\\ManyToMany(targetEntity=\"App\\Entity\\Tag\", cascade={\"persist\"}) * @ORM\\JoinTable(name=\"symfony_demo_post_tag\") * @ORM\\OrderBy({\"name\": \"ASC\"}) * @Assert\\Count(max=\"4\", maxMessage=\"post.too_many_tags\") */ private $tags ; public function __construct () { $this -> publishedAt = new \\DateTime (); $this -> comments = new ArrayCollection (); $this -> tags = new ArrayCollection (); } Podeu consultar la resta d'entitats ac\u00ed: https://github.com/symfony/demo/tree/master/src/Entity","title":"11.4. Model"},{"location":"UD11/11.04/#model","text":"{: .no_toc }","title":"Model"},{"location":"UD11/11.04/#taula-de-continguts","text":"{: .no_toc .text-delta .nocount } TOC","title":"Taula de continguts"},{"location":"UD11/11.04/#introduccio","text":"Symfony no disposa de cap m\u00f2dul que s'encarregue de la capa de persist\u00e8ncia. Per aquest motiu, alguns desenvolupadors diuen que no \u00e9s un framework MVC pur. Per a aquesta tasca Symfony s'integra amb eines de tercers, com el ORM Doctrine.","title":"Introducci\u00f3"},{"location":"UD11/11.04/#doctrine","text":"Doctrine \u00e9s un Object Relational Mapping . La finalitat d'un ORM \u00e9s la de proporcionar una capa orientada a objectes sobre d'una base de dades relacional, de manera que les files o registres de les taules siguen tractats com a objectes. Les associacions que hi ha entre aquests objectes es correspon amb les relacions entre les taules de la base de dades.","title":"Doctrine"},{"location":"UD11/11.04/#caracteristiques-dels-orm","text":"Entre les caracter\u00edstiques destaquem: * Fan independent l'aplicaci\u00f3 de l'SGBD utilitzat. * \u00c9s el propi ORM qui construeix la consulta (SQL) adequada a l'SGBD que en cada moment. * Els elements comuns a qualsevol ORM s\u00f3n les entitats. * Les metadades defineixen les relacions entre les entitats i la base de dades. * \u00c9s un producte molt potent, i per aix\u00f2, bastant complex La documentaci\u00f3 oficial \u00e9s molt completa: Documentaci\u00f3 de Doctrine No ho estudiarem en profunditat. Veurem la major part dels conceptes b\u00e0sics imprescindibles per fer \u00fas de Doctrine2 en una aplicaci\u00f3 constru\u00efda en Symfony.","title":"Caracter\u00edstiques dels ORM"},{"location":"UD11/11.04/#exemples","text":"Aquestos exemples estan extrets de l'aplicaci\u00f3 demo de Symfony /* * This file is part of the Symfony package. * * (c) Fabien Potencier <fabien@symfony.com> * * For the full copyright and license information, please view the LICENSE * file that was distributed with this source code. */ namespace App\\Entity ; use Doctrine\\Common\\Collections\\ArrayCollection ; use Doctrine\\Common\\Collections\\Collection ; use Doctrine\\ORM\\Mapping as ORM ; use Symfony\\Bridge\\Doctrine\\Validator\\Constraints\\UniqueEntity ; use Symfony\\Component\\Validator\\Constraints as Assert ; /** * @ORM\\Entity(repositoryClass=\"App\\Repository\\PostRepository\") * @ORM\\Table(name=\"symfony_demo_post\") * @UniqueEntity(fields={\"slug\"}, errorPath=\"title\", message=\"This title was already used in another blog post, but they must be unique.\") * * Defines the properties of the Post entity to represent the blog posts. * * See https://symfony.com/doc/current/doctrine.html#creating-an-entity-class * * Tip: if you have an existing database, you can generate these entity class automatically. * See https://symfony.com/doc/current/doctrine/reverse_engineering.html * * @author Ryan Weaver <weaverryan@gmail.com> * @author Javier Eguiluz <javier.eguiluz@gmail.com> * @author Yonel Ceruto <yonelceruto@gmail.com> */ class Post { /** * Use constants to define configuration options that rarely change instead * of specifying them under parameters section in config/services.yaml file. * * See https://symfony.com/doc/current/best_practices.html#use-constants-to-define-options-that-rarely-change */ public const NUM_ITEMS = 10 ; /** * @var int * * @ORM\\Id * @ORM\\GeneratedValue * @ORM\\Column(type=\"integer\") */ private $id ; /** * @var string * * @ORM\\Column(type=\"string\") * @Assert\\NotBlank */ private $title ; /** * @var string * * @ORM\\Column(type=\"string\") */ private $slug ; /** * @var string * * @ORM\\Column(type=\"string\") * @Assert\\NotBlank(message=\"post.blank_summary\") * @Assert\\Length(max=255) */ private $summary ; /** * @var string * * @ORM\\Column(type=\"text\") * @Assert\\NotBlank(message=\"post.blank_content\") * @Assert\\Length(min=10, minMessage=\"post.too_short_content\") */ private $content ; /** * @var \\DateTime * * @ORM\\Column(type=\"datetime\") */ private $publishedAt ; /** * @var User * * @ORM\\ManyToOne(targetEntity=\"App\\Entity\\User\") * @ORM\\JoinColumn(nullable=false) */ private $author ; /** * @var Comment[]|ArrayCollection * * @ORM\\OneToMany( * targetEntity=\"Comment\", * mappedBy=\"post\", * orphanRemoval=true, * cascade={\"persist\"} * ) * @ORM\\OrderBy({\"publishedAt\": \"DESC\"}) */ private $comments ; /** * @var Tag[]|ArrayCollection * * @ORM\\ManyToMany(targetEntity=\"App\\Entity\\Tag\", cascade={\"persist\"}) * @ORM\\JoinTable(name=\"symfony_demo_post_tag\") * @ORM\\OrderBy({\"name\": \"ASC\"}) * @Assert\\Count(max=\"4\", maxMessage=\"post.too_many_tags\") */ private $tags ; public function __construct () { $this -> publishedAt = new \\DateTime (); $this -> comments = new ArrayCollection (); $this -> tags = new ArrayCollection (); } Podeu consultar la resta d'entitats ac\u00ed: https://github.com/symfony/demo/tree/master/src/Entity","title":"Exemples"},{"location":"UD11/11.05/","text":"Formularis {: .no_toc } Taula de continguts {: .no_toc .text-delta .nocount } TOC Introducci\u00f3 Symfony t\u00e9 integrat un component per la gesti\u00f3 de formularis. Per poder fer servir aquest component el primer que cal fer \u00e9s instal\u00b7lar-lo: composer require symfony/form El primer que necessitem el crear un formulari \u00e9s l'entitat que anem a editar. // src/Entity/Task.php namespace App\\Entity ; class Task { protected $task ; protected $dueDate ; public function getTask () { return $this -> task ; } public function setTask ( $task ) { $this -> task = $task ; } public function getDueDate () { return $this -> dueDate ; } public function setDueDate ( \\DateTime $dueDate = null ) { $this -> dueDate = $dueDate ; } } El seg\u00fcent pas ser\u00e0 construir i mostrar el formulari en HTML. Aix\u00f2 ho farem mitjan\u00e7ant un objecte form i el mostrarem amb una plantilla Twig. Al controlador crearem el formulari amb el m\u00e8tode createFormBuilder a qu\u00e8 li passarem l'entitat a editar. A continuaci\u00f3 afegirem els camps que necessitem en el formulari, indicant de quin tipus \u00e9s cada un i cridarem el m\u00e8tode getForm que ens tornar\u00e0 l'objecte formulari. Finalment, mostrarem la vista passant-li la vista el formulari que obtindrem mitjan\u00e7ant el m\u00e8tode createView. // src/Controller/TaskController.php namespace App\\Controller ; use App\\Entity\\Task ; use Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController ; use Symfony\\Component\\Form\\Extension\\Core\\Type\\DateType ; use Symfony\\Component\\Form\\Extension\\Core\\Type\\SubmitType ; use Symfony\\Component\\Form\\Extension\\Core\\Type\\TextType ; use Symfony\\Component\\HttpFoundation\\Request ; class TaskController extends AbstractController { public function new ( Request $request ) { // creates a task object and initializes some data for this example $task = new Task (); $task -> setTask ( 'Write a blog post' ); $task -> setDueDate ( new \\DateTime ( 'tomorrow' )); $form = $this -> createFormBuilder ( $task ) -> add ( 'task' , TextType :: class ) -> add ( 'dueDate' , DateType :: class ) -> add ( 'save' , SubmitType :: class , [ 'label' => 'Create Task' ]) -> getForm (); return $this -> render ( 'task/new.html.twig' , [ 'form' => $form -> createView (), ]); } } La plantilla de Twig ser\u00e0 aix\u00ed {% raw %} { # templates/task/new.html.twig #} {{ form ( form ) }} M\u00e9s informaci\u00f3 Formularis sense classe entitat relacionada Personalitzaci\u00f3 de formularis","title":"11.5. Formularis"},{"location":"UD11/11.05/#formularis","text":"{: .no_toc }","title":"Formularis"},{"location":"UD11/11.05/#taula-de-continguts","text":"{: .no_toc .text-delta .nocount } TOC","title":"Taula de continguts"},{"location":"UD11/11.05/#introduccio","text":"Symfony t\u00e9 integrat un component per la gesti\u00f3 de formularis. Per poder fer servir aquest component el primer que cal fer \u00e9s instal\u00b7lar-lo: composer require symfony/form El primer que necessitem el crear un formulari \u00e9s l'entitat que anem a editar. // src/Entity/Task.php namespace App\\Entity ; class Task { protected $task ; protected $dueDate ; public function getTask () { return $this -> task ; } public function setTask ( $task ) { $this -> task = $task ; } public function getDueDate () { return $this -> dueDate ; } public function setDueDate ( \\DateTime $dueDate = null ) { $this -> dueDate = $dueDate ; } } El seg\u00fcent pas ser\u00e0 construir i mostrar el formulari en HTML. Aix\u00f2 ho farem mitjan\u00e7ant un objecte form i el mostrarem amb una plantilla Twig. Al controlador crearem el formulari amb el m\u00e8tode createFormBuilder a qu\u00e8 li passarem l'entitat a editar. A continuaci\u00f3 afegirem els camps que necessitem en el formulari, indicant de quin tipus \u00e9s cada un i cridarem el m\u00e8tode getForm que ens tornar\u00e0 l'objecte formulari. Finalment, mostrarem la vista passant-li la vista el formulari que obtindrem mitjan\u00e7ant el m\u00e8tode createView. // src/Controller/TaskController.php namespace App\\Controller ; use App\\Entity\\Task ; use Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController ; use Symfony\\Component\\Form\\Extension\\Core\\Type\\DateType ; use Symfony\\Component\\Form\\Extension\\Core\\Type\\SubmitType ; use Symfony\\Component\\Form\\Extension\\Core\\Type\\TextType ; use Symfony\\Component\\HttpFoundation\\Request ; class TaskController extends AbstractController { public function new ( Request $request ) { // creates a task object and initializes some data for this example $task = new Task (); $task -> setTask ( 'Write a blog post' ); $task -> setDueDate ( new \\DateTime ( 'tomorrow' )); $form = $this -> createFormBuilder ( $task ) -> add ( 'task' , TextType :: class ) -> add ( 'dueDate' , DateType :: class ) -> add ( 'save' , SubmitType :: class , [ 'label' => 'Create Task' ]) -> getForm (); return $this -> render ( 'task/new.html.twig' , [ 'form' => $form -> createView (), ]); } } La plantilla de Twig ser\u00e0 aix\u00ed {% raw %} { # templates/task/new.html.twig #} {{ form ( form ) }}","title":"Introducci\u00f3"},{"location":"UD11/11.05/#mes-informacio","text":"Formularis sense classe entitat relacionada Personalitzaci\u00f3 de formularis","title":"M\u00e9s informaci\u00f3"},{"location":"UD11/11.06%20projecte/","text":"Refactoritzant el projecte a Symfony {: .no_toc } L'objectiu del projecte del bloc II \u00e9s adaptar el projecte realitzat al framework de Symfony. Taula de continguts {: .no_toc .text-delta .nocount } TOC Pas 1. Configurar l'entorn de Symfony Cal seguir la primera part del tutorial per a acabar creant un nou projecte complet de Symfony. No t'oblides de configurar el repositori de Git. Pas 2. Creaci\u00f3 de les entitats Com que ja tenim la base de dades creada caldr\u00e0 crear les entitats a partir de les taules de base de dades. {: .alert .alert-warning} Compte: c\u00f2pia de seguretat {: .no_toc .nocount } Es recomanable que feu una c\u00f2pia de seguretat de la base de dades abans de comen\u00e7ar a implementar els canvis per si de cas. Emprarem l'ordre seg\u00fcent: php bin/console doctrine:mapping:import \"App\\Entity\" annotation --path = src/Entity I amb la seg\u00fcent generarem els getters i els setters . Tamb\u00e9 \u00e9s possible generar-o php bin/console make:entity --regenerate App M\u00e9s informaci\u00f3 en How to Generate Entities from an Existing Database Pas 3. Creaci\u00f3 del DefaultController Aquest controlador gestionar la p\u00e0gina principal i p\u00e0gines est\u00e0tiques si fora necessari. Pas 4. Creaci\u00f3 dels CRUD de les entitats principals Crea, mitjan\u00e7ant l'eina make:crud les entitats principals de l'aplicaci\u00f3. {:.alert .alert-warning} Catchable Fatal Error: Object of class App\\Entity\\Roles could not be converted to string {: .no_toc .nocount } Aquest error \u00e9s prou habitual quan treballem amb els formularis per defecte, ocorre en les relacions quan el formulari mostra una llista desplegable. Ocorre perqu\u00e8 no li s'ha indicat quin camp s'ha de mostrar en el text de la llista desplegable. La soluci\u00f3 m\u00e9s r\u00e0pida \u00e9s afegir a la classe el m\u00e8tode m\u00e0gin __toString() fent que torne un camp de text de l'entitat. Pas 5. Implementaci\u00f3 de la seguretat Pas 6. Paginaci\u00f3 i filtratge Implementa un filtre de paginaci\u00f3 i filtratge mitjan\u00e7ant un formulari que filtrar\u00e0 per text, entre dues dates. Pas 7. Implementaci\u00f3 carregador d'imatges Pas 8. Implementaci\u00f3 d'un formulari de contacte. Implementa un formuari de contacte amb els camps nom, correu electr\u00f2nic, assumpte i text que envie la informaci\u00f3 per correu electr\u00f2nic a l'adre\u00e7a del administrador de la web. Pas 9. Implementaci\u00f3 del dashboard El dashboard o tauler de control es trobar\u00e0 en /admin . Hi podran accedir tots els usuaris que hagen iniciat sessi\u00f3 per\u00f2 els usuaris amb ROLE_ADMIN podran fer totes les accions CRUD i els ROLE_USER sols podran fer-ho amb elements que hagen creat.","title":"11.6. Projecte"},{"location":"UD11/11.06%20projecte/#refactoritzant-el-projecte-a-symfony","text":"{: .no_toc } L'objectiu del projecte del bloc II \u00e9s adaptar el projecte realitzat al framework de Symfony.","title":"Refactoritzant el projecte a Symfony"},{"location":"UD11/11.06%20projecte/#taula-de-continguts","text":"{: .no_toc .text-delta .nocount } TOC","title":"Taula de continguts"},{"location":"UD11/11.06%20projecte/#pas-1-configurar-lentorn-de-symfony","text":"Cal seguir la primera part del tutorial per a acabar creant un nou projecte complet de Symfony. No t'oblides de configurar el repositori de Git.","title":"Pas 1. Configurar l'entorn de Symfony"},{"location":"UD11/11.06%20projecte/#pas-2-creacio-de-les-entitats","text":"Com que ja tenim la base de dades creada caldr\u00e0 crear les entitats a partir de les taules de base de dades. {: .alert .alert-warning}","title":"Pas 2. Creaci\u00f3 de les entitats"},{"location":"UD11/11.06%20projecte/#compte-copia-de-seguretat","text":"{: .no_toc .nocount } Es recomanable que feu una c\u00f2pia de seguretat de la base de dades abans de comen\u00e7ar a implementar els canvis per si de cas. Emprarem l'ordre seg\u00fcent: php bin/console doctrine:mapping:import \"App\\Entity\" annotation --path = src/Entity I amb la seg\u00fcent generarem els getters i els setters . Tamb\u00e9 \u00e9s possible generar-o php bin/console make:entity --regenerate App M\u00e9s informaci\u00f3 en How to Generate Entities from an Existing Database","title":"Compte: c\u00f2pia de seguretat"},{"location":"UD11/11.06%20projecte/#pas-3-creacio-del-defaultcontroller","text":"Aquest controlador gestionar la p\u00e0gina principal i p\u00e0gines est\u00e0tiques si fora necessari.","title":"Pas 3. Creaci\u00f3 del DefaultController"},{"location":"UD11/11.06%20projecte/#pas-4-creacio-dels-crud-de-les-entitats-principals","text":"Crea, mitjan\u00e7ant l'eina make:crud les entitats principals de l'aplicaci\u00f3. {:.alert .alert-warning}","title":"Pas 4. Creaci\u00f3 dels CRUD de les entitats principals"},{"location":"UD11/11.06%20projecte/#catchable-fatal-error-object-of-class-appentityroles-could-not-be-converted-to-string","text":"{: .no_toc .nocount } Aquest error \u00e9s prou habitual quan treballem amb els formularis per defecte, ocorre en les relacions quan el formulari mostra una llista desplegable. Ocorre perqu\u00e8 no li s'ha indicat quin camp s'ha de mostrar en el text de la llista desplegable. La soluci\u00f3 m\u00e9s r\u00e0pida \u00e9s afegir a la classe el m\u00e8tode m\u00e0gin __toString() fent que torne un camp de text de l'entitat.","title":"Catchable Fatal Error: Object of class App\\Entity\\Roles could not be converted to string"},{"location":"UD11/11.06%20projecte/#pas-5-implementacio-de-la-seguretat","text":"","title":"Pas 5. Implementaci\u00f3 de la seguretat"},{"location":"UD11/11.06%20projecte/#pas-6-paginacio-i-filtratge","text":"Implementa un filtre de paginaci\u00f3 i filtratge mitjan\u00e7ant un formulari que filtrar\u00e0 per text, entre dues dates.","title":"Pas 6. Paginaci\u00f3 i filtratge"},{"location":"UD11/11.06%20projecte/#pas-7-implementacio-carregador-dimatges","text":"","title":"Pas 7. Implementaci\u00f3 carregador d'imatges"},{"location":"UD11/11.06%20projecte/#pas-8-implementacio-dun-formulari-de-contacte","text":"Implementa un formuari de contacte amb els camps nom, correu electr\u00f2nic, assumpte i text que envie la informaci\u00f3 per correu electr\u00f2nic a l'adre\u00e7a del administrador de la web.","title":"Pas 8. Implementaci\u00f3 d'un formulari de contacte."},{"location":"UD11/11.06%20projecte/#pas-9-implementacio-del-dashboard","text":"El dashboard o tauler de control es trobar\u00e0 en /admin . Hi podran accedir tots els usuaris que hagen iniciat sessi\u00f3 per\u00f2 els usuaris amb ROLE_ADMIN podran fer totes les accions CRUD i els ROLE_USER sols podran fer-ho amb elements que hagen creat.","title":"Pas 9. Implementaci\u00f3 del dashboard"},{"location":"UD11/11.07.%20Extras/","text":"Extres {: .no_toc } Taula de continguts {: .no_toc .text-delta .nocount } TOC Internacionalitzaci\u00f3 Installation First, run this command to install the translator before using it: composer require symfony/translation Configuration The previous command creates an initial config file where you can define the default locale of the application and the directory where the translation files are located: # config/packages/translation.yaml framework : default_locale : 'en' translator : default_path : '%kernel.project_dir%/translations' The locale used in translations is the one stored on the request. This is typically set via a _locale attribute on your routes (see The Locale and the URL). Basic Translation Translation of text is done through the translator service (Translator). To translate a block of text (called a message), use the trans() method. Suppose, for example, that you're translating a simple message from inside a controller: // ... use Symfony\\Contracts\\Translation\\TranslatorInterface ; public function index ( TranslatorInterface $translator ) { $translated = $translator -> trans ( 'Symfony is great' ); // ... } When this code is executed, Symfony will attempt to translate the message \"Symfony is great\" based on the locale of the user. For this to work, you need to tell Symfony how to translate the message via a \"translation resource\", which is usually a file that contains a collection of translations for a given locale. This \"dictionary\" of translations can be created in several different formats: # translations/messages.fr.yaml Symfony is great : J'aime Symfony For information on where these files should be located, see Translation Resource/File Names and Locations. Now, if the language of the user's locale is French (e.g. fr_FR or fr_BE), the message will be translated into J'aime Symfony. You can also translate the message inside your templates. The Translation Process To actually translate the message, Symfony uses the following process when using the trans() method: The locale of the current user, which is stored on the request is determined. If the message is located in the catalog, the translation is returned. If not, the translator returns the original message. Message Format Sometimes, a message containing a variable needs to be translated: // ... $translated = $translator -> trans ( 'Hello ' . $name ); However, creating a translation for this string is impossible since the translator will try to look up the message including the variable portions (e.g. \"Hello Ryan\" or \"Hello Fabien\"). Another complication is when you have translations that may or may not be plural, based on some variable: There is one apple. There are 5 apples. To manage these situations, Symfony follows the ICU MessageFormat syntax by using PHP's MessageFormatter class. Read more about this in How to Translate Messages using the ICU MessageFormat . Translation in templates Extracting Translation Contents and Updating Catalogs Automatically The most time-consuming tasks when translating an application is to extract all the template contents to be translated and to keep all the translation files in sync. Symfony includes a command called translation:update that helps you with these tasks: php bin/console translation:update --dump-messages --output-format = yaml fr php bin/console translation:update --force --output-format = yaml fr php bin/console translation:update --help Translation Resource/File Names and Locations Symfony looks for message files (i.e. translations) in the following default locations: the translations/ directory (at the root of the project); the Resources/translations/ directory inside of any bundle. The locations are listed here with the highest priority first. That is, you can override the translation messages of a bundle in the first directory. The override mechanism works at a key level: only the overridden keys need to be listed in a higher priority message file. When a key is not found in a message file, the translator will automatically fall back to the lower priority message files. The filename of the translation files is also important: each message file must be named according to the following path: domain.locale.loader : domain: An optional way to organize messages into groups. locale: The locale that the translations are for (e.g. en_GB, en, etc); loader: How Symfony should load and parse the file (e.g. xlf, php, yaml, etc). The loader can be the name of any registered loader. By default, Symfony provides many loaders. The choice of which loader to use is entirely up to you and is a matter of taste. The recommended option is to use YAML for simple projects and use XLIFF if you're generating translations with specialized programs or teams.","title":"11.7. Extres"},{"location":"UD11/11.07.%20Extras/#extres","text":"{: .no_toc }","title":"Extres"},{"location":"UD11/11.07.%20Extras/#taula-de-continguts","text":"{: .no_toc .text-delta .nocount } TOC","title":"Taula de continguts"},{"location":"UD11/11.07.%20Extras/#internacionalitzacio","text":"","title":"Internacionalitzaci\u00f3"},{"location":"UD11/11.07.%20Extras/#installation","text":"First, run this command to install the translator before using it: composer require symfony/translation","title":"Installation"},{"location":"UD11/11.07.%20Extras/#configuration","text":"The previous command creates an initial config file where you can define the default locale of the application and the directory where the translation files are located: # config/packages/translation.yaml framework : default_locale : 'en' translator : default_path : '%kernel.project_dir%/translations' The locale used in translations is the one stored on the request. This is typically set via a _locale attribute on your routes (see The Locale and the URL).","title":"Configuration"},{"location":"UD11/11.07.%20Extras/#basic-translation","text":"Translation of text is done through the translator service (Translator). To translate a block of text (called a message), use the trans() method. Suppose, for example, that you're translating a simple message from inside a controller: // ... use Symfony\\Contracts\\Translation\\TranslatorInterface ; public function index ( TranslatorInterface $translator ) { $translated = $translator -> trans ( 'Symfony is great' ); // ... } When this code is executed, Symfony will attempt to translate the message \"Symfony is great\" based on the locale of the user. For this to work, you need to tell Symfony how to translate the message via a \"translation resource\", which is usually a file that contains a collection of translations for a given locale. This \"dictionary\" of translations can be created in several different formats: # translations/messages.fr.yaml Symfony is great : J'aime Symfony For information on where these files should be located, see Translation Resource/File Names and Locations. Now, if the language of the user's locale is French (e.g. fr_FR or fr_BE), the message will be translated into J'aime Symfony. You can also translate the message inside your templates.","title":"Basic Translation"},{"location":"UD11/11.07.%20Extras/#the-translation-process","text":"To actually translate the message, Symfony uses the following process when using the trans() method: The locale of the current user, which is stored on the request is determined. If the message is located in the catalog, the translation is returned. If not, the translator returns the original message.","title":"The Translation Process"},{"location":"UD11/11.07.%20Extras/#message-format","text":"Sometimes, a message containing a variable needs to be translated: // ... $translated = $translator -> trans ( 'Hello ' . $name ); However, creating a translation for this string is impossible since the translator will try to look up the message including the variable portions (e.g. \"Hello Ryan\" or \"Hello Fabien\"). Another complication is when you have translations that may or may not be plural, based on some variable: There is one apple. There are 5 apples. To manage these situations, Symfony follows the ICU MessageFormat syntax by using PHP's MessageFormatter class. Read more about this in How to Translate Messages using the ICU MessageFormat . Translation in templates","title":"Message Format"},{"location":"UD11/11.07.%20Extras/#extracting-translation-contents-and-updating-catalogs-automatically","text":"The most time-consuming tasks when translating an application is to extract all the template contents to be translated and to keep all the translation files in sync. Symfony includes a command called translation:update that helps you with these tasks: php bin/console translation:update --dump-messages --output-format = yaml fr php bin/console translation:update --force --output-format = yaml fr php bin/console translation:update --help","title":"Extracting Translation Contents and Updating Catalogs Automatically"},{"location":"UD11/11.07.%20Extras/#translation-resourcefile-names-and-locations","text":"Symfony looks for message files (i.e. translations) in the following default locations: the translations/ directory (at the root of the project); the Resources/translations/ directory inside of any bundle. The locations are listed here with the highest priority first. That is, you can override the translation messages of a bundle in the first directory. The override mechanism works at a key level: only the overridden keys need to be listed in a higher priority message file. When a key is not found in a message file, the translator will automatically fall back to the lower priority message files. The filename of the translation files is also important: each message file must be named according to the following path: domain.locale.loader : domain: An optional way to organize messages into groups. locale: The locale that the translations are for (e.g. en_GB, en, etc); loader: How Symfony should load and parse the file (e.g. xlf, php, yaml, etc). The loader can be the name of any registered loader. By default, Symfony provides many loaders. The choice of which loader to use is entirely up to you and is a matter of taste. The recommended option is to use YAML for simple projects and use XLIFF if you're generating translations with specialized programs or teams.","title":"Translation Resource/File Names and Locations"},{"location":"UD12.%20Tutorial/00-index/","text":"layout: default title: 12. Tutorial de Symfony nav_order: 12 has_children: true nav_exclude: true","title":"00 index"},{"location":"UD12.%20Tutorial/01-iniciant-projecte/","text":"Iniciant el projecte {: .no_toc } Taula de continguts {: .no_toc .text-delta .nocount } TOC Creaci\u00f3 del projecte Symfony Crea un nou projecte complet en la carpeta link_manager seguint les instruccions de Installing & Setting up the Symfony Framework . Instal\u00b7la el binari symfony de forma global. Executa el servidor integrat de symfony. Comprova que s'ha instal\u00b7lat correctament. Configuraci\u00f3 del repositori Crea en github un repositori anomenat link_manager on guardar\u00e0s el projecte. Comparteix-lo amb el professor. Des de la carpeta del projecte executa: git init git add . git commit -m \"Fist commit\" git remote add origin URL_REPOSITORY git push origin master A partir d'ara en acabar el treballar haur\u00e0s d'actualitzar el repository. Configuraci\u00f3 de la base de dades Seguint Databases and the Doctrine ORM configurarem la base de dades. Per a establir la connexi\u00f3 amb la base de dades crear un fitxer .env.local . Aquest fitxer contindr\u00e0 la configuraci\u00f3 espec\u00edfica de l'entorn de treball local i s'inclou per defecte en el .gitignore . Per a crear-lo executarem touch .env.local i l'editarem afegint: APP_ENV=dev # IMPORTANT: You MUST configure your server version, either here or in config/packages/doctrine.yaml DATABASE_URL=mysql://db_user:db_password@127.0.0.1:3306/db_name?serverVersion=5.7 Indicant que estem en un entorn de desenvolupament i la URL de la nostra base de dades. En acabar, crea la base de dades: php bin/console doctrine:database:create {:.alert .alert-warning} Si apareix l'error An exception occurred in driver: could not find driver \u00e9s perque cal instal\u00b7lar el paquet php-mysql . Creaci\u00f3 des les entitats Seguint les instruccions de l'enlla\u00e7 anterior crea les seguents entitats amb el comandament: $php bin/console make:entity Despr\u00e9s de crear les entitats executarem: php bin/console make:migration Que ens generar\u00e0 un arxiu php amb els canvis generats per a la base de dades. Amb php bin/console doctrine:migrations:migrate aplicarem els canvis. Emplenament de dades l'entitat Link Per a emplenar de dades les entitats Symfony utilitza el component doctrine/data-fixtures . L'instal\u00b7larem amb el seguent comandament: composer require orm-fixtures --dev Dos consideracions: Com que disposem de Symfony Flex emprem la recepta orm-fixtures en lloc de doctrine/data-fixtures . El par\u00e0metre --dev indica que el component sols estar\u00e0 disponible en l'entorn de desenvolupament. Despr\u00e9s executarem: php bin/console make:fixtures I indicarem el nom d'exemple. The class name of the fixtures to create ( e.g. AppFixtures ) : >> AppFixtures Pots substituir el fitxer AppFixtures.php per aquest que ja inclou 3 enlla\u00e7os: AppFixtures . Despr\u00e9s executarem: php bin/console doctrine:fixtures:load Careful, database \"link_manager\" will be purged. Do you want to continue ? ( yes/no ) [ no ] : > yes > purging database > loading App \\D ataFixtures \\A ppFixtures Creaci\u00f3 dels controladors Per a acabar crearem el nostre primer controlador i ho farem seguint les instruccions del seg\u00fcent enlla\u00e7: Generating controllers . $php bin/console make:controller DefaultController created: src/Controller/LinkController.php created: templates/default/index.html.twig Success! Next: Open your new controller class and add some pages! Editarem la ruta del controlador perqu\u00e8 siga la p\u00e0gina d'inici de la nostra aplicaci\u00f3 web. Haur\u00edem de veure alguna cosa semblant: Obtenci\u00f3 de registres Ara modificarem el m\u00e9tode index() de la seg\u00fcent forma: /** * @Route(\"/\", name=\"homepage\") */ public function index () { // get the Link repository (it is like our model) $repository = $this -> getDoctrine () -> getRepository ( Link :: class ); // retrieve all links $links = $repository -> findAll (); // now pass the array of link object to the view return $this -> render ( 'default/index.html.twig' , [ 'links' => $links , ]); } {:.alert .alert-info} Ens quedar\u00e0 modificar la plantilla de Twig, per\u00f2 en aix\u00f2 ja teniu molta experi\u00e8ncia! M\u00e9s informaci\u00f3: Querying for objects Recursos M\u00e9s informaci\u00f3: https://rogerdudler.github.io/git-guide/","title":"1. El projecte en Symfony"},{"location":"UD12.%20Tutorial/01-iniciant-projecte/#iniciant-el-projecte","text":"{: .no_toc }","title":"Iniciant el projecte"},{"location":"UD12.%20Tutorial/01-iniciant-projecte/#taula-de-continguts","text":"{: .no_toc .text-delta .nocount } TOC","title":"Taula de continguts"},{"location":"UD12.%20Tutorial/01-iniciant-projecte/#creacio-del-projecte-symfony","text":"Crea un nou projecte complet en la carpeta link_manager seguint les instruccions de Installing & Setting up the Symfony Framework . Instal\u00b7la el binari symfony de forma global. Executa el servidor integrat de symfony. Comprova que s'ha instal\u00b7lat correctament.","title":"Creaci\u00f3 del projecte Symfony"},{"location":"UD12.%20Tutorial/01-iniciant-projecte/#configuracio-del-repositori","text":"Crea en github un repositori anomenat link_manager on guardar\u00e0s el projecte. Comparteix-lo amb el professor. Des de la carpeta del projecte executa: git init git add . git commit -m \"Fist commit\" git remote add origin URL_REPOSITORY git push origin master A partir d'ara en acabar el treballar haur\u00e0s d'actualitzar el repository.","title":"Configuraci\u00f3 del repositori"},{"location":"UD12.%20Tutorial/01-iniciant-projecte/#configuracio-de-la-base-de-dades","text":"Seguint Databases and the Doctrine ORM configurarem la base de dades. Per a establir la connexi\u00f3 amb la base de dades crear un fitxer .env.local . Aquest fitxer contindr\u00e0 la configuraci\u00f3 espec\u00edfica de l'entorn de treball local i s'inclou per defecte en el .gitignore . Per a crear-lo executarem touch .env.local i l'editarem afegint: APP_ENV=dev # IMPORTANT: You MUST configure your server version, either here or in config/packages/doctrine.yaml DATABASE_URL=mysql://db_user:db_password@127.0.0.1:3306/db_name?serverVersion=5.7 Indicant que estem en un entorn de desenvolupament i la URL de la nostra base de dades. En acabar, crea la base de dades: php bin/console doctrine:database:create {:.alert .alert-warning} Si apareix l'error An exception occurred in driver: could not find driver \u00e9s perque cal instal\u00b7lar el paquet php-mysql .","title":"Configuraci\u00f3 de la base de dades"},{"location":"UD12.%20Tutorial/01-iniciant-projecte/#creacio-des-les-entitats","text":"Seguint les instruccions de l'enlla\u00e7 anterior crea les seguents entitats amb el comandament: $php bin/console make:entity Despr\u00e9s de crear les entitats executarem: php bin/console make:migration Que ens generar\u00e0 un arxiu php amb els canvis generats per a la base de dades. Amb php bin/console doctrine:migrations:migrate aplicarem els canvis.","title":"Creaci\u00f3 des les entitats"},{"location":"UD12.%20Tutorial/01-iniciant-projecte/#emplenament-de-dades-lentitat-link","text":"Per a emplenar de dades les entitats Symfony utilitza el component doctrine/data-fixtures . L'instal\u00b7larem amb el seguent comandament: composer require orm-fixtures --dev Dos consideracions: Com que disposem de Symfony Flex emprem la recepta orm-fixtures en lloc de doctrine/data-fixtures . El par\u00e0metre --dev indica que el component sols estar\u00e0 disponible en l'entorn de desenvolupament. Despr\u00e9s executarem: php bin/console make:fixtures I indicarem el nom d'exemple. The class name of the fixtures to create ( e.g. AppFixtures ) : >> AppFixtures Pots substituir el fitxer AppFixtures.php per aquest que ja inclou 3 enlla\u00e7os: AppFixtures . Despr\u00e9s executarem: php bin/console doctrine:fixtures:load Careful, database \"link_manager\" will be purged. Do you want to continue ? ( yes/no ) [ no ] : > yes > purging database > loading App \\D ataFixtures \\A ppFixtures","title":"Emplenament de dades l'entitat Link"},{"location":"UD12.%20Tutorial/01-iniciant-projecte/#creacio-dels-controladors","text":"Per a acabar crearem el nostre primer controlador i ho farem seguint les instruccions del seg\u00fcent enlla\u00e7: Generating controllers . $php bin/console make:controller DefaultController created: src/Controller/LinkController.php created: templates/default/index.html.twig Success! Next: Open your new controller class and add some pages! Editarem la ruta del controlador perqu\u00e8 siga la p\u00e0gina d'inici de la nostra aplicaci\u00f3 web. Haur\u00edem de veure alguna cosa semblant:","title":"Creaci\u00f3 dels controladors"},{"location":"UD12.%20Tutorial/01-iniciant-projecte/#obtencio-de-registres","text":"Ara modificarem el m\u00e9tode index() de la seg\u00fcent forma: /** * @Route(\"/\", name=\"homepage\") */ public function index () { // get the Link repository (it is like our model) $repository = $this -> getDoctrine () -> getRepository ( Link :: class ); // retrieve all links $links = $repository -> findAll (); // now pass the array of link object to the view return $this -> render ( 'default/index.html.twig' , [ 'links' => $links , ]); } {:.alert .alert-info} Ens quedar\u00e0 modificar la plantilla de Twig, per\u00f2 en aix\u00f2 ja teniu molta experi\u00e8ncia! M\u00e9s informaci\u00f3: Querying for objects","title":"Obtenci\u00f3 de registres"},{"location":"UD12.%20Tutorial/01-iniciant-projecte/#recursos","text":"M\u00e9s informaci\u00f3: https://rogerdudler.github.io/git-guide/","title":"Recursos"},{"location":"UD12.%20Tutorial/02-creant-els-crud/","text":"CRUD i assets {: .no_toc } Taula de continguts {: .no_toc .text-delta .nocount } TOC CRUD En The Symfony MakerBundle trobarem com el comandament que permet crear els m\u00e8todes CRUD ( create , read , update , delete ). Per a crear els m\u00e8todes de les nostres entitats executarem: php bin/console make:crud The class name of the entity to create CRUD ( e.g. TinyElephant ) : > Link created: src/Controller/LinkController.php created: src/Form/LinkType.php created: templates/link/_delete_form.html.twig created: templates/link/_form.html.twig created: templates/link/edit.html.twig created: templates/link/index.html.twig created: templates/link/new.html.twig created: templates/link/show.html.twig Success! Next: Check your new CRUD by going to /link/ Com es pot observar ens crear\u00e0 el controlador, el formulari i les plantilles. {:.alert .alert-info} Les plantilles que comencen amb _ s\u00f3n blocs de codi que s'insertaran dintre d'altres plantilles. El fitxer src/Controller/LinkController quedar\u00e0 aix\u00ed: <? php namespace App\\Controller ; use ... /** * @Route(\"/link\") */ class LinkController extends AbstractController { /** * @Route(\"/\", name=\"link_index\", methods={\"GET\"}) */ public function index () : Response { $links = $this -> getDoctrine () -> getRepository ( Link :: class ) -> findAll (); return $this -> render ( 'link/index.html.twig' , [ 'links' => $links , ]); } /** * @Route(\"/new\", name=\"link_new\", methods={\"GET\",\"POST\"}) */ public function new ( Request $request ) : Response { $link = new Link (); $form = $this -> createForm ( LinkType :: class , $link ); $form -> handleRequest ( $request ); if ( $form -> isSubmitted () && $form -> isValid ()) { $entityManager = $this -> getDoctrine () -> getManager (); $entityManager -> persist ( $link ); $entityManager -> flush (); return $this -> redirectToRoute ( 'link_indhttps://github.com/corriol/dwes/blob/master/UD11/resources/_header.html.twigex' ); } return $this -> render ( 'link/new.html.twig' , [ 'link' => $link , 'form' => $form -> createView (), ]); } /** * @Route(\"/{id}\", name=\"link_show\", methods={\"GET\"}) */ public function show ( Link $link ) : Response { return $this -> render ( 'link/show.html.twig' , [ 'link' => $link , ]); } /** * @Route(\"/{id}/edit\", name=\"link_edit\", methods={\"GET\",\"POST\"}) */ public function edit ( Request $request , Link $link ) : Response { $form = $this -> createForm ( LinkType :: class , $link ); $form -> handleRequest ( $request ); if ( $form -> isSubmitted () && $form -> isValid ()) { $this -> getDoctrine () -> getManager () -> flush (); return $this -> redirectToRoute ( 'link_index' ); } return $this -> render ( 'link/edit.html.twig' , [ 'link' => $link , 'form' => $form -> createView (), ]); } /** * @Route(\"/{id}\", name=\"link_delete\", methods={\"DELETE\"}) */ public function delete ( Request $request , Link $link ) : Response { if ( $this -> isCsrfTokenValid ( 'delete' . $link -> getId (), $request -> request -> get ( '_token' ))) { $entityManager = $this -> getDoctrine () -> getManager (); $entityManager -> remove ( $link ); $entityManager -> flush (); } return $this -> redirectToRoute ( 'link_index' ); } } {:.alert .alert-activity} Crea el controlador CRUD de l'entitat User. Estils i javascript La forma m\u00e9s senzilla d'incloure fitxers css i js al nostre projecte \u00e9s modificant la plantilla base.html.twig perqu\u00e8 els incloga directament des de la web. _style.html.twig < link rel = \"stylesheet\" href = \"https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css\" integrity = \"sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T\" crossorigin = \"anonymous\" > < link rel = \"stylesheet\" href = \"https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css\" > < script src = \"https://code.jquery.com/jquery-3.4.1.slim.min.js\" integrity = \"sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n\" crossorigin = \"anonymous\" ></ script > < script src = \"https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js\" integrity = \"sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo\" crossorigin = \"anonymous\" ></ script > < script src = \"https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js\" integrity = \"sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6\" crossorigin = \"anonymous\" ></ script > Tamb\u00e9 inclourem el men\u00fa superior. {: .alert .alert-activity } Inclou els fitxers _style.html.twig i _header.html.twig al projecte. Comprova que tot funciona b\u00e9. {: .alert .alert-warning } Hem optat per una forma senzilla d'incloure CSS i javascript al nostre projecte, per\u00f2 dista molt de ser la m\u00e9s recomanable. M\u00e9s endavant en endinsarem en la gesti\u00f3 de paquets per al frontend de la m\u00e0 de Webpack Encore . Activant bootstrap 4 als formularis Per a millorar l'aspecte dels formularis Symfony incorpora suport per a Bootstrap. Modifica el fitxer twig.yaml perqu\u00e8 quede de la seg\u00fcent manera: # config/packages/twig.yaml twig : form_themes : [ 'bootstrap_4_layout.html.twig' ]","title":"2. Creant els CRUD"},{"location":"UD12.%20Tutorial/02-creant-els-crud/#crud-i-assets","text":"{: .no_toc }","title":"CRUD i assets"},{"location":"UD12.%20Tutorial/02-creant-els-crud/#taula-de-continguts","text":"{: .no_toc .text-delta .nocount } TOC","title":"Taula de continguts"},{"location":"UD12.%20Tutorial/02-creant-els-crud/#crud","text":"En The Symfony MakerBundle trobarem com el comandament que permet crear els m\u00e8todes CRUD ( create , read , update , delete ). Per a crear els m\u00e8todes de les nostres entitats executarem: php bin/console make:crud The class name of the entity to create CRUD ( e.g. TinyElephant ) : > Link created: src/Controller/LinkController.php created: src/Form/LinkType.php created: templates/link/_delete_form.html.twig created: templates/link/_form.html.twig created: templates/link/edit.html.twig created: templates/link/index.html.twig created: templates/link/new.html.twig created: templates/link/show.html.twig Success! Next: Check your new CRUD by going to /link/ Com es pot observar ens crear\u00e0 el controlador, el formulari i les plantilles. {:.alert .alert-info} Les plantilles que comencen amb _ s\u00f3n blocs de codi que s'insertaran dintre d'altres plantilles. El fitxer src/Controller/LinkController quedar\u00e0 aix\u00ed: <? php namespace App\\Controller ; use ... /** * @Route(\"/link\") */ class LinkController extends AbstractController { /** * @Route(\"/\", name=\"link_index\", methods={\"GET\"}) */ public function index () : Response { $links = $this -> getDoctrine () -> getRepository ( Link :: class ) -> findAll (); return $this -> render ( 'link/index.html.twig' , [ 'links' => $links , ]); } /** * @Route(\"/new\", name=\"link_new\", methods={\"GET\",\"POST\"}) */ public function new ( Request $request ) : Response { $link = new Link (); $form = $this -> createForm ( LinkType :: class , $link ); $form -> handleRequest ( $request ); if ( $form -> isSubmitted () && $form -> isValid ()) { $entityManager = $this -> getDoctrine () -> getManager (); $entityManager -> persist ( $link ); $entityManager -> flush (); return $this -> redirectToRoute ( 'link_indhttps://github.com/corriol/dwes/blob/master/UD11/resources/_header.html.twigex' ); } return $this -> render ( 'link/new.html.twig' , [ 'link' => $link , 'form' => $form -> createView (), ]); } /** * @Route(\"/{id}\", name=\"link_show\", methods={\"GET\"}) */ public function show ( Link $link ) : Response { return $this -> render ( 'link/show.html.twig' , [ 'link' => $link , ]); } /** * @Route(\"/{id}/edit\", name=\"link_edit\", methods={\"GET\",\"POST\"}) */ public function edit ( Request $request , Link $link ) : Response { $form = $this -> createForm ( LinkType :: class , $link ); $form -> handleRequest ( $request ); if ( $form -> isSubmitted () && $form -> isValid ()) { $this -> getDoctrine () -> getManager () -> flush (); return $this -> redirectToRoute ( 'link_index' ); } return $this -> render ( 'link/edit.html.twig' , [ 'link' => $link , 'form' => $form -> createView (), ]); } /** * @Route(\"/{id}\", name=\"link_delete\", methods={\"DELETE\"}) */ public function delete ( Request $request , Link $link ) : Response { if ( $this -> isCsrfTokenValid ( 'delete' . $link -> getId (), $request -> request -> get ( '_token' ))) { $entityManager = $this -> getDoctrine () -> getManager (); $entityManager -> remove ( $link ); $entityManager -> flush (); } return $this -> redirectToRoute ( 'link_index' ); } } {:.alert .alert-activity} Crea el controlador CRUD de l'entitat User.","title":"CRUD"},{"location":"UD12.%20Tutorial/02-creant-els-crud/#estils-i-javascript","text":"La forma m\u00e9s senzilla d'incloure fitxers css i js al nostre projecte \u00e9s modificant la plantilla base.html.twig perqu\u00e8 els incloga directament des de la web.","title":"Estils i javascript"},{"location":"UD12.%20Tutorial/02-creant-els-crud/#_stylehtmltwig","text":"< link rel = \"stylesheet\" href = \"https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css\" integrity = \"sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T\" crossorigin = \"anonymous\" > < link rel = \"stylesheet\" href = \"https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css\" > < script src = \"https://code.jquery.com/jquery-3.4.1.slim.min.js\" integrity = \"sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n\" crossorigin = \"anonymous\" ></ script > < script src = \"https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js\" integrity = \"sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo\" crossorigin = \"anonymous\" ></ script > < script src = \"https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js\" integrity = \"sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6\" crossorigin = \"anonymous\" ></ script > Tamb\u00e9 inclourem el men\u00fa superior. {: .alert .alert-activity } Inclou els fitxers _style.html.twig i _header.html.twig al projecte. Comprova que tot funciona b\u00e9. {: .alert .alert-warning } Hem optat per una forma senzilla d'incloure CSS i javascript al nostre projecte, per\u00f2 dista molt de ser la m\u00e9s recomanable. M\u00e9s endavant en endinsarem en la gesti\u00f3 de paquets per al frontend de la m\u00e0 de Webpack Encore .","title":"_style.html.twig"},{"location":"UD12.%20Tutorial/02-creant-els-crud/#activant-bootstrap-4-als-formularis","text":"Per a millorar l'aspecte dels formularis Symfony incorpora suport per a Bootstrap. Modifica el fitxer twig.yaml perqu\u00e8 quede de la seg\u00fcent manera: # config/packages/twig.yaml twig : form_themes : [ 'bootstrap_4_layout.html.twig' ]","title":"Activant bootstrap 4 als formularis"},{"location":"UD12.%20Tutorial/03-implementant-les-relacions/","text":"Implementaci\u00f3 de les relacions {: .no_toc } Taula de continguts {: .no_toc .text-delta .nocount } TOC Introducci\u00f3 Anem a relacionar cada enlla\u00e7 amb l'autor (usuari). Es tracta d'una relaci\u00f3 molts a un , ja que cada Link tindr\u00e0 un autor per\u00f2 cada autor pot tindre m\u00e9s d'un enlla\u00e7. Executarem $ php bin/console make:entity Link Your entity already exists! So let's add some new fields! New property name (press <return> to stop adding fields): > author Field type (enter ? to see all types) [string]: > ManyToOne What class should this entity be related to?: > User Is the Link.author property allowed to be null (nullable)? (yes/no) [yes]: > yes Do you want to add a new property to User so that you can access/update Link objects from it - e.g. $user->getLinks()? (yes/no) [yes]: > yes A new property will also be added to the User class so that you can access the related Link objects from it. New field name inside User [links]: > links updated: src/Entity/Link.php updated: src/Entity/User.php Add another property? Enter the property name (or press <return> to stop adding fields): > Success! Next: When you're ready, create a migration with make:migration Revisi\u00f3 dels canvis // src/Entity/Link.php ... /** * @ORM\\ManyToOne(targetEntity=\"App\\Entity\\User\", inversedBy=\"links\") */ private $author ; // src/Entity/User.php /** * @ORM\\OneToMany(targetEntity=\"App\\Entity\\Link\", mappedBy=\"author\") */ private $links ; public function __construct () { ... $this -> links = new ArrayCollection (); } Aplicar els canvis a la base de dades Despr\u00e9s aplicarem els canvis a la base de dades mitjan\u00e7ant make:migration primer i doctrine:migrations:migrate despr\u00e9s. php bin/console make:migration Success! Next: Review the new migration \"src/Migrations/Version20200126202501.php\" Then: Run the migration with php bin/console doctrine:migrations:migrate See https://symfony.com/doc/current/bundles/DoctrineMigrationsBundle/index.html php bin/console doctrine:migrations:migrate Application Migrations WARNING! You are about to execute a database migration that could result in schema changes and data loss. Are you sure you wish to continue? (y/n)y Migrating up to 20200126203008 from 0 ++ migrating 20200126203008 -> ALTER TABLE user CHANGE roles roles JSON NOT NULL -> ALTER TABLE link ADD author_id INT DEFAULT NULL -> ALTER TABLE link ADD CONSTRAINT FK_36AC99F1F675F31B FOREIGN KEY (author_id) REFERENCES user (id) -> CREATE INDEX IDX_36AC99F1F675F31B ON link (author_id) ++ migrated (took 149.4ms, used 16M memory) ------------------------ ++ finished in 151.5ms ++ used 16M memory ++ 1 migrations executed ++ 4 sql queries Comprovaci\u00f3 dels canvis Els canvis s\u00f3n els seg\u00fcents ALTER TABLE link ADD author_id INT DEFAULT NULL ALTER TABLE link ADD CONSTRAINT FK_36AC99F1F675F31B FOREIGN KEY ( author_id ) REFERENCES user ( id ) CREATE INDEX IDX_36AC99F1F675F31B ON link ( author_id ) {:.alert .alert-info } M\u00e9s informaci\u00f3 en How to Work with Doctrine Associations / Relations Modificant el formulari Ara caldr\u00e0 modificar el formulari de Link per poder assignar l'usuari que ha enviat l'enlla\u00e7. Afegirem un camp de tipus EntityField indicant en l'array d'opcions la classe User::class i que l'etiqueta que es mostrar\u00e0 ser\u00e0 fullname . // src/Forms/LinkType.php public function buildForm ( FormBuilderInterface $builder , array $options ) { $builder -> add ( 'url' ) -> add ( 'title' ) -> add ( 'description' ) -> add ( 'createdAt' ) -> add ( 'updatedAt' ) -> add ( 'author' , EntityType :: class , [ 'class' => User :: class , 'choice_label' => 'fullname' ]); } La configuraci\u00f3 del formularis \u00e9s molt flexible, en el cas del camp roles del formulari d'Usuari podem modificar-lo perqu\u00e8 mostre en un checkbox els diferents rols d'usuari : // src/Forms/UserType.php public function buildForm ( FormBuilderInterface $builder , array $options ) { $builder -> add ( 'fullName' ) -> add ( 'username' ) -> add ( 'email' ) -> add ( 'password' ) -> add ( 'roles' , ChoiceType :: class , [ 'choices' => [ 'Usuari normal' => 'ROLE_USER' , 'Admnistrador' => 'ROLE_ADMIN' ], 'multiple' => true , 'expanded' => true ]); /* $builder->get('roles') ->addModelTransformer(new CallbackTransformer( function ($rolesAsArray) { // transform the array to a string return implode(', ', $rolesAsArray); }, function ($rolesAsString) { // transform the string back to an array return explode(', ', $rolesAsString); } )); */ } M\u00e9s informaci\u00f3 sobre els diferents tipus de camps dels formularis de Symfony en Form Types Reference","title":"3. Implementant les relacions"},{"location":"UD12.%20Tutorial/03-implementant-les-relacions/#implementacio-de-les-relacions","text":"{: .no_toc }","title":"Implementaci\u00f3 de les relacions"},{"location":"UD12.%20Tutorial/03-implementant-les-relacions/#taula-de-continguts","text":"{: .no_toc .text-delta .nocount } TOC","title":"Taula de continguts"},{"location":"UD12.%20Tutorial/03-implementant-les-relacions/#introduccio","text":"Anem a relacionar cada enlla\u00e7 amb l'autor (usuari). Es tracta d'una relaci\u00f3 molts a un , ja que cada Link tindr\u00e0 un autor per\u00f2 cada autor pot tindre m\u00e9s d'un enlla\u00e7. Executarem $ php bin/console make:entity Link Your entity already exists! So let's add some new fields! New property name (press <return> to stop adding fields): > author Field type (enter ? to see all types) [string]: > ManyToOne What class should this entity be related to?: > User Is the Link.author property allowed to be null (nullable)? (yes/no) [yes]: > yes Do you want to add a new property to User so that you can access/update Link objects from it - e.g. $user->getLinks()? (yes/no) [yes]: > yes A new property will also be added to the User class so that you can access the related Link objects from it. New field name inside User [links]: > links updated: src/Entity/Link.php updated: src/Entity/User.php Add another property? Enter the property name (or press <return> to stop adding fields): > Success! Next: When you're ready, create a migration with make:migration","title":"Introducci\u00f3"},{"location":"UD12.%20Tutorial/03-implementant-les-relacions/#revisio-dels-canvis","text":"// src/Entity/Link.php ... /** * @ORM\\ManyToOne(targetEntity=\"App\\Entity\\User\", inversedBy=\"links\") */ private $author ; // src/Entity/User.php /** * @ORM\\OneToMany(targetEntity=\"App\\Entity\\Link\", mappedBy=\"author\") */ private $links ; public function __construct () { ... $this -> links = new ArrayCollection (); }","title":"Revisi\u00f3 dels canvis"},{"location":"UD12.%20Tutorial/03-implementant-les-relacions/#aplicar-els-canvis-a-la-base-de-dades","text":"Despr\u00e9s aplicarem els canvis a la base de dades mitjan\u00e7ant make:migration primer i doctrine:migrations:migrate despr\u00e9s. php bin/console make:migration Success! Next: Review the new migration \"src/Migrations/Version20200126202501.php\" Then: Run the migration with php bin/console doctrine:migrations:migrate See https://symfony.com/doc/current/bundles/DoctrineMigrationsBundle/index.html php bin/console doctrine:migrations:migrate Application Migrations WARNING! You are about to execute a database migration that could result in schema changes and data loss. Are you sure you wish to continue? (y/n)y Migrating up to 20200126203008 from 0 ++ migrating 20200126203008 -> ALTER TABLE user CHANGE roles roles JSON NOT NULL -> ALTER TABLE link ADD author_id INT DEFAULT NULL -> ALTER TABLE link ADD CONSTRAINT FK_36AC99F1F675F31B FOREIGN KEY (author_id) REFERENCES user (id) -> CREATE INDEX IDX_36AC99F1F675F31B ON link (author_id) ++ migrated (took 149.4ms, used 16M memory) ------------------------ ++ finished in 151.5ms ++ used 16M memory ++ 1 migrations executed ++ 4 sql queries","title":"Aplicar els canvis a la base de dades"},{"location":"UD12.%20Tutorial/03-implementant-les-relacions/#comprovacio-dels-canvis","text":"Els canvis s\u00f3n els seg\u00fcents ALTER TABLE link ADD author_id INT DEFAULT NULL ALTER TABLE link ADD CONSTRAINT FK_36AC99F1F675F31B FOREIGN KEY ( author_id ) REFERENCES user ( id ) CREATE INDEX IDX_36AC99F1F675F31B ON link ( author_id ) {:.alert .alert-info } M\u00e9s informaci\u00f3 en How to Work with Doctrine Associations / Relations","title":"Comprovaci\u00f3 dels canvis"},{"location":"UD12.%20Tutorial/03-implementant-les-relacions/#modificant-el-formulari","text":"Ara caldr\u00e0 modificar el formulari de Link per poder assignar l'usuari que ha enviat l'enlla\u00e7. Afegirem un camp de tipus EntityField indicant en l'array d'opcions la classe User::class i que l'etiqueta que es mostrar\u00e0 ser\u00e0 fullname . // src/Forms/LinkType.php public function buildForm ( FormBuilderInterface $builder , array $options ) { $builder -> add ( 'url' ) -> add ( 'title' ) -> add ( 'description' ) -> add ( 'createdAt' ) -> add ( 'updatedAt' ) -> add ( 'author' , EntityType :: class , [ 'class' => User :: class , 'choice_label' => 'fullname' ]); } La configuraci\u00f3 del formularis \u00e9s molt flexible, en el cas del camp roles del formulari d'Usuari podem modificar-lo perqu\u00e8 mostre en un checkbox els diferents rols d'usuari : // src/Forms/UserType.php public function buildForm ( FormBuilderInterface $builder , array $options ) { $builder -> add ( 'fullName' ) -> add ( 'username' ) -> add ( 'email' ) -> add ( 'password' ) -> add ( 'roles' , ChoiceType :: class , [ 'choices' => [ 'Usuari normal' => 'ROLE_USER' , 'Admnistrador' => 'ROLE_ADMIN' ], 'multiple' => true , 'expanded' => true ]); /* $builder->get('roles') ->addModelTransformer(new CallbackTransformer( function ($rolesAsArray) { // transform the array to a string return implode(', ', $rolesAsArray); }, function ($rolesAsString) { // transform the string back to an array return explode(', ', $rolesAsString); } )); */ } M\u00e9s informaci\u00f3 sobre els diferents tipus de camps dels formularis de Symfony en Form Types Reference","title":"Modificant el formulari"},{"location":"UD12.%20Tutorial/04-seguretat/","text":"Seguretat {: .no_toc } Taula de continguts {: .no_toc .text-delta .nocount } TOC Introducci\u00f3 El component de seguretat de Symfony proporciona un sistema de seguretat complet per a l'aplicaci\u00f3 web. Ofereix facilitats per autenticaci\u00f3 mitjan\u00e7ant autenticaci\u00f3 b\u00e0sica HTTP, inici de sessi\u00f3 de formulari o autenticaci\u00f3 de certificat X.509, per\u00f2 tamb\u00e9 vos permet implementar les vostres estrat\u00e8gies d'autenticaci\u00f3. A m\u00e9s, el component proporciona formes d\u2019autoritzar els usuaris autentificats en funci\u00f3 del seu rol. Ens endinsar-nos en el component Security implementant un sistema d'autenticaci\u00f3 i autoritzaci\u00f3 basada en un formulari d'inici de sessi\u00f3 i en l'assignaci\u00f3 de rols. Per a fer-ho seguirem la guia Security . Pas 1. Instal\u00b7laci\u00f3 del component En el nostre cas ja tenim instal\u00b7lat el component ja que vam emprar el par\u00e0metre --full per la qual cosa no caldra tornar-lo a instal\u00b7lar. Pas 2. Creaci\u00f3 de la classe User El sistema d'autenticaci\u00f3 de Symfony requereix de disposar d'una entitat User que haur\u00e0 d'implementar la interf\u00edcie UserInterface . Si no la tenim creada podem usar el comandament php bin/console make:user . Com nosaltres ja l'hem creat haurem de fer les modificacions manualment. {: .alert .alert-info} Interf\u00edcies Les interf\u00edcies ens permeten crear codi que especifique quins m\u00e8todes ha d'implementar una classe sense necessitat de definir com s'implementen aquests m\u00e8todes . Les interf\u00edcies es defineixen de la mateixa manera que una classe, per\u00f2 amb la paraula clau de interface que substitueix la paraula clau class i sense que cap m\u00e8tode haja definit el seu contingut. Tots els m\u00e8todes declarats en una interf\u00edcie han de ser p\u00fablics; aquesta \u00e9s la naturalesa d\u2019una interf\u00edcie. En altres llenguatges aquests tipus de classes s'anomenem protocols. UserInterface Els m\u00e8todes que haurem d'implementar en la nostra classe User seran: interface UserInterface { public function getRoles () : array ; public function getPassword () :? string ; public function getSalt () :? string ; public function getUsername () : string ; public function eraseCredentials () : void ; } Per a m\u00e9s detalls: UserInterface.php El prove\u00efdor d'usuaris El prove\u00efdor d'usuaris \u00e9s l'element del sistema on s'emmagatzemaran les dades dels usuaris. En el nostre cas ser\u00e0 en la base de dades mitjant\u00e7ant la classe User per la qual cosa haurem d'establir la seg\u00fcent configuraci\u00f3: # config/packages/security.yaml # ... providers : users : entity : # the class of the entity that represents users class : 'App\\Entity\\User' # the property to query by - e.g. username, email, etc property : 'username' # optional: if you're using multiple Doctrine entity # managers, this option defines which one to use # manager_name: 'customer' # ... La secci\u00f3 prove\u00efdors crea un \"prove\u00efdor d'usuaris\" anomenat users que sap fer una consulta des de la propietat del username de la vostra entitat App\\Entity\\User . Podeu triar qualsevol nom per al prove\u00efdor d'usuari, per\u00f2 es recomana triar un nom descriptiu perqu\u00e8 posteriorment s'utilitzar\u00e0 en la configuraci\u00f3 del tallafoc. Per a m\u00e9s informaci\u00f3 llegiu Security User Providers Pas 3. Password hashing No totes les aplicacions tenen \"usuaris\" que necessiten contrasenya. Si els usuaris tenen contrasenyes, podeu controlar com es codifiquen aquestes contrasenyes a security.yaml . L'orde make:user configurar\u00e0 pr\u00e8viament aquesta opci\u00f3: Ara que Symfony sap com voleu codificar les contrasenyes, podeu utilitzar el servei UserPasswordEncoderInterface per a fer-ho abans de desar els usuaris a la base de dades. # config/packages/security.yaml security : # ... encoders : # use your user class name here App\\Entity\\User : # Use native password encoder # This value auto-selects the best possible hashing algorithm # (i.e. Sodium when available). algorithm : auto Pas 4. El prove\u00efdor d'autenticaci\u00f3 Firewalls El sistema de seguretat es configura en config/packages/security.yaml . La secci\u00f3 m\u00e9s important s\u00f3n els tallafocs ( firewalls ): # config/packages/security.yaml security : firewalls : dev : pattern : ^/(_(profiler|wdt)|css|images|js)/ security : false main : anonymous : lazy Un \"tallafoc\" \u00e9s un sistema d'autenticaci\u00f3: la configuraci\u00f3 que hi ha a continuaci\u00f3 defineix com els usuaris podran autenticar-se (per exemple, form_login, API token, etc.). A cada sol\u00b7licitud nom\u00e9s hi ha un tallafoc actiu: Symfony utilitza la clau pattern per trobar la primera coincid\u00e8ncia (tamb\u00e9 podeu coincidir per host o per altres coses). El tallafocs dev \u00e9s realment un fals tallafoc: nom\u00e9s s\u2019assegura que no bloquegeu accidentalment les eines de desenvolupament de Symfony, que viuen amb URL com /_profiler i /_wdt . Tots les URL reals s\u00f3n gestionades pel tallafoc main (cap clau pattern significa que coincidisca en totes les URL). Per\u00f2 aix\u00f2 no significa que cada URL requerisca autenticaci\u00f3. No, gr\u00e0cies a la clau anonymous , aquest tallafoc \u00e9s accessible de forma an\u00f2nima. De fet, si aneu a la p\u00e0gina principal ara mateix, tindreu acc\u00e9s i veureu que esteu \"autenticats\" com a anonims. No us deixeu enganyar pel \"S\u00ed\" que hi ha al costat d'Autentificat. El tallafoc ha comprovat que desconeix la vostra identitat i, per tant, eres an\u00f2nim. Prove\u00efdors d'autenticaci\u00f3 Una vegada enllestida la classe User caldr\u00e0 definir quin prove\u00efdor d'autenticaci\u00f3 utilitzarem, en el nostre cas usarem form_login que incorpora Symfony. M\u00e9s informaci\u00f3 sobre prove\u00efdors d'autenticaci\u00f3 {:.alert .alert-activity} Implementaci\u00f3 de form_login Seguint les instruccions de Using the form_login Authentication Provider implementa el prove\u00efdor d'autenticaci\u00f3 form_login No t'oblides d'indicar tamb\u00e9 al firewall main quin ser\u00e0 el prove\u00efdor d'usuaris mitjan\u00e7ant la clau provider: users ja que users \u00e9s el nom que li hem posat al nostre prove\u00efdor d'usuaris. {:.alert .alert-info} Guard Authenticators Un autenticador Guard \u00e9s una classe que proporciona un control complet sobre el proc\u00e9s d\u2019autenticaci\u00f3. Aquest concepte s'excedeix de l'\u00e0mbit del curs. Pas 5. Formulari de registre Symfony ens proporciona el comandament make:registration-form per poder disposar d'un formulari de registre. {:.alert .alert-activity } Formulari de registre Crea mitjan\u00e7ant make:registration-form el formulari de registre. Comprova que funciona. Si falten camps pots personalitzar la classe App\\Form\\RegisterFormType.php Crea l'usuari admin amb contrasenya admin . Pas 6. Negar acc\u00e9s, rols i altres formes d'autoritzaci\u00f3 Els usuaris ja poden iniciar sessi\u00f3 a l'aplicaci\u00f3 mitjan\u00e7ant el formulari d'inici de sessi\u00f3. Genial! Ara, heu d\u2019aprendre a restringir acc\u00e9s i a treballar amb l\u2019objecte User. Aix\u00f2 s\u2019anomena autoritzaci\u00f3, i la seva tasca \u00e9s decidir si un usuari pot accedir a algun recurs (un URL, un objecte model, una trucada al m\u00e8tode, ...). Hi ha dues formes de restringir l'acc\u00e9s a algun recurs: access_control a security.yaml vos permet protegir els patrons d\u2019URL (per exemple, /admin/*). M\u00e9s senzill, per\u00f2 menys flexible. Al controlador (o un altre codi). security.access_control En l'exemple seg\u00fcent per poder accedir a una ruta que comence per /admin caldr\u00e0 que l'usuari tinga el rol ROLE_ADMIN. # config/packages/security.yaml security : # ... firewalls : # ... main : # ... access_control : # require ROLE_ADMIN for /admin* - { path : '^/admin' , roles : ROLE_ADMIN } # the 'path' value can be any valid regular expression # (this one will match URLs like /api/post/7298 and /api/comment/528491) - { path : ^/api/(post|comment)/\\d+$ , roles : ROLE_USER } Control d'acc\u00e9s per controlador o m\u00e8todes You can deny access from inside a controller: // src/Controller/AdminController.php // ... public function adminDashboard () { $this -> denyAccessUnlessGranted ( 'ROLE_ADMIN' ); // or add an optional message - seen by developers $this -> denyAccessUnlessGranted ( 'ROLE_ADMIN' , null , 'User tried to access a page without having ROLE_ADMIN' ); } That's it! If access is not granted, a special AccessDeniedException is thrown and no more code in your controller is executed. Then, one of two things will happen: If the user isn't logged in yet, they will be asked to log in (e.g. redirected to the login page). If the user is logged in, but does not have the ROLE_ADMIN role, they'll be shown the 403 access denied page (which you can customize). Thanks to the SensioFrameworkExtraBundle, you can also secure your controller using annotations: // src/Controller/AdminController.php // ... use Sensio\\Bundle\\FrameworkExtraBundle\\Configuration\\IsGranted ; /** * Require ROLE_ADMIN for *every* controller method in this class. * * @IsGranted(\"ROLE_ADMIN\") */ class AdminController extends AbstractController { /** * Require ROLE_ADMIN for only this controller method. * * @IsGranted(\"ROLE_ADMIN\") */ public function adminDashboard () { // ... } } Access Control in Templates If you want to check if the current user has a certain role, you can use the built-in is_granted() helper function in any Twig template: {% raw %} { % if is_granted ( 'ROLE_ADMIN' ) %} <a href=\"...\">Delete</a> {% endif %} {:.alert .alert-activity} Restriccions d'acc\u00e9s Configura l'aplicaci\u00f3 de forma que per poder crear, llegir, actualitzar i eliminar usuaris calga que l'usuari autenticat tinga el rol ROLE_ADMIN . Pas 7. Tancar sessi\u00f3 Seguirem les seg\u00fcents indicacions per a implementar el tancament de la sessi\u00f3 ( logout ) Recursos Security Guide Security Component Security Best Practices","title":"4. Seguretat"},{"location":"UD12.%20Tutorial/04-seguretat/#seguretat","text":"{: .no_toc }","title":"Seguretat"},{"location":"UD12.%20Tutorial/04-seguretat/#taula-de-continguts","text":"{: .no_toc .text-delta .nocount } TOC","title":"Taula de continguts"},{"location":"UD12.%20Tutorial/04-seguretat/#introduccio","text":"El component de seguretat de Symfony proporciona un sistema de seguretat complet per a l'aplicaci\u00f3 web. Ofereix facilitats per autenticaci\u00f3 mitjan\u00e7ant autenticaci\u00f3 b\u00e0sica HTTP, inici de sessi\u00f3 de formulari o autenticaci\u00f3 de certificat X.509, per\u00f2 tamb\u00e9 vos permet implementar les vostres estrat\u00e8gies d'autenticaci\u00f3. A m\u00e9s, el component proporciona formes d\u2019autoritzar els usuaris autentificats en funci\u00f3 del seu rol. Ens endinsar-nos en el component Security implementant un sistema d'autenticaci\u00f3 i autoritzaci\u00f3 basada en un formulari d'inici de sessi\u00f3 i en l'assignaci\u00f3 de rols. Per a fer-ho seguirem la guia Security .","title":"Introducci\u00f3"},{"location":"UD12.%20Tutorial/04-seguretat/#pas-1-installacio-del-component","text":"En el nostre cas ja tenim instal\u00b7lat el component ja que vam emprar el par\u00e0metre --full per la qual cosa no caldra tornar-lo a instal\u00b7lar.","title":"Pas 1. Instal\u00b7laci\u00f3 del component"},{"location":"UD12.%20Tutorial/04-seguretat/#pas-2-creacio-de-la-classe-user","text":"El sistema d'autenticaci\u00f3 de Symfony requereix de disposar d'una entitat User que haur\u00e0 d'implementar la interf\u00edcie UserInterface . Si no la tenim creada podem usar el comandament php bin/console make:user . Com nosaltres ja l'hem creat haurem de fer les modificacions manualment. {: .alert .alert-info}","title":"Pas 2. Creaci\u00f3 de la classe User"},{"location":"UD12.%20Tutorial/04-seguretat/#interficies","text":"Les interf\u00edcies ens permeten crear codi que especifique quins m\u00e8todes ha d'implementar una classe sense necessitat de definir com s'implementen aquests m\u00e8todes . Les interf\u00edcies es defineixen de la mateixa manera que una classe, per\u00f2 amb la paraula clau de interface que substitueix la paraula clau class i sense que cap m\u00e8tode haja definit el seu contingut. Tots els m\u00e8todes declarats en una interf\u00edcie han de ser p\u00fablics; aquesta \u00e9s la naturalesa d\u2019una interf\u00edcie. En altres llenguatges aquests tipus de classes s'anomenem protocols.","title":"Interf\u00edcies"},{"location":"UD12.%20Tutorial/04-seguretat/#userinterface","text":"Els m\u00e8todes que haurem d'implementar en la nostra classe User seran: interface UserInterface { public function getRoles () : array ; public function getPassword () :? string ; public function getSalt () :? string ; public function getUsername () : string ; public function eraseCredentials () : void ; } Per a m\u00e9s detalls: UserInterface.php","title":"UserInterface"},{"location":"UD12.%20Tutorial/04-seguretat/#el-proveidor-dusuaris","text":"El prove\u00efdor d'usuaris \u00e9s l'element del sistema on s'emmagatzemaran les dades dels usuaris. En el nostre cas ser\u00e0 en la base de dades mitjant\u00e7ant la classe User per la qual cosa haurem d'establir la seg\u00fcent configuraci\u00f3: # config/packages/security.yaml # ... providers : users : entity : # the class of the entity that represents users class : 'App\\Entity\\User' # the property to query by - e.g. username, email, etc property : 'username' # optional: if you're using multiple Doctrine entity # managers, this option defines which one to use # manager_name: 'customer' # ... La secci\u00f3 prove\u00efdors crea un \"prove\u00efdor d'usuaris\" anomenat users que sap fer una consulta des de la propietat del username de la vostra entitat App\\Entity\\User . Podeu triar qualsevol nom per al prove\u00efdor d'usuari, per\u00f2 es recomana triar un nom descriptiu perqu\u00e8 posteriorment s'utilitzar\u00e0 en la configuraci\u00f3 del tallafoc. Per a m\u00e9s informaci\u00f3 llegiu Security User Providers","title":"El prove\u00efdor d'usuaris"},{"location":"UD12.%20Tutorial/04-seguretat/#pas-3-password-hashing","text":"No totes les aplicacions tenen \"usuaris\" que necessiten contrasenya. Si els usuaris tenen contrasenyes, podeu controlar com es codifiquen aquestes contrasenyes a security.yaml . L'orde make:user configurar\u00e0 pr\u00e8viament aquesta opci\u00f3: Ara que Symfony sap com voleu codificar les contrasenyes, podeu utilitzar el servei UserPasswordEncoderInterface per a fer-ho abans de desar els usuaris a la base de dades. # config/packages/security.yaml security : # ... encoders : # use your user class name here App\\Entity\\User : # Use native password encoder # This value auto-selects the best possible hashing algorithm # (i.e. Sodium when available). algorithm : auto","title":"Pas 3. Password hashing"},{"location":"UD12.%20Tutorial/04-seguretat/#pas-4-el-proveidor-dautenticacio","text":"","title":"Pas 4. El prove\u00efdor d'autenticaci\u00f3"},{"location":"UD12.%20Tutorial/04-seguretat/#firewalls","text":"El sistema de seguretat es configura en config/packages/security.yaml . La secci\u00f3 m\u00e9s important s\u00f3n els tallafocs ( firewalls ): # config/packages/security.yaml security : firewalls : dev : pattern : ^/(_(profiler|wdt)|css|images|js)/ security : false main : anonymous : lazy Un \"tallafoc\" \u00e9s un sistema d'autenticaci\u00f3: la configuraci\u00f3 que hi ha a continuaci\u00f3 defineix com els usuaris podran autenticar-se (per exemple, form_login, API token, etc.). A cada sol\u00b7licitud nom\u00e9s hi ha un tallafoc actiu: Symfony utilitza la clau pattern per trobar la primera coincid\u00e8ncia (tamb\u00e9 podeu coincidir per host o per altres coses). El tallafocs dev \u00e9s realment un fals tallafoc: nom\u00e9s s\u2019assegura que no bloquegeu accidentalment les eines de desenvolupament de Symfony, que viuen amb URL com /_profiler i /_wdt . Tots les URL reals s\u00f3n gestionades pel tallafoc main (cap clau pattern significa que coincidisca en totes les URL). Per\u00f2 aix\u00f2 no significa que cada URL requerisca autenticaci\u00f3. No, gr\u00e0cies a la clau anonymous , aquest tallafoc \u00e9s accessible de forma an\u00f2nima. De fet, si aneu a la p\u00e0gina principal ara mateix, tindreu acc\u00e9s i veureu que esteu \"autenticats\" com a anonims. No us deixeu enganyar pel \"S\u00ed\" que hi ha al costat d'Autentificat. El tallafoc ha comprovat que desconeix la vostra identitat i, per tant, eres an\u00f2nim.","title":"Firewalls"},{"location":"UD12.%20Tutorial/04-seguretat/#proveidors-dautenticacio","text":"Una vegada enllestida la classe User caldr\u00e0 definir quin prove\u00efdor d'autenticaci\u00f3 utilitzarem, en el nostre cas usarem form_login que incorpora Symfony. M\u00e9s informaci\u00f3 sobre prove\u00efdors d'autenticaci\u00f3 {:.alert .alert-activity}","title":"Prove\u00efdors d'autenticaci\u00f3"},{"location":"UD12.%20Tutorial/04-seguretat/#implementacio-de-form_login","text":"Seguint les instruccions de Using the form_login Authentication Provider implementa el prove\u00efdor d'autenticaci\u00f3 form_login No t'oblides d'indicar tamb\u00e9 al firewall main quin ser\u00e0 el prove\u00efdor d'usuaris mitjan\u00e7ant la clau provider: users ja que users \u00e9s el nom que li hem posat al nostre prove\u00efdor d'usuaris. {:.alert .alert-info}","title":"Implementaci\u00f3 de form_login"},{"location":"UD12.%20Tutorial/04-seguretat/#guard-authenticators","text":"Un autenticador Guard \u00e9s una classe que proporciona un control complet sobre el proc\u00e9s d\u2019autenticaci\u00f3. Aquest concepte s'excedeix de l'\u00e0mbit del curs.","title":"Guard Authenticators"},{"location":"UD12.%20Tutorial/04-seguretat/#pas-5-formulari-de-registre","text":"Symfony ens proporciona el comandament make:registration-form per poder disposar d'un formulari de registre. {:.alert .alert-activity }","title":"Pas 5. Formulari de registre"},{"location":"UD12.%20Tutorial/04-seguretat/#formulari-de-registre","text":"Crea mitjan\u00e7ant make:registration-form el formulari de registre. Comprova que funciona. Si falten camps pots personalitzar la classe App\\Form\\RegisterFormType.php Crea l'usuari admin amb contrasenya admin .","title":"Formulari de registre"},{"location":"UD12.%20Tutorial/04-seguretat/#pas-6-negar-acces-rols-i-altres-formes-dautoritzacio","text":"Els usuaris ja poden iniciar sessi\u00f3 a l'aplicaci\u00f3 mitjan\u00e7ant el formulari d'inici de sessi\u00f3. Genial! Ara, heu d\u2019aprendre a restringir acc\u00e9s i a treballar amb l\u2019objecte User. Aix\u00f2 s\u2019anomena autoritzaci\u00f3, i la seva tasca \u00e9s decidir si un usuari pot accedir a algun recurs (un URL, un objecte model, una trucada al m\u00e8tode, ...). Hi ha dues formes de restringir l'acc\u00e9s a algun recurs: access_control a security.yaml vos permet protegir els patrons d\u2019URL (per exemple, /admin/*). M\u00e9s senzill, per\u00f2 menys flexible. Al controlador (o un altre codi).","title":"Pas 6. Negar acc\u00e9s, rols i altres formes d'autoritzaci\u00f3"},{"location":"UD12.%20Tutorial/04-seguretat/#securityaccess_control","text":"En l'exemple seg\u00fcent per poder accedir a una ruta que comence per /admin caldr\u00e0 que l'usuari tinga el rol ROLE_ADMIN. # config/packages/security.yaml security : # ... firewalls : # ... main : # ... access_control : # require ROLE_ADMIN for /admin* - { path : '^/admin' , roles : ROLE_ADMIN } # the 'path' value can be any valid regular expression # (this one will match URLs like /api/post/7298 and /api/comment/528491) - { path : ^/api/(post|comment)/\\d+$ , roles : ROLE_USER }","title":"security.access_control"},{"location":"UD12.%20Tutorial/04-seguretat/#control-dacces-per-controlador-o-metodes","text":"You can deny access from inside a controller: // src/Controller/AdminController.php // ... public function adminDashboard () { $this -> denyAccessUnlessGranted ( 'ROLE_ADMIN' ); // or add an optional message - seen by developers $this -> denyAccessUnlessGranted ( 'ROLE_ADMIN' , null , 'User tried to access a page without having ROLE_ADMIN' ); } That's it! If access is not granted, a special AccessDeniedException is thrown and no more code in your controller is executed. Then, one of two things will happen: If the user isn't logged in yet, they will be asked to log in (e.g. redirected to the login page). If the user is logged in, but does not have the ROLE_ADMIN role, they'll be shown the 403 access denied page (which you can customize). Thanks to the SensioFrameworkExtraBundle, you can also secure your controller using annotations: // src/Controller/AdminController.php // ... use Sensio\\Bundle\\FrameworkExtraBundle\\Configuration\\IsGranted ; /** * Require ROLE_ADMIN for *every* controller method in this class. * * @IsGranted(\"ROLE_ADMIN\") */ class AdminController extends AbstractController { /** * Require ROLE_ADMIN for only this controller method. * * @IsGranted(\"ROLE_ADMIN\") */ public function adminDashboard () { // ... } }","title":"Control d'acc\u00e9s per controlador o m\u00e8todes"},{"location":"UD12.%20Tutorial/04-seguretat/#access-control-in-templates","text":"If you want to check if the current user has a certain role, you can use the built-in is_granted() helper function in any Twig template: {% raw %} { % if is_granted ( 'ROLE_ADMIN' ) %} <a href=\"...\">Delete</a> {% endif %} {:.alert .alert-activity}","title":"Access Control in Templates"},{"location":"UD12.%20Tutorial/04-seguretat/#restriccions-dacces","text":"Configura l'aplicaci\u00f3 de forma que per poder crear, llegir, actualitzar i eliminar usuaris calga que l'usuari autenticat tinga el rol ROLE_ADMIN .","title":"Restriccions d'acc\u00e9s"},{"location":"UD12.%20Tutorial/04-seguretat/#pas-7-tancar-sessio","text":"Seguirem les seg\u00fcents indicacions per a implementar el tancament de la sessi\u00f3 ( logout )","title":"Pas 7. Tancar sessi\u00f3"},{"location":"UD12.%20Tutorial/04-seguretat/#recursos","text":"Security Guide Security Component Security Best Practices","title":"Recursos"},{"location":"UD12.%20Tutorial/06-filtratge/","text":"La classe Request. Filtratge {: .no_toc } Taula de continguts {: .no_toc .text-delta .nocount } TOC La majoria de frameworks MVC disposen d'una classe Request per a gestionar les dades de les sol\u00b7licituds HTTP. Symfony no \u00e9s l'excepci\u00f3 i inclou tot un seguit de classes per a gestionar-les. Les trobarem en el component HttpFoundation . L'object Request mant\u00e9 la informaci\u00f3 de la sol\u00b7licitud del client. Aquest informaci\u00f3 \u00e9s accessible mitjan\u00e7ant diverses propietats p\u00fabliques: request : equivalent of $_POST; query : equivalent of $_GET ($request->query->get('name')); cookies : equivalent of $_COOKIE; attributes : no equivalent - used by your app to store other data (see below); files : equivalent of $_FILES; server : equivalent of $_SERVER; headers : mostly equivalent to a subset of $_SERVER ($request->headers->get('User-Agent')). Cada propietat \u00e9s una inst\u00e0ncia de ParameterBag (o una subclasse), el que \u00e9s una classe mantenidora de dades: request : ParameterBag; query : ParameterBag; cookies : ParameterBag; attributes : ParameterBag; files : FileBag; server : ServerBag; headers : HeaderBag. Totes les inst\u00e0ncies de ParameterBag tenen m\u00e8todes per a recuperar i actualitzar les seues dades: all() Returns the parameters. keys() Returns the parameter keys. replace() Replaces the current parameters by a new set. add() Adds parameters. get() Returns a parameter by name. set() Sets a parameter by name. has() Returns true if the parameter is defined. remove() Removes a parameter. La inst\u00e0ncia de ParameterBag tamb\u00e9 cont\u00e9 alguns m\u00e8todes per a filtrar els valors d'entrada: getAlpha() Returns the alphabetic characters of the parameter value; getAlnum() Returns the alphabetic characters and digits of the parameter value; getBoolean() Returns the parameter value converted to boolean; getDigits() Returns the digits of the parameter value; getInt() Returns the parameter value converted to integer; filter() Filters the parameter by using the PHP filter_var function. {:.alert .alert-activity} 1. Preparant el filtre La aplicaci\u00f3 diposar\u00e0 d'un filtre que permetr\u00e0 el filtrage dels enlla\u00e7os per un text de b\u00fasqueda ( text ), que s'hagen actualitzat entre dues dates ( start-date i end-date ) i per una de les etiquetes existents ( tag ). Emprant la classe Request implementa en la ruta homepage el codi necessari per a comprovar si s'han enviat les dades del formulari de filtratge mitjan\u00e7ant el querystring. Si no s'han enviat, estan buits o tenen un valor incorrecte la variable prendr\u00e0 el valor null . Les variables seran $text , $startDate , $endDate i $tag . El seguent pas ser\u00e0 implementar el fitre en la funci\u00f3 findLatest al repositori. {:.alert .alert-activity} 2. Implementant el filtre Per poder extraure les dades filtrades de la base de de dades implementarem el m\u00e8tode filter en el repositori. Tindr\u00e0 la seguent declaraci\u00f3: public function findLatest ( int $page = 1 , string $text = null , DateTime $startDate = null , DateTime $endDate = null ) : Paginator Haur\u00e0s d'implementar el codi necessari perqu\u00e8 segons els par\u00e0metres de filtrat es genere una consulta SQL o un altra. Ara provarem la nova funcionalitat. {:.alert .alert-activity} 3. Provant el filtre Encara no tenim el formulari de filtratge per\u00f2 podem provar el funcionament assignant valors v\u00e0lids directament a les variables o generar solicituds mitjan\u00e7ant el querystring . I per a acabar implementarem el formulari. {:.alert .alert-activity} 4. Implementant el formulari Tenim dues formes d'implementar-lo. La primera \u00e9s crear el formulari amb html. La segona, i mes interessant, usant el FormBuilder de Symfony . Tu tries.","title":"6. La classe Request. Filtratge"},{"location":"UD12.%20Tutorial/06-filtratge/#la-classe-request-filtratge","text":"{: .no_toc }","title":"La classe Request. Filtratge"},{"location":"UD12.%20Tutorial/06-filtratge/#taula-de-continguts","text":"{: .no_toc .text-delta .nocount } TOC La majoria de frameworks MVC disposen d'una classe Request per a gestionar les dades de les sol\u00b7licituds HTTP. Symfony no \u00e9s l'excepci\u00f3 i inclou tot un seguit de classes per a gestionar-les. Les trobarem en el component HttpFoundation . L'object Request mant\u00e9 la informaci\u00f3 de la sol\u00b7licitud del client. Aquest informaci\u00f3 \u00e9s accessible mitjan\u00e7ant diverses propietats p\u00fabliques: request : equivalent of $_POST; query : equivalent of $_GET ($request->query->get('name')); cookies : equivalent of $_COOKIE; attributes : no equivalent - used by your app to store other data (see below); files : equivalent of $_FILES; server : equivalent of $_SERVER; headers : mostly equivalent to a subset of $_SERVER ($request->headers->get('User-Agent')). Cada propietat \u00e9s una inst\u00e0ncia de ParameterBag (o una subclasse), el que \u00e9s una classe mantenidora de dades: request : ParameterBag; query : ParameterBag; cookies : ParameterBag; attributes : ParameterBag; files : FileBag; server : ServerBag; headers : HeaderBag. Totes les inst\u00e0ncies de ParameterBag tenen m\u00e8todes per a recuperar i actualitzar les seues dades: all() Returns the parameters. keys() Returns the parameter keys. replace() Replaces the current parameters by a new set. add() Adds parameters. get() Returns a parameter by name. set() Sets a parameter by name. has() Returns true if the parameter is defined. remove() Removes a parameter. La inst\u00e0ncia de ParameterBag tamb\u00e9 cont\u00e9 alguns m\u00e8todes per a filtrar els valors d'entrada: getAlpha() Returns the alphabetic characters of the parameter value; getAlnum() Returns the alphabetic characters and digits of the parameter value; getBoolean() Returns the parameter value converted to boolean; getDigits() Returns the digits of the parameter value; getInt() Returns the parameter value converted to integer; filter() Filters the parameter by using the PHP filter_var function. {:.alert .alert-activity}","title":"Taula de continguts"},{"location":"UD12.%20Tutorial/06-filtratge/#1-preparant-el-filtre","text":"La aplicaci\u00f3 diposar\u00e0 d'un filtre que permetr\u00e0 el filtrage dels enlla\u00e7os per un text de b\u00fasqueda ( text ), que s'hagen actualitzat entre dues dates ( start-date i end-date ) i per una de les etiquetes existents ( tag ). Emprant la classe Request implementa en la ruta homepage el codi necessari per a comprovar si s'han enviat les dades del formulari de filtratge mitjan\u00e7ant el querystring. Si no s'han enviat, estan buits o tenen un valor incorrecte la variable prendr\u00e0 el valor null . Les variables seran $text , $startDate , $endDate i $tag . El seguent pas ser\u00e0 implementar el fitre en la funci\u00f3 findLatest al repositori. {:.alert .alert-activity}","title":"1. Preparant el filtre"},{"location":"UD12.%20Tutorial/06-filtratge/#2-implementant-el-filtre","text":"Per poder extraure les dades filtrades de la base de de dades implementarem el m\u00e8tode filter en el repositori. Tindr\u00e0 la seguent declaraci\u00f3: public function findLatest ( int $page = 1 , string $text = null , DateTime $startDate = null , DateTime $endDate = null ) : Paginator Haur\u00e0s d'implementar el codi necessari perqu\u00e8 segons els par\u00e0metres de filtrat es genere una consulta SQL o un altra. Ara provarem la nova funcionalitat. {:.alert .alert-activity}","title":"2. Implementant el filtre"},{"location":"UD12.%20Tutorial/06-filtratge/#3-provant-el-filtre","text":"Encara no tenim el formulari de filtratge per\u00f2 podem provar el funcionament assignant valors v\u00e0lids directament a les variables o generar solicituds mitjan\u00e7ant el querystring . I per a acabar implementarem el formulari. {:.alert .alert-activity}","title":"3. Provant el filtre"},{"location":"UD12.%20Tutorial/06-filtratge/#4-implementant-el-formulari","text":"Tenim dues formes d'implementar-lo. La primera \u00e9s crear el formulari amb html. La segona, i mes interessant, usant el FormBuilder de Symfony . Tu tries.","title":"4. Implementant el formulari"},{"location":"UD12.%20Tutorial/08-translation/","text":"Translation {: .no_toc } Table of contents {: .no_toc .text-delta .nocount } TOC Installation First, run this command to install the translator before using it: composer require symfony/translation Configuration The previous command creates an initial config file where you can define the default locale of the application and the directory where the translation files are located: # config/packages/translation.yaml framework : default_locale : 'en' translator : default_path : '%kernel.project_dir%/translations' The locale used in translations is the one stored on the request. This is typically set via a _locale attribute on your routes (see The Locale and the URL ). How translation works Translation of text is done through the translator service (Translator). To translate a block of text (called a message ), use the trans() method. Suppose, for example, that you're translating a simple message from inside a controller: // ... use Symfony\\Contracts\\Translation\\TranslatorInterface ; public function index ( TranslatorInterface $translator ) { $translated = $translator -> trans ( 'Symfony is great' ); // ... } When this code is executed, Symfony will attempt to translate the message \"Symfony is great\" based on the locale of the user. For this to work, you need to tell Symfony how to translate the message via a \"translation resource\", which is usually a file that contains a collection of translations for a given locale. This \"dictionary\" of translations can be created in several different formats: # translations/messages.fr.yaml Symfony is great : J'aime Symfony Now, if the language of the user's locale is French (e.g. fr_FR or fr_BE), the message will be translated into J'aime Symfony . You can also translate the message inside your templates. To translate text in Twig templates Symfony implements several ways: tag and filter. {% raw %} { % trans %}Symfony is great!{% endtrans %} {% raw %} {{ 'menu.login' | trans }} The Translation Process To actually translate the message, Symfony uses the following process when using the trans() method: The locale of the current user, which is stored on the request is determined. If the message is located in the catalog, the translation is returned. If not, the translator returns the original message. Message Format Sometimes, a message containing a variable needs to be translated: // ... $translated = $translator -> trans ( 'Logged as ' . $username ); However, creating a translation for this string is impossible since the translator will try to look up the message including the variable portions (e.g. \"Logged as admin\" or \"Logged as mperez\"). Or there are translations that may or may not be plural, based on some variable: There is one search result. There are 5 search results. To manage these situations Symfony follows the ICU MessageFormat syntax by using PHP's MessageFormatter class. Read more about this in How to Translate Messages using the ICU MessageFormat . Below, some examples: # messsages+int-icu.ca.yaml logged as {username} : 'connectat com {username}' {% raw %} # _header.html.twig {{ 'logged as {username}' | trans ({ '{username}' : app . user . username }) }} Pluralization # messages+intl-icu.en.yaml search.results : \"{count, plural, =0 {There are no apples} one {There is one apple...} other {There are # apples!} }\" {% raw %} # Twig sample file {{ 'search.results' | trans ({ 'count' : 2 }) }} {{ 'search.results' | trans ({ 'count' : 1 }) }} {{ 'search.results' | trans ({ 'count' : 0 }) }} The previous code snippet will show: There are 2 apples! There is one apples... There are no apples {:.alert .alert-info} ICU Format php library {: .nocount} To use the ICU format library you need to install the php-intl library, the symfony/intl bundle and the symfony/polyfill-intl-messageformatter component. More information: Translation in templates Extracting Translation Contents and Updating Catalogs Automatically The most time-consuming tasks when translating an application is to extract all the template contents to be translated and to keep all the translation files in sync. Symfony includes a command called translation:update that helps you with these tasks: To show a list of messages: php bin/console translation:update --dump-messages --output-format = yaml en To generate message files: php bin/console translation:update --force --output-format = yaml en To show help: php bin/console translation:update --help Translation Resource/File Names and Locations Symfony looks for message files (i.e. translations) in the following default locations: the translations/ directory (at the root of the project); the Resources/translations/ directory inside of any bundle. The locations are listed here with the highest priority first. That is, you can override the translation messages of a bundle in the first directory. The filename of the translation files is also important: each message file must be named according to the following path: domain.locale.loader : domain : An optional way to organize messages into groups. locale : The locale that the translations are for (e.g. en_GB, en, etc); loader : How Symfony should load and parse the file (e.g. xlf, php, yaml, etc). The loader can be the name of any registered loader. By default, Symfony provides many loaders. The choice of which loader to use is entirely up to you and is a matter of taste. The recommended option is to use YAML for simple projects and use XLIFF if you're generating translations with specialized programs or teams. Translating Link manager menu Applying filters in Twig template {% raw %} < li class = \"nav-item\" > < a class = \"nav-link\" href = \"{{ url('link_index') }}\" > {{ 'menu.links' | trans }} </ a > </ li > < li class = \"nav-item\" > < a class = \"nav-link\" href = \"{{ url('user_index') }}\" > {{ 'menu.users' | trans }} </ a > </ li > < li class = \"nav-item\" > {% if is_granted('IS_AUTHENTICATED_FULLY') %} < a class = \"nav-link\" href = \"{{ url('logout') }}\" >< i class = \"fa fa-sign-out-alt\" > </ i > {{ 'menu.logout' | trans }} </ a > {% else %} < a class = \"nav-link\" href = \"{{ url('login') }}\" >< i class = \"fa fa-sign-in-alt\" ></ i > {{ 'menu.login' | trans }} </ a > {% endif %} </ li > Extracting messages Excuting this command Symfony generates the message files. php bin/console translation:update --force --output-format = yaml en The output will be generated in translations/messages.en.yaml : menu.links : __menu.links menu.users : __menu.users menu.logout : __menu.logout menu.login : __menu.login Now, you can translate the strings. Using Real or Keyword Messages As we learned when talked about localization there are two different philosophies when creating messages to be translated: $translator -> trans ( 'Symfony is great' ); $translator -> trans ( 'symfony.great' ); In the first method, messages are written in the language of the default locale (English in this case). That message is then used as the \"id\" when creating translations. In the second method, messages are actually \"keywords\" that convey the idea of the message. The keyword message is then used as the \"id\" for any translations. In this case, translations must be made for the default locale (i.e. to translate symfony.great to Symfony is great). The second method is handy because the message key won't need to be changed in every translation file if you decide that the message should actually read \"Symfony is really great\" in the default locale. The choice of which method to use is entirely up to you, but the \"keyword\" format is often recommended for multi-language applications, whereas for shared bundles that contain translation resources we recommend the real message, so your application can choose to disable the translator layer and you will see a readable message. Forms and translation If you're using the Twig integration with one of the default form theme files (e.g. form_div_layout.html.twig ), there is a Twig filter (trans) that is used for translating form labels, errors, option text and other strings. The problem is that the extractor command cannot read these messages so you have to write them manually in or use customize form rendering, applying the trans filter to form labels. More information on Form customization . Handling the User's Locale TODO","title":"8. Translation"},{"location":"UD12.%20Tutorial/08-translation/#translation","text":"{: .no_toc }","title":"Translation"},{"location":"UD12.%20Tutorial/08-translation/#table-of-contents","text":"{: .no_toc .text-delta .nocount } TOC","title":"Table of contents"},{"location":"UD12.%20Tutorial/08-translation/#installation","text":"First, run this command to install the translator before using it: composer require symfony/translation","title":"Installation"},{"location":"UD12.%20Tutorial/08-translation/#configuration","text":"The previous command creates an initial config file where you can define the default locale of the application and the directory where the translation files are located: # config/packages/translation.yaml framework : default_locale : 'en' translator : default_path : '%kernel.project_dir%/translations' The locale used in translations is the one stored on the request. This is typically set via a _locale attribute on your routes (see The Locale and the URL ).","title":"Configuration"},{"location":"UD12.%20Tutorial/08-translation/#how-translation-works","text":"Translation of text is done through the translator service (Translator). To translate a block of text (called a message ), use the trans() method. Suppose, for example, that you're translating a simple message from inside a controller: // ... use Symfony\\Contracts\\Translation\\TranslatorInterface ; public function index ( TranslatorInterface $translator ) { $translated = $translator -> trans ( 'Symfony is great' ); // ... } When this code is executed, Symfony will attempt to translate the message \"Symfony is great\" based on the locale of the user. For this to work, you need to tell Symfony how to translate the message via a \"translation resource\", which is usually a file that contains a collection of translations for a given locale. This \"dictionary\" of translations can be created in several different formats: # translations/messages.fr.yaml Symfony is great : J'aime Symfony Now, if the language of the user's locale is French (e.g. fr_FR or fr_BE), the message will be translated into J'aime Symfony . You can also translate the message inside your templates. To translate text in Twig templates Symfony implements several ways: tag and filter. {% raw %} { % trans %}Symfony is great!{% endtrans %} {% raw %} {{ 'menu.login' | trans }}","title":"How translation works"},{"location":"UD12.%20Tutorial/08-translation/#the-translation-process","text":"To actually translate the message, Symfony uses the following process when using the trans() method: The locale of the current user, which is stored on the request is determined. If the message is located in the catalog, the translation is returned. If not, the translator returns the original message.","title":"The Translation Process"},{"location":"UD12.%20Tutorial/08-translation/#message-format","text":"Sometimes, a message containing a variable needs to be translated: // ... $translated = $translator -> trans ( 'Logged as ' . $username ); However, creating a translation for this string is impossible since the translator will try to look up the message including the variable portions (e.g. \"Logged as admin\" or \"Logged as mperez\"). Or there are translations that may or may not be plural, based on some variable: There is one search result. There are 5 search results. To manage these situations Symfony follows the ICU MessageFormat syntax by using PHP's MessageFormatter class. Read more about this in How to Translate Messages using the ICU MessageFormat . Below, some examples: # messsages+int-icu.ca.yaml logged as {username} : 'connectat com {username}' {% raw %} # _header.html.twig {{ 'logged as {username}' | trans ({ '{username}' : app . user . username }) }}","title":"Message Format"},{"location":"UD12.%20Tutorial/08-translation/#icu-format-php-library","text":"{: .nocount} To use the ICU format library you need to install the php-intl library, the symfony/intl bundle and the symfony/polyfill-intl-messageformatter component. More information: Translation in templates","title":"ICU Format php library"},{"location":"UD12.%20Tutorial/08-translation/#extracting-translation-contents-and-updating-catalogs-automatically","text":"The most time-consuming tasks when translating an application is to extract all the template contents to be translated and to keep all the translation files in sync. Symfony includes a command called translation:update that helps you with these tasks: To show a list of messages: php bin/console translation:update --dump-messages --output-format = yaml en To generate message files: php bin/console translation:update --force --output-format = yaml en To show help: php bin/console translation:update --help","title":"Extracting Translation Contents and Updating Catalogs Automatically"},{"location":"UD12.%20Tutorial/08-translation/#translation-resourcefile-names-and-locations","text":"Symfony looks for message files (i.e. translations) in the following default locations: the translations/ directory (at the root of the project); the Resources/translations/ directory inside of any bundle. The locations are listed here with the highest priority first. That is, you can override the translation messages of a bundle in the first directory. The filename of the translation files is also important: each message file must be named according to the following path: domain.locale.loader : domain : An optional way to organize messages into groups. locale : The locale that the translations are for (e.g. en_GB, en, etc); loader : How Symfony should load and parse the file (e.g. xlf, php, yaml, etc). The loader can be the name of any registered loader. By default, Symfony provides many loaders. The choice of which loader to use is entirely up to you and is a matter of taste. The recommended option is to use YAML for simple projects and use XLIFF if you're generating translations with specialized programs or teams.","title":"Translation Resource/File Names and Locations"},{"location":"UD12.%20Tutorial/08-translation/#translating-link-manager-menu","text":"","title":"Translating Link manager menu"},{"location":"UD12.%20Tutorial/08-translation/#applying-filters-in-twig-template","text":"{% raw %} < li class = \"nav-item\" > < a class = \"nav-link\" href = \"{{ url('link_index') }}\" > {{ 'menu.links' | trans }} </ a > </ li > < li class = \"nav-item\" > < a class = \"nav-link\" href = \"{{ url('user_index') }}\" > {{ 'menu.users' | trans }} </ a > </ li > < li class = \"nav-item\" > {% if is_granted('IS_AUTHENTICATED_FULLY') %} < a class = \"nav-link\" href = \"{{ url('logout') }}\" >< i class = \"fa fa-sign-out-alt\" > </ i > {{ 'menu.logout' | trans }} </ a > {% else %} < a class = \"nav-link\" href = \"{{ url('login') }}\" >< i class = \"fa fa-sign-in-alt\" ></ i > {{ 'menu.login' | trans }} </ a > {% endif %} </ li >","title":"Applying filters in Twig template"},{"location":"UD12.%20Tutorial/08-translation/#extracting-messages","text":"Excuting this command Symfony generates the message files. php bin/console translation:update --force --output-format = yaml en The output will be generated in translations/messages.en.yaml : menu.links : __menu.links menu.users : __menu.users menu.logout : __menu.logout menu.login : __menu.login Now, you can translate the strings.","title":"Extracting messages"},{"location":"UD12.%20Tutorial/08-translation/#using-real-or-keyword-messages","text":"As we learned when talked about localization there are two different philosophies when creating messages to be translated: $translator -> trans ( 'Symfony is great' ); $translator -> trans ( 'symfony.great' ); In the first method, messages are written in the language of the default locale (English in this case). That message is then used as the \"id\" when creating translations. In the second method, messages are actually \"keywords\" that convey the idea of the message. The keyword message is then used as the \"id\" for any translations. In this case, translations must be made for the default locale (i.e. to translate symfony.great to Symfony is great). The second method is handy because the message key won't need to be changed in every translation file if you decide that the message should actually read \"Symfony is really great\" in the default locale. The choice of which method to use is entirely up to you, but the \"keyword\" format is often recommended for multi-language applications, whereas for shared bundles that contain translation resources we recommend the real message, so your application can choose to disable the translator layer and you will see a readable message.","title":"Using Real or Keyword Messages"},{"location":"UD12.%20Tutorial/08-translation/#forms-and-translation","text":"If you're using the Twig integration with one of the default form theme files (e.g. form_div_layout.html.twig ), there is a Twig filter (trans) that is used for translating form labels, errors, option text and other strings. The problem is that the extractor command cannot read these messages so you have to write them manually in or use customize form rendering, applying the trans filter to form labels. More information on Form customization .","title":"Forms and translation"},{"location":"UD12.%20Tutorial/08-translation/#handling-the-users-locale","text":"","title":"Handling the User's Locale"},{"location":"UD12.%20Tutorial/08-translation/#todo","text":"","title":"TODO"}]}